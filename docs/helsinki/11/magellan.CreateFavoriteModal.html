<!DOCTYPE html>

<html>
<head>
  <title>magellan.CreateFavoriteModal.jsx</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="SLARepairClient.html">
                  SLARepairClient.js
                </a>
              
                
                <a class="source" href="form_tags.html">
                  form_tags.jsx
                </a>
              
                
                <a class="source" href="glide-highcharts-v5.html">
                  glide-highcharts-v5.js
                </a>
              
                
                <a class="source" href="heisenberg_all.html">
                  heisenberg_all.jsx
                </a>
              
                
                <a class="source" href="js_guided_tours_includes.html">
                  js_guided_tours_includes.jsx
                </a>
              
                
                <a class="source" href="js_includes_amb.html">
                  js_includes_amb.jsx
                </a>
              
                
                <a class="source" href="js_includes_customer.html">
                  js_includes_customer.jsx
                </a>
              
                
                <a class="source" href="js_includes_doctype.html">
                  js_includes_doctype.jsx
                </a>
              
                
                <a class="source" href="js_includes_form_presence.html">
                  js_includes_form_presence.jsx
                </a>
              
                
                <a class="source" href="js_includes_last_doctype.html">
                  js_includes_last_doctype.jsx
                </a>
              
                
                <a class="source" href="js_includes_list_edit_doctype.html">
                  js_includes_list_edit_doctype.jsx
                </a>
              
                
                <a class="source" href="js_includes_listv2_doctype.html">
                  js_includes_listv2_doctype.jsx
                </a>
              
                
                <a class="source" href="js_includes_sorting_new.html">
                  js_includes_sorting_new.jsx
                </a>
              
                
                <a class="source" href="js_includes_sp.html">
                  js_includes_sp.jsx
                </a>
              
                
                <a class="source" href="magellan.CreateFavoriteModal.html">
                  magellan.CreateFavoriteModal.jsx
                </a>
              
                
                <a class="source" href="newtag-it.html">
                  newtag-it.jsx
                </a>
              
                
                <a class="source" href="transaction_scope_includes.html">
                  transaction_scope_includes.jsx
                </a>
              
                
                <a class="source" href="ui_policy.html">
                  ui_policy.jsx
                </a>
              
                
                <a class="source" href="z_last_include.html">
                  z_last_include.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>magellan.CreateFavoriteModal.jsx</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*! RESOURCE: /scripts/magellan.CreateFavoriteModal.js */</span>
MagellanCreateFavorites = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options, $</span>) </span>{
<span class="hljs-keyword">var</span> $modal =  $(<span class="hljs-string">"div#createFavoritesModal"</span>);
<span class="hljs-keyword">var</span> $form = $modal.find(<span class="hljs-string">'form[name=create_favorite_form]'</span>);
<span class="hljs-keyword">var</span> form = $form[<span class="hljs-number">0</span>];
<span class="hljs-keyword">var</span> $preview = $modal.find(<span class="hljs-string">'#favorite_preview'</span>);
<span class="hljs-keyword">var</span> historyCount = <span class="hljs-number">0</span>;
<span class="hljs-keyword">var</span> historyMaxCount = <span class="hljs-number">5</span>;
<span class="hljs-keyword">if</span> (options &amp;&amp; options.navColors) {
createColorPicker();
} <span class="hljs-keyword">else</span> {
$modal.find(<span class="hljs-string">'#icon_colors'</span>).addClass(<span class="hljs-string">'hidden'</span>);
}
<span class="hljs-keyword">if</span> (options &amp;&amp; options.navIcons) {
createIconPicker();
} <span class="hljs-keyword">else</span> {
$modal.find(<span class="hljs-string">'#icon_picker'</span>).addClass(<span class="hljs-string">'hidden'</span>);
}
$(<span class="hljs-string">'body'</span>).on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'.show-create-favorite-modal'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
evt.preventDefault();
<span class="hljs-keyword">var</span> button = $(<span class="hljs-keyword">this</span>);
<span class="hljs-keyword">var</span> data = getData(button);
clearFormData();
<span class="hljs-keyword">if</span> (data) {
updateFormData(data);
}
<span class="hljs-keyword">if</span> (getMagellanFavoriteList()) {
checkIfFavorited(getMagellanFavoriteList());
$modal.modal();
} <span class="hljs-keyword">else</span> {
<span class="hljs-keyword">var</span> fUrl = form.url.value || getPageUrl();
fUrl = cleanUrl(fUrl);
<span class="hljs-keyword">var</span> headers = {
<span class="hljs-attr">Accept</span> : <span class="hljs-string">'application/json'</span>
};
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> g_ck != <span class="hljs-string">'undefined'</span>) {
headers[<span class="hljs-string">'X-UserToken'</span>] = g_ck;
}
$.ajax({
<span class="hljs-attr">url</span> : <span class="hljs-string">'/api/now/ui/favorite/url'</span>,
<span class="hljs-attr">data</span> : <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">url</span> : fUrl}),
<span class="hljs-attr">type</span> : <span class="hljs-string">'POST'</span>,
<span class="hljs-attr">contentType</span> : <span class="hljs-string">'application/json'</span>,
<span class="hljs-attr">headers</span> : headers,
}).done(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
<span class="hljs-keyword">if</span> (response &amp;&amp; response.result &amp;&amp; response.result.favorite) {
updateFromFavorite(response.result.favorite);
}
$modal.modal();
});
}
});
$modal.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'#icon_colors a'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-keyword">var</span> $<span class="hljs-keyword">this</span> = $(<span class="hljs-keyword">this</span>);
<span class="hljs-keyword">var</span> color = $<span class="hljs-keyword">this</span>.data(<span class="hljs-string">'color'</span>);
updateSelectedColor(color, $<span class="hljs-keyword">this</span>);
});
$modal.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'#icon_picker a'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-keyword">var</span> $<span class="hljs-keyword">this</span> = $(<span class="hljs-keyword">this</span>);
<span class="hljs-keyword">var</span> icon = $<span class="hljs-keyword">this</span>.data(<span class="hljs-string">'icon'</span>);
updateSelectedIcon(icon, $<span class="hljs-keyword">this</span>);
});
$form.on(<span class="hljs-string">'focus'</span>, <span class="hljs-string">'[name=title]'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
$form.find(<span class="hljs-string">'[name=title]'</span>).removeClass(<span class="hljs-string">'error'</span>);
});
$form.on(<span class="hljs-string">'submit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
evt.preventDefault();
<span class="hljs-keyword">if</span> (!form.title.value) {
showTitleError();
<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
<span class="hljs-keyword">var</span> url = form.url.value || getPageUrl();
url = cleanUrl(url)
<span class="hljs-keyword">var</span> formData = {
<span class="hljs-attr">title</span> : form.title.value,
<span class="hljs-attr">url</span> : url,
<span class="hljs-attr">icon</span> : form.icon.value,
<span class="hljs-attr">color</span> : form.color.value,
<span class="hljs-attr">windowName</span> : form.window_name.value,
<span class="hljs-attr">id</span> : form.id.value
};
<span class="hljs-keyword">var</span> headers = {
<span class="hljs-attr">Accept</span> : <span class="hljs-string">'application/json'</span>
};
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> g_ck != <span class="hljs-string">'undefined'</span>) {
headers[<span class="hljs-string">'X-UserToken'</span>] = g_ck;
}
$.ajax({
<span class="hljs-attr">url</span> : <span class="hljs-string">'/api/now/ui/favorite'</span>,
<span class="hljs-attr">type</span>: <span class="hljs-string">'POST'</span>,
<span class="hljs-attr">contentType</span> : <span class="hljs-string">'application/json'</span>,
<span class="hljs-attr">headers</span> : headers,
<span class="hljs-attr">data</span> : <span class="hljs-built_in">JSON</span>.stringify(formData)
}).done(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
<span class="hljs-keyword">if</span> (response &amp;&amp; response.result &amp;&amp; response.result.favorite) {
CustomEvent.fireAll(<span class="hljs-string">'magellanNavigator:favoriteSaved'</span>, response.result.favorite)
$modal.modal(<span class="hljs-string">'hide'</span>);
}
});
});
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showTitleError</span>(<span class="hljs-params"></span>) </span>{
$form.find(<span class="hljs-string">'[name=title]'</span>).addClass(<span class="hljs-string">'error'</span>);
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getData</span>(<span class="hljs-params">button</span>) </span>{
<span class="hljs-keyword">var</span> data;
<span class="hljs-keyword">var</span> attr = [<span class="hljs-string">'url'</span>, <span class="hljs-string">'title'</span>, <span class="hljs-string">'icon'</span>, <span class="hljs-string">'color'</span>, <span class="hljs-string">'window_name'</span>, <span class="hljs-string">'description'</span>];
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; attr.length; i++) {
<span class="hljs-keyword">var</span> prop = button.attr(<span class="hljs-string">'data-'</span> + attr[i]);
<span class="hljs-keyword">if</span> (prop) {
<span class="hljs-keyword">if</span> (!data) {
data = {};
}
data[attr[i]] = prop;
}
}
<span class="hljs-keyword">return</span> data;
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPageUrl</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.location.href.substr(<span class="hljs-built_in">window</span>.location.href.indexOf(<span class="hljs-built_in">window</span>.location.pathname));
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateFormData</span>(<span class="hljs-params">data</span>) </span>{
<span class="hljs-keyword">if</span> (data.title) {
form.title.value = data.title;
}
<span class="hljs-keyword">if</span> (data.url) {
form.url.value = data.url;
}
<span class="hljs-keyword">if</span> (data.window_name) {
form.window_name.value = data.window_name;
}
<span class="hljs-keyword">if</span> (data.icon) {
updateSelectedIcon(data.icon);
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.navIcons &amp;&amp; options.navIcons.length) {
updateSelectedIcon(options.navIcons[<span class="hljs-number">0</span>]);
}
<span class="hljs-keyword">if</span> (data.color) {
updateSelectedColor(data.color);
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.navColors &amp;&amp; options.navColors.length) {
updateSelectedColor(options.navColors[<span class="hljs-number">0</span>]);
}
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearFormData</span>(<span class="hljs-params"></span>) </span>{
form.url.value = <span class="hljs-string">''</span>;
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanUrl</span>(<span class="hljs-params">url</span>) </span>{
<span class="hljs-keyword">if</span> (url.indexOf(<span class="hljs-string">'#'</span>) !== <span class="hljs-number">-1</span>) {
url = url.substring(<span class="hljs-number">0</span>, url.indexOf(<span class="hljs-string">'#'</span>));
}
<span class="hljs-keyword">if</span> (url.indexOf(<span class="hljs-string">'?'</span>) !== <span class="hljs-number">-1</span>) {
<span class="hljs-keyword">var</span> contextPath = url.substring(<span class="hljs-number">0</span>, url.indexOf(<span class="hljs-string">'?'</span>))
<span class="hljs-keyword">var</span> search = url.substring(url.indexOf(<span class="hljs-string">'?'</span>) + <span class="hljs-number">1</span>);
<span class="hljs-keyword">var</span> params = search.split(<span class="hljs-string">'&amp;'</span>);
<span class="hljs-keyword">var</span> cleanParams = [];
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; params.length; i++) {
<span class="hljs-keyword">var</span> prop = params[i].substring(<span class="hljs-number">0</span>, params[i].indexOf(<span class="hljs-string">'='</span>));
<span class="hljs-keyword">var</span> value = params[i].substring(params[i].indexOf(<span class="hljs-string">'='</span>) + <span class="hljs-number">1</span>);
cleanParams.push(prop + <span class="hljs-string">'='</span> + <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">decodeURIComponent</span>(value)).replace(<span class="hljs-regexp">/\%3A/g</span>, <span class="hljs-string">':'</span>));
}
url = contextPath + <span class="hljs-string">'?'</span> + cleanParams.join(<span class="hljs-string">'&amp;'</span>);
}
<span class="hljs-keyword">return</span> url;
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateSelectedColor</span>(<span class="hljs-params">color, selector</span>) </span>{
$(<span class="hljs-string">'#icon_colors a'</span>).removeClass(<span class="hljs-string">'selected'</span>).removeClass(<span class="hljs-string">'icon-check'</span>);
<span class="hljs-keyword">if</span> (!selector) {
selector = $(<span class="hljs-string">'#icon_colors a[data-color='</span> + color + <span class="hljs-string">']'</span>);
}
selector.addClass(<span class="hljs-string">'selected'</span>).addClass(<span class="hljs-string">'icon-check'</span>);
$(<span class="hljs-string">'.icon-picker'</span>).removeClass().addClass(<span class="hljs-string">'icon-picker color-'</span> + color);
$preview.removeClass().addClass(<span class="hljs-string">'color-'</span> + color);
form.color.value = color;
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateSelectedIcon</span>(<span class="hljs-params">icon, selector</span>) </span>{
$(<span class="hljs-string">'#icon_picker a'</span>).removeClass(<span class="hljs-string">'selected'</span>);
<span class="hljs-keyword">if</span> (!selector) {
selector = $(<span class="hljs-string">'#icon_picker a[data-icon='</span> + icon + <span class="hljs-string">']'</span>);
}
selector.addClass(<span class="hljs-string">'selected'</span>);
$preview.find(<span class="hljs-string">'span'</span>).removeClass().addClass(<span class="hljs-string">'icon-'</span> + icon);
form.icon.value = icon;
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createColorPicker</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-keyword">var</span> colors = options.navColors;
<span class="hljs-keyword">var</span> container = $(<span class="hljs-string">'&lt;div&gt;'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; colors.length; i++) {
<span class="hljs-keyword">var</span> a = $(<span class="hljs-string">'&lt;a&gt;'</span>);
a.addClass(<span class="hljs-string">'color-bg-'</span> + colors[i]);
a.attr(<span class="hljs-string">'data-color'</span>, colors[i]);
a.attr(<span class="hljs-string">'href'</span>, <span class="hljs-string">'javascript:void(0)'</span>);
container.append(a);
}
$modal.find(<span class="hljs-string">'#icon_colors'</span>).html(container.html());
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createIconPicker</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-keyword">var</span> icons = options.navIcons;
<span class="hljs-keyword">var</span> container = $(<span class="hljs-string">'&lt;div&gt;'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; icons.length; i++) {
<span class="hljs-keyword">var</span> a = $(<span class="hljs-string">'&lt;a&gt;'</span>);
a.addClass(<span class="hljs-string">'icon-'</span> + icons[i]);
a.attr(<span class="hljs-string">'data-icon'</span>, icons[i]);
a.attr(<span class="hljs-string">'href'</span>, <span class="hljs-string">'javascript:void(0)'</span>);
container.append(a);
}
$modal.find(<span class="hljs-string">'#icon_picker'</span>).html(container.html());
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkIfFavorited</span>(<span class="hljs-params">list</span>) </span>{
<span class="hljs-keyword">var</span> isFavorite = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> url = form.url.value || getPageUrl();
<span class="hljs-keyword">if</span> (list) {
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; list.length; i++) {
<span class="hljs-keyword">if</span> (sameUrl(list[i].url, url)) {
updateFromFavorite(list[i]);
<span class="hljs-keyword">break</span>;
}
<span class="hljs-keyword">if</span> (list[i].favorites) {
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; list[i].favorites.length; j++) {
<span class="hljs-keyword">if</span> (sameUrl(list[i].favorites[j].url, url)) {
updateFromFavorite(list[i].favorites[j]);
<span class="hljs-keyword">break</span>;
}
}
}
}
}
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateFromFavorite</span>(<span class="hljs-params">favorite</span>) </span>{
form.title.value = favorite.title;
form.id.value = favorite.id;
updateSelectedColor(favorite.color);
updateSelectedIcon(favorite.icon);
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMagellanFavoriteList</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.top.Magellan &amp;&amp; <span class="hljs-built_in">window</span>.top.Magellan.current) {
<span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.top.Magellan.current;
}
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sameUrl</span>(<span class="hljs-params">a, b</span>) </span>{
<span class="hljs-keyword">var</span> key, keys, paramsA, paramsB;
<span class="hljs-keyword">var</span> blackList = options.paramBlacklist;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> b !== <span class="hljs-string">'string'</span>) {
<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
a = a.replace(<span class="hljs-string">'/'</span>, <span class="hljs-string">''</span>);
b = b.replace(<span class="hljs-string">'/'</span>, <span class="hljs-string">''</span>);
paramsA = getParams(a);
paramsB = getParams(b);
keys = <span class="hljs-built_in">Object</span>.keys($.extend({},paramsA,paramsB));
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; keys.length; i++) {
key = keys[i];
<span class="hljs-keyword">if</span> (blackList &amp;&amp; blackList.indexOf(key) != <span class="hljs-number">-1</span>) {
<span class="hljs-keyword">continue</span>;
}
<span class="hljs-keyword">if</span> (paramsA[key] == paramsB[key]) {
<span class="hljs-keyword">continue</span>;
}
<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
<span class="hljs-keyword">var</span> contextPathA = (a.indexOf(<span class="hljs-string">'?'</span>) !== <span class="hljs-number">-1</span>) ? a.slice(<span class="hljs-number">0</span>, a.indexOf(<span class="hljs-string">'?'</span>)) : a;
<span class="hljs-keyword">var</span> contextPathB = (b.indexOf(<span class="hljs-string">'?'</span>) !== <span class="hljs-number">-1</span>) ? b.slice(<span class="hljs-number">0</span>, b.indexOf(<span class="hljs-string">'?'</span>)) : b;
<span class="hljs-keyword">return</span> contextPathA === contextPathB;
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getParams</span>(<span class="hljs-params">url</span>) </span>{
params = {};
<span class="hljs-keyword">var</span> p = url.substring(url.indexOf(<span class="hljs-string">'?'</span>) + <span class="hljs-number">1</span>);
p = p.split(<span class="hljs-string">'&amp;'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; p.length; i++) {
<span class="hljs-keyword">var</span> pos = p[i].indexOf(<span class="hljs-string">'='</span>);
params[p[i].substring(<span class="hljs-number">0</span>, pos)] = <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">decodeURIComponent</span>(p[i].substring(pos + <span class="hljs-number">1</span>))).replace(<span class="hljs-regexp">/\%3A/g</span>, <span class="hljs-string">':'</span>);
}
<span class="hljs-keyword">return</span> params;
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">collectPageHistory</span>(<span class="hljs-params"></span>) </span>{
$(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
sendPageHistory();
});
}
collectPageHistory();
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendPageHistory</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-keyword">var</span> button = $(<span class="hljs-string">'a.show-create-favorite-modal'</span>);
<span class="hljs-keyword">if</span> (button &amp;&amp; button.length) {
<span class="hljs-keyword">var</span> data = getData(button);
<span class="hljs-keyword">var</span> url = cleanUrl(getPageUrl());
<span class="hljs-keyword">var</span> title = <span class="hljs-string">''</span>;
<span class="hljs-keyword">if</span> (data) {
<span class="hljs-keyword">if</span> (data.url) {
url = data.url
}
<span class="hljs-keyword">if</span> (data.title) {
title = data.title;
}
<span class="hljs-keyword">if</span> (data.description) {
description = data.description;
}
}
url = cleanUrl(url);
<span class="hljs-keyword">var</span> isTable = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> number = <span class="hljs-string">''</span>;
<span class="hljs-keyword">var</span> pageData =  {
<span class="hljs-attr">navigator_history</span> : {
<span class="hljs-attr">title</span> : title,
<span class="hljs-attr">description</span> : description,
<span class="hljs-attr">url</span> : url,
<span class="hljs-attr">number</span> : number,
<span class="hljs-attr">isTable</span> : isTable
}
}
sendHistory(pageData);
} <span class="hljs-keyword">else</span> {
<span class="hljs-keyword">if</span> (historyCount &lt; historyMaxCount) {
historyCount += <span class="hljs-number">1</span>;
setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
sendPageHistory();
}, <span class="hljs-number">1000</span>);
}
}
}
CustomEvent.observe(<span class="hljs-string">'magellanNavigator.sendHistoryEvent'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
sendHistory(data);
}, <span class="hljs-number">5000</span>)
});
CustomEvent.observe(<span class="hljs-string">'magellanNavigator.addFavoriteEvent'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
addFavorite(data);
});
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendHistory</span>(<span class="hljs-params">data</span>) </span>{
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data == <span class="hljs-string">'undefined'</span>) {
<span class="hljs-keyword">return</span>;
}
<span class="hljs-keyword">if</span> (!data.url) {
data[<span class="hljs-string">'url'</span>] = cleanUrl(getPageUrl());
}
historyData = {
<span class="hljs-attr">navigator_history</span> : data
};
<span class="hljs-keyword">var</span> headers = {
<span class="hljs-attr">Accept</span> : <span class="hljs-string">'application/json'</span>
};
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> g_ck != <span class="hljs-string">'undefined'</span>) {
headers[<span class="hljs-string">'X-UserToken'</span>] = g_ck;
}
$.ajax({
<span class="hljs-attr">type</span> : <span class="hljs-string">'POST'</span>,
<span class="hljs-attr">url</span> : <span class="hljs-string">'/api/now/ui/history'</span>,
<span class="hljs-attr">headers</span> : headers,
<span class="hljs-attr">contentType</span> : <span class="hljs-string">'application/json'</span>,
<span class="hljs-attr">data</span> : <span class="hljs-built_in">JSON</span>.stringify(historyData)
}).done(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
<span class="hljs-keyword">if</span> (response &amp;&amp; response.result &amp;&amp; response.result.navigatorHistory) {
CustomEvent.fireTop(<span class="hljs-string">'magellanNavigator.historyAdded'</span>, {<span class="hljs-attr">history</span> : response.result.navigatorHistory});
}
});
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addFavorite</span>(<span class="hljs-params">data</span>) </span>{
clearFormData();
<span class="hljs-keyword">if</span> (data) {
updateFormData(data);
}
<span class="hljs-keyword">if</span> (getMagellanFavoriteList()) {
checkIfFavorited(getMagellanFavoriteList());
$modal.modal();
} <span class="hljs-keyword">else</span> {
<span class="hljs-keyword">var</span> fUrl = form.url.value || getPageUrl();
fUrl = cleanUrl(fUrl);
<span class="hljs-keyword">var</span> headers = {
<span class="hljs-attr">Accept</span> : <span class="hljs-string">'application/json'</span>
};
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> g_ck != <span class="hljs-string">'undefined'</span>) {
headers[<span class="hljs-string">'X-UserToken'</span>] = g_ck;
}
$.ajax({
<span class="hljs-attr">url</span> : <span class="hljs-string">'/api/now/ui/favorite/url'</span>,
<span class="hljs-attr">data</span> : <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">url</span> : fUrl}),
<span class="hljs-attr">type</span> : <span class="hljs-string">'POST'</span>,
<span class="hljs-attr">contentType</span> : <span class="hljs-string">'application/json'</span>,
<span class="hljs-attr">headers</span> : headers,
}).done(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
<span class="hljs-keyword">if</span> (response &amp;&amp; response.result &amp;&amp; response.result.favorite) {
updateFromFavorite(response.result.favorite);
}
$modal.modal();
});
}
}
<span class="hljs-keyword">return</span> {
<span class="hljs-attr">addFavorite</span> : addFavorite,
<span class="hljs-attr">sendHistory</span> : sendHistory
}
})(MagellanCreateFavorites, jQuery);
;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
