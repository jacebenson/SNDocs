<!DOCTYPE html>

<html>
<head>
  <title>SLARepairClient.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="SLARepairClient.html">
                  SLARepairClient.js
                </a>
              
                
                <a class="source" href="form_tags.html">
                  form_tags.jsx
                </a>
              
                
                <a class="source" href="glide-highcharts-v5.html">
                  glide-highcharts-v5.js
                </a>
              
                
                <a class="source" href="heisenberg_all.html">
                  heisenberg_all.jsx
                </a>
              
                
                <a class="source" href="js_guided_tours_includes.html">
                  js_guided_tours_includes.jsx
                </a>
              
                
                <a class="source" href="js_includes_amb.html">
                  js_includes_amb.jsx
                </a>
              
                
                <a class="source" href="js_includes_customer.html">
                  js_includes_customer.jsx
                </a>
              
                
                <a class="source" href="js_includes_doctype.html">
                  js_includes_doctype.jsx
                </a>
              
                
                <a class="source" href="js_includes_form_presence.html">
                  js_includes_form_presence.jsx
                </a>
              
                
                <a class="source" href="js_includes_last_doctype.html">
                  js_includes_last_doctype.jsx
                </a>
              
                
                <a class="source" href="js_includes_list_edit_doctype.html">
                  js_includes_list_edit_doctype.jsx
                </a>
              
                
                <a class="source" href="js_includes_listv2_doctype.html">
                  js_includes_listv2_doctype.jsx
                </a>
              
                
                <a class="source" href="js_includes_sorting_new.html">
                  js_includes_sorting_new.jsx
                </a>
              
                
                <a class="source" href="js_includes_sp.html">
                  js_includes_sp.jsx
                </a>
              
                
                <a class="source" href="magellan.CreateFavoriteModal.html">
                  magellan.CreateFavoriteModal.jsx
                </a>
              
                
                <a class="source" href="newtag-it.html">
                  newtag-it.jsx
                </a>
              
                
                <a class="source" href="transaction_scope_includes.html">
                  transaction_scope_includes.jsx
                </a>
              
                
                <a class="source" href="ui_policy.html">
                  ui_policy.jsx
                </a>
              
                
                <a class="source" href="z_last_include.html">
                  z_last_include.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>SLARepairClient.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*! RESOURCE: /scripts/SLARepairClient.js */</span>
<span class="hljs-keyword">var</span> SLARepairClient = Class.create({
  <span class="hljs-attr">initialize</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{},
  <span class="hljs-attr">repairBySysId</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">table, sysId</span>) </span>{
    <span class="hljs-keyword">this</span>.request = <span class="hljs-keyword">new</span> SLARepairClient.Request(table);
    <span class="hljs-keyword">this</span>.request.sys_id = sysId;
    <span class="hljs-keyword">this</span>._validateRequest();
  },
  <span class="hljs-attr">repairByFilter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">table, filter</span>) </span>{
    <span class="hljs-keyword">this</span>.request = <span class="hljs-keyword">new</span> SLARepairClient.Request(table);
    <span class="hljs-keyword">this</span>.request.filter = filter;
    <span class="hljs-keyword">this</span>._validateRequest();
  },
  <span class="hljs-attr">_validateRequest</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> ga = <span class="hljs-keyword">new</span> GlideAjax(<span class="hljs-string">'SLARepairAJAXProcessor'</span>);
    ga.addParam(<span class="hljs-string">'sysparm_name'</span>, <span class="hljs-string">'validateRepair'</span>);
    ga.addParam(<span class="hljs-string">'payload'</span>, <span class="hljs-built_in">Object</span>.toJSON(<span class="hljs-keyword">this</span>.request));
    ga.getXML(<span class="hljs-keyword">this</span>._processRequest.bind(<span class="hljs-keyword">this</span>));
  },
  <span class="hljs-attr">_processRequest</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rawResponse</span>) </span>{
    <span class="hljs-keyword">this</span>._getMessages();
    GlideUI.get().clearOutputMessages();
    <span class="hljs-keyword">var</span> response = rawResponse.responseXML.getElementsByTagName(<span class="hljs-string">"item"</span>)[<span class="hljs-number">0</span>].getAttribute(<span class="hljs-string">"payload"</span>);
    response = response.evalJSON();
    <span class="hljs-keyword">if</span> (response.status.code == <span class="hljs-number">400</span>) {
      <span class="hljs-keyword">if</span> (response.status.err_msg &amp;&amp; response.status.err_msg.length != <span class="hljs-number">0</span>)
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> msg <span class="hljs-keyword">in</span> response.status.err_msg)
          <span class="hljs-keyword">this</span>._addErrorMessage(msg);
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">this</span>._addErrorMessage(<span class="hljs-keyword">this</span>.msgs[<span class="hljs-string">"An invalid repair request was made"</span>]);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (response.status.code == <span class="hljs-number">503</span>) {
      <span class="hljs-keyword">if</span> (response.status.err_msg &amp;&amp; response.status.err_msg.length != <span class="hljs-number">0</span>)
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> msg <span class="hljs-keyword">in</span> response.status.err_msg)
          <span class="hljs-keyword">this</span>._addErrorMessage(msg);
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">this</span>._addErrorMessage(<span class="hljs-keyword">this</span>.msgs[<span class="hljs-string">"Repair cannot be run against tables that are not audited"</span>]);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (response.status.code != <span class="hljs-number">200</span>) {
      <span class="hljs-keyword">this</span>._addErrorMessage(<span class="hljs-keyword">this</span>.msgs[<span class="hljs-string">"An unknown error occured"</span>]);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!response.result.count || response.result.count == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">this</span>._addInfoMessage(<span class="hljs-keyword">this</span>.msgs[<span class="hljs-string">"There were no records found to repair"</span>]);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">this</span>._loadWarning(response);
  },
  <span class="hljs-attr">_loadWarning</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
    <span class="hljs-keyword">var</span> unauditedTables = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> table <span class="hljs-keyword">in</span> response.result.audit_info) {
      <span class="hljs-keyword">var</span> tableInfo = response.result.audit_info[table];
      <span class="hljs-keyword">if</span> (!tableInfo.audit_on)
        unauditedTables.push(tableInfo.label);
    }
    <span class="hljs-keyword">this</span>.dlg = <span class="hljs-keyword">new</span> GlideModal(<span class="hljs-string">'sla_repair_confirm'</span>);
    <span class="hljs-keyword">this</span>.dlg.setTitle(<span class="hljs-keyword">this</span>.msgs[<span class="hljs-string">"Warning"</span>]);
    <span class="hljs-keyword">this</span>.dlg.setWidth(<span class="hljs-number">351</span>);
    <span class="hljs-keyword">this</span>.dlg.setPreference(<span class="hljs-string">"sysparm_record_count"</span>, response.result.count);
    <span class="hljs-keyword">this</span>.dlg.setPreference(<span class="hljs-string">"sysparm_source_table"</span>, response.request.table);
    <span class="hljs-keyword">this</span>.dlg.setPreference(<span class="hljs-string">"sysparm_unaudited_tables"</span>, unauditedTables.join(<span class="hljs-string">","</span>));
    <span class="hljs-keyword">this</span>.dlg.on(<span class="hljs-string">"runRepair"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">this</span>._loadProgressWorker();
    }.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.dlg.render();
  },
  <span class="hljs-attr">_loadProgressWorker</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> dd = <span class="hljs-keyword">new</span> GlideModal(<span class="hljs-string">"simple_progress_viewer"</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">"40em"</span>, <span class="hljs-string">"10.5em"</span>);
    dd.setTitle(<span class="hljs-keyword">this</span>.msgs[<span class="hljs-string">"Repair SLAs"</span>]);
    dd.setPreference(<span class="hljs-string">"sysparm_ajax_processor"</span>, <span class="hljs-string">"SLARepairAJAXProcessor"</span>);
    dd.setPreference(<span class="hljs-string">"sysparm_payload"</span>, <span class="hljs-built_in">Object</span>.toJSON(<span class="hljs-keyword">this</span>.request));
    dd.setPreference(<span class="hljs-string">'sysparm_progress_name'</span>, <span class="hljs-keyword">this</span>.msgs[<span class="hljs-string">"Repairing SLAs"</span>]);
    dd.setPreference(<span class="hljs-string">"sysparm_renderer_expanded_levels"</span>, <span class="hljs-string">"0"</span>);
    dd.setPreference(<span class="hljs-string">"sysparm_renderer_hide_drill_down"</span>, <span class="hljs-literal">true</span>);
    dd.setPreference(<span class="hljs-string">"sysparm_button_view_logs"</span>, <span class="hljs-keyword">this</span>.msgs[<span class="hljs-string">"View Logs"</span>]);
    dd.setPreference(<span class="hljs-string">"sysparm_button_close"</span>, <span class="hljs-keyword">this</span>.msgs[<span class="hljs-string">"Close"</span>]);
    dd.on(<span class="hljs-string">"executionComplete"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">trackerObj</span>) </span>{
      <span class="hljs-keyword">var</span> closeBtn = $(<span class="hljs-string">"sysparm_button_close"</span>);
      <span class="hljs-keyword">if</span> (closeBtn) {
        closeBtn.onclick = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          dd.destroy();
        };
      }
      <span class="hljs-keyword">var</span> logsBtn = $(<span class="hljs-string">"sysparm_button_view_logs"</span>);
      <span class="hljs-keyword">if</span> (logsBtn) {
        logsBtn.onclick = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          location.href = <span class="hljs-string">"sla_repair_log.do?sysparm_query=sys_execution_tracker="</span> + trackerObj.sys_id;
        }.bind(<span class="hljs-keyword">this</span>);
      }
    });
    dd.on(<span class="hljs-string">"beforeclose"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.callback) {
        <span class="hljs-built_in">window</span>.location.reload;
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">this</span>.callback();
    }.bind(<span class="hljs-keyword">this</span>));
    dd.render();
    <span class="hljs-keyword">this</span>.dlg.destroy();
  },
  <span class="hljs-attr">_addErrorMessage</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> g_form !== <span class="hljs-string">"undefined"</span>) {
      g_form.addErrorMessage(message);
      <span class="hljs-keyword">return</span>;
    }
    GlideUI.get().addOutputMessage({
      <span class="hljs-string">"msg"</span>: message,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"error"</span>,
      <span class="hljs-attr">id</span>: <span class="hljs-literal">null</span>
    });
  },
  <span class="hljs-attr">_addInfoMessage</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> g_form !== <span class="hljs-string">"undefined"</span>) {
      g_form.addInfoMessage(message);
      <span class="hljs-keyword">return</span>;
    }
    GlideUI.get().addOutputMessage({
      <span class="hljs-string">"msg"</span>: message,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"info"</span>,
      <span class="hljs-attr">id</span>: <span class="hljs-literal">null</span>
    });
  },
  <span class="hljs-attr">_getMessages</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.msgs = getMessages(SLARepairClient.msg_keys);
  },
  <span class="hljs-attr">type</span>: <span class="hljs-string">"SLARepairClient"</span>
});
SLARepairClient.Request = Class.create({
  <span class="hljs-attr">initialize</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">table</span>) </span>{
    <span class="hljs-keyword">this</span>.table = table;
  },
  <span class="hljs-attr">repair_action</span>: <span class="hljs-string">"recreate"</span>,
  <span class="hljs-attr">when</span>: <span class="hljs-string">"now"</span>,
  <span class="hljs-attr">type</span>: <span class="hljs-string">"SLARepairClient.request"</span>
});
SLARepairClient.msg_keys = [<span class="hljs-string">"Warning"</span>, <span class="hljs-string">"Repair SLAs"</span>, <span class="hljs-string">"Repairing SLAs"</span>, <span class="hljs-string">"Close"</span>, <span class="hljs-string">"View Logs"</span>, <span class="hljs-string">"An invalid repair request was made"</span>, <span class="hljs-string">"Repair is not available for this record"</span>, <span class="hljs-string">"There were no records found to repair"</span>,
  <span class="hljs-string">"An unknown error occured"</span>
];;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
