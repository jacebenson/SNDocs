<!DOCTYPE html>

<html>
<head>
  <title>js_includes_common.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="AJAXCompleter.html">
                  AJAXCompleter.js
                </a>
              
                
                <a class="source" href="AJAXEmailClientCompleter.html">
                  AJAXEmailClientCompleter.js
                </a>
              
                
                <a class="source" href="AJAXOtherCompleter.html">
                  AJAXOtherCompleter.js
                </a>
              
                
                <a class="source" href="AJAXReferenceChoice.html">
                  AJAXReferenceChoice.js
                </a>
              
                
                <a class="source" href="AJAXReferenceCompleter.html">
                  AJAXReferenceCompleter.js
                </a>
              
                
                <a class="source" href="AJAXReferenceCompleterMulti.html">
                  AJAXReferenceCompleterMulti.js
                </a>
              
                
                <a class="source" href="AJAXReferenceControls.html">
                  AJAXReferenceControls.js
                </a>
              
                
                <a class="source" href="AJAXTableCompleter.html">
                  AJAXTableCompleter.js
                </a>
              
                
                <a class="source" href="AttachmentUploader.html">
                  AttachmentUploader.js
                </a>
              
                
                <a class="source" href="AutoComplete.html">
                  AutoComplete.js
                </a>
              
                
                <a class="source" href="BoundsUtil2.html">
                  BoundsUtil2.js
                </a>
              
                
                <a class="source" href="CookieJar.html">
                  CookieJar.js
                </a>
              
                
                <a class="source" href="CustomEventManager.html">
                  CustomEventManager.js
                </a>
              
                
                <a class="source" href="DaysOfWeekElement.html">
                  DaysOfWeekElement.js
                </a>
              
                
                <a class="source" href="DerivedFields.html">
                  DerivedFields.js
                </a>
              
                
                <a class="source" href="Draggable2.html">
                  Draggable2.js
                </a>
              
                
                <a class="source" href="DropTarget2.html">
                  DropTarget2.js
                </a>
              
                
                <a class="source" href="FieldListElement.html">
                  FieldListElement.js
                </a>
              
                
                <a class="source" href="GlideAPI1.html">
                  GlideAPI1.js
                </a>
              
                
                <a class="source" href="GlideAjax.html">
                  GlideAjax.js
                </a>
              
                
                <a class="source" href="GlideAjaxForm.html">
                  GlideAjaxForm.js
                </a>
              
                
                <a class="source" href="GlideBox.html">
                  GlideBox.js
                </a>
              
                
                <a class="source" href="GlideClientCache.html">
                  GlideClientCache.js
                </a>
              
                
                <a class="source" href="GlideDecoration.html">
                  GlideDecoration.js
                </a>
              
                
                <a class="source" href="GlideDialogForm.html">
                  GlideDialogForm.js
                </a>
              
                
                <a class="source" href="GlideDialogWindow.html">
                  GlideDialogWindow.js
                </a>
              
                
                <a class="source" href="GlideDraggable.html">
                  GlideDraggable.js
                </a>
              
                
                <a class="source" href="GlideDuration.html">
                  GlideDuration.js
                </a>
              
                
                <a class="source" href="GlideEvent.html">
                  GlideEvent.js
                </a>
              
                
                <a class="source" href="GlideEventHandler.html">
                  GlideEventHandler.js
                </a>
              
                
                <a class="source" href="GlideFilter14.html">
                  GlideFilter14.js
                </a>
              
                
                <a class="source" href="GlideFilterDate.html">
                  GlideFilterDate.js
                </a>
              
                
                <a class="source" href="GlideFilterDescription.html">
                  GlideFilterDescription.js
                </a>
              
                
                <a class="source" href="GlideFilterHandlers.html">
                  GlideFilterHandlers.js
                </a>
              
                
                <a class="source" href="GlideFilterItemVariables.html">
                  GlideFilterItemVariables.js
                </a>
              
                
                <a class="source" href="GlideFilterLabels.html">
                  GlideFilterLabels.js
                </a>
              
                
                <a class="source" href="GlideFilterQuestions.html">
                  GlideFilterQuestions.js
                </a>
              
                
                <a class="source" href="GlideFilterReference.html">
                  GlideFilterReference.js
                </a>
              
                
                <a class="source" href="GlideFilterReferenceMulti.html">
                  GlideFilterReferenceMulti.js
                </a>
              
                
                <a class="source" href="GlideFilterVariableMap.html">
                  GlideFilterVariableMap.js
                </a>
              
                
                <a class="source" href="GlideFilterVariables.html">
                  GlideFilterVariables.js
                </a>
              
                
                <a class="source" href="GlideForm14.html">
                  GlideForm14.js
                </a>
              
                
                <a class="source" href="GlideHeaderSearch.html">
                  GlideHeaderSearch.js
                </a>
              
                
                <a class="source" href="GlideList2.html">
                  GlideList2.js
                </a>
              
                
                <a class="source" href="GlideList2FilterUtil.html">
                  GlideList2FilterUtil.js
                </a>
              
                
                <a class="source" href="GlideList2Handlers.html">
                  GlideList2Handlers.js
                </a>
              
                
                <a class="source" href="GlideList2InitEvents.html">
                  GlideList2InitEvents.js
                </a>
              
                
                <a class="source" href="GlideList2Statics.html">
                  GlideList2Statics.js
                </a>
              
                
                <a class="source" href="GlideListAggregates.html">
                  GlideListAggregates.js
                </a>
              
                
                <a class="source" href="GlideListEditor.html">
                  GlideListEditor.js
                </a>
              
                
                <a class="source" href="GlideListEditorMessaging.html">
                  GlideListEditorMessaging.js
                </a>
              
                
                <a class="source" href="GlideListElement.html">
                  GlideListElement.js
                </a>
              
                
                <a class="source" href="GlideListWidget.html">
                  GlideListWidget.js
                </a>
              
                
                <a class="source" href="GlideListv3Compatibility.html">
                  GlideListv3Compatibility.js
                </a>
              
                
                <a class="source" href="GlideModal.html">
                  GlideModal.js
                </a>
              
                
                <a class="source" href="GlideNavigation.html">
                  GlideNavigation.js
                </a>
              
                
                <a class="source" href="GlideOverlay.html">
                  GlideOverlay.js
                </a>
              
                
                <a class="source" href="GlidePane.html">
                  GlidePane.js
                </a>
              
                
                <a class="source" href="GlidePaneForm.html">
                  GlidePaneForm.js
                </a>
              
                
                <a class="source" href="GlideRecord.html">
                  GlideRecord.js
                </a>
              
                
                <a class="source" href="GlideTabs2.html">
                  GlideTabs2.js
                </a>
              
                
                <a class="source" href="GlideTabs2State.html">
                  GlideTabs2State.js
                </a>
              
                
                <a class="source" href="GlideTabs2Tab.html">
                  GlideTabs2Tab.js
                </a>
              
                
                <a class="source" href="GlideTimeElement.html">
                  GlideTimeElement.js
                </a>
              
                
                <a class="source" href="GlideTimerElement.html">
                  GlideTimerElement.js
                </a>
              
                
                <a class="source" href="GlideTransactionScope.html">
                  GlideTransactionScope.js
                </a>
              
                
                <a class="source" href="GlideUI.html">
                  GlideUI.js
                </a>
              
                
                <a class="source" href="GlideUIDefault.html">
                  GlideUIDefault.js
                </a>
              
                
                <a class="source" href="GlideUIElement.html">
                  GlideUIElement.js
                </a>
              
                
                <a class="source" href="GlideUINotification.html">
                  GlideUINotification.js
                </a>
              
                
                <a class="source" href="GlideURL.html">
                  GlideURL.js
                </a>
              
                
                <a class="source" href="GlideURLElement.html">
                  GlideURLElement.js
                </a>
              
                
                <a class="source" href="GlideUser.html">
                  GlideUser.js
                </a>
              
                
                <a class="source" href="GlideUserImageElement.html">
                  GlideUserImageElement.js
                </a>
              
                
                <a class="source" href="GlideWidgetActions.html">
                  GlideWidgetActions.js
                </a>
              
                
                <a class="source" href="GlideWidgetFilter.html">
                  GlideWidgetFilter.js
                </a>
              
                
                <a class="source" href="GlideWidgetHideOnEmpty.html">
                  GlideWidgetHideOnEmpty.js
                </a>
              
                
                <a class="source" href="GlideWidgetSearch.html">
                  GlideWidgetSearch.js
                </a>
              
                
                <a class="source" href="GlideWidgetVCR.html">
                  GlideWidgetVCR.js
                </a>
              
                
                <a class="source" href="GlideWindow.html">
                  GlideWindow.js
                </a>
              
                
                <a class="source" href="GuidedTourElementTranslator.html">
                  GuidedTourElementTranslator.js
                </a>
              
                
                <a class="source" href="GwtCellEditor.html">
                  GwtCellEditor.js
                </a>
              
                
                <a class="source" href="GwtCellSelector.html">
                  GwtCellSelector.js
                </a>
              
                
                <a class="source" href="GwtContextMenu.html">
                  GwtContextMenu.js
                </a>
              
                
                <a class="source" href="GwtCursor.html">
                  GwtCursor.js
                </a>
              
                
                <a class="source" href="GwtDate.html">
                  GwtDate.js
                </a>
              
                
                <a class="source" href="GwtDraggable.html">
                  GwtDraggable.js
                </a>
              
                
                <a class="source" href="GwtDraggableSnap.html">
                  GwtDraggableSnap.js
                </a>
              
                
                <a class="source" href="GwtExportScheduleDialog.html">
                  GwtExportScheduleDialog.js
                </a>
              
                
                <a class="source" href="GwtListEditAjaxChangeSaver.html">
                  GwtListEditAjaxChangeSaver.js
                </a>
              
                
                <a class="source" href="GwtListEditAjaxValueLoader.html">
                  GwtListEditAjaxValueLoader.js
                </a>
              
                
                <a class="source" href="GwtListEditBoolean.html">
                  GwtListEditBoolean.js
                </a>
              
                
                <a class="source" href="GwtListEditCalendar.html">
                  GwtListEditCalendar.js
                </a>
              
                
                <a class="source" href="GwtListEditDependent.html">
                  GwtListEditDependent.js
                </a>
              
                
                <a class="source" href="GwtListEditDuration.html">
                  GwtListEditDuration.js
                </a>
              
                
                <a class="source" href="GwtListEditEncryptedText.html">
                  GwtListEditEncryptedText.js
                </a>
              
                
                <a class="source" href="GwtListEditError.html">
                  GwtListEditError.js
                </a>
              
                
                <a class="source" href="GwtListEditGList.html">
                  GwtListEditGList.js
                </a>
              
                
                <a class="source" href="GwtListEditGlideRecord.html">
                  GwtListEditGlideRecord.js
                </a>
              
                
                <a class="source" href="GwtListEditGridSelector.html">
                  GwtListEditGridSelector.js
                </a>
              
                
                <a class="source" href="GwtListEditInternalType.html">
                  GwtListEditInternalType.js
                </a>
              
                
                <a class="source" href="GwtListEditJournal.html">
                  GwtListEditJournal.js
                </a>
              
                
                <a class="source" href="GwtListEditMultiText.html">
                  GwtListEditMultiText.js
                </a>
              
                
                <a class="source" href="GwtListEditPassword.html">
                  GwtListEditPassword.js
                </a>
              
                
                <a class="source" href="GwtListEditRecord.html">
                  GwtListEditRecord.js
                </a>
              
                
                <a class="source" href="GwtListEditRecordDecorations.html">
                  GwtListEditRecordDecorations.js
                </a>
              
                
                <a class="source" href="GwtListEditReference.html">
                  GwtListEditReference.js
                </a>
              
                
                <a class="source" href="GwtListEditRelatedTags.html">
                  GwtListEditRelatedTags.js
                </a>
              
                
                <a class="source" href="GwtListEditSavePolicy.html">
                  GwtListEditSavePolicy.js
                </a>
              
                
                <a class="source" href="GwtListEditSelect.html">
                  GwtListEditSelect.js
                </a>
              
                
                <a class="source" href="GwtListEditTableController.html">
                  GwtListEditTableController.js
                </a>
              
                
                <a class="source" href="GwtListEditTablename.html">
                  GwtListEditTablename.js
                </a>
              
                
                <a class="source" href="GwtListEditText.html">
                  GwtListEditText.js
                </a>
              
                
                <a class="source" href="GwtListEditTranslatedField.html">
                  GwtListEditTranslatedField.js
                </a>
              
                
                <a class="source" href="GwtListEditUpdateTablename.html">
                  GwtListEditUpdateTablename.js
                </a>
              
                
                <a class="source" href="GwtListEditWindow.html">
                  GwtListEditWindow.js
                </a>
              
                
                <a class="source" href="GwtListEditorPendingChanges.html">
                  GwtListEditorPendingChanges.js
                </a>
              
                
                <a class="source" href="GwtMessage14.html">
                  GwtMessage14.js
                </a>
              
                
                <a class="source" href="GwtObservable.html">
                  GwtObservable.js
                </a>
              
                
                <a class="source" href="GwtPollDialog.html">
                  GwtPollDialog.js
                </a>
              
                
                <a class="source" href="ISO9075.html">
                  ISO9075.js
                </a>
              
                
                <a class="source" href="InPlaceEdit.html">
                  InPlaceEdit.js
                </a>
              
                
                <a class="source" href="ListDraggableRow2.html">
                  ListDraggableRow2.js
                </a>
              
                
                <a class="source" href="ListSelectManager2.html">
                  ListSelectManager2.js
                </a>
              
                
                <a class="source" href="ListSortDual2.html">
                  ListSortDual2.js
                </a>
              
                
                <a class="source" href="ListSortWindow2.html">
                  ListSortWindow2.js
                </a>
              
                
                <a class="source" href="NOW.messaging.html">
                  NOW.messaging.js
                </a>
              
                
                <a class="source" href="NOW.messaging.record.html">
                  NOW.messaging.record.js
                </a>
              
                
                <a class="source" href="NameMapEntry.html">
                  NameMapEntry.js
                </a>
              
                
                <a class="source" href="NotificationMessage.html">
                  NotificationMessage.js
                </a>
              
                
                <a class="source" href="PageTiming14.html">
                  PageTiming14.js
                </a>
              
                
                <a class="source" href="PersonalizeForm.html">
                  PersonalizeForm.js
                </a>
              
                
                <a class="source" href="Point.html">
                  Point.js
                </a>
              
                
                <a class="source" href="SLARepairClient.html">
                  SLARepairClient.js
                </a>
              
                
                <a class="source" href="ScriptLoader.html">
                  ScriptLoader.js
                </a>
              
                
                <a class="source" href="Select.html">
                  Select.js
                </a>
              
                
                <a class="source" href="SlushBucket.html">
                  SlushBucket.js
                </a>
              
                
                <a class="source" href="SortDraggable2.html">
                  SortDraggable2.js
                </a>
              
                
                <a class="source" href="SortDropTarget2.html">
                  SortDropTarget2.js
                </a>
              
                
                <a class="source" href="SortListManager2.html">
                  SortListManager2.js
                </a>
              
                
                <a class="source" href="SortUtil2.html">
                  SortUtil2.js
                </a>
              
                
                <a class="source" href="StopWatch.html">
                  StopWatch.js
                </a>
              
                
                <a class="source" href="Table.html">
                  Table.js
                </a>
              
                
                <a class="source" href="TableElement.html">
                  TableElement.js
                </a>
              
                
                <a class="source" href="TableExtension.html">
                  TableExtension.js
                </a>
              
                
                <a class="source" href="TemplateRecord.html">
                  TemplateRecord.js
                </a>
              
                
                <a class="source" href="TextAreaElement.html">
                  TextAreaElement.js
                </a>
              
                
                <a class="source" href="UserRolesElement.html">
                  UserRolesElement.js
                </a>
              
                
                <a class="source" href="UtilityAndOverrides2.html">
                  UtilityAndOverrides2.js
                </a>
              
                
                <a class="source" href="_module.html">
                  _module.js
                </a>
              
                
                <a class="source" href="ac.html">
                  ac.js
                </a>
              
                
                <a class="source" href="accessibility.html">
                  accessibility.js
                </a>
              
                
                <a class="source" href="accessibility_tabindex.html">
                  accessibility_tabindex.js
                </a>
              
                
                <a class="source" href="affix.html">
                  affix.js
                </a>
              
                
                <a class="source" href="alert.html">
                  alert.js
                </a>
              
                
                <a class="source" href="amb.Channel.html">
                  amb.Channel.js
                </a>
              
                
                <a class="source" href="amb.ChannelListener.html">
                  amb.ChannelListener.js
                </a>
              
                
                <a class="source" href="amb.ChannelRedirect.html">
                  amb.ChannelRedirect.js
                </a>
              
                
                <a class="source" href="amb.EventManager.html">
                  amb.EventManager.js
                </a>
              
                
                <a class="source" href="amb.Logger.html">
                  amb.Logger.js
                </a>
              
                
                <a class="source" href="amb.MessageClient.html">
                  amb.MessageClient.js
                </a>
              
                
                <a class="source" href="amb.MessageClientBuilder.html">
                  amb.MessageClientBuilder.js
                </a>
              
                
                <a class="source" href="amb.ServerConnection.html">
                  amb.ServerConnection.js
                </a>
              
                
                <a class="source" href="amb_properties.html">
                  amb_properties.js
                </a>
              
                
                <a class="source" href="angular-animate.html">
                  angular-animate.js
                </a>
              
                
                <a class="source" href="angular-aria.html">
                  angular-aria.js
                </a>
              
                
                <a class="source" href="angular-cookies.html">
                  angular-cookies.js
                </a>
              
                
                <a class="source" href="angular-file-upload-all.html">
                  angular-file-upload-all.js
                </a>
              
                
                <a class="source" href="angular-resource.html">
                  angular-resource.js
                </a>
              
                
                <a class="source" href="angular-route.html">
                  angular-route.js
                </a>
              
                
                <a class="source" href="angular-sanitize.html">
                  angular-sanitize.js
                </a>
              
                
                <a class="source" href="angular-touch.html">
                  angular-touch.js
                </a>
              
                
                <a class="source" href="angular-ui-tinymce.html">
                  angular-ui-tinymce.js
                </a>
              
                
                <a class="source" href="angular.html">
                  angular.js
                </a>
              
                
                <a class="source" href="angular_includes_1.4.html">
                  angular_includes_1.4.js
                </a>
              
                
                <a class="source" href="annotations_toggle.html">
                  annotations_toggle.js
                </a>
              
                
                <a class="source" href="app.$sp.html">
                  app.$sp.js
                </a>
              
                
                <a class="source" href="app.form_presence.html">
                  app.form_presence.js
                </a>
              
                
                <a class="source" href="app.ng.amb.html">
                  app.ng.amb.js
                </a>
              
                
                <a class="source" href="appResourcesProvider.html">
                  appResourcesProvider.js
                </a>
              
                
                <a class="source" href="app_guided_tours.html">
                  app_guided_tours.js
                </a>
              
                
                <a class="source" href="attachments.html">
                  attachments.js
                </a>
              
                
                <a class="source" href="auth.html">
                  auth.js
                </a>
              
                
                <a class="source" href="bootstrap-datetimepicker.html">
                  bootstrap-datetimepicker.js
                </a>
              
                
                <a class="source" href="bootstrap-iconpicker.html">
                  bootstrap-iconpicker.js
                </a>
              
                
                <a class="source" href="bootstrap_336.html">
                  bootstrap_336.js
                </a>
              
                
                <a class="source" href="button.html">
                  button.js
                </a>
              
                
                <a class="source" href="cabrillo.factory.html">
                  cabrillo.factory.js
                </a>
              
                
                <a class="source" href="calendar.html">
                  calendar.js
                </a>
              
                
                <a class="source" href="camera.html">
                  camera.js
                </a>
              
                
                <a class="source" href="carousel.html">
                  carousel.js
                </a>
              
                
                <a class="source" href="catalogDataLookup.html">
                  catalogDataLookup.js
                </a>
              
                
                <a class="source" href="catalogGlideFormFactory.html">
                  catalogGlideFormFactory.js
                </a>
              
                
                <a class="source" href="catalogItemFactory.html">
                  catalogItemFactory.js
                </a>
              
                
                <a class="source" href="clientScript_components.html">
                  clientScript_components.js
                </a>
              
                
                <a class="source" href="collapse.html">
                  collapse.js
                </a>
              
                
                <a class="source" href="cometd.html">
                  cometd.js
                </a>
              
                
                <a class="source" href="condition14_new.html">
                  condition14_new.js
                </a>
              
                
                <a class="source" href="condition14_reporting.html">
                  condition14_reporting.js
                </a>
              
                
                <a class="source" href="condition14_templates.html">
                  condition14_templates.js
                </a>
              
                
                <a class="source" href="condition_global_variables14.html">
                  condition_global_variables14.js
                </a>
              
                
                <a class="source" href="constants_embedded_help.html">
                  constants_embedded_help.js
                </a>
              
                
                <a class="source" href="context_actions.html">
                  context_actions.js
                </a>
              
                
                <a class="source" href="controller.AMBRecordWatcher.html">
                  controller.AMBRecordWatcher.js
                </a>
              
                
                <a class="source" href="controller.Stream.html">
                  controller.Stream.js
                </a>
              
                
                <a class="source" href="controller.formStream.html">
                  controller.formStream.js
                </a>
              
                
                <a class="source" href="controller.guidedTours.html">
                  controller.guidedTours.js
                </a>
              
                
                <a class="source" href="controller.spLogin.html">
                  controller.spLogin.js
                </a>
              
                
                <a class="source" href="controller.spPage.html">
                  controller.spPage.js
                </a>
              
                
                <a class="source" href="controller.spWidgetDebug.html">
                  controller.spWidgetDebug.js
                </a>
              
                
                <a class="source" href="debug.html">
                  debug.js
                </a>
              
                
                <a class="source" href="decorator.uiTinymce.html">
                  decorator.uiTinymce.js
                </a>
              
                
                <a class="source" href="deferred_related_lists.html">
                  deferred_related_lists.js
                </a>
              
                
                <a class="source" href="depends.html">
                  depends.js
                </a>
              
                
                <a class="source" href="directive.contenteditable.html">
                  directive.contenteditable.js
                </a>
              
                
                <a class="source" href="directive.formStreamEntry.html">
                  directive.formStreamEntry.js
                </a>
              
                
                <a class="source" href="directive.glideFormField.html">
                  directive.glideFormField.js
                </a>
              
                
                <a class="source" href="directive.message.html">
                  directive.message.js
                </a>
              
                
                <a class="source" href="directive.nowAttachmentsList.html">
                  directive.nowAttachmentsList.js
                </a>
              
                
                <a class="source" href="directive.recursiveHelper.html">
                  directive.recursiveHelper.js
                </a>
              
                
                <a class="source" href="directive.scroll_form.html">
                  directive.scroll_form.js
                </a>
              
                
                <a class="source" href="directive.snAttachmentList.html">
                  directive.snAttachmentList.js
                </a>
              
                
                <a class="source" href="directive.snAttachmentPreview.html">
                  directive.snAttachmentPreview.js
                </a>
              
                
                <a class="source" href="directive.snAvatar.html">
                  directive.snAvatar.js
                </a>
              
                
                <a class="source" href="directive.snAvatarPopover.html">
                  directive.snAvatarPopover.js
                </a>
              
                
                <a class="source" href="directive.snBindI18n.html">
                  directive.snBindI18n.js
                </a>
              
                
                <a class="source" href="directive.snBindOnce.html">
                  directive.snBindOnce.js
                </a>
              
                
                <a class="source" href="directive.snBindPopoverSelection.html">
                  directive.snBindPopoverSelection.js
                </a>
              
                
                <a class="source" href="directive.snBlurOnEnter.html">
                  directive.snBlurOnEnter.js
                </a>
              
                
                <a class="source" href="directive.snBootstrapPopover.html">
                  directive.snBootstrapPopover.js
                </a>
              
                
                <a class="source" href="directive.snChoiceList.html">
                  directive.snChoiceList.js
                </a>
              
                
                <a class="source" href="directive.snCloak.html">
                  directive.snCloak.js
                </a>
              
                
                <a class="source" href="directive.snComplexPopover.html">
                  directive.snComplexPopover.js
                </a>
              
                
                <a class="source" href="directive.snComposing.html">
                  directive.snComposing.js
                </a>
              
                
                <a class="source" href="directive.snConfirmModal.html">
                  directive.snConfirmModal.js
                </a>
              
                
                <a class="source" href="directive.snContextMenu.html">
                  directive.snContextMenu.js
                </a>
              
                
                <a class="source" href="directive.snDayAgo.html">
                  directive.snDayAgo.js
                </a>
              
                
                <a class="source" href="directive.snDialog.html">
                  directive.snDialog.js
                </a>
              
                
                <a class="source" href="directive.snExpandedEmail.html">
                  directive.snExpandedEmail.js
                </a>
              
                
                <a class="source" href="directive.snFieldReference.html">
                  directive.snFieldReference.js
                </a>
              
                
                <a class="source" href="directive.snFileUploadInput.html">
                  directive.snFileUploadInput.js
                </a>
              
                
                <a class="source" href="directive.snFlyout.html">
                  directive.snFlyout.js
                </a>
              
                
                <a class="source" href="directive.snFocus.html">
                  directive.snFocus.js
                </a>
              
                
                <a class="source" href="directive.snGlyph.html">
                  directive.snGlyph.js
                </a>
              
                
                <a class="source" href="directive.snGroupAvatar.html">
                  directive.snGroupAvatar.js
                </a>
              
                
                <a class="source" href="directive.snImageUploader.html">
                  directive.snImageUploader.js
                </a>
              
                
                <a class="source" href="directive.snLinkContent.html">
                  directive.snLinkContent.js
                </a>
              
                
                <a class="source" href="directive.snLinkContentArticle.html">
                  directive.snLinkContentArticle.js
                </a>
              
                
                <a class="source" href="directive.snLinkContentAttachment.html">
                  directive.snLinkContentAttachment.js
                </a>
              
                
                <a class="source" href="directive.snLinkContentError.html">
                  directive.snLinkContentError.js
                </a>
              
                
                <a class="source" href="directive.snLinkContentImage.html">
                  directive.snLinkContentImage.js
                </a>
              
                
                <a class="source" href="directive.snLinkContentRecord.html">
                  directive.snLinkContentRecord.js
                </a>
              
                
                <a class="source" href="directive.snLinkContentSoundcloud.html">
                  directive.snLinkContentSoundcloud.js
                </a>
              
                
                <a class="source" href="directive.snLinkContentYoutube.html">
                  directive.snLinkContentYoutube.js
                </a>
              
                
                <a class="source" href="directive.snMentionPopover.html">
                  directive.snMentionPopover.js
                </a>
              
                
                <a class="source" href="directive.snModal.html">
                  directive.snModal.js
                </a>
              
                
                <a class="source" href="directive.snModalShow.html">
                  directive.snModalShow.js
                </a>
              
                
                <a class="source" href="directive.snNotification.html">
                  directive.snNotification.js
                </a>
              
                
                <a class="source" href="directive.snPasteFileHandler.html">
                  directive.snPasteFileHandler.js
                </a>
              
                
                <a class="source" href="directive.snPopoverBasic.html">
                  directive.snPopoverBasic.js
                </a>
              
                
                <a class="source" href="directive.snPresence.html">
                  directive.snPresence.js
                </a>
              
                
                <a class="source" href="directive.snRecordPicker.html">
                  directive.snRecordPicker.js
                </a>
              
                
                <a class="source" href="directive.snReferencePicker.html">
                  directive.snReferencePicker.js
                </a>
              
                
                <a class="source" href="directive.snResizeHeight.html">
                  directive.snResizeHeight.js
                </a>
              
                
                <a class="source" href="directive.snSelectBasic.html">
                  directive.snSelectBasic.js
                </a>
              
                
                <a class="source" href="directive.snStickyHeaders.html">
                  directive.snStickyHeaders.js
                </a>
              
                
                <a class="source" href="directive.snStream.html">
                  directive.snStream.js
                </a>
              
                
                <a class="source" href="directive.snSyncWith.html">
                  directive.snSyncWith.js
                </a>
              
                
                <a class="source" href="directive.snTableReference.html">
                  directive.snTableReference.js
                </a>
              
                
                <a class="source" href="directive.snTabs.html">
                  directive.snTabs.js
                </a>
              
                
                <a class="source" href="directive.snTabsBasic.html">
                  directive.snTabsBasic.js
                </a>
              
                
                <a class="source" href="directive.snTextExpander.html">
                  directive.snTextExpander.js
                </a>
              
                
                <a class="source" href="directive.snTimeAgo.html">
                  directive.snTimeAgo.js
                </a>
              
                
                <a class="source" href="directive.snUserAvatar.html">
                  directive.snUserAvatar.js
                </a>
              
                
                <a class="source" href="directive.snUserProfile.html">
                  directive.snUserProfile.js
                </a>
              
                
                <a class="source" href="directive.spAttachmentButton.html">
                  directive.spAttachmentButton.js
                </a>
              
                
                <a class="source" href="directive.spCLink.html">
                  directive.spCLink.js
                </a>
              
                
                <a class="source" href="directive.spCatItem.html">
                  directive.spCatItem.js
                </a>
              
                
                <a class="source" href="directive.spChoiceList.html">
                  directive.spChoiceList.js
                </a>
              
                
                <a class="source" href="directive.spCodeMirror.html">
                  directive.spCodeMirror.js
                </a>
              
                
                <a class="source" href="directive.spColorPicker.html">
                  directive.spColorPicker.js
                </a>
              
                
                <a class="source" href="directive.spCssEditor.html">
                  directive.spCssEditor.js
                </a>
              
                
                <a class="source" href="directive.spCurrencyElement.html">
                  directive.spCurrencyElement.js
                </a>
              
                
                <a class="source" href="directive.spDatePicker.html">
                  directive.spDatePicker.js
                </a>
              
                
                <a class="source" href="directive.spDropdownTree.html">
                  directive.spDropdownTree.js
                </a>
              
                
                <a class="source" href="directive.spDurationElement.html">
                  directive.spDurationElement.js
                </a>
              
                
                <a class="source" href="directive.spEditableField.html">
                  directive.spEditableField.js
                </a>
              
                
                <a class="source" href="directive.spFieldListElement.html">
                  directive.spFieldListElement.js
                </a>
              
                
                <a class="source" href="directive.spFormField.html">
                  directive.spFormField.js
                </a>
              
                
                <a class="source" href="directive.spGlyph.html">
                  directive.spGlyph.js
                </a>
              
                
                <a class="source" href="directive.spGlyphPicker.html">
                  directive.spGlyphPicker.js
                </a>
              
                
                <a class="source" href="directive.spHTMLEditor.html">
                  directive.spHTMLEditor.js
                </a>
              
                
                <a class="source" href="directive.spHtmlContent.html">
                  directive.spHtmlContent.js
                </a>
              
                
                <a class="source" href="directive.spMessageDialog.html">
                  directive.spMessageDialog.js
                </a>
              
                
                <a class="source" href="directive.spModel.html">
                  directive.spModel.js
                </a>
              
                
                <a class="source" href="directive.spNavbarToggle.html">
                  directive.spNavbarToggle.js
                </a>
              
                
                <a class="source" href="directive.spPageRow.html">
                  directive.spPageRow.js
                </a>
              
                
                <a class="source" href="directive.spPanel.html">
                  directive.spPanel.js
                </a>
              
                
                <a class="source" href="directive.spReferenceElement.html">
                  directive.spReferenceElement.js
                </a>
              
                
                <a class="source" href="directive.spReferenceField.html">
                  directive.spReferenceField.js
                </a>
              
                
                <a class="source" href="directive.spScriptEditor.html">
                  directive.spScriptEditor.js
                </a>
              
                
                <a class="source" href="directive.spTinymceEditor.html">
                  directive.spTinymceEditor.js
                </a>
              
                
                <a class="source" href="directive.spWidget.html">
                  directive.spWidget.js
                </a>
              
                
                <a class="source" href="dropdown.html">
                  dropdown.js
                </a>
              
                
                <a class="source" href="dropdowns.html">
                  dropdowns.js
                </a>
              
                
                <a class="source" href="email_activity.html">
                  email_activity.js
                </a>
              
                
                <a class="source" href="event_initialize.html">
                  event_initialize.js
                </a>
              
                
                <a class="source" href="factory.AMBOverlay.html">
                  factory.AMBOverlay.js
                </a>
              
                
                <a class="source" href="factory.ArraySynchronizer.html">
                  factory.ArraySynchronizer.js
                </a>
              
                
                <a class="source" href="factory.glideUrlBuilder.html">
                  factory.glideUrlBuilder.js
                </a>
              
                
                <a class="source" href="factory.notificationWrapper.html">
                  factory.notificationWrapper.js
                </a>
              
                
                <a class="source" href="factory.nowAttachmentHandler.html">
                  factory.nowAttachmentHandler.js
                </a>
              
                
                <a class="source" href="factory.paneManager.html">
                  factory.paneManager.js
                </a>
              
                
                <a class="source" href="factory.snAttachmentHandler.html">
                  factory.snAttachmentHandler.js
                </a>
              
                
                <a class="source" href="factory.snPresence.html">
                  factory.snPresence.js
                </a>
              
                
                <a class="source" href="factory.snRecordPresence.html">
                  factory.snRecordPresence.js
                </a>
              
                
                <a class="source" href="factory.snRecordWatcher.html">
                  factory.snRecordWatcher.js
                </a>
              
                
                <a class="source" href="factory.spMacro.html">
                  factory.spMacro.js
                </a>
              
                
                <a class="source" href="factory.spUIActionFactory.html">
                  factory.spUIActionFactory.js
                </a>
              
                
                <a class="source" href="factory.spWidget.html">
                  factory.spWidget.js
                </a>
              
                
                <a class="source" href="factory.unwrappedHTTPPromise.html">
                  factory.unwrappedHTTPPromise.js
                </a>
              
                
                <a class="source" href="fixedHeaders.html">
                  fixedHeaders.js
                </a>
              
                
                <a class="source" href="focus-trap.html">
                  focus-trap.js
                </a>
              
                
                <a class="source" href="form.html">
                  form.js
                </a>
              
                
                <a class="source" href="form_submitted_mask.html">
                  form_submitted_mask.js
                </a>
              
                
                <a class="source" href="form_tags.html">
                  form_tags.js
                </a>
              
                
                <a class="source" href="formatting.html">
                  formatting.js
                </a>
              
                
                <a class="source" href="functions.html">
                  functions.js
                </a>
              
                
                <a class="source" href="functions_attachments.html">
                  functions_attachments.js
                </a>
              
                
                <a class="source" href="functions_bootstrap14.html">
                  functions_bootstrap14.js
                </a>
              
                
                <a class="source" href="functions_calendar.html">
                  functions_calendar.js
                </a>
              
                
                <a class="source" href="functions_clipboard.html">
                  functions_clipboard.js
                </a>
              
                
                <a class="source" href="functions_email.html">
                  functions_email.js
                </a>
              
                
                <a class="source" href="functions_fontsizer.html">
                  functions_fontsizer.js
                </a>
              
                
                <a class="source" href="functions_onchange.html">
                  functions_onchange.js
                </a>
              
                
                <a class="source" href="functions_reference.html">
                  functions_reference.js
                </a>
              
                
                <a class="source" href="functions_showloading.html">
                  functions_showloading.js
                </a>
              
                
                <a class="source" href="functions_user_image.html">
                  functions_user_image.js
                </a>
              
                
                <a class="source" href="geolocation.html">
                  geolocation.js
                </a>
              
                
                <a class="source" href="glide-highcharts-v5.html">
                  glide-highcharts-v5.js
                </a>
              
                
                <a class="source" href="glideAjaxFactory.html">
                  glideAjaxFactory.js
                </a>
              
                
                <a class="source" href="glideFormEnvironmentFactory.html">
                  glideFormEnvironmentFactory.js
                </a>
              
                
                <a class="source" href="glideFormFactory.html">
                  glideFormFactory.js
                </a>
              
                
                <a class="source" href="glideFormFieldFactory.html">
                  glideFormFieldFactory.js
                </a>
              
                
                <a class="source" href="glideFormMessageHandler.html">
                  glideFormMessageHandler.js
                </a>
              
                
                <a class="source" href="glideListFactory.html">
                  glideListFactory.js
                </a>
              
                
                <a class="source" href="glideModalFactory.html">
                  glideModalFactory.js
                </a>
              
                
                <a class="source" href="glideRecordData.html">
                  glideRecordData.js
                </a>
              
                
                <a class="source" href="glideRecordFactory.html">
                  glideRecordFactory.js
                </a>
              
                
                <a class="source" href="glideRequest.html">
                  glideRequest.js
                </a>
              
                
                <a class="source" href="glideUIActionsApi.html">
                  glideUIActionsApi.js
                </a>
              
                
                <a class="source" href="glideUIActionsFactory.html">
                  glideUIActionsFactory.js
                </a>
              
                
                <a class="source" href="glideUserFactory.html">
                  glideUserFactory.js
                </a>
              
                
                <a class="source" href="glideUserSession.html">
                  glideUserSession.js
                </a>
              
                
                <a class="source" href="guided_tours_template.html">
                  guided_tours_template.js
                </a>
              
                
                <a class="source" href="heisenberg_all.html">
                  heisenberg_all.js
                </a>
              
                
                <a class="source" href="html_class_setter.html">
                  html_class_setter.js
                </a>
              
                
                <a class="source" href="iconset-fontawesome-4.2.0.html">
                  iconset-fontawesome-4.2.0.js
                </a>
              
                
                <a class="source" href="jQueryRequestShim.html">
                  jQueryRequestShim.js
                </a>
              
                
                <a class="source" href="jquery-2.1.html">
                  jquery-2.1.js
                </a>
              
                
                <a class="source" href="jquery-ui-1.9.2.custom.html">
                  jquery-ui-1.9.2.custom.js
                </a>
              
                
                <a class="source" href="jquery.cometd.html">
                  jquery.cometd.js
                </a>
              
                
                <a class="source" href="jquery2_includes.html">
                  jquery2_includes.js
                </a>
              
                
                <a class="source" href="jquery_clean.html">
                  jquery_clean.js
                </a>
              
                
                <a class="source" href="jquery_no_conflict.html">
                  jquery_no_conflict.js
                </a>
              
                
                <a class="source" href="js_guided_tours_includes.html">
                  js_guided_tours_includes.js
                </a>
              
                
                <a class="source" href="js_includes_amb.html">
                  js_includes_amb.js
                </a>
              
                
                <a class="source" href="js_includes_angular.html">
                  js_includes_angular.js
                </a>
              
                
                <a class="source" href="js_includes_attachments.html">
                  js_includes_attachments.js
                </a>
              
                
                <a class="source" href="js_includes_avatar.html">
                  js_includes_avatar.js
                </a>
              
                
                <a class="source" href="js_includes_cabrillo.html">
                  js_includes_cabrillo.js
                </a>
              
                
                <a class="source" href="js_includes_clientScript.html">
                  js_includes_clientScript.js
                </a>
              
                
                <a class="source" href="js_includes_common.html">
                  js_includes_common.js
                </a>
              
                
                <a class="source" href="js_includes_controls.html">
                  js_includes_controls.js
                </a>
              
                
                <a class="source" href="js_includes_customer.html">
                  js_includes_customer.js
                </a>
              
                
                <a class="source" href="js_includes_data.html">
                  js_includes_data.js
                </a>
              
                
                <a class="source" href="js_includes_datetime.html">
                  js_includes_datetime.js
                </a>
              
                
                <a class="source" href="js_includes_doctype.html">
                  js_includes_doctype.js
                </a>
              
                
                <a class="source" href="js_includes_form.html">
                  js_includes_form.js
                </a>
              
                
                <a class="source" href="js_includes_form_presence.html">
                  js_includes_form_presence.js
                </a>
              
                
                <a class="source" href="js_includes_glide.html">
                  js_includes_glide.js
                </a>
              
                
                <a class="source" href="js_includes_i18n.html">
                  js_includes_i18n.js
                </a>
              
                
                <a class="source" href="js_includes_last_doctype.html">
                  js_includes_last_doctype.js
                </a>
              
                
                <a class="source" href="js_includes_link.html">
                  js_includes_link.js
                </a>
              
                
                <a class="source" href="js_includes_list_edit_doctype.html">
                  js_includes_list_edit_doctype.js
                </a>
              
                
                <a class="source" href="js_includes_listv2_doctype.html">
                  js_includes_listv2_doctype.js
                </a>
              
                
                <a class="source" href="js_includes_mention.html">
                  js_includes_mention.js
                </a>
              
                
                <a class="source" href="js_includes_messaging.html">
                  js_includes_messaging.js
                </a>
              
                
                <a class="source" href="js_includes_ng_amb.html">
                  js_includes_ng_amb.js
                </a>
              
                
                <a class="source" href="js_includes_notification.html">
                  js_includes_notification.js
                </a>
              
                
                <a class="source" href="js_includes_presence.html">
                  js_includes_presence.js
                </a>
              
                
                <a class="source" href="js_includes_resources.html">
                  js_includes_resources.js
                </a>
              
                
                <a class="source" href="js_includes_sorting_new.html">
                  js_includes_sorting_new.js
                </a>
              
                
                <a class="source" href="js_includes_sp.html">
                  js_includes_sp.js
                </a>
              
                
                <a class="source" href="js_includes_sp_core.html">
                  js_includes_sp_core.js
                </a>
              
                
                <a class="source" href="js_includes_sp_deps.html">
                  js_includes_sp_deps.js
                </a>
              
                
                <a class="source" href="js_includes_sp_tinymce.html">
                  js_includes_sp_tinymce.js
                </a>
              
                
                <a class="source" href="js_includes_stream.html">
                  js_includes_stream.js
                </a>
              
                
                <a class="source" href="js_includes_ui.html">
                  js_includes_ui.js
                </a>
              
                
                <a class="source" href="js_includes_ui16_form.html">
                  js_includes_ui16_form.js
                </a>
              
                
                <a class="source" href="js_includes_ui_popover.html">
                  js_includes_ui_popover.js
                </a>
              
                
                <a class="source" href="js_includes_user_profile.html">
                  js_includes_user_profile.js
                </a>
              
                
                <a class="source" href="js_includes_util.html">
                  js_includes_util.js
                </a>
              
                
                <a class="source" href="list.html">
                  list.js
                </a>
              
                
                <a class="source" href="list_filter.html">
                  list_filter.js
                </a>
              
                
                <a class="source" href="magellan.CreateFavoriteModal.html">
                  magellan.CreateFavoriteModal.js
                </a>
              
                
                <a class="source" href="mentio.html">
                  mentio.js
                </a>
              
                
                <a class="source" href="modal.html">
                  modal.js
                </a>
              
                
                <a class="source" href="modals.html">
                  modals.js
                </a>
              
                
                <a class="source" href="navigation.html">
                  navigation.js
                </a>
              
                
                <a class="source" href="newtag-it.html">
                  newtag-it.js
                </a>
              
                
                <a class="source" href="ng-sortable.html">
                  ng-sortable.js
                </a>
              
                
                <a class="source" href="page_title.html">
                  page_title.js
                </a>
              
                
                <a class="source" href="popover.html">
                  popover.js
                </a>
              
                
                <a class="source" href="popovers.html">
                  popovers.js
                </a>
              
                
                <a class="source" href="popupdivs14.html">
                  popupdivs14.js
                </a>
              
                
                <a class="source" href="popups.html">
                  popups.js
                </a>
              
                
                <a class="source" href="prism.html">
                  prism.js
                </a>
              
                
                <a class="source" href="prototype.effects.html">
                  prototype.effects.js
                </a>
              
                
                <a class="source" href="prototype.hidefix.html">
                  prototype.hidefix.js
                </a>
              
                
                <a class="source" href="prototype.html">
                  prototype.js
                </a>
              
                
                <a class="source" href="prototype.plugin.html">
                  prototype.plugin.js
                </a>
              
                
                <a class="source" href="prototype.template.html">
                  prototype.template.js
                </a>
              
                
                <a class="source" href="provider.defaultJSAutocomplete.html">
                  provider.defaultJSAutocomplete.js
                </a>
              
                
                <a class="source" href="provider.linkContentTypes.html">
                  provider.linkContentTypes.js
                </a>
              
                
                <a class="source" href="scoped_object_generators.html">
                  scoped_object_generators.js
                </a>
              
                
                <a class="source" href="scrollable.html">
                  scrollable.js
                </a>
              
                
                <a class="source" href="scrollspy.html">
                  scrollspy.js
                </a>
              
                
                <a class="source" href="section.html">
                  section.js
                </a>
              
                
                <a class="source" href="select2.html">
                  select2.js
                </a>
              
                
                <a class="source" href="selects.html">
                  selects.js
                </a>
              
                
                <a class="source" href="service.AMB.html">
                  service.AMB.js
                </a>
              
                
                <a class="source" href="service.authInterceptor.html">
                  service.authInterceptor.js
                </a>
              
                
                <a class="source" href="service.avatarProfilePersister.html">
                  service.avatarProfilePersister.js
                </a>
              
                
                <a class="source" href="service.dateUtils.html">
                  service.dateUtils.js
                </a>
              
                
                <a class="source" href="service.debounceFn.html">
                  service.debounceFn.js
                </a>
              
                
                <a class="source" href="service.filterExpressionParser.html">
                  service.filterExpressionParser.js
                </a>
              
                
                <a class="source" href="service.getTemplateUrl.html">
                  service.getTemplateUrl.js
                </a>
              
                
                <a class="source" href="service.guidedToursService.html">
                  service.guidedToursService.js
                </a>
              
                
                <a class="source" href="service.i18n.html">
                  service.i18n.js
                </a>
              
                
                <a class="source" href="service.md5.html">
                  service.md5.js
                </a>
              
                
                <a class="source" href="service.nowServer.html">
                  service.nowServer.js
                </a>
              
                
                <a class="source" href="service.nowStream.html">
                  service.nowStream.js
                </a>
              
                
                <a class="source" href="service.priorityQueue.html">
                  service.priorityQueue.js
                </a>
              
                
                <a class="source" href="service.progressDialog.html">
                  service.progressDialog.js
                </a>
              
                
                <a class="source" href="service.queryFilter.html">
                  service.queryFilter.js
                </a>
              
                
                <a class="source" href="service.snComplexPopoverService.html">
                  service.snComplexPopoverService.js
                </a>
              
                
                <a class="source" href="service.snComposingPresence.html">
                  service.snComposingPresence.js
                </a>
              
                
                <a class="source" href="service.snConnect.html">
                  service.snConnect.js
                </a>
              
                
                <a class="source" href="service.snCustomEvent.html">
                  service.snCustomEvent.js
                </a>
              
                
                <a class="source" href="service.snMention.html">
                  service.snMention.js
                </a>
              
                
                <a class="source" href="service.snNotification.html">
                  service.snNotification.js
                </a>
              
                
                <a class="source" href="service.snNotifier.html">
                  service.snNotifier.js
                </a>
              
                
                <a class="source" href="service.snResource.html">
                  service.snResource.js
                </a>
              
                
                <a class="source" href="service.snTabActivity.html">
                  service.snTabActivity.js
                </a>
              
                
                <a class="source" href="service.spCodeEditorAutocomplete.html">
                  service.spCodeEditorAutocomplete.js
                </a>
              
                
                <a class="source" href="service.spCommunicator.html">
                  service.spCommunicator.js
                </a>
              
                
                <a class="source" href="service.spFileSelect.html">
                  service.spFileSelect.js
                </a>
              
                
                <a class="source" href="service.spPreference.html">
                  service.spPreference.js
                </a>
              
                
                <a class="source" href="service.spUtil.html">
                  service.spUtil.js
                </a>
              
                
                <a class="source" href="service.urlTools.html">
                  service.urlTools.js
                </a>
              
                
                <a class="source" href="service.userData.html">
                  service.userData.js
                </a>
              
                
                <a class="source" href="service.userPreferences.html">
                  service.userPreferences.js
                </a>
              
                
                <a class="source" href="simpleStorage.html">
                  simpleStorage.js
                </a>
              
                
                <a class="source" href="snPolyfill.html">
                  snPolyfill.js
                </a>
              
                
                <a class="source" href="snPopover.html">
                  snPopover.js
                </a>
              
                
                <a class="source" href="snTimeAgoSettings.html">
                  snTimeAgoSettings.js
                </a>
              
                
                <a class="source" href="snm.auth.data.module.html">
                  snm.auth.data.module.js
                </a>
              
                
                <a class="source" href="snm.serviceCatalog.data.shim.html">
                  snm.serviceCatalog.data.shim.js
                </a>
              
                
                <a class="source" href="snm.serviceCatalog.form.module.html">
                  snm.serviceCatalog.form.module.js
                </a>
              
                
                <a class="source" href="sp.geo.html">
                  sp.geo.js
                </a>
              
                
                <a class="source" href="streamButton.html">
                  streamButton.js
                </a>
              
                
                <a class="source" href="tabbable.html">
                  tabbable.js
                </a>
              
                
                <a class="source" href="tables.html">
                  tables.js
                </a>
              
                
                <a class="source" href="tabs.html">
                  tabs.js
                </a>
              
                
                <a class="source" href="tabs2_14.html">
                  tabs2_14.js
                </a>
              
                
                <a class="source" href="templates.html">
                  templates.js
                </a>
              
                
                <a class="source" href="textutil.html">
                  textutil.js
                </a>
              
                
                <a class="source" href="timeAgo.html">
                  timeAgo.js
                </a>
              
                
                <a class="source" href="tooltip.html">
                  tooltip.js
                </a>
              
                
                <a class="source" href="tooltips.html">
                  tooltips.js
                </a>
              
                
                <a class="source" href="transaction_scope_includes.html">
                  transaction_scope_includes.js
                </a>
              
                
                <a class="source" href="transition.html">
                  transition.js
                </a>
              
                
                <a class="source" href="ui-bootstrap-tpls-1.1.2.html">
                  ui-bootstrap-tpls-1.1.2.js
                </a>
              
                
                <a class="source" href="uiPolicyFactory.html">
                  uiPolicyFactory.js
                </a>
              
                
                <a class="source" href="uiPolicyTypes.html">
                  uiPolicyTypes.js
                </a>
              
                
                <a class="source" href="ui_policy.html">
                  ui_policy.js
                </a>
              
                
                <a class="source" href="utils14.html">
                  utils14.js
                </a>
              
                
                <a class="source" href="velocity.ui.html">
                  velocity.ui.js
                </a>
              
                
                <a class="source" href="viewLayout.html">
                  viewLayout.js
                </a>
              
                
                <a class="source" href="xmlUtil.html">
                  xmlUtil.js
                </a>
              
                
                <a class="source" href="xmlhttp.html">
                  xmlhttp.js
                </a>
              
                
                <a class="source" href="z_last_include.html">
                  z_last_include.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>js_includes_common.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/js_includes_common.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common'</span>, [
  <span class="hljs-string">'ngSanitize'</span>,
  <span class="hljs-string">'ngAnimate'</span>,
  <span class="hljs-string">'sn.common.avatar'</span>,
  <span class="hljs-string">'sn.common.controls'</span>,
  <span class="hljs-string">'sn.common.datetime'</span>,
  <span class="hljs-string">'sn.common.glide'</span>,
  <span class="hljs-string">'sn.common.i18n'</span>,
  <span class="hljs-string">'sn.common.link'</span>,
  <span class="hljs-string">'sn.common.mention'</span>,
  <span class="hljs-string">'sn.common.messaging'</span>,
  <span class="hljs-string">'sn.common.notification'</span>,
  <span class="hljs-string">'sn.common.presence'</span>,
  <span class="hljs-string">'sn.common.stream'</span>,
  <span class="hljs-string">'sn.common.ui'</span>,
  <span class="hljs-string">'sn.common.user_profile'</span>,
  <span class="hljs-string">'sn.common.util'</span>
]);
angular.module(<span class="hljs-string">'ng.common'</span>, [
  <span class="hljs-string">'sn.common'</span>
]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/dist/templates.js */</span>
angular.module(<span class="hljs-string">'sn.common.dist.templates'</span>, []);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/datetime/js_includes_datetime.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/datetime/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.datetime'</span>, [
  <span class="hljs-string">'sn.common.i18n'</span>
]);
angular.module(<span class="hljs-string">'sn.timeAgo'</span>, [
  <span class="hljs-string">'sn.common.datetime'</span>
]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/datetime/directive.snTimeAgo.js */</span>
angular.module(<span class="hljs-string">'sn.common.datetime'</span>).constant(<span class="hljs-string">'DATE_GRANULARITY'</span>, {
  <span class="hljs-attr">DATETIME</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">DATE</span>: <span class="hljs-number">2</span>
});
angular.module(<span class="hljs-string">'sn.common.datetime'</span>).factory(<span class="hljs-string">'timeAgoTimer'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$interval, $rootScope, DATE_GRANULARITY</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> digestInterval;
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">displayGranularityType</span>) </span>{
    displayGranularityType = <span class="hljs-keyword">typeof</span> displayGranularityType !== <span class="hljs-string">'undefined'</span> ? displayGranularityType : DATE_GRANULARITY.DATETIME;
    <span class="hljs-keyword">if</span> (!digestInterval &amp;&amp; displayGranularityType == DATE_GRANULARITY.DATETIME)
      digestInterval = $interval(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $rootScope.$broadcast(<span class="hljs-string">'sn.TimeAgo.tick'</span>);
      }, <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Date</span>.now();
  };
});
angular.module(<span class="hljs-string">'sn.common.datetime'</span>).factory(<span class="hljs-string">'timeAgo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">timeAgoSettings, DATE_GRANULARITY</span>) </span>{
  <span class="hljs-keyword">var</span> service = {
    <span class="hljs-attr">settings</span>: timeAgoSettings.get(),
    <span class="hljs-attr">allowFuture</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allowFuture</span>(<span class="hljs-params">bool</span>) </span>{
      <span class="hljs-keyword">this</span>.settings.allowFuture = bool;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },
    <span class="hljs-attr">toWords</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toWords</span>(<span class="hljs-params">distanceMillis, messageGranularity</span>) </span>{
      messageGranularity = messageGranularity || DATE_GRANULARITY.DATETIME;
      <span class="hljs-keyword">var</span> $l = service.settings.strings;
      <span class="hljs-keyword">var</span> seconds = <span class="hljs-built_in">Math</span>.abs(distanceMillis) / <span class="hljs-number">1000</span>;
      <span class="hljs-keyword">var</span> minutes = seconds / <span class="hljs-number">60</span>;
      <span class="hljs-keyword">var</span> hours = minutes / <span class="hljs-number">60</span>;
      <span class="hljs-keyword">var</span> days = hours / <span class="hljs-number">24</span>;
      <span class="hljs-keyword">var</span> years = days / <span class="hljs-number">365</span>;
      <span class="hljs-keyword">var</span> prefix = $l.prefixAgo;
      <span class="hljs-keyword">var</span> suffix = $l.suffixAgo;
      <span class="hljs-keyword">if</span> ((seconds &lt; <span class="hljs-number">45</span> &amp;&amp; messageGranularity == DATE_GRANULARITY.DATETIME) || (hours &lt; <span class="hljs-number">24</span> &amp;&amp; messageGranularity == DATE_GRANULARITY.DATE))
        prefix = suffix = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">if</span> (service.settings.allowFuture) {
        <span class="hljs-keyword">if</span> (distanceMillis &lt; <span class="hljs-number">0</span>) {
          prefix = suffix = <span class="hljs-string">""</span>;
        }
      }
      <span class="hljs-keyword">if</span> (!service.settings.allowFuture &amp;&amp; distanceMillis &lt; <span class="hljs-number">0</span>)
        prefix = suffix = <span class="hljs-string">""</span>;

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">substitute</span>(<span class="hljs-params">stringOrFunction, number</span>) </span>{
        <span class="hljs-keyword">var</span> string = angular.isFunction(stringOrFunction) ?
          stringOrFunction(number, distanceMillis) : stringOrFunction;
        <span class="hljs-keyword">if</span> (!string)
          <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        <span class="hljs-keyword">var</span> value = ($l.numbers &amp;&amp; $l.numbers[number]) || number;
        <span class="hljs-keyword">return</span> string.replace(<span class="hljs-regexp">/%d/i</span>, value);
      }
      <span class="hljs-keyword">var</span> wantDate = messageGranularity == DATE_GRANULARITY.DATE;
      <span class="hljs-keyword">var</span> wantDateTime = messageGranularity == DATE_GRANULARITY.DATETIME;
      <span class="hljs-keyword">var</span> words = distanceMillis &lt;= <span class="hljs-number">0</span> &amp;&amp; wantDateTime &amp;&amp; substitute($l.justNow, <span class="hljs-number">0</span>) ||
        distanceMillis &lt;= <span class="hljs-number">0</span> &amp;&amp; wantDate &amp;&amp; substitute($l.today, <span class="hljs-number">0</span>) ||
        seconds &lt; <span class="hljs-number">45</span> &amp;&amp; (distanceMillis &gt;= <span class="hljs-number">0</span> || !service.settings.allowFuture) &amp;&amp; wantDateTime &amp;&amp; substitute($l.justNow, <span class="hljs-built_in">Math</span>.round(seconds)) ||
        seconds &lt; <span class="hljs-number">45</span> &amp;&amp; wantDateTime &amp;&amp; substitute($l.seconds, <span class="hljs-built_in">Math</span>.round(seconds)) ||
        seconds &lt; <span class="hljs-number">90</span> &amp;&amp; wantDateTime &amp;&amp; substitute($l.minute, <span class="hljs-number">1</span>) ||
        minutes &lt; <span class="hljs-number">45</span> &amp;&amp; wantDateTime &amp;&amp; substitute($l.minutes, <span class="hljs-built_in">Math</span>.round(minutes)) ||
        minutes &lt; <span class="hljs-number">90</span> &amp;&amp; wantDateTime &amp;&amp; substitute($l.hour, <span class="hljs-number">1</span>) ||
        hours &lt; <span class="hljs-number">24</span> &amp;&amp; wantDateTime &amp;&amp; substitute($l.hours, <span class="hljs-built_in">Math</span>.round(hours)) ||
        hours &lt; <span class="hljs-number">24</span> &amp;&amp; wantDate &amp;&amp; substitute($l.today, <span class="hljs-number">0</span>) ||
        hours &lt; <span class="hljs-number">42</span> &amp;&amp; substitute($l.day, <span class="hljs-number">1</span>) ||
        days &lt; <span class="hljs-number">30</span> &amp;&amp; substitute($l.days, <span class="hljs-built_in">Math</span>.ceil(days)) ||
        days &lt; <span class="hljs-number">45</span> &amp;&amp; substitute($l.month, <span class="hljs-number">1</span>) ||
        days &lt; <span class="hljs-number">365</span> &amp;&amp; substitute($l.months, <span class="hljs-built_in">Math</span>.round(days / <span class="hljs-number">30</span>)) ||
        years &lt; <span class="hljs-number">1.5</span> &amp;&amp; substitute($l.year, <span class="hljs-number">1</span>) ||
        substitute($l.years, <span class="hljs-built_in">Math</span>.round(years));
      <span class="hljs-keyword">var</span> separator = $l.wordSeparator === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">" "</span> : $l.wordSeparator;
      <span class="hljs-keyword">return</span> [prefix, words, suffix].join(separator).trim();
    },
    <span class="hljs-attr">parse</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">iso8601</span>) </span>{
      <span class="hljs-keyword">if</span> (angular.isNumber(iso8601))
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">parseInt</span>(iso8601, <span class="hljs-number">10</span>));
      <span class="hljs-keyword">var</span> s = iso8601.trim();
      s = s.replace(<span class="hljs-regexp">/\.\d+/</span>, <span class="hljs-string">""</span>);
      s = s.replace(<span class="hljs-regexp">/-/</span>, <span class="hljs-string">"/"</span>).replace(<span class="hljs-regexp">/-/</span>, <span class="hljs-string">"/"</span>);
      s = s.replace(<span class="hljs-regexp">/T/</span>, <span class="hljs-string">" "</span>).replace(<span class="hljs-regexp">/Z/</span>, <span class="hljs-string">" UTC"</span>);
      s = s.replace(<span class="hljs-regexp">/([\+\-]\d\d)\:?(\d\d)/</span>, <span class="hljs-string">" $1$2"</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(s);
    }
  };
  <span class="hljs-keyword">return</span> service;
});
angular.module(<span class="hljs-string">'sn.common.datetime'</span>).directive(<span class="hljs-string">"snTimeAgo"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">timeAgoSettings, $rootScope, timeAgo, timeAgoTimer, DATE_GRANULARITY</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">"E"</span>,
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;time title="{{ ::titleTime }}"&gt;{{timeAgo}}&lt;/time&gt;'</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">timestamp</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">local</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope</span>) </span>{
      timeAgoSettings.ready.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        timeAgoTimer(DATE_GRANULARITY.DATETIME)
        scope.$on(<span class="hljs-string">'sn.TimeAgo.tick'</span>, setTimeAgo);
        setTimeAgo();
      });

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setTimeAgo</span>(<span class="hljs-params"></span>) </span>{
        scope.timeAgo = timeAgoConverter(scope.timestamp, <span class="hljs-literal">true</span>);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">timeAgoConverter</span>(<span class="hljs-params">input, noFuture</span>) </span>{
        <span class="hljs-keyword">if</span> (!input)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">var</span> allowFuture = !noFuture;
        <span class="hljs-keyword">var</span> date = timeAgo.parse(input);
        <span class="hljs-keyword">if</span> (scope.local) {
          scope.titleTime = input;
          <span class="hljs-keyword">return</span> timeAgo.allowFuture(allowFuture).toWords(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() - date);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.toString.call(date) !== <span class="hljs-string">"[object Date]"</span> &amp;&amp; <span class="hljs-built_in">Object</span>.prototype.toString.call(date) !== <span class="hljs-string">"[object Number]"</span>)
          <span class="hljs-keyword">return</span> input;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.toString.call(date) == <span class="hljs-string">"[object Date]"</span> &amp;&amp; <span class="hljs-built_in">isNaN</span>(date.getTime()))
          <span class="hljs-keyword">return</span> input;
        setTitleTime(date);
        <span class="hljs-keyword">var</span> currentDate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        currentDate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(currentDate.getUTCFullYear(), currentDate.getUTCMonth(), currentDate.getUTCDate(), currentDate.getUTCHours(), currentDate.getUTCMinutes(), currentDate.getUTCSeconds());
        <span class="hljs-keyword">var</span> diff = currentDate - date;
        <span class="hljs-keyword">return</span> timeAgo.allowFuture(allowFuture).toWords(diff);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setTitleTime</span>(<span class="hljs-params">date</span>) </span>{
        <span class="hljs-keyword">var</span> t = date.getTime();
        <span class="hljs-keyword">var</span> o = date.getTimezoneOffset();
        t -= o * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;
        scope.titleTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(t).toLocaleString();
      }
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/datetime/directive.snDayAgo.js */</span>
angular.module(<span class="hljs-string">'sn.common.datetime'</span>).directive(<span class="hljs-string">"snDayAgo"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">timeAgoSettings, $rootScope, timeAgo, timeAgoTimer, DATE_GRANULARITY</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">"E"</span>,
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;time&gt;{{dayAgo}}&lt;/time&gt;'</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">date</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope</span>) </span>{
      timeAgoSettings.ready.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        setDayAgo();
      });

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setDayAgo</span>(<span class="hljs-params"></span>) </span>{
        scope.dayAgo = dayAgoConverter(scope.date, <span class="hljs-string">"noFuture"</span>);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dayAgoConverter</span>(<span class="hljs-params">input, option</span>) </span>{
        <span class="hljs-keyword">if</span> (!input) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">var</span> allowFuture = !((option === <span class="hljs-string">'noFuture'</span>) || (option === <span class="hljs-string">'no_future'</span>));
        <span class="hljs-keyword">var</span> date = timeAgo.parse(input);
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.toString.call(date) !== <span class="hljs-string">"[object Date]"</span>)
          <span class="hljs-keyword">return</span> input;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(date.getTime()))
          <span class="hljs-keyword">return</span> input;
        <span class="hljs-keyword">var</span> diff = timeAgoTimer(DATE_GRANULARITY.DATE) - date;
        <span class="hljs-keyword">return</span> timeAgo.allowFuture(allowFuture).toWords(diff, DATE_GRANULARITY.DATE);
      }
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/datetime/snTimeAgoSettings.js */</span>
angular.module(<span class="hljs-string">'sn.common.datetime'</span>).provider(<span class="hljs-string">'snTimeAgoSettings'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> INIT_NEVER = <span class="hljs-string">'never'</span>;
  <span class="hljs-keyword">var</span> INIT_AUTO = <span class="hljs-string">'auto'</span>;
  <span class="hljs-keyword">var</span> INIT_MANUAL = <span class="hljs-string">'manual'</span>;
  <span class="hljs-keyword">var</span> _initMethod = INIT_AUTO;
  <span class="hljs-keyword">this</span>.setInitializationMethod = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">init</span>) </span>{
    <span class="hljs-keyword">switch</span> (init) {
      <span class="hljs-attr">default</span>: init = INIT_AUTO;
      <span class="hljs-keyword">case</span> INIT_NEVER:
          <span class="hljs-keyword">case</span> INIT_AUTO:
          <span class="hljs-keyword">case</span> INIT_MANUAL:
          _initMethod = init;
        <span class="hljs-keyword">break</span>;
    }
  };
  <span class="hljs-keyword">this</span>.$get = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i18n, $q</span>) </span>{
    <span class="hljs-keyword">var</span> settings = {
      <span class="hljs-attr">allowFuture</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">dateOnly</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">strings</span>: {}
    };
    <span class="hljs-keyword">var</span> _initialized = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> ready = $q.defer();

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initialize</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (_initMethod === INIT_NEVER) {
        <span class="hljs-keyword">return</span> $q.reject();
      }
      <span class="hljs-keyword">if</span> (!_initialized) {
        _initialized = <span class="hljs-literal">true</span>;
        i18n.getMessages([<span class="hljs-string">'%d ago'</span>, <span class="hljs-string">'%d from now'</span>, <span class="hljs-string">'just now'</span>,
          <span class="hljs-string">'less than a minute'</span>, <span class="hljs-string">'about a minute'</span>, <span class="hljs-string">'%d minutes'</span>, <span class="hljs-string">'about an hour'</span>, <span class="hljs-string">'about %d hours'</span>, <span class="hljs-string">'today'</span>, <span class="hljs-string">'a day'</span>, <span class="hljs-string">'%d days'</span>,
          <span class="hljs-string">'about a month'</span>, <span class="hljs-string">'%d months'</span>, <span class="hljs-string">'about a year'</span>, <span class="hljs-string">'about a year'</span>, <span class="hljs-string">'%d years'</span>
        ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msgs</span>) </span>{
          settings.strings = {
            <span class="hljs-attr">ago</span>: msgs[<span class="hljs-string">'%d ago'</span>],
            <span class="hljs-attr">fromNow</span>: msgs[<span class="hljs-string">'%d from now'</span>],
            <span class="hljs-attr">justNow</span>: msgs[<span class="hljs-string">"just now"</span>],
            <span class="hljs-attr">seconds</span>: msgs[<span class="hljs-string">"less than a minute"</span>],
            <span class="hljs-attr">minute</span>: msgs[<span class="hljs-string">"about a minute"</span>],
            <span class="hljs-attr">minutes</span>: msgs[<span class="hljs-string">"%d minutes"</span>],
            <span class="hljs-attr">hour</span>: msgs[<span class="hljs-string">"about an hour"</span>],
            <span class="hljs-attr">hours</span>: msgs[<span class="hljs-string">"about %d hours"</span>],
            <span class="hljs-attr">day</span>: msgs[<span class="hljs-string">"a day"</span>],
            <span class="hljs-attr">days</span>: msgs[<span class="hljs-string">"%d days"</span>],
            <span class="hljs-attr">month</span>: msgs[<span class="hljs-string">"about a month"</span>],
            <span class="hljs-attr">months</span>: msgs[<span class="hljs-string">"%d months"</span>],
            <span class="hljs-attr">year</span>: msgs[<span class="hljs-string">"about a year"</span>],
            <span class="hljs-attr">years</span>: msgs[<span class="hljs-string">"%d years"</span>],
            <span class="hljs-attr">today</span>: msgs[<span class="hljs-string">"today"</span>],
            <span class="hljs-attr">wordSeparator</span>: msgs[<span class="hljs-string">"timeago_number_separator"</span>],
            <span class="hljs-attr">numbers</span>: []
          };
          ready.resolve();
        });
      }
      <span class="hljs-keyword">return</span> ready.promise;
    }
    <span class="hljs-keyword">if</span> (_initMethod === INIT_AUTO) {
      initialize();
    }
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">initialize</span>: initialize,
      <span class="hljs-attr">ready</span>: ready.promise,
      <span class="hljs-attr">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> settings;
      },
      <span class="hljs-attr">set</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span>(<span class="hljs-params">translated</span>) </span>{
        settings = angular.extend(settings, translated);
      }
    };
  };
}).factory(<span class="hljs-string">'timeAgoSettings'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">snTimeAgoSettings</span>) </span>{
  <span class="hljs-keyword">return</span> snTimeAgoSettings;
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/glide/js_includes_glide.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/glide/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.glide'</span>, [
  <span class="hljs-string">'sn.common.util'</span>
]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/glide/factory.glideUrlBuilder.js */</span>
angular.module(<span class="hljs-string">'sn.common.glide'</span>).factory(<span class="hljs-string">'glideUrlBuilder'</span>, [<span class="hljs-string">'$window'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$window</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GlideUrl</span>(<span class="hljs-params">contextPath</span>) </span>{
    <span class="hljs-keyword">var</span> objDef = {
      <span class="hljs-attr">contextPath</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">params</span>: {},
      <span class="hljs-attr">encodedString</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">encode</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">setFromCurrent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.setFromString($<span class="hljs-built_in">window</span>.location.href);
      },
      <span class="hljs-attr">setFromString</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">href</span>) </span>{
        <span class="hljs-keyword">var</span> pos = href.indexOf(<span class="hljs-string">'?'</span>);
        <span class="hljs-keyword">if</span> (pos &lt; <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">this</span>.contextPath = href;
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">this</span>.contextPath = href.slice(<span class="hljs-number">0</span>, pos);
        <span class="hljs-keyword">var</span> hashes = href.slice(pos + <span class="hljs-number">1</span>).split(<span class="hljs-string">'&amp;'</span>);
        <span class="hljs-keyword">var</span> i = hashes.length;
        <span class="hljs-keyword">while</span> (i--) {
          <span class="hljs-keyword">var</span> pos = hashes[i].indexOf(<span class="hljs-string">'='</span>);
          <span class="hljs-keyword">this</span>.params[hashes[i].substring(<span class="hljs-number">0</span>, pos)] = hashes[i].substring(++pos);
        }
      },
      <span class="hljs-attr">setContextPath</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{
        <span class="hljs-keyword">this</span>.contextPath = c;
      },
      <span class="hljs-attr">getParam</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.params[p];
      },
      <span class="hljs-attr">getParams</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.params;
      },
      <span class="hljs-attr">addParam</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, value</span>) </span>{
        <span class="hljs-keyword">this</span>.params[name] = value;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
      },
      <span class="hljs-attr">addToken</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> g_ck != <span class="hljs-string">'undefined'</span> &amp;&amp; g_ck != <span class="hljs-string">""</span>)
          <span class="hljs-keyword">this</span>.addParam(<span class="hljs-string">'sysparm_ck'</span>, g_ck);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
      },
      <span class="hljs-attr">deleteParam</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.params[name];
      },
      <span class="hljs-attr">addEncodedString</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) </span>{
        <span class="hljs-keyword">if</span> (!s)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (s.substr(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) != <span class="hljs-string">"&amp;"</span>)
          <span class="hljs-keyword">this</span>.encodedString += <span class="hljs-string">"&amp;"</span>;
        <span class="hljs-keyword">this</span>.encodedString += s;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
      },
      <span class="hljs-attr">getQueryString</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">additionalParams</span>) </span>{
        <span class="hljs-keyword">var</span> qs = <span class="hljs-keyword">this</span>._getParamsForURL(<span class="hljs-keyword">this</span>.params);
        qs += <span class="hljs-keyword">this</span>._getParamsForURL(additionalParams);
        qs += <span class="hljs-keyword">this</span>.encodedString;
        <span class="hljs-keyword">if</span> (qs.length == <span class="hljs-number">0</span>)
          <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        <span class="hljs-keyword">return</span> qs.substring(<span class="hljs-number">1</span>);
      },
      <span class="hljs-attr">_getParamsForURL</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">params</span>) </span>{
        <span class="hljs-keyword">if</span> (!params)
          <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
        <span class="hljs-keyword">var</span> url = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> n <span class="hljs-keyword">in</span> params) {
          <span class="hljs-keyword">var</span> p = params[n] || <span class="hljs-string">''</span>;
          url += <span class="hljs-string">'&amp;'</span> + n + <span class="hljs-string">'='</span> + (<span class="hljs-keyword">this</span>.encode ? <span class="hljs-built_in">encodeURIComponent</span>(p + <span class="hljs-string">''</span>) : p);
        }
        <span class="hljs-keyword">return</span> url;
      },
      <span class="hljs-attr">getURL</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">additionalParams</span>) </span>{
        <span class="hljs-keyword">var</span> url = <span class="hljs-keyword">this</span>.contextPath;
        <span class="hljs-keyword">var</span> qs = <span class="hljs-keyword">this</span>.getQueryString(additionalParams);
        <span class="hljs-keyword">if</span> (qs)
          url += <span class="hljs-string">"?"</span> + qs;
        <span class="hljs-keyword">return</span> url;
      },
      <span class="hljs-attr">setEncode</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">b</span>) </span>{
        <span class="hljs-keyword">this</span>.encode = b;
      },
      <span class="hljs-attr">toString</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'GlideURL'</span>;
      }
    }
    <span class="hljs-keyword">return</span> objDef;
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">newGlideUrl</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">contextPath</span>) </span>{
      <span class="hljs-keyword">var</span> glideUrl = <span class="hljs-keyword">new</span> GlideUrl();
      glideUrl.setFromString(contextPath ? contextPath : <span class="hljs-string">''</span>);
      <span class="hljs-keyword">return</span> glideUrl;
    },
    <span class="hljs-attr">refresh</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      $<span class="hljs-built_in">window</span>.location.replace($<span class="hljs-built_in">window</span>.location.href);
    },
    <span class="hljs-attr">getCancelableLink</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">link</span>) </span>{
      <span class="hljs-keyword">if</span> ($<span class="hljs-built_in">window</span>.NOW &amp;&amp; $<span class="hljs-built_in">window</span>.NOW.g_cancelPreviousTransaction) {
        <span class="hljs-keyword">var</span> nextChar = link.indexOf(<span class="hljs-string">'?'</span>) &gt; <span class="hljs-number">-1</span> ? <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">'?'</span>;
        link += nextChar + <span class="hljs-string">"sysparm_cancelable=true"</span>;
      }
      <span class="hljs-keyword">return</span> link;
    }
  };
}]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/glide/service.queryFilter.js */</span>
angular.module(<span class="hljs-string">'sn.common.glide'</span>).factory(<span class="hljs-string">'queryFilter'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">create</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> that = {};
      that.conditions = [];

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newCondition</span>(<span class="hljs-params">field, operator, value, label, displayValue, type</span>) </span>{
        <span class="hljs-keyword">var</span> condition = {
          <span class="hljs-attr">field</span>: field,
          <span class="hljs-attr">operator</span>: operator,
          <span class="hljs-attr">value</span>: value,
          <span class="hljs-attr">displayValue</span>: displayValue,
          <span class="hljs-attr">label</span>: label,
          <span class="hljs-attr">left</span>: <span class="hljs-literal">null</span>,
          <span class="hljs-attr">right</span>: <span class="hljs-literal">null</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-literal">null</span>,
          <span class="hljs-attr">setValue</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, displayValue</span>) </span>{
            <span class="hljs-keyword">this</span>.value = value;
            <span class="hljs-keyword">this</span>.displayValue = displayValue ? displayValue : value;
          }
        };
        <span class="hljs-keyword">if</span> (type)
          condition.type = type;
        <span class="hljs-keyword">return</span> condition;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addCondition</span>(<span class="hljs-params">condition</span>) </span>{
        that.conditions.push(condition);
        <span class="hljs-keyword">return</span> condition;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeCondition</span>(<span class="hljs-params">condition</span>) </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = that.conditions.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
          <span class="hljs-keyword">if</span> (that.conditions[i] === condition)
            that.conditions.splice(i, <span class="hljs-number">1</span>);
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getConditionsByField</span>(<span class="hljs-params">conditions, field</span>) </span>{
        <span class="hljs-keyword">var</span> conditionsToReturn = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> condition <span class="hljs-keyword">in</span> conditions) {
          <span class="hljs-keyword">if</span> (conditions.hasOwnProperty(condition)) {
            <span class="hljs-keyword">if</span> (conditions[condition].field == field)
              conditionsToReturn.push(conditions[condition]);
          }
        }
        <span class="hljs-keyword">return</span> conditionsToReturn;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encodeCondition</span>(<span class="hljs-params">condition</span>) </span>{
        <span class="hljs-keyword">var</span> output = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">if</span> (condition.hasOwnProperty(<span class="hljs-string">"left"</span>) &amp;&amp; condition.left) {
          output += encodeCondition(condition.left);
        }
        <span class="hljs-keyword">if</span> (condition.hasOwnProperty(<span class="hljs-string">"right"</span>) &amp;&amp; condition.right) {
          <span class="hljs-keyword">var</span> right = encodeCondition(condition.right);
          <span class="hljs-keyword">if</span> (right.length &gt; <span class="hljs-number">0</span>) {
            output += <span class="hljs-string">"^"</span> + condition.type + right;
          }
        }
        <span class="hljs-keyword">if</span> (condition.field) {
          output += condition.field;
          output += condition.operator;
          <span class="hljs-keyword">if</span> (condition.value !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> condition.value !== <span class="hljs-string">"undefined"</span>)
            output += condition.value;
        }
        <span class="hljs-keyword">return</span> output;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createEncodedQuery</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> eq = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">var</span> ca = that.conditions;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ca.length; i++) {
          <span class="hljs-keyword">var</span> condition = ca[i];
          <span class="hljs-keyword">if</span> (eq.length)
            eq += <span class="hljs-string">'^'</span>;
          eq += encodeCondition(condition);
        }
        eq += <span class="hljs-string">"^EQ"</span>;
        <span class="hljs-keyword">return</span> eq;
      }
      that.addCondition = addCondition;
      that.newCondition = newCondition;
      that.createEncodedQuery = createEncodedQuery;
      that.getConditionsByField = getConditionsByField;
      that.removeCondition = removeCondition;
      <span class="hljs-keyword">return</span> that;
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/glide/service.filterExpressionParser.js */</span>
angular.module(<span class="hljs-string">'sn.common.glide'</span>).factory(<span class="hljs-string">'filterExpressionParser'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">var</span> operatorExpressions = [{
    <span class="hljs-attr">wildcardExp</span>: <span class="hljs-string">'(.*)'</span>,
    <span class="hljs-attr">operator</span>: <span class="hljs-string">'STARTSWITH'</span>,
    <span class="hljs-attr">toExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filter</span>) </span>{
      <span class="hljs-keyword">return</span> filter;
    }
  }, {
    <span class="hljs-attr">wildcardExp</span>: <span class="hljs-string">'^\\*(.*)'</span>,
    <span class="hljs-attr">operator</span>: <span class="hljs-string">'LIKE'</span>,
    <span class="hljs-attr">toExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filter</span>) </span>{
      <span class="hljs-keyword">return</span> (filter === <span class="hljs-string">'*'</span> ? filter : <span class="hljs-string">'*'</span> + filter);
    }
  }, {
    <span class="hljs-attr">wildcardExp</span>: <span class="hljs-string">'^\\.(.*)'</span>,
    <span class="hljs-attr">operator</span>: <span class="hljs-string">'LIKE'</span>,
    <span class="hljs-attr">toExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filter</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-string">'.'</span> + filter;
    }
  }, {
    <span class="hljs-attr">wildcardExp</span>: <span class="hljs-string">'^%(.*)'</span>,
    <span class="hljs-attr">operator</span>: <span class="hljs-string">'ENDSWITH'</span>,
    <span class="hljs-attr">toExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filter</span>) </span>{
      <span class="hljs-keyword">return</span> (filter === <span class="hljs-string">'%'</span> ? filter : <span class="hljs-string">'%'</span> + filter);
    }
  }, {
    <span class="hljs-attr">wildcardExp</span>: <span class="hljs-string">'(.*)%'</span>,
    <span class="hljs-attr">operator</span>: <span class="hljs-string">'LIKE'</span>,
    <span class="hljs-attr">toExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filter</span>) </span>{
      <span class="hljs-keyword">return</span> filter + <span class="hljs-string">'%'</span>;
    }
  }, {
    <span class="hljs-attr">wildcardExp</span>: <span class="hljs-string">'^=(.*)'</span>,
    <span class="hljs-attr">operator</span>: <span class="hljs-string">'='</span>,
    <span class="hljs-attr">toExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filter</span>) </span>{
      <span class="hljs-keyword">return</span> (filter === <span class="hljs-string">'='</span> ? filter : <span class="hljs-string">'='</span> + filter);
    }
  }, {
    <span class="hljs-attr">wildcardExp</span>: <span class="hljs-string">'^!\\*(.*)'</span>,
    <span class="hljs-attr">operator</span>: <span class="hljs-string">'NOT LIKE'</span>,
    <span class="hljs-attr">toExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filter</span>) </span>{
      <span class="hljs-keyword">return</span> (filter === <span class="hljs-string">'!*'</span> || filter === <span class="hljs-string">'!'</span> ? filter : <span class="hljs-string">'!*'</span> + filter);
    }
  }, {
    <span class="hljs-attr">wildcardExp</span>: <span class="hljs-string">'^!=(.*)'</span>,
    <span class="hljs-attr">operator</span>: <span class="hljs-string">'!='</span>,
    <span class="hljs-attr">toExpression</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filter</span>) </span>{
      <span class="hljs-keyword">return</span> (filter === <span class="hljs-string">'!='</span> || filter === <span class="hljs-string">'!'</span> ? filter : <span class="hljs-string">'!='</span> + filter);
    }
  }];
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">getOperatorExpressionForOperator</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">operator</span>) </span>{
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; operatorExpressions.length; i++) {
        <span class="hljs-keyword">var</span> item = operatorExpressions[i];
        <span class="hljs-keyword">if</span> (item.operator === operator)
          <span class="hljs-keyword">return</span> item;
      }
      <span class="hljs-keyword">throw</span> {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'OperatorNotSupported'</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'The operator '</span> + operator + <span class="hljs-string">' is not in the list of operatorExpressions.'</span>
      };
    },
    <span class="hljs-attr">parse</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val, defaultOperator</span>) </span>{
      <span class="hljs-keyword">var</span> parsedValue = {
        <span class="hljs-attr">filterText</span>: val,
        <span class="hljs-attr">operator</span>: defaultOperator || <span class="hljs-string">'STARTSWITH'</span>
      };
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; operatorExpressions.length; i++) {
        <span class="hljs-keyword">var</span> operatorItem = operatorExpressions[i];
        <span class="hljs-keyword">var</span> match = val.match(operatorItem.wildcardExp);
        <span class="hljs-keyword">if</span> (match &amp;&amp; match[<span class="hljs-number">1</span>] !== <span class="hljs-string">''</span>) {
          parsedValue.operator = operatorItem.operator;
          parsedValue.filterText = match[<span class="hljs-number">1</span>];
        }
      }
      <span class="hljs-keyword">return</span> parsedValue;
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/glide/service.userPreferences.js */</span>
angular.module(<span class="hljs-string">'sn.common.glide'</span>).factory(<span class="hljs-string">"userPreferences"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$http, $q, unwrappedHTTPPromise, urlTools</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> preferencesCache = {};

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPreference</span>(<span class="hljs-params">preferenceName</span>) </span>{
    <span class="hljs-keyword">if</span> (preferenceName <span class="hljs-keyword">in</span> preferencesCache)
      <span class="hljs-keyword">return</span> preferencesCache[preferenceName];
    <span class="hljs-keyword">var</span> targetURL = urlTools.getURL(<span class="hljs-string">'user_preference'</span>, {
        <span class="hljs-string">"sysparm_pref_name"</span>: preferenceName,
        <span class="hljs-string">"sysparm_action"</span>: <span class="hljs-string">"get"</span>
      }),
      deferred = $q.defer();
    $http.get(targetURL).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
      deferred.resolve(response.sysparm_pref_value);
    }).error(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, status</span>) </span>{
      deferred.reject(<span class="hljs-string">"Error getting preference "</span> + preferenceName + <span class="hljs-string">": "</span> + status);
    });
    preferencesCache[preferenceName] = deferred.promise;
    <span class="hljs-keyword">return</span> deferred.promise;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setPreference</span>(<span class="hljs-params">preferenceName, preferenceValue</span>) </span>{
    <span class="hljs-keyword">var</span> targetURL = urlTools.getURL(<span class="hljs-string">'user_preference'</span>, {
      <span class="hljs-string">"sysparm_pref_name"</span>: preferenceName,
      <span class="hljs-string">"sysparm_action"</span>: <span class="hljs-string">"set"</span>,
      <span class="hljs-string">"sysparm_pref_value"</span>: <span class="hljs-string">""</span> + preferenceValue
    });
    <span class="hljs-keyword">var</span> httpPromise = $http.get(targetURL);
    addToCache(preferenceName, preferenceValue);
    <span class="hljs-keyword">return</span> unwrappedHTTPPromise(httpPromise);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addToCache</span>(<span class="hljs-params">preferenceName, preferenceValue</span>) </span>{
    preferencesCache[preferenceName] = $q.when(preferenceValue);
  }
  <span class="hljs-keyword">var</span> userPreferences = {
    <span class="hljs-attr">getPreference</span>: getPreference,
    <span class="hljs-attr">setPreference</span>: setPreference,
    <span class="hljs-attr">addToCache</span>: addToCache
  };
  <span class="hljs-keyword">return</span> userPreferences;
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/glide/service.nowStream.js */</span>
angular.module(<span class="hljs-string">'sn.common.glide'</span>).constant(<span class="hljs-string">'nowStreamTimerInterval'</span>, <span class="hljs-number">5000</span>);
angular.module(<span class="hljs-string">'sn.common.glide'</span>).factory(<span class="hljs-string">'nowStream'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$q, $timeout, urlTools, nowStreamTimerInterval, snResource, $log</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">var</span> Stream = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.initialize.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  };
  Stream.prototype = {
    <span class="hljs-attr">initialize</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">table, query, sys_id, processor, interval, source, includeAttachments</span>) </span>{
      <span class="hljs-keyword">this</span>.table = table;
      <span class="hljs-keyword">this</span>.query = query;
      <span class="hljs-keyword">this</span>.sysparmQuery = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">this</span>.sys_id = sys_id;
      <span class="hljs-keyword">this</span>.processor = processor;
      <span class="hljs-keyword">this</span>.lastTimestamp = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">this</span>.inflightRequest = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">this</span>.requestImmediateUpdate = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.interval = interval;
      <span class="hljs-keyword">this</span>.source = source;
      <span class="hljs-keyword">this</span>.includeAttachments = includeAttachments;
      <span class="hljs-keyword">this</span>.stopped = <span class="hljs-literal">true</span>;
    },
    <span class="hljs-attr">setQuery</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sysparmQuery</span>) </span>{
      <span class="hljs-keyword">this</span>.sysparmQuery = sysparmQuery;
    },
    <span class="hljs-attr">poll</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback, preRequestCallback</span>) </span>{
      <span class="hljs-keyword">this</span>.callback = callback;
      <span class="hljs-keyword">this</span>.preRequestCallback = preRequestCallback;
      <span class="hljs-keyword">this</span>._stopPolling();
      <span class="hljs-keyword">this</span>._startPolling();
    },
    <span class="hljs-attr">tap</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.inflightRequest) {
        <span class="hljs-keyword">this</span>._stopPolling();
        <span class="hljs-keyword">this</span>._startPolling();
      } <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">this</span>.requestImmediateUpdate = <span class="hljs-literal">true</span>;
    },
    <span class="hljs-attr">insert</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">field, text</span>) </span>{
      <span class="hljs-keyword">this</span>.insertForEntry(field, text, <span class="hljs-keyword">this</span>.table, <span class="hljs-keyword">this</span>.sys_id);
    },
    <span class="hljs-attr">insertForEntry</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">field, text, table, sys_id</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.insertEntries([{
        <span class="hljs-attr">field</span>: field,
        <span class="hljs-attr">text</span>: text
      }], table, sys_id);
    },
    <span class="hljs-attr">expandMentions</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entryText, mentionIDMap</span>) </span>{
      <span class="hljs-keyword">return</span> entryText.replace(<span class="hljs-regexp">/@\[(.+?)\]/gi</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mention</span>) </span>{
        <span class="hljs-keyword">var</span> mentionedName = mention.substring(<span class="hljs-number">2</span>, mention.length - <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> (mentionIDMap[mentionedName]) {
          <span class="hljs-keyword">return</span> <span class="hljs-string">"@["</span> + mentionIDMap[mentionedName] + <span class="hljs-string">":"</span> + mentionedName + <span class="hljs-string">"]"</span>;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> mention;
        }
      });
    },
    <span class="hljs-attr">insertEntries</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entries, table, sys_id, mentionIDMap</span>) </span>{
      mentionIDMap = mentionIDMap || {};
      <span class="hljs-keyword">var</span> sanitizedEntries = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; entries.length; i++) {
        <span class="hljs-keyword">var</span> entryText = entries[i].text;
        <span class="hljs-keyword">if</span> (entryText &amp;&amp; entryText.endsWith(<span class="hljs-string">'\n'</span>))
          entryText = entryText.substring(<span class="hljs-number">0</span>, entryText.length - <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> (!entryText)
          <span class="hljs-keyword">continue</span>;
        entries[i].text = <span class="hljs-keyword">this</span>.expandMentions(entryText, mentionIDMap);
        sanitizedEntries.push(entries[i]);
      }
      <span class="hljs-keyword">if</span> (sanitizedEntries.length === <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">this</span>._isInserting = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">var</span> url = <span class="hljs-keyword">this</span>._getInsertURL(table, sys_id);
      <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> snResource().post(url, {
        <span class="hljs-attr">entries</span>: sanitizedEntries
      }).then(<span class="hljs-keyword">this</span>._successCallback.bind(<span class="hljs-keyword">this</span>), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $log.warn(<span class="hljs-string">'Error submitting entries'</span>, sanitizedEntries);
      }).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        that._isInserting = <span class="hljs-literal">false</span>;
      });
    },
    <span class="hljs-attr">cancel</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">this</span>._stopPolling();
    },
    <span class="hljs-attr">_startPolling</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> interval = <span class="hljs-keyword">this</span>._getInterval();
      <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> successCallback = <span class="hljs-keyword">this</span>._successCallback.bind(<span class="hljs-keyword">this</span>);
      that.stopped = <span class="hljs-literal">false</span>;

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runPoll</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (that._isInserting) {
          establishNextRequest();
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> (!that.inflightRequest) {
          that.inflightRequest = that._executeRequest();
          that.inflightRequest.then(successCallback);
          that.inflightRequest.finally(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            that.inflightRequest = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (that.requestImmediateUpdate) {
              that.requestImmediateUpdate = <span class="hljs-literal">false</span>;
              establishNextRequest(<span class="hljs-number">0</span>);
            } <span class="hljs-keyword">else</span> {
              establishNextRequest();
            }
          });
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">establishNextRequest</span>(<span class="hljs-params">intervalOverride</span>) </span>{
        <span class="hljs-keyword">if</span> (that.stopped)
          <span class="hljs-keyword">return</span>;
        intervalOverride = (<span class="hljs-built_in">parseFloat</span>(intervalOverride) &gt;= <span class="hljs-number">0</span>) ? intervalOverride : interval;
        $timeout.cancel(that.timer);
        that.timer = $timeout(runPoll, intervalOverride);
      }
      runPoll();
    },
    <span class="hljs-attr">_stopPolling</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.timer)
        $timeout.cancel(<span class="hljs-keyword">this</span>.timer);
      <span class="hljs-keyword">this</span>.stopped = <span class="hljs-literal">true</span>;
    },
    <span class="hljs-attr">_executeRequest</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> url = <span class="hljs-keyword">this</span>._getURL();
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.preRequestCallback) {
        <span class="hljs-keyword">this</span>.preRequestCallback();
      }
      <span class="hljs-keyword">return</span> snResource().get(url);
    },
    <span class="hljs-attr">_getURL</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> params = {
        <span class="hljs-attr">table</span>: <span class="hljs-keyword">this</span>.table,
        <span class="hljs-attr">action</span>: <span class="hljs-keyword">this</span>._getAction(),
        <span class="hljs-attr">sysparm_silent_request</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">sysparm_auto_request</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">sysparm_timestamp</span>: <span class="hljs-keyword">this</span>.lastTimestamp,
        <span class="hljs-attr">include_attachments</span>: <span class="hljs-keyword">this</span>.includeAttachments
      };
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.sys_id) {
        params[<span class="hljs-string">'sys_id'</span>] = <span class="hljs-keyword">this</span>.sys_id;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.sysparmQuery) {
        params[<span class="hljs-string">'sysparm_query'</span>] = <span class="hljs-keyword">this</span>.sysparmQuery;
      }
      <span class="hljs-keyword">var</span> url = urlTools.getURL(<span class="hljs-keyword">this</span>.processor, params);
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.sys_id) {
        url += <span class="hljs-string">"&amp;p="</span> + <span class="hljs-keyword">this</span>.query;
      }
      <span class="hljs-keyword">return</span> url;
    },
    <span class="hljs-attr">_getInsertURL</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">table, sys_id</span>) </span>{
      <span class="hljs-keyword">return</span> urlTools.getURL(<span class="hljs-keyword">this</span>.processor, {
        <span class="hljs-attr">action</span>: <span class="hljs-string">'insert'</span>,
        <span class="hljs-attr">table</span>: table,
        <span class="hljs-attr">sys_id</span>: sys_id,
        <span class="hljs-attr">sysparm_timestamp</span>: <span class="hljs-keyword">this</span>.timestamp || <span class="hljs-number">0</span>,
        <span class="hljs-attr">sysparm_source</span>: <span class="hljs-keyword">this</span>.source
      });
    },
    <span class="hljs-attr">_successCallback</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
      <span class="hljs-keyword">var</span> response = response.data;
      <span class="hljs-keyword">if</span> (response.entries &amp;&amp; response.entries.length) {
        response.entries = <span class="hljs-keyword">this</span>._filterOld(response.entries);
        <span class="hljs-keyword">if</span> (response.entries.length &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">this</span>.lastEntry = angular.copy(response.entries[<span class="hljs-number">0</span>]);
          <span class="hljs-keyword">this</span>.lastTimestamp = response.sys_timestamp || response.entries[<span class="hljs-number">0</span>].sys_timestamp;
        }
      }
      <span class="hljs-keyword">this</span>.callback.call(<span class="hljs-literal">null</span>, response);
    },
    <span class="hljs-attr">_filterOld</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entries</span>) </span>{
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; entries.length; i++) {
        <span class="hljs-keyword">if</span> (entries[i].sys_timestamp == <span class="hljs-keyword">this</span>.lastTimestamp) {
          <span class="hljs-keyword">if</span> (!angular.equals(<span class="hljs-keyword">this</span>._makeComparable(entries[i]), <span class="hljs-keyword">this</span>._makeComparable(<span class="hljs-keyword">this</span>.lastEntry)))
            <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">if</span> (entries[i].sys_timestamp &lt;= <span class="hljs-keyword">this</span>.lastTimestamp)
          <span class="hljs-keyword">return</span> entries.slice(<span class="hljs-number">0</span>, i);
      }
      <span class="hljs-keyword">return</span> entries;
    },
    <span class="hljs-attr">_makeComparable</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry</span>) </span>{
      <span class="hljs-keyword">var</span> copy = angular.copy(entry);
      <span class="hljs-keyword">delete</span> copy.short_description;
      <span class="hljs-keyword">delete</span> copy.display_value;
      <span class="hljs-keyword">return</span> copy;
    },
    <span class="hljs-attr">_getAction</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sys_id ? <span class="hljs-string">'get_new_entries'</span> : <span class="hljs-string">'get_set_entries'</span>;
    },
    <span class="hljs-attr">_getInterval</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.interval)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.interval;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.NOW &amp;&amp; NOW.stream_poll_interval)
        <span class="hljs-keyword">return</span> NOW.stream_poll_interval * <span class="hljs-number">1000</span>;
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> nowStreamTimerInterval;
    }
  };
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">create</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">table, query, sys_id, processor, interval, source</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Stream(table, query, sys_id, processor, interval, source);
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/glide/service.nowServer.js */</span>
angular.module(<span class="hljs-string">'sn.common.glide'</span>).factory(<span class="hljs-string">'nowServer'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$http, $q, userPreferences, angularProcessorUrl, urlTools</span>) </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">getBaseURL</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> angularProcessorUrl;
    },
    <span class="hljs-attr">getPartial</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, partial, parms, callback</span>) </span>{
      <span class="hljs-keyword">var</span> url = <span class="hljs-keyword">this</span>.getPartialURL(partial, parms);
      <span class="hljs-keyword">if</span> (url === scope.url) {
        callback.call();
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">var</span> fn = scope.$on(<span class="hljs-string">'$includeContentLoaded'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        fn.call();
        callback.call();
      });
      scope.url = url;
    },
    <span class="hljs-attr">replaceView</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$location, newView</span>) </span>{
      <span class="hljs-keyword">var</span> p = $location.path();
      <span class="hljs-keyword">var</span> a = p.split(<span class="hljs-string">"/"</span>);
      a[<span class="hljs-number">1</span>] = newView;
      p = a.join(<span class="hljs-string">"/"</span>);
      <span class="hljs-keyword">return</span> p;
    },
    <span class="hljs-attr">getPartialURL</span>: urlTools.getPartialURL,
    <span class="hljs-attr">getURL</span>: urlTools.getURL,
    <span class="hljs-attr">urlFor</span>: urlTools.urlFor,
    <span class="hljs-attr">getPropertyURL</span>: urlTools.getPropertyURL,
    <span class="hljs-attr">setPreference</span>: userPreferences.setPreference,
    <span class="hljs-attr">getPreference</span>: userPreferences.getPreference
  }
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/avatar/js_includes_avatar.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/js_includes_presence.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/js_includes_ng_amb.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/js_includes_amb.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/thirdparty/cometd/org/cometd.js */</span>
<span class="hljs-keyword">this</span>.org = <span class="hljs-keyword">this</span>.org || {};
org.cometd = {};
org.cometd.JSON = {};
org.cometd.JSON.toJSON = org.cometd.JSON.fromJSON = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">object</span>) </span>{
  <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
};
org.cometd.Utils = {};
org.cometd.Utils.isString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> || value === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span> || value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">String</span>;
};
org.cometd.Utils.isArray = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> || value === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>;
};
org.cometd.Utils.inArray = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element, array</span>) </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; array.length; ++i) {
    <span class="hljs-keyword">if</span> (element === array[i]) {
      <span class="hljs-keyword">return</span> i;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
};
org.cometd.Utils.setTimeout = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cometd, funktion, delay</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">try</span> {
      funktion();
    } <span class="hljs-keyword">catch</span> (x) {
      cometd._debug(<span class="hljs-string">'Exception invoking timed function'</span>, funktion, x);
    }
  }, delay);
};
org.cometd.Utils.clearTimeout = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">timeoutHandle</span>) </span>{
  <span class="hljs-built_in">window</span>.clearTimeout(timeoutHandle);
};
org.cometd.TransportRegistry = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _types = [];
  <span class="hljs-keyword">var</span> _transports = {};
  <span class="hljs-keyword">this</span>.getTransportTypes = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _types.slice(<span class="hljs-number">0</span>);
  };
  <span class="hljs-keyword">this</span>.findTransportTypes = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">var</span> result = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      <span class="hljs-keyword">var</span> type = _types[i];
      <span class="hljs-keyword">if</span> (_transports[type].accept(version, crossDomain, url) === <span class="hljs-literal">true</span>) {
        result.push(type);
      }
    }
    <span class="hljs-keyword">return</span> result;
  };
  <span class="hljs-keyword">this</span>.negotiateTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">types, version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      <span class="hljs-keyword">var</span> type = _types[i];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; types.length; ++j) {
        <span class="hljs-keyword">if</span> (type === types[j]) {
          <span class="hljs-keyword">var</span> transport = _transports[type];
          <span class="hljs-keyword">if</span> (transport.accept(version, crossDomain, url) === <span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">return</span> transport;
          }
        }
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };
  <span class="hljs-keyword">this</span>.add = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, transport, index</span>) </span>{
    <span class="hljs-keyword">var</span> existing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      <span class="hljs-keyword">if</span> (_types[i] === type) {
        existing = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">break</span>;
      }
    }
    <span class="hljs-keyword">if</span> (!existing) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> index !== <span class="hljs-string">'number'</span>) {
        _types.push(type);
      } <span class="hljs-keyword">else</span> {
        _types.splice(index, <span class="hljs-number">0</span>, type);
      }
      _transports[type] = transport;
    }
    <span class="hljs-keyword">return</span> !existing;
  };
  <span class="hljs-keyword">this</span>.find = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      <span class="hljs-keyword">if</span> (_types[i] === type) {
        <span class="hljs-keyword">return</span> _transports[type];
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };
  <span class="hljs-keyword">this</span>.remove = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      <span class="hljs-keyword">if</span> (_types[i] === type) {
        _types.splice(i, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">var</span> transport = _transports[type];
        <span class="hljs-keyword">delete</span> _transports[type];
        <span class="hljs-keyword">return</span> transport;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };
  <span class="hljs-keyword">this</span>.clear = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _types = [];
    _transports = {};
  };
  <span class="hljs-keyword">this</span>.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      _transports[_types[i]].reset();
    }
  };
};
org.cometd.Transport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _type;
  <span class="hljs-keyword">var</span> _cometd;
  <span class="hljs-keyword">this</span>.registered = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, cometd</span>) </span>{
    _type = type;
    _cometd = cometd;
  };
  <span class="hljs-keyword">this</span>.unregistered = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _type = <span class="hljs-literal">null</span>;
    _cometd = <span class="hljs-literal">null</span>;
  };
  <span class="hljs-keyword">this</span>._debug = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _cometd._debug.apply(_cometd, <span class="hljs-built_in">arguments</span>);
  };
  <span class="hljs-keyword">this</span>._mixin = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _cometd._mixin.apply(_cometd, <span class="hljs-built_in">arguments</span>);
  };
  <span class="hljs-keyword">this</span>.getConfiguration = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _cometd.getConfiguration();
  };
  <span class="hljs-keyword">this</span>.getAdvice = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _cometd.getAdvice();
  };
  <span class="hljs-keyword">this</span>.setTimeout = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">funktion, delay</span>) </span>{
    <span class="hljs-keyword">return</span> org.cometd.Utils.setTimeout(_cometd, funktion, delay);
  };
  <span class="hljs-keyword">this</span>.clearTimeout = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handle</span>) </span>{
    org.cometd.Utils.clearTimeout(handle);
  };
  <span class="hljs-keyword">this</span>.convertToMessages = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
    <span class="hljs-keyword">if</span> (org.cometd.Utils.isString(response)) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> org.cometd.JSON.fromJSON(response);
      } <span class="hljs-keyword">catch</span> (x) {
        <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Could not convert to JSON the following string'</span>, <span class="hljs-string">'"'</span> + response + <span class="hljs-string">'"'</span>);
        <span class="hljs-keyword">throw</span> x;
      }
    }
    <span class="hljs-keyword">if</span> (org.cometd.Utils.isArray(response)) {
      <span class="hljs-keyword">return</span> response;
    }
    <span class="hljs-keyword">if</span> (response === <span class="hljs-literal">undefined</span> || response === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> [];
    }
    <span class="hljs-keyword">if</span> (response <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Object</span>) {
      <span class="hljs-keyword">return</span> [response];
    }
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Conversion Error '</span> + response + <span class="hljs-string">', typeof '</span> + (<span class="hljs-keyword">typeof</span> response);
  };
  <span class="hljs-keyword">this</span>.accept = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
  };
  <span class="hljs-keyword">this</span>.getType = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _type;
  };
  <span class="hljs-keyword">this</span>.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, metaConnect</span>) </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
  };
  <span class="hljs-keyword">this</span>.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, _type, <span class="hljs-string">'reset'</span>);
  };
  <span class="hljs-keyword">this</span>.abort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, _type, <span class="hljs-string">'aborted'</span>);
  };
  <span class="hljs-keyword">this</span>.toString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getType();
  };
};
org.cometd.Transport.derive = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">baseObject</span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">F</span>(<span class="hljs-params"></span>) </span>{}
  F.prototype = baseObject;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> F();
};
org.cometd.RequestTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org.cometd.Transport();
  <span class="hljs-keyword">var</span> _self = org.cometd.Transport.derive(_super);
  <span class="hljs-keyword">var</span> _requestIds = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> _metaConnectRequest = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> _requests = [];
  <span class="hljs-keyword">var</span> _envelopes = [];

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_coalesceEnvelopes</span>(<span class="hljs-params">envelope</span>) </span>{
    <span class="hljs-keyword">while</span> (_envelopes.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> envelopeAndRequest = _envelopes[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> newEnvelope = envelopeAndRequest[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> newRequest = envelopeAndRequest[<span class="hljs-number">1</span>];
      <span class="hljs-keyword">if</span> (newEnvelope.url === envelope.url &amp;&amp;
        newEnvelope.sync === envelope.sync) {
        _envelopes.shift();
        envelope.messages = envelope.messages.concat(newEnvelope.messages);
        <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Coalesced'</span>, newEnvelope.messages.length, <span class="hljs-string">'messages from request'</span>, newRequest.id);
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_transportSend</span>(<span class="hljs-params">envelope, request</span>) </span>{
    <span class="hljs-keyword">this</span>.transportSend(envelope, request);
    request.expired = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (!envelope.sync) {
      <span class="hljs-keyword">var</span> maxDelay = <span class="hljs-keyword">this</span>.getConfiguration().maxNetworkDelay;
      <span class="hljs-keyword">var</span> delay = maxDelay;
      <span class="hljs-keyword">if</span> (request.metaConnect === <span class="hljs-literal">true</span>) {
        delay += <span class="hljs-keyword">this</span>.getAdvice().timeout;
      }
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'waiting at most'</span>, delay, <span class="hljs-string">'ms for the response, maxNetworkDelay'</span>, maxDelay);
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
      request.timeout = <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        request.expired = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">var</span> errorMessage = <span class="hljs-string">'Request '</span> + request.id + <span class="hljs-string">' of transport '</span> + self.getType() + <span class="hljs-string">' exceeded '</span> + delay + <span class="hljs-string">' ms max network delay'</span>;
        <span class="hljs-keyword">var</span> failure = {
          <span class="hljs-attr">reason</span>: errorMessage
        };
        <span class="hljs-keyword">var</span> xhr = request.xhr;
        failure.httpCode = self.xhrStatus(xhr);
        self.abortXHR(xhr);
        self._debug(errorMessage);
        self.complete(request, <span class="hljs-literal">false</span>, request.metaConnect);
        envelope.onFailure(xhr, envelope.messages, failure);
      }, delay);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_queueSend</span>(<span class="hljs-params">envelope</span>) </span>{
    <span class="hljs-keyword">var</span> requestId = ++_requestIds;
    <span class="hljs-keyword">var</span> request = {
      <span class="hljs-attr">id</span>: requestId,
      <span class="hljs-attr">metaConnect</span>: <span class="hljs-literal">false</span>
    };
    <span class="hljs-keyword">if</span> (_requests.length &lt; <span class="hljs-keyword">this</span>.getConfiguration().maxConnections - <span class="hljs-number">1</span>) {
      _requests.push(request);
      _transportSend.call(<span class="hljs-keyword">this</span>, envelope, request);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'queueing request'</span>, requestId, <span class="hljs-string">'envelope'</span>, envelope);
      _envelopes.push([envelope, request]);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_metaConnectComplete</span>(<span class="hljs-params">request</span>) </span>{
    <span class="hljs-keyword">var</span> requestId = request.id;
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'metaConnect complete, request'</span>, requestId);
    <span class="hljs-keyword">if</span> (_metaConnectRequest !== <span class="hljs-literal">null</span> &amp;&amp; _metaConnectRequest.id !== requestId) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Longpoll request mismatch, completing request '</span> + requestId;
    }
    _metaConnectRequest = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_complete</span>(<span class="hljs-params">request, success</span>) </span>{
    <span class="hljs-keyword">var</span> index = org.cometd.Utils.inArray(request, _requests);
    <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
      _requests.splice(index, <span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">if</span> (_envelopes.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> envelopeAndRequest = _envelopes.shift();
      <span class="hljs-keyword">var</span> nextEnvelope = envelopeAndRequest[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> nextRequest = envelopeAndRequest[<span class="hljs-number">1</span>];
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport dequeued request'</span>, nextRequest.id);
      <span class="hljs-keyword">if</span> (success) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getConfiguration().autoBatch) {
          _coalesceEnvelopes.call(<span class="hljs-keyword">this</span>, nextEnvelope);
        }
        _queueSend.call(<span class="hljs-keyword">this</span>, nextEnvelope);
        <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport completed request'</span>, request.id, nextEnvelope);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          self.complete(nextRequest, <span class="hljs-literal">false</span>, nextRequest.metaConnect);
          <span class="hljs-keyword">var</span> failure = {
            <span class="hljs-attr">reason</span>: <span class="hljs-string">'Previous request failed'</span>
          };
          <span class="hljs-keyword">var</span> xhr = nextRequest.xhr;
          failure.httpCode = self.xhrStatus(xhr);
          nextEnvelope.onFailure(xhr, nextEnvelope.messages, failure);
        }, <span class="hljs-number">0</span>);
      }
    }
  }
  _self.complete = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, success, metaConnect</span>) </span>{
    <span class="hljs-keyword">if</span> (metaConnect) {
      _metaConnectComplete.call(<span class="hljs-keyword">this</span>, request);
    } <span class="hljs-keyword">else</span> {
      _complete.call(<span class="hljs-keyword">this</span>, request, success);
    }
  };
  _self.transportSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, request</span>) </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
  };
  _self.transportSuccess = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, request, responses</span>) </span>{
    <span class="hljs-keyword">if</span> (!request.expired) {
      <span class="hljs-keyword">this</span>.clearTimeout(request.timeout);
      <span class="hljs-keyword">this</span>.complete(request, <span class="hljs-literal">true</span>, request.metaConnect);
      <span class="hljs-keyword">if</span> (responses &amp;&amp; responses.length &gt; <span class="hljs-number">0</span>) {
        envelope.onSuccess(responses);
      } <span class="hljs-keyword">else</span> {
        envelope.onFailure(request.xhr, envelope.messages, {
          <span class="hljs-attr">httpCode</span>: <span class="hljs-number">204</span>
        });
      }
    }
  };
  _self.transportFailure = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, request, failure</span>) </span>{
    <span class="hljs-keyword">if</span> (!request.expired) {
      <span class="hljs-keyword">this</span>.clearTimeout(request.timeout);
      <span class="hljs-keyword">this</span>.complete(request, <span class="hljs-literal">false</span>, request.metaConnect);
      envelope.onFailure(request.xhr, envelope.messages, failure);
    }
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_metaConnectSend</span>(<span class="hljs-params">envelope</span>) </span>{
    <span class="hljs-keyword">if</span> (_metaConnectRequest !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Concurrent metaConnect requests not allowed, request id='</span> + _metaConnectRequest.id + <span class="hljs-string">' not yet completed'</span>;
    }
    <span class="hljs-keyword">var</span> requestId = ++_requestIds;
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'metaConnect send, request'</span>, requestId, <span class="hljs-string">'envelope'</span>, envelope);
    <span class="hljs-keyword">var</span> request = {
      <span class="hljs-attr">id</span>: requestId,
      <span class="hljs-attr">metaConnect</span>: <span class="hljs-literal">true</span>
    };
    _transportSend.call(<span class="hljs-keyword">this</span>, envelope, request);
    _metaConnectRequest = request;
  }
  _self.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, metaConnect</span>) </span>{
    <span class="hljs-keyword">if</span> (metaConnect) {
      _metaConnectSend.call(<span class="hljs-keyword">this</span>, envelope);
    } <span class="hljs-keyword">else</span> {
      _queueSend.call(<span class="hljs-keyword">this</span>, envelope);
    }
  };
  _self.abort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _super.abort();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _requests.length; ++i) {
      <span class="hljs-keyword">var</span> request = _requests[i];
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Aborting request'</span>, request);
      <span class="hljs-keyword">this</span>.abortXHR(request.xhr);
    }
    <span class="hljs-keyword">if</span> (_metaConnectRequest) {
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Aborting metaConnect request'</span>, _metaConnectRequest);
      <span class="hljs-keyword">this</span>.abortXHR(_metaConnectRequest.xhr);
    }
    <span class="hljs-keyword">this</span>.reset();
  };
  _self.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _super.reset();
    _metaConnectRequest = <span class="hljs-literal">null</span>;
    _requests = [];
    _envelopes = [];
  };
  _self.abortXHR = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr</span>) </span>{
    <span class="hljs-keyword">if</span> (xhr) {
      <span class="hljs-keyword">try</span> {
        xhr.abort();
      } <span class="hljs-keyword">catch</span> (x) {
        <span class="hljs-keyword">this</span>._debug(x);
      }
    }
  };
  _self.xhrStatus = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr</span>) </span>{
    <span class="hljs-keyword">if</span> (xhr) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> xhr.status;
      } <span class="hljs-keyword">catch</span> (x) {
        <span class="hljs-keyword">this</span>._debug(x);
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
  };
  <span class="hljs-keyword">return</span> _self;
};
org.cometd.LongPollingTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org.cometd.RequestTransport();
  <span class="hljs-keyword">var</span> _self = org.cometd.Transport.derive(_super);
  <span class="hljs-keyword">var</span> _supportsCrossDomain = <span class="hljs-literal">true</span>;
  _self.accept = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">return</span> _supportsCrossDomain || !crossDomain;
  };
  _self.xhrSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">packet</span>) </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
  };
  _self.transportSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, request</span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'sending request'</span>, request.id, <span class="hljs-string">'envelope'</span>, envelope);
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">var</span> sameStack = <span class="hljs-literal">true</span>;
      request.xhr = <span class="hljs-keyword">this</span>.xhrSend({
        <span class="hljs-attr">transport</span>: <span class="hljs-keyword">this</span>,
        <span class="hljs-attr">url</span>: envelope.url,
        <span class="hljs-attr">sync</span>: envelope.sync,
        <span class="hljs-attr">headers</span>: <span class="hljs-keyword">this</span>.getConfiguration().requestHeaders,
        <span class="hljs-attr">body</span>: org.cometd.JSON.toJSON(envelope.messages),
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
          self._debug(<span class="hljs-string">'Transport'</span>, self.getType(), <span class="hljs-string">'received response'</span>, response);
          <span class="hljs-keyword">var</span> success = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> received = self.convertToMessages(response);
            <span class="hljs-keyword">if</span> (received.length === <span class="hljs-number">0</span>) {
              _supportsCrossDomain = <span class="hljs-literal">false</span>;
              self.transportFailure(envelope, request, {
                <span class="hljs-attr">httpCode</span>: <span class="hljs-number">204</span>
              });
            } <span class="hljs-keyword">else</span> {
              success = <span class="hljs-literal">true</span>;
              self.transportSuccess(envelope, request, received);
            }
          } <span class="hljs-keyword">catch</span> (x) {
            self._debug(x);
            <span class="hljs-keyword">if</span> (!success) {
              _supportsCrossDomain = <span class="hljs-literal">false</span>;
              <span class="hljs-keyword">var</span> failure = {
                <span class="hljs-attr">exception</span>: x
              };
              failure.httpCode = self.xhrStatus(request.xhr);
              self.transportFailure(envelope, request, failure);
            }
          }
        },
        <span class="hljs-attr">onError</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reason, exception</span>) </span>{
          _supportsCrossDomain = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">var</span> failure = {
            <span class="hljs-attr">reason</span>: reason,
            <span class="hljs-attr">exception</span>: exception
          };
          failure.httpCode = self.xhrStatus(request.xhr);
          <span class="hljs-keyword">if</span> (sameStack) {
            self.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              self.transportFailure(envelope, request, failure);
            }, <span class="hljs-number">0</span>);
          } <span class="hljs-keyword">else</span> {
            self.transportFailure(envelope, request, failure);
          }
        }
      });
      sameStack = <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">catch</span> (x) {
      _supportsCrossDomain = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        self.transportFailure(envelope, request, {
          <span class="hljs-attr">exception</span>: x
        });
      }, <span class="hljs-number">0</span>);
    }
  };
  _self.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _super.reset();
    _supportsCrossDomain = <span class="hljs-literal">true</span>;
  };
  <span class="hljs-keyword">return</span> _self;
};
org.cometd.CallbackPollingTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org.cometd.RequestTransport();
  <span class="hljs-keyword">var</span> _self = org.cometd.Transport.derive(_super);
  <span class="hljs-keyword">var</span> _maxLength = <span class="hljs-number">2000</span>;
  _self.accept = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  };
  _self.jsonpSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">packet</span>) </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
  };
  _self.transportSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, request</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> start = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> length = envelope.messages.length;
    <span class="hljs-keyword">var</span> lengths = [];
    <span class="hljs-keyword">while</span> (length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> json = org.cometd.JSON.toJSON(envelope.messages.slice(start, start + length));
      <span class="hljs-keyword">var</span> urlLength = envelope.url.length + <span class="hljs-built_in">encodeURI</span>(json).length;
      <span class="hljs-keyword">if</span> (urlLength &gt; _maxLength) {
        <span class="hljs-keyword">if</span> (length === <span class="hljs-number">1</span>) {
          <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            self.transportFailure(envelope, request, {
              <span class="hljs-attr">reason</span>: <span class="hljs-string">'Bayeux message too big, max is '</span> + _maxLength
            });
          }, <span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span>;
        }
        --length;
        <span class="hljs-keyword">continue</span>;
      }
      lengths.push(length);
      start += length;
      length = envelope.messages.length - start;
    }
    <span class="hljs-keyword">var</span> envelopeToSend = envelope;
    <span class="hljs-keyword">if</span> (lengths.length &gt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">var</span> begin = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">var</span> end = lengths[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'split'</span>, envelope.messages.length, <span class="hljs-string">'messages into'</span>, lengths.join(<span class="hljs-string">' + '</span>));
      envelopeToSend = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, envelope);
      envelopeToSend.messages = envelope.messages.slice(begin, end);
      envelopeToSend.onSuccess = envelope.onSuccess;
      envelopeToSend.onFailure = envelope.onFailure;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; lengths.length; ++i) {
        <span class="hljs-keyword">var</span> nextEnvelope = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, envelope);
        begin = end;
        end += lengths[i];
        nextEnvelope.messages = envelope.messages.slice(begin, end);
        nextEnvelope.onSuccess = envelope.onSuccess;
        nextEnvelope.onFailure = envelope.onFailure;
        <span class="hljs-keyword">this</span>.send(nextEnvelope, request.metaConnect);
      }
    }
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'sending request'</span>, request.id, <span class="hljs-string">'envelope'</span>, envelopeToSend);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">var</span> sameStack = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">this</span>.jsonpSend({
        <span class="hljs-attr">transport</span>: <span class="hljs-keyword">this</span>,
        <span class="hljs-attr">url</span>: envelopeToSend.url,
        <span class="hljs-attr">sync</span>: envelopeToSend.sync,
        <span class="hljs-attr">headers</span>: <span class="hljs-keyword">this</span>.getConfiguration().requestHeaders,
        <span class="hljs-attr">body</span>: org.cometd.JSON.toJSON(envelopeToSend.messages),
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">responses</span>) </span>{
          <span class="hljs-keyword">var</span> success = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> received = self.convertToMessages(responses);
            <span class="hljs-keyword">if</span> (received.length === <span class="hljs-number">0</span>) {
              self.transportFailure(envelopeToSend, request, {
                <span class="hljs-attr">httpCode</span>: <span class="hljs-number">204</span>
              });
            } <span class="hljs-keyword">else</span> {
              success = <span class="hljs-literal">true</span>;
              self.transportSuccess(envelopeToSend, request, received);
            }
          } <span class="hljs-keyword">catch</span> (x) {
            self._debug(x);
            <span class="hljs-keyword">if</span> (!success) {
              self.transportFailure(envelopeToSend, request, {
                <span class="hljs-attr">exception</span>: x
              });
            }
          }
        },
        <span class="hljs-attr">onError</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reason, exception</span>) </span>{
          <span class="hljs-keyword">var</span> failure = {
            <span class="hljs-attr">reason</span>: reason,
            <span class="hljs-attr">exception</span>: exception
          };
          <span class="hljs-keyword">if</span> (sameStack) {
            self.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              self.transportFailure(envelopeToSend, request, failure);
            }, <span class="hljs-number">0</span>);
          } <span class="hljs-keyword">else</span> {
            self.transportFailure(envelopeToSend, request, failure);
          }
        }
      });
      sameStack = <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">catch</span> (xx) {
      <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        self.transportFailure(envelopeToSend, request, {
          <span class="hljs-attr">exception</span>: xx
        });
      }, <span class="hljs-number">0</span>);
    }
  };
  <span class="hljs-keyword">return</span> _self;
};
org.cometd.WebSocketTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org.cometd.Transport();
  <span class="hljs-keyword">var</span> _self = org.cometd.Transport.derive(_super);
  <span class="hljs-keyword">var</span> _cometd;
  <span class="hljs-keyword">var</span> _webSocketSupported = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> _webSocketConnected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _stickyReconnect = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> _envelopes = {};
  <span class="hljs-keyword">var</span> _timeouts = {};
  <span class="hljs-keyword">var</span> _connecting = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _webSocket = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> _connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _successCallback = <span class="hljs-literal">null</span>;
  _self.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _super.reset();
    _webSocketSupported = <span class="hljs-literal">true</span>;
    _webSocketConnected = <span class="hljs-literal">false</span>;
    _stickyReconnect = <span class="hljs-literal">true</span>;
    _envelopes = {};
    _timeouts = {};
    _connecting = <span class="hljs-literal">false</span>;
    _webSocket = <span class="hljs-literal">null</span>;
    _connected = <span class="hljs-literal">false</span>;
    _successCallback = <span class="hljs-literal">null</span>;
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_websocketConnect</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_connecting) {
      <span class="hljs-keyword">return</span>;
    }
    _connecting = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> url = _cometd.getURL().replace(<span class="hljs-regexp">/^http/</span>, <span class="hljs-string">'ws'</span>);
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'connecting to URL'</span>, url);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">var</span> protocol = _cometd.getConfiguration().protocol;
      <span class="hljs-keyword">var</span> webSocket = protocol ? <span class="hljs-keyword">new</span> org.cometd.WebSocket(url, protocol) : <span class="hljs-keyword">new</span> org.cometd.WebSocket(url);
    } <span class="hljs-keyword">catch</span> (x) {
      _webSocketSupported = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Exception while creating WebSocket object'</span>, x);
      <span class="hljs-keyword">throw</span> x;
    }
    _stickyReconnect = _cometd.getConfiguration().stickyReconnect !== <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> connectTimer = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> connectTimeout = _cometd.getConfiguration().connectTimeout;
    <span class="hljs-keyword">if</span> (connectTimeout &gt; <span class="hljs-number">0</span>) {
      connectTimer = <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        connectTimer = <span class="hljs-literal">null</span>;
        self._debug(<span class="hljs-string">'Transport'</span>, self.getType(), <span class="hljs-string">'timed out while connecting to URL'</span>, url, <span class="hljs-string">':'</span>, connectTimeout, <span class="hljs-string">'ms'</span>);
        <span class="hljs-keyword">var</span> event = {
          <span class="hljs-attr">code</span>: <span class="hljs-number">1000</span>,
          <span class="hljs-attr">reason</span>: <span class="hljs-string">'Connect Timeout'</span>
        };
        self.webSocketClose(webSocket, event.code, event.reason);
        self.onClose(webSocket, event);
      }, connectTimeout);
    }
    <span class="hljs-keyword">var</span> onopen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      self._debug(<span class="hljs-string">'WebSocket opened'</span>, webSocket);
      _connecting = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (connectTimer) {
        self.clearTimeout(connectTimer);
        connectTimer = <span class="hljs-literal">null</span>;
      }
      <span class="hljs-keyword">if</span> (_webSocket) {
        _cometd._warn(<span class="hljs-string">'Closing Extra WebSocket Connections'</span>, webSocket, _webSocket);
        self.webSocketClose(webSocket, <span class="hljs-number">1000</span>, <span class="hljs-string">'Extra Connection'</span>);
      } <span class="hljs-keyword">else</span> {
        self.onOpen(webSocket);
      }
    };
    <span class="hljs-keyword">var</span> onclose = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
      event = event || {
        <span class="hljs-attr">code</span>: <span class="hljs-number">1000</span>
      };
      self._debug(<span class="hljs-string">'WebSocket closing'</span>, webSocket, event);
      _connecting = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (connectTimer) {
        self.clearTimeout(connectTimer);
        connectTimer = <span class="hljs-literal">null</span>;
      }
      <span class="hljs-keyword">if</span> (_webSocket !== <span class="hljs-literal">null</span> &amp;&amp; webSocket !== _webSocket) {
        self._debug(<span class="hljs-string">'Closed Extra WebSocket Connection'</span>, webSocket);
      } <span class="hljs-keyword">else</span> {
        self.onClose(webSocket, event);
      }
    };
    <span class="hljs-keyword">var</span> onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      self._debug(<span class="hljs-string">'WebSocket message'</span>, message, webSocket);
      <span class="hljs-keyword">if</span> (webSocket !== _webSocket) {
        _cometd._warn(<span class="hljs-string">'Extra WebSocket Connections'</span>, webSocket, _webSocket);
      }
      self.onMessage(webSocket, message);
    };
    webSocket.onopen = onopen;
    webSocket.onclose = onclose;
    webSocket.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      onclose({
        <span class="hljs-attr">code</span>: <span class="hljs-number">1002</span>,
        <span class="hljs-attr">reason</span>: <span class="hljs-string">'Error'</span>
      });
    };
    webSocket.onmessage = onmessage;
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'configured callbacks on'</span>, webSocket);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_webSocketSend</span>(<span class="hljs-params">webSocket, envelope, metaConnect</span>) </span>{
    <span class="hljs-keyword">var</span> json = org.cometd.JSON.toJSON(envelope.messages);
    webSocket.send(json);
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'sent'</span>, envelope, <span class="hljs-string">'metaConnect ='</span>, metaConnect);
    <span class="hljs-keyword">var</span> maxDelay = <span class="hljs-keyword">this</span>.getConfiguration().maxNetworkDelay;
    <span class="hljs-keyword">var</span> delay = maxDelay;
    <span class="hljs-keyword">if</span> (metaConnect) {
      delay += <span class="hljs-keyword">this</span>.getAdvice().timeout;
      _connected = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> messageIds = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; envelope.messages.length; ++i) {
      (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> message = envelope.messages[i];
        <span class="hljs-keyword">if</span> (message.id) {
          messageIds.push(message.id);
          _timeouts[message.id] = <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            self._debug(<span class="hljs-string">'Transport'</span>, self.getType(), <span class="hljs-string">'timing out message'</span>, message.id, <span class="hljs-string">'after'</span>, delay, <span class="hljs-string">'on'</span>, webSocket);
            <span class="hljs-keyword">var</span> event = {
              <span class="hljs-attr">code</span>: <span class="hljs-number">1000</span>,
              <span class="hljs-attr">reason</span>: <span class="hljs-string">'Message Timeout'</span>
            };
            self.webSocketClose(webSocket, event.code, event.reason);
            self.onClose(webSocket, event);
          }, delay);
        }
      })();
    }
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'waiting at most'</span>, delay, <span class="hljs-string">'ms for messages'</span>, messageIds, <span class="hljs-string">'maxNetworkDelay'</span>, maxDelay, <span class="hljs-string">', timeouts:'</span>, _timeouts);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_send</span>(<span class="hljs-params">webSocket, envelope, metaConnect</span>) </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (webSocket === <span class="hljs-literal">null</span>) {
        _websocketConnect.call(<span class="hljs-keyword">this</span>);
      } <span class="hljs-keyword">else</span> {
        _webSocketSend.call(<span class="hljs-keyword">this</span>, webSocket, envelope, metaConnect);
      }
    } <span class="hljs-keyword">catch</span> (x) {
      <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        envelope.onFailure(webSocket, envelope.messages, {
          <span class="hljs-attr">exception</span>: x
        });
      }, <span class="hljs-number">0</span>);
    }
  }
  _self.onOpen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">webSocket</span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'opened'</span>, webSocket);
    _webSocket = webSocket;
    _webSocketConnected = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Sending pending messages'</span>, _envelopes);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> _envelopes) {
      <span class="hljs-keyword">var</span> element = _envelopes[key];
      <span class="hljs-keyword">var</span> envelope = element[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> metaConnect = element[<span class="hljs-number">1</span>];
      _successCallback = envelope.onSuccess;
      _webSocketSend.call(<span class="hljs-keyword">this</span>, webSocket, envelope, metaConnect);
    }
  };
  _self.onMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">webSocket, wsMessage</span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'received websocket message'</span>, wsMessage, webSocket);
    <span class="hljs-keyword">var</span> close = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> messages = <span class="hljs-keyword">this</span>.convertToMessages(wsMessage.data);
    <span class="hljs-keyword">var</span> messageIds = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; messages.length; ++i) {
      <span class="hljs-keyword">var</span> message = messages[i];
      <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^\/meta\//</span>.test(message.channel) || message.successful !== <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">if</span> (message.id) {
          messageIds.push(message.id);
          <span class="hljs-keyword">var</span> timeout = _timeouts[message.id];
          <span class="hljs-keyword">if</span> (timeout) {
            <span class="hljs-keyword">this</span>.clearTimeout(timeout);
            <span class="hljs-keyword">delete</span> _timeouts[message.id];
            <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'removed timeout for message'</span>, message.id, <span class="hljs-string">', timeouts'</span>, _timeouts);
          }
        }
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'/meta/connect'</span> === message.channel) {
        _connected = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'/meta/disconnect'</span> === message.channel &amp;&amp; !_connected) {
        close = <span class="hljs-literal">true</span>;
      }
    }
    <span class="hljs-keyword">var</span> removed = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; messageIds.length; ++j) {
      <span class="hljs-keyword">var</span> id = messageIds[j];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> _envelopes) {
        <span class="hljs-keyword">var</span> ids = key.split(<span class="hljs-string">','</span>);
        <span class="hljs-keyword">var</span> index = org.cometd.Utils.inArray(id, ids);
        <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
          removed = <span class="hljs-literal">true</span>;
          ids.splice(index, <span class="hljs-number">1</span>);
          <span class="hljs-keyword">var</span> envelope = _envelopes[key][<span class="hljs-number">0</span>];
          <span class="hljs-keyword">var</span> metaConnect = _envelopes[key][<span class="hljs-number">1</span>];
          <span class="hljs-keyword">delete</span> _envelopes[key];
          <span class="hljs-keyword">if</span> (ids.length &gt; <span class="hljs-number">0</span>) {
            _envelopes[ids.join(<span class="hljs-string">','</span>)] = [envelope, metaConnect];
          }
          <span class="hljs-keyword">break</span>;
        }
      }
    }
    <span class="hljs-keyword">if</span> (removed) {
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'removed envelope, envelopes'</span>, _envelopes);
    }
    _successCallback.call(<span class="hljs-keyword">this</span>, messages);
    <span class="hljs-keyword">if</span> (close) {
      <span class="hljs-keyword">this</span>.webSocketClose(webSocket, <span class="hljs-number">1000</span>, <span class="hljs-string">'Disconnect'</span>);
    }
  };
  _self.onClose = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">webSocket, event</span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'closed'</span>, webSocket, event);
    _webSocketSupported = _stickyReconnect &amp;&amp; _webSocketConnected;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> id <span class="hljs-keyword">in</span> _timeouts) {
      <span class="hljs-keyword">this</span>.clearTimeout(_timeouts[id]);
    }
    _timeouts = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> _envelopes) {
      <span class="hljs-keyword">var</span> envelope = _envelopes[key][<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> metaConnect = _envelopes[key][<span class="hljs-number">1</span>];
      <span class="hljs-keyword">if</span> (metaConnect) {
        _connected = <span class="hljs-literal">false</span>;
      }
      envelope.onFailure(webSocket, envelope.messages, {
        <span class="hljs-attr">websocketCode</span>: event.code,
        <span class="hljs-attr">reason</span>: event.reason
      });
    }
    _envelopes = {};
    _webSocket = <span class="hljs-literal">null</span>;
  };
  _self.registered = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, cometd</span>) </span>{
    _super.registered(type, cometd);
    _cometd = cometd;
  };
  _self.accept = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">return</span> _webSocketSupported &amp;&amp; !!org.cometd.WebSocket &amp;&amp; _cometd.websocketEnabled !== <span class="hljs-literal">false</span>;
  };
  _self.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, metaConnect</span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'sending'</span>, envelope, <span class="hljs-string">'metaConnect ='</span>, metaConnect);
    <span class="hljs-keyword">var</span> messageIds = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; envelope.messages.length; ++i) {
      <span class="hljs-keyword">var</span> message = envelope.messages[i];
      <span class="hljs-keyword">if</span> (message.id) {
        messageIds.push(message.id);
      }
    }
    _envelopes[messageIds.join(<span class="hljs-string">','</span>)] = [envelope, metaConnect];
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'stored envelope, envelopes'</span>, _envelopes);
    _send.call(<span class="hljs-keyword">this</span>, _webSocket, envelope, metaConnect);
  };
  _self.webSocketClose = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">webSocket, code, reason</span>) </span>{
    <span class="hljs-keyword">try</span> {
      webSocket.close(code, reason);
    } <span class="hljs-keyword">catch</span> (x) {
      <span class="hljs-keyword">this</span>._debug(x);
    }
  };
  _self.abort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _super.abort();
    <span class="hljs-keyword">if</span> (_webSocket) {
      <span class="hljs-keyword">var</span> event = {
        <span class="hljs-attr">code</span>: <span class="hljs-number">1001</span>,
        <span class="hljs-attr">reason</span>: <span class="hljs-string">'Abort'</span>
      };
      <span class="hljs-keyword">this</span>.webSocketClose(_webSocket, event.code, event.reason);
      <span class="hljs-keyword">this</span>.onClose(_webSocket, event);
    }
    <span class="hljs-keyword">this</span>.reset();
  };
  <span class="hljs-keyword">return</span> _self;
};
org.cometd.Cometd = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-keyword">var</span> _cometd = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> _name = name || <span class="hljs-string">'default'</span>;
  <span class="hljs-keyword">var</span> _crossDomain = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _transports = <span class="hljs-keyword">new</span> org.cometd.TransportRegistry();
  <span class="hljs-keyword">var</span> _transport;
  <span class="hljs-keyword">var</span> _status = <span class="hljs-string">'disconnected'</span>;
  <span class="hljs-keyword">var</span> _messageId = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> _clientId = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> _batch = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> _messageQueue = [];
  <span class="hljs-keyword">var</span> _internalBatch = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _listeners = {};
  <span class="hljs-keyword">var</span> _backoff = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> _scheduledSend = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> _extensions = [];
  <span class="hljs-keyword">var</span> _advice = {};
  <span class="hljs-keyword">var</span> _handshakeProps;
  <span class="hljs-keyword">var</span> _handshakeCallback;
  <span class="hljs-keyword">var</span> _callbacks = {};
  <span class="hljs-keyword">var</span> _reestablish = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _config = {
    <span class="hljs-attr">protocol</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">stickyReconnect</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">connectTimeout</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">maxConnections</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">backoffIncrement</span>: <span class="hljs-number">1000</span>,
    <span class="hljs-attr">maxBackoff</span>: <span class="hljs-number">60000</span>,
    <span class="hljs-attr">logLevel</span>: <span class="hljs-string">'info'</span>,
    <span class="hljs-attr">reverseIncomingExtensions</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">maxNetworkDelay</span>: <span class="hljs-number">10000</span>,
    <span class="hljs-attr">requestHeaders</span>: {},
    <span class="hljs-attr">appendMessageTypeToURL</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">autoBatch</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">advice</span>: {
      <span class="hljs-attr">timeout</span>: <span class="hljs-number">60000</span>,
      <span class="hljs-attr">interval</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">reconnect</span>: <span class="hljs-string">'retry'</span>
    }
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_fieldValue</span>(<span class="hljs-params">object, name</span>) </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> object[name];
    } <span class="hljs-keyword">catch</span> (x) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    }
  }
  <span class="hljs-keyword">this</span>._mixin = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">deep, target, objects</span>) </span>{
    <span class="hljs-keyword">var</span> result = target || {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">2</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; ++i) {
      <span class="hljs-keyword">var</span> object = <span class="hljs-built_in">arguments</span>[i];
      <span class="hljs-keyword">if</span> (object === <span class="hljs-literal">undefined</span> || object === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> propName <span class="hljs-keyword">in</span> object) {
        <span class="hljs-keyword">var</span> prop = _fieldValue(object, propName);
        <span class="hljs-keyword">var</span> targ = _fieldValue(result, propName);
        <span class="hljs-keyword">if</span> (prop === target) {
          <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">if</span> (prop === <span class="hljs-literal">undefined</span>) {
          <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">if</span> (deep &amp;&amp; <span class="hljs-keyword">typeof</span> prop === <span class="hljs-string">'object'</span> &amp;&amp; prop !== <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">if</span> (prop <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {
            result[propName] = <span class="hljs-keyword">this</span>._mixin(deep, targ <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span> ? targ : [], prop);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">typeof</span> targ === <span class="hljs-string">'object'</span> &amp;&amp; !(targ <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) ? targ : {};
            result[propName] = <span class="hljs-keyword">this</span>._mixin(deep, source, prop);
          }
        } <span class="hljs-keyword">else</span> {
          result[propName] = prop;
        }
      }
    }
    <span class="hljs-keyword">return</span> result;
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_isString</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">return</span> org.cometd.Utils.isString(value);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_isFunction</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> || value === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'function'</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_log</span>(<span class="hljs-params">level, args</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.console) {
      <span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">window</span>.console[level];
      <span class="hljs-keyword">if</span> (_isFunction(logger)) {
        logger.apply(<span class="hljs-built_in">window</span>.console, args);
      }
    }
  }
  <span class="hljs-keyword">this</span>._warn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _log(<span class="hljs-string">'warn'</span>, <span class="hljs-built_in">arguments</span>);
  };
  <span class="hljs-keyword">this</span>._info = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_config.logLevel !== <span class="hljs-string">'warn'</span>) {
      _log(<span class="hljs-string">'info'</span>, <span class="hljs-built_in">arguments</span>);
    }
  };
  <span class="hljs-keyword">this</span>._debug = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_config.logLevel === <span class="hljs-string">'debug'</span>) {
      _log(<span class="hljs-string">'debug'</span>, <span class="hljs-built_in">arguments</span>);
    }
  };
  <span class="hljs-keyword">this</span>._isCrossDomain = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">hostAndPort</span>) </span>{
    <span class="hljs-keyword">return</span> hostAndPort &amp;&amp; hostAndPort !== <span class="hljs-built_in">window</span>.location.host;
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_configure</span>(<span class="hljs-params">configuration</span>) </span>{
    _cometd._debug(<span class="hljs-string">'Configuring cometd object with'</span>, configuration);
    <span class="hljs-keyword">if</span> (_isString(configuration)) {
      configuration = {
        <span class="hljs-attr">url</span>: configuration
      };
    }
    <span class="hljs-keyword">if</span> (!configuration) {
      configuration = {};
    }
    _config = _cometd._mixin(<span class="hljs-literal">false</span>, _config, configuration);
    <span class="hljs-keyword">var</span> url = _cometd.getURL();
    <span class="hljs-keyword">if</span> (!url) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Missing required configuration parameter \'url\' specifying the Bayeux server URL'</span>;
    }
    <span class="hljs-keyword">var</span> urlParts = <span class="hljs-regexp">/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/</span>.exec(url);
    <span class="hljs-keyword">var</span> hostAndPort = urlParts[<span class="hljs-number">2</span>];
    <span class="hljs-keyword">var</span> uri = urlParts[<span class="hljs-number">8</span>];
    <span class="hljs-keyword">var</span> afterURI = urlParts[<span class="hljs-number">9</span>];
    _crossDomain = _cometd._isCrossDomain(hostAndPort);
    <span class="hljs-keyword">if</span> (_config.appendMessageTypeToURL) {
      <span class="hljs-keyword">if</span> (afterURI !== <span class="hljs-literal">undefined</span> &amp;&amp; afterURI.length &gt; <span class="hljs-number">0</span>) {
        _cometd._info(<span class="hljs-string">'Appending message type to URI '</span> + uri + afterURI + <span class="hljs-string">' is not supported, disabling \'appendMessageTypeToURL\' configuration'</span>);
        _config.appendMessageTypeToURL = <span class="hljs-literal">false</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> uriSegments = uri.split(<span class="hljs-string">'/'</span>);
        <span class="hljs-keyword">var</span> lastSegmentIndex = uriSegments.length - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (uri.match(<span class="hljs-regexp">/\/$/</span>)) {
          lastSegmentIndex -= <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">if</span> (uriSegments[lastSegmentIndex].indexOf(<span class="hljs-string">'.'</span>) &gt;= <span class="hljs-number">0</span>) {
          _cometd._info(<span class="hljs-string">'Appending message type to URI '</span> + uri + <span class="hljs-string">' is not supported, disabling \'appendMessageTypeToURL\' configuration'</span>);
          _config.appendMessageTypeToURL = <span class="hljs-literal">false</span>;
        }
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_removeListener</span>(<span class="hljs-params">subscription</span>) </span>{
    <span class="hljs-keyword">if</span> (subscription) {
      <span class="hljs-keyword">var</span> subscriptions = _listeners[subscription.channel];
      <span class="hljs-keyword">if</span> (subscriptions &amp;&amp; subscriptions[subscription.id]) {
        <span class="hljs-keyword">delete</span> subscriptions[subscription.id];
        _cometd._debug(<span class="hljs-string">'Removed'</span>, subscription.listener ? <span class="hljs-string">'listener'</span> : <span class="hljs-string">'subscription'</span>, subscription);
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_removeSubscription</span>(<span class="hljs-params">subscription</span>) </span>{
    <span class="hljs-keyword">if</span> (subscription &amp;&amp; !subscription.listener) {
      _removeListener(subscription);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_clearSubscriptions</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> channel <span class="hljs-keyword">in</span> _listeners) {
      <span class="hljs-keyword">var</span> subscriptions = _listeners[channel];
      <span class="hljs-keyword">if</span> (subscriptions) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; subscriptions.length; ++i) {
          _removeSubscription(subscriptions[i]);
        }
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_setStatus</span>(<span class="hljs-params">newStatus</span>) </span>{
    <span class="hljs-keyword">if</span> (_status !== newStatus) {
      _cometd._debug(<span class="hljs-string">'Status'</span>, _status, <span class="hljs-string">'-&gt;'</span>, newStatus);
      _status = newStatus;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_isDisconnected</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _status === <span class="hljs-string">'disconnecting'</span> || _status === <span class="hljs-string">'disconnected'</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_nextMessageId</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> ++_messageId;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_applyExtension</span>(<span class="hljs-params">scope, callback, name, message, outgoing</span>) </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> callback.call(scope, message);
    } <span class="hljs-keyword">catch</span> (x) {
      _cometd._debug(<span class="hljs-string">'Exception during execution of extension'</span>, name, x);
      <span class="hljs-keyword">var</span> exceptionCallback = _cometd.onExtensionException;
      <span class="hljs-keyword">if</span> (_isFunction(exceptionCallback)) {
        _cometd._debug(<span class="hljs-string">'Invoking extension exception callback'</span>, name, x);
        <span class="hljs-keyword">try</span> {
          exceptionCallback.call(_cometd, x, name, outgoing, message);
        } <span class="hljs-keyword">catch</span> (xx) {
          _cometd._info(<span class="hljs-string">'Exception during execution of exception callback in extension'</span>, name, xx);
        }
      }
      <span class="hljs-keyword">return</span> message;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_applyIncomingExtensions</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _extensions.length; ++i) {
      <span class="hljs-keyword">if</span> (message === <span class="hljs-literal">undefined</span> || message === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">break</span>;
      }
      <span class="hljs-keyword">var</span> index = _config.reverseIncomingExtensions ? _extensions.length - <span class="hljs-number">1</span> - i : i;
      <span class="hljs-keyword">var</span> extension = _extensions[index];
      <span class="hljs-keyword">var</span> callback = extension.extension.incoming;
      <span class="hljs-keyword">if</span> (_isFunction(callback)) {
        <span class="hljs-keyword">var</span> result = _applyExtension(extension.extension, callback, extension.name, message, <span class="hljs-literal">false</span>);
        message = result === <span class="hljs-literal">undefined</span> ? message : result;
      }
    }
    <span class="hljs-keyword">return</span> message;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_applyOutgoingExtensions</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _extensions.length; ++i) {
      <span class="hljs-keyword">if</span> (message === <span class="hljs-literal">undefined</span> || message === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">break</span>;
      }
      <span class="hljs-keyword">var</span> extension = _extensions[i];
      <span class="hljs-keyword">var</span> callback = extension.extension.outgoing;
      <span class="hljs-keyword">if</span> (_isFunction(callback)) {
        <span class="hljs-keyword">var</span> result = _applyExtension(extension.extension, callback, extension.name, message, <span class="hljs-literal">true</span>);
        message = result === <span class="hljs-literal">undefined</span> ? message : result;
      }
    }
    <span class="hljs-keyword">return</span> message;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_notify</span>(<span class="hljs-params">channel, message</span>) </span>{
    <span class="hljs-keyword">var</span> subscriptions = _listeners[channel];
    <span class="hljs-keyword">if</span> (subscriptions &amp;&amp; subscriptions.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; subscriptions.length; ++i) {
        <span class="hljs-keyword">var</span> subscription = subscriptions[i];
        <span class="hljs-keyword">if</span> (subscription) {
          <span class="hljs-keyword">try</span> {
            subscription.callback.call(subscription.scope, message);
          } <span class="hljs-keyword">catch</span> (x) {
            _cometd._debug(<span class="hljs-string">'Exception during notification'</span>, subscription, message, x);
            <span class="hljs-keyword">var</span> listenerCallback = _cometd.onListenerException;
            <span class="hljs-keyword">if</span> (_isFunction(listenerCallback)) {
              _cometd._debug(<span class="hljs-string">'Invoking listener exception callback'</span>, subscription, x);
              <span class="hljs-keyword">try</span> {
                listenerCallback.call(_cometd, x, subscription, subscription.listener, message);
              } <span class="hljs-keyword">catch</span> (xx) {
                _cometd._info(<span class="hljs-string">'Exception during execution of listener callback'</span>, subscription, xx);
              }
            }
          }
        }
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_notifyListeners</span>(<span class="hljs-params">channel, message</span>) </span>{
    _notify(channel, message);
    <span class="hljs-keyword">var</span> channelParts = channel.split(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">var</span> last = channelParts.length - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = last; i &gt; <span class="hljs-number">0</span>; --i) {
      <span class="hljs-keyword">var</span> channelPart = channelParts.slice(<span class="hljs-number">0</span>, i).join(<span class="hljs-string">'/'</span>) + <span class="hljs-string">'/*'</span>;
      <span class="hljs-keyword">if</span> (i === last) {
        _notify(channelPart, message);
      }
      channelPart += <span class="hljs-string">'*'</span>;
      _notify(channelPart, message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_cancelDelayedSend</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_scheduledSend !== <span class="hljs-literal">null</span>) {
      org.cometd.Utils.clearTimeout(_scheduledSend);
    }
    _scheduledSend = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_delayedSend</span>(<span class="hljs-params">operation</span>) </span>{
    _cancelDelayedSend();
    <span class="hljs-keyword">var</span> delay = _advice.interval + _backoff;
    _cometd._debug(<span class="hljs-string">'Function scheduled in'</span>, delay, <span class="hljs-string">'ms, interval ='</span>, _advice.interval, <span class="hljs-string">'backoff ='</span>, _backoff, operation);
    _scheduledSend = org.cometd.Utils.setTimeout(_cometd, operation, delay);
  }
  <span class="hljs-keyword">var</span> _handleMessages;
  <span class="hljs-keyword">var</span> _handleFailure;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_send</span>(<span class="hljs-params">sync, messages, longpoll, extraPath</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; messages.length; ++i) {
      <span class="hljs-keyword">var</span> message = messages[i];
      <span class="hljs-keyword">var</span> messageId = <span class="hljs-string">''</span> + _nextMessageId();
      message.id = messageId;
      <span class="hljs-keyword">if</span> (_clientId) {
        message.clientId = _clientId;
      }
      <span class="hljs-keyword">var</span> callback = <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">if</span> (_isFunction(message._callback)) {
        callback = message._callback;
        <span class="hljs-keyword">delete</span> message._callback;
      }
      message = _applyOutgoingExtensions(message);
      <span class="hljs-keyword">if</span> (message !== <span class="hljs-literal">undefined</span> &amp;&amp; message !== <span class="hljs-literal">null</span>) {
        message.id = messageId;
        messages[i] = message;
        <span class="hljs-keyword">if</span> (callback) {
          _callbacks[messageId] = callback;
        }
      } <span class="hljs-keyword">else</span> {
        messages.splice(i--, <span class="hljs-number">1</span>);
      }
    }
    <span class="hljs-keyword">if</span> (messages.length === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> url = _cometd.getURL();
    <span class="hljs-keyword">if</span> (_config.appendMessageTypeToURL) {
      <span class="hljs-keyword">if</span> (!url.match(<span class="hljs-regexp">/\/$/</span>)) {
        url = url + <span class="hljs-string">'/'</span>;
      }
      <span class="hljs-keyword">if</span> (extraPath) {
        url = url + extraPath;
      }
    }
    <span class="hljs-keyword">var</span> envelope = {
      <span class="hljs-attr">url</span>: url,
      <span class="hljs-attr">sync</span>: sync,
      <span class="hljs-attr">messages</span>: messages,
      <span class="hljs-attr">onSuccess</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rcvdMessages</span>) </span>{
        <span class="hljs-keyword">try</span> {
          _handleMessages.call(_cometd, rcvdMessages);
        } <span class="hljs-keyword">catch</span> (x) {
          _cometd._debug(<span class="hljs-string">'Exception during handling of messages'</span>, x);
        }
      },
      <span class="hljs-attr">onFailure</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">conduit, messages, failure</span>) </span>{
        <span class="hljs-keyword">try</span> {
          failure.connectionType = _cometd.getTransport().getType();
          _handleFailure.call(_cometd, conduit, messages, failure);
        } <span class="hljs-keyword">catch</span> (x) {
          _cometd._debug(<span class="hljs-string">'Exception during handling of failure'</span>, x);
        }
      }
    };
    _cometd._debug(<span class="hljs-string">'Send'</span>, envelope);
    _transport.send(envelope, longpoll);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_queueSend</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (_batch &gt; <span class="hljs-number">0</span> || _internalBatch === <span class="hljs-literal">true</span>) {
      _messageQueue.push(message);
    } <span class="hljs-keyword">else</span> {
      _send(<span class="hljs-literal">false</span>, [message], <span class="hljs-literal">false</span>);
    }
  }
  <span class="hljs-keyword">this</span>.send = _queueSend;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_resetBackoff</span>(<span class="hljs-params"></span>) </span>{
    _backoff = <span class="hljs-number">0</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_increaseBackoff</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_backoff &lt; _config.maxBackoff) {
      _backoff += _config.backoffIncrement;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_startBatch</span>(<span class="hljs-params"></span>) </span>{
    ++_batch;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_flushBatch</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> messages = _messageQueue;
    _messageQueue = [];
    <span class="hljs-keyword">if</span> (messages.length &gt; <span class="hljs-number">0</span>) {
      _send(<span class="hljs-literal">false</span>, messages, <span class="hljs-literal">false</span>);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_endBatch</span>(<span class="hljs-params"></span>) </span>{
    --_batch;
    <span class="hljs-keyword">if</span> (_batch &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Calls to startBatch() and endBatch() are not paired'</span>;
    }
    <span class="hljs-keyword">if</span> (_batch === <span class="hljs-number">0</span> &amp;&amp; !_isDisconnected() &amp;&amp; !_internalBatch) {
      _flushBatch();
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connect</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!_isDisconnected()) {
      <span class="hljs-keyword">var</span> message = {
        <span class="hljs-attr">channel</span>: <span class="hljs-string">'/meta/connect'</span>,
        <span class="hljs-attr">connectionType</span>: _transport.getType()
      };
      <span class="hljs-keyword">if</span> (!_connected) {
        message.advice = {
          <span class="hljs-attr">timeout</span>: <span class="hljs-number">0</span>
        };
      }
      _setStatus(<span class="hljs-string">'connecting'</span>);
      _cometd._debug(<span class="hljs-string">'Connect sent'</span>, message);
      _send(<span class="hljs-literal">false</span>, [message], <span class="hljs-literal">true</span>, <span class="hljs-string">'connect'</span>);
      _setStatus(<span class="hljs-string">'connected'</span>);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_delayedConnect</span>(<span class="hljs-params"></span>) </span>{
    _setStatus(<span class="hljs-string">'connecting'</span>);
    _delayedSend(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      _connect();
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_updateAdvice</span>(<span class="hljs-params">newAdvice</span>) </span>{
    <span class="hljs-keyword">if</span> (newAdvice) {
      _advice = _cometd._mixin(<span class="hljs-literal">false</span>, {}, _config.advice, newAdvice);
      _cometd._debug(<span class="hljs-string">'New advice'</span>, _advice);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_disconnect</span>(<span class="hljs-params">abort</span>) </span>{
    _cancelDelayedSend();
    <span class="hljs-keyword">if</span> (abort) {
      _transport.abort();
    }
    _clientId = <span class="hljs-literal">null</span>;
    _setStatus(<span class="hljs-string">'disconnected'</span>);
    _batch = <span class="hljs-number">0</span>;
    _resetBackoff();
    _transport = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (_messageQueue.length &gt; <span class="hljs-number">0</span>) {
      _handleFailure.call(_cometd, <span class="hljs-literal">undefined</span>, _messageQueue, {
        <span class="hljs-attr">reason</span>: <span class="hljs-string">'Disconnected'</span>
      });
      _messageQueue = [];
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_notifyTransportFailure</span>(<span class="hljs-params">oldTransport, newTransport, failure</span>) </span>{
    <span class="hljs-keyword">var</span> callback = _cometd.onTransportFailure;
    <span class="hljs-keyword">if</span> (_isFunction(callback)) {
      _cometd._debug(<span class="hljs-string">'Invoking transport failure callback'</span>, oldTransport, newTransport, failure);
      <span class="hljs-keyword">try</span> {
        callback.call(_cometd, oldTransport, newTransport, failure);
      } <span class="hljs-keyword">catch</span> (x) {
        _cometd._info(<span class="hljs-string">'Exception during execution of transport failure callback'</span>, x);
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_handshake</span>(<span class="hljs-params">handshakeProps, handshakeCallback</span>) </span>{
    <span class="hljs-keyword">if</span> (_isFunction(handshakeProps)) {
      handshakeCallback = handshakeProps;
      handshakeProps = <span class="hljs-literal">undefined</span>;
    }
    _clientId = <span class="hljs-literal">null</span>;
    _clearSubscriptions();
    <span class="hljs-keyword">if</span> (_isDisconnected()) {
      _transports.reset();
      _updateAdvice(_config.advice);
    } <span class="hljs-keyword">else</span> {
      _updateAdvice(_cometd._mixin(<span class="hljs-literal">false</span>, _advice, {
        <span class="hljs-attr">reconnect</span>: <span class="hljs-string">'retry'</span>
      }));
    }
    _batch = <span class="hljs-number">0</span>;
    _internalBatch = <span class="hljs-literal">true</span>;
    _handshakeProps = handshakeProps;
    _handshakeCallback = handshakeCallback;
    <span class="hljs-keyword">var</span> version = <span class="hljs-string">'1.0'</span>;
    <span class="hljs-keyword">var</span> url = _cometd.getURL();
    <span class="hljs-keyword">var</span> transportTypes = _transports.findTransportTypes(version, _crossDomain, url);
    <span class="hljs-keyword">var</span> bayeuxMessage = {
      <span class="hljs-attr">version</span>: version,
      <span class="hljs-attr">minimumVersion</span>: version,
      <span class="hljs-attr">channel</span>: <span class="hljs-string">'/meta/handshake'</span>,
      <span class="hljs-attr">supportedConnectionTypes</span>: transportTypes,
      <span class="hljs-attr">_callback</span>: handshakeCallback,
      <span class="hljs-attr">advice</span>: {
        <span class="hljs-attr">timeout</span>: _advice.timeout,
        <span class="hljs-attr">interval</span>: _advice.interval
      }
    };
    <span class="hljs-keyword">var</span> message = _cometd._mixin(<span class="hljs-literal">false</span>, {}, _handshakeProps, bayeuxMessage);
    <span class="hljs-keyword">if</span> (!_transport) {
      _transport = _transports.negotiateTransport(transportTypes, version, _crossDomain, url);
      <span class="hljs-keyword">if</span> (!_transport) {
        <span class="hljs-keyword">var</span> failure = <span class="hljs-string">'Could not find initial transport among: '</span> + _transports.getTransportTypes();
        _cometd._warn(failure);
        <span class="hljs-keyword">throw</span> failure;
      }
    }
    _cometd._debug(<span class="hljs-string">'Initial transport is'</span>, _transport.getType());
    _setStatus(<span class="hljs-string">'handshaking'</span>);
    _cometd._debug(<span class="hljs-string">'Handshake sent'</span>, message);
    _send(<span class="hljs-literal">false</span>, [message], <span class="hljs-literal">false</span>, <span class="hljs-string">'handshake'</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_delayedHandshake</span>(<span class="hljs-params"></span>) </span>{
    _setStatus(<span class="hljs-string">'handshaking'</span>);
    _internalBatch = <span class="hljs-literal">true</span>;
    _delayedSend(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      _handshake(_handshakeProps, _handshakeCallback);
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_handleCallback</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">var</span> callback = _callbacks[message.id];
    <span class="hljs-keyword">if</span> (_isFunction(callback)) {
      <span class="hljs-keyword">delete</span> _callbacks[message.id];
      callback.call(_cometd, message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failHandshake</span>(<span class="hljs-params">message</span>) </span>{
    _handleCallback(message);
    _notifyListeners(<span class="hljs-string">'/meta/handshake'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
    <span class="hljs-keyword">var</span> retry = !_isDisconnected() &amp;&amp; _advice.reconnect !== <span class="hljs-string">'none'</span>;
    <span class="hljs-keyword">if</span> (retry) {
      _increaseBackoff();
      _delayedHandshake();
    } <span class="hljs-keyword">else</span> {
      _disconnect(<span class="hljs-literal">false</span>);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_handshakeResponse</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (message.successful) {
      _clientId = message.clientId;
      <span class="hljs-keyword">var</span> url = _cometd.getURL();
      <span class="hljs-keyword">var</span> newTransport = _transports.negotiateTransport(message.supportedConnectionTypes, message.version, _crossDomain, url);
      <span class="hljs-keyword">if</span> (newTransport === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">var</span> failure = <span class="hljs-string">'Could not negotiate transport with server; client=['</span> +
          _transports.findTransportTypes(message.version, _crossDomain, url) +
          <span class="hljs-string">'], server=['</span> + message.supportedConnectionTypes + <span class="hljs-string">']'</span>;
        <span class="hljs-keyword">var</span> oldTransport = _cometd.getTransport();
        _notifyTransportFailure(oldTransport.getType(), <span class="hljs-literal">null</span>, {
          <span class="hljs-attr">reason</span>: failure,
          <span class="hljs-attr">connectionType</span>: oldTransport.getType(),
          <span class="hljs-attr">transport</span>: oldTransport
        });
        _cometd._warn(failure);
        _transport.reset();
        _failHandshake(message);
        <span class="hljs-keyword">return</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_transport !== newTransport) {
        _cometd._debug(<span class="hljs-string">'Transport'</span>, _transport.getType(), <span class="hljs-string">'-&gt;'</span>, newTransport.getType());
        _transport = newTransport;
      }
      _internalBatch = <span class="hljs-literal">false</span>;
      _flushBatch();
      message.reestablish = _reestablish;
      _reestablish = <span class="hljs-literal">true</span>;
      _handleCallback(message);
      _notifyListeners(<span class="hljs-string">'/meta/handshake'</span>, message);
      <span class="hljs-keyword">var</span> action = _isDisconnected() ? <span class="hljs-string">'none'</span> : _advice.reconnect;
      <span class="hljs-keyword">switch</span> (action) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'retry'</span>:
          _resetBackoff();
          _delayedConnect();
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'none'</span>:
          _disconnect(<span class="hljs-literal">false</span>);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Unrecognized advice action '</span> + action;
      }
    } <span class="hljs-keyword">else</span> {
      _failHandshake(message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_handshakeFailure</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">var</span> version = <span class="hljs-string">'1.0'</span>;
    <span class="hljs-keyword">var</span> url = _cometd.getURL();
    <span class="hljs-keyword">var</span> oldTransport = _cometd.getTransport();
    <span class="hljs-keyword">var</span> transportTypes = _transports.findTransportTypes(version, _crossDomain, url);
    <span class="hljs-keyword">var</span> newTransport = _transports.negotiateTransport(transportTypes, version, _crossDomain, url);
    <span class="hljs-keyword">if</span> (!newTransport) {
      _notifyTransportFailure(oldTransport.getType(), <span class="hljs-literal">null</span>, message.failure);
      _cometd._warn(<span class="hljs-string">'Could not negotiate transport; client=['</span> + transportTypes + <span class="hljs-string">']'</span>);
      _transport.reset();
      _failHandshake(message);
    } <span class="hljs-keyword">else</span> {
      _cometd._debug(<span class="hljs-string">'Transport'</span>, oldTransport.getType(), <span class="hljs-string">'-&gt;'</span>, newTransport.getType());
      _notifyTransportFailure(oldTransport.getType(), newTransport.getType(), message.failure);
      _failHandshake(message);
      _transport = newTransport;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failConnect</span>(<span class="hljs-params">message</span>) </span>{
    _notifyListeners(<span class="hljs-string">'/meta/connect'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
    <span class="hljs-keyword">var</span> action = _isDisconnected() ? <span class="hljs-string">'none'</span> : _advice.reconnect;
    <span class="hljs-keyword">switch</span> (action) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'retry'</span>:
        _delayedConnect();
        _increaseBackoff();
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'handshake'</span>:
        _transports.reset();
        _resetBackoff();
        _delayedHandshake();
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'none'</span>:
        _disconnect(<span class="hljs-literal">false</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Unrecognized advice action'</span> + action;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectResponse</span>(<span class="hljs-params">message</span>) </span>{
    _connected = message.successful;
    <span class="hljs-keyword">if</span> (_connected) {
      _notifyListeners(<span class="hljs-string">'/meta/connect'</span>, message);
      <span class="hljs-keyword">var</span> action = _isDisconnected() ? <span class="hljs-string">'none'</span> : _advice.reconnect;
      <span class="hljs-keyword">switch</span> (action) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'retry'</span>:
          _resetBackoff();
          _delayedConnect();
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'none'</span>:
          _disconnect(<span class="hljs-literal">false</span>);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Unrecognized advice action '</span> + action;
      }
    } <span class="hljs-keyword">else</span> {
      _failConnect(message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectFailure</span>(<span class="hljs-params">message</span>) </span>{
    _connected = <span class="hljs-literal">false</span>;
    _failConnect(message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failDisconnect</span>(<span class="hljs-params">message</span>) </span>{
    _disconnect(<span class="hljs-literal">true</span>);
    _handleCallback(message);
    _notifyListeners(<span class="hljs-string">'/meta/disconnect'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_disconnectResponse</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (message.successful) {
      _disconnect(<span class="hljs-literal">false</span>);
      _handleCallback(message);
      _notifyListeners(<span class="hljs-string">'/meta/disconnect'</span>, message);
    } <span class="hljs-keyword">else</span> {
      _failDisconnect(message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_disconnectFailure</span>(<span class="hljs-params">message</span>) </span>{
    _failDisconnect(message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failSubscribe</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">var</span> subscriptions = _listeners[message.subscription];
    <span class="hljs-keyword">if</span> (subscriptions) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = subscriptions.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; --i) {
        <span class="hljs-keyword">var</span> subscription = subscriptions[i];
        <span class="hljs-keyword">if</span> (subscription &amp;&amp; !subscription.listener) {
          <span class="hljs-keyword">delete</span> subscriptions[i];
          _cometd._debug(<span class="hljs-string">'Removed failed subscription'</span>, subscription);
          <span class="hljs-keyword">break</span>;
        }
      }
    }
    _handleCallback(message);
    _notifyListeners(<span class="hljs-string">'/meta/subscribe'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_subscribeResponse</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (message.successful) {
      _handleCallback(message);
      _notifyListeners(<span class="hljs-string">'/meta/subscribe'</span>, message);
    } <span class="hljs-keyword">else</span> {
      _failSubscribe(message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_subscribeFailure</span>(<span class="hljs-params">message</span>) </span>{
    _failSubscribe(message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failUnsubscribe</span>(<span class="hljs-params">message</span>) </span>{
    _handleCallback(message);
    _notifyListeners(<span class="hljs-string">'/meta/unsubscribe'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_unsubscribeResponse</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (message.successful) {
      _handleCallback(message);
      _notifyListeners(<span class="hljs-string">'/meta/unsubscribe'</span>, message);
    } <span class="hljs-keyword">else</span> {
      _failUnsubscribe(message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_unsubscribeFailure</span>(<span class="hljs-params">message</span>) </span>{
    _failUnsubscribe(message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failMessage</span>(<span class="hljs-params">message</span>) </span>{
    _handleCallback(message);
    _notifyListeners(<span class="hljs-string">'/meta/publish'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_messageResponse</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (message.successful === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (message.data !== <span class="hljs-literal">undefined</span>) {
        _notifyListeners(message.channel, message);
      } <span class="hljs-keyword">else</span> {
        _cometd._warn(<span class="hljs-string">'Unknown Bayeux Message'</span>, message);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (message.successful) {
        _handleCallback(message);
        _notifyListeners(<span class="hljs-string">'/meta/publish'</span>, message);
      } <span class="hljs-keyword">else</span> {
        _failMessage(message);
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_messageFailure</span>(<span class="hljs-params">failure</span>) </span>{
    _failMessage(failure);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_receive</span>(<span class="hljs-params">message</span>) </span>{
    message = _applyIncomingExtensions(message);
    <span class="hljs-keyword">if</span> (message === <span class="hljs-literal">undefined</span> || message === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span>;
    }
    _updateAdvice(message.advice);
    <span class="hljs-keyword">var</span> channel = message.channel;
    <span class="hljs-keyword">switch</span> (channel) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/handshake'</span>:
        _handshakeResponse(message);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/connect'</span>:
        _connectResponse(message);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/disconnect'</span>:
        _disconnectResponse(message);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/subscribe'</span>:
        _subscribeResponse(message);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/unsubscribe'</span>:
        _unsubscribeResponse(message);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        _messageResponse(message);
        <span class="hljs-keyword">break</span>;
    }
  }
  <span class="hljs-keyword">this</span>.receive = _receive;
  _handleMessages = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rcvdMessages</span>) </span>{
    _cometd._debug(<span class="hljs-string">'Received'</span>, rcvdMessages);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; rcvdMessages.length; ++i) {
      <span class="hljs-keyword">var</span> message = rcvdMessages[i];
      _receive(message);
    }
  };
  _handleFailure = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">conduit, messages, failure</span>) </span>{
    _cometd._debug(<span class="hljs-string">'handleFailure'</span>, conduit, messages, failure);
    failure.transport = conduit;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; messages.length; ++i) {
      <span class="hljs-keyword">var</span> message = messages[i];
      <span class="hljs-keyword">var</span> failureMessage = {
        <span class="hljs-attr">id</span>: message.id,
        <span class="hljs-attr">successful</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">channel</span>: message.channel,
        <span class="hljs-attr">failure</span>: failure
      };
      failure.message = message;
      <span class="hljs-keyword">switch</span> (message.channel) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/handshake'</span>:
          _handshakeFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/connect'</span>:
          _connectFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/disconnect'</span>:
          _disconnectFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/subscribe'</span>:
          failureMessage.subscription = message.subscription;
          _subscribeFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/unsubscribe'</span>:
          failureMessage.subscription = message.subscription;
          _unsubscribeFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          _messageFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
      }
    }
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_hasSubscriptions</span>(<span class="hljs-params">channel</span>) </span>{
    <span class="hljs-keyword">var</span> subscriptions = _listeners[channel];
    <span class="hljs-keyword">if</span> (subscriptions) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; subscriptions.length; ++i) {
        <span class="hljs-keyword">if</span> (subscriptions[i]) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_resolveScopedCallback</span>(<span class="hljs-params">scope, callback</span>) </span>{
    <span class="hljs-keyword">var</span> delegate = {
      <span class="hljs-attr">scope</span>: scope,
      <span class="hljs-attr">method</span>: callback
    };
    <span class="hljs-keyword">if</span> (_isFunction(scope)) {
      delegate.scope = <span class="hljs-literal">undefined</span>;
      delegate.method = scope;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (_isString(callback)) {
        <span class="hljs-keyword">if</span> (!scope) {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Invalid scope '</span> + scope;
        }
        delegate.method = scope[callback];
        <span class="hljs-keyword">if</span> (!_isFunction(delegate.method)) {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Invalid callback '</span> + callback + <span class="hljs-string">' for scope '</span> + scope;
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!_isFunction(callback)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Invalid callback '</span> + callback;
      }
    }
    <span class="hljs-keyword">return</span> delegate;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_addListener</span>(<span class="hljs-params">channel, scope, callback, isListener</span>) </span>{
    <span class="hljs-keyword">var</span> delegate = _resolveScopedCallback(scope, callback);
    _cometd._debug(<span class="hljs-string">'Adding'</span>, isListener ? <span class="hljs-string">'listener'</span> : <span class="hljs-string">'subscription'</span>, <span class="hljs-string">'on'</span>, channel, <span class="hljs-string">'with scope'</span>, delegate.scope, <span class="hljs-string">'and callback'</span>, delegate.method);
    <span class="hljs-keyword">var</span> subscription = {
      <span class="hljs-attr">channel</span>: channel,
      <span class="hljs-attr">scope</span>: delegate.scope,
      <span class="hljs-attr">callback</span>: delegate.method,
      <span class="hljs-attr">listener</span>: isListener
    };
    <span class="hljs-keyword">var</span> subscriptions = _listeners[channel];
    <span class="hljs-keyword">if</span> (!subscriptions) {
      subscriptions = [];
      _listeners[channel] = subscriptions;
    }
    subscription.id = subscriptions.push(subscription) - <span class="hljs-number">1</span>;
    _cometd._debug(<span class="hljs-string">'Added'</span>, isListener ? <span class="hljs-string">'listener'</span> : <span class="hljs-string">'subscription'</span>, subscription);
    subscription[<span class="hljs-number">0</span>] = channel;
    subscription[<span class="hljs-number">1</span>] = subscription.id;
    <span class="hljs-keyword">return</span> subscription;
  }
  <span class="hljs-keyword">this</span>.registerTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, transport, index</span>) </span>{
    <span class="hljs-keyword">var</span> result = _transports.add(type, transport, index);
    <span class="hljs-keyword">if</span> (result) {
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Registered transport'</span>, type);
      <span class="hljs-keyword">if</span> (_isFunction(transport.registered)) {
        transport.registered(type, <span class="hljs-keyword">this</span>);
      }
    }
    <span class="hljs-keyword">return</span> result;
  };
  <span class="hljs-keyword">this</span>.getTransportTypes = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _transports.getTransportTypes();
  };
  <span class="hljs-keyword">this</span>.unregisterTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) </span>{
    <span class="hljs-keyword">var</span> transport = _transports.remove(type);
    <span class="hljs-keyword">if</span> (transport !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Unregistered transport'</span>, type);
      <span class="hljs-keyword">if</span> (_isFunction(transport.unregistered)) {
        transport.unregistered();
      }
    }
    <span class="hljs-keyword">return</span> transport;
  };
  <span class="hljs-keyword">this</span>.unregisterTransports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _transports.clear();
  };
  <span class="hljs-keyword">this</span>.findTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">return</span> _transports.find(name);
  };
  <span class="hljs-keyword">this</span>.configure = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">configuration</span>) </span>{
    _configure.call(<span class="hljs-keyword">this</span>, configuration);
  };
  <span class="hljs-keyword">this</span>.init = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">configuration, handshakeProps</span>) </span>{
    <span class="hljs-keyword">this</span>.configure(configuration);
    <span class="hljs-keyword">this</span>.handshake(handshakeProps);
  };
  <span class="hljs-keyword">this</span>.handshake = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handshakeProps, handshakeCallback</span>) </span>{
    _setStatus(<span class="hljs-string">'disconnected'</span>);
    _reestablish = <span class="hljs-literal">false</span>;
    _handshake(handshakeProps, handshakeCallback);
  };
  <span class="hljs-keyword">this</span>.disconnect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sync, disconnectProps, disconnectCallback</span>) </span>{
    <span class="hljs-keyword">if</span> (_isDisconnected()) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> sync !== <span class="hljs-string">'boolean'</span>) {
      disconnectCallback = disconnectProps;
      disconnectProps = sync;
      sync = <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">if</span> (_isFunction(disconnectProps)) {
      disconnectCallback = disconnectProps;
      disconnectProps = <span class="hljs-literal">undefined</span>;
    }
    <span class="hljs-keyword">var</span> bayeuxMessage = {
      <span class="hljs-attr">channel</span>: <span class="hljs-string">'/meta/disconnect'</span>,
      <span class="hljs-attr">_callback</span>: disconnectCallback
    };
    <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, disconnectProps, bayeuxMessage);
    _setStatus(<span class="hljs-string">'disconnecting'</span>);
    _send(sync === <span class="hljs-literal">true</span>, [message], <span class="hljs-literal">false</span>, <span class="hljs-string">'disconnect'</span>);
  };
  <span class="hljs-keyword">this</span>.startBatch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _startBatch();
  };
  <span class="hljs-keyword">this</span>.endBatch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _endBatch();
  };
  <span class="hljs-keyword">this</span>.batch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, callback</span>) </span>{
    <span class="hljs-keyword">var</span> delegate = _resolveScopedCallback(scope, callback);
    <span class="hljs-keyword">this</span>.startBatch();
    <span class="hljs-keyword">try</span> {
      delegate.method.call(delegate.scope);
      <span class="hljs-keyword">this</span>.endBatch();
    } <span class="hljs-keyword">catch</span> (x) {
      <span class="hljs-keyword">this</span>._info(<span class="hljs-string">'Exception during execution of batch'</span>, x);
      <span class="hljs-keyword">this</span>.endBatch();
      <span class="hljs-keyword">throw</span> x;
    }
  };
  <span class="hljs-keyword">this</span>.addListener = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channel, scope, callback</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal arguments number: required 2, got '</span> + <span class="hljs-built_in">arguments</span>.length;
    }
    <span class="hljs-keyword">if</span> (!_isString(channel)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument type: channel must be a string'</span>;
    }
    <span class="hljs-keyword">return</span> _addListener(channel, scope, callback, <span class="hljs-literal">true</span>);
  };
  <span class="hljs-keyword">this</span>.removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">subscription</span>) </span>{
    <span class="hljs-keyword">if</span> (!subscription || !subscription.channel || !(<span class="hljs-string">"id"</span> <span class="hljs-keyword">in</span> subscription)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Invalid argument: expected subscription, not '</span> + subscription;
    }
    _removeListener(subscription);
  };
  <span class="hljs-keyword">this</span>.clearListeners = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _listeners = {};
  };
  <span class="hljs-keyword">this</span>.subscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channel, scope, callback, subscribeProps, subscribeCallback</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal arguments number: required 2, got '</span> + <span class="hljs-built_in">arguments</span>.length;
    }
    <span class="hljs-keyword">if</span> (!_isString(channel)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument type: channel must be a string'</span>;
    }
    <span class="hljs-keyword">if</span> (_isDisconnected()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal state: already disconnected'</span>;
    }
    <span class="hljs-keyword">if</span> (_isFunction(scope)) {
      subscribeCallback = subscribeProps;
      subscribeProps = callback;
      callback = scope;
      scope = <span class="hljs-literal">undefined</span>;
    }
    <span class="hljs-keyword">if</span> (_isFunction(subscribeProps)) {
      subscribeCallback = subscribeProps;
      subscribeProps = <span class="hljs-literal">undefined</span>;
    }
    <span class="hljs-keyword">var</span> send = !_hasSubscriptions(channel);
    <span class="hljs-keyword">var</span> subscription = _addListener(channel, scope, callback, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">if</span> (send) {
      <span class="hljs-keyword">var</span> bayeuxMessage = {
        <span class="hljs-attr">channel</span>: <span class="hljs-string">'/meta/subscribe'</span>,
        <span class="hljs-attr">subscription</span>: channel,
        <span class="hljs-attr">_callback</span>: subscribeCallback
      };
      <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, subscribeProps, bayeuxMessage);
      _queueSend(message);
    }
    <span class="hljs-keyword">return</span> subscription;
  };
  <span class="hljs-keyword">this</span>.unsubscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">subscription, unsubscribeProps, unsubscribeCallback</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal arguments number: required 1, got '</span> + <span class="hljs-built_in">arguments</span>.length;
    }
    <span class="hljs-keyword">if</span> (_isDisconnected()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal state: already disconnected'</span>;
    }
    <span class="hljs-keyword">if</span> (_isFunction(unsubscribeProps)) {
      unsubscribeCallback = unsubscribeProps;
      unsubscribeProps = <span class="hljs-literal">undefined</span>;
    }
    <span class="hljs-keyword">this</span>.removeListener(subscription);
    <span class="hljs-keyword">var</span> channel = subscription.channel;
    <span class="hljs-keyword">if</span> (!_hasSubscriptions(channel)) {
      <span class="hljs-keyword">var</span> bayeuxMessage = {
        <span class="hljs-attr">channel</span>: <span class="hljs-string">'/meta/unsubscribe'</span>,
        <span class="hljs-attr">subscription</span>: channel,
        <span class="hljs-attr">_callback</span>: unsubscribeCallback
      };
      <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, unsubscribeProps, bayeuxMessage);
      _queueSend(message);
    }
  };
  <span class="hljs-keyword">this</span>.resubscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">subscription, subscribeProps</span>) </span>{
    _removeSubscription(subscription);
    <span class="hljs-keyword">if</span> (subscription) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.subscribe(subscription.channel, subscription.scope, subscription.callback, subscribeProps);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  };
  <span class="hljs-keyword">this</span>.clearSubscriptions = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _clearSubscriptions();
  };
  <span class="hljs-keyword">this</span>.publish = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channel, content, publishProps, publishCallback</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal arguments number: required 1, got '</span> + <span class="hljs-built_in">arguments</span>.length;
    }
    <span class="hljs-keyword">if</span> (!_isString(channel)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument type: channel must be a string'</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^\/meta\//</span>.test(channel)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument: cannot publish to meta channels'</span>;
    }
    <span class="hljs-keyword">if</span> (_isDisconnected()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal state: already disconnected'</span>;
    }
    <span class="hljs-keyword">if</span> (_isFunction(content)) {
      publishCallback = content;
      content = publishProps = {};
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_isFunction(publishProps)) {
      publishCallback = publishProps;
      publishProps = {};
    }
    <span class="hljs-keyword">var</span> bayeuxMessage = {
      <span class="hljs-attr">channel</span>: channel,
      <span class="hljs-attr">data</span>: content,
      <span class="hljs-attr">_callback</span>: publishCallback
    };
    <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, publishProps, bayeuxMessage);
    _queueSend(message);
  };
  <span class="hljs-keyword">this</span>.getStatus = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _status;
  };
  <span class="hljs-keyword">this</span>.isDisconnected = _isDisconnected;
  <span class="hljs-keyword">this</span>.setBackoffIncrement = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">period</span>) </span>{
    _config.backoffIncrement = period;
  };
  <span class="hljs-keyword">this</span>.getBackoffIncrement = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _config.backoffIncrement;
  };
  <span class="hljs-keyword">this</span>.getBackoffPeriod = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _backoff;
  };
  <span class="hljs-keyword">this</span>.setLogLevel = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">level</span>) </span>{
    _config.logLevel = level;
  };
  <span class="hljs-keyword">this</span>.registerExtension = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, extension</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal arguments number: required 2, got '</span> + <span class="hljs-built_in">arguments</span>.length;
    }
    <span class="hljs-keyword">if</span> (!_isString(name)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument type: extension name must be a string'</span>;
    }
    <span class="hljs-keyword">var</span> existing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _extensions.length; ++i) {
      <span class="hljs-keyword">var</span> existingExtension = _extensions[i];
      <span class="hljs-keyword">if</span> (existingExtension.name === name) {
        existing = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">break</span>;
      }
    }
    <span class="hljs-keyword">if</span> (!existing) {
      _extensions.push({
        <span class="hljs-attr">name</span>: name,
        <span class="hljs-attr">extension</span>: extension
      });
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Registered extension'</span>, name);
      <span class="hljs-keyword">if</span> (_isFunction(extension.registered)) {
        extension.registered(name, <span class="hljs-keyword">this</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>._info(<span class="hljs-string">'Could not register extension with name'</span>, name, <span class="hljs-string">'since another extension with the same name already exists'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  };
  <span class="hljs-keyword">this</span>.unregisterExtension = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">if</span> (!_isString(name)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument type: extension name must be a string'</span>;
    }
    <span class="hljs-keyword">var</span> unregistered = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _extensions.length; ++i) {
      <span class="hljs-keyword">var</span> extension = _extensions[i];
      <span class="hljs-keyword">if</span> (extension.name === name) {
        _extensions.splice(i, <span class="hljs-number">1</span>);
        unregistered = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Unregistered extension'</span>, name);
        <span class="hljs-keyword">var</span> ext = extension.extension;
        <span class="hljs-keyword">if</span> (_isFunction(ext.unregistered)) {
          ext.unregistered();
        }
        <span class="hljs-keyword">break</span>;
      }
    }
    <span class="hljs-keyword">return</span> unregistered;
  };
  <span class="hljs-keyword">this</span>.getExtension = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _extensions.length; ++i) {
      <span class="hljs-keyword">var</span> extension = _extensions[i];
      <span class="hljs-keyword">if</span> (extension.name === name) {
        <span class="hljs-keyword">return</span> extension.extension;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };
  <span class="hljs-keyword">this</span>.getName = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _name;
  };
  <span class="hljs-keyword">this</span>.getClientId = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _clientId;
  };
  <span class="hljs-keyword">this</span>.getURL = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_transport &amp;&amp; <span class="hljs-keyword">typeof</span> _config.urls === <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">var</span> url = _config.urls[_transport.getType()];
      <span class="hljs-keyword">if</span> (url) {
        <span class="hljs-keyword">return</span> url;
      }
    }
    <span class="hljs-keyword">return</span> _config.url;
  };
  <span class="hljs-keyword">this</span>.getTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _transport;
  };
  <span class="hljs-keyword">this</span>.getConfiguration = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">true</span>, {}, _config);
  };
  <span class="hljs-keyword">this</span>.getAdvice = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">true</span>, {}, _advice);
  };
  org.cometd.WebSocket = <span class="hljs-built_in">window</span>.WebSocket;
  <span class="hljs-keyword">if</span> (!org.cometd.WebSocket) {
    org.cometd.WebSocket = <span class="hljs-built_in">window</span>.MozWebSocket;
  }
};
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {
  define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> org.cometd;
  });
};
<span class="hljs-comment">/*! RESOURCE: /scripts/thirdparty/cometd/jquery/jquery.cometd.js */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bind</span>(<span class="hljs-params">$, org_cometd</span>) </span>{
    org_cometd.JSON.toJSON = (<span class="hljs-built_in">window</span>.JSON &amp;&amp; <span class="hljs-built_in">JSON</span>.stringify) || (<span class="hljs-built_in">window</span>.jaredJSON &amp;&amp; <span class="hljs-built_in">window</span>.jaredJSON.stringify);
    org_cometd.JSON.fromJSON = (<span class="hljs-built_in">window</span>.JSON &amp;&amp; <span class="hljs-built_in">JSON</span>.parse) || (<span class="hljs-built_in">window</span>.jaredJSON &amp;&amp; <span class="hljs-built_in">window</span>.jaredJSON.parse);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_setHeaders</span>(<span class="hljs-params">xhr, headers</span>) </span>{
      <span class="hljs-keyword">if</span> (headers) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> headerName <span class="hljs-keyword">in</span> headers) {
          <span class="hljs-keyword">if</span> (headerName.toLowerCase() === <span class="hljs-string">'content-type'</span>) {
            <span class="hljs-keyword">continue</span>;
          }
          xhr.setRequestHeader(headerName, headers[headerName]);
        }
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">LongPollingTransport</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org_cometd.LongPollingTransport();
      <span class="hljs-keyword">var</span> that = org_cometd.Transport.derive(_super);
      that.xhrSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">packet</span>) </span>{
        <span class="hljs-keyword">return</span> $.ajax({
          <span class="hljs-attr">url</span>: packet.url,
          <span class="hljs-attr">async</span>: packet.sync !== <span class="hljs-literal">true</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'POST'</span>,
          <span class="hljs-attr">contentType</span>: <span class="hljs-string">'application/json;charset=UTF-8'</span>,
          <span class="hljs-attr">data</span>: packet.body,
          <span class="hljs-attr">xhrFields</span>: {
            <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">true</span>
          },
          <span class="hljs-attr">beforeSend</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr</span>) </span>{
            _setHeaders(xhr, packet.headers);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
          },
          <span class="hljs-attr">success</span>: packet.onSuccess,
          <span class="hljs-attr">error</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr, reason, exception</span>) </span>{
            packet.onError(reason, exception);
          }
        });
      };
      <span class="hljs-keyword">return</span> that;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CallbackPollingTransport</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org_cometd.CallbackPollingTransport();
      <span class="hljs-keyword">var</span> that = org_cometd.Transport.derive(_super);
      that.jsonpSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">packet</span>) </span>{
        $.ajax({
          <span class="hljs-attr">url</span>: packet.url,
          <span class="hljs-attr">async</span>: packet.sync !== <span class="hljs-literal">true</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'GET'</span>,
          <span class="hljs-attr">dataType</span>: <span class="hljs-string">'jsonp'</span>,
          <span class="hljs-attr">jsonp</span>: <span class="hljs-string">'jsonp'</span>,
          <span class="hljs-attr">data</span>: {
            <span class="hljs-attr">message</span>: packet.body
          },
          <span class="hljs-attr">beforeSend</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr</span>) </span>{
            _setHeaders(xhr, packet.headers);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
          },
          <span class="hljs-attr">success</span>: packet.onSuccess,
          <span class="hljs-attr">error</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr, reason, exception</span>) </span>{
            packet.onError(reason, exception);
          }
        });
      };
      <span class="hljs-keyword">return</span> that;
    }
    $.Cometd = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
      <span class="hljs-keyword">var</span> cometd = <span class="hljs-keyword">new</span> org_cometd.Cometd(name);
      <span class="hljs-keyword">if</span> (org_cometd.WebSocket) {
        cometd.registerTransport(<span class="hljs-string">'websocket'</span>, <span class="hljs-keyword">new</span> org_cometd.WebSocketTransport());
      }
      cometd.registerTransport(<span class="hljs-string">'long-polling'</span>, <span class="hljs-keyword">new</span> LongPollingTransport());
      cometd.registerTransport(<span class="hljs-string">'callback-polling'</span>, <span class="hljs-keyword">new</span> CallbackPollingTransport());
      <span class="hljs-keyword">return</span> cometd;
    };
    $.cometd = <span class="hljs-keyword">new</span> $.Cometd();
    <span class="hljs-keyword">return</span> $.cometd;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {
    define([<span class="hljs-string">'jquery'</span>, <span class="hljs-string">'org/cometd'</span>], bind);
  } <span class="hljs-keyword">else</span> {
    bind(<span class="hljs-built_in">window</span>.jQuery || <span class="hljs-built_in">window</span>.Zepto, org.cometd);
  }
})();;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb_properties.js */</span>
<span class="hljs-keyword">var</span> amb = amb || {
  <span class="hljs-attr">properties</span>: {
    <span class="hljs-attr">servletURI</span>: <span class="hljs-string">'amb/'</span>,
    <span class="hljs-attr">logLevel</span>: <span class="hljs-string">'info'</span>,
    <span class="hljs-attr">loginWindow</span>: <span class="hljs-string">'true'</span>
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.Logger.js */</span>
amb[<span class="hljs-string">'Logger'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callerType</span>) </span>{
  <span class="hljs-keyword">var</span> _debugEnabled = amb[<span class="hljs-string">'properties'</span>][<span class="hljs-string">'logLevel'</span>] == <span class="hljs-string">'debug'</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">print</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.console)
      <span class="hljs-built_in">console</span>.log(callerType + <span class="hljs-string">' '</span> + message);
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">debug</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      <span class="hljs-keyword">if</span> (_debugEnabled)
        print(<span class="hljs-string">'[DEBUG] '</span> + message);
    },
    <span class="hljs-attr">addInfoMessage</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      print(<span class="hljs-string">'[INFO] '</span> + message);
    },
    <span class="hljs-attr">addErrorMessage</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      print(<span class="hljs-string">'[ERROR] '</span> + message);
    }
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.EventManager.js */</span>
amb.EventManager = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EventManager</span>(<span class="hljs-params">events</span>) </span>{
  <span class="hljs-keyword">var</span> _subscriptions = [];
  <span class="hljs-keyword">var</span> _idCounter = <span class="hljs-number">0</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getSubscriptions</span>(<span class="hljs-params">event</span>) </span>{
    <span class="hljs-keyword">var</span> subscriptions = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _subscriptions.length; i++) {
      <span class="hljs-keyword">if</span> (_subscriptions[i].event == event)
        subscriptions.push(_subscriptions[i]);
    }
    <span class="hljs-keyword">return</span> subscriptions;
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">subscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
      <span class="hljs-keyword">var</span> id = _idCounter++;
      _subscriptions.push({
        <span class="hljs-attr">event</span>: event,
        <span class="hljs-attr">callback</span>: callback,
        <span class="hljs-attr">id</span>: id
      });
      <span class="hljs-keyword">return</span> id;
    },
    <span class="hljs-attr">unsubscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _subscriptions.length; i++)
        <span class="hljs-keyword">if</span> (id == _subscriptions[i].id)
          _subscriptions.splice(i, <span class="hljs-number">1</span>);
    },
    <span class="hljs-attr">publish</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, args</span>) </span>{
      <span class="hljs-keyword">var</span> subscriptions = _getSubscriptions(event);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; subscriptions.length; i++)
        subscriptions[i].callback.apply(<span class="hljs-literal">null</span>, args);
    },
    <span class="hljs-attr">getEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> events;
    }
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.ServerConnection.js */</span>
amb.ServerConnection = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ServerConnection</span>(<span class="hljs-params">cometd</span>) </span>{
  <span class="hljs-keyword">var</span> connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> disconnecting = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> eventManager = <span class="hljs-keyword">new</span> amb.EventManager({
    <span class="hljs-attr">CONNECTION_INITIALIZED</span>: <span class="hljs-string">'connection.initialized'</span>,
    <span class="hljs-attr">CONNECTION_OPENED</span>: <span class="hljs-string">'connection.opened'</span>,
    <span class="hljs-attr">CONNECTION_CLOSED</span>: <span class="hljs-string">'connection.closed'</span>,
    <span class="hljs-attr">CONNECTION_BROKEN</span>: <span class="hljs-string">'connection.broken'</span>,
    <span class="hljs-attr">SESSION_LOGGED_IN</span>: <span class="hljs-string">'session.logged.in'</span>,
    <span class="hljs-attr">SESSION_LOGGED_OUT</span>: <span class="hljs-string">'session.logged.out'</span>,
    <span class="hljs-attr">SESSION_INVALIDATED</span>: <span class="hljs-string">'session.invalidated'</span>
  });
  <span class="hljs-keyword">var</span> state = <span class="hljs-string">"closed"</span>;
  <span class="hljs-keyword">var</span> LOGGER = <span class="hljs-keyword">new</span> amb.Logger(<span class="hljs-string">'amb.ServerConnection'</span>);
  _initializeMetaChannelListeners();
  <span class="hljs-keyword">var</span> loggedIn = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> loginWindow = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> loginWindowEnabled = amb.properties[<span class="hljs-string">'loginWindow'</span>] === <span class="hljs-string">'true'</span>;
  <span class="hljs-keyword">var</span> lastError = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> errorMessages = {
    <span class="hljs-string">'UNKNOWN_CLIENT'</span>: <span class="hljs-string">'402::Unknown client'</span>
  };
  <span class="hljs-keyword">var</span> loginWindowOverride = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> ambServerConnection = {};
  ambServerConnection.connect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (connected) {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"&gt;&gt;&gt; connection exists, request satisfied"</span>);
      <span class="hljs-keyword">return</span>;
    }
    LOGGER.debug(<span class="hljs-string">'Connecting to glide amb server -&gt; '</span> + amb[<span class="hljs-string">'properties'</span>][<span class="hljs-string">'servletURI'</span>]);
    cometd.configure({
      <span class="hljs-attr">url</span>: _getRelativePath(amb[<span class="hljs-string">'properties'</span>][<span class="hljs-string">'servletURI'</span>]),
      <span class="hljs-attr">logLevel</span>: amb[<span class="hljs-string">'properties'</span>][<span class="hljs-string">'logLevel'</span>]
    });
    cometd.handshake();
  };
  ambServerConnection.reload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    cometd.reload();
  };
  ambServerConnection.abort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    cometd.getTransport().abort();
  };
  ambServerConnection.disconnect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.debug(<span class="hljs-string">'Disconnecting from glide amb server..'</span>);
    disconnecting = <span class="hljs-literal">true</span>;
    cometd.disconnect();
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initializeMetaChannelListeners</span>(<span class="hljs-params"></span>) </span>{
    cometd.addListener(<span class="hljs-string">'/meta/handshake'</span>, <span class="hljs-keyword">this</span>, _metaHandshake);
    cometd.addListener(<span class="hljs-string">'/meta/connect'</span>, <span class="hljs-keyword">this</span>, _metaConnect);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_metaHandshake</span>(<span class="hljs-params">message</span>) </span>{
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (message[<span class="hljs-string">'successful'</span>])
        _connectionInitialized();
    }, <span class="hljs-number">0</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_metaConnect</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (disconnecting) {
      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        connected = <span class="hljs-literal">false</span>;
        _connectionClosed();
      }, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> error = message[<span class="hljs-string">'error'</span>];
    <span class="hljs-keyword">if</span> (error)
      lastError = error;
    _sessionStatus(message);
    <span class="hljs-keyword">var</span> wasConnected = connected;
    connected = (message[<span class="hljs-string">'successful'</span>] === <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">if</span> (!wasConnected &amp;&amp; connected)
      _connectionOpened();
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (wasConnected &amp;&amp; !connected)
      _connectionBroken();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionInitialized</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.debug(<span class="hljs-string">'Connection initialized'</span>);
    state = <span class="hljs-string">"initialized"</span>;
    eventManager.publish(eventManager.getEvents().CONNECTION_INITIALIZED);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionOpened</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.debug(<span class="hljs-string">'Connection opened'</span>);
    state = <span class="hljs-string">"opened"</span>;
    eventManager.publish(eventManager.getEvents().CONNECTION_OPENED);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionClosed</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.debug(<span class="hljs-string">'Connection closed'</span>);
    state = <span class="hljs-string">"closed"</span>;
    eventManager.publish(eventManager.getEvents().CONNECTION_CLOSED);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionBroken</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.addErrorMessage(<span class="hljs-string">'Connection broken'</span>);
    state = <span class="hljs-string">"broken"</span>;
    eventManager.publish(eventManager.getEvents().CONNECTION_BROKEN);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_sessionStatus</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">var</span> ext = message[<span class="hljs-string">'ext'</span>];
    <span class="hljs-keyword">if</span> (ext) {
      <span class="hljs-keyword">var</span> sessionStatus = ext[<span class="hljs-string">'glide.session.status'</span>];
      loginWindowOverride = ext[<span class="hljs-string">'glide.amb.login.window.override'</span>] === <span class="hljs-literal">true</span>;
      LOGGER.debug(<span class="hljs-string">'session.status - '</span> + sessionStatus);
      <span class="hljs-keyword">switch</span> (sessionStatus) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'session.logged.out'</span>:
          <span class="hljs-keyword">if</span> (loggedIn)
            _logout();
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'session.logged.in'</span>:
          <span class="hljs-keyword">if</span> (!loggedIn)
            _login();
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'session.invalidated'</span>:
          <span class="hljs-keyword">if</span> (loggedIn)
            _invalidated();
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          LOGGER.debug(<span class="hljs-string">"unknown session status - "</span> + sessionStatus);
          <span class="hljs-keyword">break</span>;
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_login</span>(<span class="hljs-params"></span>) </span>{
    loggedIn = <span class="hljs-literal">true</span>;
    LOGGER.debug(<span class="hljs-string">"LOGGED_IN event fire!"</span>);
    eventManager.publish(eventManager.getEvents().SESSION_LOGGED_IN);
    ambServerConnection.loginHide();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_logout</span>(<span class="hljs-params"></span>) </span>{
    loggedIn = <span class="hljs-literal">false</span>;
    LOGGER.debug(<span class="hljs-string">"LOGGED_OUT event fire!"</span>);
    eventManager.publish(eventManager.getEvents().SESSION_LOGGED_OUT);
    ambServerConnection.loginShow();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_invalidated</span>(<span class="hljs-params"></span>) </span>{
    loggedIn = <span class="hljs-literal">false</span>;
    LOGGER.debug(<span class="hljs-string">"INVALIDATED event fire!"</span>);
    eventManager.publish(eventManager.getEvents().SESSION_INVALIDATED);
  }
  <span class="hljs-keyword">var</span> modalContent = <span class="hljs-string">'&lt;iframe src="/amb_login.do" frameborder="0" height="400px" width="405px" scrolling="no"&gt;&lt;/iframe&gt;'</span>;
  <span class="hljs-keyword">var</span> modalTemplate = <span class="hljs-string">'&lt;div id="amb_disconnect_modal" tabindex="-1" aria-hidden="true" class="modal" role="dialog"&gt;'</span> +
    <span class="hljs-string">'  &lt;div class="modal-dialog small-modal" style="width:450px"&gt;'</span> +
    <span class="hljs-string">'     &lt;div class="modal-content"&gt;'</span> +
    <span class="hljs-string">'        &lt;header class="modal-header"&gt;'</span> +
    <span class="hljs-string">'           &lt;h4 id="small_modal1_title" class="modal-title"&gt;Login&lt;/h4&gt;'</span> +
    <span class="hljs-string">'        &lt;/header&gt;'</span> +
    <span class="hljs-string">'        &lt;div class="modal-body"&gt;'</span> +
    <span class="hljs-string">'        &lt;/div&gt;'</span> +
    <span class="hljs-string">'     &lt;/div&gt;'</span> +
    <span class="hljs-string">'  &lt;/div&gt;'</span> +
    <span class="hljs-string">'&lt;/div&gt;'</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_loginShow</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.debug(<span class="hljs-string">"Show login window"</span>);
    <span class="hljs-keyword">if</span> (!loginWindowEnabled || loginWindowOverride)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> dialog = <span class="hljs-keyword">new</span> GlideModal(<span class="hljs-string">'amb_disconnect_modal'</span>);
    <span class="hljs-keyword">if</span> (dialog[<span class="hljs-string">'renderWithContent'</span>]) {
      dialog.template = modalTemplate;
      dialog.renderWithContent(modalContent);
    } <span class="hljs-keyword">else</span> {
      dialog.setBody(modalContent);
      dialog.render();
    }
    loginWindow = dialog;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_loginHide</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!loginWindow)
      <span class="hljs-keyword">return</span>;
    loginWindow.destroy();
    loginWindow = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loginComplete</span>(<span class="hljs-params"></span>) </span>{
    _login();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getRelativePath</span>(<span class="hljs-params">uri</span>) </span>{
    <span class="hljs-keyword">var</span> relativePath = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">window</span>.location.pathname.match(<span class="hljs-regexp">/\//g</span>).length - <span class="hljs-number">1</span>; i++) {
      relativePath = <span class="hljs-string">"../"</span> + relativePath;
    }
    <span class="hljs-keyword">return</span> relativePath + uri;
  }
  ambServerConnection.getEvents = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> eventManager.getEvents();
  };
  ambServerConnection.getConnectionState = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> state;
  };
  ambServerConnection.getLastError = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> lastError;
  };
  ambServerConnection.setLastError = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
    lastError = error;
  };
  ambServerConnection.getErrorMessages = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> errorMessages;
  };
  ambServerConnection.isLoggedIn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> loggedIn;
  };
  ambServerConnection.loginShow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _loginShow();
  };
  ambServerConnection.loginHide = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _loginHide();
  };
  ambServerConnection.loginComplete = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _login();
  };
  ambServerConnection.subscribeToEvent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
    <span class="hljs-keyword">if</span> (eventManager.getEvents().CONNECTION_OPENED == event &amp;&amp; connected)
      callback();
    <span class="hljs-keyword">return</span> eventManager.subscribe(event, callback);
  };
  ambServerConnection.unsubscribeFromEvent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
    eventManager.unsubscribe(id);
  };
  ambServerConnection.getConnectionState = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> state;
  };
  ambServerConnection.isLoginWindowEnabled = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> loginWindowEnabled;
  };
  ambServerConnection.isLoginWindowOverride = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> loginWindowOverride;
  }
  <span class="hljs-keyword">return</span> ambServerConnection;
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.ChannelRedirect.js */</span>
amb.ChannelRedirect = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ChannelRedirect</span>(<span class="hljs-params">cometd, serverConnection,
  channelProvider</span>) </span>{
  <span class="hljs-keyword">var</span> initialized = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _cometd = cometd;
  <span class="hljs-keyword">var</span> eventManager = <span class="hljs-keyword">new</span> amb.EventManager({
    <span class="hljs-attr">CHANNEL_REDIRECT</span>: <span class="hljs-string">'channel.redirect'</span>
  });
  <span class="hljs-keyword">var</span> LOGGER = <span class="hljs-keyword">new</span> amb.Logger(<span class="hljs-string">'amb.ChannelRedirect'</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_onAdvice</span>(<span class="hljs-params">advice</span>) </span>{
    LOGGER.debug(<span class="hljs-string">'_onAdvice:'</span> + advice.data.clientId);
    <span class="hljs-keyword">var</span> fromChannel = channelProvider(advice.data.fromChannel);
    <span class="hljs-keyword">var</span> toChannel = channelProvider(advice.data.toChannel);
    eventManager.publish(eventManager.getEvents().CHANNEL_REDIRECT, [fromChannel, toChannel]);
    LOGGER.debug(
      <span class="hljs-string">'published channel switch event, fromChannel:'</span> + fromChannel.getName() +
      <span class="hljs-string">', toChannel:'</span> + toChannel.getName());
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">subscribeToEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
      <span class="hljs-keyword">return</span> eventManager.subscribe(event, callback);
    },
    <span class="hljs-attr">unsubscribeToEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
      eventManager.unsubscribe(id);
    },
    <span class="hljs-attr">getEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> eventManager.getEvents();
    },
    <span class="hljs-attr">initialize</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!initialized) {
        <span class="hljs-keyword">var</span> channelName = <span class="hljs-string">'/sn/meta/channel_redirect/'</span> + _cometd.getClientId();
        <span class="hljs-keyword">var</span> metaChannel = channelProvider(channelName);
        metaChannel.newListener(serverConnection, <span class="hljs-literal">null</span>).subscribe(_onAdvice);
        LOGGER.debug(<span class="hljs-string">"ChannelRedirect initialized: "</span> + channelName);
        initialized = <span class="hljs-literal">true</span>;
      }
    }
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.ChannelListener.js */</span>
amb.ChannelListener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ChannelListener</span>(<span class="hljs-params">channel, serverConnection,
  channelRedirect</span>) </span>{
  <span class="hljs-keyword">var</span> id;
  <span class="hljs-keyword">var</span> subscriberCallback;
  <span class="hljs-keyword">var</span> LOGGER = <span class="hljs-keyword">new</span> amb.Logger(<span class="hljs-string">'amb.ChannelListener'</span>);
  <span class="hljs-keyword">var</span> channelRedirectId = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> connectOpenedEventId;
  <span class="hljs-keyword">var</span> currentChannel = channel;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">getCallback</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> subscriberCallback;
    },
    <span class="hljs-attr">getID</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> id;
    },
    <span class="hljs-attr">subscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
      subscriberCallback = callback;
      <span class="hljs-keyword">if</span> (channelRedirect)
        channelRedirectId = channelRedirect.subscribeToEvent(
          channelRedirect.getEvents().CHANNEL_REDIRECT, <span class="hljs-keyword">this</span>._switchToChannel.bind(<span class="hljs-keyword">this</span>));
      connectOpenedEventId = serverConnection.subscribeToEvent(serverConnection.getEvents().CONNECTION_OPENED, <span class="hljs-keyword">this</span>._subscribeWhenReady.bind(<span class="hljs-keyword">this</span>));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },
    <span class="hljs-attr">resubscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.subscribe(subscriberCallback);
    },
    <span class="hljs-attr">_switchToChannel</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fromChannel, toChannel</span>) </span>{
      <span class="hljs-keyword">if</span> (!fromChannel || !toChannel)
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (fromChannel.getName() != currentChannel.getName())
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">this</span>.unsubscribe();
      currentChannel = toChannel;
      <span class="hljs-keyword">this</span>.subscribe(subscriberCallback);
    },
    <span class="hljs-attr">_subscribeWhenReady</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      LOGGER.debug(<span class="hljs-string">"Subscribing to '"</span> + currentChannel.getName() + <span class="hljs-string">"'..."</span>);
      id = currentChannel.subscribe(<span class="hljs-keyword">this</span>);
    },
    <span class="hljs-attr">unsubscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      channelRedirect.unsubscribeToEvent(channelRedirectId);
      currentChannel.unsubscribe(<span class="hljs-keyword">this</span>);
      serverConnection.unsubscribeFromEvent(connectOpenedEventId);
      LOGGER.debug(<span class="hljs-string">"Unsubscribed from channel: "</span> + currentChannel.getName());
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },
    <span class="hljs-attr">publish</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      currentChannel.publish(message);
    },
    <span class="hljs-attr">getName</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> currentChannel.getName();
    }
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.Channel.js */</span>
amb.Channel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Channel</span>(<span class="hljs-params">cometd, channelName, initialized</span>) </span>{
  <span class="hljs-keyword">var</span> subscription = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> listeners = [];
  <span class="hljs-keyword">var</span> LOGGER = <span class="hljs-keyword">new</span> amb.Logger(<span class="hljs-string">'amb.Channel'</span>);
  <span class="hljs-keyword">var</span> idCounter = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> _initialized = initialized;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_disconnected</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> status = cometd.getStatus();
    <span class="hljs-keyword">return</span> status === <span class="hljs-string">'disconnecting'</span> || status === <span class="hljs-string">'disconnected'</span>;
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">newListener</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serverConnection,
      channelRedirect</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> amb.ChannelListener(<span class="hljs-keyword">this</span>, serverConnection, channelRedirect);
    },
    <span class="hljs-attr">subscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">listener</span>) </span>{
      <span class="hljs-keyword">if</span> (!listener.getCallback()) {
        LOGGER.addErrorMessage(<span class="hljs-string">'Cannot subscribe to channel: '</span> + channelName +
          <span class="hljs-string">', callback not provided'</span>);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">if</span> (!subscription &amp;&amp; _initialized)
        <span class="hljs-keyword">this</span>.subscribeToCometD();
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++) {
        <span class="hljs-keyword">if</span> (listeners[i] === listener) {
          LOGGER.debug(<span class="hljs-string">'Channel listener already in the list'</span>);
          <span class="hljs-keyword">return</span> listener.getID();
        }
      }
      <span class="hljs-keyword">var</span> id = idCounter++;
      listeners.push(listener);
      <span class="hljs-keyword">return</span> id;
    },
    <span class="hljs-attr">resubscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      subscription = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++)
        listeners[i].resubscribe();
    },
    <span class="hljs-attr">subscribeOnInitCompletion</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">redirect</span>) </span>{
      _initialized = <span class="hljs-literal">true</span>;
      subscription = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++) {
        listeners[i].subscribe();
        LOGGER.debug(<span class="hljs-string">'Successfully subscribed to channel: '</span> + channelName);
      }
    },
    <span class="hljs-attr">_handleResponse</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++)
        listeners[i].getCallback()(message);
    },
    <span class="hljs-attr">unsubscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">listener</span>) </span>{
      <span class="hljs-keyword">if</span> (!listener) {
        LOGGER.addErrorMessage(<span class="hljs-string">'Cannot unsubscribe from channel: '</span> + channelName +
          <span class="hljs-string">', listener argument does not exist'</span>);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++) {
        <span class="hljs-keyword">if</span> (listeners[i].getID() == listener.getID())
          listeners.splice(i, <span class="hljs-number">1</span>);
      }
      <span class="hljs-keyword">if</span> (listeners.length &lt; <span class="hljs-number">1</span> &amp;&amp; subscription &amp;&amp; !_disconnected())
        <span class="hljs-keyword">this</span>.unsubscribeFromCometD();
    },
    <span class="hljs-attr">publish</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      cometd.publish(channelName, message);
    },
    <span class="hljs-attr">subscribeToCometD</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      subscription = cometd.subscribe(channelName, <span class="hljs-keyword">this</span>._handleResponse.bind(<span class="hljs-keyword">this</span>));
      LOGGER.debug(<span class="hljs-string">'Successfully subscribed to channel: '</span> + channelName);
    },
    <span class="hljs-attr">unsubscribeFromCometD</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      cometd.unsubscribe(subscription);
      subscription = <span class="hljs-literal">null</span>;
      LOGGER.debug(<span class="hljs-string">'Successfully unsubscribed from channel: '</span> + channelName);
    },
    <span class="hljs-attr">resubscribeToCometD</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">this</span>.subscribeToCometD();
    },
    <span class="hljs-attr">getName</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> channelName;
    }
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.MessageClient.js */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$</span>) </span>{
  amb.MessageClient = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MessageClient</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> cometd = <span class="hljs-keyword">new</span> $.Cometd();
    cometd.unregisterTransport(<span class="hljs-string">'websocket'</span>);
    cometd.unregisterTransport(<span class="hljs-string">'callback-polling'</span>);
    <span class="hljs-keyword">var</span> serverConnection = <span class="hljs-keyword">new</span> amb.ServerConnection(cometd);
    <span class="hljs-keyword">var</span> channels = {};
    <span class="hljs-keyword">var</span> LOGGER = <span class="hljs-keyword">new</span> amb.Logger(<span class="hljs-string">'amb.MessageClient'</span>);
    <span class="hljs-keyword">var</span> channelRedirect = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> connected = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> initialized = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> uninitializedChannels = [];
    serverConnection.subscribeToEvent(serverConnection.getEvents().CONNECTION_BROKEN, _connectionBroken);
    serverConnection.subscribeToEvent(serverConnection.getEvents().CONNECTION_OPENED, _connectionOpened);
    serverConnection.subscribeToEvent(serverConnection.getEvents().CONNECTION_INITIALIZED, _connectionInitialized);
    serverConnection.subscribeToEvent(serverConnection.getEvents().SESSION_LOGGED_OUT, _unsubscribeAll);
    serverConnection.subscribeToEvent(serverConnection.getEvents().SESSION_INVALIDATED, _unsubscribeAll);
    serverConnection.subscribeToEvent(serverConnection.getEvents().SESSION_LOGGED_IN, _resubscribeAll);
    <span class="hljs-keyword">var</span> _connectionBrokenEvent = <span class="hljs-literal">false</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionBroken</span>(<span class="hljs-params"></span>) </span>{
      LOGGER.debug(<span class="hljs-string">"connection broken!"</span>);
      _connectionBrokenEvent = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionInitialized</span>(<span class="hljs-params"></span>) </span>{
      initialized = <span class="hljs-literal">true</span>;
      _initChannelRedirect();
      channelRedirect.initialize();
      LOGGER.debug(<span class="hljs-string">"Connection initialized. Initializing "</span> + uninitializedChannels.length + <span class="hljs-string">" channels."</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; uninitializedChannels.length; i++) {
        uninitializedChannels[i].subscribeOnInitCompletion();
      }
      uninitializedChannels = [];
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionOpened</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (_connectionBrokenEvent) {
        LOGGER.debug(<span class="hljs-string">"connection opened!"</span>);
        <span class="hljs-keyword">var</span> sc = serverConnection;
        <span class="hljs-keyword">if</span> (sc.getLastError() !== sc.getErrorMessages().UNKNOWN_CLIENT)
          <span class="hljs-keyword">return</span>;
        sc.setLastError(<span class="hljs-literal">null</span>);
        LOGGER.debug(<span class="hljs-string">"channel resubscribe!"</span>);
        $.ajax({
          <span class="hljs-attr">url</span>: <span class="hljs-string">"/amb_session_setup.do"</span>,
          <span class="hljs-attr">method</span>: <span class="hljs-string">"GET"</span>,
          <span class="hljs-attr">contentType</span>: <span class="hljs-string">"application/json;charset=UTF-8"</span>,
          <span class="hljs-attr">data</span>: <span class="hljs-string">""</span>,
          <span class="hljs-attr">dataType</span>: <span class="hljs-string">"HTML"</span>,
          <span class="hljs-attr">headers</span>: {
            <span class="hljs-string">'X-UserToken'</span>: <span class="hljs-built_in">window</span>.g_ck
          }
        }).done(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          _resubscribeAll()
          _connectionBrokenEvent = <span class="hljs-literal">false</span>;
        });
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_unsubscribeAll</span>(<span class="hljs-params"></span>) </span>{
      LOGGER.debug(<span class="hljs-string">"Unsubscribing from all!"</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> channels) {
        <span class="hljs-keyword">var</span> channel = channels[name];
        channel.unsubscribeFromCometD();
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_resubscribeAll</span>(<span class="hljs-params"></span>) </span>{
      LOGGER.debug(<span class="hljs-string">"Resubscribing to all!"</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> channels) {
        <span class="hljs-keyword">var</span> channel = channels[name];
        channel.resubscribeToCometD();
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initChannelRedirect</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (channelRedirect)
        <span class="hljs-keyword">return</span>;
      channelRedirect = <span class="hljs-keyword">new</span> amb.ChannelRedirect(cometd, serverConnection, _getChannel);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getChannel</span>(<span class="hljs-params">channelName</span>) </span>{
      <span class="hljs-keyword">if</span> (channelName <span class="hljs-keyword">in</span> channels)
        <span class="hljs-keyword">return</span> channels[channelName];
      <span class="hljs-keyword">var</span> channel = <span class="hljs-keyword">new</span> amb.Channel(cometd, channelName, initialized);
      channels[channelName] = channel;
      <span class="hljs-keyword">if</span> (!initialized)
        uninitializedChannels.push(channel);
      <span class="hljs-keyword">return</span> channel;
    }
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">getServerConnection</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> serverConnection;
      },
      <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> serverConnection.isLoggedIn();
      },
      <span class="hljs-attr">loginComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        serverConnection.loginComplete();
      },
      <span class="hljs-attr">connect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (connected) {
          LOGGER.addInfoMessage(<span class="hljs-string">"&gt;&gt;&gt; connection exists, request satisfied"</span>);
          <span class="hljs-keyword">return</span>;
        }
        connected = <span class="hljs-literal">true</span>;
        serverConnection.connect();
      },
      <span class="hljs-attr">reload</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        connected = <span class="hljs-literal">false</span>;
        serverConnection.reload();
      },
      <span class="hljs-attr">abort</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        connected = <span class="hljs-literal">false</span>;
        serverConnection.abort();
      },
      <span class="hljs-attr">disconnect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        connected = <span class="hljs-literal">false</span>;
        serverConnection.disconnect();
      },
      <span class="hljs-attr">getConnectionEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> serverConnection.getEvents();
      },
      <span class="hljs-attr">subscribeToEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
        <span class="hljs-keyword">return</span> serverConnection.subscribeToEvent(event, callback);
      },
      <span class="hljs-attr">unsubscribeFromEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
        serverConnection.unsubscribeFromEvent(id);
      },
      <span class="hljs-attr">getConnectionState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> serverConnection.getConnectionState();
      },
      <span class="hljs-attr">getClientId</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> cometd.getClientId();
      },
      <span class="hljs-attr">getChannel</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channelName</span>) </span>{
        _initChannelRedirect();
        <span class="hljs-keyword">var</span> channel = _getChannel(channelName);
        <span class="hljs-keyword">return</span> channel.newListener(serverConnection, channelRedirect);
      },
      <span class="hljs-attr">registerExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName, extension</span>) </span>{
        cometd.registerExtension(extensionName, extension);
      },
      <span class="hljs-attr">unregisterExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName</span>) </span>{
        cometd.unregisterExtension(extensionName);
      },
      <span class="hljs-attr">batch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">block</span>) </span>{
        cometd.batch(block);
      }
    }
  };
})(<span class="hljs-built_in">window</span>.jQuery || <span class="hljs-built_in">window</span>.Zepto);;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.MessageClientBuilder.js */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$</span>) </span>{
  amb.getClient = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> getClient();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getClient</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> _window = <span class="hljs-built_in">window</span>.self;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (!(<span class="hljs-built_in">window</span>.MSInputMethodContext &amp;&amp; <span class="hljs-built_in">document</span>.documentMode)) {
        <span class="hljs-keyword">while</span> (_window != _window.parent) {
          <span class="hljs-keyword">if</span> (_window.g_ambClient)
            <span class="hljs-keyword">break</span>;
          _window = _window.parent;
        }
      }
      <span class="hljs-keyword">if</span> (_window.g_ambClient)
        <span class="hljs-keyword">return</span> _window.g_ambClient;
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"AMB getClient() tried to access parent from an iFrame. Caught error: "</span> + e);
    }
    <span class="hljs-keyword">var</span> client = buildClient();
    setClient(client);
    <span class="hljs-keyword">return</span> client;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setClient</span>(<span class="hljs-params">client</span>) </span>{
    <span class="hljs-keyword">var</span> _window = <span class="hljs-built_in">window</span>.self;
    _window.g_ambClient = client;
    $(_window).unload(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      _window.g_ambClient.disconnect();
    });
    _window.g_ambClient.connect();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildClient</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> ambClient = <span class="hljs-keyword">new</span> amb.MessageClient();
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">getServerConnection</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getServerConnection();
        },
        <span class="hljs-attr">connect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          ambClient.connect();
        },
        <span class="hljs-attr">abort</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          ambClient.abort();
        },
        <span class="hljs-attr">disconnect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          ambClient.disconnect();
        },
        <span class="hljs-attr">getConnectionState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getConnectionState();
        },
        <span class="hljs-attr">getState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getConnectionState();
        },
        <span class="hljs-attr">getClientId</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getClientId();
        },
        <span class="hljs-attr">getChannel</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channelName</span>) </span>{
          <span class="hljs-keyword">var</span> channel = ambClient.getChannel(channelName);
          <span class="hljs-keyword">var</span> originalSubscribe = channel.subscribe;
          <span class="hljs-keyword">var</span> originalUnsubscribe = channel.unsubscribe;
          channel.subscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">listener</span>) </span>{
            originalSubscribe.call(channel, listener);
            $(<span class="hljs-built_in">window</span>).unload(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
              originalUnsubscribe.call(channel);
            });
            <span class="hljs-keyword">return</span> channel;
          };
          <span class="hljs-keyword">return</span> channel;
        },
        <span class="hljs-attr">getChannel0</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channelName</span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getChannel(channelName);
        },
        <span class="hljs-attr">registerExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName, extension</span>) </span>{
          ambClient.registerExtension(extensionName, extension);
        },
        <span class="hljs-attr">unregisterExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName</span>) </span>{
          ambClient.unregisterExtension(extensionName);
        },
        <span class="hljs-attr">batch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">block</span>) </span>{
          ambClient.batch(block);
        },
        <span class="hljs-attr">subscribeToEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.subscribeToEvent(event, callback);
        },
        <span class="hljs-attr">unsubscribeFromEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
          ambClient.unsubscribeFromEvent(id);
        },
        <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.isLoggedIn();
        },
        <span class="hljs-attr">getConnectionEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getConnectionEvents();
        },
        <span class="hljs-attr">getEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getConnectionEvents();
        },
        <span class="hljs-attr">loginComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          ambClient.loginComplete();
        }
      };
    })();
  }
})(<span class="hljs-built_in">window</span>.jQuery || <span class="hljs-built_in">window</span>.Zepto);;;
<span class="hljs-comment">/*! RESOURCE: /scripts/app.ng.amb/app.ng.amb.js */</span>
angular.module(<span class="hljs-string">"ng.amb"</span>, [<span class="hljs-string">'sn.common.presence'</span>, <span class="hljs-string">'sn.common.util'</span>])
  .value(<span class="hljs-string">"ambLogLevel"</span>, <span class="hljs-string">'info'</span>)
  .value(<span class="hljs-string">"ambServletURI"</span>, <span class="hljs-string">'/amb'</span>)
  .value(<span class="hljs-string">"cometd"</span>, angular.element.cometd)
  .value(<span class="hljs-string">"ambLoginWindow"</span>, <span class="hljs-string">'true'</span>);;
<span class="hljs-comment">/*! RESOURCE: /scripts/app.ng.amb/service.AMB.js */</span>
angular.module(<span class="hljs-string">"ng.amb"</span>).service(<span class="hljs-string">"amb"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">AMBOverlay, $window, $q, $log, $rootScope, $timeout</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> ambClient = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> _window = $<span class="hljs-built_in">window</span>.self;
  <span class="hljs-keyword">var</span> loginWindow = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> sameScope = <span class="hljs-literal">false</span>;
  ambClient = amb.getClient();
  <span class="hljs-keyword">if</span> (_window.g_ambClient) {
    sameScope = <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">if</span> (sameScope) {
    <span class="hljs-keyword">var</span> serverConnection = ambClient.getServerConnection();
    serverConnection.loginShow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!serverConnection.isLoginWindowEnabled())
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (loginWindow &amp;&amp; loginWindow.isVisible())
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (serverConnection.isLoginWindowOverride())
        <span class="hljs-keyword">return</span>;
      loginWindow = <span class="hljs-keyword">new</span> AMBOverlay();
      loginWindow.render();
      loginWindow.show();
    };
    serverConnection.loginHide = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!loginWindow)
        <span class="hljs-keyword">return</span>;
      loginWindow.hide();
      loginWindow.destroy();
      loginWindow = <span class="hljs-literal">null</span>;
    }
  }
  <span class="hljs-keyword">var</span> connected = $q.defer();
  <span class="hljs-keyword">var</span> connectionInterrupted = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> monitorAMB = <span class="hljs-literal">false</span>;
  $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    monitorAMB = <span class="hljs-literal">true</span>;
  }, <span class="hljs-number">5</span> * <span class="hljs-number">1000</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ambInterrupted</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> state = ambClient.getState();
    <span class="hljs-keyword">return</span> monitorAMB &amp;&amp; state !== <span class="hljs-string">"opened"</span> &amp;&amp; state !== <span class="hljs-string">"initialized"</span>
  }
  <span class="hljs-keyword">var</span> interruptionTimeout;
  <span class="hljs-keyword">var</span> extendedInterruption = <span class="hljs-literal">false</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setInterrupted</span>(<span class="hljs-params">eventName</span>) </span>{
    connectionInterrupted = <span class="hljs-literal">true</span>;
    $rootScope.$broadcast(eventName);
    <span class="hljs-keyword">if</span> (!interruptionTimeout) {
      interruptionTimeout = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        extendedInterruption = <span class="hljs-literal">true</span>;
      }, <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>)
    }
    connected = $q.defer();
  }
  <span class="hljs-keyword">var</span> connectOpenedEventId = ambClient.subscribeToEvent(<span class="hljs-string">"connection.opened"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    $rootScope.$broadcast(<span class="hljs-string">"amb.connection.opened"</span>);
    <span class="hljs-keyword">if</span> (interruptionTimeout) {
      $timeout.cancel(interruptionTimeout);
      interruptionTimeout = <span class="hljs-literal">null</span>;
    }
    extendedInterruption = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (connectionInterrupted) {
      connectionInterrupted = <span class="hljs-literal">false</span>;
      $rootScope.$broadcast(<span class="hljs-string">"amb.connection.recovered"</span>);
    }
    connected.resolve();
  });
  <span class="hljs-keyword">var</span> connectClosedEventId = ambClient.subscribeToEvent(<span class="hljs-string">"connection.closed"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    setInterrupted(<span class="hljs-string">"amb.connection.closed"</span>);
  });
  <span class="hljs-keyword">var</span> connectBrokenEventId = ambClient.subscribeToEvent(<span class="hljs-string">"connection.broken"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    setInterrupted(<span class="hljs-string">"amb.connection.broken"</span>);
  });
  jQuery(<span class="hljs-built_in">window</span>).unload(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fixMemoryLeakInGlobalAMBEventManager</span>(<span class="hljs-params">event</span>) </span>{
    ambClient.unsubscribeFromEvent(connectOpenedEventId);
    ambClient.unsubscribeFromEvent(connectClosedEventId);
    ambClient.unsubscribeFromEvent(connectBrokenEventId);
    jQuery(<span class="hljs-keyword">this</span>).unbind(event);
  });
  ambClient.connect();
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">getServerConnection</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getServerConnection();
    },
    <span class="hljs-attr">connect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      ambClient.connect();
      <span class="hljs-keyword">return</span> connected.promise;
    },
    get interrupted() {
      <span class="hljs-keyword">return</span> ambInterrupted();
    },
    get extendedInterruption() {
      <span class="hljs-keyword">return</span> extendedInterruption;
    },
    get connected() {
      <span class="hljs-keyword">return</span> connected.promise;
    },
    <span class="hljs-attr">abort</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      ambClient.abort();
    },
    <span class="hljs-attr">disconnect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      ambClient.disconnect();
    },
    <span class="hljs-attr">getConnectionState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getConnectionState();
    },
    <span class="hljs-attr">getClientId</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getClientId();
    },
    <span class="hljs-attr">getChannel</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channelName</span>) </span>{
      <span class="hljs-keyword">var</span> channel = ambClient.getChannel0(channelName);
      <span class="hljs-keyword">var</span> originalSubscribe = channel.subscribe;
      <span class="hljs-keyword">var</span> originalUnsubscribe = channel.unsubscribe;
      channel.subscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">listener</span>) </span>{
        originalSubscribe.call(channel, listener);
        jQuery(<span class="hljs-built_in">window</span>).unload(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          originalUnsubscribe.call(channel);
        });
        <span class="hljs-keyword">return</span> channel;
      };
      <span class="hljs-keyword">return</span> channel;
    },
    <span class="hljs-attr">registerExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName, extension</span>) </span>{
      ambClient.registerExtension(extensionName, extension);
    },
    <span class="hljs-attr">unregisterExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName</span>) </span>{
      ambClient.unregisterExtension(extensionName);
    },
    <span class="hljs-attr">batch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">batch</span>) </span>{
      ambClient.batch(batch);
    },
    <span class="hljs-attr">getState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getState();
    },
    <span class="hljs-attr">getFilterString</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filter</span>) </span>{
      filter = filter.
      replace(<span class="hljs-regexp">/\^EQ/g</span>, <span class="hljs-string">''</span>).
      replace(<span class="hljs-regexp">/\^ORDERBY(?:DESC)?[^^]*/g</span>, <span class="hljs-string">''</span>).
      replace(<span class="hljs-regexp">/^GOTO/</span>, <span class="hljs-string">''</span>);
      <span class="hljs-keyword">return</span> btoa(filter).replace(<span class="hljs-regexp">/=/g</span>, <span class="hljs-string">'-'</span>);
    },
    <span class="hljs-attr">getChannelRW</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">table, filter</span>) </span>{
      <span class="hljs-keyword">var</span> t = <span class="hljs-string">'/rw/default/'</span> + table + <span class="hljs-string">'/'</span> + <span class="hljs-keyword">this</span>.getFilterString(filter);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getChannel(t);
    },
    <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.isLoggedIn();
    },
    <span class="hljs-attr">subscribeToEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
      ambClient.subscribeToEvent(event, callback);
    },
    <span class="hljs-attr">getConnectionEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getConnectionEvents();
    },
    <span class="hljs-attr">getEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getConnectionEvents();
    },
    <span class="hljs-attr">loginComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      ambClient.loginComplete();
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/app.ng.amb/controller.AMBRecordWatcher.js */</span>
angular.module(<span class="hljs-string">"ng.amb"</span>).controller(<span class="hljs-string">"AMBRecordWatcher"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $timeout, $window</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> amb = $<span class="hljs-built_in">window</span>.top.g_ambClient;
  $scope.messages = [];
  <span class="hljs-keyword">var</span> lastFilter;
  <span class="hljs-keyword">var</span> watcherChannel;
  <span class="hljs-keyword">var</span> watcher;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onMessage</span>(<span class="hljs-params">message</span>) </span>{
    $scope.messages.push(message.data);
  }
  $scope.getState = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> amb.getState();
  };
  $scope.initWatcher = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    angular.element(<span class="hljs-string">":focus"</span>).blur();
    <span class="hljs-keyword">if</span> (!$scope.filter || $scope.filter === lastFilter)
      <span class="hljs-keyword">return</span>;
    lastFilter = $scope.filter;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"initiating watcher on "</span> + $scope.filter);
    $scope.messages = [];
    <span class="hljs-keyword">if</span> (watcher) {
      watcher.unsubscribe();
    }
    <span class="hljs-keyword">var</span> base64EncodeQuery = btoa($scope.filter).replace(<span class="hljs-regexp">/=/g</span>, <span class="hljs-string">'-'</span>);
    <span class="hljs-keyword">var</span> channelId = <span class="hljs-string">'/rw/'</span> + base64EncodeQuery;
    watcherChannel = amb.getChannel(channelId)
    watcher = watcherChannel.subscribe(onMessage);
  };
  amb.connect();
});
<span class="hljs-comment">/*! RESOURCE: /scripts/app.ng.amb/factory.snRecordWatcher.js */</span>
angular.module(<span class="hljs-string">"ng.amb"</span>).factory(<span class="hljs-string">'snRecordWatcher'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$rootScope, amb, $timeout, snPresence, $log, urlTools</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> watcherChannel;
  <span class="hljs-keyword">var</span> connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> diagnosticLog = <span class="hljs-literal">true</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initWatcher</span>(<span class="hljs-params">table, sys_id, query</span>) </span>{
    <span class="hljs-keyword">if</span> (!table)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (sys_id)
      <span class="hljs-keyword">var</span> filter = <span class="hljs-string">"sys_id="</span> + sys_id;
    <span class="hljs-keyword">else</span>
      filter = query;
    <span class="hljs-keyword">if</span> (!filter)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">return</span> initChannel(table, filter);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initList</span>(<span class="hljs-params">table, query</span>) </span>{
    <span class="hljs-keyword">if</span> (!table)
      <span class="hljs-keyword">return</span>;
    query = query || <span class="hljs-string">"sys_idISNOTEMPTY"</span>;
    <span class="hljs-keyword">return</span> initChannel(table, query);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initTaskList</span>(<span class="hljs-params">list, prevChannel</span>) </span>{
    <span class="hljs-keyword">if</span> (prevChannel)
      prevChannel.unsubscribe();
    <span class="hljs-keyword">var</span> sys_ids = list.toString();
    <span class="hljs-keyword">var</span> filter = <span class="hljs-string">"sys_idIN"</span> + sys_ids;
    <span class="hljs-keyword">return</span> initChannel(<span class="hljs-string">"task"</span>, filter);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initChannel</span>(<span class="hljs-params">table, filter</span>) </span>{
    <span class="hljs-keyword">if</span> (isBlockedTable(table)) {
      $log.log(<span class="hljs-string">"Blocked from watching"</span>, table);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">if</span> (diagnosticLog)
      log(<span class="hljs-string">"&gt;&gt;&gt; init "</span> + table + <span class="hljs-string">"?"</span> + filter);
    watcherChannel = amb.getChannelRW(table, filter);
    watcherChannel.subscribe(onMessage);
    amb.connect();
    <span class="hljs-keyword">return</span> watcherChannel;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onMessage</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">var</span> r = message.data;
    <span class="hljs-keyword">var</span> c = message.channel;
    <span class="hljs-keyword">if</span> (diagnosticLog)
      log(<span class="hljs-string">"&gt;&gt;&gt; record "</span> + r.operation + <span class="hljs-string">": "</span> + r.table_name + <span class="hljs-string">"."</span> + r.sys_id + <span class="hljs-string">" "</span> + r.display_value);
    $rootScope.$broadcast(<span class="hljs-string">'record.updated'</span>, r);
    $rootScope.$broadcast(<span class="hljs-string">"sn.stream.tap"</span>);
    $rootScope.$broadcast(<span class="hljs-string">'list.updated'</span>, r, c);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params">message</span>) </span>{
    $log.log(message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isBlockedTable</span>(<span class="hljs-params">table</span>) </span>{
    <span class="hljs-keyword">return</span> table == <span class="hljs-string">'sys_amb_message'</span> || table.startsWith(<span class="hljs-string">'sys_rw'</span>);
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">initTaskList</span>: initTaskList,
    <span class="hljs-attr">initChannel</span>: initChannel,
    <span class="hljs-attr">init</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> location = urlTools.parseQueryString(<span class="hljs-built_in">window</span>.location.search);
      <span class="hljs-keyword">var</span> table = location[<span class="hljs-string">'table'</span>] || location[<span class="hljs-string">'sysparm_table'</span>];
      <span class="hljs-keyword">var</span> sys_id = location[<span class="hljs-string">'sys_id'</span>] || location[<span class="hljs-string">'sysparm_sys_id'</span>];
      <span class="hljs-keyword">var</span> query = location[<span class="hljs-string">'sysparm_query'</span>];
      initWatcher(table, sys_id, query);
      snPresence.init(table, sys_id, query);
    },
    <span class="hljs-attr">initList</span>: initList,
    <span class="hljs-attr">initRecord</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">table, sysId</span>) </span>{
      initWatcher(table, sysId, <span class="hljs-literal">null</span>);
      snPresence.initWithDocument(table, sysId);
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/app.ng.amb/factory.AMBOverlay.js */</span>
angular.module(<span class="hljs-string">"ng.amb"</span>).factory(<span class="hljs-string">"AMBOverlay"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$templateCache, $compile, $rootScope</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> showCallbacks = [],
    hideCallbacks = [],
    isRendered = <span class="hljs-literal">false</span>,
    modal,
    modalScope,
    modalOptions;
  <span class="hljs-keyword">var</span> defaults = {
    <span class="hljs-attr">backdrop</span>: <span class="hljs-string">'static'</span>,
    <span class="hljs-attr">keyboard</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AMBOverlay</span>(<span class="hljs-params">config</span>) </span>{
    config = config || {};
    <span class="hljs-keyword">if</span> (angular.isFunction(config.onShow))
      showCallbacks.push(config.onShow);
    <span class="hljs-keyword">if</span> (angular.isFunction(config.onHide))
      hideCallbacks.push(config.onHide);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lazyRender</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!angular.element(<span class="hljs-string">'html'</span>)[<span class="hljs-string">'modal'</span>]) {
        <span class="hljs-keyword">var</span> bootstrapInclude = <span class="hljs-string">"/scripts/bootstrap3/bootstrap.js"</span>;
        ScriptLoader.getScripts([bootstrapInclude], renderModal);
      } <span class="hljs-keyword">else</span>
        renderModal();
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderModal</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (isRendered)
        <span class="hljs-keyword">return</span>;
      modalScope = angular.extend($rootScope.$<span class="hljs-keyword">new</span>(), config);
      modal = $compile($templateCache.get(<span class="hljs-string">"amb_disconnect_modal.xml"</span>))(modalScope);
      angular.element(<span class="hljs-string">"body"</span>).append(modal);
      modal.on(<span class="hljs-string">"shown.bs.modal"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = showCallbacks.length; i &lt; len; i++)
          showCallbacks[i](e);
      });
      modal.on(<span class="hljs-string">"hidden.bs.modal"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = hideCallbacks.length; i &lt; len; i++)
          hideCallbacks[i](e);
      });
      modalOptions = angular.extend({}, defaults, config);
      modal.modal(modalOptions);
      isRendered = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showModal</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (isRendered)
        modal.modal(<span class="hljs-string">'show'</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hideModal</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (isRendered)
        modal.modal(<span class="hljs-string">'hide'</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroyModal</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!isRendered)
        <span class="hljs-keyword">return</span>;
      modal.modal(<span class="hljs-string">'hide'</span>);
      modal.remove();
      modalScope.$destroy();
      modalScope = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
      isRendered = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">var</span> pos = showCallbacks.indexOf(config.onShow);
      <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span>)
        showCallbacks.splice(pos, <span class="hljs-number">1</span>);
      pos = hideCallbacks.indexOf(config.onShow);
      <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span>)
        hideCallbacks.splice(pos, <span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">render</span>: lazyRender,
      <span class="hljs-attr">destroy</span>: destroyModal,
      <span class="hljs-attr">show</span>: showModal,
      <span class="hljs-attr">hide</span>: hideModal,
      <span class="hljs-attr">isVisible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!isRendered)
          <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> modal.visible();
      }
    }
  }
  $templateCache.put(<span class="hljs-string">'amb_disconnect_modal.xml'</span>,
    <span class="hljs-string">'&lt;div id="amb_disconnect_modal" tabindex="-1" aria-hidden="true" class="modal" role="dialog"&gt;'</span> +
    <span class="hljs-string">'	&lt;div class="modal-dialog small-modal" style="width:450px"&gt;'</span> +
    <span class="hljs-string">'		&lt;div class="modal-content"&gt;'</span> +
    <span class="hljs-string">'			&lt;header class="modal-header"&gt;'</span> +
    <span class="hljs-string">'				&lt;h4 id="small_modal1_title" class="modal-title"&gt;{{title || "Login"}}&lt;/h4&gt;'</span> +
    <span class="hljs-string">'			&lt;/header&gt;'</span> +
    <span class="hljs-string">'			&lt;div class="modal-body"&gt;'</span> +
    <span class="hljs-string">'			&lt;iframe class="concourse_modal" ng-src=\'{{iframe || "/amb_login.do"}}\' frameborder="0" scrolling="no" height="400px" width="405px"&gt;&lt;/iframe&gt;'</span> +
    <span class="hljs-string">'			&lt;/div&gt;'</span> +
    <span class="hljs-string">'		&lt;/div&gt;'</span> +
    <span class="hljs-string">'	&lt;/div&gt;'</span> +
    <span class="hljs-string">'&lt;/div&gt;'</span>
  );
  <span class="hljs-keyword">return</span> AMBOverlay;
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.presence'</span>, [<span class="hljs-string">'ng.amb'</span>, <span class="hljs-string">'sn.common.glide'</span>]).config(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$provide</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  $provide.constant(<span class="hljs-string">"PRESENCE_DISABLED"</span>, <span class="hljs-string">"false"</span> === <span class="hljs-string">"true"</span>);
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/factory.snPresence.js */</span>
angular.module(<span class="hljs-string">"sn.common.presence"</span>).factory(<span class="hljs-string">'snPresence'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$rootScope, $window, $log, amb, $timeout, $http, snRecordPresence, snTabActivity, urlTools, PRESENCE_DISABLED</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> REST = {
    <span class="hljs-attr">PRESENCE</span>: <span class="hljs-string">"/api/now/ui/presence"</span>
  };
  <span class="hljs-keyword">var</span> databaseInterval = ($<span class="hljs-built_in">window</span>.NOW.presence_interval || <span class="hljs-number">15</span>) * <span class="hljs-number">1000</span>;
  <span class="hljs-keyword">var</span> initialized = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> primary = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> presenceArray = [];
  <span class="hljs-keyword">var</span> serverTimeMillis;
  <span class="hljs-keyword">var</span> skew = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> st = <span class="hljs-number">0</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> location = urlTools.parseQueryString(<span class="hljs-built_in">window</span>.location.search);
    <span class="hljs-keyword">var</span> table = location[<span class="hljs-string">'table'</span>] || location[<span class="hljs-string">'sysparm_table'</span>];
    <span class="hljs-keyword">var</span> sys_id = location[<span class="hljs-string">'sys_id'</span>] || location[<span class="hljs-string">'sysparm_sys_id'</span>];
    <span class="hljs-keyword">var</span> query = location[<span class="hljs-string">'sysparm_query'</span>];
    initPresence(table, sys_id, query);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initPresence</span>(<span class="hljs-params">t, id</span>) </span>{
    <span class="hljs-keyword">if</span> (PRESENCE_DISABLED)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (!initialized) {
      initialized = <span class="hljs-literal">true</span>;
      initRootScopes();
      <span class="hljs-keyword">if</span> (!primary) {
        CustomEvent.observe(<span class="hljs-string">'sn.presence'</span>, onPresenceEvent);
        CustomEvent.fireTop(<span class="hljs-string">'sn.presence.ping'</span>);
      } <span class="hljs-keyword">else</span> {
        presenceArray = getLocalPresence();
        <span class="hljs-keyword">if</span> (presenceArray)
          $timeout(schedulePresence, <span class="hljs-number">100</span>);
        <span class="hljs-keyword">else</span>
          updateDatabase();
      }
    }
    snRecordPresence.initPresence(t, id);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onPresenceEvent</span>(<span class="hljs-params">parms</span>) </span>{
    presenceArray = parms;
    $timeout(broadcastPresence);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initRootScopes</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> ($<span class="hljs-built_in">window</span>.NOW.presence_scopes) {
      <span class="hljs-keyword">var</span> ps = $<span class="hljs-built_in">window</span>.NOW.presence_scopes;
      <span class="hljs-keyword">if</span> (ps.indexOf($rootScope) == <span class="hljs-number">-1</span>)
        ps.push($rootScope);
    } <span class="hljs-keyword">else</span> {
      $<span class="hljs-built_in">window</span>.NOW.presence_scopes = [$rootScope];
      primary = CustomEvent.isTopWindow();
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateDatabase</span>(<span class="hljs-params"></span>) </span>{
    presenceArray = getLocalPresence();
    <span class="hljs-keyword">if</span> (presenceArray) {
      determineStatus();
      $timeout(schedulePresence);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!amb.isLoggedIn() || !snTabActivity.isPrimary) {
      $timeout(schedulePresence);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> p = {
      <span class="hljs-attr">user_agent</span>: navigator.userAgent,
      <span class="hljs-attr">ua_time</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      <span class="hljs-attr">href</span>: <span class="hljs-built_in">window</span>.location.href,
      <span class="hljs-attr">pathname</span>: <span class="hljs-built_in">window</span>.location.pathname,
      <span class="hljs-attr">search</span>: <span class="hljs-built_in">window</span>.location.search,
      <span class="hljs-attr">path</span>: <span class="hljs-built_in">window</span>.location.pathname + <span class="hljs-built_in">window</span>.location.search
    };
    st = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    $http.post(REST.PRESENCE + <span class="hljs-string">'?sysparm_auto_request=true&amp;cd='</span> + st, p).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
      <span class="hljs-keyword">var</span> rt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - st;
      <span class="hljs-keyword">if</span> (rt &gt; <span class="hljs-number">500</span>)
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"snPresence response time "</span> + rt + <span class="hljs-string">"ms"</span>);
      <span class="hljs-keyword">if</span> (data.result &amp;&amp; data.result.presenceArray) {
        presenceArray = data.result.presenceArray;
        setLocalPresence(presenceArray);
        serverTimeMillis = data.result.serverTimeMillis;
        skew = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - serverTimeMillis;
        <span class="hljs-keyword">var</span> t = <span class="hljs-built_in">Math</span>.floor(skew / <span class="hljs-number">1000</span>);
        <span class="hljs-keyword">if</span> (t &lt; <span class="hljs-number">-15</span>)
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"&gt;&gt;&gt;&gt;&gt; server ahead "</span> + <span class="hljs-built_in">Math</span>.abs(t) + <span class="hljs-string">" seconds"</span>);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (t &gt; <span class="hljs-number">15</span>)
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"&gt;&gt;&gt;&gt;&gt; browser time ahead "</span> + t + <span class="hljs-string">" seconds"</span>);
      }
      schedulePresence();
    }).error(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response, status</span>) </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"snPresence "</span> + status);
      <span class="hljs-keyword">if</span> (<span class="hljs-number">429</span> == status)
        $timeout(updateDatabase, databaseInterval);
      <span class="hljs-keyword">else</span>
        schedulePresence();
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schedulePresence</span>(<span class="hljs-params"></span>) </span>{
    $timeout(updateDatabase, databaseInterval);
    determineStatus();
    broadcastPresence();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">broadcastPresence</span>(<span class="hljs-params"></span>) </span>{
    $rootScope.$broadcast(<span class="hljs-string">"sn.presence"</span>, presenceArray);
    <span class="hljs-keyword">if</span> (!primary)
      <span class="hljs-keyword">return</span>;
    CustomEvent.fireAll(<span class="hljs-string">'sn.presence'</span>, presenceArray);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">determineStatus</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!presenceArray || !presenceArray.forEach)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    t -= skew;
    presenceArray.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>) </span>{
      <span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span> + p.last_on;
      <span class="hljs-keyword">var</span> y = t - x;
      p.status = <span class="hljs-string">"online"</span>;
      <span class="hljs-keyword">if</span> (y &gt; (<span class="hljs-number">5</span> * databaseInterval))
        p.status = <span class="hljs-string">"offline"</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (y &gt; (<span class="hljs-number">3</span> * databaseInterval))
        p.status = <span class="hljs-string">"probably offline"</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (y &gt; (<span class="hljs-number">2.5</span> * databaseInterval))
        p.status = <span class="hljs-string">"maybe offline"</span>;
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setLocalPresence</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">var</span> p = {
      <span class="hljs-attr">saved</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),
      <span class="hljs-attr">presenceArray</span>: value
    }
    $<span class="hljs-built_in">window</span>.localStorage.setItem(<span class="hljs-string">'snPresence'</span>, angular.toJson(p));
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLocalPresence</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> p = $<span class="hljs-built_in">window</span>.localStorage.getItem(<span class="hljs-string">'snPresence'</span>);
    <span class="hljs-keyword">if</span> (!p)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
      p = angular.fromJson(p);
    } <span class="hljs-keyword">catch</span> (e) {
      p = {};
    }
    <span class="hljs-keyword">if</span> (!p.presenceArray)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    <span class="hljs-keyword">if</span> (now - p.saved &gt;= databaseInterval)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">return</span> p.presenceArray;
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">init</span>: init,
    <span class="hljs-attr">initWithDocument</span>: initPresence,
    <span class="hljs-attr">initPresence</span>: initPresence
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/factory.snRecordPresence.js */</span>
angular.module(<span class="hljs-string">"sn.common.presence"</span>).factory(<span class="hljs-string">'snRecordPresence'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$rootScope, $location, amb, $timeout, $window, PRESENCE_DISABLED, snTabActivity</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> statChannel;
  <span class="hljs-keyword">var</span> interval = ($<span class="hljs-built_in">window</span>.NOW.record_presence_interval || <span class="hljs-number">20</span>) * <span class="hljs-number">1000</span>;
  <span class="hljs-keyword">var</span> sessions = {};
  <span class="hljs-keyword">var</span> primary = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> table;
  <span class="hljs-keyword">var</span> sys_id;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initPresence</span>(<span class="hljs-params">t, id</span>) </span>{
    <span class="hljs-keyword">if</span> (PRESENCE_DISABLED)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (!t || !id)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (t == table &amp;&amp; id == sys_id)
      <span class="hljs-keyword">return</span>;
    initRootScopes();
    <span class="hljs-keyword">if</span> (!primary)
      <span class="hljs-keyword">return</span>;
    termPresence();
    table = t;
    sys_id = id;
    <span class="hljs-keyword">var</span> recordPresence = <span class="hljs-string">"/sn/rp/"</span> + table + <span class="hljs-string">"/"</span> + sys_id;
    $rootScope.me = NOW.session_id;
    statChannel = amb.getChannel(recordPresence);
    statChannel.subscribe(onStatus);
    amb.connected.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      setStatus(<span class="hljs-string">"entered"</span>);
      $rootScope.status = <span class="hljs-string">"viewing"</span>;
    });
    <span class="hljs-keyword">return</span> statChannel;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initRootScopes</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> ($<span class="hljs-built_in">window</span>.NOW.record_presence_scopes) {
      <span class="hljs-keyword">var</span> ps = $<span class="hljs-built_in">window</span>.NOW.record_presence_scopes;
      <span class="hljs-keyword">if</span> (ps.indexOf($rootScope) == <span class="hljs-number">-1</span>) {
        ps.push($rootScope);
        CustomEvent.observe(<span class="hljs-string">'sn.sessions'</span>, onPresenceEvent);
      }
    } <span class="hljs-keyword">else</span> {
      $<span class="hljs-built_in">window</span>.NOW.record_presence_scopes = [$rootScope];
      primary = <span class="hljs-literal">true</span>;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onPresenceEvent</span>(<span class="hljs-params">sessionsToSend</span>) </span>{
    $rootScope.$broadcast(<span class="hljs-string">"sn.sessions"</span>, sessionsToSend);
    $rootScope.$broadcast(<span class="hljs-string">"sp.sessions"</span>, sessionsToSend);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">termPresence</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!statChannel)
      <span class="hljs-keyword">return</span>;
    statChannel.unsubscribe();
    statChannel = table = sys_id = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setStatus</span>(<span class="hljs-params">status</span>) </span>{
    <span class="hljs-keyword">if</span> (status == $rootScope.status)
      <span class="hljs-keyword">return</span>;
    $rootScope.status = status;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(sessions).length == <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (getStatusPrecedence(status) &gt; <span class="hljs-number">1</span>)
      <span class="hljs-keyword">return</span>;
    publish($rootScope.status);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">publish</span>(<span class="hljs-params">status</span>) </span>{
    <span class="hljs-keyword">if</span> (!statChannel)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (amb.getState() !== <span class="hljs-string">"opened"</span>)
      <span class="hljs-keyword">return</span>;
    statChannel.publish({
      <span class="hljs-attr">presences</span>: [{
        <span class="hljs-attr">status</span>: status,
        <span class="hljs-attr">session_id</span>: NOW.session_id,
        <span class="hljs-attr">user_name</span>: NOW.user_name,
        <span class="hljs-attr">user_id</span>: NOW.user_id,
        <span class="hljs-attr">user_display_name</span>: NOW.user_display_name,
        <span class="hljs-attr">user_initials</span>: NOW.user_initials,
        <span class="hljs-attr">user_avatar</span>: NOW.user_avatar,
        <span class="hljs-attr">ua</span>: navigator.userAgent,
        <span class="hljs-attr">table</span>: table,
        <span class="hljs-attr">sys_id</span>: sys_id,
        <span class="hljs-attr">time</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toString().substring(<span class="hljs-number">0</span>, <span class="hljs-number">24</span>)
      }]
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onStatus</span>(<span class="hljs-params">message</span>) </span>{
    message.data.presences.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d</span>) </span>{
      <span class="hljs-keyword">if</span> (!d.session_id || d.session_id == NOW.session_id)
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">var</span> s = sessions[d.session_id];
      <span class="hljs-keyword">if</span> (s)
        angular.extend(s, d);
      <span class="hljs-keyword">else</span>
        s = sessions[d.session_id] = d;
      s.lastUpdated = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      <span class="hljs-keyword">if</span> (s.status == <span class="hljs-string">'exited'</span>)
        <span class="hljs-keyword">delete</span> sessions[d.session_id];
    });
    broadcastSessions();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">broadcastSessions</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> sessionsToSend = getUniqueSessions();
    $rootScope.$broadcast(<span class="hljs-string">"sn.sessions"</span>, sessionsToSend);
    $rootScope.$broadcast(<span class="hljs-string">"sp.sessions"</span>, sessionsToSend);
    <span class="hljs-keyword">if</span> (primary)
      $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        CustomEvent.fire(<span class="hljs-string">'sn.sessions'</span>, sessionsToSend);
      })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUniqueSessions</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> uniqueSessionsByUser = {};
    <span class="hljs-keyword">var</span> sessionKeys = <span class="hljs-built_in">Object</span>.keys(sessions);
    sessionKeys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>) </span>{
      <span class="hljs-keyword">var</span> session = sessions[key];
      <span class="hljs-keyword">if</span> (session.user_id == NOW.user_id)
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (session.user_id <span class="hljs-keyword">in</span> uniqueSessionsByUser) {
        <span class="hljs-keyword">var</span> otherSession = uniqueSessionsByUser[session.user_id];
        <span class="hljs-keyword">var</span> thisPrecedence = getStatusPrecedence(session.status);
        <span class="hljs-keyword">var</span> otherPrecedence = getStatusPrecedence(otherSession.status);
        uniqueSessionsByUser[session.user_id] = thisPrecedence &lt; otherPrecedence ? session : otherSession;
        <span class="hljs-keyword">return</span>
      }
      uniqueSessionsByUser[session.user_id] = session;
    });
    <span class="hljs-keyword">var</span> uniqueSessions = {};
    angular.forEach(uniqueSessionsByUser, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
      uniqueSessions[item.session_id] = item;
    });
    <span class="hljs-keyword">return</span> uniqueSessions;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStatusPrecedence</span>(<span class="hljs-params">status</span>) </span>{
    <span class="hljs-keyword">switch</span> (status) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'typing'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'viewing'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'entered'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'exited'</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">'probably left'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'offline'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;
    }
  }
  $rootScope.$on(<span class="hljs-string">"record.typing"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt, data</span>) </span>{
    setStatus(data.status);
  });
  <span class="hljs-keyword">var</span> idleTable, idleSysID;
  snTabActivity.onIdle({
    <span class="hljs-attr">onIdle</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RecordPresenceTabIdle</span>(<span class="hljs-params"></span>) </span>{
      idleTable = table;
      idleSysID = sys_id;
      sessions = {};
      termPresence();
      broadcastSessions();
    },
    <span class="hljs-attr">onReturn</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RecordPresenceTabActive</span>(<span class="hljs-params"></span>) </span>{
      initPresence(idleTable, idleSysID, <span class="hljs-literal">true</span>);
      idleTable = idleSysID = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
    },
    <span class="hljs-attr">delay</span>: interval * <span class="hljs-number">4</span>
  });
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">initPresence</span>: initPresence,
    <span class="hljs-attr">termPresence</span>: termPresence
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/directive.snPresence.js */</span>
angular.module(<span class="hljs-string">'sn.common.presence'</span>).directive(<span class="hljs-string">'snPresence'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">snPresence, $rootScope, $timeout</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  $timeout(snPresence.init, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">var</span> presences = {};
  $rootScope.$on(<span class="hljs-string">'sn.presence'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, presenceArray</span>) </span>{
    <span class="hljs-keyword">if</span> (!presenceArray) {
      angular.forEach(presences, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>) </span>{
        p.status = <span class="hljs-string">"offline"</span>;
      });
      <span class="hljs-keyword">return</span>;
    }
    presenceArray.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">presence</span>) </span>{
      presences[presence.user] = presence;
    });
  });
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'EA'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">snPresence</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">user</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">profile</span>: <span class="hljs-string">'=?'</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
      <span class="hljs-keyword">if</span> (scope.profile)
        scope.user = scope.profile.userID;
      <span class="hljs-keyword">if</span> (!element.hasClass(<span class="hljs-string">'presence'</span>))
        element.addClass(<span class="hljs-string">'presence'</span>);

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updatePresence</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> id = scope.snPresence || scope.user;
        <span class="hljs-keyword">if</span> (presences[id]) {
          <span class="hljs-keyword">var</span> status = presences[id].status;
          <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'maybe offline'</span> || status === <span class="hljs-string">'probably offline'</span>) {
            element.removeClass(<span class="hljs-string">'presence-online presence-offline presence-away'</span>);
            element.addClass(<span class="hljs-string">'presence-away'</span>);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">"offline"</span> &amp;&amp; !element.hasClass(<span class="hljs-string">'presence-offline'</span>)) {
            element.removeClass(<span class="hljs-string">'presence-online presence-away'</span>);
            element.addClass(<span class="hljs-string">'presence-offline'</span>);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((status == <span class="hljs-string">"online"</span> || status == <span class="hljs-string">"entered"</span> || status == <span class="hljs-string">"viewing"</span>) &amp;&amp; !element.hasClass(<span class="hljs-string">'presence-online'</span>)) {
            element.removeClass(<span class="hljs-string">'presence-offline presence-away'</span>);
            element.addClass(<span class="hljs-string">'presence-online'</span>);
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (!element.hasClass(<span class="hljs-string">'presence-offline'</span>))
            element.addClass(<span class="hljs-string">'presence-offline'</span>);
        }
      }
      $rootScope.$on(<span class="hljs-string">'sn.presence'</span>, updatePresence);
      updatePresence();
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/directive.snComposing.js */</span>
angular.module(<span class="hljs-string">'sn.common.presence'</span>).directive(<span class="hljs-string">'snComposing'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, snComposingPresence</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">"snComposing.xml"</span>),
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">conversation</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $element</span>) </span>{
      <span class="hljs-keyword">var</span> child = $element.children();
      <span class="hljs-keyword">if</span> (child &amp;&amp; child.tooltip)
        child.tooltip({
          <span class="hljs-string">'template'</span>: <span class="hljs-string">'&lt;div class="tooltip" style="white-space: pre-wrap" role="tooltip"&gt;&lt;div class="tooltip-arrow"&gt;&lt;/div&gt;&lt;div class="tooltip-inner"&gt;&lt;/div&gt;&lt;/div&gt;'</span>,
          <span class="hljs-string">'placement'</span>: <span class="hljs-string">'top'</span>,
          <span class="hljs-string">'container'</span>: <span class="hljs-string">'body'</span>
        });
      $scope.snComposingPresence = snComposingPresence;
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/service.snComposingPresence.js */</span>
angular.module(<span class="hljs-string">'sn.common.presence'</span>).service(<span class="hljs-string">'snComposingPresence'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i18n</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> viewing = {};
  <span class="hljs-keyword">var</span> typing = {};
  <span class="hljs-keyword">var</span> allStrings = {};
  <span class="hljs-keyword">var</span> shortStrings = {};
  <span class="hljs-keyword">var</span> typing1 = <span class="hljs-string">"{0} is typing"</span>,
    typing2 = <span class="hljs-string">"{0} and {1} are typing"</span>,
    typingMore = <span class="hljs-string">"{0}, {1}, and {2} more are typing"</span>,
    viewing1 = <span class="hljs-string">"{0} is viewing"</span>,
    viewing2 = <span class="hljs-string">"{0} and {1} are viewing"</span>,
    viewingMore = <span class="hljs-string">"{0}, {1}, and {2} more are viewing"</span>;
  i18n.getMessages(
    [
      typing1,
      typing2,
      typingMore,
      viewing1,
      viewing2,
      viewingMore
    ],
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">results</span>) </span>{
      typing1 = results[typing1];
      typing2 = results[typing2];
      typingMore = results[typingMore];
      viewing1 = results[viewing1];
      viewing2 = results[viewing2];
      viewingMore = results[viewingMore];
    });

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span>(<span class="hljs-params">conversationID, newPresenceValues</span>) </span>{
    <span class="hljs-keyword">if</span> (newPresenceValues.viewing)
      viewing[conversationID] = newPresenceValues.viewing;
    <span class="hljs-keyword">if</span> (newPresenceValues.typing)
      typing[conversationID] = newPresenceValues.typing;
    generateAllString(conversationID, {
      <span class="hljs-attr">viewing</span>: viewing[conversationID],
      <span class="hljs-attr">typing</span>: typing[conversationID]
    });
    generateShortString(conversationID, {
      <span class="hljs-attr">viewing</span>: viewing[conversationID],
      <span class="hljs-attr">typing</span>: typing[conversationID]
    });
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">viewing</span>: viewing[conversationID],
      <span class="hljs-attr">typing</span>: typing[conversationID]
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params">conversationID</span>) </span>{
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">viewing</span>: viewing[conversationID] || [],
      <span class="hljs-attr">typing</span>: typing[conversationID] || []
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateAllString</span>(<span class="hljs-params">conversationID, members</span>) </span>{
    <span class="hljs-keyword">var</span> result = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">var</span> typingLength = members.typing.length;
    <span class="hljs-keyword">var</span> viewingLength = members.viewing.length;
    <span class="hljs-keyword">if</span> (typingLength &lt; <span class="hljs-number">4</span> &amp;&amp; viewingLength &lt; <span class="hljs-number">4</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    <span class="hljs-keyword">switch</span> (typingLength) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        result += i18n.format(typing1, members.typing[<span class="hljs-number">0</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        result += i18n.format(typing2, members.typing[<span class="hljs-number">0</span>].name, members.typing[<span class="hljs-number">1</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">var</span> allButLastTyper = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; typingLength; i++) {
          <span class="hljs-keyword">if</span> (i &lt; typingLength - <span class="hljs-number">2</span>)
            allButLastTyper += members.typing[i].name + <span class="hljs-string">", "</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i === typingLength - <span class="hljs-number">2</span>)
            allButLastTyper += members.typing[i].name + <span class="hljs-string">","</span>;
          <span class="hljs-keyword">else</span>
            result += i18n.format(typing2, allButLastTyper, members.typing[i].name);
        }
    }
    <span class="hljs-keyword">if</span> (viewingLength &gt; <span class="hljs-number">0</span> &amp;&amp; typingLength &gt; <span class="hljs-number">0</span>)
      result += <span class="hljs-string">"\n\n"</span>;
    <span class="hljs-keyword">switch</span> (viewingLength) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        result += i18n.format(viewing1, members.viewing[<span class="hljs-number">0</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        result += i18n.format(viewing2, members.viewing[<span class="hljs-number">0</span>].name, members.viewing[<span class="hljs-number">1</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">var</span> allButLastViewer = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; viewingLength; i++) {
          <span class="hljs-keyword">if</span> (i &lt; viewingLength - <span class="hljs-number">2</span>)
            allButLastViewer += members.viewing[i].name + <span class="hljs-string">", "</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i === viewingLength - <span class="hljs-number">2</span>)
            allButLastViewer += members.viewing[i].name + <span class="hljs-string">","</span>;
          <span class="hljs-keyword">else</span>
            result += i18n.format(viewing2, allButLastViewer, members.viewing[i].name);
        }
    }
    allStrings[conversationID] = result;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateShortString</span>(<span class="hljs-params">conversationID, members</span>) </span>{
    <span class="hljs-keyword">var</span> typingLength = members.typing.length;
    <span class="hljs-keyword">var</span> viewingLength = members.viewing.length;
    <span class="hljs-keyword">var</span> typingString = <span class="hljs-string">""</span>,
      viewingString = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">var</span> inBetween = <span class="hljs-string">" "</span>;
    <span class="hljs-keyword">switch</span> (typingLength) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        typingString = i18n.format(typing1, members.typing[<span class="hljs-number">0</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        typingString = i18n.format(typing2, members.typing[<span class="hljs-number">0</span>].name, members.typing[<span class="hljs-number">1</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
        typingString = i18n.format(typing2, members.typing[<span class="hljs-number">0</span>].name + <span class="hljs-string">", "</span> + members.typing[<span class="hljs-number">1</span>].name + <span class="hljs-string">","</span>, members.typing[<span class="hljs-number">2</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        typingString = i18n.format(typingMore, members.typing[<span class="hljs-number">0</span>].name, members.typing[<span class="hljs-number">1</span>].name, (typingLength - <span class="hljs-number">2</span>));
    }
    <span class="hljs-keyword">if</span> (viewingLength &gt; <span class="hljs-number">0</span> &amp;&amp; typingLength &gt; <span class="hljs-number">0</span>)
      inBetween = <span class="hljs-string">". "</span>;
    <span class="hljs-keyword">switch</span> (viewingLength) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        viewingString = i18n.format(viewing1, members.viewing[<span class="hljs-number">0</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        viewingString = i18n.format(viewing2, members.viewing[<span class="hljs-number">0</span>].name, members.viewing[<span class="hljs-number">1</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
        viewingString = i18n.format(viewing2, members.viewing[<span class="hljs-number">0</span>].name + <span class="hljs-string">", "</span> + members.viewing[<span class="hljs-number">1</span>].name + <span class="hljs-string">","</span>, members.viewing[<span class="hljs-number">2</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        viewingString = i18n.format(viewingMore, members.viewing[<span class="hljs-number">0</span>].name, members.viewing[<span class="hljs-number">1</span>].name, (viewingLength - <span class="hljs-number">2</span>));
    }
    shortStrings[conversationID] = typingString + inBetween + viewingString;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAllString</span>(<span class="hljs-params">conversationID</span>) </span>{
    <span class="hljs-keyword">if</span> ((viewing[conversationID] &amp;&amp; viewing[conversationID].length &gt; <span class="hljs-number">3</span>) ||
      (typing[conversationID] &amp;&amp; typing[conversationID].length &gt; <span class="hljs-number">3</span>))
      <span class="hljs-keyword">return</span> allStrings[conversationID];
    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getShortString</span>(<span class="hljs-params">conversationID</span>) </span>{
    <span class="hljs-keyword">return</span> shortStrings[conversationID];
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">remove</span>(<span class="hljs-params">conversationID</span>) </span>{
    <span class="hljs-keyword">delete</span> viewing[conversationID];
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">set</span>: set,
    <span class="hljs-attr">get</span>: get,
    <span class="hljs-attr">generateAllString</span>: generateAllString,
    <span class="hljs-attr">getAllString</span>: getAllString,
    <span class="hljs-attr">generateShortString</span>: generateShortString,
    <span class="hljs-attr">getShortString</span>: getShortString,
    <span class="hljs-attr">remove</span>: remove
  }
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/user_profile/js_includes_user_profile.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/user_profile/_module.js */</span>
angular.module(<span class="hljs-string">"sn.common.user_profile"</span>, [<span class="hljs-string">'sn.common.ui'</span>]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/user_profile/directive.snUserProfile.js */</span>
angular.module(<span class="hljs-string">'sn.common.user_profile'</span>).directive(<span class="hljs-string">'snUserProfile'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, snCustomEvent, $window, avatarProfilePersister, $timeout, $http</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'snUserProfile.xml'</span>),
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">profile</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">showDirectMessagePrompt</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope</span>) </span>{
      scope.showDirectMessagePromptFn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (scope.showDirectMessagePrompt) {
          <span class="hljs-keyword">var</span> activeUserID = $<span class="hljs-built_in">window</span>.NOW.user_id || <span class="hljs-string">""</span>;
          <span class="hljs-keyword">return</span> !(!scope.profile ||
            activeUserID === scope.profile.sysID ||
            (scope.profile.document &amp;&amp; activeUserID === scope.profile.document));
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
      };
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, snConnectService</span>) </span>{
      <span class="hljs-keyword">if</span> ($scope.profile &amp;&amp; $scope.profile.userID &amp;&amp; avatarProfilePersister.getAvatar($scope.profile.userID)) {
        $scope.profile = avatarProfilePersister.getAvatar($scope.profile.userID);
        $scope.$emit(<span class="hljs-string">"sn-user-profile.ready"</span>);
      } <span class="hljs-keyword">else</span> {
        $http.get(<span class="hljs-string">'/api/now/live/profiles/sys_user.'</span> + $scope.profile.userID).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
          angular.merge($scope.profile, response.data.result);
          avatarProfilePersister.setAvatar($scope.profile.userID, $scope.profile);
          $scope.$emit(<span class="hljs-string">"sn-user-profile.ready"</span>);
        })
      }
      $scope.openDirectMessageConversation = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        <span class="hljs-keyword">if</span> (evt.keyCode === <span class="hljs-number">9</span>)
          <span class="hljs-keyword">return</span>;
        $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          snConnectService.openWithProfile($scope.profile);
        }, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);
        angular.element(<span class="hljs-string">'.popover'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          angular.element(<span class="hljs-string">'body'</span>).off(<span class="hljs-string">'click.snUserAvatarPopoverClose'</span>);
          angular.element(<span class="hljs-keyword">this</span>).popover(<span class="hljs-string">'hide'</span>);
        });
      };
    }
  }
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/avatar/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.avatar'</span>, [<span class="hljs-string">'sn.common.presence'</span>, <span class="hljs-string">'sn.common.messaging'</span>, <span class="hljs-string">'sn.common.user_profile'</span>]).config(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$provide</span>) </span>{
  $provide.value(<span class="hljs-string">"liveProfileID"</span>, <span class="hljs-string">''</span>);
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/avatar/directive.snAvatarPopover.js */</span>
angular.module(<span class="hljs-string">'sn.common.avatar'</span>).directive(<span class="hljs-string">'snAvatarPopover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$http, $compile, getTemplateUrl, avatarProfilePersister, $injector</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'sn_avatar_popover.xml'</span>),
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">members</span>: <span class="hljs-string">'='</span>,
      <span class="hljs-attr">primary</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">showPresence</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">enableContextMenu</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">enableTooltip</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">enableBindOnce</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-attr">displayMemberCount</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">groupAvatar</span>: <span class="hljs-string">"@"</span>,
      <span class="hljs-attr">nopopover</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">directconversation</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-attr">conversation</span>: <span class="hljs-string">'='</span>,
      <span class="hljs-attr">primaryNonAssign</span>: <span class="hljs-string">'=?'</span>
    },
    <span class="hljs-attr">compile</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tElement</span>) </span>{
      <span class="hljs-keyword">var</span> template = tElement.html();
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs, controller, transcludeFn</span>) </span>{
        <span class="hljs-keyword">if</span> (scope.directconversation) {
          <span class="hljs-keyword">if</span> (scope.directconversation === <span class="hljs-string">"true"</span>)
            scope.directconversation = <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">else</span>
            scope.directconversation = <span class="hljs-literal">false</span>;
          scope.showdirectconversation = !scope.directconversation;
        } <span class="hljs-keyword">else</span> {
          scope.showdirectconversation = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span> ($injector.has(<span class="hljs-string">'inSupportClient'</span>) &amp;&amp; $injector.get(<span class="hljs-string">'inSupportClient'</span>))
          scope.showdirectconversation = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (scope.primaryNonAssign) {
          scope.primary = angular.extend({}, scope.primary, scope.primaryNonAssign);
          <span class="hljs-keyword">if</span> (scope.users &amp;&amp; scope.users[<span class="hljs-number">0</span>])
            scope.users[<span class="hljs-number">0</span>] = scope.primary;
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recompile</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">if</span> (scope.primaryNonAssign) {
            scope.primary = angular.extend({}, scope.primary, scope.primaryNonAssign);
            <span class="hljs-keyword">if</span> (scope.users &amp;&amp; scope.users[<span class="hljs-number">0</span>])
              scope.users[<span class="hljs-number">0</span>] = scope.primary;
          }
          <span class="hljs-keyword">var</span> newElement = $compile(template, transcludeFn)(scope);
          element.html(newElement);
          <span class="hljs-keyword">if</span> (scope.enableTooltip) {
            element.tooltip({
              <span class="hljs-attr">placement</span>: <span class="hljs-string">'auto top'</span>,
              <span class="hljs-attr">container</span>: <span class="hljs-string">'body'</span>
            }).attr(<span class="hljs-string">'data-original-title'</span>, scope.users[<span class="hljs-number">0</span>].name).tooltip(<span class="hljs-string">'fixTitle'</span>);
            <span class="hljs-keyword">if</span> (element.hideFix)
              element.hideFix();
          }
        }
        <span class="hljs-keyword">if</span> (attrs.enableBindOnce === <span class="hljs-string">'false'</span>) {
          scope.$watch(<span class="hljs-string">'primary'</span>, recompile);
          scope.$watch(<span class="hljs-string">'primaryNonAssign'</span>, recompile);
          scope.$watch(<span class="hljs-string">'members'</span>, recompile);
        }
        <span class="hljs-keyword">if</span> (scope.enableTooltip &amp;&amp; scope.nopopover) {
          <span class="hljs-keyword">var</span> usersWatch = scope.$watch(<span class="hljs-string">'users'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (scope.users &amp;&amp; scope.users.length === <span class="hljs-number">1</span> &amp;&amp; scope.users[<span class="hljs-number">0</span>] &amp;&amp; scope.users[<span class="hljs-number">0</span>].name) {
              element.tooltip({
                <span class="hljs-attr">placement</span>: <span class="hljs-string">'auto top'</span>,
                <span class="hljs-attr">container</span>: <span class="hljs-string">'body'</span>
              }).attr(<span class="hljs-string">'data-original-title'</span>, scope.users[<span class="hljs-number">0</span>].name).tooltip(<span class="hljs-string">'fixTitle'</span>);
              <span class="hljs-keyword">if</span> (element.hideFix)
                element.hideFix();
              usersWatch();
            }
          });
        }
      };
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, liveProfileID, $timeout, $element, $document, snCustomEvent</span>) </span>{
      $scope.randId = <span class="hljs-built_in">Math</span>.random();
      $scope.loadEvent = <span class="hljs-string">'sn-user-profile.ready'</span>;
      $scope.closeEvent = [<span class="hljs-string">'chat:open_conversation'</span>, <span class="hljs-string">'snAvatar.closePopover'</span>, <span class="hljs-string">'body_clicked'</span>];
      $scope.popoverConfig = {
        <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;div class="popover" role="tooltip"&gt;&lt;div class="arrow"&gt;&lt;/div&gt;&lt;div class="popover-content"&gt;&lt;/div&gt;&lt;/div&gt;'</span>
      };
      $scope.displayMemberCount = $scope.displayMemberCount || <span class="hljs-literal">false</span>;
      $scope.liveProfileID = liveProfileID;
      <span class="hljs-keyword">if</span> ($scope.primaryNonAssign) {
        $scope.primary = angular.extend({}, $scope.primary, $scope.primaryNonAssign);
        <span class="hljs-keyword">if</span> ($scope.users &amp;&amp; $scope.users[<span class="hljs-number">0</span>])
          $scope.users[<span class="hljs-number">0</span>] = $scope.primary;
      }
      $scope.$watch(<span class="hljs-string">'members'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newVal, oldVal</span>) </span>{
        <span class="hljs-keyword">if</span> (newVal === oldVal)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> ($scope.members)
          buildAvatar();
      });
      $scope.noPopover = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $scope.popoverCursor = ($scope.nopopover || ($scope.members &amp;&amp; $scope.members.length &gt; <span class="hljs-number">2</span>)) ? <span class="hljs-string">"default"</span> : <span class="hljs-string">"pointer"</span>;
        <span class="hljs-keyword">return</span> ($scope.nopopover || ($scope.members &amp;&amp; $scope.members.length &gt; <span class="hljs-number">2</span>));
      }
      $scope.avatarType = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> result = [];
        <span class="hljs-keyword">if</span> ($scope.groupAvatar || !$scope.users)
          <span class="hljs-keyword">return</span> result;
        <span class="hljs-keyword">if</span> ($scope.users.length &gt; <span class="hljs-number">1</span>)
          result.push(<span class="hljs-string">"group"</span>)
        <span class="hljs-keyword">if</span> ($scope.users.length === <span class="hljs-number">2</span>)
          result.push(<span class="hljs-string">"avatar-duo"</span>)
        <span class="hljs-keyword">if</span> ($scope.users.length === <span class="hljs-number">3</span>)
          result.push(<span class="hljs-string">"avatar-trio"</span>)
        <span class="hljs-keyword">if</span> ($scope.users.length &gt;= <span class="hljs-number">4</span>)
          result.push(<span class="hljs-string">"avatar-quad"</span>)
        <span class="hljs-keyword">return</span> result;
      }
      $scope.getBackgroundStyle = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) </span>{
        <span class="hljs-keyword">var</span> avatar = (user ? user.avatar : <span class="hljs-string">''</span>);
        <span class="hljs-keyword">if</span> ($scope.groupAvatar)
          avatar = $scope.groupAvatar;
        <span class="hljs-keyword">if</span> (avatar &amp;&amp; avatar !== <span class="hljs-string">''</span>)
          <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'background-image'</span>: <span class="hljs-string">'url('</span> + avatar + <span class="hljs-string">')'</span>
          };
        <span class="hljs-keyword">if</span> (user &amp;&amp; user.name)
          <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
      };
      $scope.stopPropCheck = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        $scope.$broadcast(<span class="hljs-string">"snAvatar.closeOtherPopovers"</span>, $scope.randId);
        <span class="hljs-keyword">if</span> (!$scope.nopopover) {
          evt.stopPropagation();
        }
      };
      $scope.$on(<span class="hljs-string">"snAvatar.closeOtherPopovers"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
        <span class="hljs-keyword">if</span> (id !== $scope.randId)
          snCustomEvent.fireTop(<span class="hljs-string">'snAvatar.closePopover'</span>);
      });
      $scope.maxStringWidth = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> paddedWidth = <span class="hljs-built_in">parseInt</span>($scope.avatarWidth * <span class="hljs-number">0.8</span>, <span class="hljs-number">10</span>);
        <span class="hljs-keyword">return</span> $scope.users.length === <span class="hljs-number">1</span> ? paddedWidth : paddedWidth / <span class="hljs-number">2</span>;
      };

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildInitials</span>(<span class="hljs-params">name</span>) </span>{
        <span class="hljs-keyword">if</span> (!name)
          <span class="hljs-keyword">return</span> <span class="hljs-string">"--"</span>;
        <span class="hljs-keyword">var</span> initials = name.split(<span class="hljs-string">" "</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">word</span>) </span>{
          <span class="hljs-keyword">return</span> word.toUpperCase();
        }).filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">word</span>) </span>{
          <span class="hljs-keyword">return</span> word.match(<span class="hljs-regexp">/^[A-Z]/</span>);
        }).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">word</span>) </span>{
          <span class="hljs-keyword">return</span> word.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
        }).join(<span class="hljs-string">""</span>);
        <span class="hljs-keyword">return</span> (initials.length &gt; <span class="hljs-number">3</span>) ?
          initials.substr(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>) :
          initials;
      }
      $scope.avatartooltip = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!$scope.enableTooltip) {
          <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
        }
        <span class="hljs-keyword">if</span> (!$scope.users) {
          <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
        }
        <span class="hljs-keyword">var</span> names = [];
        $scope.users.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) </span>{
          <span class="hljs-keyword">if</span> (!user) {
            <span class="hljs-keyword">return</span>;
          }
          names.push(user.name);
        });
        <span class="hljs-keyword">return</span> names.join(<span class="hljs-string">', '</span>);
      };

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildAvatar</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> $scope.primary === <span class="hljs-string">'string'</span>) {
          $http.get(<span class="hljs-string">'/api/now/live/profiles/sys_user.'</span> + $scope.primary).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
            $scope.users = [{
              <span class="hljs-attr">userID</span>: $scope.primary,
              <span class="hljs-attr">name</span>: response.data.result.name,
              <span class="hljs-attr">initials</span>: buildInitials(response.data.result.name),
              <span class="hljs-attr">avatar</span>: response.data.result.avatar
            }];
          });
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> ($scope.primary) {
          <span class="hljs-keyword">if</span> ($scope.primary.userImage)
            $scope.primary.avatar = $scope.primary.userImage;
          <span class="hljs-keyword">if</span> (!$scope.primary.userID &amp;&amp; $scope.primary.sys_id)
            $scope.primary.userID = $scope.primary.sys_id;
        }
        $scope.isGroup = $scope.conversation &amp;&amp; $scope.conversation.isGroup;
        $scope.users = [$scope.primary];
        <span class="hljs-keyword">if</span> ($scope.primary &amp;&amp; (!$scope.members || $scope.members.length &lt;= <span class="hljs-number">0</span>) &amp;&amp; ($scope.primary.avatar || $scope.primary.initials) &amp;&amp; $scope.isDocument) {
          $scope.users = [$scope.primary];
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($scope.members &amp;&amp; $scope.members.length &gt; <span class="hljs-number">0</span>) {
          $scope.users = buildCompositeAvatar($scope.members);
        }
        $scope.presenceEnabled = $scope.showPresence &amp;&amp; !$scope.isGroup &amp;&amp; $scope.users.length === <span class="hljs-number">1</span>;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildCompositeAvatar</span>(<span class="hljs-params">members</span>) </span>{
        <span class="hljs-keyword">var</span> currentUser = <span class="hljs-built_in">window</span>.NOW.user ? <span class="hljs-built_in">window</span>.NOW.user.userID : <span class="hljs-built_in">window</span>.NOW.user_id;
        <span class="hljs-keyword">var</span> users = angular.isArray(members) ? members.slice() : [members];
        users = users.sort(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
          <span class="hljs-keyword">var</span> aID = a.userID || a.document;
          <span class="hljs-keyword">var</span> bID = b.userID || b.document;
          <span class="hljs-keyword">if</span> (a.table === <span class="hljs-string">"chat_queue_entry"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
          <span class="hljs-keyword">if</span> (aID === currentUser)
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bID === currentUser)
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
          <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        });
        <span class="hljs-keyword">if</span> (users.length === <span class="hljs-number">2</span>)
          users = [users[<span class="hljs-number">0</span>]];
        <span class="hljs-keyword">if</span> (users.length &gt; <span class="hljs-number">2</span> &amp;&amp; $scope.primary &amp;&amp; $scope.primary.name &amp;&amp; $scope.primary.table === <span class="hljs-string">"sys_user"</span>) {
          <span class="hljs-keyword">var</span> index = <span class="hljs-number">-1</span>;
          angular.forEach(users, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user, i</span>) </span>{
            <span class="hljs-keyword">if</span> (user.sys_id === $scope.primary.sys_id) {
              index = i;
            }
          });
          <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">-1</span>) {
            users.splice(index, <span class="hljs-number">1</span>);
          }
          users.splice(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, $scope.primary);
        }
        <span class="hljs-keyword">return</span> users;
      }
      buildAvatar();
      $scope.loadFullProfile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.primary &amp;&amp; !$scope.primary.sys_id &amp;&amp; !avatarProfilePersister.getAvatar($scope.primary.userID)) {
          $http.get(<span class="hljs-string">'/api/now/live/profiles/'</span> + $scope.primary.userID).then(
            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
              <span class="hljs-keyword">try</span> {
                angular.extend($scope.primary, response.data.result);
                avatarProfilePersister.setAvatar($scope.primary.userID, $scope.primary);
              } <span class="hljs-keyword">catch</span> (e) {}
            });
        }
      }
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/avatar/directive.snAvatar.js */</span>
angular.module(<span class="hljs-string">'sn.common.avatar'</span>).directive(<span class="hljs-string">'snAvatar'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$http, $compile, getTemplateUrl, snCustomEvent, snConnectService</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'sn_avatar.xml'</span>),
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">members</span>: <span class="hljs-string">'='</span>,
      <span class="hljs-attr">primary</span>: <span class="hljs-string">'='</span>,
      <span class="hljs-attr">showPresence</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">enableContextMenu</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">enableTooltip</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">enableBindOnce</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-attr">displayMemberCount</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">groupAvatar</span>: <span class="hljs-string">"@"</span>
    },
    <span class="hljs-attr">compile</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tElement</span>) </span>{
      <span class="hljs-keyword">var</span> template = tElement.html();
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs, controller, transcludeFn</span>) </span>{
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recompile</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">var</span> newElement = $compile(template, transcludeFn)(scope);
          element.html(newElement);
          <span class="hljs-keyword">if</span> (scope.enableTooltip) {
            element.tooltip({
              <span class="hljs-attr">placement</span>: <span class="hljs-string">'auto top'</span>,
              <span class="hljs-attr">container</span>: <span class="hljs-string">'body'</span>
            }).attr(<span class="hljs-string">'data-original-title'</span>, scope.users[<span class="hljs-number">0</span>].name).tooltip(<span class="hljs-string">'fixTitle'</span>);
            <span class="hljs-keyword">if</span> (element.hideFix)
              element.hideFix();
          }
        }
        <span class="hljs-keyword">if</span> (attrs.enableBindOnce === <span class="hljs-string">'false'</span>) {
          scope.$watch(<span class="hljs-string">'primary'</span>, recompile);
          scope.$watch(<span class="hljs-string">'members'</span>, recompile);
        }
        <span class="hljs-keyword">if</span> (scope.enableTooltip) {
          <span class="hljs-keyword">var</span> usersWatch = scope.$watch(<span class="hljs-string">'users'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (scope.users &amp;&amp; scope.users.length === <span class="hljs-number">1</span> &amp;&amp; scope.users[<span class="hljs-number">0</span>] &amp;&amp; scope.users[<span class="hljs-number">0</span>].name) {
              element.tooltip({
                <span class="hljs-attr">placement</span>: <span class="hljs-string">'auto top'</span>,
                <span class="hljs-attr">container</span>: <span class="hljs-string">'body'</span>
              }).attr(<span class="hljs-string">'data-original-title'</span>, scope.users[<span class="hljs-number">0</span>].name).tooltip(<span class="hljs-string">'fixTitle'</span>);
              <span class="hljs-keyword">if</span> (element.hideFix)
                element.hideFix();
              usersWatch();
            }
          });
        }
        <span class="hljs-keyword">if</span> (scope.enableContextMenu !== <span class="hljs-literal">false</span>) {
          scope.contextOptions = [];
          <span class="hljs-keyword">var</span> gUser = <span class="hljs-literal">null</span>;
          <span class="hljs-keyword">try</span> {
            gUser = g_user;
          } <span class="hljs-keyword">catch</span> (err) {}
          <span class="hljs-keyword">if</span> (scope.users &amp;&amp; scope.users.length === <span class="hljs-number">1</span> &amp;&amp; scope.users[<span class="hljs-number">0</span>] &amp;&amp; (scope.users[<span class="hljs-number">0</span>].userID || scope.users[<span class="hljs-number">0</span>].sys_id)) {
            scope.contextOptions = [
              [<span class="hljs-string">"Open user's profile"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (scope.users &amp;&amp; scope.users.length &gt; <span class="hljs-number">0</span>) {
                  <span class="hljs-built_in">window</span>.open(<span class="hljs-string">'/nav_to.do?uri='</span> + <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-string">'sys_user.do?sys_id='</span> + scope.users[<span class="hljs-number">0</span>].userID), <span class="hljs-string">'_blank'</span>);
                }
              }]
            ];
            <span class="hljs-keyword">if</span> ((gUser &amp;&amp; scope.users[<span class="hljs-number">0</span>].userID &amp;&amp; scope.users[<span class="hljs-number">0</span>].userID !== gUser.userID) ||
              (scope.liveProfileID &amp;&amp; scope.users[<span class="hljs-number">0</span>] &amp;&amp; scope.users[<span class="hljs-number">0</span>].sysID !== scope.liveProfileID)) {
              scope.contextOptions.push([<span class="hljs-string">"Open a new chat"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                snConnectService.openWithProfile(scope.users[<span class="hljs-number">0</span>]);
              }]);
            }
          }
        } <span class="hljs-keyword">else</span> {
          scope.contextOptions = [];
        }
      };
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, liveProfileID</span>) </span>{
      $scope.displayMemberCount = $scope.displayMemberCount || <span class="hljs-literal">false</span>;
      $scope.liveProfileID = liveProfileID;
      $scope.$watch(<span class="hljs-string">'primary'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.primary &amp;&amp; newValue !== oldValue) {
          buildAvatar();
          <span class="hljs-keyword">if</span> ($scope.contextOptions.length &gt; <span class="hljs-number">0</span>) {
            $scope.contextOptions = [
              [<span class="hljs-string">"Open user's profile"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> ($scope.users &amp;&amp; $scope.users.length &gt; <span class="hljs-number">0</span>) {
                  <span class="hljs-built_in">window</span>.location.href = <span class="hljs-string">'sys_user.do?sys_id='</span> + $scope.users[<span class="hljs-number">0</span>].userID || $scope.users[<span class="hljs-number">0</span>].userID;
                }
              }]
            ];
            <span class="hljs-keyword">var</span> gUser = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">try</span> {
              gUser = g_user;
            } <span class="hljs-keyword">catch</span> (err) {}
            <span class="hljs-keyword">if</span> ((!gUser &amp;&amp; !liveProfileID) || ($scope.users &amp;&amp; $scope.users.length === <span class="hljs-number">1</span> &amp;&amp; $scope.users[<span class="hljs-number">0</span>])) {
              <span class="hljs-keyword">if</span> ((gUser &amp;&amp; $scope.users[<span class="hljs-number">0</span>].userID &amp;&amp; $scope.users[<span class="hljs-number">0</span>].userID !== gUser.userID) ||
                ($scope.liveProfileID &amp;&amp; $scope.users[<span class="hljs-number">0</span>] &amp;&amp; $scope.users[<span class="hljs-number">0</span>].sysID !== $scope.liveProfileID)) {
                $scope.contextOptions.push([<span class="hljs-string">"Open a new chat"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                  snConnectService.openWithProfile($scope.users[<span class="hljs-number">0</span>]);
                }]);
              }
            }
          }
        }
      });
      $scope.$watch(<span class="hljs-string">'members'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.members)
          buildAvatar();
      });
      $scope.avatarType = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> result = [];
        <span class="hljs-keyword">if</span> ($scope.groupAvatar || !$scope.users)
          <span class="hljs-keyword">return</span> result;
        <span class="hljs-keyword">if</span> ($scope.users.length &gt; <span class="hljs-number">1</span>)
          result.push(<span class="hljs-string">"group"</span>);
        <span class="hljs-keyword">if</span> ($scope.users.length === <span class="hljs-number">2</span>)
          result.push(<span class="hljs-string">"avatar-duo"</span>);
        <span class="hljs-keyword">if</span> ($scope.users.length === <span class="hljs-number">3</span>)
          result.push(<span class="hljs-string">"avatar-trio"</span>);
        <span class="hljs-keyword">if</span> ($scope.users.length &gt;= <span class="hljs-number">4</span>)
          result.push(<span class="hljs-string">"avatar-quad"</span>);
        <span class="hljs-keyword">return</span> result;
      };
      $scope.getBackgroundStyle = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) </span>{
        <span class="hljs-keyword">var</span> avatar = (user ? user.avatar : <span class="hljs-string">''</span>);
        <span class="hljs-keyword">if</span> ($scope.groupAvatar)
          avatar = $scope.groupAvatar;
        <span class="hljs-keyword">if</span> (avatar &amp;&amp; avatar !== <span class="hljs-string">''</span>)
          <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'background-image'</span>: <span class="hljs-string">'url('</span> + avatar + <span class="hljs-string">')'</span>
          };
        <span class="hljs-keyword">if</span> (user &amp;&amp; user.name)
          <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
      };
      $scope.maxStringWidth = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> paddedWidth = <span class="hljs-built_in">parseInt</span>($scope.avatarWidth * <span class="hljs-number">0.8</span>, <span class="hljs-number">10</span>);
        <span class="hljs-keyword">return</span> $scope.users.length === <span class="hljs-number">1</span> ? paddedWidth : paddedWidth / <span class="hljs-number">2</span>;
      };

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildInitials</span>(<span class="hljs-params">name</span>) </span>{
        <span class="hljs-keyword">if</span> (!name)
          <span class="hljs-keyword">return</span> <span class="hljs-string">"--"</span>;
        <span class="hljs-keyword">var</span> initials = name.split(<span class="hljs-string">" "</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">word</span>) </span>{
          <span class="hljs-keyword">return</span> word.toUpperCase();
        }).filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">word</span>) </span>{
          <span class="hljs-keyword">return</span> word.match(<span class="hljs-regexp">/^[A-Z]/</span>);
        }).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">word</span>) </span>{
          <span class="hljs-keyword">return</span> word.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
        }).join(<span class="hljs-string">""</span>);
        <span class="hljs-keyword">return</span> (initials.length &gt; <span class="hljs-number">3</span>) ?
          initials.substr(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>) :
          initials;
      }
      $scope.avatartooltip = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!$scope.enableTooltip) {
          <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
        }
        <span class="hljs-keyword">if</span> (!$scope.users) {
          <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
        }
        <span class="hljs-keyword">var</span> names = [];
        $scope.users.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) </span>{
          <span class="hljs-keyword">if</span> (!user) {
            <span class="hljs-keyword">return</span>;
          }
          names.push(user.name);
        });
        <span class="hljs-keyword">return</span> names.join(<span class="hljs-string">', '</span>);
      };

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildAvatar</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> $scope.primary === <span class="hljs-string">'string'</span>) {
          $http.get(<span class="hljs-string">'/api/now/live/profiles/sys_user.'</span> + $scope.primary).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
            $scope.users = [{
              <span class="hljs-attr">userID</span>: $scope.primary,
              <span class="hljs-attr">name</span>: response.data.result.name,
              <span class="hljs-attr">initials</span>: buildInitials(response.data.result.name),
              <span class="hljs-attr">avatar</span>: response.data.result.avatar
            }];
            $scope.presenceEnabled = $scope.showPresence &amp;&amp; !$scope.isDocument &amp;&amp; $scope.users.length === <span class="hljs-number">1</span>;
          });
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> ($scope.primary) {
          <span class="hljs-keyword">if</span> ($scope.primary.userImage)
            $scope.primary.avatar = $scope.primary.userImage;
          <span class="hljs-keyword">if</span> (!$scope.primary.userID &amp;&amp; $scope.primary.sys_id)
            $scope.primary.userID = $scope.primary.sys_id;
        }
        $scope.isDocument = $scope.primary &amp;&amp; $scope.primary.table &amp;&amp; $scope.primary.table !== <span class="hljs-string">"sys_user"</span> &amp;&amp; $scope.primary.table !== <span class="hljs-string">"chat_queue_entry"</span>;
        $scope.users = [$scope.primary];
        <span class="hljs-keyword">if</span> ($scope.primary &amp;&amp; (!$scope.members || $scope.members.length &lt;= <span class="hljs-number">0</span>) &amp;&amp; ($scope.primary.avatar || $scope.primary.initials) &amp;&amp; $scope.isDocument) {
          $scope.users = [$scope.primary];
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($scope.members &amp;&amp; $scope.members.length &gt; <span class="hljs-number">0</span>) {
          $scope.users = buildCompositeAvatar($scope.members);
        }
        $scope.presenceEnabled = $scope.showPresence &amp;&amp; !$scope.isDocument &amp;&amp; $scope.users.length === <span class="hljs-number">1</span>;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildCompositeAvatar</span>(<span class="hljs-params">members</span>) </span>{
        <span class="hljs-keyword">var</span> currentUser = <span class="hljs-built_in">window</span>.NOW.user ? <span class="hljs-built_in">window</span>.NOW.user.userID : <span class="hljs-built_in">window</span>.NOW.user_id;
        <span class="hljs-keyword">var</span> users = angular.isArray(members) ? members.slice() : [members];
        users = users.sort(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
          <span class="hljs-keyword">var</span> aID = a.userID || a.document;
          <span class="hljs-keyword">var</span> bID = b.userID || b.document;
          <span class="hljs-keyword">if</span> (a.table === <span class="hljs-string">"chat_queue_entry"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
          <span class="hljs-keyword">if</span> (aID === currentUser)
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bID === currentUser)
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
          <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        });
        <span class="hljs-keyword">if</span> (users.length === <span class="hljs-number">2</span>)
          users = [users[<span class="hljs-number">0</span>]];
        <span class="hljs-keyword">if</span> (users.length &gt; <span class="hljs-number">2</span> &amp;&amp; $scope.primary &amp;&amp; $scope.primary.name &amp;&amp; $scope.primary.table === <span class="hljs-string">"sys_user"</span>) {
          <span class="hljs-keyword">var</span> index = <span class="hljs-number">-1</span>;
          angular.forEach(users, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user, i</span>) </span>{
            <span class="hljs-keyword">if</span> (user.sys_id === $scope.primary.sys_id) {
              index = i;
            }
          });
          <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">-1</span>) {
            users.splice(index, <span class="hljs-number">1</span>);
          }
          users.splice(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, $scope.primary);
        }
        <span class="hljs-keyword">return</span> users;
      }
      buildAvatar();
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/avatar/service.avatarProfilePersister.js */</span>
angular.module(<span class="hljs-string">'sn.common.avatar'</span>).service(<span class="hljs-string">'avatarProfilePersister'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> avatars = {};

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setAvatar</span>(<span class="hljs-params">id, payload</span>) </span>{
    avatars[id] = payload;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAvatar</span>(<span class="hljs-params">id</span>) </span>{
    <span class="hljs-keyword">return</span> avatars[id];
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">setAvatar</span>: setAvatar,
    <span class="hljs-attr">getAvatar</span>: getAvatar
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/avatar/directive.snUserAvatar.js */</span>
angular.module(<span class="hljs-string">'sn.common.avatar'</span>).directive(<span class="hljs-string">'snUserAvatar'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'sn_user_avatar.xml'</span>),
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">profile</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">userId</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">avatarUrl</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">initials</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">enablePresence</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-attr">disablePopover</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">directConversationButton</span>: <span class="hljs-string">'=?'</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
      scope.evaluatedProfile = <span class="hljs-literal">undefined</span>;
      scope.backgroundStyle = <span class="hljs-literal">undefined</span>;
      scope.enablePresence = scope.enablePresence !== <span class="hljs-string">'false'</span>;
      <span class="hljs-keyword">if</span> (scope.profile) {
        scope.evaluatedProfile = scope.profile;
        scope.userId = scope.profile.userID || <span class="hljs-string">""</span>;
        scope.avatarUrl = scope.profile.avatar || <span class="hljs-string">""</span>;
        scope.initials = scope.profile.initials || <span class="hljs-string">""</span>;
        scope.backgroundStyle = scope.getBackgroundStyle();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scope.userId || scope.avatarUrl || scope.initials) {
        scope.evaluatedProfile = scope.profile = {
          <span class="hljs-string">'userID'</span>: scope.userId || <span class="hljs-string">""</span>,
          <span class="hljs-string">'avatar'</span>: scope.avatarUrl || <span class="hljs-string">""</span>,
          <span class="hljs-string">'initials'</span>: scope.initials || <span class="hljs-string">""</span>
        }
        scope.backgroundStyle = scope.getBackgroundStyle();
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> unwatch = scope.$watch(<span class="hljs-string">'profile'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newVal</span>) </span>{
          <span class="hljs-keyword">if</span> (newVal) {
            scope.evaluatedProfile = newVal;
            scope.backgroundStyle = scope.getBackgroundStyle();
            unwatch();
          }
        })
      }
      scope.directConversationButton = scope.directConversationButton !== <span class="hljs-string">'false'</span> &amp;&amp; scope.directConversationButton !== <span class="hljs-literal">false</span>;
      scope.template = <span class="hljs-string">'&lt;sn-user-profile profile="evaluatedProfile" show-direct-message-prompt="::directConversationButton" class="avatar-popover avatar-popover-padding"&gt;&lt;/sn-user-profile&gt;'</span>;
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
      $scope.getBackgroundStyle = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (($scope.avatarUrl &amp;&amp; $scope.avatarUrl !== <span class="hljs-string">''</span>) || $scope.evaluatedProfile &amp;&amp; $scope.evaluatedProfile.avatar !== <span class="hljs-string">''</span>)
          <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"background-image"</span>: <span class="hljs-string">'url('</span> + ($scope.avatarUrl || $scope.evaluatedProfile.avatar) + <span class="hljs-string">')'</span>
          };
        <span class="hljs-keyword">return</span> {
          <span class="hljs-string">"background-image"</span>: <span class="hljs-string">""</span>
        };
      };
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/avatar/directive.snGroupAvatar.js */</span>
angular.module(<span class="hljs-string">'sn.common.avatar'</span>).directive(<span class="hljs-string">'snGroupAvatar'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$http, $compile, getTemplateUrl, avatarProfilePersister</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'sn_group_avatar.xml'</span>),
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">members</span>: <span class="hljs-string">'='</span>,
      <span class="hljs-attr">primary</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">groupAvatar</span>: <span class="hljs-string">"@"</span>
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, liveProfileID</span>) </span>{
      $scope.liveProfileID = liveProfileID;
      $scope.$watch(<span class="hljs-string">'members'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newVal, oldVal</span>) </span>{
        <span class="hljs-keyword">if</span> (newVal === oldVal)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> ($scope.members)
          $scope.users = buildCompositeAvatar($scope.members);
      });
      $scope.avatarType = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> result = [];
        <span class="hljs-keyword">if</span> ($scope.groupAvatar || !$scope.users)
          <span class="hljs-keyword">return</span> result;
        <span class="hljs-keyword">if</span> ($scope.users.length &gt; <span class="hljs-number">1</span>)
          result.push(<span class="hljs-string">"group"</span>)
        <span class="hljs-keyword">if</span> ($scope.users.length === <span class="hljs-number">2</span>)
          result.push(<span class="hljs-string">"sn-avatar_duo"</span>)
        <span class="hljs-keyword">if</span> ($scope.users.length === <span class="hljs-number">3</span>)
          result.push(<span class="hljs-string">"sn-avatar_trio"</span>)
        <span class="hljs-keyword">if</span> ($scope.users.length &gt;= <span class="hljs-number">4</span>)
          result.push(<span class="hljs-string">"sn-avatar_quad"</span>)
        <span class="hljs-keyword">return</span> result;
      };
      $scope.getBackgroundStyle = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) </span>{
        <span class="hljs-keyword">var</span> avatar = (user ? user.avatar : <span class="hljs-string">''</span>);
        <span class="hljs-keyword">if</span> ($scope.groupAvatar)
          avatar = $scope.groupAvatar;
        <span class="hljs-keyword">if</span> (avatar &amp;&amp; avatar !== <span class="hljs-string">''</span>)
          <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"background-image"</span>: <span class="hljs-string">"url("</span> + avatar + <span class="hljs-string">")"</span>
          };
        <span class="hljs-keyword">return</span> {};
      };
      $scope.users = buildCompositeAvatar($scope.members);

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildCompositeAvatar</span>(<span class="hljs-params">members</span>) </span>{
        <span class="hljs-keyword">var</span> currentUser = <span class="hljs-built_in">window</span>.NOW.user ? <span class="hljs-built_in">window</span>.NOW.user.userID : <span class="hljs-built_in">window</span>.NOW.user_id;
        <span class="hljs-keyword">var</span> users = angular.isArray(members) ? members.slice() : [members];
        users = users.sort(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
          <span class="hljs-keyword">var</span> aID = a.userID || a.document;
          <span class="hljs-keyword">var</span> bID = b.userID || b.document;
          <span class="hljs-keyword">if</span> (a.table === <span class="hljs-string">"chat_queue_entry"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
          <span class="hljs-keyword">if</span> (aID === currentUser)
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bID === currentUser)
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
          <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        });
        <span class="hljs-keyword">if</span> (users.length === <span class="hljs-number">2</span>)
          users = [users[<span class="hljs-number">0</span>]];
        <span class="hljs-keyword">if</span> (users.length &gt; <span class="hljs-number">2</span> &amp;&amp; $scope.primary &amp;&amp; $scope.primary.name &amp;&amp; $scope.primary.table === <span class="hljs-string">"sys_user"</span>) {
          <span class="hljs-keyword">var</span> index = <span class="hljs-number">-1</span>;
          angular.forEach(users, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user, i</span>) </span>{
            <span class="hljs-keyword">if</span> (user.sys_id === $scope.primary.sys_id) {
              index = i;
            }
          });
          <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">-1</span>) {
            users.splice(index, <span class="hljs-number">1</span>);
          }
          users.splice(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, $scope.primary);
        }
        <span class="hljs-keyword">return</span> users;
      }
    }
  }
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/js_includes_controls.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.controls'</span>, []);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/directive.snChoiceList.js */</span>
angular.module(<span class="hljs-string">'sn.common.controls'</span>).directive(<span class="hljs-string">'snChoiceList'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">snModel</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">snTextField</span>: <span class="hljs-string">"@"</span>,
      <span class="hljs-attr">snValueField</span>: <span class="hljs-string">"@"</span>,
      <span class="hljs-attr">snOptions</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">snItems</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">snOnChange</span>: <span class="hljs-string">"&amp;"</span>,
      <span class="hljs-attr">snDisabled</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">snDialogName</span>: <span class="hljs-string">"="</span>,
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;select ng-disabled="snDisabled" ng-model="model" ng-options="item[snValueField] as item[snTextField] for item in snItems"&gt;&lt;option value="" ng-show="snOptions.placeholder"&gt;{{snOptions.placeholder}}&lt;/option&gt;&lt;/select&gt;'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs</span>) </span>{
      <span class="hljs-keyword">if</span> (scope.snDialogName)
        scope.$on(<span class="hljs-string">"dialog."</span> + scope.snDialogName + <span class="hljs-string">".close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            $(element).select2(<span class="hljs-string">"destroy"</span>);
          })
        });
      $(element).css(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">var</span> config = {
        <span class="hljs-attr">width</span>: <span class="hljs-string">"100%"</span>
      };
      <span class="hljs-keyword">if</span> (scope.snOptions) {
        <span class="hljs-keyword">if</span> (scope.snOptions.placeholder) {
          config.placeholderOption = <span class="hljs-string">"first"</span>;
        }
        <span class="hljs-keyword">if</span> (scope.snOptions.hideSearch &amp;&amp; scope.snOptions.hideSearch === <span class="hljs-literal">true</span>) {
          config.minimumResultsForSearch = <span class="hljs-number">-1</span>;
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
        scope.model = scope.snModel;
        render();
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!attrs) {
          $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            render();
          });
          <span class="hljs-keyword">return</span>;
        }
        $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          $(element).css(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">1</span>);
          $(element).select2(<span class="hljs-string">"destroy"</span>);
          $(element).select2(config);
        });
      }
      init();
      scope.$watch(<span class="hljs-string">"snItems"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
        <span class="hljs-keyword">if</span> (newValue !== oldValue) {
          init();
        }
      }, <span class="hljs-literal">true</span>);
      scope.$watch(<span class="hljs-string">"snModel"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>) </span>{
        <span class="hljs-keyword">if</span> (newValue !== <span class="hljs-literal">undefined</span> &amp;&amp; newValue !== scope.model) {
          init();
        }
      });
      scope.$watch(<span class="hljs-string">"model"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
        <span class="hljs-keyword">if</span> (newValue !== oldValue) {
          scope.snModel = newValue;
          <span class="hljs-keyword">if</span> (scope.snOnChange)
            scope.snOnChange({
              <span class="hljs-attr">selectedValue</span>: newValue
            });
        }
      });
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{}
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/directive.snReferencePicker.js */</span>
angular.module(<span class="hljs-string">'sn.common.controls'</span>).directive(<span class="hljs-string">'snReferencePicker'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout, $http, urlTools, filterExpressionParser, $sanitize, i18n</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">ed</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">field</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">refTable</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">refId</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">snOptions</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">snOnChange</span>: <span class="hljs-string">"&amp;"</span>,
      <span class="hljs-attr">snOnBlur</span>: <span class="hljs-string">"&amp;"</span>,
      <span class="hljs-attr">snOnClose</span>: <span class="hljs-string">"&amp;"</span>,
      <span class="hljs-attr">snOnOpen</span>: <span class="hljs-string">'&amp;'</span>,
      <span class="hljs-attr">minimumInputLength</span>: <span class="hljs-string">"@"</span>,
      <span class="hljs-attr">snDisabled</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">snPageSize</span>: <span class="hljs-string">"@"</span>,
      <span class="hljs-attr">dropdownCssClass</span>: <span class="hljs-string">"@"</span>,
      <span class="hljs-attr">formatResultCssClass</span>: <span class="hljs-string">"&amp;"</span>,
      <span class="hljs-attr">overlay</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">additionalDisplayColumns</span>: <span class="hljs-string">"@"</span>,
      <span class="hljs-attr">displayColumn</span>: <span class="hljs-string">"@"</span>,
      <span class="hljs-attr">recordValues</span>: <span class="hljs-string">'&amp;'</span>,
      <span class="hljs-attr">getGlideForm</span>: <span class="hljs-string">'&amp;glideForm'</span>,
      <span class="hljs-attr">domain</span>: <span class="hljs-string">"@"</span>,
      <span class="hljs-attr">snSelectWidth</span>: <span class="hljs-string">'@'</span>,
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;input type="text" name="{{field.name}}" ng-disabled="snDisabled" style="min-width: 150px;" ng-model="field.displayValue" /&gt;'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs, ctrl</span>) </span>{
      scope.ed = scope.ed || scope.field.ed;
      scope.selectWidth = scope.snSelectWidth || <span class="hljs-string">'100%'</span>;
      element.css(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">var</span> fireReadyEvent = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">var</span> g_form;
      <span class="hljs-keyword">if</span> (angular.isDefined(scope.getGlideForm))
        g_form = scope.getGlideForm();
      <span class="hljs-keyword">var</span> fieldAttributes = {};
      <span class="hljs-keyword">if</span> (angular.isDefined(scope.field) &amp;&amp; angular.isDefined(scope.field.attributes) &amp;&amp; <span class="hljs-keyword">typeof</span> scope.ed.attributes == <span class="hljs-string">'undefined'</span>)
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(scope.field.attributes))
          fieldAttributes = scope.field.attributes;
        <span class="hljs-keyword">else</span>
          fieldAttributes = parseAttributes(scope.field.attributes);
      <span class="hljs-keyword">else</span>
        fieldAttributes = parseAttributes(scope.ed.attributes);
      <span class="hljs-keyword">if</span> (!angular.isDefined(scope.additionalDisplayColumns) &amp;&amp; angular.isDefined(fieldAttributes[<span class="hljs-string">'ref_ac_columns'</span>]))
        scope.additionalDisplayColumns = fieldAttributes[<span class="hljs-string">'ref_ac_columns'</span>];
      <span class="hljs-keyword">var</span> select2AjaxHelpers = {
        <span class="hljs-attr">formatSelection</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">return</span> $sanitize(getDisplayValue(item));
        },
        <span class="hljs-attr">formatResult</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">var</span> displayValues = getDisplayValues(item);
          <span class="hljs-keyword">if</span> (displayValues.length == <span class="hljs-number">1</span>)
            <span class="hljs-keyword">return</span> $sanitize(displayValues[<span class="hljs-number">0</span>]);
          <span class="hljs-keyword">if</span> (displayValues.length &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">var</span> width = <span class="hljs-number">100</span> / displayValues.length;
            <span class="hljs-keyword">var</span> markup = <span class="hljs-string">""</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; displayValues.length; i++)
              markup += <span class="hljs-string">"&lt;div style='width: "</span> + width + <span class="hljs-string">"%;' class='select2-result-cell'&gt;"</span> + $sanitize(displayValues[i]) + <span class="hljs-string">"&lt;/div&gt;"</span>;
            <span class="hljs-keyword">return</span> markup;
          }
          <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        },
        <span class="hljs-attr">search</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">queryParams</span>) </span>{
          <span class="hljs-keyword">if</span> (<span class="hljs-string">'sysparm_include_variables'</span> <span class="hljs-keyword">in</span> queryParams.data) {
            <span class="hljs-keyword">var</span> url = urlTools.getURL(<span class="hljs-string">'ref_list_data'</span>, queryParams.data);
            <span class="hljs-keyword">return</span> $http.get(url).then(queryParams.success);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> url = urlTools.getURL(<span class="hljs-string">'ref_list_data'</span>);
            <span class="hljs-keyword">return</span> $http.post(url, queryParams.data).then(queryParams.success);
          }
        },
        <span class="hljs-attr">initSelection</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">elem, callback</span>) </span>{
          <span class="hljs-keyword">if</span> (scope.field.displayValue)
            callback({
              <span class="hljs-attr">sys_id</span>: scope.field.value,
              <span class="hljs-attr">name</span>: scope.field.displayValue
            });
        }
      };
      <span class="hljs-keyword">var</span> config = {
        <span class="hljs-attr">width</span>: scope.selectWidth,
        <span class="hljs-attr">minimumInputLength</span>: scope.minimumInputLength ? <span class="hljs-built_in">parseInt</span>(scope.minimumInputLength, <span class="hljs-number">10</span>) : <span class="hljs-number">0</span>,
        <span class="hljs-attr">overlay</span>: scope.overlay,
        <span class="hljs-attr">containerCssClass</span>: <span class="hljs-string">'select2-reference ng-form-element'</span>,
        <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'   '</span>,
        <span class="hljs-attr">formatSearching</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">allowClear</span>: attrs.allowClear !== <span class="hljs-string">'false'</span>,
        <span class="hljs-attr">id</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">return</span> item.sys_id;
        },
        <span class="hljs-attr">sortResults</span>: (scope.snOptions &amp;&amp; scope.snOptions.sortResults) ? scope.snOptions.sortResults : <span class="hljs-literal">undefined</span>,
        <span class="hljs-attr">ajax</span>: {
          <span class="hljs-attr">quietMillis</span>: NOW.ac_wait_time,
          <span class="hljs-attr">data</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filterText, page</span>) </span>{
            <span class="hljs-keyword">var</span> filterExpression = filterExpressionParser.parse(filterText, scope.ed.defaultOperator);
            <span class="hljs-keyword">var</span> colToSearch = getReferenceColumnToSearch();
            <span class="hljs-keyword">var</span> q = colToSearch + filterExpression.operator + filterExpression.filterText +
              <span class="hljs-string">'^'</span> + colToSearch + <span class="hljs-string">'ISNOTEMPTY'</span> + getExcludedValues() + <span class="hljs-string">"^EQ"</span>;
            <span class="hljs-keyword">var</span> params = {
              <span class="hljs-attr">start</span>: (scope.pageSize * (page - <span class="hljs-number">1</span>)),
              <span class="hljs-attr">count</span>: scope.pageSize,
              <span class="hljs-attr">sysparm_target_table</span>: scope.refTable,
              <span class="hljs-attr">sysparm_target_sys_id</span>: scope.refId,
              <span class="hljs-attr">sysparm_target_field</span>: scope.ed.dependent_field || scope.ed.name,
              <span class="hljs-attr">table</span>: scope.ed.reference,
              <span class="hljs-attr">qualifier</span>: scope.ed.qualifier,
              <span class="hljs-attr">data_adapter</span>: scope.ed.data_adapter,
              <span class="hljs-attr">attributes</span>: scope.ed.attributes,
              <span class="hljs-attr">dependent_field</span>: scope.ed.dependent_field,
              <span class="hljs-attr">dependent_table</span>: scope.ed.dependent_table,
              <span class="hljs-attr">dependent_value</span>: scope.ed.dependent_value,
              <span class="hljs-attr">p</span>: scope.ed.reference + <span class="hljs-string">';q:'</span> + q + <span class="hljs-string">';r:'</span> + scope.ed.qualifier
            };
            <span class="hljs-keyword">if</span> (scope.domain) {
              params.sysparm_domain = scope.domain;
            }
            <span class="hljs-keyword">if</span> (angular.isDefined(scope.field) &amp;&amp; scope.field[<span class="hljs-string">'_cat_variable'</span>] === <span class="hljs-literal">true</span>) {
              <span class="hljs-keyword">delete</span> params[<span class="hljs-string">'sysparm_target_table'</span>];
              params[<span class="hljs-string">'sysparm_include_variables'</span>] = <span class="hljs-literal">true</span>;
              params[<span class="hljs-string">'variable_ids'</span>] = scope.field.sys_id;
              <span class="hljs-keyword">var</span> getFieldSequence = g_form.$private.options(<span class="hljs-string">'getFieldSequence'</span>);
              <span class="hljs-keyword">if</span> (getFieldSequence) {
                params[<span class="hljs-string">'variable_sequence1'</span>] = getFieldSequence();
              }
              <span class="hljs-keyword">var</span> itemSysId = g_form.$private.options(<span class="hljs-string">'itemSysId'</span>);
              params[<span class="hljs-string">'sysparm_id'</span>] = itemSysId;
              <span class="hljs-keyword">var</span> getFieldParams = g_form.$private.options(<span class="hljs-string">'getFieldParams'</span>);
              <span class="hljs-keyword">if</span> (getFieldParams) {
                angular.extend(params, getFieldParams());
              }
            }
            <span class="hljs-keyword">if</span> (scope.recordValues)
              params.sysparm_record_values = scope.recordValues();
            <span class="hljs-keyword">return</span> params;
          },
          <span class="hljs-attr">results</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, page</span>) </span>{
            <span class="hljs-keyword">return</span> ctrl.filterResults(data, page, scope.pageSize);
          },
          <span class="hljs-attr">transport</span>: select2AjaxHelpers.search
        },
        <span class="hljs-attr">formatSelection</span>: select2AjaxHelpers.formatSelection,
        <span class="hljs-attr">formatResult</span>: select2AjaxHelpers.formatResult,
        <span class="hljs-attr">initSelection</span>: select2AjaxHelpers.initSelection,
        <span class="hljs-attr">dropdownCssClass</span>: attrs.dropdownCssClass,
        <span class="hljs-attr">formatResultCssClass</span>: scope.formatResultCssClass || <span class="hljs-literal">null</span>
      };
      <span class="hljs-keyword">if</span> (scope.snOptions) {
        <span class="hljs-keyword">if</span> (scope.snOptions.placeholder) {
          config.placeholder = scope.snOptions.placeholder;
        }
        <span class="hljs-keyword">if</span> (scope.snOptions.width) {
          config.width = scope.snOptions.width;
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getReferenceColumnToSearch</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> colName = <span class="hljs-string">'name'</span>;
        <span class="hljs-keyword">if</span> (scope.ed.searchField)
          colName = scope.ed.searchField;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fieldAttributes[<span class="hljs-string">'ref_ac_columns_search'</span>] == <span class="hljs-string">'true'</span> &amp;&amp; <span class="hljs-string">'ref_ac_columns'</span> <span class="hljs-keyword">in</span> fieldAttributes &amp;&amp; fieldAttributes[<span class="hljs-string">'ref_ac_columns'</span>] != <span class="hljs-string">''</span>) {
          <span class="hljs-keyword">var</span> refAcColumns = fieldAttributes[<span class="hljs-string">'ref_ac_columns'</span>].split(<span class="hljs-string">';'</span>);
          colName = refAcColumns[<span class="hljs-number">0</span>];
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fieldAttributes[<span class="hljs-string">'ref_ac_order_by'</span>])
          colName = fieldAttributes[<span class="hljs-string">'ref_ac_order_by'</span>];
        <span class="hljs-keyword">return</span> colName;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getExcludedValues</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (scope.ed.excludeValues &amp;&amp; scope.ed.excludeValues != <span class="hljs-string">''</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-string">'^sys_idNOT IN'</span> + scope.ed.excludeValues;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseAttributes</span>(<span class="hljs-params">strAttributes</span>) </span>{
        <span class="hljs-keyword">var</span> attributeArray = (strAttributes &amp;&amp; strAttributes.length ? strAttributes.split(<span class="hljs-string">','</span>) : []);
        <span class="hljs-keyword">var</span> attributeObj = {};
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; attributeArray.length; i++) {
          <span class="hljs-keyword">if</span> (attributeArray[i].length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">var</span> attribute = attributeArray[i].split(<span class="hljs-string">'='</span>);
            attributeObj[attribute[<span class="hljs-number">0</span>]] = attribute.length &gt; <span class="hljs-number">1</span> ? attribute[<span class="hljs-number">1</span>] : <span class="hljs-string">''</span>;
          }
        }
        <span class="hljs-keyword">return</span> attributeObj;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
        scope.model = scope.snModel;
        render();
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
        $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          i18n.getMessage(<span class="hljs-string">'Searching...'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">searchingMsg</span>) </span>{
            config.formatSearching = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">return</span> searchingMsg;
            };
          });
          element.css(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">1</span>);
          element.select2(<span class="hljs-string">"destroy"</span>);
          <span class="hljs-keyword">var</span> select2 = element.select2(config);
          select2.bind(<span class="hljs-string">"change"</span>, select2Change);
          select2.bind(<span class="hljs-string">"select2-removed"</span>, select2Change);
          select2.bind(<span class="hljs-string">"select2-blur"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              scope.snOnBlur();
            });
          });
          select2.bind(<span class="hljs-string">"select2-close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              scope.snOnClose();
            });
          });
          select2.bind(<span class="hljs-string">"select2-open"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">if</span> (scope.snOnOpen)
                scope.snOnOpen();
            });
          });
          <span class="hljs-keyword">if</span> (fireReadyEvent) {
            scope.$emit(<span class="hljs-string">'select2.ready'</span>, element);
            fireReadyEvent = <span class="hljs-literal">false</span>;
          }
        });
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">select2Change</span>(<span class="hljs-params">e</span>) </span>{
        e.stopImmediatePropagation();
        <span class="hljs-keyword">if</span> (e.added) {
          <span class="hljs-keyword">if</span> (scope.$$phase || scope.$root.$$phase)
            <span class="hljs-keyword">return</span>;
          <span class="hljs-keyword">var</span> selectedItem = e.added;
          <span class="hljs-keyword">var</span> value = selectedItem.sys_id;
          <span class="hljs-keyword">var</span> displayValue = value ? getDisplayValue(selectedItem) : <span class="hljs-string">''</span>;
          <span class="hljs-keyword">if</span> (scope.snOptions &amp;&amp; scope.snOptions.useGlideForm === <span class="hljs-literal">true</span>) {
            g_form.setValue(scope.field.name, value, displayValue);
            scope.rowSelected();
          } <span class="hljs-keyword">else</span> {
            scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              scope.field.value = value;
              scope.field.displayValue = displayValue;
              scope.rowSelected();
            });
          }
          <span class="hljs-keyword">if</span> (scope.snOnChange) {
            e.displayValue = displayValue;
            scope.snOnChange(e);
          }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.removed) {
          <span class="hljs-keyword">if</span> (scope.snOptions &amp;&amp; scope.snOptions.useGlideForm === <span class="hljs-literal">true</span>) {
            g_form.clearValue(scope.field.name);
            <span class="hljs-keyword">if</span> (scope.snOnChange)
              scope.snOnChange(e);
          } <span class="hljs-keyword">else</span> {
            scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              scope.field.displayValue = <span class="hljs-string">''</span>;
              scope.field.value = <span class="hljs-string">''</span>;
              <span class="hljs-keyword">if</span> (scope.snOnChange)
                scope.snOnChange(e);
            });
          }
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDisplayValue</span>(<span class="hljs-params">selectedItem</span>) </span>{
        <span class="hljs-keyword">var</span> displayValue = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">if</span> (selectedItem &amp;&amp; selectedItem.sys_id) {
          <span class="hljs-keyword">if</span> (scope.displayColumn &amp;&amp; <span class="hljs-keyword">typeof</span> selectedItem[scope.displayColumn] != <span class="hljs-string">"undefined"</span>)
            displayValue = selectedItem[scope.displayColumn];
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectedItem.$$displayValue)
            displayValue = selectedItem.$$displayValue;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectedItem.name)
            displayValue = selectedItem.name;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectedItem.title)
            displayValue = selectedItem.title;
        }
        <span class="hljs-keyword">return</span> displayValue;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDisplayValues</span>(<span class="hljs-params">selectedItem</span>) </span>{
        <span class="hljs-keyword">var</span> displayValues = [];
        <span class="hljs-keyword">if</span> (selectedItem &amp;&amp; selectedItem.sys_id) {
          <span class="hljs-keyword">var</span> current = <span class="hljs-string">""</span>;
          <span class="hljs-keyword">if</span> (scope.displayColumn &amp;&amp; <span class="hljs-keyword">typeof</span> selectedItem[scope.displayColumn] != <span class="hljs-string">"undefined"</span>)
            current = selectedItem[scope.displayColumn];
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectedItem.$$displayValue)
            current = selectedItem.$$displayValue;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectedItem.name)
            current = selectedItem.name;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectedItem.title)
            current = selectedItem.title;
          displayValues.push(current);
        }
        <span class="hljs-keyword">if</span> (scope.additionalDisplayColumns) {
          <span class="hljs-keyword">var</span> columns = scope.additionalDisplayColumns.split(<span class="hljs-string">","</span>);
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; columns.length; i++) {
            <span class="hljs-keyword">var</span> column = columns[i];
            <span class="hljs-keyword">if</span> (selectedItem[column])
              displayValues.push(selectedItem[column]);
          }
        }
        <span class="hljs-keyword">return</span> displayValues;
      }
      scope.$watch(<span class="hljs-string">"field.displayValue"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
        <span class="hljs-keyword">if</span> (newValue != oldValue &amp;&amp; newValue !== scope.model) {
          init();
        }
      });
      scope.$on(<span class="hljs-string">"snReferencePicker.activate"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt, parms</span>) </span>{
        $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          element.select2(<span class="hljs-string">"open"</span>);
        })
      });
      init();
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $rootScope</span>) </span>{
      $scope.pageSize = <span class="hljs-number">20</span>;
      <span class="hljs-keyword">if</span> ($scope.snPageSize)
        $scope.pageSize = <span class="hljs-built_in">parseInt</span>($scope.snPageSize);
      $scope.rowSelected = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $rootScope.$broadcast(<span class="hljs-string">"@page.reference.selected"</span>, {
          <span class="hljs-attr">field</span>: $scope.field,
          <span class="hljs-attr">ed</span>: $scope.ed
        });
      };
      <span class="hljs-keyword">this</span>.filterResults = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, page</span>) </span>{
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">results</span>: data.data.items,
          <span class="hljs-attr">more</span>: (page * $scope.pageSize &lt; data.data.total)
        };
      };
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/directive.snRecordPicker.js */</span>
angular.module(<span class="hljs-string">'sn.common.controls'</span>).directive(<span class="hljs-string">'snRecordPicker'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout, $http, urlTools, filterExpressionParser, $sanitize, i18n</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> cache = {};

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanLabel</span>(<span class="hljs-params">val</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> val == <span class="hljs-string">"object"</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> val == <span class="hljs-string">"string"</span> ? val.trim() : val;
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">field</span>: <span class="hljs-string">'='</span>,
      <span class="hljs-attr">table</span>: <span class="hljs-string">'='</span>,
      <span class="hljs-attr">defaultQuery</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">searchFields</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">valueField</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">displayField</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">displayFields</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">pageSize</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">onChange</span>: <span class="hljs-string">'&amp;'</span>,
      <span class="hljs-attr">snDisabled</span>: <span class="hljs-string">'='</span>,
      <span class="hljs-attr">multiple</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">options</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'@'</span>
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;input type="text" ng-disabled="snDisabled" style="min-width: 150px;" name="{{field.name}}" ng-model="field.value" /&gt;'</span>,
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
      <span class="hljs-keyword">if</span> (!angular.isNumber($scope.pageSize))
        $scope.pageSize = <span class="hljs-number">20</span>;
      <span class="hljs-keyword">if</span> (!angular.isDefined($scope.valueField))
        $scope.valueField = <span class="hljs-string">'sys_id'</span>;
      <span class="hljs-keyword">this</span>.filterResults = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, page</span>) </span>{
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">results</span>: data.data.result,
          <span class="hljs-attr">more</span>: (page * $scope.pageSize &lt; <span class="hljs-built_in">parseInt</span>(data.headers(<span class="hljs-string">'x-total-count'</span>), <span class="hljs-number">10</span>))
        };
      };
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs, ctrl</span>) </span>{
      <span class="hljs-keyword">var</span> isExecuting = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">var</span> select2Helpers = {
        <span class="hljs-attr">formatSelection</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">return</span> $sanitize(getDisplayValue(item));
        },
        <span class="hljs-attr">formatResult</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">var</span> displayFields = getdisplayFields(item);
          <span class="hljs-keyword">if</span> (displayFields.length == <span class="hljs-number">1</span>)
            <span class="hljs-keyword">return</span> $sanitize(cleanLabel(displayFields[<span class="hljs-number">0</span>]));
          <span class="hljs-keyword">if</span> (displayFields.length &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">var</span> markup = $sanitize(displayFields[<span class="hljs-number">0</span>]);
            <span class="hljs-keyword">var</span> width = <span class="hljs-number">100</span> / (displayFields.length - <span class="hljs-number">1</span>);
            markup += <span class="hljs-string">"&lt;div&gt;"</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; displayFields.length; i++)
              markup += <span class="hljs-string">"&lt;div style='width: "</span> + width + <span class="hljs-string">"%;' class='select2-additional-display-field'&gt;"</span> + $sanitize(cleanLabel(displayFields[i])) + <span class="hljs-string">"&lt;/div&gt;"</span>;
            markup += <span class="hljs-string">"&lt;/div&gt;"</span>;
            <span class="hljs-keyword">return</span> markup;
          }
          <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        },
        <span class="hljs-attr">search</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">queryParams</span>) </span>{
          <span class="hljs-keyword">var</span> url = <span class="hljs-string">'/api/now/table/'</span> + scope.table + <span class="hljs-string">'?'</span> + urlTools.encodeURIParameters(queryParams.data);
          <span class="hljs-keyword">if</span> (scope.options &amp;&amp; scope.options.cache &amp;&amp; cache[url])
            <span class="hljs-keyword">return</span> queryParams.success(cache[url]);
          <span class="hljs-keyword">return</span> $http.get(url).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
            <span class="hljs-keyword">if</span> (scope.options &amp;&amp; scope.options.cache) {
              cache[url] = response;
            }
            <span class="hljs-keyword">return</span> queryParams.success(response)
          });
        },
        <span class="hljs-attr">initSelection</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">elem, callback</span>) </span>{
          <span class="hljs-keyword">if</span> (scope.field.displayValue) {
            <span class="hljs-keyword">if</span> (scope.multiple) {
              <span class="hljs-keyword">var</span> items = [],
                sel;
              <span class="hljs-keyword">var</span> values = scope.field.value.split(<span class="hljs-string">','</span>);
              <span class="hljs-keyword">var</span> displayValues = scope.field.displayValue.split(<span class="hljs-string">','</span>);
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; values.length; i++) {
                sel = {};
                sel[scope.valueField] = values[i];
                sel[scope.displayField] = displayValues[i];
                items.push(sel);
              }
              callback(items);
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">var</span> sel = {};
              sel[scope.valueField] = scope.field.value;
              sel[scope.displayField] = scope.field.displayValue;
              callback(sel);
            }
          } <span class="hljs-keyword">else</span>
            callback([]);
        }
      };
      <span class="hljs-keyword">var</span> config = {
        <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>,
        <span class="hljs-attr">containerCssClass</span>: <span class="hljs-string">'select2-reference ng-form-element'</span>,
        <span class="hljs-attr">placeholder</span>: scope.placeholder || <span class="hljs-string">'    '</span>,
        <span class="hljs-attr">formatSearching</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">allowClear</span>: (scope.options &amp;&amp; <span class="hljs-keyword">typeof</span> scope.options.allowClear !== <span class="hljs-string">"undefined"</span>) ? scope.options.allowClear : <span class="hljs-literal">true</span>,
        <span class="hljs-attr">id</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">return</span> item[scope.valueField];
        },
        <span class="hljs-attr">ajax</span>: {
          <span class="hljs-attr">quietMillis</span>: NOW.ac_wait_time,
          <span class="hljs-attr">data</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filterText, page</span>) </span>{
            <span class="hljs-keyword">var</span> params = {
              <span class="hljs-attr">sysparm_offset</span>: (scope.pageSize * (page - <span class="hljs-number">1</span>)),
              <span class="hljs-attr">sysparm_limit</span>: scope.pageSize,
              <span class="hljs-attr">sysparm_query</span>: buildQuery(filterText, scope.searchFields, scope.defaultQuery)
            };
            <span class="hljs-keyword">return</span> params;
          },
          <span class="hljs-attr">results</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, page</span>) </span>{
            <span class="hljs-keyword">return</span> ctrl.filterResults(data, page, scope.pageSize);
          },
          <span class="hljs-attr">transport</span>: select2Helpers.search
        },
        <span class="hljs-attr">formatSelection</span>: select2Helpers.formatSelection,
        <span class="hljs-attr">formatResult</span>: select2Helpers.formatResult,
        <span class="hljs-attr">formatResultCssClass</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
        },
        <span class="hljs-attr">initSelection</span>: select2Helpers.initSelection,
        <span class="hljs-attr">multiple</span>: scope.multiple
      };

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildQuery</span>(<span class="hljs-params">filterText, searchFields, defaultQuery</span>) </span>{
        <span class="hljs-keyword">var</span> queryParts = [];
        <span class="hljs-keyword">var</span> operator = <span class="hljs-string">"CONTAINS"</span>;
        <span class="hljs-keyword">if</span> (filterText.startsWith(<span class="hljs-string">"*"</span>))
          filterText = filterText.substring(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> (defaultQuery)
          queryParts.push(defaultQuery);
        <span class="hljs-keyword">var</span> filterExpression = filterExpressionParser.parse(filterText, operator);
        <span class="hljs-keyword">if</span> (searchFields != <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">var</span> fields = searchFields.split(<span class="hljs-string">','</span>);
          <span class="hljs-keyword">if</span> (filterExpression.filterText != <span class="hljs-string">''</span>) {
            <span class="hljs-keyword">var</span> OR = <span class="hljs-string">""</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; fields.length; i++) {
              queryParts.push(OR + fields[i] + filterExpression.operator + filterExpression.filterText);
              OR = <span class="hljs-string">"OR"</span>;
            }
          }
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; fields.length; i++)
            queryParts.push(<span class="hljs-string">'ORDERBY'</span> + fields[i]);
          queryParts.push(<span class="hljs-string">'EQ'</span>);
        }
        <span class="hljs-keyword">return</span> queryParts.join(<span class="hljs-string">'^'</span>);
      }
      scope.field = scope.field || {};
      <span class="hljs-keyword">var</span> initTimeout = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">var</span> value = scope.field.value;
      <span class="hljs-keyword">var</span> oldValue = scope.field.value;
      <span class="hljs-keyword">var</span> $select;

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
        element.css(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">0</span>);
        $timeout.cancel(initTimeout);
        initTimeout = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          i18n.getMessage(<span class="hljs-string">'Searching...'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">searchingMsg</span>) </span>{
            config.formatSearching = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">return</span> searchingMsg;
            };
          });
          element.css(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">1</span>);
          element.select2(<span class="hljs-string">"destroy"</span>);
          $select = element.select2(config);
          $select.bind(<span class="hljs-string">"change"</span>, onChanged);
          $select.bind(<span class="hljs-string">"select2-removed"</span>, onChanged);
          $select.bind(<span class="hljs-string">"select2-selecting"</span>, onSelecting);
          $select.bind(<span class="hljs-string">"select2-removing"</span>, onRemoving);
          scope.$emit(<span class="hljs-string">'select2.ready'</span>, element);
        });
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onSelecting</span>(<span class="hljs-params">e</span>) </span>{
        isExecuting = <span class="hljs-literal">true</span>;
        oldValue = scope.field.value;
        <span class="hljs-keyword">var</span> selectedItem = e.choice;
        <span class="hljs-keyword">if</span> (scope.multiple &amp;&amp; selectedItem[scope.valueField] != <span class="hljs-string">''</span>) {
          <span class="hljs-keyword">var</span> values = scope.field.value == <span class="hljs-string">''</span> ? [] : scope.field.value.split(<span class="hljs-string">','</span>);
          <span class="hljs-keyword">var</span> displayValues = scope.field.displayValue == <span class="hljs-string">''</span> ? [] : scope.field.displayValue.split(<span class="hljs-string">','</span>);
          values.push(selectedItem[scope.valueField]);
          displayValues.push(getDisplayValue(selectedItem));
          scope.field.value = values.join(<span class="hljs-string">','</span>);
          scope.field.displayValue = displayValues.join(<span class="hljs-string">','</span>);
          e.preventDefault();
          $select.select2(<span class="hljs-string">'val'</span>, values).select2(<span class="hljs-string">'close'</span>);
          scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            callChange(oldValue, e);
          });
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onRemoving</span>(<span class="hljs-params">e</span>) </span>{
        isExecuting = <span class="hljs-literal">true</span>;
        oldValue = scope.field.value;
        <span class="hljs-keyword">var</span> removed = e.choice;
        <span class="hljs-keyword">if</span> (scope.multiple) {
          <span class="hljs-keyword">var</span> values = scope.field.value.split(<span class="hljs-string">','</span>);
          <span class="hljs-keyword">var</span> displayValues = scope.field.displayValue.split(<span class="hljs-string">','</span>);
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = values.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-keyword">if</span> (removed[scope.valueField] == values[i]) {
              values.splice(i, <span class="hljs-number">1</span>);
              displayValues.splice(i, <span class="hljs-number">1</span>);
              <span class="hljs-keyword">break</span>;
            }
          }
          scope.field.value = values.join(<span class="hljs-string">','</span>);
          scope.field.displayValue = displayValues.join(<span class="hljs-string">','</span>);
          e.preventDefault();
          $select.select2(<span class="hljs-string">'val'</span>, scope.field.value.split(<span class="hljs-string">','</span>));
          scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            callChange(oldValue, e);
          });
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callChange</span>(<span class="hljs-params">oldValue, e</span>) </span>{
        <span class="hljs-keyword">var</span> f = scope.field;
        <span class="hljs-keyword">var</span> p = {
          <span class="hljs-attr">field</span>: f,
          <span class="hljs-attr">newValue</span>: f.value,
          <span class="hljs-attr">oldValue</span>: oldValue,
          <span class="hljs-attr">displayValue</span>: f.displayValue
        }
        scope.$emit(<span class="hljs-string">"field.change"</span>, p);
        scope.$emit(<span class="hljs-string">"field.change."</span> + f.name, p);
        <span class="hljs-keyword">if</span> (scope.onChange)
          <span class="hljs-keyword">try</span> {
            scope.onChange(e);
          } <span class="hljs-keyword">catch</span> (ex) {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"directive.snRecordPicker error in onChange"</span>)
            <span class="hljs-built_in">console</span>.log(ex)
          }
        isExecuting = <span class="hljs-literal">false</span>;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onChanged</span>(<span class="hljs-params">e</span>) </span>{
        e.stopImmediatePropagation();
        <span class="hljs-keyword">if</span> (scope.$$phase || scope.$root.$$phase) {
          <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">'in digest, returning early'</span>);
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> (e.added) {
          <span class="hljs-keyword">var</span> selectedItem = e.added;
          <span class="hljs-keyword">if</span> (!scope.multiple) {
            scope.field.value = selectedItem[scope.valueField];
            <span class="hljs-keyword">if</span> (scope.field.value) {
              scope.field.displayValue = getDisplayValue(selectedItem);
            } <span class="hljs-keyword">else</span>
              scope.field.displayValue = <span class="hljs-string">''</span>;
          }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.removed) {
          <span class="hljs-keyword">if</span> (!scope.multiple) {
            scope.field.displayValue = <span class="hljs-string">''</span>;
            scope.field.value = <span class="hljs-string">''</span>;
          }
        }
        scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          callChange(oldValue, e);
        });
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDisplayValue</span>(<span class="hljs-params">selectedItem</span>) </span>{
        <span class="hljs-keyword">var</span> displayValue = selectedItem[scope.valueField];
        <span class="hljs-keyword">if</span> (selectedItem) {
          <span class="hljs-keyword">if</span> (scope.displayField &amp;&amp; angular.isDefined(selectedItem[scope.displayField]))
            displayValue = selectedItem[scope.displayField];
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectedItem.name)
            displayValue = selectedItem.name;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectedItem.title)
            displayValue = selectedItem.title;
        }
        <span class="hljs-keyword">return</span> cleanLabel(displayValue);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getdisplayFields</span>(<span class="hljs-params">selectedItem</span>) </span>{
        <span class="hljs-keyword">var</span> displayFields = [];
        <span class="hljs-keyword">if</span> (selectedItem &amp;&amp; selectedItem[scope.valueField]) {
          <span class="hljs-keyword">var</span> current = <span class="hljs-string">""</span>;
          <span class="hljs-keyword">if</span> (scope.displayField &amp;&amp; angular.isDefined(selectedItem[scope.displayField]))
            current = selectedItem[scope.displayField];
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectedItem.name)
            current = selectedItem.name;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectedItem.title)
            current = selectedItem.title;
          displayFields.push(current);
        }
        <span class="hljs-keyword">if</span> (scope.displayFields) {
          <span class="hljs-keyword">var</span> columns = scope.displayFields.split(<span class="hljs-string">","</span>);
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; columns.length; i++) {
            <span class="hljs-keyword">var</span> column = columns[i];
            <span class="hljs-keyword">if</span> (selectedItem[column])
              displayFields.push(selectedItem[column]);
          }
        }
        <span class="hljs-keyword">return</span> displayFields;
      }
      scope.$watch(<span class="hljs-string">"field.value"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>) </span>{
        <span class="hljs-keyword">if</span> (isExecuting) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (angular.isDefined(newValue) &amp;&amp; $select) {
          <span class="hljs-keyword">if</span> (scope.multiple)
            $select.select2(<span class="hljs-string">'val'</span>, newValue.split(<span class="hljs-string">','</span>)).select2(<span class="hljs-string">'close'</span>);
          <span class="hljs-keyword">else</span>
            $select.select2(<span class="hljs-string">'val'</span>, newValue).select2(<span class="hljs-string">'close'</span>);
        }
      });
      <span class="hljs-keyword">if</span> (attrs.displayValue) {
        attrs.$observe(<span class="hljs-string">'displayValue'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
          scope.field.value = value;
        });
      }
      init();
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/directive.snSelectBasic.js */</span>
angular.module(<span class="hljs-string">'sn.common.controls'</span>).directive(<span class="hljs-string">'snSelectBasic'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout</span>) </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'C'</span>,
    <span class="hljs-attr">priority</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">require</span>: <span class="hljs-string">'?ngModel'</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-string">'snAllowClear'</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-string">'snSelectWidth'</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-string">'snChoices'</span>: <span class="hljs-string">'=?'</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs, ngModel</span>) </span>{
      <span class="hljs-keyword">if</span> (angular.isFunction(element.select2)) {
        element.css(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">0</span>);
        scope.selectWidth = scope.snSelectWidth || <span class="hljs-string">'100%'</span>;
        scope.selectAllowClear = scope.snAllowClear === <span class="hljs-string">"true"</span>;
        $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          element.css(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">1</span>);
          element.select2({
            <span class="hljs-attr">allowClear</span>: scope.selectAllowClear,
            <span class="hljs-attr">width</span>: scope.selectWidth
          });
          ngModel.$render = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            element.select2(<span class="hljs-string">'val'</span>, ngModel.$viewValue);
            element.val(ngModel.$viewValue);
          };
        });
        element.on(<span class="hljs-string">'change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          scope.$evalAsync(setModelValue);
        });
        scope.$watch(<span class="hljs-string">'snChoices'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
          <span class="hljs-keyword">if</span> (angular.isDefined(newValue) &amp;&amp; newValue != oldValue) {
            $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              setModelValue();
            });
          }
        }, <span class="hljs-literal">true</span>);

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setModelValue</span>(<span class="hljs-params"></span>) </span>{
          ngModel.$setViewValue(element.val());
        };
      }
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/directive.snTableReference.js */</span>
angular.module(<span class="hljs-string">'sn.common.controls'</span>).directive(<span class="hljs-string">'snTableReference'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">field</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">snChange</span>: <span class="hljs-string">"&amp;"</span>,
      <span class="hljs-attr">snDisabled</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;select ng-disabled="snDisabled" style="min-width: 150px;" name="{{field.name}}" ng-model="fieldValue" ng-model-options="{getterSetter: true}" ng-options="choice.value as choice.label for choice in field.choices"&gt;&lt;/select&gt;'</span>,
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
      $scope.fieldValue = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">selected</span>) </span>{
        <span class="hljs-keyword">if</span> (angular.isDefined(selected)) {
          $scope.snChange({
            <span class="hljs-attr">newValue</span>: selected
          });
        }
        <span class="hljs-keyword">return</span> $scope.field.value;
      }
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
      <span class="hljs-keyword">var</span> initTimeout = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">var</span> fireReadyEvent = <span class="hljs-literal">true</span>;
      element.css(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">0</span>);

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
        $timeout.cancel(initTimeout);
        initTimeout = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          element.css(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">1</span>);
          element.select2(<span class="hljs-string">"destroy"</span>);
          element.select2();
          <span class="hljs-keyword">if</span> (fireReadyEvent) {
            scope.$emit(<span class="hljs-string">'select2.ready'</span>, element);
            fireReadyEvent = <span class="hljs-literal">false</span>;
          }
        });
      }
      scope.$watch(<span class="hljs-string">"field.displayValue"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
        <span class="hljs-keyword">if</span> (newValue !== <span class="hljs-literal">undefined</span> &amp;&amp; newValue != oldValue) {
          render();
        }
      });
      render();
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/directive.snFieldReference.js */</span>
angular.module(<span class="hljs-string">'sn.common.controls'</span>).directive(<span class="hljs-string">'snFieldReference'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout, $http, nowServer</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">field</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">snChange</span>: <span class="hljs-string">"&amp;"</span>,
      <span class="hljs-attr">snDisabled</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">getGlideForm</span>: <span class="hljs-string">'&amp;glideForm'</span>
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;select ng-disabled="snDisabled" name="{{field.name}}" style="min-width: 150px;" ng-model="fieldValue" ng-model-options="{getterSetter: true}" ng-options="choice.name as choice.label for choice in field.choices"&gt;&lt;/select&gt;'</span>,
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
      $scope.fieldValue = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">selected</span>) </span>{
        <span class="hljs-keyword">if</span> (angular.isDefined(selected))
          $scope.snChange({
            <span class="hljs-attr">newValue</span>: selected
          });
        <span class="hljs-keyword">return</span> $scope.field.value;
      }
      $scope.$watch(<span class="hljs-string">'field.dependentValue'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newVal, oldVal</span>) </span>{
        <span class="hljs-keyword">if</span> (!angular.isDefined(newVal))
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">var</span> src = nowServer.getURL(<span class="hljs-string">'table_fields'</span>, <span class="hljs-string">'exclude_formatters=true&amp;fd_table='</span> + newVal);
        $http.post(src).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
          $scope.field.choices = response;
          $scope.render();
        });
      });
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
      <span class="hljs-keyword">var</span> initTimeout = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">var</span> fireReadyEvent = <span class="hljs-literal">true</span>;
      scope.render = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $timeout.cancel(initTimeout);
        initTimeout = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          element.select2(<span class="hljs-string">"destroy"</span>);
          element.select2();
          <span class="hljs-keyword">if</span> (fireReadyEvent) {
            scope.$emit(<span class="hljs-string">'select2.ready'</span>, element);
            fireReadyEvent = <span class="hljs-literal">false</span>;
          }
        });
      };
      scope.$watch(<span class="hljs-string">"field.displayValue"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
        <span class="hljs-keyword">if</span> (newValue !== <span class="hljs-literal">undefined</span> &amp;&amp; newValue != oldValue) {
          scope.render();
        }
      });
      scope.render();
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/directive.snSyncWith.js */</span>
angular.module(<span class="hljs-string">"sn.common.controls"</span>).directive(<span class="hljs-string">'snSyncWith'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">require</span>: <span class="hljs-string">'ngModel'</span>,
    <span class="hljs-attr">scope</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, elem, attr</span>) </span>{
      scope.journalField = scope.$<span class="hljs-built_in">eval</span>(attr.snSyncWith);
      scope.value = scope.$<span class="hljs-built_in">eval</span>(attr.ngModel);
      <span class="hljs-keyword">if</span> (attr.snSyncWithValueInFn)
        scope.$<span class="hljs-built_in">eval</span>(attr.ngModel + <span class="hljs-string">"="</span> + attr.snSyncWithValueInFn, {
          <span class="hljs-attr">text</span>: scope.value
        });
      scope.$watch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> scope.$<span class="hljs-built_in">eval</span>(attr.snSyncWith);
      }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">nv, ov</span>) </span>{
        <span class="hljs-keyword">if</span> (nv !== ov)
          scope.journalField = nv;
      });
      scope.$watch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> scope.$<span class="hljs-built_in">eval</span>(attr.ngModel);
      }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">nv, ov</span>) </span>{
        <span class="hljs-keyword">if</span> (nv !== ov)
          scope.value = nv;
      });
      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">window</span>.g_form)
        <span class="hljs-keyword">return</span>;
      scope.$watch(<span class="hljs-string">'value'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n, o</span>) </span>{
        <span class="hljs-keyword">if</span> (n !== o)
          setFieldValue();
      });

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setFieldValue</span>(<span class="hljs-params"></span>) </span>{
        setValue(scope.journalField, scope.value);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setValue</span>(<span class="hljs-params">field, value</span>) </span>{
        value = !!value ? value : <span class="hljs-string">''</span>;
        <span class="hljs-keyword">var</span> control = g_form.getControl(field);
        <span class="hljs-keyword">if</span> (attr.snSyncWithValueOutFn)
          value = scope.$<span class="hljs-built_in">eval</span>(attr.snSyncWithValueOutFn, {
            <span class="hljs-attr">text</span>: value
          })
        control.value = value;
        onChange(control.id);
      }
      scope.$watch(<span class="hljs-string">'journalField'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
        <span class="hljs-keyword">if</span> (newValue !== oldValue) {
          <span class="hljs-keyword">if</span> (oldValue)
            setValue(oldValue, <span class="hljs-string">''</span>);
          <span class="hljs-keyword">if</span> (newValue)
            setFieldValue();
        }
      }, <span class="hljs-literal">true</span>);
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/directive.contenteditable.js */</span>
angular.module(<span class="hljs-string">'sn.common.controls'</span>).directive(<span class="hljs-string">'contenteditable'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout, $sanitize</span>) </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">require</span>: <span class="hljs-string">'ngModel'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, elem, attrs, ctrl</span>) </span>{
      <span class="hljs-keyword">var</span> changehandler = scope.changehandler;
      scope.usenewline = scope.usenewline + <span class="hljs-string">""</span> != <span class="hljs-string">"false"</span>;
      <span class="hljs-keyword">var</span> newLine = <span class="hljs-string">"\n"</span>;
      <span class="hljs-keyword">var</span> nodeBR = <span class="hljs-string">"BR"</span>;
      <span class="hljs-keyword">var</span> nodeDIV = <span class="hljs-string">"DIV"</span>;
      <span class="hljs-keyword">var</span> nodeText = <span class="hljs-string">"#text"</span>;
      <span class="hljs-keyword">var</span> nbspRegExp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-built_in">String</span>.fromCharCode(<span class="hljs-number">160</span>), <span class="hljs-string">"g"</span>);
      <span class="hljs-keyword">if</span> (!scope.usenewline)
        elem.keypress(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
          <span class="hljs-keyword">if</span> (event.which == <span class="hljs-string">"13"</span>) {
            <span class="hljs-keyword">if</span> (scope.entercallback)
              scope.entercallback(elem);
            event.preventDefault();
          }
        });

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processNodes</span>(<span class="hljs-params">nodes</span>) </span>{
        <span class="hljs-keyword">var</span> val = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; nodes.length; i++) {
          <span class="hljs-keyword">var</span> node = nodes[i];
          <span class="hljs-keyword">var</span> follow = <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">switch</span> (node.nodeName) {
            <span class="hljs-keyword">case</span> nodeText:
              val += node.nodeValue.replace(nbspRegExp, <span class="hljs-string">" "</span>);
              <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> nodeDIV:
              val += newLine;
              <span class="hljs-keyword">if</span> (node.childNodes.length == <span class="hljs-number">1</span> &amp;&amp; node.childNodes[<span class="hljs-number">0</span>].nodeName == nodeBR)
                follow = <span class="hljs-literal">false</span>;
              <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> nodeBR:
              val += scope.usenewline ? newLine : <span class="hljs-string">""</span>;
          }
          <span class="hljs-keyword">if</span> (follow)
            val += processNodes(node.childNodes)
        }
        <span class="hljs-keyword">return</span> val;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readHtml</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> val = processNodes(elem[<span class="hljs-number">0</span>].childNodes);
        ctrl.$setViewValue(val);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeHtml</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> val = ctrl.$viewValue;
        <span class="hljs-keyword">if</span> (!val || val === <span class="hljs-literal">null</span>)
          val = <span class="hljs-string">""</span>;
        val = val.replace(<span class="hljs-regexp">/\n/gi</span>, scope.usenewline ? <span class="hljs-string">"&lt;br/&gt;"</span> : <span class="hljs-string">""</span>);
        val = val.replace(<span class="hljs-regexp">/  /gi</span>, <span class="hljs-string">" &amp;nbsp;"</span>);
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">if</span> (attrs.contenteditableEscapeHtml == <span class="hljs-string">"true"</span>)
            val = $sanitize(val);
        } <span class="hljs-keyword">catch</span> (err) {
          <span class="hljs-keyword">var</span> replacement = {
            <span class="hljs-string">'&amp;'</span>: <span class="hljs-string">'&amp;amp;'</span>,
            <span class="hljs-string">'&lt;'</span>: <span class="hljs-string">'&amp;lt;'</span>,
            <span class="hljs-string">'&gt;'</span>: <span class="hljs-string">'&amp;gt;'</span>,
            <span class="hljs-string">'"'</span>: <span class="hljs-string">'&amp;quot;'</span>,
            <span class="hljs-string">"'"</span>: <span class="hljs-string">'&amp;#x27;'</span>,
            <span class="hljs-string">'/'</span>: <span class="hljs-string">'&amp;#x2F;'</span>
          };
          val = val.replace(<span class="hljs-regexp">/[&amp;&lt;&gt;"'\/]/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pattern</span>) </span>{
            <span class="hljs-keyword">return</span> replacement[pattern]
          });
        };
        elem.html(val);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processPlaceholder</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (elem[<span class="hljs-number">0</span>].dataset) {
          <span class="hljs-keyword">if</span> (elem[<span class="hljs-number">0</span>].textContent)
            elem[<span class="hljs-number">0</span>].dataset.divPlaceholderContent = <span class="hljs-string">'true'</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elem[<span class="hljs-number">0</span>].dataset.divPlaceholderContent)
            <span class="hljs-keyword">delete</span>(elem[<span class="hljs-number">0</span>].dataset.divPlaceholderContent);
        }
      }
      elem.bind(<span class="hljs-string">'keyup'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          readHtml();
          processPlaceholder();
        });
      });

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">selectText</span>(<span class="hljs-params">elem</span>) </span>{
        <span class="hljs-keyword">var</span> range;
        <span class="hljs-keyword">var</span> selection;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.body.createTextRange) {
          range = <span class="hljs-built_in">document</span>.body.createTextRange();
          range.moveToElementText(elem);
          range.select();
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.getSelection) {
          selection = <span class="hljs-built_in">window</span>.getSelection();
          range = <span class="hljs-built_in">document</span>.createRange();
          range.selectNodeContents(elem);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      }
      elem.bind(<span class="hljs-string">'focus'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (scope[attrs.tracker] &amp;&amp; scope[attrs.tracker][<span class="hljs-string">'isDefault_'</span> + attrs.trackeratt])
          $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            selectText(elem[<span class="hljs-number">0</span>]);
          });
        elem.original = ctrl.$viewValue;
      });
      elem.bind(<span class="hljs-string">'blur'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          readHtml();
          processPlaceholder();
          <span class="hljs-keyword">if</span> (elem.original != ctrl.$viewValue &amp;&amp; changehandler) {
            <span class="hljs-keyword">if</span> (scope[attrs.tracker] &amp;&amp; <span class="hljs-keyword">typeof</span> scope[attrs.tracker][<span class="hljs-string">'isDefault_'</span> + attrs.trackeratt] != <span class="hljs-string">"undefined"</span>)
              scope[attrs.tracker][<span class="hljs-string">'isDefault_'</span> + attrs.trackeratt] = <span class="hljs-literal">false</span>;
            changehandler(scope[attrs.tracker], attrs.trackeratt);
          }
        });
      });
      elem.bind(<span class="hljs-string">'paste'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            readHtml();
            writeHtml();
          }, <span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        });
      });
      ctrl.$render = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        writeHtml();
      };
      scope.$watch(<span class="hljs-string">'field.readonly'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        elem[<span class="hljs-number">0</span>].contentEditable = !scope.$<span class="hljs-built_in">eval</span>(<span class="hljs-string">'field.readonly'</span>);
      });
      scope.$watch(
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">val</span>: elem[<span class="hljs-number">0</span>].textContent
          };
        },
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
          <span class="hljs-keyword">if</span> (newValue.val != oldValue.val)
            processPlaceholder();
        },
        <span class="hljs-literal">true</span>);
      writeHtml();
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/directive.snGlyph.js */</span>
angular.module(<span class="hljs-string">"sn.common.controls"</span>).directive(<span class="hljs-string">"snGlyph"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">char</span>: <span class="hljs-string">"@"</span>,
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;span class="glyphicon glyphicon-{{char}}" /&gt;'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope</span>) </span>{}
  }
});
angular.module(<span class="hljs-string">"sn.common.controls"</span>).directive(<span class="hljs-string">'fa'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
      <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;span class="fa" aria-hidden="true"&gt;&lt;/span&gt;'</span>,
      <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-keyword">var</span> currentClasses = {};

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_observeStringAttr</span>(<span class="hljs-params">attr, baseClass</span>) </span>{
          <span class="hljs-keyword">var</span> className;
          attrs.$observe(attr, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            baseClass = baseClass || <span class="hljs-string">'fa-'</span> + attr;
            element.removeClass(currentClasses[attr]);
            <span class="hljs-keyword">if</span> (attrs[attr]) {
              className = [baseClass, attrs[attr]].join(<span class="hljs-string">'-'</span>);
              element.addClass(className);
              currentClasses[attr] = className;
            }
          });
        }
        _observeStringAttr(<span class="hljs-string">'name'</span>, <span class="hljs-string">'fa'</span>);
        _observeStringAttr(<span class="hljs-string">'rotate'</span>);
        _observeStringAttr(<span class="hljs-string">'flip'</span>);
        _observeStringAttr(<span class="hljs-string">'stack'</span>);
        attrs.$observe(<span class="hljs-string">'size'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">var</span> className;
          element.removeClass(currentClasses.size);
          <span class="hljs-keyword">if</span> (attrs.size === <span class="hljs-string">'large'</span>) {
            className = <span class="hljs-string">'fa-lg'</span>;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseInt</span>(attrs.size, <span class="hljs-number">10</span>))) {
            className = <span class="hljs-string">'fa-'</span> + attrs.size + <span class="hljs-string">'x'</span>;
          }
          element.addClass(className);
          currentClasses.size = className;
        });
        attrs.$observe(<span class="hljs-string">'stack'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">var</span> className;
          element.removeClass(currentClasses.stack);
          <span class="hljs-keyword">if</span> (attrs.stack === <span class="hljs-string">'large'</span>) {
            className = <span class="hljs-string">'fa-stack-lg'</span>;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseInt</span>(attrs.stack, <span class="hljs-number">10</span>))) {
            className = <span class="hljs-string">'fa-stack-'</span> + attrs.stack + <span class="hljs-string">'x'</span>;
          }
          element.addClass(className);
          currentClasses.stack = className;
        });

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_observeBooleanAttr</span>(<span class="hljs-params">attr, className</span>) </span>{
          <span class="hljs-keyword">var</span> value;
          attrs.$observe(attr, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            className = className || <span class="hljs-string">'fa-'</span> + attr;
            value = attr <span class="hljs-keyword">in</span> attrs &amp;&amp; attrs[attr] !== <span class="hljs-string">'false'</span> &amp;&amp; attrs[attr] !== <span class="hljs-literal">false</span>;
            element.toggleClass(className, value);
          });
        }
        _observeBooleanAttr(<span class="hljs-string">'border'</span>);
        _observeBooleanAttr(<span class="hljs-string">'fw'</span>);
        _observeBooleanAttr(<span class="hljs-string">'inverse'</span>);
        _observeBooleanAttr(<span class="hljs-string">'spin'</span>);
        element.toggleClass(<span class="hljs-string">'fa-li'</span>,
          element.parent() &amp;&amp;
          element.parent().prop(<span class="hljs-string">'tagName'</span>) === <span class="hljs-string">'LI'</span> &amp;&amp;
          element.parent().parent() &amp;&amp;
          element.parent().parent().hasClass(<span class="hljs-string">'fa-ul'</span>) &amp;&amp;
          element.parent().children()[<span class="hljs-number">0</span>] === element[<span class="hljs-number">0</span>] &amp;&amp;
          attrs.list !== <span class="hljs-string">'false'</span> &amp;&amp;
          attrs.list !== <span class="hljs-literal">false</span>
        );
        attrs.$observe(<span class="hljs-string">'alt'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">var</span> altText = attrs.alt,
            altElem = element.next(),
            altElemClass = <span class="hljs-string">'fa-alt-text'</span>;
          <span class="hljs-keyword">if</span> (altText) {
            element.removeAttr(<span class="hljs-string">'alt'</span>);
            <span class="hljs-keyword">if</span> (!altElem || !altElem.hasClass(altElemClass)) {
              element.after(<span class="hljs-string">'&lt;span class="sr-only fa-alt-text"&gt;&lt;/span&gt;'</span>);
              altElem = element.next();
            }
            altElem.text(altText);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (altElem &amp;&amp; altElem.hasClass(altElemClass)) {
            altElem.remove();
          }
        });
      }
    };
  })
  .directive(<span class="hljs-string">'faStack'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
      <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;span ng-transclude class="fa-stack fa-lg"&gt;&lt;/span&gt;'</span>,
      <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs</span>) </span>{
        <span class="hljs-keyword">var</span> currentClasses = {};

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_observeStringAttr</span>(<span class="hljs-params">attr, baseClass</span>) </span>{
          <span class="hljs-keyword">var</span> className;
          attrs.$observe(attr, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            baseClass = baseClass || <span class="hljs-string">'fa-'</span> + attr;
            element.removeClass(currentClasses[attr]);
            <span class="hljs-keyword">if</span> (attrs[attr]) {
              className = [baseClass, attrs[attr]].join(<span class="hljs-string">'-'</span>);
              element.addClass(className);
              currentClasses[attr] = className;
            }
          });
        }
        _observeStringAttr(<span class="hljs-string">'size'</span>);
        attrs.$observe(<span class="hljs-string">'size'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">var</span> className;
          element.removeClass(currentClasses.size);
          <span class="hljs-keyword">if</span> (attrs.size === <span class="hljs-string">'large'</span>) {
            className = <span class="hljs-string">'fa-lg'</span>;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseInt</span>(attrs.size, <span class="hljs-number">10</span>))) {
            className = <span class="hljs-string">'fa-'</span> + attrs.size + <span class="hljs-string">'x'</span>;
          }
          element.addClass(className);
          currentClasses.size = className;
        });
      }
    };
  });;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/controls/directive.snImageUploader.js */</span>
angular.module(<span class="hljs-string">'sn.common.controls'</span>).directive(<span class="hljs-string">'snImageUploader'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$window, $rootScope, $timeout, getTemplateUrl, i18n, snAttachmentHandler</span>) </span>{
  <span class="hljs-keyword">var</span> DRAG_IMAGE_SELECT = i18n.getMessage(<span class="hljs-string">'Drag image or click to select'</span>);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'directive.snImageUploader'</span>),
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">readOnly</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-attr">tableName</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-attr">sysId</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-attr">fieldName</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-attr">onUpload</span>: <span class="hljs-string">'&amp;'</span>,
      <span class="hljs-attr">onDelete</span>: <span class="hljs-string">'&amp;'</span>,
      <span class="hljs-attr">uploadMessage</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-attr">src</span>: <span class="hljs-string">'='</span>
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
      $scope.uploading = <span class="hljs-literal">false</span>;
      $scope.getTitle = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.readOnly !== <span class="hljs-string">'true'</span>)
          <span class="hljs-keyword">return</span> DRAG_IMAGE_SELECT;
        <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
      }
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isValidImage</span>(<span class="hljs-params">file</span>) </span>{
        <span class="hljs-keyword">if</span> (file.type.indexOf(<span class="hljs-string">'image'</span>) != <span class="hljs-number">0</span>) {
          $alert(i18n.getMessage(<span class="hljs-string">'Please select an image'</span>));
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">if</span> (file.type.indexOf(<span class="hljs-string">'tiff'</span>) &gt; <span class="hljs-number">0</span>) {
          $alert(i18n.getMessage(<span class="hljs-string">'Please select a common image format such as gif, jpeg or png'</span>));
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">$alert</span>(<span class="hljs-params">message</span>) </span>{
        alert(message);
      }
      scope.onFileSelect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$files</span>) </span>{
        <span class="hljs-keyword">if</span> (scope.readOnly === <span class="hljs-string">'true'</span>)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> ($files.length == <span class="hljs-number">0</span>)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">var</span> file = $files[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">if</span> (!isValidImage(file))
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">var</span> uploadParams = {
          <span class="hljs-attr">sysparm_fieldname</span>: scope.fieldName
        };
        scope.uploading = <span class="hljs-literal">true</span>;
        snAttachmentHandler.create(scope.tableName, scope.sysId).uploadAttachment(file, uploadParams).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
          $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            scope.uploading = <span class="hljs-literal">false</span>;
          });
          <span class="hljs-keyword">if</span> (scope.onUpload)
            scope.onUpload({
              <span class="hljs-attr">thumbnail</span>: response.thumbnail
            });
          $rootScope.$broadcast(<span class="hljs-string">"snImageUploader:complete"</span>, scope.sysId, response);
        });
      }
      scope.openFileSelector = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$event</span>) </span>{
        $event.stopPropagation();
        <span class="hljs-keyword">var</span> input = element.find(<span class="hljs-string">'input[type=file]'</span>);
        input.click();
      }
      scope.activateUpload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$event</span>) </span>{
        <span class="hljs-keyword">if</span> (scope.readOnly !== <span class="hljs-string">'true'</span>)
          scope.openFileSelector($event);
        <span class="hljs-keyword">else</span>
          scope.showUpload = !scope.showUpload;
      }
      scope.deleteAttachment = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> sys_id = scope.src.split(<span class="hljs-string">"."</span>)[<span class="hljs-number">0</span>];
        snAttachmentHandler.deleteAttachment(sys_id).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          scope.src = <span class="hljs-literal">null</span>;
          <span class="hljs-keyword">if</span> (scope.onDelete)
            scope.onDelete();
          $rootScope.$broadcast(<span class="hljs-string">"snImageUploader:delete"</span>, scope.sysId, sys_id);
        });
      }
    }
  }
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/i18n/js_includes_i18n.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/i18n/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.i18n'</span>, [<span class="hljs-string">'sn.common.glide'</span>]);
angular.module(<span class="hljs-string">'sn.i18n'</span>, [<span class="hljs-string">'sn.common.i18n'</span>]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/i18n/directive.snBindI18n.js */</span>
angular.module(<span class="hljs-string">'sn.common.i18n'</span>).directive(<span class="hljs-string">'snBindI18n'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i18n, $sanitize</span>) </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, iElem, iAttrs</span>) </span>{
      i18n.getMessage(iAttrs.snBindI18n, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">translatedValue</span>) </span>{
        <span class="hljs-keyword">var</span> sanitizedValue = $sanitize(translatedValue);
        iElem.append(sanitizedValue);
      });
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/i18n/directive.message.js */</span>
angular.module(<span class="hljs-string">'sn.common.i18n'</span>).directive(<span class="hljs-string">'nowMessage'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i18n</span>) </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">priority</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">template</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">compile</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element, attrs, transclude</span>) </span>{
      <span class="hljs-keyword">var</span> value = element.attr(<span class="hljs-string">'value'</span>);
      <span class="hljs-keyword">if</span> (!attrs.key || !value)
        <span class="hljs-keyword">return</span>;
      i18n.loadMessage(attrs.key, value);
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/i18n/service.i18n.js */</span>
angular.module(<span class="hljs-string">'sn.common.i18n'</span>).provider(<span class="hljs-string">'i18n'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> messageMap = {};

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadMessage</span>(<span class="hljs-params">msgKey, msgValue</span>) </span>{
    messageMap[msgKey] = msgValue;
  }
  <span class="hljs-keyword">this</span>.preloadMessages = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">messages</span>) </span>{
    angular.forEach(messages, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, val</span>) </span>{
      loadMessage(key, val);
    });
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">interpolate</span>(<span class="hljs-params">param</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.replace(<span class="hljs-regexp">/{([^{}]*)}/g</span>,
      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
        <span class="hljs-keyword">var</span> r = param[b];
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> r === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> r === <span class="hljs-string">'number'</span> ? r : a;
      }
    );
  }
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">String</span>.prototype.withValues)
    <span class="hljs-built_in">String</span>.prototype.withValues = interpolate;
  <span class="hljs-keyword">this</span>.$get = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">nowServer, $http, $window, $log</span>) </span>{
    <span class="hljs-keyword">var</span> isDebug = $<span class="hljs-built_in">window</span>.NOW ? $<span class="hljs-built_in">window</span>.NOW.i18n_debug : <span class="hljs-literal">true</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">debug</span>(<span class="hljs-params">msg</span>) </span>{
      <span class="hljs-keyword">if</span> (!isDebug)
        <span class="hljs-keyword">return</span>;
      $log.log(<span class="hljs-string">'i18n: '</span> + msg);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMessageFromServer</span>(<span class="hljs-params">msgKey, callback</span>) </span>{
      getMessagesFromServer([msgKey], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (callback)
          callback(messageMap[msgKey]);
      });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMessagesFromServer</span>(<span class="hljs-params">msgArray, callback, msgArrayFull</span>) </span>{
      <span class="hljs-keyword">var</span> url = nowServer.getURL(<span class="hljs-string">'message'</span>);
      $http.post(url, {
        <span class="hljs-attr">messages</span>: msgArray
      }).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
        <span class="hljs-keyword">var</span> messages = response.messages;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> messages) {
          loadMessage(i, messages[i]);
        }
        <span class="hljs-keyword">var</span> returnMessages = {},
          allMessages = msgArrayFull || msgArray;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; allMessages.length; j++) {
          <span class="hljs-keyword">var</span> key = allMessages[j];
          returnMessages[key] = messageMap[key];
        }
        <span class="hljs-keyword">if</span> (callback)
          callback(returnMessages);
      });
    }
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">getMessage</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msgKey, callback</span>) </span>{
        debug(<span class="hljs-string">'getMessage: Checking for '</span> + msgKey);
        <span class="hljs-keyword">if</span> (messageMap.hasOwnProperty(msgKey)) {
          <span class="hljs-keyword">var</span> message = messageMap[msgKey];
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(callback) == <span class="hljs-string">'function'</span>)
            callback(message);
          debug(<span class="hljs-string">'getMessage: Found: '</span> + msgKey + <span class="hljs-string">', message: '</span> + message);
          <span class="hljs-keyword">return</span> message;
        }
        debug(<span class="hljs-string">'getMessage: Not found: '</span> + msgKey + <span class="hljs-string">', querying server'</span>);
        getMessageFromServer(msgKey, callback);
        msgKey.withValues = interpolate;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(callback) != <span class="hljs-string">'function'</span>)
          $log.warn(<span class="hljs-string">'getMessage (key="'</span> + msgKey + <span class="hljs-string">'"): synchronous use not supported in Mobile or Service Portal unless message is already cached'</span>);
        <span class="hljs-keyword">return</span> msgKey;
      },
      <span class="hljs-attr">format</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length == <span class="hljs-number">1</span>)
          <span class="hljs-keyword">return</span> message;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length == <span class="hljs-number">2</span> &amp;&amp; (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>] === <span class="hljs-string">'object'</span>))
          <span class="hljs-keyword">return</span> interpolate.call(message, <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">return</span> interpolate.call(message, [].slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>));
      },
      <span class="hljs-attr">getMessages</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msgArray, callback</span>) </span>{
        debug(<span class="hljs-string">'getMessages: Checking for '</span> + msgArray.join(<span class="hljs-string">','</span>));
        <span class="hljs-keyword">var</span> results = {},
          needMessage = [],
          needServerRequest = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; msgArray.length; i++) {
          <span class="hljs-keyword">var</span> key = msgArray[i];
          <span class="hljs-keyword">if</span> (!messageMap.hasOwnProperty(key)) {
            debug(<span class="hljs-string">'getMessages: Did not find '</span> + key);
            needMessage.push(key);
            needServerRequest = <span class="hljs-literal">true</span>;
            results[key] = key;
            <span class="hljs-keyword">continue</span>;
          }
          results[key] = messageMap[key];
          debug(<span class="hljs-string">'getMessages: Found '</span> + key + <span class="hljs-string">', message: '</span> + results[key]);
        }
        <span class="hljs-keyword">if</span> (needServerRequest) {
          debug(<span class="hljs-string">'getMessages: Querying server for '</span> + needMessage.join(<span class="hljs-string">','</span>));
          getMessagesFromServer(needMessage, callback, msgArray);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(callback) == <span class="hljs-string">'function'</span>) {
          debug(<span class="hljs-string">'getMessages: Found all messages'</span>);
          callback(results);
        }
        <span class="hljs-keyword">return</span> results;
      },
      <span class="hljs-attr">clearMessages</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        debug(<span class="hljs-string">'clearMessages: clearing messages'</span>);
        messageMap = {};
      },
      <span class="hljs-attr">loadMessage</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msgKey, msgValue</span>) </span>{
        loadMessage(msgKey, msgValue);
        debug(<span class="hljs-string">'loadMessage: loaded key: '</span> + msgKey + <span class="hljs-string">', value: '</span> + msgValue);
      },
      <span class="hljs-attr">preloadMessages</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>
        angular.element(<span class="hljs-string">'now-message'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">var</span> elem = angular.element(<span class="hljs-keyword">this</span>);
          that.loadMessage(elem.attr(<span class="hljs-string">'key'</span>), elem.attr(<span class="hljs-string">'value'</span>));
        })
      }
    };
  };
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/link/js_includes_link.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/link/_module.js */</span>
angular.module(<span class="hljs-string">"sn.common.link"</span>, []);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/link/directive.snLinkContent.js */</span>
angular.module(<span class="hljs-string">'sn.common.link'</span>).directive(<span class="hljs-string">'snLinkContent'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$compile, linkContentTypes</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">template</span>: <span class="hljs-string">"&lt;span /&gt;"</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">link</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, elem</span>) </span>{
      scope.isShowing = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> (scope.link.isActive || scope.link.isUnauthorized) &amp;&amp; !scope.link.isPending;
      };
      <span class="hljs-keyword">var</span> linkDirective = linkContentTypes.forType(scope.link);
      elem.attr(linkDirective, <span class="hljs-string">""</span>);
      elem.attr(<span class="hljs-string">'ng-if'</span>, <span class="hljs-string">'isShowing()'</span>);
      $compile(elem)(scope);
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/link/directive.snLinkContentYoutube.js */</span>
angular.module(<span class="hljs-string">'sn.common.link'</span>).directive(<span class="hljs-string">'snLinkContentYoutube'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, $sce, inFrameSet</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'snLinkContentYoutube.xml'</span>),
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">link</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
      $scope.playerActive = <span class="hljs-literal">false</span>;
      $scope.width = (inFrameSet) ? <span class="hljs-string">'248px'</span> : <span class="hljs-string">'500px'</span>;
      $scope.height = (inFrameSet) ? <span class="hljs-string">'139px'</span> : <span class="hljs-string">'281px'</span>;
      $scope.showPlayer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $scope.playerActive = <span class="hljs-literal">true</span>;
      };
      $scope.getVideoEmbedLink = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.link.embedLink) {
          <span class="hljs-keyword">var</span> videoLink = $scope.link.embedLink + <span class="hljs-string">"?autoplay=1"</span>;
          <span class="hljs-keyword">return</span> $sce.trustAsHtml(<span class="hljs-string">"&lt;iframe width='"</span> + $scope.width + <span class="hljs-string">"' height='"</span> + $scope.height + <span class="hljs-string">"' autoplay='1' frameborder='0' allowfullscreen='' src='"</span> + videoLink + <span class="hljs-string">"'&gt;&lt;/iframe&gt;"</span>);
        }
      };
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/link/directive.snLinkContentSoundcloud.js */</span>
angular.module(<span class="hljs-string">'sn.common.link'</span>).directive(<span class="hljs-string">'snLinkContentSoundcloud'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, $sce, inFrameSet</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'snLinkContentSoundcloud.xml'</span>),
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">link</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
      $scope.playerActive = <span class="hljs-literal">false</span>;
      $scope.width = (inFrameSet) ? <span class="hljs-string">'248px'</span> : <span class="hljs-string">'500px'</span>;
      $scope.height = (inFrameSet) ? <span class="hljs-string">'139px'</span> : <span class="hljs-string">'281px'</span>;
      $scope.showPlayer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $scope.playerActive = <span class="hljs-literal">true</span>;
      };
      $scope.getVideoEmbedLink = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.link.embedLink) {
          <span class="hljs-keyword">var</span> videoLink = $scope.link.embedLink + <span class="hljs-string">"&amp;amp;auto_play=true"</span>;
          <span class="hljs-keyword">var</span> width = (inFrameSet) ? <span class="hljs-number">248</span> : <span class="hljs-number">500</span>;
          <span class="hljs-keyword">return</span> $sce.trustAsHtml(<span class="hljs-string">"&lt;iframe width='"</span> + $scope.width + <span class="hljs-string">"' height='"</span> + $scope.height + <span class="hljs-string">"' autoplay='1' frameborder='0' allowfullscreen='' src='"</span> + videoLink + <span class="hljs-string">"'&gt;&lt;/iframe&gt;"</span>);
        }
      };
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/link/directive.snLinkContentArticle.js */</span>
angular.module(<span class="hljs-string">'sn.common.link'</span>).directive(<span class="hljs-string">'snLinkContentArticle'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'snLinkContentArticle.xml'</span>),
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">link</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
      $scope.backgroundImageStyle = $scope.link.imageLink ?
        {
          <span class="hljs-string">"background-image"</span>: <span class="hljs-string">'url('</span> + $scope.link.imageLink + <span class="hljs-string">')'</span>
        } :
        {};
      $scope.isVisible = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> link = $scope.link;
        <span class="hljs-keyword">return</span> !!link.shortDescription || !!link.imageLink;
      };
      $scope.hasDescription = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> link = $scope.link;
        <span class="hljs-keyword">return</span> link.shortDescription &amp;&amp; (link.shortDescription !== link.title);
      };
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/link/directive.snLinkContentError.js */</span>
angular.module(<span class="hljs-string">'sn.common.link'</span>).directive(<span class="hljs-string">'snLinkContentError'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'snLinkContentError.xml'</span>),
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">link</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{}
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/link/directive.snLinkContentImage.js */</span>
angular.module(<span class="hljs-string">'sn.common.link'</span>).directive(<span class="hljs-string">'snLinkContentImage'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'snLinkContentImage.xml'</span>),
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">link</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{}
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/link/directive.snLinkContentAttachment.js */</span>
angular.module(<span class="hljs-string">'sn.common.link'</span>).directive(<span class="hljs-string">'snLinkContentAttachment'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'EA'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'snLinkContentAttachment.xml'</span>),
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">attachment</span>: <span class="hljs-string">'='</span>,
      <span class="hljs-attr">link</span>: <span class="hljs-string">'='</span>
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $element, snCustomEvent</span>) </span>{
      $scope.attachment = $scope.attachment || $scope.link.attachment;
      $scope.calcImageSize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> imageWidth = $scope.width;
        <span class="hljs-keyword">var</span> imageHeight = $scope.height;
        <span class="hljs-keyword">var</span> MAX_IMAGE_SIZE = $element.width() &lt; <span class="hljs-number">298</span> ? $element.width() : <span class="hljs-number">298</span>;
        <span class="hljs-keyword">if</span> (imageHeight &lt; <span class="hljs-number">0</span> || imageWidth &lt; <span class="hljs-number">0</span>)
          <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        <span class="hljs-keyword">if</span> (imageHeight &gt; imageWidth) {
          <span class="hljs-keyword">if</span> (imageHeight &gt;= MAX_IMAGE_SIZE) {
            imageWidth *= MAX_IMAGE_SIZE / imageHeight;
            imageHeight = MAX_IMAGE_SIZE;
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (imageWidth &gt;= MAX_IMAGE_SIZE) {
            imageHeight *= MAX_IMAGE_SIZE / imageWidth;
            imageWidth = MAX_IMAGE_SIZE
          }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"height: "</span> + imageHeight + <span class="hljs-string">"px; width: "</span> + imageWidth + <span class="hljs-string">"px;"</span>;
      };
      $scope.aspectRatioClass = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> ($scope.height &gt; $scope.width) ? <span class="hljs-string">'limit-height'</span> : <span class="hljs-string">'limit-width'</span>;
      };
      $scope.showImage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
        <span class="hljs-keyword">if</span> (event.keyCode === <span class="hljs-number">9</span>)
          <span class="hljs-keyword">return</span>;
        snCustomEvent.fire(<span class="hljs-string">'sn.attachment.preview'</span>, event, $scope.attachment.rawData);
      };
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/link/directive.snLinkContentRecord.js */</span>
angular.module(<span class="hljs-string">'sn.common.link'</span>).directive(<span class="hljs-string">'snLinkContentRecord'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'snLinkContentRecord.xml'</span>),
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">link</span>: <span class="hljs-string">'='</span>
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
      $scope.isTitleVisible = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> !$scope.isDescriptionVisible() &amp;&amp; $scope.link.title;
      };
      $scope.isDescriptionVisible = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> $scope.link.shortDescription;
      };
      $scope.hasNoHeader = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> !$scope.isTitleVisible() &amp;&amp; !$scope.isDescriptionVisible();
      };
      $scope.isUnassigned = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> $scope.link.isTask &amp;&amp; !$scope.link.avatarID;
      };
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/link/provider.linkContentTypes.js */</span>
angular.module(<span class="hljs-string">'sn.common.link'</span>).provider(<span class="hljs-string">'linkContentTypes'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">linkContentTypesProvider</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> linkDirectiveMap = {
    <span class="hljs-string">'record'</span>: <span class="hljs-string">"sn-link-content-record"</span>,
    <span class="hljs-string">'attachment'</span>: <span class="hljs-string">"sn-link-content-attachment"</span>,
    <span class="hljs-string">'video'</span>: <span class="hljs-string">"sn-link-content-youtube"</span>,
    <span class="hljs-string">'music.song'</span>: <span class="hljs-string">"sn-link-content-soundcloud"</span>,
    <span class="hljs-string">'link'</span>: <span class="hljs-string">'sn-link-content-article'</span>,
    <span class="hljs-string">'article'</span>: <span class="hljs-string">'sn-link-content-article'</span>,
    <span class="hljs-string">'website'</span>: <span class="hljs-string">'sn-link-content-article'</span>,
    <span class="hljs-string">'image'</span>: <span class="hljs-string">'sn-link-content-image'</span>
  };
  <span class="hljs-keyword">this</span>.$get = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">linkContentTypesFactory</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">forType</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">link</span>) </span>{
        <span class="hljs-keyword">if</span> (link.isUnauthorized)
          <span class="hljs-keyword">return</span> <span class="hljs-string">"sn-link-content-error"</span>;
        <span class="hljs-keyword">return</span> linkDirectiveMap[link.type] || <span class="hljs-string">"no-card"</span>;
      }
    }
  };
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/mention/js_includes_mention.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/mention/_module.js */</span>
angular.module(<span class="hljs-string">"sn.common.mention"</span>, []);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/mention/directive.snMentionPopover.js */</span>
angular.module(<span class="hljs-string">'sn.common.mention'</span>).directive(<span class="hljs-string">"snMentionPopover"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, $timeout</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'snMentionPopover.xml'</span>),
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, elem, $attrs</span>) </span>{
      elem.detach().appendTo(<span class="hljs-built_in">document</span>.body);
      scope.dontPositionManually = scope.$<span class="hljs-built_in">eval</span>($attrs.dontpositionmanually) || <span class="hljs-literal">false</span>;
      scope.onClick = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
        <span class="hljs-keyword">if</span> (!angular.element(event.target).closest(<span class="hljs-string">"#mention-popover"</span>).length ||
          angular.element(event.target).closest(<span class="hljs-string">"#direct-message-popover-trigger"</span>).length) {
          scope.$evalAsync(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            scope.$parent.showPopover = <span class="hljs-literal">false</span>;
            scope.$emit(<span class="hljs-string">"snMentionPopover.showPopoverIsFalse"</span>);
            <span class="hljs-keyword">if</span> (scope.dontPositionManually &amp;&amp; !(scope.$<span class="hljs-built_in">eval</span>($attrs.snavatarpopover))) {
              elem.remove();
            } <span class="hljs-keyword">else</span> {
              scope.$broadcast(<span class="hljs-string">"sn-avatar-popover-destroy"</span>);
            }
            angular.element(<span class="hljs-string">'.popover'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">var</span> object = angular.element(<span class="hljs-keyword">this</span>);
              <span class="hljs-keyword">if</span> (object.popover) {
                object.popover(<span class="hljs-string">'hide'</span>);
              }
            })
          });
        }
      };
      scope.clickListener = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        angular.element(<span class="hljs-string">'html'</span>).on(<span class="hljs-string">'click.mentionPopover'</span>, scope.onClick);
      }, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);
      scope.$on(<span class="hljs-string">'sn-bootstrap-popover.close-other-popovers'</span>, scope.onClick);

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setPopoverPosition</span>(<span class="hljs-params">clickX, clickY</span>) </span>{
        <span class="hljs-keyword">var</span> topPosition;
        <span class="hljs-keyword">var</span> leftPosition;
        <span class="hljs-keyword">var</span> windowHeight = <span class="hljs-built_in">window</span>.innerHeight;
        <span class="hljs-keyword">var</span> windowWidth = <span class="hljs-built_in">window</span>.innerWidth;
        <span class="hljs-keyword">if</span> (((clickY - (elem.height() / <span class="hljs-number">2</span>))) &lt; <span class="hljs-number">10</span>)
          topPosition = <span class="hljs-number">10</span>;
        <span class="hljs-keyword">else</span>
          topPosition = ((clickY + (elem.height() / <span class="hljs-number">2</span>)) &gt; windowHeight) ? windowHeight - elem.height() - <span class="hljs-number">15</span> : clickY - (elem.height() / <span class="hljs-number">2</span>);
        leftPosition = ((clickX + <span class="hljs-number">20</span> + (elem.width())) &gt; windowWidth) ? windowWidth - elem.width() - <span class="hljs-number">15</span> : clickX + <span class="hljs-number">20</span>;
        elem.css(<span class="hljs-string">"top"</span>, topPosition + <span class="hljs-string">"px"</span>).css(<span class="hljs-string">"left"</span>, leftPosition + <span class="hljs-string">"px"</span>);
      }
      <span class="hljs-keyword">if</span> (!scope.dontPositionManually) {
        $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">var</span> clickX = (scope.$parent &amp;&amp; scope.$parent.clickEvent &amp;&amp; scope.$parent.clickEvent.pageX) ? scope.$parent.clickEvent.pageX : clickX || <span class="hljs-number">300</span>;
          <span class="hljs-keyword">var</span> clickY = (scope.$parent &amp;&amp; scope.$parent.clickEvent &amp;&amp; scope.$parent.clickEvent.pageY) ? scope.$parent.clickEvent.pageY : clickY || <span class="hljs-number">300</span>;
          setPopoverPosition(clickX, clickY);
          elem.velocity({
            <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span>
          }, {
            <span class="hljs-attr">duration</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">easing</span>: <span class="hljs-string">"cubic"</span>
          });
        });
      }
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $element, $attrs</span>) </span>{
      $scope.profile = $scope.$<span class="hljs-built_in">eval</span>($attrs.profile);
      $scope.$on(<span class="hljs-string">"$destroy"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        angular.element(<span class="hljs-string">'html'</span>).off(<span class="hljs-string">'click.mentionPopover'</span>, $scope.onClick);
        $element.remove();
      });
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/mention/service.snMention.js */</span>
angular.module(<span class="hljs-string">"sn.common.mention"</span>).factory(<span class="hljs-string">"snMention"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">liveProfileID, $q, $http</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> MENTION_PATH = <span class="hljs-string">"/api/now/form/mention/record"</span>;
  <span class="hljs-keyword">var</span> USER_PATH = <span class="hljs-string">'/api/now/ui/user/'</span>;
  <span class="hljs-keyword">var</span> avatarCache = {};

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieveMembers</span>(<span class="hljs-params">table, document, term</span>) </span>{
    <span class="hljs-keyword">if</span> (!term || !<span class="hljs-built_in">document</span> || !table) {
      <span class="hljs-keyword">var</span> deferred = $q.defer();
      deferred.resolve([]);
      <span class="hljs-keyword">return</span> deferred.promise;
    }
    <span class="hljs-keyword">return</span> $http({
      <span class="hljs-attr">url</span>: MENTION_PATH + <span class="hljs-string">"/"</span> + table + <span class="hljs-string">"/"</span> + <span class="hljs-built_in">document</span>,
      <span class="hljs-attr">method</span>: <span class="hljs-string">"GET"</span>,
      <span class="hljs-attr">params</span>: {
        <span class="hljs-attr">term</span>: term
      }
    }).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
      <span class="hljs-keyword">var</span> members = response.data.result;
      <span class="hljs-keyword">var</span> promises = [];
      angular.forEach(members, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) </span>{
        <span class="hljs-keyword">if</span> (avatarCache[user.sys_id]) {
          user.initials = avatarCache[user.sys_id].initials;
          user.avatar = avatarCache[user.sys_id].avatar;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> promise = $http.get(USER_PATH + user.sys_id).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
            user.initials = response.result.user_initials;
            user.avatar = response.result.user_avatar;
            avatarCache[user.sys_id] = {
              <span class="hljs-attr">initials</span>: user.initials,
              <span class="hljs-attr">avatar</span>: user.avatar
            };
          });
          promises.push(promise);
        }
      });
      <span class="hljs-keyword">return</span> $q.all(promises).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> members;
      });
    })
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">retrieveMembers</span>: retrieveMembers
  }
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/messaging/js_includes_messaging.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/doctype/CustomEventManager.js */</span>
<span class="hljs-keyword">var</span> NOW = NOW || {};
<span class="hljs-keyword">var</span> CustomEventManager = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">existingCustomEvent</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> events = (existingCustomEvent &amp;&amp; existingCustomEvent.events) || {};
  <span class="hljs-keyword">var</span> isFiringFlag = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> trace = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> suppressEvents = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> NOW_MSG = <span class="hljs-string">'NOW.PostMessage'</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">observe</span>(<span class="hljs-params">eventName, fn</span>) </span>{
    <span class="hljs-keyword">if</span> (trace)
      jslog(<span class="hljs-string">"$CustomEventManager observing: "</span> + eventName);
    on(eventName, fn);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">on</span>(<span class="hljs-params">name, func</span>) </span>{
    <span class="hljs-keyword">if</span> (!func || <span class="hljs-keyword">typeof</span> func !== <span class="hljs-string">'function'</span>)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'undefined'</span>)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (!events[name])
      events[name] = [];
    events[name].push(func);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">un</span>(<span class="hljs-params">name, func</span>) </span>{
    <span class="hljs-keyword">if</span> (!events[name])
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> idx = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; events[name].length; i++) {
      <span class="hljs-keyword">if</span> (events[name][i] === func) {
        idx = i;
        <span class="hljs-keyword">break</span>;
      }
    }
    <span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span>)
      events[name].splice(idx, <span class="hljs-number">1</span>)
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unAll</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">if</span> (events[name])
      <span class="hljs-keyword">delete</span> events[name];
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fire</span>(<span class="hljs-params">eventName, args</span>) </span>{
    <span class="hljs-keyword">if</span> (trace)
      jslog(<span class="hljs-string">"$CustomEventManager firing: "</span> + eventName + <span class="hljs-string">" args: "</span> + <span class="hljs-built_in">arguments</span>.length);
    <span class="hljs-keyword">return</span> fireEvent.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fireUp</span>(<span class="hljs-params">eventName, args</span>) </span>{
    <span class="hljs-keyword">var</span> win = <span class="hljs-built_in">window</span>;
    <span class="hljs-keyword">while</span> (win) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (win.CustomEvent.fireEvent.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>) === <span class="hljs-literal">false</span>)
          <span class="hljs-keyword">return</span>;
        win = win.parent === win ? <span class="hljs-literal">null</span> : win.parent;
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-keyword">return</span>;
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fireEvent</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (suppressEvents)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.apply(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> name = args.shift();
    <span class="hljs-keyword">var</span> eventList = events[name];
    <span class="hljs-keyword">if</span> (!eventList)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> event = eventList.slice();
    isFiringFlag = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = event.length; i &lt; l; i++) {
      <span class="hljs-keyword">var</span> ev = event[i];
      <span class="hljs-keyword">if</span> (!ev)
        <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">if</span> (ev.apply(<span class="hljs-literal">null</span>, args) === <span class="hljs-literal">false</span>) {
        isFiringFlag = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }
    isFiringFlag = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isFiring</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> isFiringFlag;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">forward</span>(<span class="hljs-params">name, element, func</span>) </span>{
    on(name, func);
    element.addEventListener(name, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
      fireEvent(e.type, <span class="hljs-keyword">this</span>, e);
    }.bind(api));
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerPostMessageEvent</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (NOW.registeredPostMessageEvent) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">window</span>.postMessage) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
      <span class="hljs-keyword">var</span> nowMessageJSON = event.data;
      <span class="hljs-keyword">var</span> nowMessage;
      <span class="hljs-keyword">try</span> {
        nowMessage = <span class="hljs-built_in">JSON</span>.parse(nowMessageJSON.toString());
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">if</span> (!nowMessage.type == NOW_MSG) {
        <span class="hljs-keyword">return</span>;
      }
      fire(nowMessage.eventName, nowMessage.args);
    }, <span class="hljs-literal">false</span>);
    NOW.registeredPostMessageEvent = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doPostMessage</span>(<span class="hljs-params">win, event, msg, targetOrigin</span>) </span>{
    <span class="hljs-keyword">var</span> nowMessage = {
      <span class="hljs-attr">type</span>: NOW_MSG,
      <span class="hljs-attr">eventName</span>: event,
      <span class="hljs-attr">args</span>: msg
    };
    <span class="hljs-keyword">var</span> nowMessageJSON;
    <span class="hljs-keyword">if</span> (!win || !win.postMessage) {
      <span class="hljs-keyword">return</span>
    }
    nowMessageJSON = <span class="hljs-built_in">JSON</span>.stringify(nowMessage);
    win.postMessage(nowMessageJSON, targetOrigin);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fireTop</span>(<span class="hljs-params">eventName, args</span>) </span>{
    <span class="hljs-keyword">if</span> (trace)
      jslog(<span class="hljs-string">"$CustomEventManager firing: "</span> + eventName + <span class="hljs-string">" args: "</span> + <span class="hljs-built_in">arguments</span>.length);
    fireEvent.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> t = getTopWindow();
    <span class="hljs-keyword">if</span> (t !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">window</span> !== t)
      t.CustomEvent.fire(eventName, args);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fireAll</span>(<span class="hljs-params">eventName, args</span>) </span>{
    <span class="hljs-keyword">if</span> (trace)
      jslog(<span class="hljs-string">"$CustomEventManager firing: "</span> + eventName + <span class="hljs-string">" args: "</span> + <span class="hljs-built_in">arguments</span>.length);
    <span class="hljs-keyword">var</span> topWindow = getTopWindow();
    notifyAllFrom(topWindow);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notifyAllFrom</span>(<span class="hljs-params">rootFrame</span>) </span>{
      <span class="hljs-keyword">var</span> childFrame;
      rootFrame.CustomEvent.fireEvent(eventName, args);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; rootFrame.length; i++) {
        <span class="hljs-keyword">try</span> {
          childFrame = rootFrame[i];
          <span class="hljs-keyword">if</span> (!childFrame)
            <span class="hljs-keyword">continue</span>;
          <span class="hljs-keyword">if</span> (childFrame.CustomEvent &amp;&amp; <span class="hljs-keyword">typeof</span> childFrame.CustomEvent.fireEvent === <span class="hljs-string">"function"</span>) {
            notifyAllFrom(childFrame);
          }
        } <span class="hljs-keyword">catch</span> (e) {}
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fireToWindow</span>(<span class="hljs-params">targetWindow, eventName, args, usePostMessage, targetOrigin</span>) </span>{
    <span class="hljs-keyword">if</span> (trace)
      jslog(<span class="hljs-string">"$CustomEventManager firing: "</span> + eventName + <span class="hljs-string">" args: "</span> + args.length);
    <span class="hljs-keyword">if</span> (usePostMessage) {
      doPostMessage(targetWindow, eventName, args, targetOrigin);
    } <span class="hljs-keyword">else</span> {
      targetWindow.CustomEvent.fireEvent(eventName, args);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTopWindow</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> topWindow = <span class="hljs-built_in">window</span>.self;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">while</span> (topWindow.CustomEvent.fireEvent &amp;&amp; topWindow !== topWindow.parent &amp;&amp; topWindow.parent.CustomEvent.fireEvent) {
        topWindow = topWindow.parent;
      }
    } <span class="hljs-keyword">catch</span> (e) {}
    <span class="hljs-keyword">return</span> topWindow;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isTopWindow</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> getTopWindow() == <span class="hljs-built_in">window</span>.self;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">jslog</span>(<span class="hljs-params">msg, src, dateTime</span>) </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (!src) {
        <span class="hljs-keyword">var</span> path = <span class="hljs-built_in">window</span>.self.location.pathname;
        src = path.substring(path.lastIndexOf(<span class="hljs-string">'/'</span>) + <span class="hljs-number">1</span>);
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.self.opener &amp;&amp; <span class="hljs-built_in">window</span> != <span class="hljs-built_in">window</span>.self.opener) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.self.opener.jslog) {
          <span class="hljs-built_in">window</span>.self.opener.jslog(msg, src, dateTime);
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parent &amp;&amp; parent.jslog &amp;&amp; jslog != parent.jslog) {
        parent.jslog(msg, src, dateTime);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.console &amp;&amp; <span class="hljs-built_in">window</span>.console.log)
          <span class="hljs-built_in">console</span>.log(msg);
      }
    } <span class="hljs-keyword">catch</span> (e) {}
  }
  <span class="hljs-keyword">var</span> api = {
    set trace(value) {
      trace = !!value;
    },
    get trace() {
      <span class="hljs-keyword">return</span> trace;
    },
    set suppressEvents(value) {
      suppressEvents = !!value;
    },
    get suppressEvents() {
      <span class="hljs-keyword">return</span> suppressEvents;
    },
    get events() {
      <span class="hljs-keyword">return</span> events;
    },
    <span class="hljs-attr">on</span>: on,
    <span class="hljs-attr">un</span>: un,
    <span class="hljs-attr">unAll</span>: unAll,
    <span class="hljs-attr">forward</span>: forward,
    <span class="hljs-attr">isFiring</span>: isFiring,
    <span class="hljs-attr">fireEvent</span>: fireEvent,
    <span class="hljs-attr">observe</span>: observe,
    <span class="hljs-attr">fire</span>: fire,
    <span class="hljs-attr">fireTop</span>: fireTop,
    <span class="hljs-attr">fireAll</span>: fireAll,
    <span class="hljs-attr">fireToWindow</span>: fireToWindow,
    <span class="hljs-attr">isTopWindow</span>: isTopWindow,
    <span class="hljs-attr">fireUp</span>: fireUp,
    <span class="hljs-attr">toString</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-string">'CustomEventManager'</span>;
    }
  };
  registerPostMessageEvent();
  <span class="hljs-keyword">return</span> api;
})(NOW.CustomEvent);
NOW.CustomEvent = CustomEventManager;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> CustomEvent !== <span class="hljs-string">"undefined"</span>) {
  CustomEvent.observe = NOW.CustomEvent.observe.bind(NOW.CustomEvent);
  CustomEvent.fire = NOW.CustomEvent.fire.bind(NOW.CustomEvent);
  CustomEvent.fireUp = NOW.CustomEvent.fireUp.bind(NOW.CustomEvent);
  CustomEvent.fireTop = NOW.CustomEvent.fireTop.bind(NOW.CustomEvent);
  CustomEvent.fireAll = NOW.CustomEvent.fireAll.bind(NOW.CustomEvent);
  CustomEvent.fireToWindow = NOW.CustomEvent.fireToWindow.bind(NOW.CustomEvent);
  CustomEvent.on = NOW.CustomEvent.on.bind(NOW.CustomEvent);
  CustomEvent.un = NOW.CustomEvent.un.bind(NOW.CustomEvent);
  CustomEvent.unAll = NOW.CustomEvent.unAll.bind(NOW.CustomEvent);
  CustomEvent.forward = NOW.CustomEvent.forward.bind(NOW.CustomEvent);
  CustomEvent.isFiring = NOW.CustomEvent.isFiring.bind(NOW.CustomEvent);
  CustomEvent.fireEvent = NOW.CustomEvent.fireEvent.bind(NOW.CustomEvent);
  CustomEvent.events = NOW.CustomEvent.events;
  CustomEvent.isTopWindow = NOW.CustomEvent.isTopWindow.bind(NOW.CustomEvent);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-built_in">window</span>.CustomEvent = NOW.CustomEvent;
};
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/messaging/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.messaging'</span>, []);
angular.module(<span class="hljs-string">'sn.messaging'</span>, [<span class="hljs-string">'sn.common.messaging'</span>]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/messaging/service.snCustomEvent.js */</span>
angular.module(<span class="hljs-string">'sn.common.messaging'</span>).factory(<span class="hljs-string">'snCustomEvent'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> NOW.CustomEvent === <span class="hljs-string">'undefined'</span>)
    <span class="hljs-keyword">throw</span> <span class="hljs-string">"CustomEvent not found in NOW global"</span>;
  <span class="hljs-keyword">return</span> NOW.CustomEvent;
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/notification/js_includes_notification.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/notification/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.notification'</span>, [<span class="hljs-string">'sn.common.util'</span>, <span class="hljs-string">'ngSanitize'</span>]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/notification/factory.notificationWrapper.js */</span>
angular.module(<span class="hljs-string">"sn.common.notification"</span>).factory(<span class="hljs-string">"snNotificationWrapper"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$window, $timeout</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assignHandler</span>(<span class="hljs-params">notification, handlerName, options</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options[handlerName] === <span class="hljs-string">"function"</span>)
      notification[handlerName.toLowerCase()] = options[handlerName];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NotificationWrapper</span>(<span class="hljs-params">title, options</span>) </span>{
    <span class="hljs-keyword">var</span> defaults = {
      <span class="hljs-attr">dir</span>: <span class="hljs-string">'auto'</span>,
      <span class="hljs-attr">lang</span>: <span class="hljs-string">'en_US'</span>,
      <span class="hljs-attr">decay</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">lifespan</span>: <span class="hljs-number">4000</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">tag</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">icon</span>: <span class="hljs-string">'/native_notification_icon.png'</span>
    };
    <span class="hljs-keyword">var</span> optionsOnClick = options.onClick;
    options.onClick = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (angular.isFunction($<span class="hljs-built_in">window</span>.focus))
        $<span class="hljs-built_in">window</span>.focus();
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> optionsOnClick === <span class="hljs-string">"function"</span>)
        optionsOnClick();
    }
    <span class="hljs-keyword">var</span> result = {};
    options = angular.extend(defaults, options);
    <span class="hljs-keyword">var</span> previousOnClose = options.onClose;
    options.onClose = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (angular.isFunction(result.onclose))
        result.onclose();
      <span class="hljs-keyword">if</span> (angular.isFunction(previousOnClose))
        previousOnClose();
    }
    <span class="hljs-keyword">var</span> notification = <span class="hljs-keyword">new</span> $<span class="hljs-built_in">window</span>.Notification(title, options);
    assignHandler(notification, <span class="hljs-string">"onShow"</span>, options);
    assignHandler(notification, <span class="hljs-string">"onClick"</span>, options);
    assignHandler(notification, <span class="hljs-string">"onError"</span>, options);
    assignHandler(notification, <span class="hljs-string">"onClose"</span>, options);
    <span class="hljs-keyword">if</span> (options.decay &amp;&amp; options.lifespan &gt; <span class="hljs-number">0</span>)
      $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        notification.close();
      }, options.lifespan)
    result.close = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      notification.close();
    }
    <span class="hljs-keyword">return</span> result;
  }
});
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/notification/service.snNotifier.js */</span>
angular.module(<span class="hljs-string">"sn.common.notification"</span>).factory(<span class="hljs-string">"snNotifier"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$window, snNotificationWrapper</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">settings</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requestNotificationPermission</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> ($<span class="hljs-built_in">window</span>.Notification &amp;&amp; $<span class="hljs-built_in">window</span>.Notification.permission === <span class="hljs-string">"default"</span>)
        $<span class="hljs-built_in">window</span>.Notification.requestPermission();
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canUseNativeNotifications</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ($<span class="hljs-built_in">window</span>.Notification &amp;&amp; $<span class="hljs-built_in">window</span>.Notification.permission === <span class="hljs-string">"granted"</span>);
    }
    <span class="hljs-keyword">var</span> currentNotifications = [];
    settings = angular.extend({
      <span class="hljs-attr">notifyMethods</span>: [<span class="hljs-string">"native"</span>, <span class="hljs-string">"glide"</span>]
    }, settings);
    <span class="hljs-keyword">var</span> methods = {
      <span class="hljs-string">'native'</span>: nativeNotify,
      <span class="hljs-string">'glide'</span>: glideNotify
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nativeNotify</span>(<span class="hljs-params">title, options</span>) </span>{
      <span class="hljs-keyword">if</span> (canUseNativeNotifications()) {
        <span class="hljs-keyword">var</span> newNotification = snNotificationWrapper(title, options);
        newNotification.onclose = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          stopTrackingNotification(newNotification)
        };
        currentNotifications.push(newNotification);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">glideNotify</span>(<span class="hljs-params">title, options</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stopTrackingNotification</span>(<span class="hljs-params">newNotification</span>) </span>{
      <span class="hljs-keyword">var</span> index = currentNotifications.indexOf(newNotification);
      <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">-1</span>)
        currentNotifications.splice(index, <span class="hljs-number">1</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notify</span>(<span class="hljs-params">title, options</span>) </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">"string"</span>)
        options = {
          <span class="hljs-attr">body</span>: options
        };
      options = options || {};
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = settings.notifyMethods.length; i &lt; len; i++)
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> settings.notifyMethods[i] == <span class="hljs-string">"string"</span>) {
          <span class="hljs-keyword">if</span> (methods[settings.notifyMethods[i]](title, options))
            <span class="hljs-keyword">break</span>;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (settings.notifyMethods[i](title, options))
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearAllNotifications</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">while</span> (currentNotifications.length &gt; <span class="hljs-number">0</span>)
        currentNotifications.pop().close();
    }
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">notify</span>: notify,
      <span class="hljs-attr">canUseNativeNotifications</span>: canUseNativeNotifications,
      <span class="hljs-attr">clearAllNotifications</span>: clearAllNotifications,
      <span class="hljs-attr">requestNotificationPermission</span>: requestNotificationPermission
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/notification/directive.snNotification.js */</span>
angular.module(<span class="hljs-string">'sn.common.notification'</span>).directive(<span class="hljs-string">'snNotification'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout, $rootScope</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;div class="notification-container"&gt;&lt;/div&gt;'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
      scope.addNotification = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">payload</span>) </span>{
          <span class="hljs-keyword">if</span> (!payload)
            payload = {};
          <span class="hljs-keyword">if</span> (!payload.text)
            payload.text = <span class="hljs-string">''</span>;
          <span class="hljs-keyword">if</span> (!payload.classes)
            payload.classes = <span class="hljs-string">''</span>;
          <span class="hljs-keyword">if</span> (!payload.duration)
            payload.duration = <span class="hljs-number">5000</span>;
          angular.element(<span class="hljs-string">'&lt;div/&gt;'</span>).qtip({
            <span class="hljs-attr">content</span>: {
              <span class="hljs-attr">text</span>: payload.text,
              <span class="hljs-attr">title</span>: {
                <span class="hljs-attr">button</span>: <span class="hljs-literal">false</span>
              }
            },
            <span class="hljs-attr">position</span>: {
              <span class="hljs-attr">target</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],
              <span class="hljs-attr">container</span>: angular.element(<span class="hljs-string">'.notification-container'</span>)
            },
            <span class="hljs-attr">show</span>: {
              <span class="hljs-attr">event</span>: <span class="hljs-literal">false</span>,
              <span class="hljs-attr">ready</span>: <span class="hljs-literal">true</span>,
              <span class="hljs-attr">effect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                angular.element(<span class="hljs-keyword">this</span>).stop(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>).animate({
                  <span class="hljs-attr">height</span>: <span class="hljs-string">'toggle'</span>
                }, <span class="hljs-number">400</span>, <span class="hljs-string">'swing'</span>);
              },
              <span class="hljs-attr">delay</span>: <span class="hljs-number">0</span>,
              <span class="hljs-attr">persistent</span>: <span class="hljs-literal">false</span>
            },
            <span class="hljs-attr">hide</span>: {
              <span class="hljs-attr">event</span>: <span class="hljs-literal">false</span>,
              <span class="hljs-attr">effect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">api</span>) </span>{
                angular.element(<span class="hljs-keyword">this</span>).stop(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>).animate({
                  <span class="hljs-attr">height</span>: <span class="hljs-string">'toggle'</span>
                }, <span class="hljs-number">400</span>, <span class="hljs-string">'swing'</span>);
              }
            },
            <span class="hljs-attr">style</span>: {
              <span class="hljs-attr">classes</span>: <span class="hljs-string">'jgrowl'</span> + <span class="hljs-string">' '</span> + payload.classes,
              <span class="hljs-attr">tip</span>: <span class="hljs-literal">false</span>
            },
            <span class="hljs-attr">events</span>: {
              <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, api</span>) </span>{
                <span class="hljs-keyword">if</span> (!api.options.show.persistent) {
                  angular.element(<span class="hljs-keyword">this</span>).bind(<span class="hljs-string">'mouseover mouseout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
                      clearTimeout(api.timer);
                      <span class="hljs-keyword">if</span> (e.type !== <span class="hljs-string">'mouseover'</span>) {
                        api.timer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                          api.hide(e);
                        }, payload.duration);
                      }
                    })
                    .triggerHandler(<span class="hljs-string">'mouseout'</span>);
                }
              }
            }
          });
        },
        scope.$on(<span class="hljs-string">'notification.notify'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, payload</span>) </span>{
          scope.addNotification(payload);
        });
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/notification/service.snNotification.js */</span>
angular.module(<span class="hljs-string">'sn.common.notification'</span>).factory(<span class="hljs-string">'snNotification'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$document, $templateCache, $compile, $rootScope,
  $timeout, $q, getTemplateUrl, $http</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">var</span> openNotifications = [],
    timeouts = {},
    options = {
      <span class="hljs-attr">top</span>: <span class="hljs-number">20</span>,
      <span class="hljs-attr">gap</span>: <span class="hljs-number">10</span>,
      <span class="hljs-attr">duration</span>: <span class="hljs-number">5000</span>
    };
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">show</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, message, duration, onClick</span>) </span>{
      <span class="hljs-keyword">return</span> createNotificationElement(type, message).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element</span>) </span>{
        displayNotification(element);
        checkAndSetDestroyDuration(element, duration);
        <span class="hljs-keyword">return</span> element;
      });
    },
    <span class="hljs-attr">hide</span>: hide,
    <span class="hljs-attr">setOptions</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">opts</span>) </span>{
      <span class="hljs-keyword">if</span> (angular.isObject(opts))
        angular.extend(options, opts);
    }
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTemplate</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> templateName = <span class="hljs-string">'sn_notification.xml'</span>,
      template = $templateCache.get(templateName),
      deferred = $q.defer();
    <span class="hljs-keyword">if</span> (!template) {
      <span class="hljs-keyword">var</span> url = getTemplateUrl(templateName);
      $http.get(url).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">result</span>) </span>{
          $templateCache.put(templateName, result.data);
          deferred.resolve(result.data);
        },
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reason</span>) </span>{
          <span class="hljs-keyword">return</span> $q.reject(reason);
        });
    } <span class="hljs-keyword">else</span>
      deferred.resolve(template);
    <span class="hljs-keyword">return</span> deferred.promise;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createNotificationElement</span>(<span class="hljs-params">type, message</span>) </span>{
    <span class="hljs-keyword">var</span> thisScope, thisElement;
    <span class="hljs-keyword">return</span> getTemplate().then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">template</span>) </span>{
      thisScope = $rootScope.$<span class="hljs-keyword">new</span>();
      thisScope.type = type;
      thisScope.message = message;
      thisElement = $compile(template)(thisScope);
      <span class="hljs-keyword">return</span> angular.element(thisElement[<span class="hljs-number">0</span>]);
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">displayNotification</span>(<span class="hljs-params">element</span>) </span>{
    <span class="hljs-keyword">var</span> body = $<span class="hljs-built_in">document</span>.find(<span class="hljs-string">'body'</span>),
      id = <span class="hljs-string">'elm'</span> + <span class="hljs-built_in">Date</span>.now(),
      pos;
    body.append(element);
    pos = options.top + openNotifications.length * getElementHeight(element);
    positionElement(element, pos);
    element.addClass(<span class="hljs-string">'visible'</span>);
    element.attr(<span class="hljs-string">'id'</span>, id);
    element.find(<span class="hljs-string">'button'</span>).bind(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
      hideElement(element);
    });
    openNotifications.push(element);
    <span class="hljs-keyword">if</span> (options.duration &gt; <span class="hljs-number">0</span>)
      timeouts[id] = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        hideNext();
      }, options.duration);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hide</span>(<span class="hljs-params">element</span>) </span>{
    $timeout.cancel(timeouts[element.attr(<span class="hljs-string">'id'</span>)]);
    element.removeClass(<span class="hljs-string">'visible'</span>);
    element.addClass(<span class="hljs-string">'hidden'</span>);
    element.find(<span class="hljs-string">'button'</span>).eq(<span class="hljs-number">0</span>).unbind();
    element.scope().$destroy();
    element.remove();
    repositionAll();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hideElement</span>(<span class="hljs-params">element</span>) </span>{
    <span class="hljs-keyword">var</span> index = openNotifications.indexOf(element);
    openNotifications.splice(index, <span class="hljs-number">1</span>);
    hide(element);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hideNext</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> element = openNotifications.shift();
    <span class="hljs-keyword">if</span> (element)
      hide(element);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getElementHeight</span>(<span class="hljs-params">element</span>) </span>{
    <span class="hljs-keyword">return</span> element[<span class="hljs-number">0</span>].offsetHeight + options.gap;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">positionElement</span>(<span class="hljs-params">element, pos</span>) </span>{
    element[<span class="hljs-number">0</span>].style.top = pos + <span class="hljs-string">'px'</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">repositionAll</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> pos = options.top;
    openNotifications.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element</span>) </span>{
      positionElement(element, pos);
      pos += getElementHeight(element);
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkAndSetDestroyDuration</span>(<span class="hljs-params">element, duration</span>) </span>{
    <span class="hljs-keyword">if</span> (duration) {
      timeouts[element.attr(<span class="hljs-string">'id'</span>)] = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        hideElement(element);
      }, duration);
    }
  }
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/js_includes_presence.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/js_includes_ng_amb.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/js_includes_amb.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/thirdparty/cometd/org/cometd.js */</span>
<span class="hljs-keyword">this</span>.org = <span class="hljs-keyword">this</span>.org || {};
org.cometd = {};
org.cometd.JSON = {};
org.cometd.JSON.toJSON = org.cometd.JSON.fromJSON = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">object</span>) </span>{
  <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
};
org.cometd.Utils = {};
org.cometd.Utils.isString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> || value === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span> || value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">String</span>;
};
org.cometd.Utils.isArray = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> || value === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>;
};
org.cometd.Utils.inArray = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element, array</span>) </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; array.length; ++i) {
    <span class="hljs-keyword">if</span> (element === array[i]) {
      <span class="hljs-keyword">return</span> i;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
};
org.cometd.Utils.setTimeout = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cometd, funktion, delay</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">try</span> {
      funktion();
    } <span class="hljs-keyword">catch</span> (x) {
      cometd._debug(<span class="hljs-string">'Exception invoking timed function'</span>, funktion, x);
    }
  }, delay);
};
org.cometd.Utils.clearTimeout = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">timeoutHandle</span>) </span>{
  <span class="hljs-built_in">window</span>.clearTimeout(timeoutHandle);
};
org.cometd.TransportRegistry = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _types = [];
  <span class="hljs-keyword">var</span> _transports = {};
  <span class="hljs-keyword">this</span>.getTransportTypes = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _types.slice(<span class="hljs-number">0</span>);
  };
  <span class="hljs-keyword">this</span>.findTransportTypes = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">var</span> result = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      <span class="hljs-keyword">var</span> type = _types[i];
      <span class="hljs-keyword">if</span> (_transports[type].accept(version, crossDomain, url) === <span class="hljs-literal">true</span>) {
        result.push(type);
      }
    }
    <span class="hljs-keyword">return</span> result;
  };
  <span class="hljs-keyword">this</span>.negotiateTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">types, version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      <span class="hljs-keyword">var</span> type = _types[i];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; types.length; ++j) {
        <span class="hljs-keyword">if</span> (type === types[j]) {
          <span class="hljs-keyword">var</span> transport = _transports[type];
          <span class="hljs-keyword">if</span> (transport.accept(version, crossDomain, url) === <span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">return</span> transport;
          }
        }
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };
  <span class="hljs-keyword">this</span>.add = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, transport, index</span>) </span>{
    <span class="hljs-keyword">var</span> existing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      <span class="hljs-keyword">if</span> (_types[i] === type) {
        existing = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">break</span>;
      }
    }
    <span class="hljs-keyword">if</span> (!existing) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> index !== <span class="hljs-string">'number'</span>) {
        _types.push(type);
      } <span class="hljs-keyword">else</span> {
        _types.splice(index, <span class="hljs-number">0</span>, type);
      }
      _transports[type] = transport;
    }
    <span class="hljs-keyword">return</span> !existing;
  };
  <span class="hljs-keyword">this</span>.find = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      <span class="hljs-keyword">if</span> (_types[i] === type) {
        <span class="hljs-keyword">return</span> _transports[type];
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };
  <span class="hljs-keyword">this</span>.remove = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      <span class="hljs-keyword">if</span> (_types[i] === type) {
        _types.splice(i, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">var</span> transport = _transports[type];
        <span class="hljs-keyword">delete</span> _transports[type];
        <span class="hljs-keyword">return</span> transport;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };
  <span class="hljs-keyword">this</span>.clear = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _types = [];
    _transports = {};
  };
  <span class="hljs-keyword">this</span>.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _types.length; ++i) {
      _transports[_types[i]].reset();
    }
  };
};
org.cometd.Transport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _type;
  <span class="hljs-keyword">var</span> _cometd;
  <span class="hljs-keyword">this</span>.registered = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, cometd</span>) </span>{
    _type = type;
    _cometd = cometd;
  };
  <span class="hljs-keyword">this</span>.unregistered = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _type = <span class="hljs-literal">null</span>;
    _cometd = <span class="hljs-literal">null</span>;
  };
  <span class="hljs-keyword">this</span>._debug = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _cometd._debug.apply(_cometd, <span class="hljs-built_in">arguments</span>);
  };
  <span class="hljs-keyword">this</span>._mixin = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _cometd._mixin.apply(_cometd, <span class="hljs-built_in">arguments</span>);
  };
  <span class="hljs-keyword">this</span>.getConfiguration = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _cometd.getConfiguration();
  };
  <span class="hljs-keyword">this</span>.getAdvice = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _cometd.getAdvice();
  };
  <span class="hljs-keyword">this</span>.setTimeout = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">funktion, delay</span>) </span>{
    <span class="hljs-keyword">return</span> org.cometd.Utils.setTimeout(_cometd, funktion, delay);
  };
  <span class="hljs-keyword">this</span>.clearTimeout = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handle</span>) </span>{
    org.cometd.Utils.clearTimeout(handle);
  };
  <span class="hljs-keyword">this</span>.convertToMessages = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
    <span class="hljs-keyword">if</span> (org.cometd.Utils.isString(response)) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> org.cometd.JSON.fromJSON(response);
      } <span class="hljs-keyword">catch</span> (x) {
        <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Could not convert to JSON the following string'</span>, <span class="hljs-string">'"'</span> + response + <span class="hljs-string">'"'</span>);
        <span class="hljs-keyword">throw</span> x;
      }
    }
    <span class="hljs-keyword">if</span> (org.cometd.Utils.isArray(response)) {
      <span class="hljs-keyword">return</span> response;
    }
    <span class="hljs-keyword">if</span> (response === <span class="hljs-literal">undefined</span> || response === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> [];
    }
    <span class="hljs-keyword">if</span> (response <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Object</span>) {
      <span class="hljs-keyword">return</span> [response];
    }
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Conversion Error '</span> + response + <span class="hljs-string">', typeof '</span> + (<span class="hljs-keyword">typeof</span> response);
  };
  <span class="hljs-keyword">this</span>.accept = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
  };
  <span class="hljs-keyword">this</span>.getType = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _type;
  };
  <span class="hljs-keyword">this</span>.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, metaConnect</span>) </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
  };
  <span class="hljs-keyword">this</span>.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, _type, <span class="hljs-string">'reset'</span>);
  };
  <span class="hljs-keyword">this</span>.abort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, _type, <span class="hljs-string">'aborted'</span>);
  };
  <span class="hljs-keyword">this</span>.toString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getType();
  };
};
org.cometd.Transport.derive = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">baseObject</span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">F</span>(<span class="hljs-params"></span>) </span>{}
  F.prototype = baseObject;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> F();
};
org.cometd.RequestTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org.cometd.Transport();
  <span class="hljs-keyword">var</span> _self = org.cometd.Transport.derive(_super);
  <span class="hljs-keyword">var</span> _requestIds = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> _metaConnectRequest = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> _requests = [];
  <span class="hljs-keyword">var</span> _envelopes = [];

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_coalesceEnvelopes</span>(<span class="hljs-params">envelope</span>) </span>{
    <span class="hljs-keyword">while</span> (_envelopes.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> envelopeAndRequest = _envelopes[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> newEnvelope = envelopeAndRequest[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> newRequest = envelopeAndRequest[<span class="hljs-number">1</span>];
      <span class="hljs-keyword">if</span> (newEnvelope.url === envelope.url &amp;&amp;
        newEnvelope.sync === envelope.sync) {
        _envelopes.shift();
        envelope.messages = envelope.messages.concat(newEnvelope.messages);
        <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Coalesced'</span>, newEnvelope.messages.length, <span class="hljs-string">'messages from request'</span>, newRequest.id);
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_transportSend</span>(<span class="hljs-params">envelope, request</span>) </span>{
    <span class="hljs-keyword">this</span>.transportSend(envelope, request);
    request.expired = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (!envelope.sync) {
      <span class="hljs-keyword">var</span> maxDelay = <span class="hljs-keyword">this</span>.getConfiguration().maxNetworkDelay;
      <span class="hljs-keyword">var</span> delay = maxDelay;
      <span class="hljs-keyword">if</span> (request.metaConnect === <span class="hljs-literal">true</span>) {
        delay += <span class="hljs-keyword">this</span>.getAdvice().timeout;
      }
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'waiting at most'</span>, delay, <span class="hljs-string">'ms for the response, maxNetworkDelay'</span>, maxDelay);
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
      request.timeout = <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        request.expired = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">var</span> errorMessage = <span class="hljs-string">'Request '</span> + request.id + <span class="hljs-string">' of transport '</span> + self.getType() + <span class="hljs-string">' exceeded '</span> + delay + <span class="hljs-string">' ms max network delay'</span>;
        <span class="hljs-keyword">var</span> failure = {
          <span class="hljs-attr">reason</span>: errorMessage
        };
        <span class="hljs-keyword">var</span> xhr = request.xhr;
        failure.httpCode = self.xhrStatus(xhr);
        self.abortXHR(xhr);
        self._debug(errorMessage);
        self.complete(request, <span class="hljs-literal">false</span>, request.metaConnect);
        envelope.onFailure(xhr, envelope.messages, failure);
      }, delay);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_queueSend</span>(<span class="hljs-params">envelope</span>) </span>{
    <span class="hljs-keyword">var</span> requestId = ++_requestIds;
    <span class="hljs-keyword">var</span> request = {
      <span class="hljs-attr">id</span>: requestId,
      <span class="hljs-attr">metaConnect</span>: <span class="hljs-literal">false</span>
    };
    <span class="hljs-keyword">if</span> (_requests.length &lt; <span class="hljs-keyword">this</span>.getConfiguration().maxConnections - <span class="hljs-number">1</span>) {
      _requests.push(request);
      _transportSend.call(<span class="hljs-keyword">this</span>, envelope, request);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'queueing request'</span>, requestId, <span class="hljs-string">'envelope'</span>, envelope);
      _envelopes.push([envelope, request]);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_metaConnectComplete</span>(<span class="hljs-params">request</span>) </span>{
    <span class="hljs-keyword">var</span> requestId = request.id;
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'metaConnect complete, request'</span>, requestId);
    <span class="hljs-keyword">if</span> (_metaConnectRequest !== <span class="hljs-literal">null</span> &amp;&amp; _metaConnectRequest.id !== requestId) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Longpoll request mismatch, completing request '</span> + requestId;
    }
    _metaConnectRequest = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_complete</span>(<span class="hljs-params">request, success</span>) </span>{
    <span class="hljs-keyword">var</span> index = org.cometd.Utils.inArray(request, _requests);
    <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
      _requests.splice(index, <span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">if</span> (_envelopes.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> envelopeAndRequest = _envelopes.shift();
      <span class="hljs-keyword">var</span> nextEnvelope = envelopeAndRequest[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> nextRequest = envelopeAndRequest[<span class="hljs-number">1</span>];
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport dequeued request'</span>, nextRequest.id);
      <span class="hljs-keyword">if</span> (success) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getConfiguration().autoBatch) {
          _coalesceEnvelopes.call(<span class="hljs-keyword">this</span>, nextEnvelope);
        }
        _queueSend.call(<span class="hljs-keyword">this</span>, nextEnvelope);
        <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport completed request'</span>, request.id, nextEnvelope);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          self.complete(nextRequest, <span class="hljs-literal">false</span>, nextRequest.metaConnect);
          <span class="hljs-keyword">var</span> failure = {
            <span class="hljs-attr">reason</span>: <span class="hljs-string">'Previous request failed'</span>
          };
          <span class="hljs-keyword">var</span> xhr = nextRequest.xhr;
          failure.httpCode = self.xhrStatus(xhr);
          nextEnvelope.onFailure(xhr, nextEnvelope.messages, failure);
        }, <span class="hljs-number">0</span>);
      }
    }
  }
  _self.complete = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, success, metaConnect</span>) </span>{
    <span class="hljs-keyword">if</span> (metaConnect) {
      _metaConnectComplete.call(<span class="hljs-keyword">this</span>, request);
    } <span class="hljs-keyword">else</span> {
      _complete.call(<span class="hljs-keyword">this</span>, request, success);
    }
  };
  _self.transportSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, request</span>) </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
  };
  _self.transportSuccess = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, request, responses</span>) </span>{
    <span class="hljs-keyword">if</span> (!request.expired) {
      <span class="hljs-keyword">this</span>.clearTimeout(request.timeout);
      <span class="hljs-keyword">this</span>.complete(request, <span class="hljs-literal">true</span>, request.metaConnect);
      <span class="hljs-keyword">if</span> (responses &amp;&amp; responses.length &gt; <span class="hljs-number">0</span>) {
        envelope.onSuccess(responses);
      } <span class="hljs-keyword">else</span> {
        envelope.onFailure(request.xhr, envelope.messages, {
          <span class="hljs-attr">httpCode</span>: <span class="hljs-number">204</span>
        });
      }
    }
  };
  _self.transportFailure = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, request, failure</span>) </span>{
    <span class="hljs-keyword">if</span> (!request.expired) {
      <span class="hljs-keyword">this</span>.clearTimeout(request.timeout);
      <span class="hljs-keyword">this</span>.complete(request, <span class="hljs-literal">false</span>, request.metaConnect);
      envelope.onFailure(request.xhr, envelope.messages, failure);
    }
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_metaConnectSend</span>(<span class="hljs-params">envelope</span>) </span>{
    <span class="hljs-keyword">if</span> (_metaConnectRequest !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Concurrent metaConnect requests not allowed, request id='</span> + _metaConnectRequest.id + <span class="hljs-string">' not yet completed'</span>;
    }
    <span class="hljs-keyword">var</span> requestId = ++_requestIds;
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'metaConnect send, request'</span>, requestId, <span class="hljs-string">'envelope'</span>, envelope);
    <span class="hljs-keyword">var</span> request = {
      <span class="hljs-attr">id</span>: requestId,
      <span class="hljs-attr">metaConnect</span>: <span class="hljs-literal">true</span>
    };
    _transportSend.call(<span class="hljs-keyword">this</span>, envelope, request);
    _metaConnectRequest = request;
  }
  _self.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, metaConnect</span>) </span>{
    <span class="hljs-keyword">if</span> (metaConnect) {
      _metaConnectSend.call(<span class="hljs-keyword">this</span>, envelope);
    } <span class="hljs-keyword">else</span> {
      _queueSend.call(<span class="hljs-keyword">this</span>, envelope);
    }
  };
  _self.abort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _super.abort();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _requests.length; ++i) {
      <span class="hljs-keyword">var</span> request = _requests[i];
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Aborting request'</span>, request);
      <span class="hljs-keyword">this</span>.abortXHR(request.xhr);
    }
    <span class="hljs-keyword">if</span> (_metaConnectRequest) {
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Aborting metaConnect request'</span>, _metaConnectRequest);
      <span class="hljs-keyword">this</span>.abortXHR(_metaConnectRequest.xhr);
    }
    <span class="hljs-keyword">this</span>.reset();
  };
  _self.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _super.reset();
    _metaConnectRequest = <span class="hljs-literal">null</span>;
    _requests = [];
    _envelopes = [];
  };
  _self.abortXHR = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr</span>) </span>{
    <span class="hljs-keyword">if</span> (xhr) {
      <span class="hljs-keyword">try</span> {
        xhr.abort();
      } <span class="hljs-keyword">catch</span> (x) {
        <span class="hljs-keyword">this</span>._debug(x);
      }
    }
  };
  _self.xhrStatus = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr</span>) </span>{
    <span class="hljs-keyword">if</span> (xhr) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> xhr.status;
      } <span class="hljs-keyword">catch</span> (x) {
        <span class="hljs-keyword">this</span>._debug(x);
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
  };
  <span class="hljs-keyword">return</span> _self;
};
org.cometd.LongPollingTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org.cometd.RequestTransport();
  <span class="hljs-keyword">var</span> _self = org.cometd.Transport.derive(_super);
  <span class="hljs-keyword">var</span> _supportsCrossDomain = <span class="hljs-literal">true</span>;
  _self.accept = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">return</span> _supportsCrossDomain || !crossDomain;
  };
  _self.xhrSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">packet</span>) </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
  };
  _self.transportSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, request</span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'sending request'</span>, request.id, <span class="hljs-string">'envelope'</span>, envelope);
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">var</span> sameStack = <span class="hljs-literal">true</span>;
      request.xhr = <span class="hljs-keyword">this</span>.xhrSend({
        <span class="hljs-attr">transport</span>: <span class="hljs-keyword">this</span>,
        <span class="hljs-attr">url</span>: envelope.url,
        <span class="hljs-attr">sync</span>: envelope.sync,
        <span class="hljs-attr">headers</span>: <span class="hljs-keyword">this</span>.getConfiguration().requestHeaders,
        <span class="hljs-attr">body</span>: org.cometd.JSON.toJSON(envelope.messages),
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
          self._debug(<span class="hljs-string">'Transport'</span>, self.getType(), <span class="hljs-string">'received response'</span>, response);
          <span class="hljs-keyword">var</span> success = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> received = self.convertToMessages(response);
            <span class="hljs-keyword">if</span> (received.length === <span class="hljs-number">0</span>) {
              _supportsCrossDomain = <span class="hljs-literal">false</span>;
              self.transportFailure(envelope, request, {
                <span class="hljs-attr">httpCode</span>: <span class="hljs-number">204</span>
              });
            } <span class="hljs-keyword">else</span> {
              success = <span class="hljs-literal">true</span>;
              self.transportSuccess(envelope, request, received);
            }
          } <span class="hljs-keyword">catch</span> (x) {
            self._debug(x);
            <span class="hljs-keyword">if</span> (!success) {
              _supportsCrossDomain = <span class="hljs-literal">false</span>;
              <span class="hljs-keyword">var</span> failure = {
                <span class="hljs-attr">exception</span>: x
              };
              failure.httpCode = self.xhrStatus(request.xhr);
              self.transportFailure(envelope, request, failure);
            }
          }
        },
        <span class="hljs-attr">onError</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reason, exception</span>) </span>{
          _supportsCrossDomain = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">var</span> failure = {
            <span class="hljs-attr">reason</span>: reason,
            <span class="hljs-attr">exception</span>: exception
          };
          failure.httpCode = self.xhrStatus(request.xhr);
          <span class="hljs-keyword">if</span> (sameStack) {
            self.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              self.transportFailure(envelope, request, failure);
            }, <span class="hljs-number">0</span>);
          } <span class="hljs-keyword">else</span> {
            self.transportFailure(envelope, request, failure);
          }
        }
      });
      sameStack = <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">catch</span> (x) {
      _supportsCrossDomain = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        self.transportFailure(envelope, request, {
          <span class="hljs-attr">exception</span>: x
        });
      }, <span class="hljs-number">0</span>);
    }
  };
  _self.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _super.reset();
    _supportsCrossDomain = <span class="hljs-literal">true</span>;
  };
  <span class="hljs-keyword">return</span> _self;
};
org.cometd.CallbackPollingTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org.cometd.RequestTransport();
  <span class="hljs-keyword">var</span> _self = org.cometd.Transport.derive(_super);
  <span class="hljs-keyword">var</span> _maxLength = <span class="hljs-number">2000</span>;
  _self.accept = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  };
  _self.jsonpSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">packet</span>) </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Abstract'</span>;
  };
  _self.transportSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, request</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> start = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> length = envelope.messages.length;
    <span class="hljs-keyword">var</span> lengths = [];
    <span class="hljs-keyword">while</span> (length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> json = org.cometd.JSON.toJSON(envelope.messages.slice(start, start + length));
      <span class="hljs-keyword">var</span> urlLength = envelope.url.length + <span class="hljs-built_in">encodeURI</span>(json).length;
      <span class="hljs-keyword">if</span> (urlLength &gt; _maxLength) {
        <span class="hljs-keyword">if</span> (length === <span class="hljs-number">1</span>) {
          <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            self.transportFailure(envelope, request, {
              <span class="hljs-attr">reason</span>: <span class="hljs-string">'Bayeux message too big, max is '</span> + _maxLength
            });
          }, <span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span>;
        }
        --length;
        <span class="hljs-keyword">continue</span>;
      }
      lengths.push(length);
      start += length;
      length = envelope.messages.length - start;
    }
    <span class="hljs-keyword">var</span> envelopeToSend = envelope;
    <span class="hljs-keyword">if</span> (lengths.length &gt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">var</span> begin = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">var</span> end = lengths[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'split'</span>, envelope.messages.length, <span class="hljs-string">'messages into'</span>, lengths.join(<span class="hljs-string">' + '</span>));
      envelopeToSend = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, envelope);
      envelopeToSend.messages = envelope.messages.slice(begin, end);
      envelopeToSend.onSuccess = envelope.onSuccess;
      envelopeToSend.onFailure = envelope.onFailure;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; lengths.length; ++i) {
        <span class="hljs-keyword">var</span> nextEnvelope = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, envelope);
        begin = end;
        end += lengths[i];
        nextEnvelope.messages = envelope.messages.slice(begin, end);
        nextEnvelope.onSuccess = envelope.onSuccess;
        nextEnvelope.onFailure = envelope.onFailure;
        <span class="hljs-keyword">this</span>.send(nextEnvelope, request.metaConnect);
      }
    }
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'sending request'</span>, request.id, <span class="hljs-string">'envelope'</span>, envelopeToSend);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">var</span> sameStack = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">this</span>.jsonpSend({
        <span class="hljs-attr">transport</span>: <span class="hljs-keyword">this</span>,
        <span class="hljs-attr">url</span>: envelopeToSend.url,
        <span class="hljs-attr">sync</span>: envelopeToSend.sync,
        <span class="hljs-attr">headers</span>: <span class="hljs-keyword">this</span>.getConfiguration().requestHeaders,
        <span class="hljs-attr">body</span>: org.cometd.JSON.toJSON(envelopeToSend.messages),
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">responses</span>) </span>{
          <span class="hljs-keyword">var</span> success = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> received = self.convertToMessages(responses);
            <span class="hljs-keyword">if</span> (received.length === <span class="hljs-number">0</span>) {
              self.transportFailure(envelopeToSend, request, {
                <span class="hljs-attr">httpCode</span>: <span class="hljs-number">204</span>
              });
            } <span class="hljs-keyword">else</span> {
              success = <span class="hljs-literal">true</span>;
              self.transportSuccess(envelopeToSend, request, received);
            }
          } <span class="hljs-keyword">catch</span> (x) {
            self._debug(x);
            <span class="hljs-keyword">if</span> (!success) {
              self.transportFailure(envelopeToSend, request, {
                <span class="hljs-attr">exception</span>: x
              });
            }
          }
        },
        <span class="hljs-attr">onError</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reason, exception</span>) </span>{
          <span class="hljs-keyword">var</span> failure = {
            <span class="hljs-attr">reason</span>: reason,
            <span class="hljs-attr">exception</span>: exception
          };
          <span class="hljs-keyword">if</span> (sameStack) {
            self.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              self.transportFailure(envelopeToSend, request, failure);
            }, <span class="hljs-number">0</span>);
          } <span class="hljs-keyword">else</span> {
            self.transportFailure(envelopeToSend, request, failure);
          }
        }
      });
      sameStack = <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">catch</span> (xx) {
      <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        self.transportFailure(envelopeToSend, request, {
          <span class="hljs-attr">exception</span>: xx
        });
      }, <span class="hljs-number">0</span>);
    }
  };
  <span class="hljs-keyword">return</span> _self;
};
org.cometd.WebSocketTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org.cometd.Transport();
  <span class="hljs-keyword">var</span> _self = org.cometd.Transport.derive(_super);
  <span class="hljs-keyword">var</span> _cometd;
  <span class="hljs-keyword">var</span> _webSocketSupported = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> _webSocketConnected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _stickyReconnect = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> _envelopes = {};
  <span class="hljs-keyword">var</span> _timeouts = {};
  <span class="hljs-keyword">var</span> _connecting = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _webSocket = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> _connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _successCallback = <span class="hljs-literal">null</span>;
  _self.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _super.reset();
    _webSocketSupported = <span class="hljs-literal">true</span>;
    _webSocketConnected = <span class="hljs-literal">false</span>;
    _stickyReconnect = <span class="hljs-literal">true</span>;
    _envelopes = {};
    _timeouts = {};
    _connecting = <span class="hljs-literal">false</span>;
    _webSocket = <span class="hljs-literal">null</span>;
    _connected = <span class="hljs-literal">false</span>;
    _successCallback = <span class="hljs-literal">null</span>;
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_websocketConnect</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_connecting) {
      <span class="hljs-keyword">return</span>;
    }
    _connecting = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> url = _cometd.getURL().replace(<span class="hljs-regexp">/^http/</span>, <span class="hljs-string">'ws'</span>);
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'connecting to URL'</span>, url);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">var</span> protocol = _cometd.getConfiguration().protocol;
      <span class="hljs-keyword">var</span> webSocket = protocol ? <span class="hljs-keyword">new</span> org.cometd.WebSocket(url, protocol) : <span class="hljs-keyword">new</span> org.cometd.WebSocket(url);
    } <span class="hljs-keyword">catch</span> (x) {
      _webSocketSupported = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Exception while creating WebSocket object'</span>, x);
      <span class="hljs-keyword">throw</span> x;
    }
    _stickyReconnect = _cometd.getConfiguration().stickyReconnect !== <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> connectTimer = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> connectTimeout = _cometd.getConfiguration().connectTimeout;
    <span class="hljs-keyword">if</span> (connectTimeout &gt; <span class="hljs-number">0</span>) {
      connectTimer = <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        connectTimer = <span class="hljs-literal">null</span>;
        self._debug(<span class="hljs-string">'Transport'</span>, self.getType(), <span class="hljs-string">'timed out while connecting to URL'</span>, url, <span class="hljs-string">':'</span>, connectTimeout, <span class="hljs-string">'ms'</span>);
        <span class="hljs-keyword">var</span> event = {
          <span class="hljs-attr">code</span>: <span class="hljs-number">1000</span>,
          <span class="hljs-attr">reason</span>: <span class="hljs-string">'Connect Timeout'</span>
        };
        self.webSocketClose(webSocket, event.code, event.reason);
        self.onClose(webSocket, event);
      }, connectTimeout);
    }
    <span class="hljs-keyword">var</span> onopen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      self._debug(<span class="hljs-string">'WebSocket opened'</span>, webSocket);
      _connecting = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (connectTimer) {
        self.clearTimeout(connectTimer);
        connectTimer = <span class="hljs-literal">null</span>;
      }
      <span class="hljs-keyword">if</span> (_webSocket) {
        _cometd._warn(<span class="hljs-string">'Closing Extra WebSocket Connections'</span>, webSocket, _webSocket);
        self.webSocketClose(webSocket, <span class="hljs-number">1000</span>, <span class="hljs-string">'Extra Connection'</span>);
      } <span class="hljs-keyword">else</span> {
        self.onOpen(webSocket);
      }
    };
    <span class="hljs-keyword">var</span> onclose = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
      event = event || {
        <span class="hljs-attr">code</span>: <span class="hljs-number">1000</span>
      };
      self._debug(<span class="hljs-string">'WebSocket closing'</span>, webSocket, event);
      _connecting = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (connectTimer) {
        self.clearTimeout(connectTimer);
        connectTimer = <span class="hljs-literal">null</span>;
      }
      <span class="hljs-keyword">if</span> (_webSocket !== <span class="hljs-literal">null</span> &amp;&amp; webSocket !== _webSocket) {
        self._debug(<span class="hljs-string">'Closed Extra WebSocket Connection'</span>, webSocket);
      } <span class="hljs-keyword">else</span> {
        self.onClose(webSocket, event);
      }
    };
    <span class="hljs-keyword">var</span> onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      self._debug(<span class="hljs-string">'WebSocket message'</span>, message, webSocket);
      <span class="hljs-keyword">if</span> (webSocket !== _webSocket) {
        _cometd._warn(<span class="hljs-string">'Extra WebSocket Connections'</span>, webSocket, _webSocket);
      }
      self.onMessage(webSocket, message);
    };
    webSocket.onopen = onopen;
    webSocket.onclose = onclose;
    webSocket.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      onclose({
        <span class="hljs-attr">code</span>: <span class="hljs-number">1002</span>,
        <span class="hljs-attr">reason</span>: <span class="hljs-string">'Error'</span>
      });
    };
    webSocket.onmessage = onmessage;
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'configured callbacks on'</span>, webSocket);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_webSocketSend</span>(<span class="hljs-params">webSocket, envelope, metaConnect</span>) </span>{
    <span class="hljs-keyword">var</span> json = org.cometd.JSON.toJSON(envelope.messages);
    webSocket.send(json);
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'sent'</span>, envelope, <span class="hljs-string">'metaConnect ='</span>, metaConnect);
    <span class="hljs-keyword">var</span> maxDelay = <span class="hljs-keyword">this</span>.getConfiguration().maxNetworkDelay;
    <span class="hljs-keyword">var</span> delay = maxDelay;
    <span class="hljs-keyword">if</span> (metaConnect) {
      delay += <span class="hljs-keyword">this</span>.getAdvice().timeout;
      _connected = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> messageIds = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; envelope.messages.length; ++i) {
      (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> message = envelope.messages[i];
        <span class="hljs-keyword">if</span> (message.id) {
          messageIds.push(message.id);
          _timeouts[message.id] = <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            self._debug(<span class="hljs-string">'Transport'</span>, self.getType(), <span class="hljs-string">'timing out message'</span>, message.id, <span class="hljs-string">'after'</span>, delay, <span class="hljs-string">'on'</span>, webSocket);
            <span class="hljs-keyword">var</span> event = {
              <span class="hljs-attr">code</span>: <span class="hljs-number">1000</span>,
              <span class="hljs-attr">reason</span>: <span class="hljs-string">'Message Timeout'</span>
            };
            self.webSocketClose(webSocket, event.code, event.reason);
            self.onClose(webSocket, event);
          }, delay);
        }
      })();
    }
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'waiting at most'</span>, delay, <span class="hljs-string">'ms for messages'</span>, messageIds, <span class="hljs-string">'maxNetworkDelay'</span>, maxDelay, <span class="hljs-string">', timeouts:'</span>, _timeouts);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_send</span>(<span class="hljs-params">webSocket, envelope, metaConnect</span>) </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (webSocket === <span class="hljs-literal">null</span>) {
        _websocketConnect.call(<span class="hljs-keyword">this</span>);
      } <span class="hljs-keyword">else</span> {
        _webSocketSend.call(<span class="hljs-keyword">this</span>, webSocket, envelope, metaConnect);
      }
    } <span class="hljs-keyword">catch</span> (x) {
      <span class="hljs-keyword">this</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        envelope.onFailure(webSocket, envelope.messages, {
          <span class="hljs-attr">exception</span>: x
        });
      }, <span class="hljs-number">0</span>);
    }
  }
  _self.onOpen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">webSocket</span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'opened'</span>, webSocket);
    _webSocket = webSocket;
    _webSocketConnected = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Sending pending messages'</span>, _envelopes);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> _envelopes) {
      <span class="hljs-keyword">var</span> element = _envelopes[key];
      <span class="hljs-keyword">var</span> envelope = element[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> metaConnect = element[<span class="hljs-number">1</span>];
      _successCallback = envelope.onSuccess;
      _webSocketSend.call(<span class="hljs-keyword">this</span>, webSocket, envelope, metaConnect);
    }
  };
  _self.onMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">webSocket, wsMessage</span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'received websocket message'</span>, wsMessage, webSocket);
    <span class="hljs-keyword">var</span> close = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> messages = <span class="hljs-keyword">this</span>.convertToMessages(wsMessage.data);
    <span class="hljs-keyword">var</span> messageIds = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; messages.length; ++i) {
      <span class="hljs-keyword">var</span> message = messages[i];
      <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^\/meta\//</span>.test(message.channel) || message.successful !== <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">if</span> (message.id) {
          messageIds.push(message.id);
          <span class="hljs-keyword">var</span> timeout = _timeouts[message.id];
          <span class="hljs-keyword">if</span> (timeout) {
            <span class="hljs-keyword">this</span>.clearTimeout(timeout);
            <span class="hljs-keyword">delete</span> _timeouts[message.id];
            <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'removed timeout for message'</span>, message.id, <span class="hljs-string">', timeouts'</span>, _timeouts);
          }
        }
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'/meta/connect'</span> === message.channel) {
        _connected = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'/meta/disconnect'</span> === message.channel &amp;&amp; !_connected) {
        close = <span class="hljs-literal">true</span>;
      }
    }
    <span class="hljs-keyword">var</span> removed = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; messageIds.length; ++j) {
      <span class="hljs-keyword">var</span> id = messageIds[j];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> _envelopes) {
        <span class="hljs-keyword">var</span> ids = key.split(<span class="hljs-string">','</span>);
        <span class="hljs-keyword">var</span> index = org.cometd.Utils.inArray(id, ids);
        <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
          removed = <span class="hljs-literal">true</span>;
          ids.splice(index, <span class="hljs-number">1</span>);
          <span class="hljs-keyword">var</span> envelope = _envelopes[key][<span class="hljs-number">0</span>];
          <span class="hljs-keyword">var</span> metaConnect = _envelopes[key][<span class="hljs-number">1</span>];
          <span class="hljs-keyword">delete</span> _envelopes[key];
          <span class="hljs-keyword">if</span> (ids.length &gt; <span class="hljs-number">0</span>) {
            _envelopes[ids.join(<span class="hljs-string">','</span>)] = [envelope, metaConnect];
          }
          <span class="hljs-keyword">break</span>;
        }
      }
    }
    <span class="hljs-keyword">if</span> (removed) {
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'removed envelope, envelopes'</span>, _envelopes);
    }
    _successCallback.call(<span class="hljs-keyword">this</span>, messages);
    <span class="hljs-keyword">if</span> (close) {
      <span class="hljs-keyword">this</span>.webSocketClose(webSocket, <span class="hljs-number">1000</span>, <span class="hljs-string">'Disconnect'</span>);
    }
  };
  _self.onClose = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">webSocket, event</span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'closed'</span>, webSocket, event);
    _webSocketSupported = _stickyReconnect &amp;&amp; _webSocketConnected;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> id <span class="hljs-keyword">in</span> _timeouts) {
      <span class="hljs-keyword">this</span>.clearTimeout(_timeouts[id]);
    }
    _timeouts = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> _envelopes) {
      <span class="hljs-keyword">var</span> envelope = _envelopes[key][<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> metaConnect = _envelopes[key][<span class="hljs-number">1</span>];
      <span class="hljs-keyword">if</span> (metaConnect) {
        _connected = <span class="hljs-literal">false</span>;
      }
      envelope.onFailure(webSocket, envelope.messages, {
        <span class="hljs-attr">websocketCode</span>: event.code,
        <span class="hljs-attr">reason</span>: event.reason
      });
    }
    _envelopes = {};
    _webSocket = <span class="hljs-literal">null</span>;
  };
  _self.registered = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, cometd</span>) </span>{
    _super.registered(type, cometd);
    _cometd = cometd;
  };
  _self.accept = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version, crossDomain, url</span>) </span>{
    <span class="hljs-keyword">return</span> _webSocketSupported &amp;&amp; !!org.cometd.WebSocket &amp;&amp; _cometd.websocketEnabled !== <span class="hljs-literal">false</span>;
  };
  _self.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">envelope, metaConnect</span>) </span>{
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'sending'</span>, envelope, <span class="hljs-string">'metaConnect ='</span>, metaConnect);
    <span class="hljs-keyword">var</span> messageIds = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; envelope.messages.length; ++i) {
      <span class="hljs-keyword">var</span> message = envelope.messages[i];
      <span class="hljs-keyword">if</span> (message.id) {
        messageIds.push(message.id);
      }
    }
    _envelopes[messageIds.join(<span class="hljs-string">','</span>)] = [envelope, metaConnect];
    <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Transport'</span>, <span class="hljs-keyword">this</span>.getType(), <span class="hljs-string">'stored envelope, envelopes'</span>, _envelopes);
    _send.call(<span class="hljs-keyword">this</span>, _webSocket, envelope, metaConnect);
  };
  _self.webSocketClose = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">webSocket, code, reason</span>) </span>{
    <span class="hljs-keyword">try</span> {
      webSocket.close(code, reason);
    } <span class="hljs-keyword">catch</span> (x) {
      <span class="hljs-keyword">this</span>._debug(x);
    }
  };
  _self.abort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _super.abort();
    <span class="hljs-keyword">if</span> (_webSocket) {
      <span class="hljs-keyword">var</span> event = {
        <span class="hljs-attr">code</span>: <span class="hljs-number">1001</span>,
        <span class="hljs-attr">reason</span>: <span class="hljs-string">'Abort'</span>
      };
      <span class="hljs-keyword">this</span>.webSocketClose(_webSocket, event.code, event.reason);
      <span class="hljs-keyword">this</span>.onClose(_webSocket, event);
    }
    <span class="hljs-keyword">this</span>.reset();
  };
  <span class="hljs-keyword">return</span> _self;
};
org.cometd.Cometd = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-keyword">var</span> _cometd = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> _name = name || <span class="hljs-string">'default'</span>;
  <span class="hljs-keyword">var</span> _crossDomain = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _transports = <span class="hljs-keyword">new</span> org.cometd.TransportRegistry();
  <span class="hljs-keyword">var</span> _transport;
  <span class="hljs-keyword">var</span> _status = <span class="hljs-string">'disconnected'</span>;
  <span class="hljs-keyword">var</span> _messageId = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> _clientId = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> _batch = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> _messageQueue = [];
  <span class="hljs-keyword">var</span> _internalBatch = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _listeners = {};
  <span class="hljs-keyword">var</span> _backoff = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> _scheduledSend = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> _extensions = [];
  <span class="hljs-keyword">var</span> _advice = {};
  <span class="hljs-keyword">var</span> _handshakeProps;
  <span class="hljs-keyword">var</span> _handshakeCallback;
  <span class="hljs-keyword">var</span> _callbacks = {};
  <span class="hljs-keyword">var</span> _reestablish = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _config = {
    <span class="hljs-attr">protocol</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">stickyReconnect</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">connectTimeout</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">maxConnections</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">backoffIncrement</span>: <span class="hljs-number">1000</span>,
    <span class="hljs-attr">maxBackoff</span>: <span class="hljs-number">60000</span>,
    <span class="hljs-attr">logLevel</span>: <span class="hljs-string">'info'</span>,
    <span class="hljs-attr">reverseIncomingExtensions</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">maxNetworkDelay</span>: <span class="hljs-number">10000</span>,
    <span class="hljs-attr">requestHeaders</span>: {},
    <span class="hljs-attr">appendMessageTypeToURL</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">autoBatch</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">advice</span>: {
      <span class="hljs-attr">timeout</span>: <span class="hljs-number">60000</span>,
      <span class="hljs-attr">interval</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">reconnect</span>: <span class="hljs-string">'retry'</span>
    }
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_fieldValue</span>(<span class="hljs-params">object, name</span>) </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> object[name];
    } <span class="hljs-keyword">catch</span> (x) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    }
  }
  <span class="hljs-keyword">this</span>._mixin = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">deep, target, objects</span>) </span>{
    <span class="hljs-keyword">var</span> result = target || {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">2</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; ++i) {
      <span class="hljs-keyword">var</span> object = <span class="hljs-built_in">arguments</span>[i];
      <span class="hljs-keyword">if</span> (object === <span class="hljs-literal">undefined</span> || object === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> propName <span class="hljs-keyword">in</span> object) {
        <span class="hljs-keyword">var</span> prop = _fieldValue(object, propName);
        <span class="hljs-keyword">var</span> targ = _fieldValue(result, propName);
        <span class="hljs-keyword">if</span> (prop === target) {
          <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">if</span> (prop === <span class="hljs-literal">undefined</span>) {
          <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">if</span> (deep &amp;&amp; <span class="hljs-keyword">typeof</span> prop === <span class="hljs-string">'object'</span> &amp;&amp; prop !== <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">if</span> (prop <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {
            result[propName] = <span class="hljs-keyword">this</span>._mixin(deep, targ <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span> ? targ : [], prop);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">typeof</span> targ === <span class="hljs-string">'object'</span> &amp;&amp; !(targ <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) ? targ : {};
            result[propName] = <span class="hljs-keyword">this</span>._mixin(deep, source, prop);
          }
        } <span class="hljs-keyword">else</span> {
          result[propName] = prop;
        }
      }
    }
    <span class="hljs-keyword">return</span> result;
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_isString</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">return</span> org.cometd.Utils.isString(value);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_isFunction</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> || value === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'function'</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_log</span>(<span class="hljs-params">level, args</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.console) {
      <span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">window</span>.console[level];
      <span class="hljs-keyword">if</span> (_isFunction(logger)) {
        logger.apply(<span class="hljs-built_in">window</span>.console, args);
      }
    }
  }
  <span class="hljs-keyword">this</span>._warn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _log(<span class="hljs-string">'warn'</span>, <span class="hljs-built_in">arguments</span>);
  };
  <span class="hljs-keyword">this</span>._info = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_config.logLevel !== <span class="hljs-string">'warn'</span>) {
      _log(<span class="hljs-string">'info'</span>, <span class="hljs-built_in">arguments</span>);
    }
  };
  <span class="hljs-keyword">this</span>._debug = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_config.logLevel === <span class="hljs-string">'debug'</span>) {
      _log(<span class="hljs-string">'debug'</span>, <span class="hljs-built_in">arguments</span>);
    }
  };
  <span class="hljs-keyword">this</span>._isCrossDomain = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">hostAndPort</span>) </span>{
    <span class="hljs-keyword">return</span> hostAndPort &amp;&amp; hostAndPort !== <span class="hljs-built_in">window</span>.location.host;
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_configure</span>(<span class="hljs-params">configuration</span>) </span>{
    _cometd._debug(<span class="hljs-string">'Configuring cometd object with'</span>, configuration);
    <span class="hljs-keyword">if</span> (_isString(configuration)) {
      configuration = {
        <span class="hljs-attr">url</span>: configuration
      };
    }
    <span class="hljs-keyword">if</span> (!configuration) {
      configuration = {};
    }
    _config = _cometd._mixin(<span class="hljs-literal">false</span>, _config, configuration);
    <span class="hljs-keyword">var</span> url = _cometd.getURL();
    <span class="hljs-keyword">if</span> (!url) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Missing required configuration parameter \'url\' specifying the Bayeux server URL'</span>;
    }
    <span class="hljs-keyword">var</span> urlParts = <span class="hljs-regexp">/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/</span>.exec(url);
    <span class="hljs-keyword">var</span> hostAndPort = urlParts[<span class="hljs-number">2</span>];
    <span class="hljs-keyword">var</span> uri = urlParts[<span class="hljs-number">8</span>];
    <span class="hljs-keyword">var</span> afterURI = urlParts[<span class="hljs-number">9</span>];
    _crossDomain = _cometd._isCrossDomain(hostAndPort);
    <span class="hljs-keyword">if</span> (_config.appendMessageTypeToURL) {
      <span class="hljs-keyword">if</span> (afterURI !== <span class="hljs-literal">undefined</span> &amp;&amp; afterURI.length &gt; <span class="hljs-number">0</span>) {
        _cometd._info(<span class="hljs-string">'Appending message type to URI '</span> + uri + afterURI + <span class="hljs-string">' is not supported, disabling \'appendMessageTypeToURL\' configuration'</span>);
        _config.appendMessageTypeToURL = <span class="hljs-literal">false</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> uriSegments = uri.split(<span class="hljs-string">'/'</span>);
        <span class="hljs-keyword">var</span> lastSegmentIndex = uriSegments.length - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (uri.match(<span class="hljs-regexp">/\/$/</span>)) {
          lastSegmentIndex -= <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">if</span> (uriSegments[lastSegmentIndex].indexOf(<span class="hljs-string">'.'</span>) &gt;= <span class="hljs-number">0</span>) {
          _cometd._info(<span class="hljs-string">'Appending message type to URI '</span> + uri + <span class="hljs-string">' is not supported, disabling \'appendMessageTypeToURL\' configuration'</span>);
          _config.appendMessageTypeToURL = <span class="hljs-literal">false</span>;
        }
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_removeListener</span>(<span class="hljs-params">subscription</span>) </span>{
    <span class="hljs-keyword">if</span> (subscription) {
      <span class="hljs-keyword">var</span> subscriptions = _listeners[subscription.channel];
      <span class="hljs-keyword">if</span> (subscriptions &amp;&amp; subscriptions[subscription.id]) {
        <span class="hljs-keyword">delete</span> subscriptions[subscription.id];
        _cometd._debug(<span class="hljs-string">'Removed'</span>, subscription.listener ? <span class="hljs-string">'listener'</span> : <span class="hljs-string">'subscription'</span>, subscription);
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_removeSubscription</span>(<span class="hljs-params">subscription</span>) </span>{
    <span class="hljs-keyword">if</span> (subscription &amp;&amp; !subscription.listener) {
      _removeListener(subscription);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_clearSubscriptions</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> channel <span class="hljs-keyword">in</span> _listeners) {
      <span class="hljs-keyword">var</span> subscriptions = _listeners[channel];
      <span class="hljs-keyword">if</span> (subscriptions) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; subscriptions.length; ++i) {
          _removeSubscription(subscriptions[i]);
        }
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_setStatus</span>(<span class="hljs-params">newStatus</span>) </span>{
    <span class="hljs-keyword">if</span> (_status !== newStatus) {
      _cometd._debug(<span class="hljs-string">'Status'</span>, _status, <span class="hljs-string">'-&gt;'</span>, newStatus);
      _status = newStatus;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_isDisconnected</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _status === <span class="hljs-string">'disconnecting'</span> || _status === <span class="hljs-string">'disconnected'</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_nextMessageId</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> ++_messageId;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_applyExtension</span>(<span class="hljs-params">scope, callback, name, message, outgoing</span>) </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> callback.call(scope, message);
    } <span class="hljs-keyword">catch</span> (x) {
      _cometd._debug(<span class="hljs-string">'Exception during execution of extension'</span>, name, x);
      <span class="hljs-keyword">var</span> exceptionCallback = _cometd.onExtensionException;
      <span class="hljs-keyword">if</span> (_isFunction(exceptionCallback)) {
        _cometd._debug(<span class="hljs-string">'Invoking extension exception callback'</span>, name, x);
        <span class="hljs-keyword">try</span> {
          exceptionCallback.call(_cometd, x, name, outgoing, message);
        } <span class="hljs-keyword">catch</span> (xx) {
          _cometd._info(<span class="hljs-string">'Exception during execution of exception callback in extension'</span>, name, xx);
        }
      }
      <span class="hljs-keyword">return</span> message;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_applyIncomingExtensions</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _extensions.length; ++i) {
      <span class="hljs-keyword">if</span> (message === <span class="hljs-literal">undefined</span> || message === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">break</span>;
      }
      <span class="hljs-keyword">var</span> index = _config.reverseIncomingExtensions ? _extensions.length - <span class="hljs-number">1</span> - i : i;
      <span class="hljs-keyword">var</span> extension = _extensions[index];
      <span class="hljs-keyword">var</span> callback = extension.extension.incoming;
      <span class="hljs-keyword">if</span> (_isFunction(callback)) {
        <span class="hljs-keyword">var</span> result = _applyExtension(extension.extension, callback, extension.name, message, <span class="hljs-literal">false</span>);
        message = result === <span class="hljs-literal">undefined</span> ? message : result;
      }
    }
    <span class="hljs-keyword">return</span> message;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_applyOutgoingExtensions</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _extensions.length; ++i) {
      <span class="hljs-keyword">if</span> (message === <span class="hljs-literal">undefined</span> || message === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">break</span>;
      }
      <span class="hljs-keyword">var</span> extension = _extensions[i];
      <span class="hljs-keyword">var</span> callback = extension.extension.outgoing;
      <span class="hljs-keyword">if</span> (_isFunction(callback)) {
        <span class="hljs-keyword">var</span> result = _applyExtension(extension.extension, callback, extension.name, message, <span class="hljs-literal">true</span>);
        message = result === <span class="hljs-literal">undefined</span> ? message : result;
      }
    }
    <span class="hljs-keyword">return</span> message;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_notify</span>(<span class="hljs-params">channel, message</span>) </span>{
    <span class="hljs-keyword">var</span> subscriptions = _listeners[channel];
    <span class="hljs-keyword">if</span> (subscriptions &amp;&amp; subscriptions.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; subscriptions.length; ++i) {
        <span class="hljs-keyword">var</span> subscription = subscriptions[i];
        <span class="hljs-keyword">if</span> (subscription) {
          <span class="hljs-keyword">try</span> {
            subscription.callback.call(subscription.scope, message);
          } <span class="hljs-keyword">catch</span> (x) {
            _cometd._debug(<span class="hljs-string">'Exception during notification'</span>, subscription, message, x);
            <span class="hljs-keyword">var</span> listenerCallback = _cometd.onListenerException;
            <span class="hljs-keyword">if</span> (_isFunction(listenerCallback)) {
              _cometd._debug(<span class="hljs-string">'Invoking listener exception callback'</span>, subscription, x);
              <span class="hljs-keyword">try</span> {
                listenerCallback.call(_cometd, x, subscription, subscription.listener, message);
              } <span class="hljs-keyword">catch</span> (xx) {
                _cometd._info(<span class="hljs-string">'Exception during execution of listener callback'</span>, subscription, xx);
              }
            }
          }
        }
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_notifyListeners</span>(<span class="hljs-params">channel, message</span>) </span>{
    _notify(channel, message);
    <span class="hljs-keyword">var</span> channelParts = channel.split(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">var</span> last = channelParts.length - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = last; i &gt; <span class="hljs-number">0</span>; --i) {
      <span class="hljs-keyword">var</span> channelPart = channelParts.slice(<span class="hljs-number">0</span>, i).join(<span class="hljs-string">'/'</span>) + <span class="hljs-string">'/*'</span>;
      <span class="hljs-keyword">if</span> (i === last) {
        _notify(channelPart, message);
      }
      channelPart += <span class="hljs-string">'*'</span>;
      _notify(channelPart, message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_cancelDelayedSend</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_scheduledSend !== <span class="hljs-literal">null</span>) {
      org.cometd.Utils.clearTimeout(_scheduledSend);
    }
    _scheduledSend = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_delayedSend</span>(<span class="hljs-params">operation</span>) </span>{
    _cancelDelayedSend();
    <span class="hljs-keyword">var</span> delay = _advice.interval + _backoff;
    _cometd._debug(<span class="hljs-string">'Function scheduled in'</span>, delay, <span class="hljs-string">'ms, interval ='</span>, _advice.interval, <span class="hljs-string">'backoff ='</span>, _backoff, operation);
    _scheduledSend = org.cometd.Utils.setTimeout(_cometd, operation, delay);
  }
  <span class="hljs-keyword">var</span> _handleMessages;
  <span class="hljs-keyword">var</span> _handleFailure;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_send</span>(<span class="hljs-params">sync, messages, longpoll, extraPath</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; messages.length; ++i) {
      <span class="hljs-keyword">var</span> message = messages[i];
      <span class="hljs-keyword">var</span> messageId = <span class="hljs-string">''</span> + _nextMessageId();
      message.id = messageId;
      <span class="hljs-keyword">if</span> (_clientId) {
        message.clientId = _clientId;
      }
      <span class="hljs-keyword">var</span> callback = <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">if</span> (_isFunction(message._callback)) {
        callback = message._callback;
        <span class="hljs-keyword">delete</span> message._callback;
      }
      message = _applyOutgoingExtensions(message);
      <span class="hljs-keyword">if</span> (message !== <span class="hljs-literal">undefined</span> &amp;&amp; message !== <span class="hljs-literal">null</span>) {
        message.id = messageId;
        messages[i] = message;
        <span class="hljs-keyword">if</span> (callback) {
          _callbacks[messageId] = callback;
        }
      } <span class="hljs-keyword">else</span> {
        messages.splice(i--, <span class="hljs-number">1</span>);
      }
    }
    <span class="hljs-keyword">if</span> (messages.length === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> url = _cometd.getURL();
    <span class="hljs-keyword">if</span> (_config.appendMessageTypeToURL) {
      <span class="hljs-keyword">if</span> (!url.match(<span class="hljs-regexp">/\/$/</span>)) {
        url = url + <span class="hljs-string">'/'</span>;
      }
      <span class="hljs-keyword">if</span> (extraPath) {
        url = url + extraPath;
      }
    }
    <span class="hljs-keyword">var</span> envelope = {
      <span class="hljs-attr">url</span>: url,
      <span class="hljs-attr">sync</span>: sync,
      <span class="hljs-attr">messages</span>: messages,
      <span class="hljs-attr">onSuccess</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rcvdMessages</span>) </span>{
        <span class="hljs-keyword">try</span> {
          _handleMessages.call(_cometd, rcvdMessages);
        } <span class="hljs-keyword">catch</span> (x) {
          _cometd._debug(<span class="hljs-string">'Exception during handling of messages'</span>, x);
        }
      },
      <span class="hljs-attr">onFailure</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">conduit, messages, failure</span>) </span>{
        <span class="hljs-keyword">try</span> {
          failure.connectionType = _cometd.getTransport().getType();
          _handleFailure.call(_cometd, conduit, messages, failure);
        } <span class="hljs-keyword">catch</span> (x) {
          _cometd._debug(<span class="hljs-string">'Exception during handling of failure'</span>, x);
        }
      }
    };
    _cometd._debug(<span class="hljs-string">'Send'</span>, envelope);
    _transport.send(envelope, longpoll);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_queueSend</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (_batch &gt; <span class="hljs-number">0</span> || _internalBatch === <span class="hljs-literal">true</span>) {
      _messageQueue.push(message);
    } <span class="hljs-keyword">else</span> {
      _send(<span class="hljs-literal">false</span>, [message], <span class="hljs-literal">false</span>);
    }
  }
  <span class="hljs-keyword">this</span>.send = _queueSend;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_resetBackoff</span>(<span class="hljs-params"></span>) </span>{
    _backoff = <span class="hljs-number">0</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_increaseBackoff</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_backoff &lt; _config.maxBackoff) {
      _backoff += _config.backoffIncrement;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_startBatch</span>(<span class="hljs-params"></span>) </span>{
    ++_batch;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_flushBatch</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> messages = _messageQueue;
    _messageQueue = [];
    <span class="hljs-keyword">if</span> (messages.length &gt; <span class="hljs-number">0</span>) {
      _send(<span class="hljs-literal">false</span>, messages, <span class="hljs-literal">false</span>);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_endBatch</span>(<span class="hljs-params"></span>) </span>{
    --_batch;
    <span class="hljs-keyword">if</span> (_batch &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Calls to startBatch() and endBatch() are not paired'</span>;
    }
    <span class="hljs-keyword">if</span> (_batch === <span class="hljs-number">0</span> &amp;&amp; !_isDisconnected() &amp;&amp; !_internalBatch) {
      _flushBatch();
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connect</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!_isDisconnected()) {
      <span class="hljs-keyword">var</span> message = {
        <span class="hljs-attr">channel</span>: <span class="hljs-string">'/meta/connect'</span>,
        <span class="hljs-attr">connectionType</span>: _transport.getType()
      };
      <span class="hljs-keyword">if</span> (!_connected) {
        message.advice = {
          <span class="hljs-attr">timeout</span>: <span class="hljs-number">0</span>
        };
      }
      _setStatus(<span class="hljs-string">'connecting'</span>);
      _cometd._debug(<span class="hljs-string">'Connect sent'</span>, message);
      _send(<span class="hljs-literal">false</span>, [message], <span class="hljs-literal">true</span>, <span class="hljs-string">'connect'</span>);
      _setStatus(<span class="hljs-string">'connected'</span>);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_delayedConnect</span>(<span class="hljs-params"></span>) </span>{
    _setStatus(<span class="hljs-string">'connecting'</span>);
    _delayedSend(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      _connect();
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_updateAdvice</span>(<span class="hljs-params">newAdvice</span>) </span>{
    <span class="hljs-keyword">if</span> (newAdvice) {
      _advice = _cometd._mixin(<span class="hljs-literal">false</span>, {}, _config.advice, newAdvice);
      _cometd._debug(<span class="hljs-string">'New advice'</span>, _advice);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_disconnect</span>(<span class="hljs-params">abort</span>) </span>{
    _cancelDelayedSend();
    <span class="hljs-keyword">if</span> (abort) {
      _transport.abort();
    }
    _clientId = <span class="hljs-literal">null</span>;
    _setStatus(<span class="hljs-string">'disconnected'</span>);
    _batch = <span class="hljs-number">0</span>;
    _resetBackoff();
    _transport = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (_messageQueue.length &gt; <span class="hljs-number">0</span>) {
      _handleFailure.call(_cometd, <span class="hljs-literal">undefined</span>, _messageQueue, {
        <span class="hljs-attr">reason</span>: <span class="hljs-string">'Disconnected'</span>
      });
      _messageQueue = [];
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_notifyTransportFailure</span>(<span class="hljs-params">oldTransport, newTransport, failure</span>) </span>{
    <span class="hljs-keyword">var</span> callback = _cometd.onTransportFailure;
    <span class="hljs-keyword">if</span> (_isFunction(callback)) {
      _cometd._debug(<span class="hljs-string">'Invoking transport failure callback'</span>, oldTransport, newTransport, failure);
      <span class="hljs-keyword">try</span> {
        callback.call(_cometd, oldTransport, newTransport, failure);
      } <span class="hljs-keyword">catch</span> (x) {
        _cometd._info(<span class="hljs-string">'Exception during execution of transport failure callback'</span>, x);
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_handshake</span>(<span class="hljs-params">handshakeProps, handshakeCallback</span>) </span>{
    <span class="hljs-keyword">if</span> (_isFunction(handshakeProps)) {
      handshakeCallback = handshakeProps;
      handshakeProps = <span class="hljs-literal">undefined</span>;
    }
    _clientId = <span class="hljs-literal">null</span>;
    _clearSubscriptions();
    <span class="hljs-keyword">if</span> (_isDisconnected()) {
      _transports.reset();
      _updateAdvice(_config.advice);
    } <span class="hljs-keyword">else</span> {
      _updateAdvice(_cometd._mixin(<span class="hljs-literal">false</span>, _advice, {
        <span class="hljs-attr">reconnect</span>: <span class="hljs-string">'retry'</span>
      }));
    }
    _batch = <span class="hljs-number">0</span>;
    _internalBatch = <span class="hljs-literal">true</span>;
    _handshakeProps = handshakeProps;
    _handshakeCallback = handshakeCallback;
    <span class="hljs-keyword">var</span> version = <span class="hljs-string">'1.0'</span>;
    <span class="hljs-keyword">var</span> url = _cometd.getURL();
    <span class="hljs-keyword">var</span> transportTypes = _transports.findTransportTypes(version, _crossDomain, url);
    <span class="hljs-keyword">var</span> bayeuxMessage = {
      <span class="hljs-attr">version</span>: version,
      <span class="hljs-attr">minimumVersion</span>: version,
      <span class="hljs-attr">channel</span>: <span class="hljs-string">'/meta/handshake'</span>,
      <span class="hljs-attr">supportedConnectionTypes</span>: transportTypes,
      <span class="hljs-attr">_callback</span>: handshakeCallback,
      <span class="hljs-attr">advice</span>: {
        <span class="hljs-attr">timeout</span>: _advice.timeout,
        <span class="hljs-attr">interval</span>: _advice.interval
      }
    };
    <span class="hljs-keyword">var</span> message = _cometd._mixin(<span class="hljs-literal">false</span>, {}, _handshakeProps, bayeuxMessage);
    <span class="hljs-keyword">if</span> (!_transport) {
      _transport = _transports.negotiateTransport(transportTypes, version, _crossDomain, url);
      <span class="hljs-keyword">if</span> (!_transport) {
        <span class="hljs-keyword">var</span> failure = <span class="hljs-string">'Could not find initial transport among: '</span> + _transports.getTransportTypes();
        _cometd._warn(failure);
        <span class="hljs-keyword">throw</span> failure;
      }
    }
    _cometd._debug(<span class="hljs-string">'Initial transport is'</span>, _transport.getType());
    _setStatus(<span class="hljs-string">'handshaking'</span>);
    _cometd._debug(<span class="hljs-string">'Handshake sent'</span>, message);
    _send(<span class="hljs-literal">false</span>, [message], <span class="hljs-literal">false</span>, <span class="hljs-string">'handshake'</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_delayedHandshake</span>(<span class="hljs-params"></span>) </span>{
    _setStatus(<span class="hljs-string">'handshaking'</span>);
    _internalBatch = <span class="hljs-literal">true</span>;
    _delayedSend(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      _handshake(_handshakeProps, _handshakeCallback);
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_handleCallback</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">var</span> callback = _callbacks[message.id];
    <span class="hljs-keyword">if</span> (_isFunction(callback)) {
      <span class="hljs-keyword">delete</span> _callbacks[message.id];
      callback.call(_cometd, message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failHandshake</span>(<span class="hljs-params">message</span>) </span>{
    _handleCallback(message);
    _notifyListeners(<span class="hljs-string">'/meta/handshake'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
    <span class="hljs-keyword">var</span> retry = !_isDisconnected() &amp;&amp; _advice.reconnect !== <span class="hljs-string">'none'</span>;
    <span class="hljs-keyword">if</span> (retry) {
      _increaseBackoff();
      _delayedHandshake();
    } <span class="hljs-keyword">else</span> {
      _disconnect(<span class="hljs-literal">false</span>);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_handshakeResponse</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (message.successful) {
      _clientId = message.clientId;
      <span class="hljs-keyword">var</span> url = _cometd.getURL();
      <span class="hljs-keyword">var</span> newTransport = _transports.negotiateTransport(message.supportedConnectionTypes, message.version, _crossDomain, url);
      <span class="hljs-keyword">if</span> (newTransport === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">var</span> failure = <span class="hljs-string">'Could not negotiate transport with server; client=['</span> +
          _transports.findTransportTypes(message.version, _crossDomain, url) +
          <span class="hljs-string">'], server=['</span> + message.supportedConnectionTypes + <span class="hljs-string">']'</span>;
        <span class="hljs-keyword">var</span> oldTransport = _cometd.getTransport();
        _notifyTransportFailure(oldTransport.getType(), <span class="hljs-literal">null</span>, {
          <span class="hljs-attr">reason</span>: failure,
          <span class="hljs-attr">connectionType</span>: oldTransport.getType(),
          <span class="hljs-attr">transport</span>: oldTransport
        });
        _cometd._warn(failure);
        _transport.reset();
        _failHandshake(message);
        <span class="hljs-keyword">return</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_transport !== newTransport) {
        _cometd._debug(<span class="hljs-string">'Transport'</span>, _transport.getType(), <span class="hljs-string">'-&gt;'</span>, newTransport.getType());
        _transport = newTransport;
      }
      _internalBatch = <span class="hljs-literal">false</span>;
      _flushBatch();
      message.reestablish = _reestablish;
      _reestablish = <span class="hljs-literal">true</span>;
      _handleCallback(message);
      _notifyListeners(<span class="hljs-string">'/meta/handshake'</span>, message);
      <span class="hljs-keyword">var</span> action = _isDisconnected() ? <span class="hljs-string">'none'</span> : _advice.reconnect;
      <span class="hljs-keyword">switch</span> (action) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'retry'</span>:
          _resetBackoff();
          _delayedConnect();
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'none'</span>:
          _disconnect(<span class="hljs-literal">false</span>);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Unrecognized advice action '</span> + action;
      }
    } <span class="hljs-keyword">else</span> {
      _failHandshake(message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_handshakeFailure</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">var</span> version = <span class="hljs-string">'1.0'</span>;
    <span class="hljs-keyword">var</span> url = _cometd.getURL();
    <span class="hljs-keyword">var</span> oldTransport = _cometd.getTransport();
    <span class="hljs-keyword">var</span> transportTypes = _transports.findTransportTypes(version, _crossDomain, url);
    <span class="hljs-keyword">var</span> newTransport = _transports.negotiateTransport(transportTypes, version, _crossDomain, url);
    <span class="hljs-keyword">if</span> (!newTransport) {
      _notifyTransportFailure(oldTransport.getType(), <span class="hljs-literal">null</span>, message.failure);
      _cometd._warn(<span class="hljs-string">'Could not negotiate transport; client=['</span> + transportTypes + <span class="hljs-string">']'</span>);
      _transport.reset();
      _failHandshake(message);
    } <span class="hljs-keyword">else</span> {
      _cometd._debug(<span class="hljs-string">'Transport'</span>, oldTransport.getType(), <span class="hljs-string">'-&gt;'</span>, newTransport.getType());
      _notifyTransportFailure(oldTransport.getType(), newTransport.getType(), message.failure);
      _failHandshake(message);
      _transport = newTransport;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failConnect</span>(<span class="hljs-params">message</span>) </span>{
    _notifyListeners(<span class="hljs-string">'/meta/connect'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
    <span class="hljs-keyword">var</span> action = _isDisconnected() ? <span class="hljs-string">'none'</span> : _advice.reconnect;
    <span class="hljs-keyword">switch</span> (action) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'retry'</span>:
        _delayedConnect();
        _increaseBackoff();
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'handshake'</span>:
        _transports.reset();
        _resetBackoff();
        _delayedHandshake();
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'none'</span>:
        _disconnect(<span class="hljs-literal">false</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Unrecognized advice action'</span> + action;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectResponse</span>(<span class="hljs-params">message</span>) </span>{
    _connected = message.successful;
    <span class="hljs-keyword">if</span> (_connected) {
      _notifyListeners(<span class="hljs-string">'/meta/connect'</span>, message);
      <span class="hljs-keyword">var</span> action = _isDisconnected() ? <span class="hljs-string">'none'</span> : _advice.reconnect;
      <span class="hljs-keyword">switch</span> (action) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'retry'</span>:
          _resetBackoff();
          _delayedConnect();
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'none'</span>:
          _disconnect(<span class="hljs-literal">false</span>);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Unrecognized advice action '</span> + action;
      }
    } <span class="hljs-keyword">else</span> {
      _failConnect(message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectFailure</span>(<span class="hljs-params">message</span>) </span>{
    _connected = <span class="hljs-literal">false</span>;
    _failConnect(message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failDisconnect</span>(<span class="hljs-params">message</span>) </span>{
    _disconnect(<span class="hljs-literal">true</span>);
    _handleCallback(message);
    _notifyListeners(<span class="hljs-string">'/meta/disconnect'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_disconnectResponse</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (message.successful) {
      _disconnect(<span class="hljs-literal">false</span>);
      _handleCallback(message);
      _notifyListeners(<span class="hljs-string">'/meta/disconnect'</span>, message);
    } <span class="hljs-keyword">else</span> {
      _failDisconnect(message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_disconnectFailure</span>(<span class="hljs-params">message</span>) </span>{
    _failDisconnect(message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failSubscribe</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">var</span> subscriptions = _listeners[message.subscription];
    <span class="hljs-keyword">if</span> (subscriptions) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = subscriptions.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; --i) {
        <span class="hljs-keyword">var</span> subscription = subscriptions[i];
        <span class="hljs-keyword">if</span> (subscription &amp;&amp; !subscription.listener) {
          <span class="hljs-keyword">delete</span> subscriptions[i];
          _cometd._debug(<span class="hljs-string">'Removed failed subscription'</span>, subscription);
          <span class="hljs-keyword">break</span>;
        }
      }
    }
    _handleCallback(message);
    _notifyListeners(<span class="hljs-string">'/meta/subscribe'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_subscribeResponse</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (message.successful) {
      _handleCallback(message);
      _notifyListeners(<span class="hljs-string">'/meta/subscribe'</span>, message);
    } <span class="hljs-keyword">else</span> {
      _failSubscribe(message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_subscribeFailure</span>(<span class="hljs-params">message</span>) </span>{
    _failSubscribe(message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failUnsubscribe</span>(<span class="hljs-params">message</span>) </span>{
    _handleCallback(message);
    _notifyListeners(<span class="hljs-string">'/meta/unsubscribe'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_unsubscribeResponse</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (message.successful) {
      _handleCallback(message);
      _notifyListeners(<span class="hljs-string">'/meta/unsubscribe'</span>, message);
    } <span class="hljs-keyword">else</span> {
      _failUnsubscribe(message);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_unsubscribeFailure</span>(<span class="hljs-params">message</span>) </span>{
    _failUnsubscribe(message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_failMessage</span>(<span class="hljs-params">message</span>) </span>{
    _handleCallback(message);
    _notifyListeners(<span class="hljs-string">'/meta/publish'</span>, message);
    _notifyListeners(<span class="hljs-string">'/meta/unsuccessful'</span>, message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_messageResponse</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (message.successful === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (message.data !== <span class="hljs-literal">undefined</span>) {
        _notifyListeners(message.channel, message);
      } <span class="hljs-keyword">else</span> {
        _cometd._warn(<span class="hljs-string">'Unknown Bayeux Message'</span>, message);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (message.successful) {
        _handleCallback(message);
        _notifyListeners(<span class="hljs-string">'/meta/publish'</span>, message);
      } <span class="hljs-keyword">else</span> {
        _failMessage(message);
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_messageFailure</span>(<span class="hljs-params">failure</span>) </span>{
    _failMessage(failure);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_receive</span>(<span class="hljs-params">message</span>) </span>{
    message = _applyIncomingExtensions(message);
    <span class="hljs-keyword">if</span> (message === <span class="hljs-literal">undefined</span> || message === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span>;
    }
    _updateAdvice(message.advice);
    <span class="hljs-keyword">var</span> channel = message.channel;
    <span class="hljs-keyword">switch</span> (channel) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/handshake'</span>:
        _handshakeResponse(message);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/connect'</span>:
        _connectResponse(message);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/disconnect'</span>:
        _disconnectResponse(message);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/subscribe'</span>:
        _subscribeResponse(message);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/unsubscribe'</span>:
        _unsubscribeResponse(message);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        _messageResponse(message);
        <span class="hljs-keyword">break</span>;
    }
  }
  <span class="hljs-keyword">this</span>.receive = _receive;
  _handleMessages = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rcvdMessages</span>) </span>{
    _cometd._debug(<span class="hljs-string">'Received'</span>, rcvdMessages);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; rcvdMessages.length; ++i) {
      <span class="hljs-keyword">var</span> message = rcvdMessages[i];
      _receive(message);
    }
  };
  _handleFailure = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">conduit, messages, failure</span>) </span>{
    _cometd._debug(<span class="hljs-string">'handleFailure'</span>, conduit, messages, failure);
    failure.transport = conduit;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; messages.length; ++i) {
      <span class="hljs-keyword">var</span> message = messages[i];
      <span class="hljs-keyword">var</span> failureMessage = {
        <span class="hljs-attr">id</span>: message.id,
        <span class="hljs-attr">successful</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">channel</span>: message.channel,
        <span class="hljs-attr">failure</span>: failure
      };
      failure.message = message;
      <span class="hljs-keyword">switch</span> (message.channel) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/handshake'</span>:
          _handshakeFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/connect'</span>:
          _connectFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/disconnect'</span>:
          _disconnectFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/subscribe'</span>:
          failureMessage.subscription = message.subscription;
          _subscribeFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'/meta/unsubscribe'</span>:
          failureMessage.subscription = message.subscription;
          _unsubscribeFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          _messageFailure(failureMessage);
          <span class="hljs-keyword">break</span>;
      }
    }
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_hasSubscriptions</span>(<span class="hljs-params">channel</span>) </span>{
    <span class="hljs-keyword">var</span> subscriptions = _listeners[channel];
    <span class="hljs-keyword">if</span> (subscriptions) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; subscriptions.length; ++i) {
        <span class="hljs-keyword">if</span> (subscriptions[i]) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_resolveScopedCallback</span>(<span class="hljs-params">scope, callback</span>) </span>{
    <span class="hljs-keyword">var</span> delegate = {
      <span class="hljs-attr">scope</span>: scope,
      <span class="hljs-attr">method</span>: callback
    };
    <span class="hljs-keyword">if</span> (_isFunction(scope)) {
      delegate.scope = <span class="hljs-literal">undefined</span>;
      delegate.method = scope;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (_isString(callback)) {
        <span class="hljs-keyword">if</span> (!scope) {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Invalid scope '</span> + scope;
        }
        delegate.method = scope[callback];
        <span class="hljs-keyword">if</span> (!_isFunction(delegate.method)) {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Invalid callback '</span> + callback + <span class="hljs-string">' for scope '</span> + scope;
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!_isFunction(callback)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Invalid callback '</span> + callback;
      }
    }
    <span class="hljs-keyword">return</span> delegate;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_addListener</span>(<span class="hljs-params">channel, scope, callback, isListener</span>) </span>{
    <span class="hljs-keyword">var</span> delegate = _resolveScopedCallback(scope, callback);
    _cometd._debug(<span class="hljs-string">'Adding'</span>, isListener ? <span class="hljs-string">'listener'</span> : <span class="hljs-string">'subscription'</span>, <span class="hljs-string">'on'</span>, channel, <span class="hljs-string">'with scope'</span>, delegate.scope, <span class="hljs-string">'and callback'</span>, delegate.method);
    <span class="hljs-keyword">var</span> subscription = {
      <span class="hljs-attr">channel</span>: channel,
      <span class="hljs-attr">scope</span>: delegate.scope,
      <span class="hljs-attr">callback</span>: delegate.method,
      <span class="hljs-attr">listener</span>: isListener
    };
    <span class="hljs-keyword">var</span> subscriptions = _listeners[channel];
    <span class="hljs-keyword">if</span> (!subscriptions) {
      subscriptions = [];
      _listeners[channel] = subscriptions;
    }
    subscription.id = subscriptions.push(subscription) - <span class="hljs-number">1</span>;
    _cometd._debug(<span class="hljs-string">'Added'</span>, isListener ? <span class="hljs-string">'listener'</span> : <span class="hljs-string">'subscription'</span>, subscription);
    subscription[<span class="hljs-number">0</span>] = channel;
    subscription[<span class="hljs-number">1</span>] = subscription.id;
    <span class="hljs-keyword">return</span> subscription;
  }
  <span class="hljs-keyword">this</span>.registerTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, transport, index</span>) </span>{
    <span class="hljs-keyword">var</span> result = _transports.add(type, transport, index);
    <span class="hljs-keyword">if</span> (result) {
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Registered transport'</span>, type);
      <span class="hljs-keyword">if</span> (_isFunction(transport.registered)) {
        transport.registered(type, <span class="hljs-keyword">this</span>);
      }
    }
    <span class="hljs-keyword">return</span> result;
  };
  <span class="hljs-keyword">this</span>.getTransportTypes = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _transports.getTransportTypes();
  };
  <span class="hljs-keyword">this</span>.unregisterTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) </span>{
    <span class="hljs-keyword">var</span> transport = _transports.remove(type);
    <span class="hljs-keyword">if</span> (transport !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Unregistered transport'</span>, type);
      <span class="hljs-keyword">if</span> (_isFunction(transport.unregistered)) {
        transport.unregistered();
      }
    }
    <span class="hljs-keyword">return</span> transport;
  };
  <span class="hljs-keyword">this</span>.unregisterTransports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _transports.clear();
  };
  <span class="hljs-keyword">this</span>.findTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">return</span> _transports.find(name);
  };
  <span class="hljs-keyword">this</span>.configure = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">configuration</span>) </span>{
    _configure.call(<span class="hljs-keyword">this</span>, configuration);
  };
  <span class="hljs-keyword">this</span>.init = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">configuration, handshakeProps</span>) </span>{
    <span class="hljs-keyword">this</span>.configure(configuration);
    <span class="hljs-keyword">this</span>.handshake(handshakeProps);
  };
  <span class="hljs-keyword">this</span>.handshake = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handshakeProps, handshakeCallback</span>) </span>{
    _setStatus(<span class="hljs-string">'disconnected'</span>);
    _reestablish = <span class="hljs-literal">false</span>;
    _handshake(handshakeProps, handshakeCallback);
  };
  <span class="hljs-keyword">this</span>.disconnect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sync, disconnectProps, disconnectCallback</span>) </span>{
    <span class="hljs-keyword">if</span> (_isDisconnected()) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> sync !== <span class="hljs-string">'boolean'</span>) {
      disconnectCallback = disconnectProps;
      disconnectProps = sync;
      sync = <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">if</span> (_isFunction(disconnectProps)) {
      disconnectCallback = disconnectProps;
      disconnectProps = <span class="hljs-literal">undefined</span>;
    }
    <span class="hljs-keyword">var</span> bayeuxMessage = {
      <span class="hljs-attr">channel</span>: <span class="hljs-string">'/meta/disconnect'</span>,
      <span class="hljs-attr">_callback</span>: disconnectCallback
    };
    <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, disconnectProps, bayeuxMessage);
    _setStatus(<span class="hljs-string">'disconnecting'</span>);
    _send(sync === <span class="hljs-literal">true</span>, [message], <span class="hljs-literal">false</span>, <span class="hljs-string">'disconnect'</span>);
  };
  <span class="hljs-keyword">this</span>.startBatch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _startBatch();
  };
  <span class="hljs-keyword">this</span>.endBatch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _endBatch();
  };
  <span class="hljs-keyword">this</span>.batch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, callback</span>) </span>{
    <span class="hljs-keyword">var</span> delegate = _resolveScopedCallback(scope, callback);
    <span class="hljs-keyword">this</span>.startBatch();
    <span class="hljs-keyword">try</span> {
      delegate.method.call(delegate.scope);
      <span class="hljs-keyword">this</span>.endBatch();
    } <span class="hljs-keyword">catch</span> (x) {
      <span class="hljs-keyword">this</span>._info(<span class="hljs-string">'Exception during execution of batch'</span>, x);
      <span class="hljs-keyword">this</span>.endBatch();
      <span class="hljs-keyword">throw</span> x;
    }
  };
  <span class="hljs-keyword">this</span>.addListener = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channel, scope, callback</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal arguments number: required 2, got '</span> + <span class="hljs-built_in">arguments</span>.length;
    }
    <span class="hljs-keyword">if</span> (!_isString(channel)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument type: channel must be a string'</span>;
    }
    <span class="hljs-keyword">return</span> _addListener(channel, scope, callback, <span class="hljs-literal">true</span>);
  };
  <span class="hljs-keyword">this</span>.removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">subscription</span>) </span>{
    <span class="hljs-keyword">if</span> (!subscription || !subscription.channel || !(<span class="hljs-string">"id"</span> <span class="hljs-keyword">in</span> subscription)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Invalid argument: expected subscription, not '</span> + subscription;
    }
    _removeListener(subscription);
  };
  <span class="hljs-keyword">this</span>.clearListeners = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _listeners = {};
  };
  <span class="hljs-keyword">this</span>.subscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channel, scope, callback, subscribeProps, subscribeCallback</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal arguments number: required 2, got '</span> + <span class="hljs-built_in">arguments</span>.length;
    }
    <span class="hljs-keyword">if</span> (!_isString(channel)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument type: channel must be a string'</span>;
    }
    <span class="hljs-keyword">if</span> (_isDisconnected()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal state: already disconnected'</span>;
    }
    <span class="hljs-keyword">if</span> (_isFunction(scope)) {
      subscribeCallback = subscribeProps;
      subscribeProps = callback;
      callback = scope;
      scope = <span class="hljs-literal">undefined</span>;
    }
    <span class="hljs-keyword">if</span> (_isFunction(subscribeProps)) {
      subscribeCallback = subscribeProps;
      subscribeProps = <span class="hljs-literal">undefined</span>;
    }
    <span class="hljs-keyword">var</span> send = !_hasSubscriptions(channel);
    <span class="hljs-keyword">var</span> subscription = _addListener(channel, scope, callback, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">if</span> (send) {
      <span class="hljs-keyword">var</span> bayeuxMessage = {
        <span class="hljs-attr">channel</span>: <span class="hljs-string">'/meta/subscribe'</span>,
        <span class="hljs-attr">subscription</span>: channel,
        <span class="hljs-attr">_callback</span>: subscribeCallback
      };
      <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, subscribeProps, bayeuxMessage);
      _queueSend(message);
    }
    <span class="hljs-keyword">return</span> subscription;
  };
  <span class="hljs-keyword">this</span>.unsubscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">subscription, unsubscribeProps, unsubscribeCallback</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal arguments number: required 1, got '</span> + <span class="hljs-built_in">arguments</span>.length;
    }
    <span class="hljs-keyword">if</span> (_isDisconnected()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal state: already disconnected'</span>;
    }
    <span class="hljs-keyword">if</span> (_isFunction(unsubscribeProps)) {
      unsubscribeCallback = unsubscribeProps;
      unsubscribeProps = <span class="hljs-literal">undefined</span>;
    }
    <span class="hljs-keyword">this</span>.removeListener(subscription);
    <span class="hljs-keyword">var</span> channel = subscription.channel;
    <span class="hljs-keyword">if</span> (!_hasSubscriptions(channel)) {
      <span class="hljs-keyword">var</span> bayeuxMessage = {
        <span class="hljs-attr">channel</span>: <span class="hljs-string">'/meta/unsubscribe'</span>,
        <span class="hljs-attr">subscription</span>: channel,
        <span class="hljs-attr">_callback</span>: unsubscribeCallback
      };
      <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, unsubscribeProps, bayeuxMessage);
      _queueSend(message);
    }
  };
  <span class="hljs-keyword">this</span>.resubscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">subscription, subscribeProps</span>) </span>{
    _removeSubscription(subscription);
    <span class="hljs-keyword">if</span> (subscription) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.subscribe(subscription.channel, subscription.scope, subscription.callback, subscribeProps);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  };
  <span class="hljs-keyword">this</span>.clearSubscriptions = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _clearSubscriptions();
  };
  <span class="hljs-keyword">this</span>.publish = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channel, content, publishProps, publishCallback</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal arguments number: required 1, got '</span> + <span class="hljs-built_in">arguments</span>.length;
    }
    <span class="hljs-keyword">if</span> (!_isString(channel)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument type: channel must be a string'</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^\/meta\//</span>.test(channel)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument: cannot publish to meta channels'</span>;
    }
    <span class="hljs-keyword">if</span> (_isDisconnected()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal state: already disconnected'</span>;
    }
    <span class="hljs-keyword">if</span> (_isFunction(content)) {
      publishCallback = content;
      content = publishProps = {};
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_isFunction(publishProps)) {
      publishCallback = publishProps;
      publishProps = {};
    }
    <span class="hljs-keyword">var</span> bayeuxMessage = {
      <span class="hljs-attr">channel</span>: channel,
      <span class="hljs-attr">data</span>: content,
      <span class="hljs-attr">_callback</span>: publishCallback
    };
    <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">false</span>, {}, publishProps, bayeuxMessage);
    _queueSend(message);
  };
  <span class="hljs-keyword">this</span>.getStatus = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _status;
  };
  <span class="hljs-keyword">this</span>.isDisconnected = _isDisconnected;
  <span class="hljs-keyword">this</span>.setBackoffIncrement = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">period</span>) </span>{
    _config.backoffIncrement = period;
  };
  <span class="hljs-keyword">this</span>.getBackoffIncrement = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _config.backoffIncrement;
  };
  <span class="hljs-keyword">this</span>.getBackoffPeriod = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _backoff;
  };
  <span class="hljs-keyword">this</span>.setLogLevel = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">level</span>) </span>{
    _config.logLevel = level;
  };
  <span class="hljs-keyword">this</span>.registerExtension = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, extension</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt; <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal arguments number: required 2, got '</span> + <span class="hljs-built_in">arguments</span>.length;
    }
    <span class="hljs-keyword">if</span> (!_isString(name)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument type: extension name must be a string'</span>;
    }
    <span class="hljs-keyword">var</span> existing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _extensions.length; ++i) {
      <span class="hljs-keyword">var</span> existingExtension = _extensions[i];
      <span class="hljs-keyword">if</span> (existingExtension.name === name) {
        existing = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">break</span>;
      }
    }
    <span class="hljs-keyword">if</span> (!existing) {
      _extensions.push({
        <span class="hljs-attr">name</span>: name,
        <span class="hljs-attr">extension</span>: extension
      });
      <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Registered extension'</span>, name);
      <span class="hljs-keyword">if</span> (_isFunction(extension.registered)) {
        extension.registered(name, <span class="hljs-keyword">this</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>._info(<span class="hljs-string">'Could not register extension with name'</span>, name, <span class="hljs-string">'since another extension with the same name already exists'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  };
  <span class="hljs-keyword">this</span>.unregisterExtension = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">if</span> (!_isString(name)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Illegal argument type: extension name must be a string'</span>;
    }
    <span class="hljs-keyword">var</span> unregistered = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _extensions.length; ++i) {
      <span class="hljs-keyword">var</span> extension = _extensions[i];
      <span class="hljs-keyword">if</span> (extension.name === name) {
        _extensions.splice(i, <span class="hljs-number">1</span>);
        unregistered = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>._debug(<span class="hljs-string">'Unregistered extension'</span>, name);
        <span class="hljs-keyword">var</span> ext = extension.extension;
        <span class="hljs-keyword">if</span> (_isFunction(ext.unregistered)) {
          ext.unregistered();
        }
        <span class="hljs-keyword">break</span>;
      }
    }
    <span class="hljs-keyword">return</span> unregistered;
  };
  <span class="hljs-keyword">this</span>.getExtension = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _extensions.length; ++i) {
      <span class="hljs-keyword">var</span> extension = _extensions[i];
      <span class="hljs-keyword">if</span> (extension.name === name) {
        <span class="hljs-keyword">return</span> extension.extension;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };
  <span class="hljs-keyword">this</span>.getName = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _name;
  };
  <span class="hljs-keyword">this</span>.getClientId = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _clientId;
  };
  <span class="hljs-keyword">this</span>.getURL = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (_transport &amp;&amp; <span class="hljs-keyword">typeof</span> _config.urls === <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">var</span> url = _config.urls[_transport.getType()];
      <span class="hljs-keyword">if</span> (url) {
        <span class="hljs-keyword">return</span> url;
      }
    }
    <span class="hljs-keyword">return</span> _config.url;
  };
  <span class="hljs-keyword">this</span>.getTransport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> _transport;
  };
  <span class="hljs-keyword">this</span>.getConfiguration = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">true</span>, {}, _config);
  };
  <span class="hljs-keyword">this</span>.getAdvice = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._mixin(<span class="hljs-literal">true</span>, {}, _advice);
  };
  org.cometd.WebSocket = <span class="hljs-built_in">window</span>.WebSocket;
  <span class="hljs-keyword">if</span> (!org.cometd.WebSocket) {
    org.cometd.WebSocket = <span class="hljs-built_in">window</span>.MozWebSocket;
  }
};
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {
  define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> org.cometd;
  });
};
<span class="hljs-comment">/*! RESOURCE: /scripts/thirdparty/cometd/jquery/jquery.cometd.js */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bind</span>(<span class="hljs-params">$, org_cometd</span>) </span>{
    org_cometd.JSON.toJSON = (<span class="hljs-built_in">window</span>.JSON &amp;&amp; <span class="hljs-built_in">JSON</span>.stringify) || (<span class="hljs-built_in">window</span>.jaredJSON &amp;&amp; <span class="hljs-built_in">window</span>.jaredJSON.stringify);
    org_cometd.JSON.fromJSON = (<span class="hljs-built_in">window</span>.JSON &amp;&amp; <span class="hljs-built_in">JSON</span>.parse) || (<span class="hljs-built_in">window</span>.jaredJSON &amp;&amp; <span class="hljs-built_in">window</span>.jaredJSON.parse);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_setHeaders</span>(<span class="hljs-params">xhr, headers</span>) </span>{
      <span class="hljs-keyword">if</span> (headers) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> headerName <span class="hljs-keyword">in</span> headers) {
          <span class="hljs-keyword">if</span> (headerName.toLowerCase() === <span class="hljs-string">'content-type'</span>) {
            <span class="hljs-keyword">continue</span>;
          }
          xhr.setRequestHeader(headerName, headers[headerName]);
        }
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">LongPollingTransport</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org_cometd.LongPollingTransport();
      <span class="hljs-keyword">var</span> that = org_cometd.Transport.derive(_super);
      that.xhrSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">packet</span>) </span>{
        <span class="hljs-keyword">return</span> $.ajax({
          <span class="hljs-attr">url</span>: packet.url,
          <span class="hljs-attr">async</span>: packet.sync !== <span class="hljs-literal">true</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'POST'</span>,
          <span class="hljs-attr">contentType</span>: <span class="hljs-string">'application/json;charset=UTF-8'</span>,
          <span class="hljs-attr">data</span>: packet.body,
          <span class="hljs-attr">xhrFields</span>: {
            <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">true</span>
          },
          <span class="hljs-attr">beforeSend</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr</span>) </span>{
            _setHeaders(xhr, packet.headers);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
          },
          <span class="hljs-attr">success</span>: packet.onSuccess,
          <span class="hljs-attr">error</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr, reason, exception</span>) </span>{
            packet.onError(reason, exception);
          }
        });
      };
      <span class="hljs-keyword">return</span> that;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CallbackPollingTransport</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> _super = <span class="hljs-keyword">new</span> org_cometd.CallbackPollingTransport();
      <span class="hljs-keyword">var</span> that = org_cometd.Transport.derive(_super);
      that.jsonpSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">packet</span>) </span>{
        $.ajax({
          <span class="hljs-attr">url</span>: packet.url,
          <span class="hljs-attr">async</span>: packet.sync !== <span class="hljs-literal">true</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'GET'</span>,
          <span class="hljs-attr">dataType</span>: <span class="hljs-string">'jsonp'</span>,
          <span class="hljs-attr">jsonp</span>: <span class="hljs-string">'jsonp'</span>,
          <span class="hljs-attr">data</span>: {
            <span class="hljs-attr">message</span>: packet.body
          },
          <span class="hljs-attr">beforeSend</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr</span>) </span>{
            _setHeaders(xhr, packet.headers);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
          },
          <span class="hljs-attr">success</span>: packet.onSuccess,
          <span class="hljs-attr">error</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">xhr, reason, exception</span>) </span>{
            packet.onError(reason, exception);
          }
        });
      };
      <span class="hljs-keyword">return</span> that;
    }
    $.Cometd = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
      <span class="hljs-keyword">var</span> cometd = <span class="hljs-keyword">new</span> org_cometd.Cometd(name);
      <span class="hljs-keyword">if</span> (org_cometd.WebSocket) {
        cometd.registerTransport(<span class="hljs-string">'websocket'</span>, <span class="hljs-keyword">new</span> org_cometd.WebSocketTransport());
      }
      cometd.registerTransport(<span class="hljs-string">'long-polling'</span>, <span class="hljs-keyword">new</span> LongPollingTransport());
      cometd.registerTransport(<span class="hljs-string">'callback-polling'</span>, <span class="hljs-keyword">new</span> CallbackPollingTransport());
      <span class="hljs-keyword">return</span> cometd;
    };
    $.cometd = <span class="hljs-keyword">new</span> $.Cometd();
    <span class="hljs-keyword">return</span> $.cometd;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {
    define([<span class="hljs-string">'jquery'</span>, <span class="hljs-string">'org/cometd'</span>], bind);
  } <span class="hljs-keyword">else</span> {
    bind(<span class="hljs-built_in">window</span>.jQuery || <span class="hljs-built_in">window</span>.Zepto, org.cometd);
  }
})();;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb_properties.js */</span>
<span class="hljs-keyword">var</span> amb = amb || {
  <span class="hljs-attr">properties</span>: {
    <span class="hljs-attr">servletURI</span>: <span class="hljs-string">'amb/'</span>,
    <span class="hljs-attr">logLevel</span>: <span class="hljs-string">'info'</span>,
    <span class="hljs-attr">loginWindow</span>: <span class="hljs-string">'true'</span>
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.Logger.js */</span>
amb[<span class="hljs-string">'Logger'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callerType</span>) </span>{
  <span class="hljs-keyword">var</span> _debugEnabled = amb[<span class="hljs-string">'properties'</span>][<span class="hljs-string">'logLevel'</span>] == <span class="hljs-string">'debug'</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">print</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.console)
      <span class="hljs-built_in">console</span>.log(callerType + <span class="hljs-string">' '</span> + message);
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">debug</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      <span class="hljs-keyword">if</span> (_debugEnabled)
        print(<span class="hljs-string">'[DEBUG] '</span> + message);
    },
    <span class="hljs-attr">addInfoMessage</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      print(<span class="hljs-string">'[INFO] '</span> + message);
    },
    <span class="hljs-attr">addErrorMessage</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      print(<span class="hljs-string">'[ERROR] '</span> + message);
    }
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.EventManager.js */</span>
amb.EventManager = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EventManager</span>(<span class="hljs-params">events</span>) </span>{
  <span class="hljs-keyword">var</span> _subscriptions = [];
  <span class="hljs-keyword">var</span> _idCounter = <span class="hljs-number">0</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getSubscriptions</span>(<span class="hljs-params">event</span>) </span>{
    <span class="hljs-keyword">var</span> subscriptions = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _subscriptions.length; i++) {
      <span class="hljs-keyword">if</span> (_subscriptions[i].event == event)
        subscriptions.push(_subscriptions[i]);
    }
    <span class="hljs-keyword">return</span> subscriptions;
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">subscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
      <span class="hljs-keyword">var</span> id = _idCounter++;
      _subscriptions.push({
        <span class="hljs-attr">event</span>: event,
        <span class="hljs-attr">callback</span>: callback,
        <span class="hljs-attr">id</span>: id
      });
      <span class="hljs-keyword">return</span> id;
    },
    <span class="hljs-attr">unsubscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _subscriptions.length; i++)
        <span class="hljs-keyword">if</span> (id == _subscriptions[i].id)
          _subscriptions.splice(i, <span class="hljs-number">1</span>);
    },
    <span class="hljs-attr">publish</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, args</span>) </span>{
      <span class="hljs-keyword">var</span> subscriptions = _getSubscriptions(event);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; subscriptions.length; i++)
        subscriptions[i].callback.apply(<span class="hljs-literal">null</span>, args);
    },
    <span class="hljs-attr">getEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> events;
    }
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.ServerConnection.js */</span>
amb.ServerConnection = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ServerConnection</span>(<span class="hljs-params">cometd</span>) </span>{
  <span class="hljs-keyword">var</span> connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> disconnecting = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> eventManager = <span class="hljs-keyword">new</span> amb.EventManager({
    <span class="hljs-attr">CONNECTION_INITIALIZED</span>: <span class="hljs-string">'connection.initialized'</span>,
    <span class="hljs-attr">CONNECTION_OPENED</span>: <span class="hljs-string">'connection.opened'</span>,
    <span class="hljs-attr">CONNECTION_CLOSED</span>: <span class="hljs-string">'connection.closed'</span>,
    <span class="hljs-attr">CONNECTION_BROKEN</span>: <span class="hljs-string">'connection.broken'</span>,
    <span class="hljs-attr">SESSION_LOGGED_IN</span>: <span class="hljs-string">'session.logged.in'</span>,
    <span class="hljs-attr">SESSION_LOGGED_OUT</span>: <span class="hljs-string">'session.logged.out'</span>,
    <span class="hljs-attr">SESSION_INVALIDATED</span>: <span class="hljs-string">'session.invalidated'</span>
  });
  <span class="hljs-keyword">var</span> state = <span class="hljs-string">"closed"</span>;
  <span class="hljs-keyword">var</span> LOGGER = <span class="hljs-keyword">new</span> amb.Logger(<span class="hljs-string">'amb.ServerConnection'</span>);
  _initializeMetaChannelListeners();
  <span class="hljs-keyword">var</span> loggedIn = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> loginWindow = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> loginWindowEnabled = amb.properties[<span class="hljs-string">'loginWindow'</span>] === <span class="hljs-string">'true'</span>;
  <span class="hljs-keyword">var</span> lastError = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> errorMessages = {
    <span class="hljs-string">'UNKNOWN_CLIENT'</span>: <span class="hljs-string">'402::Unknown client'</span>
  };
  <span class="hljs-keyword">var</span> loginWindowOverride = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> ambServerConnection = {};
  ambServerConnection.connect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (connected) {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"&gt;&gt;&gt; connection exists, request satisfied"</span>);
      <span class="hljs-keyword">return</span>;
    }
    LOGGER.debug(<span class="hljs-string">'Connecting to glide amb server -&gt; '</span> + amb[<span class="hljs-string">'properties'</span>][<span class="hljs-string">'servletURI'</span>]);
    cometd.configure({
      <span class="hljs-attr">url</span>: _getRelativePath(amb[<span class="hljs-string">'properties'</span>][<span class="hljs-string">'servletURI'</span>]),
      <span class="hljs-attr">logLevel</span>: amb[<span class="hljs-string">'properties'</span>][<span class="hljs-string">'logLevel'</span>]
    });
    cometd.handshake();
  };
  ambServerConnection.reload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    cometd.reload();
  };
  ambServerConnection.abort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    cometd.getTransport().abort();
  };
  ambServerConnection.disconnect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.debug(<span class="hljs-string">'Disconnecting from glide amb server..'</span>);
    disconnecting = <span class="hljs-literal">true</span>;
    cometd.disconnect();
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initializeMetaChannelListeners</span>(<span class="hljs-params"></span>) </span>{
    cometd.addListener(<span class="hljs-string">'/meta/handshake'</span>, <span class="hljs-keyword">this</span>, _metaHandshake);
    cometd.addListener(<span class="hljs-string">'/meta/connect'</span>, <span class="hljs-keyword">this</span>, _metaConnect);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_metaHandshake</span>(<span class="hljs-params">message</span>) </span>{
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (message[<span class="hljs-string">'successful'</span>])
        _connectionInitialized();
    }, <span class="hljs-number">0</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_metaConnect</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (disconnecting) {
      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        connected = <span class="hljs-literal">false</span>;
        _connectionClosed();
      }, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> error = message[<span class="hljs-string">'error'</span>];
    <span class="hljs-keyword">if</span> (error)
      lastError = error;
    _sessionStatus(message);
    <span class="hljs-keyword">var</span> wasConnected = connected;
    connected = (message[<span class="hljs-string">'successful'</span>] === <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">if</span> (!wasConnected &amp;&amp; connected)
      _connectionOpened();
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (wasConnected &amp;&amp; !connected)
      _connectionBroken();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionInitialized</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.debug(<span class="hljs-string">'Connection initialized'</span>);
    state = <span class="hljs-string">"initialized"</span>;
    eventManager.publish(eventManager.getEvents().CONNECTION_INITIALIZED);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionOpened</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.debug(<span class="hljs-string">'Connection opened'</span>);
    state = <span class="hljs-string">"opened"</span>;
    eventManager.publish(eventManager.getEvents().CONNECTION_OPENED);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionClosed</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.debug(<span class="hljs-string">'Connection closed'</span>);
    state = <span class="hljs-string">"closed"</span>;
    eventManager.publish(eventManager.getEvents().CONNECTION_CLOSED);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionBroken</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.addErrorMessage(<span class="hljs-string">'Connection broken'</span>);
    state = <span class="hljs-string">"broken"</span>;
    eventManager.publish(eventManager.getEvents().CONNECTION_BROKEN);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_sessionStatus</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">var</span> ext = message[<span class="hljs-string">'ext'</span>];
    <span class="hljs-keyword">if</span> (ext) {
      <span class="hljs-keyword">var</span> sessionStatus = ext[<span class="hljs-string">'glide.session.status'</span>];
      loginWindowOverride = ext[<span class="hljs-string">'glide.amb.login.window.override'</span>] === <span class="hljs-literal">true</span>;
      LOGGER.debug(<span class="hljs-string">'session.status - '</span> + sessionStatus);
      <span class="hljs-keyword">switch</span> (sessionStatus) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'session.logged.out'</span>:
          <span class="hljs-keyword">if</span> (loggedIn)
            _logout();
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'session.logged.in'</span>:
          <span class="hljs-keyword">if</span> (!loggedIn)
            _login();
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'session.invalidated'</span>:
          <span class="hljs-keyword">if</span> (loggedIn)
            _invalidated();
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          LOGGER.debug(<span class="hljs-string">"unknown session status - "</span> + sessionStatus);
          <span class="hljs-keyword">break</span>;
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_login</span>(<span class="hljs-params"></span>) </span>{
    loggedIn = <span class="hljs-literal">true</span>;
    LOGGER.debug(<span class="hljs-string">"LOGGED_IN event fire!"</span>);
    eventManager.publish(eventManager.getEvents().SESSION_LOGGED_IN);
    ambServerConnection.loginHide();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_logout</span>(<span class="hljs-params"></span>) </span>{
    loggedIn = <span class="hljs-literal">false</span>;
    LOGGER.debug(<span class="hljs-string">"LOGGED_OUT event fire!"</span>);
    eventManager.publish(eventManager.getEvents().SESSION_LOGGED_OUT);
    ambServerConnection.loginShow();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_invalidated</span>(<span class="hljs-params"></span>) </span>{
    loggedIn = <span class="hljs-literal">false</span>;
    LOGGER.debug(<span class="hljs-string">"INVALIDATED event fire!"</span>);
    eventManager.publish(eventManager.getEvents().SESSION_INVALIDATED);
  }
  <span class="hljs-keyword">var</span> modalContent = <span class="hljs-string">'&lt;iframe src="/amb_login.do" frameborder="0" height="400px" width="405px" scrolling="no"&gt;&lt;/iframe&gt;'</span>;
  <span class="hljs-keyword">var</span> modalTemplate = <span class="hljs-string">'&lt;div id="amb_disconnect_modal" tabindex="-1" aria-hidden="true" class="modal" role="dialog"&gt;'</span> +
    <span class="hljs-string">'  &lt;div class="modal-dialog small-modal" style="width:450px"&gt;'</span> +
    <span class="hljs-string">'     &lt;div class="modal-content"&gt;'</span> +
    <span class="hljs-string">'        &lt;header class="modal-header"&gt;'</span> +
    <span class="hljs-string">'           &lt;h4 id="small_modal1_title" class="modal-title"&gt;Login&lt;/h4&gt;'</span> +
    <span class="hljs-string">'        &lt;/header&gt;'</span> +
    <span class="hljs-string">'        &lt;div class="modal-body"&gt;'</span> +
    <span class="hljs-string">'        &lt;/div&gt;'</span> +
    <span class="hljs-string">'     &lt;/div&gt;'</span> +
    <span class="hljs-string">'  &lt;/div&gt;'</span> +
    <span class="hljs-string">'&lt;/div&gt;'</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_loginShow</span>(<span class="hljs-params"></span>) </span>{
    LOGGER.debug(<span class="hljs-string">"Show login window"</span>);
    <span class="hljs-keyword">if</span> (!loginWindowEnabled || loginWindowOverride)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> dialog = <span class="hljs-keyword">new</span> GlideModal(<span class="hljs-string">'amb_disconnect_modal'</span>);
    <span class="hljs-keyword">if</span> (dialog[<span class="hljs-string">'renderWithContent'</span>]) {
      dialog.template = modalTemplate;
      dialog.renderWithContent(modalContent);
    } <span class="hljs-keyword">else</span> {
      dialog.setBody(modalContent);
      dialog.render();
    }
    loginWindow = dialog;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_loginHide</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!loginWindow)
      <span class="hljs-keyword">return</span>;
    loginWindow.destroy();
    loginWindow = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loginComplete</span>(<span class="hljs-params"></span>) </span>{
    _login();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getRelativePath</span>(<span class="hljs-params">uri</span>) </span>{
    <span class="hljs-keyword">var</span> relativePath = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">window</span>.location.pathname.match(<span class="hljs-regexp">/\//g</span>).length - <span class="hljs-number">1</span>; i++) {
      relativePath = <span class="hljs-string">"../"</span> + relativePath;
    }
    <span class="hljs-keyword">return</span> relativePath + uri;
  }
  ambServerConnection.getEvents = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> eventManager.getEvents();
  };
  ambServerConnection.getConnectionState = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> state;
  };
  ambServerConnection.getLastError = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> lastError;
  };
  ambServerConnection.setLastError = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
    lastError = error;
  };
  ambServerConnection.getErrorMessages = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> errorMessages;
  };
  ambServerConnection.isLoggedIn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> loggedIn;
  };
  ambServerConnection.loginShow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _loginShow();
  };
  ambServerConnection.loginHide = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _loginHide();
  };
  ambServerConnection.loginComplete = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _login();
  };
  ambServerConnection.subscribeToEvent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
    <span class="hljs-keyword">if</span> (eventManager.getEvents().CONNECTION_OPENED == event &amp;&amp; connected)
      callback();
    <span class="hljs-keyword">return</span> eventManager.subscribe(event, callback);
  };
  ambServerConnection.unsubscribeFromEvent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
    eventManager.unsubscribe(id);
  };
  ambServerConnection.getConnectionState = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> state;
  };
  ambServerConnection.isLoginWindowEnabled = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> loginWindowEnabled;
  };
  ambServerConnection.isLoginWindowOverride = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> loginWindowOverride;
  }
  <span class="hljs-keyword">return</span> ambServerConnection;
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.ChannelRedirect.js */</span>
amb.ChannelRedirect = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ChannelRedirect</span>(<span class="hljs-params">cometd, serverConnection,
  channelProvider</span>) </span>{
  <span class="hljs-keyword">var</span> initialized = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> _cometd = cometd;
  <span class="hljs-keyword">var</span> eventManager = <span class="hljs-keyword">new</span> amb.EventManager({
    <span class="hljs-attr">CHANNEL_REDIRECT</span>: <span class="hljs-string">'channel.redirect'</span>
  });
  <span class="hljs-keyword">var</span> LOGGER = <span class="hljs-keyword">new</span> amb.Logger(<span class="hljs-string">'amb.ChannelRedirect'</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_onAdvice</span>(<span class="hljs-params">advice</span>) </span>{
    LOGGER.debug(<span class="hljs-string">'_onAdvice:'</span> + advice.data.clientId);
    <span class="hljs-keyword">var</span> fromChannel = channelProvider(advice.data.fromChannel);
    <span class="hljs-keyword">var</span> toChannel = channelProvider(advice.data.toChannel);
    eventManager.publish(eventManager.getEvents().CHANNEL_REDIRECT, [fromChannel, toChannel]);
    LOGGER.debug(
      <span class="hljs-string">'published channel switch event, fromChannel:'</span> + fromChannel.getName() +
      <span class="hljs-string">', toChannel:'</span> + toChannel.getName());
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">subscribeToEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
      <span class="hljs-keyword">return</span> eventManager.subscribe(event, callback);
    },
    <span class="hljs-attr">unsubscribeToEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
      eventManager.unsubscribe(id);
    },
    <span class="hljs-attr">getEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> eventManager.getEvents();
    },
    <span class="hljs-attr">initialize</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!initialized) {
        <span class="hljs-keyword">var</span> channelName = <span class="hljs-string">'/sn/meta/channel_redirect/'</span> + _cometd.getClientId();
        <span class="hljs-keyword">var</span> metaChannel = channelProvider(channelName);
        metaChannel.newListener(serverConnection, <span class="hljs-literal">null</span>).subscribe(_onAdvice);
        LOGGER.debug(<span class="hljs-string">"ChannelRedirect initialized: "</span> + channelName);
        initialized = <span class="hljs-literal">true</span>;
      }
    }
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.ChannelListener.js */</span>
amb.ChannelListener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ChannelListener</span>(<span class="hljs-params">channel, serverConnection,
  channelRedirect</span>) </span>{
  <span class="hljs-keyword">var</span> id;
  <span class="hljs-keyword">var</span> subscriberCallback;
  <span class="hljs-keyword">var</span> LOGGER = <span class="hljs-keyword">new</span> amb.Logger(<span class="hljs-string">'amb.ChannelListener'</span>);
  <span class="hljs-keyword">var</span> channelRedirectId = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> connectOpenedEventId;
  <span class="hljs-keyword">var</span> currentChannel = channel;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">getCallback</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> subscriberCallback;
    },
    <span class="hljs-attr">getID</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> id;
    },
    <span class="hljs-attr">subscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
      subscriberCallback = callback;
      <span class="hljs-keyword">if</span> (channelRedirect)
        channelRedirectId = channelRedirect.subscribeToEvent(
          channelRedirect.getEvents().CHANNEL_REDIRECT, <span class="hljs-keyword">this</span>._switchToChannel.bind(<span class="hljs-keyword">this</span>));
      connectOpenedEventId = serverConnection.subscribeToEvent(serverConnection.getEvents().CONNECTION_OPENED, <span class="hljs-keyword">this</span>._subscribeWhenReady.bind(<span class="hljs-keyword">this</span>));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },
    <span class="hljs-attr">resubscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.subscribe(subscriberCallback);
    },
    <span class="hljs-attr">_switchToChannel</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fromChannel, toChannel</span>) </span>{
      <span class="hljs-keyword">if</span> (!fromChannel || !toChannel)
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (fromChannel.getName() != currentChannel.getName())
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">this</span>.unsubscribe();
      currentChannel = toChannel;
      <span class="hljs-keyword">this</span>.subscribe(subscriberCallback);
    },
    <span class="hljs-attr">_subscribeWhenReady</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      LOGGER.debug(<span class="hljs-string">"Subscribing to '"</span> + currentChannel.getName() + <span class="hljs-string">"'..."</span>);
      id = currentChannel.subscribe(<span class="hljs-keyword">this</span>);
    },
    <span class="hljs-attr">unsubscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      channelRedirect.unsubscribeToEvent(channelRedirectId);
      currentChannel.unsubscribe(<span class="hljs-keyword">this</span>);
      serverConnection.unsubscribeFromEvent(connectOpenedEventId);
      LOGGER.debug(<span class="hljs-string">"Unsubscribed from channel: "</span> + currentChannel.getName());
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },
    <span class="hljs-attr">publish</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      currentChannel.publish(message);
    },
    <span class="hljs-attr">getName</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> currentChannel.getName();
    }
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.Channel.js */</span>
amb.Channel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Channel</span>(<span class="hljs-params">cometd, channelName, initialized</span>) </span>{
  <span class="hljs-keyword">var</span> subscription = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> listeners = [];
  <span class="hljs-keyword">var</span> LOGGER = <span class="hljs-keyword">new</span> amb.Logger(<span class="hljs-string">'amb.Channel'</span>);
  <span class="hljs-keyword">var</span> idCounter = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> _initialized = initialized;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_disconnected</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> status = cometd.getStatus();
    <span class="hljs-keyword">return</span> status === <span class="hljs-string">'disconnecting'</span> || status === <span class="hljs-string">'disconnected'</span>;
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">newListener</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serverConnection,
      channelRedirect</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> amb.ChannelListener(<span class="hljs-keyword">this</span>, serverConnection, channelRedirect);
    },
    <span class="hljs-attr">subscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">listener</span>) </span>{
      <span class="hljs-keyword">if</span> (!listener.getCallback()) {
        LOGGER.addErrorMessage(<span class="hljs-string">'Cannot subscribe to channel: '</span> + channelName +
          <span class="hljs-string">', callback not provided'</span>);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">if</span> (!subscription &amp;&amp; _initialized)
        <span class="hljs-keyword">this</span>.subscribeToCometD();
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++) {
        <span class="hljs-keyword">if</span> (listeners[i] === listener) {
          LOGGER.debug(<span class="hljs-string">'Channel listener already in the list'</span>);
          <span class="hljs-keyword">return</span> listener.getID();
        }
      }
      <span class="hljs-keyword">var</span> id = idCounter++;
      listeners.push(listener);
      <span class="hljs-keyword">return</span> id;
    },
    <span class="hljs-attr">resubscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      subscription = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++)
        listeners[i].resubscribe();
    },
    <span class="hljs-attr">subscribeOnInitCompletion</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">redirect</span>) </span>{
      _initialized = <span class="hljs-literal">true</span>;
      subscription = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++) {
        listeners[i].subscribe();
        LOGGER.debug(<span class="hljs-string">'Successfully subscribed to channel: '</span> + channelName);
      }
    },
    <span class="hljs-attr">_handleResponse</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++)
        listeners[i].getCallback()(message);
    },
    <span class="hljs-attr">unsubscribe</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">listener</span>) </span>{
      <span class="hljs-keyword">if</span> (!listener) {
        LOGGER.addErrorMessage(<span class="hljs-string">'Cannot unsubscribe from channel: '</span> + channelName +
          <span class="hljs-string">', listener argument does not exist'</span>);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++) {
        <span class="hljs-keyword">if</span> (listeners[i].getID() == listener.getID())
          listeners.splice(i, <span class="hljs-number">1</span>);
      }
      <span class="hljs-keyword">if</span> (listeners.length &lt; <span class="hljs-number">1</span> &amp;&amp; subscription &amp;&amp; !_disconnected())
        <span class="hljs-keyword">this</span>.unsubscribeFromCometD();
    },
    <span class="hljs-attr">publish</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
      cometd.publish(channelName, message);
    },
    <span class="hljs-attr">subscribeToCometD</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      subscription = cometd.subscribe(channelName, <span class="hljs-keyword">this</span>._handleResponse.bind(<span class="hljs-keyword">this</span>));
      LOGGER.debug(<span class="hljs-string">'Successfully subscribed to channel: '</span> + channelName);
    },
    <span class="hljs-attr">unsubscribeFromCometD</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      cometd.unsubscribe(subscription);
      subscription = <span class="hljs-literal">null</span>;
      LOGGER.debug(<span class="hljs-string">'Successfully unsubscribed from channel: '</span> + channelName);
    },
    <span class="hljs-attr">resubscribeToCometD</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">this</span>.subscribeToCometD();
    },
    <span class="hljs-attr">getName</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> channelName;
    }
  }
};;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.MessageClient.js */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$</span>) </span>{
  amb.MessageClient = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MessageClient</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> cometd = <span class="hljs-keyword">new</span> $.Cometd();
    cometd.unregisterTransport(<span class="hljs-string">'websocket'</span>);
    cometd.unregisterTransport(<span class="hljs-string">'callback-polling'</span>);
    <span class="hljs-keyword">var</span> serverConnection = <span class="hljs-keyword">new</span> amb.ServerConnection(cometd);
    <span class="hljs-keyword">var</span> channels = {};
    <span class="hljs-keyword">var</span> LOGGER = <span class="hljs-keyword">new</span> amb.Logger(<span class="hljs-string">'amb.MessageClient'</span>);
    <span class="hljs-keyword">var</span> channelRedirect = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> connected = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> initialized = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> uninitializedChannels = [];
    serverConnection.subscribeToEvent(serverConnection.getEvents().CONNECTION_BROKEN, _connectionBroken);
    serverConnection.subscribeToEvent(serverConnection.getEvents().CONNECTION_OPENED, _connectionOpened);
    serverConnection.subscribeToEvent(serverConnection.getEvents().CONNECTION_INITIALIZED, _connectionInitialized);
    serverConnection.subscribeToEvent(serverConnection.getEvents().SESSION_LOGGED_OUT, _unsubscribeAll);
    serverConnection.subscribeToEvent(serverConnection.getEvents().SESSION_INVALIDATED, _unsubscribeAll);
    serverConnection.subscribeToEvent(serverConnection.getEvents().SESSION_LOGGED_IN, _resubscribeAll);
    <span class="hljs-keyword">var</span> _connectionBrokenEvent = <span class="hljs-literal">false</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionBroken</span>(<span class="hljs-params"></span>) </span>{
      LOGGER.debug(<span class="hljs-string">"connection broken!"</span>);
      _connectionBrokenEvent = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionInitialized</span>(<span class="hljs-params"></span>) </span>{
      initialized = <span class="hljs-literal">true</span>;
      _initChannelRedirect();
      channelRedirect.initialize();
      LOGGER.debug(<span class="hljs-string">"Connection initialized. Initializing "</span> + uninitializedChannels.length + <span class="hljs-string">" channels."</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; uninitializedChannels.length; i++) {
        uninitializedChannels[i].subscribeOnInitCompletion();
      }
      uninitializedChannels = [];
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_connectionOpened</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (_connectionBrokenEvent) {
        LOGGER.debug(<span class="hljs-string">"connection opened!"</span>);
        <span class="hljs-keyword">var</span> sc = serverConnection;
        <span class="hljs-keyword">if</span> (sc.getLastError() !== sc.getErrorMessages().UNKNOWN_CLIENT)
          <span class="hljs-keyword">return</span>;
        sc.setLastError(<span class="hljs-literal">null</span>);
        LOGGER.debug(<span class="hljs-string">"channel resubscribe!"</span>);
        $.ajax({
          <span class="hljs-attr">url</span>: <span class="hljs-string">"/amb_session_setup.do"</span>,
          <span class="hljs-attr">method</span>: <span class="hljs-string">"GET"</span>,
          <span class="hljs-attr">contentType</span>: <span class="hljs-string">"application/json;charset=UTF-8"</span>,
          <span class="hljs-attr">data</span>: <span class="hljs-string">""</span>,
          <span class="hljs-attr">dataType</span>: <span class="hljs-string">"HTML"</span>,
          <span class="hljs-attr">headers</span>: {
            <span class="hljs-string">'X-UserToken'</span>: <span class="hljs-built_in">window</span>.g_ck
          }
        }).done(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          _resubscribeAll()
          _connectionBrokenEvent = <span class="hljs-literal">false</span>;
        });
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_unsubscribeAll</span>(<span class="hljs-params"></span>) </span>{
      LOGGER.debug(<span class="hljs-string">"Unsubscribing from all!"</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> channels) {
        <span class="hljs-keyword">var</span> channel = channels[name];
        channel.unsubscribeFromCometD();
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_resubscribeAll</span>(<span class="hljs-params"></span>) </span>{
      LOGGER.debug(<span class="hljs-string">"Resubscribing to all!"</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> channels) {
        <span class="hljs-keyword">var</span> channel = channels[name];
        channel.resubscribeToCometD();
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initChannelRedirect</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (channelRedirect)
        <span class="hljs-keyword">return</span>;
      channelRedirect = <span class="hljs-keyword">new</span> amb.ChannelRedirect(cometd, serverConnection, _getChannel);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getChannel</span>(<span class="hljs-params">channelName</span>) </span>{
      <span class="hljs-keyword">if</span> (channelName <span class="hljs-keyword">in</span> channels)
        <span class="hljs-keyword">return</span> channels[channelName];
      <span class="hljs-keyword">var</span> channel = <span class="hljs-keyword">new</span> amb.Channel(cometd, channelName, initialized);
      channels[channelName] = channel;
      <span class="hljs-keyword">if</span> (!initialized)
        uninitializedChannels.push(channel);
      <span class="hljs-keyword">return</span> channel;
    }
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">getServerConnection</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> serverConnection;
      },
      <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> serverConnection.isLoggedIn();
      },
      <span class="hljs-attr">loginComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        serverConnection.loginComplete();
      },
      <span class="hljs-attr">connect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (connected) {
          LOGGER.addInfoMessage(<span class="hljs-string">"&gt;&gt;&gt; connection exists, request satisfied"</span>);
          <span class="hljs-keyword">return</span>;
        }
        connected = <span class="hljs-literal">true</span>;
        serverConnection.connect();
      },
      <span class="hljs-attr">reload</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        connected = <span class="hljs-literal">false</span>;
        serverConnection.reload();
      },
      <span class="hljs-attr">abort</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        connected = <span class="hljs-literal">false</span>;
        serverConnection.abort();
      },
      <span class="hljs-attr">disconnect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        connected = <span class="hljs-literal">false</span>;
        serverConnection.disconnect();
      },
      <span class="hljs-attr">getConnectionEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> serverConnection.getEvents();
      },
      <span class="hljs-attr">subscribeToEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
        <span class="hljs-keyword">return</span> serverConnection.subscribeToEvent(event, callback);
      },
      <span class="hljs-attr">unsubscribeFromEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
        serverConnection.unsubscribeFromEvent(id);
      },
      <span class="hljs-attr">getConnectionState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> serverConnection.getConnectionState();
      },
      <span class="hljs-attr">getClientId</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> cometd.getClientId();
      },
      <span class="hljs-attr">getChannel</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channelName</span>) </span>{
        _initChannelRedirect();
        <span class="hljs-keyword">var</span> channel = _getChannel(channelName);
        <span class="hljs-keyword">return</span> channel.newListener(serverConnection, channelRedirect);
      },
      <span class="hljs-attr">registerExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName, extension</span>) </span>{
        cometd.registerExtension(extensionName, extension);
      },
      <span class="hljs-attr">unregisterExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName</span>) </span>{
        cometd.unregisterExtension(extensionName);
      },
      <span class="hljs-attr">batch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">block</span>) </span>{
        cometd.batch(block);
      }
    }
  };
})(<span class="hljs-built_in">window</span>.jQuery || <span class="hljs-built_in">window</span>.Zepto);;
<span class="hljs-comment">/*! RESOURCE: /scripts/amb.MessageClientBuilder.js */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$</span>) </span>{
  amb.getClient = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> getClient();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getClient</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> _window = <span class="hljs-built_in">window</span>.self;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (!(<span class="hljs-built_in">window</span>.MSInputMethodContext &amp;&amp; <span class="hljs-built_in">document</span>.documentMode)) {
        <span class="hljs-keyword">while</span> (_window != _window.parent) {
          <span class="hljs-keyword">if</span> (_window.g_ambClient)
            <span class="hljs-keyword">break</span>;
          _window = _window.parent;
        }
      }
      <span class="hljs-keyword">if</span> (_window.g_ambClient)
        <span class="hljs-keyword">return</span> _window.g_ambClient;
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"AMB getClient() tried to access parent from an iFrame. Caught error: "</span> + e);
    }
    <span class="hljs-keyword">var</span> client = buildClient();
    setClient(client);
    <span class="hljs-keyword">return</span> client;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setClient</span>(<span class="hljs-params">client</span>) </span>{
    <span class="hljs-keyword">var</span> _window = <span class="hljs-built_in">window</span>.self;
    _window.g_ambClient = client;
    $(_window).unload(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      _window.g_ambClient.disconnect();
    });
    _window.g_ambClient.connect();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildClient</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> ambClient = <span class="hljs-keyword">new</span> amb.MessageClient();
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">getServerConnection</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getServerConnection();
        },
        <span class="hljs-attr">connect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          ambClient.connect();
        },
        <span class="hljs-attr">abort</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          ambClient.abort();
        },
        <span class="hljs-attr">disconnect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          ambClient.disconnect();
        },
        <span class="hljs-attr">getConnectionState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getConnectionState();
        },
        <span class="hljs-attr">getState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getConnectionState();
        },
        <span class="hljs-attr">getClientId</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getClientId();
        },
        <span class="hljs-attr">getChannel</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channelName</span>) </span>{
          <span class="hljs-keyword">var</span> channel = ambClient.getChannel(channelName);
          <span class="hljs-keyword">var</span> originalSubscribe = channel.subscribe;
          <span class="hljs-keyword">var</span> originalUnsubscribe = channel.unsubscribe;
          channel.subscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">listener</span>) </span>{
            originalSubscribe.call(channel, listener);
            $(<span class="hljs-built_in">window</span>).unload(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
              originalUnsubscribe.call(channel);
            });
            <span class="hljs-keyword">return</span> channel;
          };
          <span class="hljs-keyword">return</span> channel;
        },
        <span class="hljs-attr">getChannel0</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channelName</span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getChannel(channelName);
        },
        <span class="hljs-attr">registerExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName, extension</span>) </span>{
          ambClient.registerExtension(extensionName, extension);
        },
        <span class="hljs-attr">unregisterExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName</span>) </span>{
          ambClient.unregisterExtension(extensionName);
        },
        <span class="hljs-attr">batch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">block</span>) </span>{
          ambClient.batch(block);
        },
        <span class="hljs-attr">subscribeToEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.subscribeToEvent(event, callback);
        },
        <span class="hljs-attr">unsubscribeFromEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
          ambClient.unsubscribeFromEvent(id);
        },
        <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.isLoggedIn();
        },
        <span class="hljs-attr">getConnectionEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getConnectionEvents();
        },
        <span class="hljs-attr">getEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> ambClient.getConnectionEvents();
        },
        <span class="hljs-attr">loginComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          ambClient.loginComplete();
        }
      };
    })();
  }
})(<span class="hljs-built_in">window</span>.jQuery || <span class="hljs-built_in">window</span>.Zepto);;;
<span class="hljs-comment">/*! RESOURCE: /scripts/app.ng.amb/app.ng.amb.js */</span>
angular.module(<span class="hljs-string">"ng.amb"</span>, [<span class="hljs-string">'sn.common.presence'</span>, <span class="hljs-string">'sn.common.util'</span>])
  .value(<span class="hljs-string">"ambLogLevel"</span>, <span class="hljs-string">'info'</span>)
  .value(<span class="hljs-string">"ambServletURI"</span>, <span class="hljs-string">'/amb'</span>)
  .value(<span class="hljs-string">"cometd"</span>, angular.element.cometd)
  .value(<span class="hljs-string">"ambLoginWindow"</span>, <span class="hljs-string">'true'</span>);;
<span class="hljs-comment">/*! RESOURCE: /scripts/app.ng.amb/service.AMB.js */</span>
angular.module(<span class="hljs-string">"ng.amb"</span>).service(<span class="hljs-string">"amb"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">AMBOverlay, $window, $q, $log, $rootScope, $timeout</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> ambClient = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> _window = $<span class="hljs-built_in">window</span>.self;
  <span class="hljs-keyword">var</span> loginWindow = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> sameScope = <span class="hljs-literal">false</span>;
  ambClient = amb.getClient();
  <span class="hljs-keyword">if</span> (_window.g_ambClient) {
    sameScope = <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">if</span> (sameScope) {
    <span class="hljs-keyword">var</span> serverConnection = ambClient.getServerConnection();
    serverConnection.loginShow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!serverConnection.isLoginWindowEnabled())
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (loginWindow &amp;&amp; loginWindow.isVisible())
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (serverConnection.isLoginWindowOverride())
        <span class="hljs-keyword">return</span>;
      loginWindow = <span class="hljs-keyword">new</span> AMBOverlay();
      loginWindow.render();
      loginWindow.show();
    };
    serverConnection.loginHide = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!loginWindow)
        <span class="hljs-keyword">return</span>;
      loginWindow.hide();
      loginWindow.destroy();
      loginWindow = <span class="hljs-literal">null</span>;
    }
  }
  <span class="hljs-keyword">var</span> connected = $q.defer();
  <span class="hljs-keyword">var</span> connectionInterrupted = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> monitorAMB = <span class="hljs-literal">false</span>;
  $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    monitorAMB = <span class="hljs-literal">true</span>;
  }, <span class="hljs-number">5</span> * <span class="hljs-number">1000</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ambInterrupted</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> state = ambClient.getState();
    <span class="hljs-keyword">return</span> monitorAMB &amp;&amp; state !== <span class="hljs-string">"opened"</span> &amp;&amp; state !== <span class="hljs-string">"initialized"</span>
  }
  <span class="hljs-keyword">var</span> interruptionTimeout;
  <span class="hljs-keyword">var</span> extendedInterruption = <span class="hljs-literal">false</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setInterrupted</span>(<span class="hljs-params">eventName</span>) </span>{
    connectionInterrupted = <span class="hljs-literal">true</span>;
    $rootScope.$broadcast(eventName);
    <span class="hljs-keyword">if</span> (!interruptionTimeout) {
      interruptionTimeout = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        extendedInterruption = <span class="hljs-literal">true</span>;
      }, <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>)
    }
    connected = $q.defer();
  }
  <span class="hljs-keyword">var</span> connectOpenedEventId = ambClient.subscribeToEvent(<span class="hljs-string">"connection.opened"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    $rootScope.$broadcast(<span class="hljs-string">"amb.connection.opened"</span>);
    <span class="hljs-keyword">if</span> (interruptionTimeout) {
      $timeout.cancel(interruptionTimeout);
      interruptionTimeout = <span class="hljs-literal">null</span>;
    }
    extendedInterruption = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (connectionInterrupted) {
      connectionInterrupted = <span class="hljs-literal">false</span>;
      $rootScope.$broadcast(<span class="hljs-string">"amb.connection.recovered"</span>);
    }
    connected.resolve();
  });
  <span class="hljs-keyword">var</span> connectClosedEventId = ambClient.subscribeToEvent(<span class="hljs-string">"connection.closed"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    setInterrupted(<span class="hljs-string">"amb.connection.closed"</span>);
  });
  <span class="hljs-keyword">var</span> connectBrokenEventId = ambClient.subscribeToEvent(<span class="hljs-string">"connection.broken"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    setInterrupted(<span class="hljs-string">"amb.connection.broken"</span>);
  });
  jQuery(<span class="hljs-built_in">window</span>).unload(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fixMemoryLeakInGlobalAMBEventManager</span>(<span class="hljs-params">event</span>) </span>{
    ambClient.unsubscribeFromEvent(connectOpenedEventId);
    ambClient.unsubscribeFromEvent(connectClosedEventId);
    ambClient.unsubscribeFromEvent(connectBrokenEventId);
    jQuery(<span class="hljs-keyword">this</span>).unbind(event);
  });
  ambClient.connect();
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">getServerConnection</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getServerConnection();
    },
    <span class="hljs-attr">connect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      ambClient.connect();
      <span class="hljs-keyword">return</span> connected.promise;
    },
    get interrupted() {
      <span class="hljs-keyword">return</span> ambInterrupted();
    },
    get extendedInterruption() {
      <span class="hljs-keyword">return</span> extendedInterruption;
    },
    get connected() {
      <span class="hljs-keyword">return</span> connected.promise;
    },
    <span class="hljs-attr">abort</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      ambClient.abort();
    },
    <span class="hljs-attr">disconnect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      ambClient.disconnect();
    },
    <span class="hljs-attr">getConnectionState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getConnectionState();
    },
    <span class="hljs-attr">getClientId</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getClientId();
    },
    <span class="hljs-attr">getChannel</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">channelName</span>) </span>{
      <span class="hljs-keyword">var</span> channel = ambClient.getChannel0(channelName);
      <span class="hljs-keyword">var</span> originalSubscribe = channel.subscribe;
      <span class="hljs-keyword">var</span> originalUnsubscribe = channel.unsubscribe;
      channel.subscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">listener</span>) </span>{
        originalSubscribe.call(channel, listener);
        jQuery(<span class="hljs-built_in">window</span>).unload(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          originalUnsubscribe.call(channel);
        });
        <span class="hljs-keyword">return</span> channel;
      };
      <span class="hljs-keyword">return</span> channel;
    },
    <span class="hljs-attr">registerExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName, extension</span>) </span>{
      ambClient.registerExtension(extensionName, extension);
    },
    <span class="hljs-attr">unregisterExtension</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extensionName</span>) </span>{
      ambClient.unregisterExtension(extensionName);
    },
    <span class="hljs-attr">batch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">batch</span>) </span>{
      ambClient.batch(batch);
    },
    <span class="hljs-attr">getState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getState();
    },
    <span class="hljs-attr">getFilterString</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filter</span>) </span>{
      filter = filter.
      replace(<span class="hljs-regexp">/\^EQ/g</span>, <span class="hljs-string">''</span>).
      replace(<span class="hljs-regexp">/\^ORDERBY(?:DESC)?[^^]*/g</span>, <span class="hljs-string">''</span>).
      replace(<span class="hljs-regexp">/^GOTO/</span>, <span class="hljs-string">''</span>);
      <span class="hljs-keyword">return</span> btoa(filter).replace(<span class="hljs-regexp">/=/g</span>, <span class="hljs-string">'-'</span>);
    },
    <span class="hljs-attr">getChannelRW</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">table, filter</span>) </span>{
      <span class="hljs-keyword">var</span> t = <span class="hljs-string">'/rw/default/'</span> + table + <span class="hljs-string">'/'</span> + <span class="hljs-keyword">this</span>.getFilterString(filter);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getChannel(t);
    },
    <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.isLoggedIn();
    },
    <span class="hljs-attr">subscribeToEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) </span>{
      ambClient.subscribeToEvent(event, callback);
    },
    <span class="hljs-attr">getConnectionEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getConnectionEvents();
    },
    <span class="hljs-attr">getEvents</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ambClient.getConnectionEvents();
    },
    <span class="hljs-attr">loginComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      ambClient.loginComplete();
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/app.ng.amb/controller.AMBRecordWatcher.js */</span>
angular.module(<span class="hljs-string">"ng.amb"</span>).controller(<span class="hljs-string">"AMBRecordWatcher"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $timeout, $window</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> amb = $<span class="hljs-built_in">window</span>.top.g_ambClient;
  $scope.messages = [];
  <span class="hljs-keyword">var</span> lastFilter;
  <span class="hljs-keyword">var</span> watcherChannel;
  <span class="hljs-keyword">var</span> watcher;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onMessage</span>(<span class="hljs-params">message</span>) </span>{
    $scope.messages.push(message.data);
  }
  $scope.getState = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> amb.getState();
  };
  $scope.initWatcher = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    angular.element(<span class="hljs-string">":focus"</span>).blur();
    <span class="hljs-keyword">if</span> (!$scope.filter || $scope.filter === lastFilter)
      <span class="hljs-keyword">return</span>;
    lastFilter = $scope.filter;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"initiating watcher on "</span> + $scope.filter);
    $scope.messages = [];
    <span class="hljs-keyword">if</span> (watcher) {
      watcher.unsubscribe();
    }
    <span class="hljs-keyword">var</span> base64EncodeQuery = btoa($scope.filter).replace(<span class="hljs-regexp">/=/g</span>, <span class="hljs-string">'-'</span>);
    <span class="hljs-keyword">var</span> channelId = <span class="hljs-string">'/rw/'</span> + base64EncodeQuery;
    watcherChannel = amb.getChannel(channelId)
    watcher = watcherChannel.subscribe(onMessage);
  };
  amb.connect();
});
<span class="hljs-comment">/*! RESOURCE: /scripts/app.ng.amb/factory.snRecordWatcher.js */</span>
angular.module(<span class="hljs-string">"ng.amb"</span>).factory(<span class="hljs-string">'snRecordWatcher'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$rootScope, amb, $timeout, snPresence, $log, urlTools</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> watcherChannel;
  <span class="hljs-keyword">var</span> connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> diagnosticLog = <span class="hljs-literal">true</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initWatcher</span>(<span class="hljs-params">table, sys_id, query</span>) </span>{
    <span class="hljs-keyword">if</span> (!table)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (sys_id)
      <span class="hljs-keyword">var</span> filter = <span class="hljs-string">"sys_id="</span> + sys_id;
    <span class="hljs-keyword">else</span>
      filter = query;
    <span class="hljs-keyword">if</span> (!filter)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">return</span> initChannel(table, filter);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initList</span>(<span class="hljs-params">table, query</span>) </span>{
    <span class="hljs-keyword">if</span> (!table)
      <span class="hljs-keyword">return</span>;
    query = query || <span class="hljs-string">"sys_idISNOTEMPTY"</span>;
    <span class="hljs-keyword">return</span> initChannel(table, query);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initTaskList</span>(<span class="hljs-params">list, prevChannel</span>) </span>{
    <span class="hljs-keyword">if</span> (prevChannel)
      prevChannel.unsubscribe();
    <span class="hljs-keyword">var</span> sys_ids = list.toString();
    <span class="hljs-keyword">var</span> filter = <span class="hljs-string">"sys_idIN"</span> + sys_ids;
    <span class="hljs-keyword">return</span> initChannel(<span class="hljs-string">"task"</span>, filter);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initChannel</span>(<span class="hljs-params">table, filter</span>) </span>{
    <span class="hljs-keyword">if</span> (isBlockedTable(table)) {
      $log.log(<span class="hljs-string">"Blocked from watching"</span>, table);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">if</span> (diagnosticLog)
      log(<span class="hljs-string">"&gt;&gt;&gt; init "</span> + table + <span class="hljs-string">"?"</span> + filter);
    watcherChannel = amb.getChannelRW(table, filter);
    watcherChannel.subscribe(onMessage);
    amb.connect();
    <span class="hljs-keyword">return</span> watcherChannel;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onMessage</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">var</span> r = message.data;
    <span class="hljs-keyword">var</span> c = message.channel;
    <span class="hljs-keyword">if</span> (diagnosticLog)
      log(<span class="hljs-string">"&gt;&gt;&gt; record "</span> + r.operation + <span class="hljs-string">": "</span> + r.table_name + <span class="hljs-string">"."</span> + r.sys_id + <span class="hljs-string">" "</span> + r.display_value);
    $rootScope.$broadcast(<span class="hljs-string">'record.updated'</span>, r);
    $rootScope.$broadcast(<span class="hljs-string">"sn.stream.tap"</span>);
    $rootScope.$broadcast(<span class="hljs-string">'list.updated'</span>, r, c);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params">message</span>) </span>{
    $log.log(message);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isBlockedTable</span>(<span class="hljs-params">table</span>) </span>{
    <span class="hljs-keyword">return</span> table == <span class="hljs-string">'sys_amb_message'</span> || table.startsWith(<span class="hljs-string">'sys_rw'</span>);
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">initTaskList</span>: initTaskList,
    <span class="hljs-attr">initChannel</span>: initChannel,
    <span class="hljs-attr">init</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> location = urlTools.parseQueryString(<span class="hljs-built_in">window</span>.location.search);
      <span class="hljs-keyword">var</span> table = location[<span class="hljs-string">'table'</span>] || location[<span class="hljs-string">'sysparm_table'</span>];
      <span class="hljs-keyword">var</span> sys_id = location[<span class="hljs-string">'sys_id'</span>] || location[<span class="hljs-string">'sysparm_sys_id'</span>];
      <span class="hljs-keyword">var</span> query = location[<span class="hljs-string">'sysparm_query'</span>];
      initWatcher(table, sys_id, query);
      snPresence.init(table, sys_id, query);
    },
    <span class="hljs-attr">initList</span>: initList,
    <span class="hljs-attr">initRecord</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">table, sysId</span>) </span>{
      initWatcher(table, sysId, <span class="hljs-literal">null</span>);
      snPresence.initWithDocument(table, sysId);
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/app.ng.amb/factory.AMBOverlay.js */</span>
angular.module(<span class="hljs-string">"ng.amb"</span>).factory(<span class="hljs-string">"AMBOverlay"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$templateCache, $compile, $rootScope</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> showCallbacks = [],
    hideCallbacks = [],
    isRendered = <span class="hljs-literal">false</span>,
    modal,
    modalScope,
    modalOptions;
  <span class="hljs-keyword">var</span> defaults = {
    <span class="hljs-attr">backdrop</span>: <span class="hljs-string">'static'</span>,
    <span class="hljs-attr">keyboard</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AMBOverlay</span>(<span class="hljs-params">config</span>) </span>{
    config = config || {};
    <span class="hljs-keyword">if</span> (angular.isFunction(config.onShow))
      showCallbacks.push(config.onShow);
    <span class="hljs-keyword">if</span> (angular.isFunction(config.onHide))
      hideCallbacks.push(config.onHide);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lazyRender</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!angular.element(<span class="hljs-string">'html'</span>)[<span class="hljs-string">'modal'</span>]) {
        <span class="hljs-keyword">var</span> bootstrapInclude = <span class="hljs-string">"/scripts/bootstrap3/bootstrap.js"</span>;
        ScriptLoader.getScripts([bootstrapInclude], renderModal);
      } <span class="hljs-keyword">else</span>
        renderModal();
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderModal</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (isRendered)
        <span class="hljs-keyword">return</span>;
      modalScope = angular.extend($rootScope.$<span class="hljs-keyword">new</span>(), config);
      modal = $compile($templateCache.get(<span class="hljs-string">"amb_disconnect_modal.xml"</span>))(modalScope);
      angular.element(<span class="hljs-string">"body"</span>).append(modal);
      modal.on(<span class="hljs-string">"shown.bs.modal"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = showCallbacks.length; i &lt; len; i++)
          showCallbacks[i](e);
      });
      modal.on(<span class="hljs-string">"hidden.bs.modal"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = hideCallbacks.length; i &lt; len; i++)
          hideCallbacks[i](e);
      });
      modalOptions = angular.extend({}, defaults, config);
      modal.modal(modalOptions);
      isRendered = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showModal</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (isRendered)
        modal.modal(<span class="hljs-string">'show'</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hideModal</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (isRendered)
        modal.modal(<span class="hljs-string">'hide'</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroyModal</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!isRendered)
        <span class="hljs-keyword">return</span>;
      modal.modal(<span class="hljs-string">'hide'</span>);
      modal.remove();
      modalScope.$destroy();
      modalScope = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
      isRendered = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">var</span> pos = showCallbacks.indexOf(config.onShow);
      <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span>)
        showCallbacks.splice(pos, <span class="hljs-number">1</span>);
      pos = hideCallbacks.indexOf(config.onShow);
      <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span>)
        hideCallbacks.splice(pos, <span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">render</span>: lazyRender,
      <span class="hljs-attr">destroy</span>: destroyModal,
      <span class="hljs-attr">show</span>: showModal,
      <span class="hljs-attr">hide</span>: hideModal,
      <span class="hljs-attr">isVisible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!isRendered)
          <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> modal.visible();
      }
    }
  }
  $templateCache.put(<span class="hljs-string">'amb_disconnect_modal.xml'</span>,
    <span class="hljs-string">'&lt;div id="amb_disconnect_modal" tabindex="-1" aria-hidden="true" class="modal" role="dialog"&gt;'</span> +
    <span class="hljs-string">'	&lt;div class="modal-dialog small-modal" style="width:450px"&gt;'</span> +
    <span class="hljs-string">'		&lt;div class="modal-content"&gt;'</span> +
    <span class="hljs-string">'			&lt;header class="modal-header"&gt;'</span> +
    <span class="hljs-string">'				&lt;h4 id="small_modal1_title" class="modal-title"&gt;{{title || "Login"}}&lt;/h4&gt;'</span> +
    <span class="hljs-string">'			&lt;/header&gt;'</span> +
    <span class="hljs-string">'			&lt;div class="modal-body"&gt;'</span> +
    <span class="hljs-string">'			&lt;iframe class="concourse_modal" ng-src=\'{{iframe || "/amb_login.do"}}\' frameborder="0" scrolling="no" height="400px" width="405px"&gt;&lt;/iframe&gt;'</span> +
    <span class="hljs-string">'			&lt;/div&gt;'</span> +
    <span class="hljs-string">'		&lt;/div&gt;'</span> +
    <span class="hljs-string">'	&lt;/div&gt;'</span> +
    <span class="hljs-string">'&lt;/div&gt;'</span>
  );
  <span class="hljs-keyword">return</span> AMBOverlay;
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.presence'</span>, [<span class="hljs-string">'ng.amb'</span>, <span class="hljs-string">'sn.common.glide'</span>]).config(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$provide</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  $provide.constant(<span class="hljs-string">"PRESENCE_DISABLED"</span>, <span class="hljs-string">"false"</span> === <span class="hljs-string">"true"</span>);
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/factory.snPresence.js */</span>
angular.module(<span class="hljs-string">"sn.common.presence"</span>).factory(<span class="hljs-string">'snPresence'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$rootScope, $window, $log, amb, $timeout, $http, snRecordPresence, snTabActivity, urlTools, PRESENCE_DISABLED</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> REST = {
    <span class="hljs-attr">PRESENCE</span>: <span class="hljs-string">"/api/now/ui/presence"</span>
  };
  <span class="hljs-keyword">var</span> databaseInterval = ($<span class="hljs-built_in">window</span>.NOW.presence_interval || <span class="hljs-number">15</span>) * <span class="hljs-number">1000</span>;
  <span class="hljs-keyword">var</span> initialized = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> primary = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> presenceArray = [];
  <span class="hljs-keyword">var</span> serverTimeMillis;
  <span class="hljs-keyword">var</span> skew = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> st = <span class="hljs-number">0</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> location = urlTools.parseQueryString(<span class="hljs-built_in">window</span>.location.search);
    <span class="hljs-keyword">var</span> table = location[<span class="hljs-string">'table'</span>] || location[<span class="hljs-string">'sysparm_table'</span>];
    <span class="hljs-keyword">var</span> sys_id = location[<span class="hljs-string">'sys_id'</span>] || location[<span class="hljs-string">'sysparm_sys_id'</span>];
    <span class="hljs-keyword">var</span> query = location[<span class="hljs-string">'sysparm_query'</span>];
    initPresence(table, sys_id, query);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initPresence</span>(<span class="hljs-params">t, id</span>) </span>{
    <span class="hljs-keyword">if</span> (PRESENCE_DISABLED)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (!initialized) {
      initialized = <span class="hljs-literal">true</span>;
      initRootScopes();
      <span class="hljs-keyword">if</span> (!primary) {
        CustomEvent.observe(<span class="hljs-string">'sn.presence'</span>, onPresenceEvent);
        CustomEvent.fireTop(<span class="hljs-string">'sn.presence.ping'</span>);
      } <span class="hljs-keyword">else</span> {
        presenceArray = getLocalPresence();
        <span class="hljs-keyword">if</span> (presenceArray)
          $timeout(schedulePresence, <span class="hljs-number">100</span>);
        <span class="hljs-keyword">else</span>
          updateDatabase();
      }
    }
    snRecordPresence.initPresence(t, id);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onPresenceEvent</span>(<span class="hljs-params">parms</span>) </span>{
    presenceArray = parms;
    $timeout(broadcastPresence);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initRootScopes</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> ($<span class="hljs-built_in">window</span>.NOW.presence_scopes) {
      <span class="hljs-keyword">var</span> ps = $<span class="hljs-built_in">window</span>.NOW.presence_scopes;
      <span class="hljs-keyword">if</span> (ps.indexOf($rootScope) == <span class="hljs-number">-1</span>)
        ps.push($rootScope);
    } <span class="hljs-keyword">else</span> {
      $<span class="hljs-built_in">window</span>.NOW.presence_scopes = [$rootScope];
      primary = CustomEvent.isTopWindow();
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateDatabase</span>(<span class="hljs-params"></span>) </span>{
    presenceArray = getLocalPresence();
    <span class="hljs-keyword">if</span> (presenceArray) {
      determineStatus();
      $timeout(schedulePresence);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!amb.isLoggedIn() || !snTabActivity.isPrimary) {
      $timeout(schedulePresence);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> p = {
      <span class="hljs-attr">user_agent</span>: navigator.userAgent,
      <span class="hljs-attr">ua_time</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      <span class="hljs-attr">href</span>: <span class="hljs-built_in">window</span>.location.href,
      <span class="hljs-attr">pathname</span>: <span class="hljs-built_in">window</span>.location.pathname,
      <span class="hljs-attr">search</span>: <span class="hljs-built_in">window</span>.location.search,
      <span class="hljs-attr">path</span>: <span class="hljs-built_in">window</span>.location.pathname + <span class="hljs-built_in">window</span>.location.search
    };
    st = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    $http.post(REST.PRESENCE + <span class="hljs-string">'?sysparm_auto_request=true&amp;cd='</span> + st, p).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
      <span class="hljs-keyword">var</span> rt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - st;
      <span class="hljs-keyword">if</span> (rt &gt; <span class="hljs-number">500</span>)
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"snPresence response time "</span> + rt + <span class="hljs-string">"ms"</span>);
      <span class="hljs-keyword">if</span> (data.result &amp;&amp; data.result.presenceArray) {
        presenceArray = data.result.presenceArray;
        setLocalPresence(presenceArray);
        serverTimeMillis = data.result.serverTimeMillis;
        skew = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - serverTimeMillis;
        <span class="hljs-keyword">var</span> t = <span class="hljs-built_in">Math</span>.floor(skew / <span class="hljs-number">1000</span>);
        <span class="hljs-keyword">if</span> (t &lt; <span class="hljs-number">-15</span>)
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"&gt;&gt;&gt;&gt;&gt; server ahead "</span> + <span class="hljs-built_in">Math</span>.abs(t) + <span class="hljs-string">" seconds"</span>);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (t &gt; <span class="hljs-number">15</span>)
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"&gt;&gt;&gt;&gt;&gt; browser time ahead "</span> + t + <span class="hljs-string">" seconds"</span>);
      }
      schedulePresence();
    }).error(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response, status</span>) </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"snPresence "</span> + status);
      <span class="hljs-keyword">if</span> (<span class="hljs-number">429</span> == status)
        $timeout(updateDatabase, databaseInterval);
      <span class="hljs-keyword">else</span>
        schedulePresence();
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schedulePresence</span>(<span class="hljs-params"></span>) </span>{
    $timeout(updateDatabase, databaseInterval);
    determineStatus();
    broadcastPresence();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">broadcastPresence</span>(<span class="hljs-params"></span>) </span>{
    $rootScope.$broadcast(<span class="hljs-string">"sn.presence"</span>, presenceArray);
    <span class="hljs-keyword">if</span> (!primary)
      <span class="hljs-keyword">return</span>;
    CustomEvent.fireAll(<span class="hljs-string">'sn.presence'</span>, presenceArray);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">determineStatus</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!presenceArray || !presenceArray.forEach)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    t -= skew;
    presenceArray.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>) </span>{
      <span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span> + p.last_on;
      <span class="hljs-keyword">var</span> y = t - x;
      p.status = <span class="hljs-string">"online"</span>;
      <span class="hljs-keyword">if</span> (y &gt; (<span class="hljs-number">5</span> * databaseInterval))
        p.status = <span class="hljs-string">"offline"</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (y &gt; (<span class="hljs-number">3</span> * databaseInterval))
        p.status = <span class="hljs-string">"probably offline"</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (y &gt; (<span class="hljs-number">2.5</span> * databaseInterval))
        p.status = <span class="hljs-string">"maybe offline"</span>;
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setLocalPresence</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">var</span> p = {
      <span class="hljs-attr">saved</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),
      <span class="hljs-attr">presenceArray</span>: value
    }
    $<span class="hljs-built_in">window</span>.localStorage.setItem(<span class="hljs-string">'snPresence'</span>, angular.toJson(p));
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLocalPresence</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> p = $<span class="hljs-built_in">window</span>.localStorage.getItem(<span class="hljs-string">'snPresence'</span>);
    <span class="hljs-keyword">if</span> (!p)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
      p = angular.fromJson(p);
    } <span class="hljs-keyword">catch</span> (e) {
      p = {};
    }
    <span class="hljs-keyword">if</span> (!p.presenceArray)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    <span class="hljs-keyword">if</span> (now - p.saved &gt;= databaseInterval)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">return</span> p.presenceArray;
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">init</span>: init,
    <span class="hljs-attr">initWithDocument</span>: initPresence,
    <span class="hljs-attr">initPresence</span>: initPresence
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/factory.snRecordPresence.js */</span>
angular.module(<span class="hljs-string">"sn.common.presence"</span>).factory(<span class="hljs-string">'snRecordPresence'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$rootScope, $location, amb, $timeout, $window, PRESENCE_DISABLED, snTabActivity</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> statChannel;
  <span class="hljs-keyword">var</span> interval = ($<span class="hljs-built_in">window</span>.NOW.record_presence_interval || <span class="hljs-number">20</span>) * <span class="hljs-number">1000</span>;
  <span class="hljs-keyword">var</span> sessions = {};
  <span class="hljs-keyword">var</span> primary = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> table;
  <span class="hljs-keyword">var</span> sys_id;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initPresence</span>(<span class="hljs-params">t, id</span>) </span>{
    <span class="hljs-keyword">if</span> (PRESENCE_DISABLED)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (!t || !id)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (t == table &amp;&amp; id == sys_id)
      <span class="hljs-keyword">return</span>;
    initRootScopes();
    <span class="hljs-keyword">if</span> (!primary)
      <span class="hljs-keyword">return</span>;
    termPresence();
    table = t;
    sys_id = id;
    <span class="hljs-keyword">var</span> recordPresence = <span class="hljs-string">"/sn/rp/"</span> + table + <span class="hljs-string">"/"</span> + sys_id;
    $rootScope.me = NOW.session_id;
    statChannel = amb.getChannel(recordPresence);
    statChannel.subscribe(onStatus);
    amb.connected.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      setStatus(<span class="hljs-string">"entered"</span>);
      $rootScope.status = <span class="hljs-string">"viewing"</span>;
    });
    <span class="hljs-keyword">return</span> statChannel;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initRootScopes</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> ($<span class="hljs-built_in">window</span>.NOW.record_presence_scopes) {
      <span class="hljs-keyword">var</span> ps = $<span class="hljs-built_in">window</span>.NOW.record_presence_scopes;
      <span class="hljs-keyword">if</span> (ps.indexOf($rootScope) == <span class="hljs-number">-1</span>) {
        ps.push($rootScope);
        CustomEvent.observe(<span class="hljs-string">'sn.sessions'</span>, onPresenceEvent);
      }
    } <span class="hljs-keyword">else</span> {
      $<span class="hljs-built_in">window</span>.NOW.record_presence_scopes = [$rootScope];
      primary = <span class="hljs-literal">true</span>;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onPresenceEvent</span>(<span class="hljs-params">sessionsToSend</span>) </span>{
    $rootScope.$broadcast(<span class="hljs-string">"sn.sessions"</span>, sessionsToSend);
    $rootScope.$broadcast(<span class="hljs-string">"sp.sessions"</span>, sessionsToSend);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">termPresence</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!statChannel)
      <span class="hljs-keyword">return</span>;
    statChannel.unsubscribe();
    statChannel = table = sys_id = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setStatus</span>(<span class="hljs-params">status</span>) </span>{
    <span class="hljs-keyword">if</span> (status == $rootScope.status)
      <span class="hljs-keyword">return</span>;
    $rootScope.status = status;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(sessions).length == <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (getStatusPrecedence(status) &gt; <span class="hljs-number">1</span>)
      <span class="hljs-keyword">return</span>;
    publish($rootScope.status);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">publish</span>(<span class="hljs-params">status</span>) </span>{
    <span class="hljs-keyword">if</span> (!statChannel)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (amb.getState() !== <span class="hljs-string">"opened"</span>)
      <span class="hljs-keyword">return</span>;
    statChannel.publish({
      <span class="hljs-attr">presences</span>: [{
        <span class="hljs-attr">status</span>: status,
        <span class="hljs-attr">session_id</span>: NOW.session_id,
        <span class="hljs-attr">user_name</span>: NOW.user_name,
        <span class="hljs-attr">user_id</span>: NOW.user_id,
        <span class="hljs-attr">user_display_name</span>: NOW.user_display_name,
        <span class="hljs-attr">user_initials</span>: NOW.user_initials,
        <span class="hljs-attr">user_avatar</span>: NOW.user_avatar,
        <span class="hljs-attr">ua</span>: navigator.userAgent,
        <span class="hljs-attr">table</span>: table,
        <span class="hljs-attr">sys_id</span>: sys_id,
        <span class="hljs-attr">time</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toString().substring(<span class="hljs-number">0</span>, <span class="hljs-number">24</span>)
      }]
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onStatus</span>(<span class="hljs-params">message</span>) </span>{
    message.data.presences.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d</span>) </span>{
      <span class="hljs-keyword">if</span> (!d.session_id || d.session_id == NOW.session_id)
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">var</span> s = sessions[d.session_id];
      <span class="hljs-keyword">if</span> (s)
        angular.extend(s, d);
      <span class="hljs-keyword">else</span>
        s = sessions[d.session_id] = d;
      s.lastUpdated = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      <span class="hljs-keyword">if</span> (s.status == <span class="hljs-string">'exited'</span>)
        <span class="hljs-keyword">delete</span> sessions[d.session_id];
    });
    broadcastSessions();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">broadcastSessions</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> sessionsToSend = getUniqueSessions();
    $rootScope.$broadcast(<span class="hljs-string">"sn.sessions"</span>, sessionsToSend);
    $rootScope.$broadcast(<span class="hljs-string">"sp.sessions"</span>, sessionsToSend);
    <span class="hljs-keyword">if</span> (primary)
      $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        CustomEvent.fire(<span class="hljs-string">'sn.sessions'</span>, sessionsToSend);
      })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUniqueSessions</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> uniqueSessionsByUser = {};
    <span class="hljs-keyword">var</span> sessionKeys = <span class="hljs-built_in">Object</span>.keys(sessions);
    sessionKeys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>) </span>{
      <span class="hljs-keyword">var</span> session = sessions[key];
      <span class="hljs-keyword">if</span> (session.user_id == NOW.user_id)
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (session.user_id <span class="hljs-keyword">in</span> uniqueSessionsByUser) {
        <span class="hljs-keyword">var</span> otherSession = uniqueSessionsByUser[session.user_id];
        <span class="hljs-keyword">var</span> thisPrecedence = getStatusPrecedence(session.status);
        <span class="hljs-keyword">var</span> otherPrecedence = getStatusPrecedence(otherSession.status);
        uniqueSessionsByUser[session.user_id] = thisPrecedence &lt; otherPrecedence ? session : otherSession;
        <span class="hljs-keyword">return</span>
      }
      uniqueSessionsByUser[session.user_id] = session;
    });
    <span class="hljs-keyword">var</span> uniqueSessions = {};
    angular.forEach(uniqueSessionsByUser, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
      uniqueSessions[item.session_id] = item;
    });
    <span class="hljs-keyword">return</span> uniqueSessions;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStatusPrecedence</span>(<span class="hljs-params">status</span>) </span>{
    <span class="hljs-keyword">switch</span> (status) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'typing'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'viewing'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'entered'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'exited'</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">'probably left'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'offline'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;
    }
  }
  $rootScope.$on(<span class="hljs-string">"record.typing"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt, data</span>) </span>{
    setStatus(data.status);
  });
  <span class="hljs-keyword">var</span> idleTable, idleSysID;
  snTabActivity.onIdle({
    <span class="hljs-attr">onIdle</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RecordPresenceTabIdle</span>(<span class="hljs-params"></span>) </span>{
      idleTable = table;
      idleSysID = sys_id;
      sessions = {};
      termPresence();
      broadcastSessions();
    },
    <span class="hljs-attr">onReturn</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RecordPresenceTabActive</span>(<span class="hljs-params"></span>) </span>{
      initPresence(idleTable, idleSysID, <span class="hljs-literal">true</span>);
      idleTable = idleSysID = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
    },
    <span class="hljs-attr">delay</span>: interval * <span class="hljs-number">4</span>
  });
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">initPresence</span>: initPresence,
    <span class="hljs-attr">termPresence</span>: termPresence
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/directive.snPresence.js */</span>
angular.module(<span class="hljs-string">'sn.common.presence'</span>).directive(<span class="hljs-string">'snPresence'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">snPresence, $rootScope, $timeout</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  $timeout(snPresence.init, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">var</span> presences = {};
  $rootScope.$on(<span class="hljs-string">'sn.presence'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, presenceArray</span>) </span>{
    <span class="hljs-keyword">if</span> (!presenceArray) {
      angular.forEach(presences, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>) </span>{
        p.status = <span class="hljs-string">"offline"</span>;
      });
      <span class="hljs-keyword">return</span>;
    }
    presenceArray.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">presence</span>) </span>{
      presences[presence.user] = presence;
    });
  });
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'EA'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">snPresence</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">user</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">profile</span>: <span class="hljs-string">'=?'</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
      <span class="hljs-keyword">if</span> (scope.profile)
        scope.user = scope.profile.userID;
      <span class="hljs-keyword">if</span> (!element.hasClass(<span class="hljs-string">'presence'</span>))
        element.addClass(<span class="hljs-string">'presence'</span>);

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updatePresence</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> id = scope.snPresence || scope.user;
        <span class="hljs-keyword">if</span> (presences[id]) {
          <span class="hljs-keyword">var</span> status = presences[id].status;
          <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'maybe offline'</span> || status === <span class="hljs-string">'probably offline'</span>) {
            element.removeClass(<span class="hljs-string">'presence-online presence-offline presence-away'</span>);
            element.addClass(<span class="hljs-string">'presence-away'</span>);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">"offline"</span> &amp;&amp; !element.hasClass(<span class="hljs-string">'presence-offline'</span>)) {
            element.removeClass(<span class="hljs-string">'presence-online presence-away'</span>);
            element.addClass(<span class="hljs-string">'presence-offline'</span>);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((status == <span class="hljs-string">"online"</span> || status == <span class="hljs-string">"entered"</span> || status == <span class="hljs-string">"viewing"</span>) &amp;&amp; !element.hasClass(<span class="hljs-string">'presence-online'</span>)) {
            element.removeClass(<span class="hljs-string">'presence-offline presence-away'</span>);
            element.addClass(<span class="hljs-string">'presence-online'</span>);
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (!element.hasClass(<span class="hljs-string">'presence-offline'</span>))
            element.addClass(<span class="hljs-string">'presence-offline'</span>);
        }
      }
      $rootScope.$on(<span class="hljs-string">'sn.presence'</span>, updatePresence);
      updatePresence();
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/directive.snComposing.js */</span>
angular.module(<span class="hljs-string">'sn.common.presence'</span>).directive(<span class="hljs-string">'snComposing'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, snComposingPresence</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">"snComposing.xml"</span>),
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">conversation</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $element</span>) </span>{
      <span class="hljs-keyword">var</span> child = $element.children();
      <span class="hljs-keyword">if</span> (child &amp;&amp; child.tooltip)
        child.tooltip({
          <span class="hljs-string">'template'</span>: <span class="hljs-string">'&lt;div class="tooltip" style="white-space: pre-wrap" role="tooltip"&gt;&lt;div class="tooltip-arrow"&gt;&lt;/div&gt;&lt;div class="tooltip-inner"&gt;&lt;/div&gt;&lt;/div&gt;'</span>,
          <span class="hljs-string">'placement'</span>: <span class="hljs-string">'top'</span>,
          <span class="hljs-string">'container'</span>: <span class="hljs-string">'body'</span>
        });
      $scope.snComposingPresence = snComposingPresence;
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/presence/service.snComposingPresence.js */</span>
angular.module(<span class="hljs-string">'sn.common.presence'</span>).service(<span class="hljs-string">'snComposingPresence'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i18n</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> viewing = {};
  <span class="hljs-keyword">var</span> typing = {};
  <span class="hljs-keyword">var</span> allStrings = {};
  <span class="hljs-keyword">var</span> shortStrings = {};
  <span class="hljs-keyword">var</span> typing1 = <span class="hljs-string">"{0} is typing"</span>,
    typing2 = <span class="hljs-string">"{0} and {1} are typing"</span>,
    typingMore = <span class="hljs-string">"{0}, {1}, and {2} more are typing"</span>,
    viewing1 = <span class="hljs-string">"{0} is viewing"</span>,
    viewing2 = <span class="hljs-string">"{0} and {1} are viewing"</span>,
    viewingMore = <span class="hljs-string">"{0}, {1}, and {2} more are viewing"</span>;
  i18n.getMessages(
    [
      typing1,
      typing2,
      typingMore,
      viewing1,
      viewing2,
      viewingMore
    ],
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">results</span>) </span>{
      typing1 = results[typing1];
      typing2 = results[typing2];
      typingMore = results[typingMore];
      viewing1 = results[viewing1];
      viewing2 = results[viewing2];
      viewingMore = results[viewingMore];
    });

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span>(<span class="hljs-params">conversationID, newPresenceValues</span>) </span>{
    <span class="hljs-keyword">if</span> (newPresenceValues.viewing)
      viewing[conversationID] = newPresenceValues.viewing;
    <span class="hljs-keyword">if</span> (newPresenceValues.typing)
      typing[conversationID] = newPresenceValues.typing;
    generateAllString(conversationID, {
      <span class="hljs-attr">viewing</span>: viewing[conversationID],
      <span class="hljs-attr">typing</span>: typing[conversationID]
    });
    generateShortString(conversationID, {
      <span class="hljs-attr">viewing</span>: viewing[conversationID],
      <span class="hljs-attr">typing</span>: typing[conversationID]
    });
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">viewing</span>: viewing[conversationID],
      <span class="hljs-attr">typing</span>: typing[conversationID]
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params">conversationID</span>) </span>{
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">viewing</span>: viewing[conversationID] || [],
      <span class="hljs-attr">typing</span>: typing[conversationID] || []
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateAllString</span>(<span class="hljs-params">conversationID, members</span>) </span>{
    <span class="hljs-keyword">var</span> result = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">var</span> typingLength = members.typing.length;
    <span class="hljs-keyword">var</span> viewingLength = members.viewing.length;
    <span class="hljs-keyword">if</span> (typingLength &lt; <span class="hljs-number">4</span> &amp;&amp; viewingLength &lt; <span class="hljs-number">4</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    <span class="hljs-keyword">switch</span> (typingLength) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        result += i18n.format(typing1, members.typing[<span class="hljs-number">0</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        result += i18n.format(typing2, members.typing[<span class="hljs-number">0</span>].name, members.typing[<span class="hljs-number">1</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">var</span> allButLastTyper = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; typingLength; i++) {
          <span class="hljs-keyword">if</span> (i &lt; typingLength - <span class="hljs-number">2</span>)
            allButLastTyper += members.typing[i].name + <span class="hljs-string">", "</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i === typingLength - <span class="hljs-number">2</span>)
            allButLastTyper += members.typing[i].name + <span class="hljs-string">","</span>;
          <span class="hljs-keyword">else</span>
            result += i18n.format(typing2, allButLastTyper, members.typing[i].name);
        }
    }
    <span class="hljs-keyword">if</span> (viewingLength &gt; <span class="hljs-number">0</span> &amp;&amp; typingLength &gt; <span class="hljs-number">0</span>)
      result += <span class="hljs-string">"\n\n"</span>;
    <span class="hljs-keyword">switch</span> (viewingLength) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        result += i18n.format(viewing1, members.viewing[<span class="hljs-number">0</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        result += i18n.format(viewing2, members.viewing[<span class="hljs-number">0</span>].name, members.viewing[<span class="hljs-number">1</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">var</span> allButLastViewer = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; viewingLength; i++) {
          <span class="hljs-keyword">if</span> (i &lt; viewingLength - <span class="hljs-number">2</span>)
            allButLastViewer += members.viewing[i].name + <span class="hljs-string">", "</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i === viewingLength - <span class="hljs-number">2</span>)
            allButLastViewer += members.viewing[i].name + <span class="hljs-string">","</span>;
          <span class="hljs-keyword">else</span>
            result += i18n.format(viewing2, allButLastViewer, members.viewing[i].name);
        }
    }
    allStrings[conversationID] = result;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateShortString</span>(<span class="hljs-params">conversationID, members</span>) </span>{
    <span class="hljs-keyword">var</span> typingLength = members.typing.length;
    <span class="hljs-keyword">var</span> viewingLength = members.viewing.length;
    <span class="hljs-keyword">var</span> typingString = <span class="hljs-string">""</span>,
      viewingString = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">var</span> inBetween = <span class="hljs-string">" "</span>;
    <span class="hljs-keyword">switch</span> (typingLength) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        typingString = i18n.format(typing1, members.typing[<span class="hljs-number">0</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        typingString = i18n.format(typing2, members.typing[<span class="hljs-number">0</span>].name, members.typing[<span class="hljs-number">1</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
        typingString = i18n.format(typing2, members.typing[<span class="hljs-number">0</span>].name + <span class="hljs-string">", "</span> + members.typing[<span class="hljs-number">1</span>].name + <span class="hljs-string">","</span>, members.typing[<span class="hljs-number">2</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        typingString = i18n.format(typingMore, members.typing[<span class="hljs-number">0</span>].name, members.typing[<span class="hljs-number">1</span>].name, (typingLength - <span class="hljs-number">2</span>));
    }
    <span class="hljs-keyword">if</span> (viewingLength &gt; <span class="hljs-number">0</span> &amp;&amp; typingLength &gt; <span class="hljs-number">0</span>)
      inBetween = <span class="hljs-string">". "</span>;
    <span class="hljs-keyword">switch</span> (viewingLength) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        viewingString = i18n.format(viewing1, members.viewing[<span class="hljs-number">0</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        viewingString = i18n.format(viewing2, members.viewing[<span class="hljs-number">0</span>].name, members.viewing[<span class="hljs-number">1</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
        viewingString = i18n.format(viewing2, members.viewing[<span class="hljs-number">0</span>].name + <span class="hljs-string">", "</span> + members.viewing[<span class="hljs-number">1</span>].name + <span class="hljs-string">","</span>, members.viewing[<span class="hljs-number">2</span>].name);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        viewingString = i18n.format(viewingMore, members.viewing[<span class="hljs-number">0</span>].name, members.viewing[<span class="hljs-number">1</span>].name, (viewingLength - <span class="hljs-number">2</span>));
    }
    shortStrings[conversationID] = typingString + inBetween + viewingString;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAllString</span>(<span class="hljs-params">conversationID</span>) </span>{
    <span class="hljs-keyword">if</span> ((viewing[conversationID] &amp;&amp; viewing[conversationID].length &gt; <span class="hljs-number">3</span>) ||
      (typing[conversationID] &amp;&amp; typing[conversationID].length &gt; <span class="hljs-number">3</span>))
      <span class="hljs-keyword">return</span> allStrings[conversationID];
    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getShortString</span>(<span class="hljs-params">conversationID</span>) </span>{
    <span class="hljs-keyword">return</span> shortStrings[conversationID];
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">remove</span>(<span class="hljs-params">conversationID</span>) </span>{
    <span class="hljs-keyword">delete</span> viewing[conversationID];
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">set</span>: set,
    <span class="hljs-attr">get</span>: get,
    <span class="hljs-attr">generateAllString</span>: generateAllString,
    <span class="hljs-attr">getAllString</span>: getAllString,
    <span class="hljs-attr">generateShortString</span>: generateShortString,
    <span class="hljs-attr">getShortString</span>: getShortString,
    <span class="hljs-attr">remove</span>: remove
  }
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/user_profile/js_includes_user_profile.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/user_profile/_module.js */</span>
angular.module(<span class="hljs-string">"sn.common.user_profile"</span>, [<span class="hljs-string">'sn.common.ui'</span>]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/user_profile/directive.snUserProfile.js */</span>
angular.module(<span class="hljs-string">'sn.common.user_profile'</span>).directive(<span class="hljs-string">'snUserProfile'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, snCustomEvent, $window, avatarProfilePersister, $timeout, $http</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'snUserProfile.xml'</span>),
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">profile</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">showDirectMessagePrompt</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope</span>) </span>{
      scope.showDirectMessagePromptFn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (scope.showDirectMessagePrompt) {
          <span class="hljs-keyword">var</span> activeUserID = $<span class="hljs-built_in">window</span>.NOW.user_id || <span class="hljs-string">""</span>;
          <span class="hljs-keyword">return</span> !(!scope.profile ||
            activeUserID === scope.profile.sysID ||
            (scope.profile.document &amp;&amp; activeUserID === scope.profile.document));
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
      };
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, snConnectService</span>) </span>{
      <span class="hljs-keyword">if</span> ($scope.profile &amp;&amp; $scope.profile.userID &amp;&amp; avatarProfilePersister.getAvatar($scope.profile.userID)) {
        $scope.profile = avatarProfilePersister.getAvatar($scope.profile.userID);
        $scope.$emit(<span class="hljs-string">"sn-user-profile.ready"</span>);
      } <span class="hljs-keyword">else</span> {
        $http.get(<span class="hljs-string">'/api/now/live/profiles/sys_user.'</span> + $scope.profile.userID).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
          angular.merge($scope.profile, response.data.result);
          avatarProfilePersister.setAvatar($scope.profile.userID, $scope.profile);
          $scope.$emit(<span class="hljs-string">"sn-user-profile.ready"</span>);
        })
      }
      $scope.openDirectMessageConversation = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        <span class="hljs-keyword">if</span> (evt.keyCode === <span class="hljs-number">9</span>)
          <span class="hljs-keyword">return</span>;
        $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          snConnectService.openWithProfile($scope.profile);
        }, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);
        angular.element(<span class="hljs-string">'.popover'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          angular.element(<span class="hljs-string">'body'</span>).off(<span class="hljs-string">'click.snUserAvatarPopoverClose'</span>);
          angular.element(<span class="hljs-keyword">this</span>).popover(<span class="hljs-string">'hide'</span>);
        });
      };
    }
  }
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/js_includes_util.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>, [<span class="hljs-string">'sn.common.auth'</span>]);
angular.module(<span class="hljs-string">'sn.util'</span>, [<span class="hljs-string">'sn.common.util'</span>]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/service.dateUtils.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>).factory(<span class="hljs-string">'dateUtils'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> dateUtils = {
    <span class="hljs-attr">SYS_DATE_FORMAT</span>: <span class="hljs-string">"yyyy-MM-dd"</span>,
    <span class="hljs-attr">SYS_TIME_FORMAT</span>: <span class="hljs-string">"HH:mm:ss"</span>,
    <span class="hljs-attr">SYS_DATE_TIME_FORMAT</span>: <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>,
    <span class="hljs-attr">MONTH_NAMES</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-string">'January'</span>, <span class="hljs-string">'February'</span>, <span class="hljs-string">'March'</span>, <span class="hljs-string">'April'</span>, <span class="hljs-string">'May'</span>, <span class="hljs-string">'June'</span>, <span class="hljs-string">'July'</span>, <span class="hljs-string">'August'</span>, <span class="hljs-string">'September'</span>, <span class="hljs-string">'October'</span>, <span class="hljs-string">'November'</span>, <span class="hljs-string">'December'</span>, <span class="hljs-string">'Jan'</span>, <span class="hljs-string">'Feb'</span>, <span class="hljs-string">'Mar'</span>, <span class="hljs-string">'Apr'</span>, <span class="hljs-string">'May'</span>, <span class="hljs-string">'Jun'</span>, <span class="hljs-string">'Jul'</span>, <span class="hljs-string">'Aug'</span>, <span class="hljs-string">'Sep'</span>, <span class="hljs-string">'Oct'</span>, <span class="hljs-string">'Nov'</span>, <span class="hljs-string">'Dec'</span>),
    <span class="hljs-attr">DAY_NAMES</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-string">'Sunday'</span>, <span class="hljs-string">'Monday'</span>, <span class="hljs-string">'Tuesday'</span>, <span class="hljs-string">'Wednesday'</span>, <span class="hljs-string">'Thursday'</span>, <span class="hljs-string">'Friday'</span>, <span class="hljs-string">'Saturday'</span>, <span class="hljs-string">'Sun'</span>, <span class="hljs-string">'Mon'</span>, <span class="hljs-string">'Tue'</span>, <span class="hljs-string">'Wed'</span>, <span class="hljs-string">'Thu'</span>, <span class="hljs-string">'Fri'</span>, <span class="hljs-string">'Sat'</span>),
    <span class="hljs-attr">LZ</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) </span>{
      <span class="hljs-keyword">return</span> (x &lt; <span class="hljs-number">0</span> || x &gt; <span class="hljs-number">9</span> ? <span class="hljs-string">""</span> : <span class="hljs-string">"0"</span>) + x
    },
    <span class="hljs-attr">isDate</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val, format</span>) </span>{
      <span class="hljs-keyword">var</span> date = <span class="hljs-keyword">this</span>.getDateFromFormat(val, format);
      <span class="hljs-keyword">if</span> (date == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    },
    <span class="hljs-attr">compareDates</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">date1, dateformat1, date2, dateformat2</span>) </span>{
      <span class="hljs-keyword">var</span> d1 = <span class="hljs-keyword">this</span>.getDateFromFormat(date1, dateformat1);
      <span class="hljs-keyword">var</span> d2 = <span class="hljs-keyword">this</span>.getDateFromFormat(date2, dateformat2);
      <span class="hljs-keyword">if</span> (d1 == <span class="hljs-number">0</span> || d2 == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (d1 &gt; d2) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    },
    <span class="hljs-attr">formatDateServer</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">date, format</span>) </span>{
      <span class="hljs-keyword">var</span> ga = <span class="hljs-keyword">new</span> GlideAjax(<span class="hljs-string">"DateTimeUtils"</span>);
      ga.addParam(<span class="hljs-string">"sysparm_name"</span>, <span class="hljs-string">"formatCalendarDate"</span>);
      <span class="hljs-keyword">var</span> browserOffset = date.getTimezoneOffset() * <span class="hljs-number">60000</span>;
      <span class="hljs-keyword">var</span> utcTime = date.getTime() - browserOffset;
      <span class="hljs-keyword">var</span> userDateTime = utcTime - g_tz_offset;
      ga.addParam(<span class="hljs-string">"sysparm_value"</span>, userDateTime);
      ga.getXMLWait();
      <span class="hljs-keyword">return</span> ga.getAnswer();
    },
    <span class="hljs-attr">formatDate</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">date, format</span>) </span>{
      <span class="hljs-keyword">if</span> (format.indexOf(<span class="hljs-string">"z"</span>) &gt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.formatDateServer(date, format);
      format = format + <span class="hljs-string">""</span>;
      <span class="hljs-keyword">var</span> result = <span class="hljs-string">""</span>;
      <span class="hljs-keyword">var</span> i_format = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">var</span> c = <span class="hljs-string">""</span>;
      <span class="hljs-keyword">var</span> token = <span class="hljs-string">""</span>;
      <span class="hljs-keyword">var</span> y = date.getYear() + <span class="hljs-string">""</span>;
      <span class="hljs-keyword">var</span> M = date.getMonth() + <span class="hljs-number">1</span>;
      <span class="hljs-keyword">var</span> d = date.getDate();
      <span class="hljs-keyword">var</span> E = date.getDay();
      <span class="hljs-keyword">var</span> H = date.getHours();
      <span class="hljs-keyword">var</span> m = date.getMinutes();
      <span class="hljs-keyword">var</span> s = date.getSeconds();
      <span class="hljs-keyword">var</span> yyyy, yy, MMM, MM, dd, hh, h, mm, ss, ampm, HH, H, KK, K, kk, k;
      <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Object</span>();
      value[<span class="hljs-string">"M"</span>] = M;
      value[<span class="hljs-string">"MM"</span>] = <span class="hljs-keyword">this</span>.LZ(M);
      value[<span class="hljs-string">"MMM"</span>] = <span class="hljs-keyword">this</span>.MONTH_NAMES[M + <span class="hljs-number">11</span>];
      value[<span class="hljs-string">"NNN"</span>] = <span class="hljs-keyword">this</span>.MONTH_NAMES[M + <span class="hljs-number">11</span>];
      value[<span class="hljs-string">"MMMM"</span>] = <span class="hljs-keyword">this</span>.MONTH_NAMES[M - <span class="hljs-number">1</span>];
      value[<span class="hljs-string">"d"</span>] = d;
      value[<span class="hljs-string">"dd"</span>] = <span class="hljs-keyword">this</span>.LZ(d);
      value[<span class="hljs-string">"E"</span>] = <span class="hljs-keyword">this</span>.DAY_NAMES[E + <span class="hljs-number">7</span>];
      value[<span class="hljs-string">"EE"</span>] = <span class="hljs-keyword">this</span>.DAY_NAMES[E];
      value[<span class="hljs-string">"H"</span>] = H;
      value[<span class="hljs-string">"HH"</span>] = <span class="hljs-keyword">this</span>.LZ(H);
      <span class="hljs-keyword">if</span> (format.indexOf(<span class="hljs-string">'w'</span>) != <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">var</span> wk = date.getWeek();
        <span class="hljs-keyword">if</span> (wk &gt;= <span class="hljs-number">52</span> &amp;&amp; M == <span class="hljs-number">1</span>) {
          y = date.getYear();
          y--;
          y = y + <span class="hljs-string">""</span>;
        }
        <span class="hljs-keyword">if</span> (wk == <span class="hljs-number">1</span> &amp;&amp; M == <span class="hljs-number">12</span>) {
          y = date.getYear();
          y++;
          y = y + <span class="hljs-string">""</span>;
        }
        value[<span class="hljs-string">"w"</span>] = wk;
        value[<span class="hljs-string">"ww"</span>] = <span class="hljs-keyword">this</span>.LZ(wk);
      }
      <span class="hljs-keyword">var</span> dayOfWeek = (<span class="hljs-number">7</span> + (E + <span class="hljs-number">1</span>) - (g_first_day_of_week - <span class="hljs-number">1</span>)) % <span class="hljs-number">7</span>;
      <span class="hljs-keyword">if</span> (dayOfWeek == <span class="hljs-number">0</span>)
        dayOfWeek = <span class="hljs-number">7</span>;
      value[<span class="hljs-string">"D"</span>] = dayOfWeek;
      <span class="hljs-keyword">if</span> (y.length &lt; <span class="hljs-number">4</span>) {
        y = <span class="hljs-string">""</span> + (y - <span class="hljs-number">0</span> + <span class="hljs-number">1900</span>);
      }
      value[<span class="hljs-string">"y"</span>] = <span class="hljs-string">""</span> + y;
      value[<span class="hljs-string">"yyyy"</span>] = y;
      value[<span class="hljs-string">"yy"</span>] = y.substring(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>);
      <span class="hljs-keyword">if</span> (H == <span class="hljs-number">0</span>) {
        value[<span class="hljs-string">"h"</span>] = <span class="hljs-number">12</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (H &gt; <span class="hljs-number">12</span>) {
        value[<span class="hljs-string">"h"</span>] = H - <span class="hljs-number">12</span>;
      } <span class="hljs-keyword">else</span> {
        value[<span class="hljs-string">"h"</span>] = H;
      }
      value[<span class="hljs-string">"hh"</span>] = <span class="hljs-keyword">this</span>.LZ(value[<span class="hljs-string">"h"</span>]);
      <span class="hljs-keyword">if</span> (H &gt; <span class="hljs-number">11</span>) {
        value[<span class="hljs-string">"K"</span>] = H - <span class="hljs-number">12</span>;
      } <span class="hljs-keyword">else</span> {
        value[<span class="hljs-string">"K"</span>] = H;
      }
      value[<span class="hljs-string">"k"</span>] = H + <span class="hljs-number">1</span>;
      value[<span class="hljs-string">"KK"</span>] = <span class="hljs-keyword">this</span>.LZ(value[<span class="hljs-string">"K"</span>]);
      value[<span class="hljs-string">"kk"</span>] = <span class="hljs-keyword">this</span>.LZ(value[<span class="hljs-string">"k"</span>]);
      <span class="hljs-keyword">if</span> (H &gt; <span class="hljs-number">11</span>) {
        value[<span class="hljs-string">"a"</span>] = <span class="hljs-string">"PM"</span>;
      } <span class="hljs-keyword">else</span> {
        value[<span class="hljs-string">"a"</span>] = <span class="hljs-string">"AM"</span>;
      }
      value[<span class="hljs-string">"m"</span>] = m;
      value[<span class="hljs-string">"mm"</span>] = <span class="hljs-keyword">this</span>.LZ(m);
      value[<span class="hljs-string">"s"</span>] = s;
      value[<span class="hljs-string">"ss"</span>] = <span class="hljs-keyword">this</span>.LZ(s);
      <span class="hljs-keyword">while</span> (i_format &lt; format.length) {
        c = format.charAt(i_format);
        token = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">while</span> ((format.charAt(i_format) == c) &amp;&amp; (i_format &lt; format.length)) {
          token += format.charAt(i_format++);
        }
        <span class="hljs-keyword">if</span> (value[token] != <span class="hljs-literal">null</span>) {
          result = result + value[token];
        } <span class="hljs-keyword">else</span> {
          result = result + token;
        }
      }
      <span class="hljs-keyword">return</span> result;
    },
    <span class="hljs-attr">_isInteger</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>) </span>{
      <span class="hljs-keyword">var</span> digits = <span class="hljs-string">"1234567890"</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; val.length; i++) {
        <span class="hljs-keyword">if</span> (digits.indexOf(val.charAt(i)) == <span class="hljs-number">-1</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    },
    <span class="hljs-attr">_getInt</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">str, i, minlength, maxlength</span>) </span>{
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = maxlength; x &gt;= minlength; x--) {
        <span class="hljs-keyword">var</span> token = str.substring(i, i + x);
        <span class="hljs-keyword">if</span> (token.length &lt; minlength) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._isInteger(token)) {
          <span class="hljs-keyword">return</span> token;
        }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    },
    <span class="hljs-attr">getDateFromFormat</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val, format</span>) </span>{
      val = val + <span class="hljs-string">""</span>;
      format = format + <span class="hljs-string">""</span>;
      <span class="hljs-keyword">var</span> i_val = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">var</span> i_format = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">var</span> c = <span class="hljs-string">""</span>;
      <span class="hljs-keyword">var</span> token = <span class="hljs-string">""</span>;
      <span class="hljs-keyword">var</span> token2 = <span class="hljs-string">""</span>;
      <span class="hljs-keyword">var</span> x, y;
      <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      <span class="hljs-keyword">var</span> year = now.getYear();
      <span class="hljs-keyword">var</span> month = now.getMonth() + <span class="hljs-number">1</span>;
      <span class="hljs-keyword">var</span> date = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">var</span> hh = now.getHours();
      <span class="hljs-keyword">var</span> mm = now.getMinutes();
      <span class="hljs-keyword">var</span> ss = now.getSeconds();
      <span class="hljs-keyword">var</span> ampm = <span class="hljs-string">""</span>;
      <span class="hljs-keyword">var</span> week = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">while</span> (i_format &lt; format.length) {
        c = format.charAt(i_format);
        token = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">while</span> ((format.charAt(i_format) == c) &amp;&amp; (i_format &lt; format.length)) {
          token += format.charAt(i_format++);
        }
        <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"yyyy"</span> || token == <span class="hljs-string">"yy"</span> || token == <span class="hljs-string">"y"</span>) {
          <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"yyyy"</span>) {
            x = <span class="hljs-number">4</span>;
            y = <span class="hljs-number">4</span>;
          }
          <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"yy"</span>) {
            x = <span class="hljs-number">2</span>;
            y = <span class="hljs-number">2</span>;
          }
          <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"y"</span>) {
            x = <span class="hljs-number">2</span>;
            y = <span class="hljs-number">4</span>;
          }
          year = <span class="hljs-keyword">this</span>._getInt(val, i_val, x, y);
          <span class="hljs-keyword">if</span> (year == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
          i_val += year.length;
          <span class="hljs-keyword">if</span> (year.length == <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">if</span> (year &gt; <span class="hljs-number">70</span>) {
              year = <span class="hljs-number">1900</span> + (year - <span class="hljs-number">0</span>);
            } <span class="hljs-keyword">else</span> {
              year = <span class="hljs-number">2000</span> + (year - <span class="hljs-number">0</span>);
            }
          }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"MMM"</span> || token == <span class="hljs-string">"NNN"</span>) {
          month = <span class="hljs-number">0</span>;
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.MONTH_NAMES.length; i++) {
            <span class="hljs-keyword">var</span> month_name = <span class="hljs-keyword">this</span>.MONTH_NAMES[i];
            <span class="hljs-keyword">if</span> (val.substring(i_val, i_val + month_name.length).toLowerCase() == month_name.toLowerCase()) {
              <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"MMM"</span> || (token == <span class="hljs-string">"NNN"</span> &amp;&amp; i &gt; <span class="hljs-number">11</span>)) {
                month = i + <span class="hljs-number">1</span>;
                <span class="hljs-keyword">if</span> (month &gt; <span class="hljs-number">12</span>) {
                  month -= <span class="hljs-number">12</span>;
                }
                i_val += month_name.length;
                <span class="hljs-keyword">break</span>;
              }
            }
          }
          <span class="hljs-keyword">if</span> ((month &lt; <span class="hljs-number">1</span>) || (month &gt; <span class="hljs-number">12</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"EE"</span> || token == <span class="hljs-string">"E"</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.DAY_NAMES.length; i++) {
            <span class="hljs-keyword">var</span> day_name = <span class="hljs-keyword">this</span>.DAY_NAMES[i];
            <span class="hljs-keyword">if</span> (val.substring(i_val, i_val + day_name.length).toLowerCase() == day_name.toLowerCase()) {
              <span class="hljs-keyword">if</span> (week) {
                <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span> || i == <span class="hljs-number">7</span>)
                  date += <span class="hljs-number">6</span>;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i == <span class="hljs-number">2</span> || i == <span class="hljs-number">9</span>)
                  date += <span class="hljs-number">1</span>;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i == <span class="hljs-number">3</span> || i == <span class="hljs-number">10</span>)
                  date += <span class="hljs-number">2</span>;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i == <span class="hljs-number">4</span> || i == <span class="hljs-number">11</span>)
                  date += <span class="hljs-number">3</span>;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i == <span class="hljs-number">5</span> || i == <span class="hljs-number">12</span>)
                  date += <span class="hljs-number">4</span>;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i == <span class="hljs-number">6</span> || i == <span class="hljs-number">13</span>)
                  date += <span class="hljs-number">5</span>;
              }
              i_val += day_name.length;
              <span class="hljs-keyword">break</span>;
            }
          }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"MM"</span> || token == <span class="hljs-string">"M"</span>) {
          month = <span class="hljs-keyword">this</span>._getInt(val, i_val, token.length, <span class="hljs-number">2</span>);
          <span class="hljs-keyword">if</span> (month == <span class="hljs-literal">null</span> || (month &lt; <span class="hljs-number">1</span>) || (month &gt; <span class="hljs-number">12</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
          i_val += month.length;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"dd"</span> || token == <span class="hljs-string">"d"</span>) {
          date = <span class="hljs-keyword">this</span>._getInt(val, i_val, token.length, <span class="hljs-number">2</span>);
          <span class="hljs-keyword">if</span> (date == <span class="hljs-literal">null</span> || (date &lt; <span class="hljs-number">1</span>) || (date &gt; <span class="hljs-number">31</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
          i_val += date.length;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"hh"</span> || token == <span class="hljs-string">"h"</span>) {
          hh = <span class="hljs-keyword">this</span>._getInt(val, i_val, token.length, <span class="hljs-number">2</span>);
          <span class="hljs-keyword">if</span> (hh == <span class="hljs-literal">null</span> || (hh &lt; <span class="hljs-number">1</span>) || (hh &gt; <span class="hljs-number">12</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
          i_val += hh.length;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"HH"</span> || token == <span class="hljs-string">"H"</span>) {
          hh = <span class="hljs-keyword">this</span>._getInt(val, i_val, token.length, <span class="hljs-number">2</span>);
          <span class="hljs-keyword">if</span> (hh == <span class="hljs-literal">null</span> || (hh &lt; <span class="hljs-number">0</span>) || (hh &gt; <span class="hljs-number">23</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
          i_val += hh.length;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"KK"</span> || token == <span class="hljs-string">"K"</span>) {
          hh = <span class="hljs-keyword">this</span>._getInt(val, i_val, token.length, <span class="hljs-number">2</span>);
          <span class="hljs-keyword">if</span> (hh == <span class="hljs-literal">null</span> || (hh &lt; <span class="hljs-number">0</span>) || (hh &gt; <span class="hljs-number">11</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
          i_val += hh.length;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"kk"</span> || token == <span class="hljs-string">"k"</span>) {
          hh = <span class="hljs-keyword">this</span>._getInt(val, i_val, token.length, <span class="hljs-number">2</span>);
          <span class="hljs-keyword">if</span> (hh == <span class="hljs-literal">null</span> || (hh &lt; <span class="hljs-number">1</span>) || (hh &gt; <span class="hljs-number">24</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
          i_val += hh.length;
          hh--;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"mm"</span> || token == <span class="hljs-string">"m"</span>) {
          mm = <span class="hljs-keyword">this</span>._getInt(val, i_val, token.length, <span class="hljs-number">2</span>);
          <span class="hljs-keyword">if</span> (mm == <span class="hljs-literal">null</span> || (mm &lt; <span class="hljs-number">0</span>) || (mm &gt; <span class="hljs-number">59</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
          i_val += mm.length;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"ss"</span> || token == <span class="hljs-string">"s"</span>) {
          ss = <span class="hljs-keyword">this</span>._getInt(val, i_val, token.length, <span class="hljs-number">2</span>);
          <span class="hljs-keyword">if</span> (ss == <span class="hljs-literal">null</span> || (ss &lt; <span class="hljs-number">0</span>) || (ss &gt; <span class="hljs-number">59</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
          i_val += ss.length;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"a"</span>) {
          <span class="hljs-keyword">if</span> (val.substring(i_val, i_val + <span class="hljs-number">2</span>).toLowerCase() == <span class="hljs-string">"am"</span>) {
            ampm = <span class="hljs-string">"AM"</span>;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val.substring(i_val, i_val + <span class="hljs-number">2</span>).toLowerCase() == <span class="hljs-string">"pm"</span>) {
            ampm = <span class="hljs-string">"PM"</span>;
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
          i_val += <span class="hljs-number">2</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"w"</span> || token == <span class="hljs-string">"ww"</span>) {
          <span class="hljs-keyword">var</span> weekNum = <span class="hljs-keyword">this</span>._getInt(val, i_val, token.length, <span class="hljs-number">2</span>);
          week = <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">if</span> (weekNum != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">var</span> temp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(year, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            temp.setWeek(<span class="hljs-built_in">parseInt</span>(weekNum, <span class="hljs-number">10</span>));
            year = temp.getFullYear();
            month = temp.getMonth() + <span class="hljs-number">1</span>;
            date = temp.getDate();
          }
          weekNum += <span class="hljs-string">""</span>;
          i_val += weekNum.length;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"D"</span>) {
          <span class="hljs-keyword">if</span> (week) {
            <span class="hljs-keyword">var</span> day = <span class="hljs-keyword">this</span>._getInt(val, i_val, token.length, <span class="hljs-number">1</span>);
            <span class="hljs-keyword">if</span> ((day == <span class="hljs-literal">null</span>) || (day &lt;= <span class="hljs-number">0</span>) || (day &gt; <span class="hljs-number">7</span>))
              <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">var</span> temp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(year, month - <span class="hljs-number">1</span>, date, hh, mm, ss);
            <span class="hljs-keyword">var</span> dayOfWeek = temp.getDay();
            day = <span class="hljs-built_in">parseInt</span>(day, <span class="hljs-number">10</span>);
            day = (day + g_first_day_of_week - <span class="hljs-number">1</span>) % <span class="hljs-number">7</span>;
            <span class="hljs-keyword">if</span> (day == <span class="hljs-number">0</span>)
              day = <span class="hljs-number">7</span>;
            day--;
            <span class="hljs-keyword">if</span> (day &lt; dayOfWeek)
              day = <span class="hljs-number">7</span> - (dayOfWeek - day);
            <span class="hljs-keyword">else</span>
              day -= dayOfWeek;
            <span class="hljs-keyword">if</span> (day &gt; <span class="hljs-number">0</span>) {
              temp.setDate(temp.getDate() + day);
              year = temp.getFullYear();
              month = temp.getMonth() + <span class="hljs-number">1</span>;
              date = temp.getDate();
            }
            i_val++;
          }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token == <span class="hljs-string">"z"</span>)
          i_val += <span class="hljs-number">3</span>;
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (val.substring(i_val, i_val + token.length) != token) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          } <span class="hljs-keyword">else</span> {
            i_val += token.length;
          }
        }
      }
      <span class="hljs-keyword">if</span> (i_val != val.length) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
      }
      <span class="hljs-keyword">if</span> (month == <span class="hljs-number">2</span>) {
        <span class="hljs-keyword">if</span> (((year % <span class="hljs-number">4</span> == <span class="hljs-number">0</span>) &amp;&amp; (year % <span class="hljs-number">100</span> != <span class="hljs-number">0</span>)) || (year % <span class="hljs-number">400</span> == <span class="hljs-number">0</span>)) {
          <span class="hljs-keyword">if</span> (date &gt; <span class="hljs-number">29</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (date &gt; <span class="hljs-number">28</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
          }
        }
      }
      <span class="hljs-keyword">if</span> ((month == <span class="hljs-number">4</span>) || (month == <span class="hljs-number">6</span>) || (month == <span class="hljs-number">9</span>) || (month == <span class="hljs-number">11</span>)) {
        <span class="hljs-keyword">if</span> (date &gt; <span class="hljs-number">30</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
      }
      <span class="hljs-keyword">if</span> (hh &lt; <span class="hljs-number">12</span> &amp;&amp; ampm == <span class="hljs-string">"PM"</span>) {
        hh = hh - <span class="hljs-number">0</span> + <span class="hljs-number">12</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (hh &gt; <span class="hljs-number">11</span> &amp;&amp; ampm == <span class="hljs-string">"AM"</span>) {
        hh -= <span class="hljs-number">12</span>;
      }
      <span class="hljs-keyword">var</span> newdate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(year, month - <span class="hljs-number">1</span>, date, hh, mm, ss);
      <span class="hljs-keyword">return</span> newdate.getTime();
    },
    <span class="hljs-attr">parseDate</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>) </span>{
      <span class="hljs-keyword">var</span> preferEuro = (<span class="hljs-built_in">arguments</span>.length == <span class="hljs-number">2</span>) ? <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>] : <span class="hljs-literal">false</span>;
      generalFormats = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-string">'y-M-d'</span>, <span class="hljs-string">'MMM d, y'</span>, <span class="hljs-string">'MMM d,y'</span>, <span class="hljs-string">'y-MMM-d'</span>, <span class="hljs-string">'d-MMM-y'</span>, <span class="hljs-string">'MMM d'</span>);
      monthFirst = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-string">'M/d/y'</span>, <span class="hljs-string">'M-d-y'</span>, <span class="hljs-string">'M.d.y'</span>, <span class="hljs-string">'MMM-d'</span>, <span class="hljs-string">'M/d'</span>, <span class="hljs-string">'M-d'</span>);
      dateFirst = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-string">'d/M/y'</span>, <span class="hljs-string">'d-M-y'</span>, <span class="hljs-string">'d.M.y'</span>, <span class="hljs-string">'d-MMM'</span>, <span class="hljs-string">'d/M'</span>, <span class="hljs-string">'d-M'</span>);
      yearFirst = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-string">'yyyyw.F'</span>, <span class="hljs-string">'yyw.F'</span>);
      <span class="hljs-keyword">var</span> checkList = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-string">'generalFormats'</span>, preferEuro ? <span class="hljs-string">'dateFirst'</span> : <span class="hljs-string">'monthFirst'</span>, preferEuro ? <span class="hljs-string">'monthFirst'</span> : <span class="hljs-string">'dateFirst'</span>, <span class="hljs-string">'yearFirst'</span>);
      <span class="hljs-keyword">var</span> d = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; checkList.length; i++) {
        <span class="hljs-keyword">var</span> l = <span class="hljs-built_in">window</span>[checkList[i]];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; l.length; j++) {
          d = <span class="hljs-keyword">this</span>.getDateFromFormat(val, l[j]);
          <span class="hljs-keyword">if</span> (d != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(d);
          }
        }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  };
  <span class="hljs-built_in">Date</span>.prototype.getWeek = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> newYear = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-keyword">this</span>.getFullYear(), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">var</span> day = newYear.getDay() - (g_first_day_of_week - <span class="hljs-number">1</span>);
    day = (day &gt;= <span class="hljs-number">0</span> ? day : day + <span class="hljs-number">7</span>);
    <span class="hljs-keyword">var</span> dayNum = <span class="hljs-built_in">Math</span>.floor((<span class="hljs-keyword">this</span>.getTime() - newYear.getTime() - (<span class="hljs-keyword">this</span>.getTimezoneOffset() - newYear.getTimezoneOffset()) * <span class="hljs-number">60000</span>) / <span class="hljs-number">86400000</span>) + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> weekNum;
    <span class="hljs-keyword">if</span> (day &lt; <span class="hljs-number">4</span>) {
      weekNum = <span class="hljs-built_in">Math</span>.floor((dayNum + day - <span class="hljs-number">1</span>) / <span class="hljs-number">7</span>) + <span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (weekNum &gt; <span class="hljs-number">52</span>)
        weekNum = <span class="hljs-keyword">this</span>._checkNextYear(weekNum);
      <span class="hljs-keyword">return</span> weekNum;
    }
    weekNum = <span class="hljs-built_in">Math</span>.floor((dayNum + day - <span class="hljs-number">1</span>) / <span class="hljs-number">7</span>);
    <span class="hljs-keyword">if</span> (weekNum &lt; <span class="hljs-number">1</span>)
      weekNum = <span class="hljs-keyword">this</span>._lastWeekOfYear();
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (weekNum &gt; <span class="hljs-number">52</span>)
      weekNum = <span class="hljs-keyword">this</span>._checkNextYear(weekNum);
    <span class="hljs-keyword">return</span> weekNum;
  };
  <span class="hljs-built_in">Date</span>.prototype._lastWeekOfYear = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> newYear = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-keyword">this</span>.getFullYear() - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">var</span> endOfYear = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-keyword">this</span>.getFullYear() - <span class="hljs-number">1</span>, <span class="hljs-number">11</span>, <span class="hljs-number">31</span>);
    <span class="hljs-keyword">var</span> day = newYear.getDay() - (g_first_day_of_week - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">var</span> dayNum = <span class="hljs-built_in">Math</span>.floor((endOfYear.getTime() - newYear.getTime() - (endOfYear.getTimezoneOffset() - newYear.getTimezoneOffset()) * <span class="hljs-number">60000</span>) / <span class="hljs-number">86400000</span>) + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> day &lt; <span class="hljs-number">4</span> ? <span class="hljs-built_in">Math</span>.floor((dayNum + day - <span class="hljs-number">1</span>) / <span class="hljs-number">7</span>) + <span class="hljs-number">1</span> : <span class="hljs-built_in">Math</span>.floor((dayNum + day - <span class="hljs-number">1</span>) / <span class="hljs-number">7</span>);
  };
  <span class="hljs-built_in">Date</span>.prototype._checkNextYear = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> nYear = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-keyword">this</span>.getFullYear() + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">var</span> nDay = nYear.getDay() - (g_first_day_of_week - <span class="hljs-number">1</span>);
    nDay = nDay &gt;= <span class="hljs-number">0</span> ? nDay : nDay + <span class="hljs-number">7</span>;
    <span class="hljs-keyword">return</span> nDay &lt; <span class="hljs-number">4</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">53</span>;
  };
  <span class="hljs-built_in">Date</span>.prototype.setWeek = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">weekNum</span>) </span>{
    weekNum--;
    <span class="hljs-keyword">var</span> startOfYear = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-keyword">this</span>.getFullYear(), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">var</span> day = startOfYear.getDay() - (g_first_day_of_week - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> (day &gt; <span class="hljs-number">0</span> &amp;&amp; day &lt; <span class="hljs-number">4</span>) {
      <span class="hljs-keyword">this</span>.setFullYear(startOfYear.getFullYear() - <span class="hljs-number">1</span>);
      <span class="hljs-keyword">this</span>.setDate(<span class="hljs-number">31</span> - day + <span class="hljs-number">1</span>);
      <span class="hljs-keyword">this</span>.setMonth(<span class="hljs-number">11</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (day &gt; <span class="hljs-number">3</span>)
      <span class="hljs-keyword">this</span>.setDate(startOfYear.getDate() + (<span class="hljs-number">7</span> - day));
    <span class="hljs-keyword">this</span>.setDate(<span class="hljs-keyword">this</span>.getDate() + (<span class="hljs-number">7</span> * weekNum));
  };
  <span class="hljs-keyword">return</span> dateUtils;
});
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/service.debounceFn.js */</span>
angular.module(<span class="hljs-string">"sn.common.util"</span>).service(<span class="hljs-string">"debounceFn"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">debounce</span>(<span class="hljs-params">func, wait, immediate</span>) </span>{
    <span class="hljs-keyword">var</span> timeout;
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">this</span>,
        args = <span class="hljs-built_in">arguments</span>;
      <span class="hljs-keyword">var</span> later = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        timeout = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (!immediate) func.apply(context, args);
      };
      <span class="hljs-keyword">var</span> callNow = immediate &amp;&amp; !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      <span class="hljs-keyword">if</span> (callNow) func.apply(context, args);
    };
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">debounce</span>: debounce
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/factory.unwrappedHTTPPromise.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>).factory(<span class="hljs-string">"unwrappedHTTPPromise"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$q</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isGenericPromise</span>(<span class="hljs-params">promise</span>) </span>{
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> promise.then === <span class="hljs-string">"function"</span> &amp;&amp;
      promise.success === <span class="hljs-literal">undefined</span> &amp;&amp;
      promise.error === <span class="hljs-literal">undefined</span>);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">httpPromise</span>) </span>{
    <span class="hljs-keyword">if</span> (isGenericPromise(httpPromise))
      <span class="hljs-keyword">return</span> httpPromise;
    <span class="hljs-keyword">var</span> deferred = $q.defer();
    httpPromise.success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
      deferred.resolve(data);
    }).error(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, status</span>) </span>{
      deferred.reject({
        <span class="hljs-attr">data</span>: data,
        <span class="hljs-attr">status</span>: status
      })
    });
    <span class="hljs-keyword">return</span> deferred.promise;
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/service.urlTools.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>).constant(<span class="hljs-string">'angularProcessorUrl'</span>, <span class="hljs-string">'angular.do?sysparm_type='</span>);
angular.module(<span class="hljs-string">'sn.common.util'</span>).factory(<span class="hljs-string">"urlTools"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, angularProcessorUrl</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPartialURL</span>(<span class="hljs-params">name, parameters</span>) </span>{
    <span class="hljs-keyword">var</span> url = getTemplateUrl(name);
    <span class="hljs-keyword">if</span> (parameters) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> parameters !== <span class="hljs-string">'string'</span>) {
        parameters = encodeURIParameters(parameters);
      }
      <span class="hljs-keyword">if</span> (parameters.length) {
        url += <span class="hljs-string">"&amp;"</span> + parameters;
      }
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.NOW &amp;&amp; <span class="hljs-built_in">window</span>.NOW.ng_cache_defeat)
      url += <span class="hljs-string">"&amp;t="</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    <span class="hljs-keyword">return</span> url;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getURL</span>(<span class="hljs-params">name, parameters</span>) </span>{
    <span class="hljs-keyword">if</span> (parameters &amp;&amp; <span class="hljs-keyword">typeof</span> parameters === <span class="hljs-string">'object'</span>)
      <span class="hljs-keyword">return</span> urlFor(name, parameters);
    <span class="hljs-keyword">var</span> url = angularProcessorUrl;
    url += name;
    <span class="hljs-keyword">if</span> (parameters)
      url += <span class="hljs-string">"&amp;"</span> + parameters;
    <span class="hljs-keyword">return</span> url;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">urlFor</span>(<span class="hljs-params">route, parameters</span>) </span>{
    <span class="hljs-keyword">var</span> p = encodeURIParameters(parameters);
    <span class="hljs-keyword">return</span> angularProcessorUrl + route + (p.length ? <span class="hljs-string">'&amp;'</span> + p : <span class="hljs-string">''</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPropertyURL</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">var</span> url = angularProcessorUrl + <span class="hljs-string">"get_property&amp;name="</span> + name;
    url += <span class="hljs-string">"&amp;t="</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    <span class="hljs-keyword">return</span> url;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encodeURIParameters</span>(<span class="hljs-params">parameters</span>) </span>{
    <span class="hljs-keyword">var</span> s = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> parameter <span class="hljs-keyword">in</span> parameters) {
      <span class="hljs-keyword">if</span> (parameters.hasOwnProperty(parameter)) {
        <span class="hljs-keyword">var</span> key = <span class="hljs-built_in">encodeURIComponent</span>(parameter);
        <span class="hljs-keyword">var</span> value = parameters[parameter] ? <span class="hljs-built_in">encodeURIComponent</span>(parameters[parameter]) : <span class="hljs-string">''</span>;
        s.push(key + <span class="hljs-string">"="</span> + value);
      }
    }
    <span class="hljs-keyword">return</span> s.join(<span class="hljs-string">'&amp;'</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseQueryString</span>(<span class="hljs-params">qs</span>) </span>{
    qs = qs || <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (qs.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'?'</span>) {
      qs = qs.substr(<span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">var</span> a = qs.split(<span class="hljs-string">'&amp;'</span>);
    <span class="hljs-keyword">if</span> (a === <span class="hljs-string">""</span>) {
      <span class="hljs-keyword">return</span> {};
    }
    <span class="hljs-keyword">if</span> (a &amp;&amp; a[<span class="hljs-number">0</span>].indexOf(<span class="hljs-string">'http'</span>) != <span class="hljs-number">-1</span>)
      a[<span class="hljs-number">0</span>] = a[<span class="hljs-number">0</span>].split(<span class="hljs-string">"?"</span>)[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">var</span> b = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; a.length; i++) {
      <span class="hljs-keyword">var</span> p = a[i].split(<span class="hljs-string">'='</span>, <span class="hljs-number">2</span>);
      <span class="hljs-keyword">if</span> (p.length == <span class="hljs-number">1</span>) {
        b[p[<span class="hljs-number">0</span>]] = <span class="hljs-string">""</span>;
      } <span class="hljs-keyword">else</span> {
        b[p[<span class="hljs-number">0</span>]] = <span class="hljs-built_in">decodeURIComponent</span>(p[<span class="hljs-number">1</span>].replace(<span class="hljs-regexp">/\+/g</span>, <span class="hljs-string">" "</span>));
      }
    }
    <span class="hljs-keyword">return</span> b;
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">getPartialURL</span>: getPartialURL,
    <span class="hljs-attr">getURL</span>: getURL,
    <span class="hljs-attr">urlFor</span>: urlFor,
    <span class="hljs-attr">getPropertyURL</span>: getPropertyURL,
    <span class="hljs-attr">encodeURIParameters</span>: encodeURIParameters,
    <span class="hljs-attr">parseQueryString</span>: parseQueryString
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/service.getTemplateUrl.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>).provider(<span class="hljs-string">'getTemplateUrl'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">angularProcessorUrl</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">var</span> _handlerId = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> _handlers = {};
  <span class="hljs-keyword">this</span>.registerHandler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handler</span>) </span>{
    <span class="hljs-keyword">var</span> registeredId = _handlerId;
    _handlers[_handlerId] = handler;
    _handlerId++;
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">delete</span> _handlers[registeredId];
    };
  };
  <span class="hljs-keyword">this</span>.$get = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> getTemplateUrl;
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTemplateUrl</span>(<span class="hljs-params">templatePath</span>) </span>{
    <span class="hljs-keyword">if</span> (_handlerId &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> path;
      <span class="hljs-keyword">var</span> handled = <span class="hljs-literal">false</span>;
      angular.forEach(_handlers, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handler</span>) </span>{
        <span class="hljs-keyword">if</span> (!handled) {
          <span class="hljs-keyword">var</span> handlerPath = handler(templatePath);
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> handlerPath !== <span class="hljs-string">'undefined'</span>) {
            path = handlerPath;
            handled = <span class="hljs-literal">true</span>;
          }
        }
      });
      <span class="hljs-keyword">if</span> (handled) {
        <span class="hljs-keyword">return</span> path;
      }
    }
    <span class="hljs-keyword">return</span> angularProcessorUrl + <span class="hljs-string">'get_partial&amp;name='</span> + templatePath;
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/service.snTabActivity.js */</span>
angular.module(<span class="hljs-string">"sn.common.util"</span>).service(<span class="hljs-string">"snTabActivity"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$window, $timeout, $rootElement, $document</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> activeEvents = [<span class="hljs-string">"keydown"</span>, <span class="hljs-string">"DOMMouseScroll"</span>, <span class="hljs-string">"mousewheel"</span>, <span class="hljs-string">"mousedown"</span>, <span class="hljs-string">"touchstart"</span>, <span class="hljs-string">"mousemove"</span>, <span class="hljs-string">"mouseenter"</span>, <span class="hljs-string">"input"</span>, <span class="hljs-string">"focus"</span>, <span class="hljs-string">"scroll"</span>],
    defaultIdle = <span class="hljs-number">75000</span>,
    isPrimary = <span class="hljs-literal">true</span>,
    idleTime = <span class="hljs-number">0</span>,
    isVisible = <span class="hljs-literal">true</span>,
    idleTimeout = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>),
    pageIdleTimeout = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>),
    hasActed = <span class="hljs-literal">false</span>,
    appName = $rootElement.attr(<span class="hljs-string">'ng-app'</span>) || <span class="hljs-string">""</span>,
    storageKey = <span class="hljs-string">"sn.tabs."</span> + appName + <span class="hljs-string">".activeTab"</span>;
  <span class="hljs-keyword">var</span> callbacks = {
    <span class="hljs-string">"tab.primary"</span>: [],
    <span class="hljs-string">"tab.secondary"</span>: [],
    <span class="hljs-string">"activity.active"</span>: [],
    <span class="hljs-string">"activity.idle"</span>: [{
      <span class="hljs-attr">delay</span>: defaultIdle,
      <span class="hljs-attr">cb</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{}
    }]
  };
  $<span class="hljs-built_in">window</span>.tabGUID = $<span class="hljs-built_in">window</span>.tabGUID || createGUID();

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getActiveEvents</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> activeEvents.join(<span class="hljs-string">".snTabActivity "</span>) + <span class="hljs-string">".snTabActivity"</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setAppName</span>(<span class="hljs-params">an</span>) </span>{
    appName = an;
    storageKey = <span class="hljs-string">"sn.tabs."</span> + appName + <span class="hljs-string">".activeTab"</span>;
    makePrimary(<span class="hljs-literal">true</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createGUID</span>(<span class="hljs-params">l</span>) </span>{
    l = l || <span class="hljs-number">32</span>;
    <span class="hljs-keyword">var</span> strResult = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">while</span> (strResult.length &lt; l)
      strResult += (((<span class="hljs-number">1</span> + <span class="hljs-built_in">Math</span>.random() + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()) * <span class="hljs-number">0x10000</span>) | <span class="hljs-number">0</span>).toString(<span class="hljs-number">16</span>).substring(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> strResult.substr(<span class="hljs-number">0</span>, l);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ngObjectIndexOf</span>(<span class="hljs-params">arr, obj</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = arr.length; i &lt; len; i++)
      <span class="hljs-keyword">if</span> (angular.equals(arr[i], obj))
        <span class="hljs-keyword">return</span> i;
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
  }
  <span class="hljs-keyword">var</span> detectedApi,
    apis = [{
      <span class="hljs-attr">eventName</span>: <span class="hljs-string">'visibilitychange'</span>,
      <span class="hljs-attr">propertyName</span>: <span class="hljs-string">'hidden'</span>
    }, {
      <span class="hljs-attr">eventName</span>: <span class="hljs-string">'mozvisibilitychange'</span>,
      <span class="hljs-attr">propertyName</span>: <span class="hljs-string">'mozHidden'</span>
    }, {
      <span class="hljs-attr">eventName</span>: <span class="hljs-string">'msvisibilitychange'</span>,
      <span class="hljs-attr">propertyName</span>: <span class="hljs-string">'msHidden'</span>
    }, {
      <span class="hljs-attr">eventName</span>: <span class="hljs-string">'webkitvisibilitychange'</span>,
      <span class="hljs-attr">propertyName</span>: <span class="hljs-string">'webkitHidden'</span>
    }];
  apis.some(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">api</span>) </span>{
    <span class="hljs-keyword">if</span> (angular.isDefined($<span class="hljs-built_in">document</span>[<span class="hljs-number">0</span>][api.propertyName])) {
      detectedApi = api;
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
  });
  <span class="hljs-keyword">if</span> (detectedApi)
    $<span class="hljs-built_in">document</span>.on(detectedApi.eventName, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (!$<span class="hljs-built_in">document</span>[<span class="hljs-number">0</span>][detectedApi.propertyName]) {
        makePrimary();
        isVisible = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (!idleTimeout &amp;&amp; !idleTime)
          waitForIdle(<span class="hljs-number">0</span>);
        isVisible = <span class="hljs-literal">false</span>;
      }
    });
  angular.element($<span class="hljs-built_in">window</span>).on({
    <span class="hljs-string">"mouseleave"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
      <span class="hljs-keyword">var</span> destination = angular.isUndefined(e.toElement) ? e.relatedTarget : e.toElement;
      <span class="hljs-keyword">if</span> (destination === <span class="hljs-literal">null</span> &amp;&amp; $<span class="hljs-built_in">document</span>[<span class="hljs-number">0</span>].hasFocus()) {
        waitForIdle(<span class="hljs-number">0</span>);
      }
    },
    <span class="hljs-string">"storage"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
      <span class="hljs-keyword">if</span> (e.originalEvent.key !== storageKey)
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> ($<span class="hljs-built_in">window</span>.localStorage.getItem(storageKey) !== $<span class="hljs-built_in">window</span>.tabGUID)
        makeSecondary();
    }
  });

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForIdle</span>(<span class="hljs-params">index, delayOffset</span>) </span>{
    <span class="hljs-keyword">var</span> callback = callbacks[<span class="hljs-string">'activity.idle'</span>][index];
    <span class="hljs-keyword">var</span> numCallbacks = callbacks[<span class="hljs-string">'activity.idle'</span>].length;
    delayOffset = delayOffset || callback.delay;
    angular.element($<span class="hljs-built_in">window</span>).off(getActiveEvents());
    angular.element($<span class="hljs-built_in">window</span>).one(getActiveEvents(), setActive);
    <span class="hljs-keyword">if</span> (index &gt;= numCallbacks)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (idleTimeout)
      $timeout.cancel(idleTimeout);
    idleTimeout = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      idleTime = callback.delay;
      callback.cb();
      $timeout.cancel(idleTimeout);
      idleTimeout = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
      angular.element($<span class="hljs-built_in">window</span>).off(getActiveEvents());
      angular.element($<span class="hljs-built_in">window</span>).one(getActiveEvents(), setActive);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = index + <span class="hljs-number">1</span>; i &lt; numCallbacks; i++) {
        <span class="hljs-keyword">var</span> nextDelay = callbacks[<span class="hljs-string">'activity.idle'</span>][i].delay;
        <span class="hljs-keyword">if</span> (nextDelay &lt;= callback.delay)
          callbacks[<span class="hljs-string">'activity.idle'</span>][i].cb();
        <span class="hljs-keyword">else</span> {
          waitForIdle(i, nextDelay - callback.delay);
          <span class="hljs-keyword">break</span>;
        }
      }
    }, delayOffset, <span class="hljs-literal">false</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setActive</span>(<span class="hljs-params"></span>) </span>{
    angular.element($<span class="hljs-built_in">window</span>).off(getActiveEvents());
    <span class="hljs-keyword">if</span> (idleTimeout) {
      $timeout.cancel(idleTimeout);
      idleTimeout = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
    }
    <span class="hljs-keyword">var</span> activeCallbacks = callbacks[<span class="hljs-string">'activity.active'</span>];
    activeCallbacks.some(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
      <span class="hljs-keyword">if</span> (callback.delay &lt;= idleTime)
        callback.cb();
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    });
    idleTime = <span class="hljs-number">0</span>;
    makePrimary();
    <span class="hljs-keyword">if</span> (pageIdleTimeout) {
      $timeout.cancel(pageIdleTimeout);
      pageIdleTimeout = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
    }
    <span class="hljs-keyword">var</span> minDelay = callbacks[<span class="hljs-string">'activity.idle'</span>][<span class="hljs-number">0</span>].delay;
    hasActed = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (!pageIdleTimeout)
      pageIdleTimeout = $timeout(pageIdleHandler, minDelay, <span class="hljs-literal">false</span>);
    listenForActivity();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pageIdleHandler</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (idleTimeout)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> minDelay = callbacks[<span class="hljs-string">'activity.idle'</span>][<span class="hljs-number">0</span>].delay;
    <span class="hljs-keyword">if</span> (hasActed) {
      hasActed = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (pageIdleTimeout)
        $timeout.cancel(pageIdleTimeout);
      pageIdleTimeout = $timeout(pageIdleHandler, minDelay, <span class="hljs-literal">false</span>);
      listenForActivity();
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> delayOffset = minDelay;
    <span class="hljs-keyword">if</span> (callbacks[<span class="hljs-string">'activity.idle'</span>].length &gt; <span class="hljs-number">1</span>)
      delayOffset = callbacks[<span class="hljs-string">'activity.idle'</span>][<span class="hljs-number">1</span>].delay - minDelay;
    idleTime = minDelay;
    callbacks[<span class="hljs-string">'activity.idle'</span>][<span class="hljs-number">0</span>].cb();
    waitForIdle(<span class="hljs-number">1</span>, delayOffset);
    pageIdleTimeout = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listenForActivity</span>(<span class="hljs-params"></span>) </span>{
    angular.element($<span class="hljs-built_in">window</span>).off(getActiveEvents());
    angular.element($<span class="hljs-built_in">window</span>).one(getActiveEvents(), onActivity);
    angular.element(<span class="hljs-string">"#gsft_main"</span>).on(<span class="hljs-string">"load.snTabActivity"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> src = angular.element(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'src'</span>);
      <span class="hljs-keyword">if</span> (src.indexOf(<span class="hljs-string">"/"</span>) == <span class="hljs-number">0</span> || src.indexOf($<span class="hljs-built_in">window</span>.location.origin) == <span class="hljs-number">0</span> || src.indexOf(<span class="hljs-string">'http'</span>) == <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">var</span> iframeWindow = <span class="hljs-keyword">this</span>.contentWindow ? <span class="hljs-keyword">this</span>.contentWindow : <span class="hljs-keyword">this</span>.contentDocument.defaultView;
        angular.element(iframeWindow).off(getActiveEvents());
        angular.element(iframeWindow).one(getActiveEvents(), onActivity);
      }
    });
    angular.element(<span class="hljs-string">'iframe'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">idx, iframe</span>) </span>{
      <span class="hljs-keyword">var</span> src = angular.element(iframe).attr(<span class="hljs-string">'src'</span>);
      <span class="hljs-keyword">if</span> (!src)
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (src.indexOf(<span class="hljs-string">"/"</span>) == <span class="hljs-number">0</span> || src.indexOf($<span class="hljs-built_in">window</span>.location.origin) == <span class="hljs-number">0</span> || src.indexOf(<span class="hljs-string">'http'</span>) == <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">var</span> iframeWindow = iframe.contentWindow ? iframe.contentWindow : iframe.contentDocument.defaultView;
        angular.element(iframeWindow).off(getActiveEvents());
        angular.element(iframeWindow).one(getActiveEvents(), onActivity);
      }
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onActivity</span>(<span class="hljs-params"></span>) </span>{
    hasActed = <span class="hljs-literal">true</span>;
    makePrimary();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makePrimary</span>(<span class="hljs-params">initial</span>) </span>{
    <span class="hljs-keyword">var</span> oldGuid = $<span class="hljs-built_in">window</span>.localStorage.getItem(storageKey);
    isPrimary = <span class="hljs-literal">true</span>;
    isVisible = <span class="hljs-literal">true</span>;
    $timeout.cancel(idleTimeout);
    idleTimeout = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (canUseStorage() &amp;&amp; oldGuid !== $<span class="hljs-built_in">window</span>.tabGUID &amp;&amp; !initial)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = callbacks[<span class="hljs-string">"tab.primary"</span>].length; i &lt; len; i++)
        callbacks[<span class="hljs-string">"tab.primary"</span>][i].cb();
    <span class="hljs-keyword">try</span> {
      $<span class="hljs-built_in">window</span>.localStorage.setItem(storageKey, $<span class="hljs-built_in">window</span>.tabGUID);
    } <span class="hljs-keyword">catch</span> (ignored) {}
    <span class="hljs-keyword">if</span> (idleTime &amp;&amp; $<span class="hljs-built_in">document</span>[<span class="hljs-number">0</span>].hasFocus())
      setActive();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeSecondary</span>(<span class="hljs-params"></span>) </span>{
    isPrimary = <span class="hljs-literal">false</span>;
    isVisible = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = callbacks[<span class="hljs-string">"tab.secondary"</span>].length; i &lt; len; i++)
      callbacks[<span class="hljs-string">"tab.secondary"</span>][i].cb();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerCallback</span>(<span class="hljs-params">event, callback, scope</span>) </span>{
    <span class="hljs-keyword">var</span> cbObject = angular.isObject(callback) ? callback : {
      <span class="hljs-attr">delay</span>: defaultIdle,
      <span class="hljs-attr">cb</span>: callback
    };
    <span class="hljs-keyword">if</span> (callbacks[event]) {
      callbacks[event].push(cbObject);
      callbacks[event].sort(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
        <span class="hljs-keyword">return</span> a.delay - b.delay;
      })
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroyCallback</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (callbacks[event]) {
        <span class="hljs-keyword">var</span> pos = ngObjectIndexOf(callbacks[event], cbObject);
        <span class="hljs-keyword">if</span> (pos !== <span class="hljs-number">-1</span>)
          callbacks[event].splice(pos, <span class="hljs-number">1</span>);
      }
    }
    <span class="hljs-keyword">if</span> (scope)
      scope.$on(<span class="hljs-string">"$destroy"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        destroyCallback();
      });
    <span class="hljs-keyword">return</span> destroyCallback;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerIdleCallback</span>(<span class="hljs-params">options, onIdle, onReturn, scope</span>) </span>{
    <span class="hljs-keyword">var</span> delay = options,
      onIdleDestroy,
      onReturnDestroy;
    <span class="hljs-keyword">if</span> (angular.isObject(options)) {
      delay = options.delay;
      onIdle = options.onIdle || onIdle;
      onReturn = options.onReturn || onReturn;
      scope = options.scope || scope;
    }
    <span class="hljs-keyword">if</span> (angular.isFunction(onIdle))
      onIdleDestroy = registerCallback(<span class="hljs-string">"activity.idle"</span>, {
        <span class="hljs-attr">delay</span>: delay,
        <span class="hljs-attr">cb</span>: onIdle
      });
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (angular.isFunction(onReturn)) {
      onIdleDestroy = registerCallback(<span class="hljs-string">"activity.idle"</span>, {
        <span class="hljs-attr">delay</span>: delay,
        <span class="hljs-attr">cb</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{}
      });
    }
    <span class="hljs-keyword">if</span> (angular.isFunction(onReturn))
      onReturnDestroy = registerCallback(<span class="hljs-string">"activity.active"</span>, {
        <span class="hljs-attr">delay</span>: delay,
        <span class="hljs-attr">cb</span>: onReturn
      });

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroyAll</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (angular.isFunction(onIdleDestroy))
        onIdleDestroy();
      <span class="hljs-keyword">if</span> (angular.isFunction(onReturnDestroy))
        onReturnDestroy();
    }
    <span class="hljs-keyword">if</span> (scope)
      scope.$on(<span class="hljs-string">"$destroy"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        destroyAll();
      });
    <span class="hljs-keyword">return</span> destroyAll;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canUseStorage</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> canWe = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">try</span> {
      $<span class="hljs-built_in">window</span>.localStorage.setItem(storageKey, $<span class="hljs-built_in">window</span>.tabGUID);
      canWe = <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">catch</span> (ignored) {}
    <span class="hljs-keyword">return</span> canWe;
  }
  makePrimary(<span class="hljs-literal">true</span>);
  listenForActivity();
  pageIdleTimeout = $timeout(pageIdleHandler, defaultIdle, <span class="hljs-literal">false</span>);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">on</span>: registerCallback,
    <span class="hljs-attr">onIdle</span>: registerIdleCallback,
    <span class="hljs-attr">setAppName</span>: setAppName,
    get isPrimary() {
      <span class="hljs-keyword">return</span> isPrimary;
    },
    get isIdle() {
      <span class="hljs-keyword">return</span> idleTime &gt; <span class="hljs-number">0</span>;
    },
    get idleTime() {
      <span class="hljs-keyword">return</span> idleTime;
    },
    get isVisible() {
      <span class="hljs-keyword">return</span> isVisible;
    },
    get appName() {
      <span class="hljs-keyword">return</span> appName;
    },
    get defaultIdleTime() {
      <span class="hljs-keyword">return</span> defaultIdle
    },
    <span class="hljs-attr">isActive</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.idleTime &lt; <span class="hljs-keyword">this</span>.defaultIdleTime &amp;&amp; <span class="hljs-keyword">this</span>.isVisible;
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/factory.ArraySynchronizer.js */</span>
angular.module(<span class="hljs-string">"sn.common.util"</span>).factory(<span class="hljs-string">"ArraySynchronizer"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  'use strict'</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ArraySynchronizer</span>(<span class="hljs-params"></span>) </span>{}

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params">key, arr</span>) </span>{
    <span class="hljs-keyword">var</span> result = {};
    <span class="hljs-keyword">var</span> keys = [];
    result.orderedKeys = keys;
    angular.forEach(arr, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
      <span class="hljs-keyword">var</span> keyValue = item[key];
      result[keyValue] = item;
      keys.push(keyValue);
    });
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sortByKeyAndModel</span>(<span class="hljs-params">arr, key, model</span>) </span>{
    arr.sort(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
      <span class="hljs-keyword">var</span> aIndex = model.indexOf(a[key]);
      <span class="hljs-keyword">var</span> bIndex = model.indexOf(b[key]);
      <span class="hljs-keyword">if</span> (aIndex &gt; bIndex)
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (aIndex &lt; bIndex)
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    });
  }
  ArraySynchronizer.prototype = {
    <span class="hljs-attr">add</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">syncField, dest, source, end</span>) </span>{
      end = end || <span class="hljs-string">"bottom"</span>;
      <span class="hljs-keyword">var</span> destIndex = index(syncField, dest);
      <span class="hljs-keyword">var</span> sourceIndex = index(syncField, source);
      angular.forEach(sourceIndex.orderedKeys, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>) </span>{
        <span class="hljs-keyword">if</span> (destIndex.orderedKeys.indexOf(key) === <span class="hljs-number">-1</span>) {
          <span class="hljs-keyword">if</span> (end === <span class="hljs-string">"bottom"</span>) {
            dest.push(sourceIndex[key]);
          } <span class="hljs-keyword">else</span> {
            dest.unshift(sourceIndex[key]);
          }
        }
      });
    },
    <span class="hljs-attr">synchronize</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">syncField, dest, source, deepKeySyncArray</span>) </span>{
      <span class="hljs-keyword">var</span> destIndex = index(syncField, dest);
      <span class="hljs-keyword">var</span> sourceIndex = index(syncField, source);
      deepKeySyncArray = (<span class="hljs-keyword">typeof</span> deepKeySyncArray === <span class="hljs-string">"undefined"</span>) ? [] : deepKeySyncArray;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = destIndex.orderedKeys.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
        <span class="hljs-keyword">var</span> key = destIndex.orderedKeys[i];
        <span class="hljs-keyword">if</span> (sourceIndex.orderedKeys.indexOf(key) === <span class="hljs-number">-1</span>) {
          destIndex.orderedKeys.splice(i, <span class="hljs-number">1</span>);
          dest.splice(i, <span class="hljs-number">1</span>);
        }
        <span class="hljs-keyword">if</span> (deepKeySyncArray.length &gt; <span class="hljs-number">0</span>) {
          angular.forEach(deepKeySyncArray, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">deepKey</span>) </span>{
            <span class="hljs-keyword">if</span> (sourceIndex[key] &amp;&amp; destIndex[key][deepKey] !== sourceIndex[key][deepKey]) {
              destIndex[key][deepKey] = sourceIndex[key][deepKey];
            }
          });
        }
      }
      angular.forEach(sourceIndex.orderedKeys, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>) </span>{
        <span class="hljs-keyword">if</span> (destIndex.orderedKeys.indexOf(key) === <span class="hljs-number">-1</span>)
          dest.push(sourceIndex[key]);
      });
      sortByKeyAndModel(dest, syncField, sourceIndex.orderedKeys);
    }
  };
  <span class="hljs-keyword">return</span> ArraySynchronizer;
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/directive.snBindOnce.js */</span>
angular.module(<span class="hljs-string">"sn.common.util"</span>).directive(<span class="hljs-string">"snBindOnce"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$sanitize</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">"A"</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs</span>) </span>{
      <span class="hljs-keyword">var</span> value = scope.$<span class="hljs-built_in">eval</span>(attrs.snBindOnce);
      <span class="hljs-keyword">var</span> sanitizedValue = $sanitize(value);
      element.append(sanitizedValue);
    }
  }
});
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/directive.snCloak.js */</span>
angular.module(<span class="hljs-string">"sn.common.util"</span>).directive(<span class="hljs-string">"snCloak"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">"A"</span>,
    <span class="hljs-attr">compile</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element, attr</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        attr.$set(<span class="hljs-string">'snCloak'</span>, <span class="hljs-literal">undefined</span>);
        element.removeClass(<span class="hljs-string">'sn-cloak'</span>);
      }
    }
  };
});
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/service.md5.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>).factory(<span class="hljs-string">'md5'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">var</span> md5cycle = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, k</span>) </span>{
    <span class="hljs-keyword">var</span> a = x[<span class="hljs-number">0</span>],
      b = x[<span class="hljs-number">1</span>],
      c = x[<span class="hljs-number">2</span>],
      d = x[<span class="hljs-number">3</span>];
    a = ff(a, b, c, d, k[<span class="hljs-number">0</span>], <span class="hljs-number">7</span>, <span class="hljs-number">-680876936</span>);
    d = ff(d, a, b, c, k[<span class="hljs-number">1</span>], <span class="hljs-number">12</span>, <span class="hljs-number">-389564586</span>);
    c = ff(c, d, a, b, k[<span class="hljs-number">2</span>], <span class="hljs-number">17</span>, <span class="hljs-number">606105819</span>);
    b = ff(b, c, d, a, k[<span class="hljs-number">3</span>], <span class="hljs-number">22</span>, <span class="hljs-number">-1044525330</span>);
    a = ff(a, b, c, d, k[<span class="hljs-number">4</span>], <span class="hljs-number">7</span>, <span class="hljs-number">-176418897</span>);
    d = ff(d, a, b, c, k[<span class="hljs-number">5</span>], <span class="hljs-number">12</span>, <span class="hljs-number">1200080426</span>);
    c = ff(c, d, a, b, k[<span class="hljs-number">6</span>], <span class="hljs-number">17</span>, <span class="hljs-number">-1473231341</span>);
    b = ff(b, c, d, a, k[<span class="hljs-number">7</span>], <span class="hljs-number">22</span>, <span class="hljs-number">-45705983</span>);
    a = ff(a, b, c, d, k[<span class="hljs-number">8</span>], <span class="hljs-number">7</span>, <span class="hljs-number">1770035416</span>);
    d = ff(d, a, b, c, k[<span class="hljs-number">9</span>], <span class="hljs-number">12</span>, <span class="hljs-number">-1958414417</span>);
    c = ff(c, d, a, b, k[<span class="hljs-number">10</span>], <span class="hljs-number">17</span>, <span class="hljs-number">-42063</span>);
    b = ff(b, c, d, a, k[<span class="hljs-number">11</span>], <span class="hljs-number">22</span>, <span class="hljs-number">-1990404162</span>);
    a = ff(a, b, c, d, k[<span class="hljs-number">12</span>], <span class="hljs-number">7</span>, <span class="hljs-number">1804603682</span>);
    d = ff(d, a, b, c, k[<span class="hljs-number">13</span>], <span class="hljs-number">12</span>, <span class="hljs-number">-40341101</span>);
    c = ff(c, d, a, b, k[<span class="hljs-number">14</span>], <span class="hljs-number">17</span>, <span class="hljs-number">-1502002290</span>);
    b = ff(b, c, d, a, k[<span class="hljs-number">15</span>], <span class="hljs-number">22</span>, <span class="hljs-number">1236535329</span>);
    a = gg(a, b, c, d, k[<span class="hljs-number">1</span>], <span class="hljs-number">5</span>, <span class="hljs-number">-165796510</span>);
    d = gg(d, a, b, c, k[<span class="hljs-number">6</span>], <span class="hljs-number">9</span>, <span class="hljs-number">-1069501632</span>);
    c = gg(c, d, a, b, k[<span class="hljs-number">11</span>], <span class="hljs-number">14</span>, <span class="hljs-number">643717713</span>);
    b = gg(b, c, d, a, k[<span class="hljs-number">0</span>], <span class="hljs-number">20</span>, <span class="hljs-number">-373897302</span>);
    a = gg(a, b, c, d, k[<span class="hljs-number">5</span>], <span class="hljs-number">5</span>, <span class="hljs-number">-701558691</span>);
    d = gg(d, a, b, c, k[<span class="hljs-number">10</span>], <span class="hljs-number">9</span>, <span class="hljs-number">38016083</span>);
    c = gg(c, d, a, b, k[<span class="hljs-number">15</span>], <span class="hljs-number">14</span>, <span class="hljs-number">-660478335</span>);
    b = gg(b, c, d, a, k[<span class="hljs-number">4</span>], <span class="hljs-number">20</span>, <span class="hljs-number">-405537848</span>);
    a = gg(a, b, c, d, k[<span class="hljs-number">9</span>], <span class="hljs-number">5</span>, <span class="hljs-number">568446438</span>);
    d = gg(d, a, b, c, k[<span class="hljs-number">14</span>], <span class="hljs-number">9</span>, <span class="hljs-number">-1019803690</span>);
    c = gg(c, d, a, b, k[<span class="hljs-number">3</span>], <span class="hljs-number">14</span>, <span class="hljs-number">-187363961</span>);
    b = gg(b, c, d, a, k[<span class="hljs-number">8</span>], <span class="hljs-number">20</span>, <span class="hljs-number">1163531501</span>);
    a = gg(a, b, c, d, k[<span class="hljs-number">13</span>], <span class="hljs-number">5</span>, <span class="hljs-number">-1444681467</span>);
    d = gg(d, a, b, c, k[<span class="hljs-number">2</span>], <span class="hljs-number">9</span>, <span class="hljs-number">-51403784</span>);
    c = gg(c, d, a, b, k[<span class="hljs-number">7</span>], <span class="hljs-number">14</span>, <span class="hljs-number">1735328473</span>);
    b = gg(b, c, d, a, k[<span class="hljs-number">12</span>], <span class="hljs-number">20</span>, <span class="hljs-number">-1926607734</span>);
    a = hh(a, b, c, d, k[<span class="hljs-number">5</span>], <span class="hljs-number">4</span>, <span class="hljs-number">-378558</span>);
    d = hh(d, a, b, c, k[<span class="hljs-number">8</span>], <span class="hljs-number">11</span>, <span class="hljs-number">-2022574463</span>);
    c = hh(c, d, a, b, k[<span class="hljs-number">11</span>], <span class="hljs-number">16</span>, <span class="hljs-number">1839030562</span>);
    b = hh(b, c, d, a, k[<span class="hljs-number">14</span>], <span class="hljs-number">23</span>, <span class="hljs-number">-35309556</span>);
    a = hh(a, b, c, d, k[<span class="hljs-number">1</span>], <span class="hljs-number">4</span>, <span class="hljs-number">-1530992060</span>);
    d = hh(d, a, b, c, k[<span class="hljs-number">4</span>], <span class="hljs-number">11</span>, <span class="hljs-number">1272893353</span>);
    c = hh(c, d, a, b, k[<span class="hljs-number">7</span>], <span class="hljs-number">16</span>, <span class="hljs-number">-155497632</span>);
    b = hh(b, c, d, a, k[<span class="hljs-number">10</span>], <span class="hljs-number">23</span>, <span class="hljs-number">-1094730640</span>);
    a = hh(a, b, c, d, k[<span class="hljs-number">13</span>], <span class="hljs-number">4</span>, <span class="hljs-number">681279174</span>);
    d = hh(d, a, b, c, k[<span class="hljs-number">0</span>], <span class="hljs-number">11</span>, <span class="hljs-number">-358537222</span>);
    c = hh(c, d, a, b, k[<span class="hljs-number">3</span>], <span class="hljs-number">16</span>, <span class="hljs-number">-722521979</span>);
    b = hh(b, c, d, a, k[<span class="hljs-number">6</span>], <span class="hljs-number">23</span>, <span class="hljs-number">76029189</span>);
    a = hh(a, b, c, d, k[<span class="hljs-number">9</span>], <span class="hljs-number">4</span>, <span class="hljs-number">-640364487</span>);
    d = hh(d, a, b, c, k[<span class="hljs-number">12</span>], <span class="hljs-number">11</span>, <span class="hljs-number">-421815835</span>);
    c = hh(c, d, a, b, k[<span class="hljs-number">15</span>], <span class="hljs-number">16</span>, <span class="hljs-number">530742520</span>);
    b = hh(b, c, d, a, k[<span class="hljs-number">2</span>], <span class="hljs-number">23</span>, <span class="hljs-number">-995338651</span>);
    a = ii(a, b, c, d, k[<span class="hljs-number">0</span>], <span class="hljs-number">6</span>, <span class="hljs-number">-198630844</span>);
    d = ii(d, a, b, c, k[<span class="hljs-number">7</span>], <span class="hljs-number">10</span>, <span class="hljs-number">1126891415</span>);
    c = ii(c, d, a, b, k[<span class="hljs-number">14</span>], <span class="hljs-number">15</span>, <span class="hljs-number">-1416354905</span>);
    b = ii(b, c, d, a, k[<span class="hljs-number">5</span>], <span class="hljs-number">21</span>, <span class="hljs-number">-57434055</span>);
    a = ii(a, b, c, d, k[<span class="hljs-number">12</span>], <span class="hljs-number">6</span>, <span class="hljs-number">1700485571</span>);
    d = ii(d, a, b, c, k[<span class="hljs-number">3</span>], <span class="hljs-number">10</span>, <span class="hljs-number">-1894986606</span>);
    c = ii(c, d, a, b, k[<span class="hljs-number">10</span>], <span class="hljs-number">15</span>, <span class="hljs-number">-1051523</span>);
    b = ii(b, c, d, a, k[<span class="hljs-number">1</span>], <span class="hljs-number">21</span>, <span class="hljs-number">-2054922799</span>);
    a = ii(a, b, c, d, k[<span class="hljs-number">8</span>], <span class="hljs-number">6</span>, <span class="hljs-number">1873313359</span>);
    d = ii(d, a, b, c, k[<span class="hljs-number">15</span>], <span class="hljs-number">10</span>, <span class="hljs-number">-30611744</span>);
    c = ii(c, d, a, b, k[<span class="hljs-number">6</span>], <span class="hljs-number">15</span>, <span class="hljs-number">-1560198380</span>);
    b = ii(b, c, d, a, k[<span class="hljs-number">13</span>], <span class="hljs-number">21</span>, <span class="hljs-number">1309151649</span>);
    a = ii(a, b, c, d, k[<span class="hljs-number">4</span>], <span class="hljs-number">6</span>, <span class="hljs-number">-145523070</span>);
    d = ii(d, a, b, c, k[<span class="hljs-number">11</span>], <span class="hljs-number">10</span>, <span class="hljs-number">-1120210379</span>);
    c = ii(c, d, a, b, k[<span class="hljs-number">2</span>], <span class="hljs-number">15</span>, <span class="hljs-number">718787259</span>);
    b = ii(b, c, d, a, k[<span class="hljs-number">9</span>], <span class="hljs-number">21</span>, <span class="hljs-number">-343485551</span>);
    x[<span class="hljs-number">0</span>] = add32(a, x[<span class="hljs-number">0</span>]);
    x[<span class="hljs-number">1</span>] = add32(b, x[<span class="hljs-number">1</span>]);
    x[<span class="hljs-number">2</span>] = add32(c, x[<span class="hljs-number">2</span>]);
    x[<span class="hljs-number">3</span>] = add32(d, x[<span class="hljs-number">3</span>]);
  };
  <span class="hljs-keyword">var</span> cmn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">q, a, b, x, s, t</span>) </span>{
    a = add32(add32(a, q), add32(x, t));
    <span class="hljs-keyword">return</span> add32((a &lt;&lt; s) | (a &gt;&gt;&gt; (<span class="hljs-number">32</span> - s)), b);
  };
  <span class="hljs-keyword">var</span> ff = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b, c, d, x, s, t</span>) </span>{
    <span class="hljs-keyword">return</span> cmn((b &amp; c) | ((~b) &amp; d), a, b, x, s, t);
  };
  <span class="hljs-keyword">var</span> gg = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b, c, d, x, s, t</span>) </span>{
    <span class="hljs-keyword">return</span> cmn((b &amp; d) | (c &amp; (~d)), a, b, x, s, t);
  };
  <span class="hljs-keyword">var</span> hh = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b, c, d, x, s, t</span>) </span>{
    <span class="hljs-keyword">return</span> cmn(b ^ c ^ d, a, b, x, s, t);
  };
  <span class="hljs-keyword">var</span> ii = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b, c, d, x, s, t</span>) </span>{
    <span class="hljs-keyword">return</span> cmn(c ^ (b | (~d)), a, b, x, s, t);
  };
  <span class="hljs-keyword">var</span> md51 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) </span>{
    <span class="hljs-keyword">var</span> txt = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">var</span> n = s.length,
      state = [<span class="hljs-number">1732584193</span>, <span class="hljs-number">-271733879</span>, <span class="hljs-number">-1732584194</span>, <span class="hljs-number">271733878</span>],
      i;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">64</span>; i &lt;= s.length; i += <span class="hljs-number">64</span>) {
      md5cycle(state, md5blk(s.substring(i - <span class="hljs-number">64</span>, i)));
    }
    s = s.substring(i - <span class="hljs-number">64</span>);
    <span class="hljs-keyword">var</span> tail = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>];
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; s.length; i++)
      tail[i &gt;&gt; <span class="hljs-number">2</span>] |= s.charCodeAt(i) &lt;&lt; ((i % <span class="hljs-number">4</span>) &lt;&lt; <span class="hljs-number">3</span>);
    tail[i &gt;&gt; <span class="hljs-number">2</span>] |= <span class="hljs-number">0x80</span> &lt;&lt; ((i % <span class="hljs-number">4</span>) &lt;&lt; <span class="hljs-number">3</span>);
    <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">55</span>) {
      md5cycle(state, tail);
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++) tail[i] = <span class="hljs-number">0</span>;
    }
    tail[<span class="hljs-number">14</span>] = n * <span class="hljs-number">8</span>;
    md5cycle(state, tail);
    <span class="hljs-keyword">return</span> state;
  };
  <span class="hljs-keyword">var</span> md5blk = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) </span>{
    <span class="hljs-keyword">var</span> md5blks = [],
      i;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">64</span>; i += <span class="hljs-number">4</span>) {
      md5blks[i &gt;&gt; <span class="hljs-number">2</span>] = s.charCodeAt(i) +
        (s.charCodeAt(i + <span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-number">8</span>) +
        (s.charCodeAt(i + <span class="hljs-number">2</span>) &lt;&lt; <span class="hljs-number">16</span>) +
        (s.charCodeAt(i + <span class="hljs-number">3</span>) &lt;&lt; <span class="hljs-number">24</span>);
    }
    <span class="hljs-keyword">return</span> md5blks;
  };
  <span class="hljs-keyword">var</span> hex_chr = <span class="hljs-string">'0123456789abcdef'</span>.split(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">var</span> rhex = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>) </span>{
    <span class="hljs-keyword">var</span> s = <span class="hljs-string">''</span>,
      j = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (; j &lt; <span class="hljs-number">4</span>; j++)
      s += hex_chr[(n &gt;&gt; (j * <span class="hljs-number">8</span> + <span class="hljs-number">4</span>)) &amp; <span class="hljs-number">0x0F</span>] +
      hex_chr[(n &gt;&gt; (j * <span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0x0F</span>];
    <span class="hljs-keyword">return</span> s;
  };
  <span class="hljs-keyword">var</span> hex = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; x.length; i++)
      x[i] = rhex(x[i]);
    <span class="hljs-keyword">return</span> x.join(<span class="hljs-string">''</span>);
  };
  <span class="hljs-keyword">var</span> add32 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
    <span class="hljs-keyword">return</span> (a + b) &amp; <span class="hljs-number">0xFFFFFFFF</span>;
  };
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) </span>{
    <span class="hljs-keyword">return</span> hex(md51(s));
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/service.priorityQueue.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>).factory(<span class="hljs-string">'priorityQueue'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">comparator</span>) </span>{
    <span class="hljs-keyword">var</span> items = [];
    <span class="hljs-keyword">var</span> compare = comparator || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
      <span class="hljs-keyword">return</span> a - b;
    };
    <span class="hljs-keyword">var</span> swap = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
      <span class="hljs-keyword">var</span> temp = items[a];
      items[a] = items[b];
      items[b] = temp;
    };
    <span class="hljs-keyword">var</span> bubbleUp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pos</span>) </span>{
      <span class="hljs-keyword">var</span> parent;
      <span class="hljs-keyword">while</span> (pos &gt; <span class="hljs-number">0</span>) {
        parent = (pos - <span class="hljs-number">1</span>) &gt;&gt; <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (compare(items[pos], items[parent]) &gt;= <span class="hljs-number">0</span>)
          <span class="hljs-keyword">break</span>;
        swap(parent, pos);
        pos = parent;
      }
    };
    <span class="hljs-keyword">var</span> bubbleDown = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pos</span>) </span>{
      <span class="hljs-keyword">var</span> left, right, min, last = items.length - <span class="hljs-number">1</span>;
      <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        left = (pos &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;
        right = left + <span class="hljs-number">1</span>;
        min = pos;
        <span class="hljs-keyword">if</span> (left &lt;= last &amp;&amp; compare(items[left], items[min]) &lt; <span class="hljs-number">0</span>)
          min = left;
        <span class="hljs-keyword">if</span> (right &lt;= last &amp;&amp; compare(items[right], items[min]) &lt; <span class="hljs-number">0</span>)
          min = right;
        <span class="hljs-keyword">if</span> (min === pos)
          <span class="hljs-keyword">break</span>;
        swap(min, pos);
        pos = min;
      }
    };
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">add</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
        items.push(item);
        bubbleUp(items.length - <span class="hljs-number">1</span>);
      },
      <span class="hljs-attr">poll</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> first = items[<span class="hljs-number">0</span>],
          last = items.pop();
        <span class="hljs-keyword">if</span> (items.length &gt; <span class="hljs-number">0</span>) {
          items[<span class="hljs-number">0</span>] = last;
          bubbleDown(<span class="hljs-number">0</span>);
        }
        <span class="hljs-keyword">return</span> first;
      },
      <span class="hljs-attr">peek</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> items[<span class="hljs-number">0</span>];
      },
      <span class="hljs-attr">clear</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        items = [];
      },
      <span class="hljs-attr">inspect</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> angular.toJson(items, <span class="hljs-literal">true</span>);
      },
      get size() {
        <span class="hljs-keyword">return</span> items.length;
      },
      get all() {
        <span class="hljs-keyword">return</span> items;
      },
      set comparator(fn) {
        compare = fn;
      }
    };
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/service.snResource.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>).factory(<span class="hljs-string">'snResource'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$http, $q, priorityQueue, md5</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">var</span> methods = [<span class="hljs-string">'get'</span>, <span class="hljs-string">'post'</span>, <span class="hljs-string">'put'</span>, <span class="hljs-string">'patch'</span>, <span class="hljs-string">'delete'</span>, <span class="hljs-string">'head'</span>, <span class="hljs-string">'options'</span>, <span class="hljs-string">'jsonp'</span>, <span class="hljs-string">'trace'</span>],
    queue = priorityQueue(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
      <span class="hljs-keyword">return</span> a.timestamp - b.timestamp;
    }),
    resource = {},
    pendingRequests = [],
    inFlightRequests = [];
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> requestInterceptors = $http.defaults.transformRequest,
      responseInterceptors = $http.defaults.transformResponse;
    <span class="hljs-keyword">var</span> next = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> request = queue.peek();
      pendingRequests.shift();
      inFlightRequests.push(request.hash);
      $http(request.config).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
        request.deferred.resolve(response);
      }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reason</span>) </span>{
        request.deferred.reject(reason);
      }).finally(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        queue.poll();
        inFlightRequests.shift();
        <span class="hljs-keyword">if</span> (queue.size &gt; <span class="hljs-number">0</span>)
          next();
      });
    };
    angular.forEach(methods, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method</span>) </span>{
      resource[method] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">url, data</span>) </span>{
        <span class="hljs-keyword">var</span> deferredRequest = $q.defer(),
          promise = deferredRequest.promise,
          deferredAbort = $q.defer(),
          config = {
            <span class="hljs-attr">method</span>: method,
            <span class="hljs-attr">url</span>: url,
            <span class="hljs-attr">data</span>: data,
            <span class="hljs-attr">transformRequest</span>: requestInterceptors,
            <span class="hljs-attr">transformResponse</span>: responseInterceptors,
            <span class="hljs-attr">timeout</span>: deferredAbort.promise
          },
          hash = md5(<span class="hljs-built_in">JSON</span>.stringify(config));
        pendingRequests.push(hash);
        queue.add({
          <span class="hljs-attr">config</span>: config,
          <span class="hljs-attr">deferred</span>: deferredRequest,
          <span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">Date</span>.now(),
          <span class="hljs-attr">hash</span>: hash
        });
        <span class="hljs-keyword">if</span> (queue.size === <span class="hljs-number">1</span>)
          next();
        promise.abort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          deferredAbort.resolve(<span class="hljs-string">'Request cancelled'</span>);
        };
        <span class="hljs-keyword">return</span> promise;
      };
    });
    resource.addRequestInterceptor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fn</span>) </span>{
      requestInterceptors = requestInterceptors.concat([fn]);
    };
    resource.addResponseInterceptor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fn</span>) </span>{
      responseInterceptors = responseInterceptors.concat([fn]);
    };
    resource.queueSize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> queue.size;
    };
    resource.queuedRequests = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> queue.all;
    };
    <span class="hljs-keyword">return</span> resource;
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/service.snConnect.js */</span>
angular.module(<span class="hljs-string">"sn.common.util"</span>).service(<span class="hljs-string">"snConnectService"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$http, snCustomEvent</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> connectPaths = [<span class="hljs-string">"/$c.do"</span>, <span class="hljs-string">"/$chat.do"</span>];

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canOpenInFrameset</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.top.NOW.collaborationFrameset;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isInConnect</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> parentPath = getParentPath();
    <span class="hljs-keyword">return</span> connectPaths.some(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path</span>) </span>{
      <span class="hljs-keyword">return</span> parentPath == path;
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getParentPath</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.top.location.pathname;
    } <span class="hljs-keyword">catch</span> (IGNORED) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">openWithProfile</span>(<span class="hljs-params">profile</span>) </span>{
    <span class="hljs-keyword">if</span> (isInConnect() || canOpenInFrameset())
      snCustomEvent.fireTop(<span class="hljs-string">'chat:open_conversation'</span>, profile);
    <span class="hljs-keyword">else</span>
      <span class="hljs-built_in">window</span>.open(<span class="hljs-string">"$c.do#/with/"</span> + profile.sys_id, <span class="hljs-string">"_blank"</span>);
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">openWithProfile</span>: openWithProfile
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/snPolyfill.js */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  polyfill(<span class="hljs-built_in">String</span>.prototype, <span class="hljs-string">'startsWith'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prefix</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.indexOf(prefix) === <span class="hljs-number">0</span>;
  });
  polyfill(<span class="hljs-built_in">String</span>.prototype, <span class="hljs-string">'endsWith'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">suffix</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.indexOf(suffix, <span class="hljs-keyword">this</span>.length - suffix.length) !== <span class="hljs-number">-1</span>;
  });
  polyfill(<span class="hljs-built_in">Number</span>, <span class="hljs-string">'isNaN'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">return</span> value !== value;
  });
  polyfill(<span class="hljs-built_in">window</span>, <span class="hljs-string">'btoa'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">input</span>) </span>{
    <span class="hljs-keyword">var</span> str = <span class="hljs-built_in">String</span>(input);
    <span class="hljs-keyword">var</span> chars = <span class="hljs-string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='</span>;
    <span class="hljs-keyword">for</span> (
      <span class="hljs-keyword">var</span> block, charCode, idx = <span class="hljs-number">0</span>, map = chars, output = <span class="hljs-string">''</span>; str.charAt(idx | <span class="hljs-number">0</span>) || (map = <span class="hljs-string">'='</span>, idx % <span class="hljs-number">1</span>); output += map.charAt(<span class="hljs-number">63</span> &amp; block &gt;&gt; <span class="hljs-number">8</span> - idx % <span class="hljs-number">1</span> * <span class="hljs-number">8</span>)
    ) {
      charCode = str.charCodeAt(idx += <span class="hljs-number">3</span> / <span class="hljs-number">4</span>);
      <span class="hljs-keyword">if</span> (charCode &gt; <span class="hljs-number">0xFF</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidCharacterError(<span class="hljs-string">"'btoa' failed: The string to be encoded contains characters outside of the Latin1 range."</span>);
      }
      block = block &lt;&lt; <span class="hljs-number">8</span> | charCode;
    }
    <span class="hljs-keyword">return</span> output;
  });

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">polyfill</span>(<span class="hljs-params">obj, slot, fn</span>) </span>{
    <span class="hljs-keyword">if</span> (obj[slot] === <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>)) {
      obj[slot] = fn;
    }
  }
  <span class="hljs-built_in">window</span>.console = <span class="hljs-built_in">window</span>.console || {
    <span class="hljs-attr">log</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{}
  };
})();;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/directive.snFocus.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>).directive(<span class="hljs-string">'snFocus'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs</span>) </span>{
    scope.$watch(attrs.snFocus, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
      <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">true</span>)
        <span class="hljs-keyword">return</span>;
      $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        element[<span class="hljs-number">0</span>].focus();
      });
    });
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/directive.snResizeHeight.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>).directive(<span class="hljs-string">'snResizeHeight'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, elem, attrs</span>) </span>{
      <span class="hljs-keyword">var</span> typographyStyles = [
        <span class="hljs-string">'fontFamily'</span>,
        <span class="hljs-string">'fontSize'</span>,
        <span class="hljs-string">'fontWeight'</span>,
        <span class="hljs-string">'fontStyle'</span>,
        <span class="hljs-string">'letterSpacing'</span>,
        <span class="hljs-string">'textTransform'</span>,
        <span class="hljs-string">'wordSpacing'</span>,
        <span class="hljs-string">'textIndent'</span>
      ];
      <span class="hljs-keyword">var</span> maxHeight = <span class="hljs-built_in">parseInt</span>(elem.css(<span class="hljs-string">'max-height'</span>), <span class="hljs-number">10</span>) || <span class="hljs-number">0</span>;
      <span class="hljs-keyword">var</span> offset = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (elem.css(<span class="hljs-string">'box-sizing'</span>) === <span class="hljs-string">'border-box'</span> || elem.css(<span class="hljs-string">'-moz-box-sizing'</span>) === <span class="hljs-string">'border-box'</span> || elem.css(<span class="hljs-string">'-webkit-box-sizing'</span>) === <span class="hljs-string">'border-box'</span>)
        offset = elem.outerHeight() - elem.height();
      <span class="hljs-keyword">var</span> styles = {};
      angular.forEach(typographyStyles, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>) </span>{
        styles[val] = elem.css(val);
      });
      <span class="hljs-keyword">var</span> $clone = angular.element(<span class="hljs-string">'&lt;textarea rows="1" tabindex="-1" style="position:absolute; top:-999px; left:0; right:auto; bottom:auto; border:0; padding: 0; -moz-box-sizing:content-box; -webkit-box-sizing:content-box; box-sizing:content-box; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden; transition:none; -webkit-transition:none; -moz-transition:none;"&gt;&lt;/textarea&gt;'</span>);
      $clone.css(styles);
      $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        angular.element(<span class="hljs-built_in">document</span>.body).append($clone);
        reSize();
      }, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.chrome) {
        <span class="hljs-keyword">var</span> width = elem[<span class="hljs-number">0</span>].style.width;
        elem[<span class="hljs-number">0</span>].style.width = <span class="hljs-string">'0px'</span>;
        <span class="hljs-keyword">var</span> ignore = elem[<span class="hljs-number">0</span>].offsetWidth;
        elem[<span class="hljs-number">0</span>].style.width = width;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reSize</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!setWidth())
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (!elem[<span class="hljs-number">0</span>].value &amp;&amp; attrs[<span class="hljs-string">'placeholder'</span>])
          $clone[<span class="hljs-number">0</span>].value = attrs[<span class="hljs-string">'placeholder'</span>] || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">else</span>
          $clone[<span class="hljs-number">0</span>].value = elem[<span class="hljs-number">0</span>].value;
        $clone[<span class="hljs-number">0</span>].scrollTop = <span class="hljs-number">0</span>;
        $clone[<span class="hljs-number">0</span>].scrollTop = <span class="hljs-number">9e4</span>;
        <span class="hljs-keyword">var</span> newHeight = $clone[<span class="hljs-number">0</span>].scrollTop;
        <span class="hljs-keyword">if</span> (maxHeight &amp;&amp; newHeight &gt; maxHeight) {
          newHeight = maxHeight;
          elem[<span class="hljs-number">0</span>].style.overflow = <span class="hljs-string">"auto"</span>;
        } <span class="hljs-keyword">else</span>
          elem[<span class="hljs-number">0</span>].style.overflow = <span class="hljs-string">"hidden"</span>;
        newHeight += offset;
        elem[<span class="hljs-number">0</span>].style.height = newHeight + <span class="hljs-string">"px"</span>;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setWidth</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> width;
        <span class="hljs-keyword">var</span> style = <span class="hljs-built_in">window</span>.getComputedStyle ? <span class="hljs-built_in">window</span>.getComputedStyle(elem[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>) : <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (style) {
          width = elem[<span class="hljs-number">0</span>].getBoundingClientRect().width;
          <span class="hljs-keyword">if</span> (width === <span class="hljs-number">0</span> || <span class="hljs-keyword">typeof</span> width !== <span class="hljs-string">'number'</span>) {
            <span class="hljs-keyword">if</span> (style.width.length &amp;&amp; style.width[style.width.length - <span class="hljs-number">1</span>] === <span class="hljs-string">'%'</span>) {
              $timeout(reSize, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);
              <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            width = <span class="hljs-built_in">parseInt</span>(style.width, <span class="hljs-number">10</span>);
          }
          angular.forEach([<span class="hljs-string">'paddingLeft'</span>, <span class="hljs-string">'paddingRight'</span>, <span class="hljs-string">'borderLeftWidth'</span>, <span class="hljs-string">'borderRightWidth'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>) </span>{
            width -= <span class="hljs-built_in">parseInt</span>(style[val], <span class="hljs-number">10</span>);
          });
        } <span class="hljs-keyword">else</span> {
          width = <span class="hljs-built_in">Math</span>.max(elem.width(), <span class="hljs-number">0</span>);
        }
        $clone[<span class="hljs-number">0</span>].style.width = width + <span class="hljs-string">'px'</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      scope.$watch(
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> elem[<span class="hljs-number">0</span>].value
        },
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
          <span class="hljs-keyword">if</span> (newValue === oldValue)
            <span class="hljs-keyword">return</span>;
          reSize();
        }
      );
      elem.on(<span class="hljs-string">'input.resize'</span>, reSize);
      <span class="hljs-keyword">if</span> (attrs[<span class="hljs-string">'snResizeHeight'</span>] == <span class="hljs-string">"trim"</span>) {
        elem.on(<span class="hljs-string">'blur'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          elem.val(elem.val().trim());
          reSize();
        });
      }
      scope.$on(<span class="hljs-string">'$destroy'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $clone.remove();
      });
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/directive.snBlurOnEnter.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>).directive(<span class="hljs-string">'snBlurOnEnter'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
    element.bind(<span class="hljs-string">"keydown keypress"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
      <span class="hljs-keyword">if</span> (event.which !== <span class="hljs-number">13</span>)
        <span class="hljs-keyword">return</span>;
      element.blur();
      event.preventDefault();
    });
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/util/directive.snStickyHeaders.js */</span>
angular.module(<span class="hljs-string">'sn.common.util'</span>).directive(<span class="hljs-string">'snStickyHeaders'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs</span>) </span>{
      element.addClass(<span class="hljs-string">'sticky-headers'</span>);
      <span class="hljs-keyword">var</span> containers;
      <span class="hljs-keyword">var</span> scrollContainer = element.find(<span class="hljs-string">'[sn-sticky-scroll-container]'</span>);
      scrollContainer.addClass(<span class="hljs-string">'sticky-scroll-container'</span>);

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshHeaders</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (attrs.snStickyHeaders !== <span class="hljs-string">'false'</span>) {
          angular.forEach(containers, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">container</span>) </span>{
            <span class="hljs-keyword">var</span> stickyContainer = angular.element(container);
            <span class="hljs-keyword">var</span> stickyHeader = stickyContainer.find(<span class="hljs-string">'[sn-sticky-header]'</span>);
            <span class="hljs-keyword">var</span> stickyOffset = stickyContainer.position().top + stickyContainer.outerHeight();
            stickyContainer.addClass(<span class="hljs-string">'sticky-container'</span>);
            <span class="hljs-keyword">if</span> (stickyOffset &lt; stickyContainer.outerHeight() &amp;&amp; stickyOffset &gt; -stickyHeader.outerHeight()) {
              stickyContainer.css(<span class="hljs-string">'padding-top'</span>, stickyHeader.outerHeight());
              stickyHeader.css(<span class="hljs-string">'width'</span>, stickyHeader.outerWidth());
              stickyHeader.removeClass(<span class="hljs-string">'sticky-header-disabled'</span>).addClass(<span class="hljs-string">'sticky-header-enabled'</span>);
            } <span class="hljs-keyword">else</span> {
              stickyContainer.css(<span class="hljs-string">'padding-top'</span>, <span class="hljs-string">''</span>);
              stickyHeader.css(<span class="hljs-string">'width'</span>, <span class="hljs-string">''</span>);
              stickyHeader.removeClass(<span class="hljs-string">'sticky-header-enabled'</span>).addClass(<span class="hljs-string">'sticky-header-disabled'</span>);
            }
          });
        } <span class="hljs-keyword">else</span> {
          element.find(<span class="hljs-string">'[sn-sticky-container]'</span>).removeClass(<span class="hljs-string">'sticky-container'</span>);
          element.find(<span class="hljs-string">'[sn-sticky-container]'</span>).css(<span class="hljs-string">'padding-top'</span>, <span class="hljs-string">''</span>);
          element.find(<span class="hljs-string">'[sn-sticky-header]'</span>).css(<span class="hljs-string">'width'</span>, <span class="hljs-string">''</span>);
          element.find(<span class="hljs-string">'[sn-sticky-header]'</span>).removeClass(<span class="hljs-string">'sticky-header-enabled'</span>).addClass(<span class="hljs-string">'sticky-header-disabled'</span>);
        }
      }
      scope.$watch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        scrollContainer.find(<span class="hljs-string">'[sn-sticky-header]'</span>).addClass(<span class="hljs-string">'sticky-header'</span>);
        containers = element.find(<span class="hljs-string">'[sn-sticky-container]'</span>);
        <span class="hljs-keyword">return</span> attrs.snStickyHeaders;
      }, refreshHeaders);
      scope.$watch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> scrollContainer[<span class="hljs-number">0</span>].scrollHeight;
      }, refreshHeaders);
      scrollContainer.on(<span class="hljs-string">'scroll'</span>, refreshHeaders);
    }
  };
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/js_includes_ui.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui'</span>, [<span class="hljs-string">'sn.common.messaging'</span>]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/popover/js_includes_ui_popover.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/popover/_module.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui.popover'</span>, []);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/popover/directive.snBindPopoverSelection.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui.popover'</span>).directive(<span class="hljs-string">'snBindPopoverSelection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">snCustomEvent</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">"A"</span>,
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $element, $attrs, snCustomEvent</span>) </span>{
      snCustomEvent.observe(<span class="hljs-string">'list.record_select'</span>, recordSelectDataHandler);

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recordSelectDataHandler</span>(<span class="hljs-params">data, event</span>) </span>{
        <span class="hljs-keyword">if</span> (!data || !event)
          <span class="hljs-keyword">return</span>;
        event.stopPropagation();
        <span class="hljs-keyword">var</span> ref = ($scope.field) ? $scope.field.ref : $attrs.ref;
        <span class="hljs-keyword">if</span> (data.ref === ref) {
          <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.g_form) {
            <span class="hljs-keyword">if</span> ($attrs.addOption) {
              addGlideListChoice(<span class="hljs-string">'select_0'</span> + $attrs.ref, data.value, data.displayValue);
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">var</span> fieldValue = <span class="hljs-keyword">typeof</span> $attrs.ref === <span class="hljs-string">'undefined'</span> ? data.ref : $attrs.ref;
              <span class="hljs-built_in">window</span>.g_form._setValue(fieldValue, data.value, data.displayValue);
              clearDerivedFields(data.value);
            }
          }
          <span class="hljs-keyword">if</span> ($scope.field) {
            $scope.field.value = data.value;
            $scope.field.displayValue = data.displayValue;
          }
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearDerivedFields</span>(<span class="hljs-params">value</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.DerivedFields) {
          <span class="hljs-keyword">var</span> df = <span class="hljs-keyword">new</span> DerivedFields($scope.field ? $scope.field.ref : $attrs.ref);
          df.clearRelated();
          df.updateRelated(value);
        }
      }
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/popover/directive.snComplexPopover.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui.popover'</span>).directive(<span class="hljs-string">'snComplexPopover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, $q, $http, $templateCache, $compile, $timeout</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">templateUrl</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">elem, attrs</span>) </span>{
      <span class="hljs-keyword">return</span> getTemplateUrl(attrs.buttonTemplate);
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $element, $attrs, $q, $document, snCustomEvent, snComplexPopoverService</span>) </span>{
      $scope.type = $attrs.complexPopoverType || <span class="hljs-string">"complex_popover"</span>;
      <span class="hljs-keyword">if</span> ($scope.closeEvent) {
        snCustomEvent.observe($scope.closeEvent, destroyPopover);
        $scope.$on($scope.closeEvent, destroyPopover);
      }
      $scope.$parent.$on(<span class="hljs-string">'$destroy'</span>, destroyPopover);
      <span class="hljs-keyword">var</span> newScope;
      <span class="hljs-keyword">var</span> open;
      <span class="hljs-keyword">var</span> popover;
      <span class="hljs-keyword">var</span> content;
      <span class="hljs-keyword">var</span> popoverDefaults = {
        <span class="hljs-attr">container</span>: <span class="hljs-string">'body'</span>,
        <span class="hljs-attr">html</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">placement</span>: <span class="hljs-string">'auto'</span>,
        <span class="hljs-attr">trigger</span>: <span class="hljs-string">'manual'</span>,
        <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;div class="complex_popover popover" role="tooltip"&gt;&lt;div class="arrow"&gt;&lt;/div&gt;&lt;div class="popover-content"&gt;&lt;/div&gt;&lt;/div&gt;'</span>
      };
      <span class="hljs-keyword">var</span> popoverConfig = angular.extend(popoverDefaults, $scope.popoverConfig);
      $scope.loading = <span class="hljs-literal">false</span>;
      $scope.initialized = <span class="hljs-literal">false</span>;
      $scope.togglePopover = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
        <span class="hljs-keyword">if</span> (!$scope.initialized) {
          showPopover(event);
        } <span class="hljs-keyword">else</span> {
          destroyPopover();
        }
      };

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showPopover</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.loading)
          <span class="hljs-keyword">return</span>;
        $scope.$toggleButton = angular.element(e.target);
        $scope.loading = <span class="hljs-literal">true</span>;
        $scope.$emit(<span class="hljs-string">'list.toggleLoadingState'</span>, <span class="hljs-literal">true</span>);
        _getTemplate()
          .then(_insertTemplate)
          .then(_createPopover)
          .then(_bindHtml)
          .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            $scope.loading = <span class="hljs-literal">false</span>;
            $scope.initialized = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">if</span> (!$scope.loadEvent)
              _openPopover();
          });
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroyPopover</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!newScope)
          <span class="hljs-keyword">return</span>;
        $scope.$toggleButton.on(<span class="hljs-string">'hidden.bs.popover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          open = <span class="hljs-literal">false</span>;
          $scope.$toggleButton.data(<span class="hljs-string">'bs.popover'</span>).$element.removeData(<span class="hljs-string">'bs.popover'</span>).off(<span class="hljs-string">'.popover'</span>);
          $scope.$toggleButton = <span class="hljs-literal">null</span>;
          snCustomEvent.fire(<span class="hljs-string">'hidden.complexpopover.'</span> + $scope.ref);
        });
        $scope.$toggleButton.popover(<span class="hljs-string">'hide'</span>);
        snCustomEvent.fire(<span class="hljs-string">'hide.complexpopover.'</span> + $scope.ref, $scope.$toggleButton);
        newScope.$broadcast(<span class="hljs-string">'$destroy'</span>);
        newScope.$destroy();
        newScope = <span class="hljs-literal">null</span>;
        $scope.initialized = <span class="hljs-literal">false</span>;
        angular.element(<span class="hljs-string">'html'</span>).off(<span class="hljs-string">'click'</span>, complexHtmlHandler);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getTemplate</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> snComplexPopoverService.getTemplate(getTemplateUrl($attrs.template));
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_createPopover</span>(<span class="hljs-params"></span>) </span>{
        $scope.$toggleButton.popover(popoverConfig);
        <span class="hljs-keyword">return</span> $q.when(<span class="hljs-literal">true</span>);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_insertTemplate</span>(<span class="hljs-params">response</span>) </span>{
        newScope = $scope.$<span class="hljs-keyword">new</span>();
        <span class="hljs-keyword">if</span> ($scope.loadEvent)
          newScope.$on($scope.loadEvent, _openPopover);
        content = $compile(response.data)(newScope);
        popoverConfig.content = content;
        newScope.open = <span class="hljs-literal">true</span>;
        snCustomEvent.fire(<span class="hljs-string">'inserted.complexpopover.'</span> + $scope.ref, $scope.$toggleButton);
        <span class="hljs-keyword">return</span> $q.when(<span class="hljs-literal">true</span>);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_bindHtml</span>(<span class="hljs-params"></span>) </span>{
        angular.element(<span class="hljs-string">'html'</span>).on(<span class="hljs-string">'click'</span>, complexHtmlHandler);
        <span class="hljs-keyword">return</span> $q.when(<span class="hljs-literal">true</span>);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">complexHtmlHandler</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-keyword">var</span> parentComplexPopoverScope = angular.element(e.target).parents(<span class="hljs-string">'.popover-content'</span>).children().scope();
        <span class="hljs-keyword">if</span> (parentComplexPopoverScope &amp;&amp; (parentComplexPopoverScope.type = <span class="hljs-string">"complex_popover"</span>) &amp;&amp; $scope.type === <span class="hljs-string">"complex_popover"</span>)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (angular.element(e.target).parents(<span class="hljs-string">'html'</span>).length === <span class="hljs-number">0</span>)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> ($scope.initialized &amp;&amp; !$scope.loading &amp;&amp; !$scope.$toggleButton.is(e.target) &amp;&amp; content.parents(<span class="hljs-string">'.popover'</span>).has(angular.element(e.target)).length === <span class="hljs-number">0</span>) {
          e.preventDefault();
          e.stopPropagation();
          destroyPopover(e);
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_openPopover</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (open)
          <span class="hljs-keyword">return</span>;
        open = <span class="hljs-literal">true</span>;
        $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          $scope.$toggleButton.popover(<span class="hljs-string">'show'</span>);
          snCustomEvent.fire(<span class="hljs-string">'show.complexpopover.'</span> + $scope.ref, $scope.$toggleButton);
          $scope.$toggleButton.on(<span class="hljs-string">'shown.bs.popover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            snCustomEvent.fire(<span class="hljs-string">'shown.complexpopover.'</span> + $scope.ref, $scope.$toggleButton);
          });
        }, <span class="hljs-number">0</span>);
      }
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/popover/service.snComplexPopoverService.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui.popover'</span>).service(<span class="hljs-string">'snComplexPopoverService'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$http, $q, $templateCache</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">getTemplate</span>: getTemplate
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTemplate</span>(<span class="hljs-params">template</span>) </span>{
    <span class="hljs-keyword">return</span> $http.get(template, {
      <span class="hljs-attr">cache</span>: $templateCache
    });
  }
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/directive.snConfirmModal.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui'</span>).directive(<span class="hljs-string">'snConfirmModal'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl</span>) </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'sn_confirm_modal.xml'</span>),
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">config</span>: <span class="hljs-string">'=?'</span>,
      <span class="hljs-attr">modalName</span>: <span class="hljs-string">'@'</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'@?'</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'@?'</span>,
      <span class="hljs-attr">cancelButton</span>: <span class="hljs-string">'@?'</span>,
      <span class="hljs-attr">okButton</span>: <span class="hljs-string">'@?'</span>,
      <span class="hljs-attr">alertButton</span>: <span class="hljs-string">'@?'</span>,
      <span class="hljs-attr">cancel</span>: <span class="hljs-string">'&amp;?'</span>,
      <span class="hljs-attr">ok</span>: <span class="hljs-string">'&amp;?'</span>,
      <span class="hljs-attr">alert</span>: <span class="hljs-string">'&amp;?'</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
      element.find(<span class="hljs-string">'.modal'</span>).remove();
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $rootScope</span>) </span>{
      $scope.config = $scope.config || {};

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Button</span>(<span class="hljs-params">fn, text</span>) </span>{
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">fn</span>: fn,
          <span class="hljs-attr">text</span>: text
        }
      }
      <span class="hljs-keyword">var</span> buttons = {
        <span class="hljs-string">'cancelButton'</span>: <span class="hljs-keyword">new</span> Button(<span class="hljs-string">'cancel'</span>, <span class="hljs-string">'Cancel'</span>),
        <span class="hljs-string">'okButton'</span>: <span class="hljs-keyword">new</span> Button(<span class="hljs-string">'ok'</span>, <span class="hljs-string">'OK'</span>),
        <span class="hljs-string">'alertButton'</span>: <span class="hljs-keyword">new</span> Button(<span class="hljs-string">'alert'</span>, <span class="hljs-string">'Close'</span>),
        <span class="hljs-attr">getText</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) </span>{
          <span class="hljs-keyword">var</span> button = <span class="hljs-keyword">this</span>[type];
          <span class="hljs-keyword">if</span> (button &amp;&amp; $scope.get(button.fn))
            <span class="hljs-keyword">return</span> button.text;
        }
      };
      $scope.get = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.config[type])
          <span class="hljs-keyword">return</span> $scope.config[type];
        <span class="hljs-keyword">if</span> (!$scope[type]) {
          <span class="hljs-keyword">var</span> text = buttons.getText(type);
          <span class="hljs-keyword">if</span> (text)
            <span class="hljs-keyword">return</span> $scope.config[type] = text;
        }
        <span class="hljs-keyword">return</span> $scope.config[type] = $scope[type];
      };
      <span class="hljs-keyword">if</span> (!$scope.get(<span class="hljs-string">'modalName'</span>))
        $scope.config.modalName = <span class="hljs-string">'confirm-modal'</span>;

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">call</span>(<span class="hljs-params">type</span>) </span>{
        <span class="hljs-keyword">var</span> action = $scope.get(type);
        <span class="hljs-keyword">if</span> (action) {
          <span class="hljs-keyword">if</span> (angular.isFunction(action))
            action();
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> !!buttons.getText(type);
      }
      $scope.cancelPressed = close(<span class="hljs-string">'cancel'</span>);
      $scope.okPressed = close(<span class="hljs-string">'ok'</span>);
      $scope.alertPressed = close(<span class="hljs-string">'alert'</span>);

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span>(<span class="hljs-params">type</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          actionClosed = <span class="hljs-literal">true</span>;
          $rootScope.$broadcast(<span class="hljs-string">'dialog.'</span> + $scope.config.modalName + <span class="hljs-string">'.close'</span>);
          call(type);
        }
      }
      <span class="hljs-keyword">var</span> actionClosed;
      $scope.$on(<span class="hljs-string">'dialog.'</span> + $scope.get(<span class="hljs-string">'modalName'</span>) + <span class="hljs-string">'.opened'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        actionClosed = <span class="hljs-literal">false</span>;
      });
      $scope.$on(<span class="hljs-string">'dialog.'</span> + $scope.get(<span class="hljs-string">'modalName'</span>) + <span class="hljs-string">'.closed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (actionClosed)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (call(<span class="hljs-string">'cancel'</span>))
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (call(<span class="hljs-string">'alert'</span>))
          <span class="hljs-keyword">return</span>;
        call(<span class="hljs-string">'ok'</span>);
      });
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/directive.snContextMenu.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui'</span>).directive(<span class="hljs-string">'contextMenu'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$document, $window, snCustomEvent</span>) </span>{
  <span class="hljs-keyword">var</span> $contextMenu, $ul;
  <span class="hljs-keyword">var</span> scrollHeight = angular.element(<span class="hljs-string">"body"</span>).get(<span class="hljs-number">0</span>).scrollHeight;
  <span class="hljs-keyword">var</span> contextMenuItemHeight = <span class="hljs-number">0</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setContextMenuPosition</span>(<span class="hljs-params">event, $ul</span>) </span>{
    <span class="hljs-keyword">if</span> (contextMenuItemHeight === <span class="hljs-number">0</span>)
      contextMenuItemHeight = <span class="hljs-number">24</span>;
    <span class="hljs-keyword">var</span> cmWidth = <span class="hljs-number">150</span>;
    <span class="hljs-keyword">var</span> cmHeight = contextMenuItemHeight * $ul.children().length;
    <span class="hljs-keyword">var</span> startX = event.pageX + cmWidth &gt;= $<span class="hljs-built_in">window</span>.innerWidth ? event.pageX - cmWidth : event.pageX;
    <span class="hljs-keyword">var</span> startY = event.pageY + cmHeight &gt;= $<span class="hljs-built_in">window</span>.innerHeight ? event.pageY - cmHeight : event.pageY;
    $ul.css({
      <span class="hljs-attr">display</span>: <span class="hljs-string">'block'</span>,
      <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
      <span class="hljs-attr">left</span>: startX,
      <span class="hljs-attr">top</span>: startY
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderContextMenuItems</span>(<span class="hljs-params">$scope, event, options</span>) </span>{
    $ul.empty();
    angular.forEach(options, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
      <span class="hljs-keyword">var</span> $li = angular.element(<span class="hljs-string">'&lt;li&gt;'</span>);
      <span class="hljs-keyword">if</span> (item === <span class="hljs-literal">null</span>) {
        $li.addClass(<span class="hljs-string">'divider'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> $a = angular.element(<span class="hljs-string">'&lt;a&gt;'</span>);
        $a.attr({
          <span class="hljs-attr">tabindex</span>: <span class="hljs-string">'-1'</span>
        });
        $a.text(<span class="hljs-keyword">typeof</span> item[<span class="hljs-number">0</span>] == <span class="hljs-string">'string'</span> ? item[<span class="hljs-number">0</span>] : item[<span class="hljs-number">0</span>].call($scope, $scope));
        $li.append($a);
        $li.on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$event</span>) </span>{
          $event.preventDefault();
          $scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            _clearContextMenus(event);
            item[<span class="hljs-number">1</span>].call($scope, $scope);
          });
        });
      }
      $ul.append($li);
    });
    setContextMenuPosition(event, $ul);
  }
  <span class="hljs-keyword">var</span> renderContextMenu = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, event, options</span>) </span>{
    angular.element(event.currentTarget).addClass(<span class="hljs-string">'context'</span>);
    $contextMenu = angular.element(<span class="hljs-string">'&lt;div&gt;'</span>, {
      <span class="hljs-string">'class'</span>: <span class="hljs-string">'dropdown clearfix context-dropdown open'</span>
    });
    $contextMenu.on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
      <span class="hljs-keyword">if</span> (angular.element(e.target).hasClass(<span class="hljs-string">'dropdown'</span>)) {
        _clearContextMenus(event);
      }
    });
    $contextMenu.on(<span class="hljs-string">'contextmenu'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
      event.preventDefault();
      _clearContextMenus(event);
    });
    $contextMenu.css({
      <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
      <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">height</span>: scrollHeight,
      <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">right</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">zIndex</span>: <span class="hljs-number">9999</span>
    });
    $<span class="hljs-built_in">document</span>.find(<span class="hljs-string">'body'</span>).append($contextMenu);
    $ul = angular.element(<span class="hljs-string">'&lt;ul&gt;'</span>, {
      <span class="hljs-string">'class'</span>: <span class="hljs-string">'dropdown-menu'</span>,
      <span class="hljs-string">'role'</span>: <span class="hljs-string">'menu'</span>
    });
    renderContextMenuItems($scope, event, options);
    $contextMenu.append($ul);
    $contextMenu.data(<span class="hljs-string">'resizeHandler'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      scrollHeight = angular.element(<span class="hljs-string">"body"</span>).get(<span class="hljs-number">0</span>).scrollHeight;
      $contextMenu.css(<span class="hljs-string">'height'</span>, scrollHeight);
    });
    snCustomEvent.observe(<span class="hljs-string">'partial.page.reload'</span>, $contextMenu.data(<span class="hljs-string">'resizeHandler'</span>));
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_clearContextMenus</span>(<span class="hljs-params">event</span>) </span>{
    <span class="hljs-keyword">if</span> (!event) {
      <span class="hljs-keyword">return</span>;
    }
    angular.element(event.currentTarget).removeClass(<span class="hljs-string">'context'</span>);
    <span class="hljs-keyword">var</span> els = angular.element(<span class="hljs-string">".context-dropdown"</span>);
    angular.forEach(els, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">el</span>) </span>{
      snCustomEvent.un(<span class="hljs-string">'partial.page.reload'</span>, angular.element(el).data(<span class="hljs-string">'resizeHandler'</span>));
      angular.element(el).remove();
    });
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs</span>) </span>{
    element.on(<span class="hljs-string">'contextmenu'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
      <span class="hljs-keyword">if</span> (event.ctrlKey)
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (angular.element(element).attr(<span class="hljs-string">'context-type'</span>))
        <span class="hljs-keyword">return</span>;
      scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        applyMenu(event);
        clearWindowSelection();
      });
    });
    element.on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
      <span class="hljs-keyword">var</span> $el = angular.element(element);
      <span class="hljs-keyword">var</span> $target = angular.element(event.target);
      <span class="hljs-keyword">if</span> (!$el.attr(<span class="hljs-string">'context-type'</span>) &amp;&amp; !$target.hasClass(<span class="hljs-string">'context-menu-click'</span>))
        <span class="hljs-keyword">return</span>;
      scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        applyMenu(event);
        clearWindowSelection();
      });
    });

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearWindowSelection</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.getSelection)
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.getSelection().empty)
          <span class="hljs-built_in">window</span>.getSelection().empty();
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.getSelection().removeAllRanges)
        <span class="hljs-built_in">window</span>.getSelection().removeAllRanges();
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.selection)
        <span class="hljs-built_in">document</span>.selection.empty();
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">applyMenu</span>(<span class="hljs-params">event</span>) </span>{
      <span class="hljs-keyword">var</span> tagName = event.target.tagName;
      <span class="hljs-keyword">if</span> (tagName == <span class="hljs-string">'INPUT'</span> || tagName == <span class="hljs-string">'SELECT'</span> || tagName == <span class="hljs-string">'BUTTON'</span>) {
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">var</span> menu = scope.$<span class="hljs-built_in">eval</span>(attrs.contextMenu);
      <span class="hljs-keyword">if</span> (menu <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {
        <span class="hljs-keyword">if</span> (menu.length &gt; <span class="hljs-number">0</span>) {
          event.stopPropagation();
          event.preventDefault();
          scope.$watch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> menu;
          }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
            <span class="hljs-keyword">if</span> (newValue !== oldValue) renderContextMenuItems(scope, event, menu);
          }, <span class="hljs-literal">true</span>);
          renderContextMenu(scope, event, menu);
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> menu !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> menu.then === <span class="hljs-string">'function'</span>) {
        event.stopPropagation();
        event.preventDefault();
        menu.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
          <span class="hljs-keyword">var</span> contextMenu = response;
          <span class="hljs-keyword">if</span> (contextMenu.length &gt; <span class="hljs-number">0</span>) {
            scope.$watch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">return</span> contextMenu;
            }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
              <span class="hljs-keyword">if</span> (newValue !== oldValue)
                renderContextMenuItems(scope, event, contextMenu);
            }, <span class="hljs-literal">true</span>);
            renderContextMenu(scope, event, contextMenu);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-string">'"'</span> + attrs.contextMenu + <span class="hljs-string">'" is not an array or promise'</span>;
          }
        });
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'"'</span> + attrs.contextMenu + <span class="hljs-string">'" is not an array or promise'</span>;
      }
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/directive.snDialog.js */</span>
angular.module(<span class="hljs-string">"sn.common.ui"</span>).directive(<span class="hljs-string">"snDialog"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout, $rootScope, $document</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">"AE"</span>,
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">modal</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">disableAutoFocus</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">classCheck</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;dialog&gt;&lt;div ng-click="onClickClose()" class="close-button icon-button icon-cross"&gt;&lt;/div&gt;&lt;/dialog&gt;'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs, ctrl, transcludeFn</span>) </span>{
      <span class="hljs-keyword">var</span> transcludeScope = {};
      scope.isOpen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> element[<span class="hljs-number">0</span>].open;
      };
      transcludeFn(element.scope().$<span class="hljs-keyword">new</span>(), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
        element.append(a);
        transcludeScope = b;
      });
      element.click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
        event.stopPropagation();
        <span class="hljs-keyword">if</span> (event.offsetX &lt; <span class="hljs-number">0</span> || event.offsetX &gt; element[<span class="hljs-number">0</span>].offsetWidth || event.offsetY &lt; <span class="hljs-number">0</span> || event.offsetY &gt; element[<span class="hljs-number">0</span>].offsetHeight)
          <span class="hljs-keyword">if</span> (!scope.classCheck)
            scope.onClickClose();
          <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> classes = scope.classCheck.split(<span class="hljs-string">","</span>);
            <span class="hljs-keyword">var</span> found = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; classes.length; i++)
              <span class="hljs-keyword">if</span> (angular.element(event.srcElement).closest(classes[i]).length &gt; <span class="hljs-number">0</span>)
                found = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">if</span> (!found)
              scope.onClickClose();
          }
      });
      scope.show = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> d = element[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">if</span> (!d.showModal || <span class="hljs-literal">true</span>) {
          dialogPolyfill.registerDialog(d);
          d.setDisableAutoFocus(scope.disableAutoFocus);
        }
        <span class="hljs-keyword">if</span> (scope.modal)
          d.showModal();
        <span class="hljs-keyword">else</span>
          d.show();
        <span class="hljs-keyword">if</span> (!angular.element(d).hasClass(<span class="hljs-string">'sn-alert'</span>)) {
          $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (d.dialogPolyfillInfo &amp;&amp; d.dialogPolyfillInfo.backdrop) {
              angular.element(d.dialogPolyfillInfo.backdrop).one(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
                <span class="hljs-keyword">if</span> (!scope.classCheck || angular.element(event.srcElement).closest(scope.classCheck).length == <span class="hljs-number">0</span>)
                  scope.onClickClose();
              })
            } <span class="hljs-keyword">else</span> {
              $<span class="hljs-built_in">document</span>.on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
                <span class="hljs-keyword">if</span> (!scope.classCheck || angular.element(event.srcElement).closest(scope.classCheck).length == <span class="hljs-number">0</span>)
                  scope.onClickClose();
              })
            }
          });
        }
      };
      scope.setPosition = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
        <span class="hljs-keyword">var</span> contextData = scope.getContextData(data);
        <span class="hljs-keyword">if</span> (contextData &amp;&amp; element &amp;&amp; element[<span class="hljs-number">0</span>]) {
          <span class="hljs-keyword">if</span> (contextData.position) {
            element[<span class="hljs-number">0</span>].style.top = contextData.position.top + <span class="hljs-string">"px"</span>;
            element[<span class="hljs-number">0</span>].style.left = contextData.position.left + <span class="hljs-string">"px"</span>;
            element[<span class="hljs-number">0</span>].style.margin = <span class="hljs-string">"0px"</span>;
          }
          <span class="hljs-keyword">if</span> (contextData.dimensions) {
            element[<span class="hljs-number">0</span>].style.width = contextData.dimensions.width + <span class="hljs-string">"px"</span>;
            element[<span class="hljs-number">0</span>].style.height = contextData.dimensions.height + <span class="hljs-string">"px"</span>;
          }
        }
      }
      scope.$on(<span class="hljs-string">"dialog."</span> + attrs.name + <span class="hljs-string">".move"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, data</span>) </span>{
        scope.setPosition(data);
      })
      scope.$on(<span class="hljs-string">"dialog."</span> + attrs.name + <span class="hljs-string">".show"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, data</span>) </span>{
        scope.setPosition(data);
        scope.setKeyEvents(data);
        <span class="hljs-keyword">if</span> (scope.isOpen() === <span class="hljs-literal">true</span>)
          scope.close();
        <span class="hljs-keyword">else</span>
          scope.show();
        angular.element(<span class="hljs-string">".sn-dialog-menu"</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">index, value</span>) </span>{
          <span class="hljs-keyword">var</span> name = angular.element(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'name'</span>);
          <span class="hljs-keyword">if</span> (name != attrs.name &amp;&amp; !angular.element(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'open'</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
          }
          <span class="hljs-keyword">if</span> (name != attrs.name &amp;&amp; angular.element(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'open'</span>)) {
            $rootScope.$broadcast(<span class="hljs-string">"dialog."</span> + name + <span class="hljs-string">".close"</span>);
          }
        });
      })
      scope.onClickClose = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (scope.isOpen())
          $rootScope.$broadcast(<span class="hljs-string">"dialog."</span> + attrs.name + <span class="hljs-string">".close"</span>);
      }
      scope.close = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> d = element[<span class="hljs-number">0</span>];
        d.close();
        scope.removeListeners();
      }
      scope.ok = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">contextData</span>) </span>{
        contextData.ok();
        scope.removeListeners();
      }
      scope.cancel = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">contextData</span>) </span>{
        contextData.cancel();
        scope.removeListeners();
      }
      scope.removeListeners = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        element[<span class="hljs-number">0</span>].removeEventListener(<span class="hljs-string">"ok"</span>, scope.handleContextOk, <span class="hljs-literal">false</span>);
        element[<span class="hljs-number">0</span>].removeEventListener(<span class="hljs-string">"cancel"</span>, scope.handleContextCancel, <span class="hljs-literal">false</span>);
      }
      scope.setKeyEvents = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
        <span class="hljs-keyword">var</span> contextData = scope.getContextData(data);
        <span class="hljs-keyword">if</span> (contextData &amp;&amp; contextData.cancel) {
          scope.handleContextOk = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            scope.ok(contextData);
          }
          scope.handleContextCancel = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            scope.cancel(contextData);
          }
          element[<span class="hljs-number">0</span>].addEventListener(<span class="hljs-string">"ok"</span>, scope.handleContextOk, <span class="hljs-literal">false</span>);
          element[<span class="hljs-number">0</span>].addEventListener(<span class="hljs-string">"cancel"</span>, scope.handleContextCancel, <span class="hljs-literal">false</span>);
        }
      }
      scope.getContextData = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
        <span class="hljs-keyword">var</span> context = attrs.context;
        <span class="hljs-keyword">var</span> contextData = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (context &amp;&amp; data &amp;&amp; context <span class="hljs-keyword">in</span> data) {
          contextData = data[context];
          transcludeScope[context] = contextData;
        }
        <span class="hljs-keyword">return</span> contextData;
      }
      scope.$on(<span class="hljs-string">"dialog."</span> + attrs.name + <span class="hljs-string">".close"</span>, scope.close);
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/directive.snFlyout.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui'</span>).directive(<span class="hljs-string">'snFlyout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-string">'true'</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'sn_flyout.xml'</span>),
    <span class="hljs-attr">scope</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, element, attrs</span>) </span>{
      $scope.open = <span class="hljs-literal">false</span>;
      $scope.more = <span class="hljs-literal">false</span>;
      $scope.position = attrs.position || <span class="hljs-string">'left'</span>;
      $scope.flyoutControl = attrs.control;
      $scope.register = attrs.register;
      <span class="hljs-keyword">var</span> body = angular.element(<span class="hljs-string">'.flyout-body'</span>, element);
      <span class="hljs-keyword">var</span> header = angular.element(<span class="hljs-string">'.flyout-header'</span>, element);
      <span class="hljs-keyword">var</span> tabs = angular.element(<span class="hljs-string">'.flyout-tabs'</span>, element);
      <span class="hljs-keyword">var</span> distance = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">var</span> position = $scope.position;
      <span class="hljs-keyword">var</span> options = {
        <span class="hljs-attr">duration</span>: <span class="hljs-number">800</span>,
        <span class="hljs-attr">easing</span>: <span class="hljs-string">'easeOutBounce'</span>
      }
      <span class="hljs-keyword">var</span> animation = {};
      <span class="hljs-keyword">if</span> ($scope.flyoutControl) {
        $(<span class="hljs-string">'.flyout-handle'</span>, element).hide();
        <span class="hljs-keyword">var</span> controls = angular.element(<span class="hljs-string">'#'</span> + $scope.flyoutControl);
        controls.click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          angular.element(<span class="hljs-keyword">this</span>).trigger(<span class="hljs-string">"snFlyout.open"</span>);
        });
        controls.on(<span class="hljs-string">'snFlyout.open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          $scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            $scope.open = !$scope.open;
          });
        });
      }
      <span class="hljs-keyword">var</span> animate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        element.velocity(animation, options);
      }
      <span class="hljs-keyword">var</span> setup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        animation[position] = -distance;
        <span class="hljs-keyword">if</span> ($scope.open)
          element.css(position, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">else</span>
          element.css(position, -distance);
      }
      <span class="hljs-keyword">var</span> calculatePosition = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.open) {
          animation[position] = <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> ($scope.position === <span class="hljs-string">'left'</span> || $scope.position === <span class="hljs-string">'right'</span>)
            animation[position] = -body.outerWidth();
          <span class="hljs-keyword">else</span>
            animation[position] = -body.outerHeight();
        }
      }
      $scope.$watch(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
        <span class="hljs-keyword">if</span> (newValue === oldValue)
          <span class="hljs-keyword">return</span>;
        calculatePosition();
        animate();
      });
      $scope.$watch(<span class="hljs-string">'more'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
        <span class="hljs-keyword">if</span> (newValue === oldValue)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">var</span> moreAnimation = {};
        <span class="hljs-keyword">if</span> ($scope.more) {
          element.addClass(<span class="hljs-string">'fly-double'</span>);
          moreAnimation = {
            <span class="hljs-attr">width</span>: body.outerWidth() * <span class="hljs-number">2</span>
          };
        } <span class="hljs-keyword">else</span> {
          element.removeClass(<span class="hljs-string">'fly-double'</span>);
          moreAnimation = {
            <span class="hljs-attr">width</span>: body.outerWidth() / <span class="hljs-number">2</span>
          };
        }
        body.velocity(moreAnimation, options);
        header.velocity(moreAnimation, options);
      });
      <span class="hljs-keyword">if</span> ($scope.position === <span class="hljs-string">'left'</span> || $scope.position === <span class="hljs-string">'right'</span>) {
        $scope.$watch(element[<span class="hljs-number">0</span>].offsetWidth, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          element.addClass(<span class="hljs-string">'fly-from-'</span> + $scope.position);
          distance = body.outerWidth();
          setup();
        });
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($scope.position === <span class="hljs-string">'top'</span> || $scope.position === <span class="hljs-string">'bottom'</span>) {
        $scope.$watch(element[<span class="hljs-number">0</span>].offsetWidth, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          element.addClass(<span class="hljs-string">'fly-from-'</span> + $scope.position);
          distance = body.outerHeight() + header.outerHeight();
          setup();
        });
      }
      $scope.$on($scope.register + <span class="hljs-string">".bounceTabByIndex"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, index</span>) </span>{
        $scope.bounceTab(index);
      });
      $scope.$on($scope.register + <span class="hljs-string">".bounceTab"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, tab</span>) </span>{
        $scope.bounceTab($scope.tabs.indexOf(tab));
      });
      $scope.$on($scope.register + <span class="hljs-string">".selectTabByIndex"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, index</span>) </span>{
        $scope.selectTab($scope.tabs[index]);
      });
      $scope.$on($scope.register + <span class="hljs-string">".selectTab"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, tab</span>) </span>{
        $scope.selectTab(tab);
      });
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $element</span>) </span>{
      $scope.tabs = [];
      <span class="hljs-keyword">var</span> baseColor, highLightColor;
      $scope.selectTab = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tab</span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.selectedTab)
          $scope.selectedTab.selected = <span class="hljs-literal">false</span>;
        tab.selected = <span class="hljs-literal">true</span>;
        $scope.selectedTab = tab;
        normalizeTab($scope.tabs.indexOf(tab));
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">expandTab</span>(<span class="hljs-params">tabElem</span>) </span>{
        tabElem.queue(<span class="hljs-string">"tabBounce"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">next</span>) </span>{
          tabElem.velocity({
            <span class="hljs-attr">width</span>: [<span class="hljs-string">"2.5rem"</span>, <span class="hljs-string">"2.125rem"</span>],
            <span class="hljs-attr">backgroundColorRed</span>: [highLightColor[<span class="hljs-number">0</span>], baseColor[<span class="hljs-number">0</span>]],
            <span class="hljs-attr">backgroundColorGreen</span>: [highLightColor[<span class="hljs-number">1</span>], baseColor[<span class="hljs-number">1</span>]],
            <span class="hljs-attr">backgroundColorBlue</span>: [highLightColor[<span class="hljs-number">2</span>], baseColor[<span class="hljs-number">2</span>]]
          }, {
            <span class="hljs-attr">easing</span>: <span class="hljs-string">"easeInExpo"</span>,
            <span class="hljs-attr">duration</span>: <span class="hljs-number">250</span>
          });
          next();
        });
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">contractTab</span>(<span class="hljs-params">tabElem</span>) </span>{
        tabElem.queue(<span class="hljs-string">"tabBounce"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">next</span>) </span>{
          tabElem.velocity({
            <span class="hljs-attr">width</span>: [<span class="hljs-string">"2.125rem"</span>, <span class="hljs-string">"2.5rem"</span>],
            <span class="hljs-attr">backgroundColorRed</span>: [baseColor[<span class="hljs-number">0</span>], highLightColor[<span class="hljs-number">0</span>]],
            <span class="hljs-attr">backgroundColorGreen</span>: [baseColor[<span class="hljs-number">1</span>], highLightColor[<span class="hljs-number">1</span>]],
            <span class="hljs-attr">backgroundColorBlue</span>: [baseColor[<span class="hljs-number">2</span>], highLightColor[<span class="hljs-number">2</span>]]
          }, {
            <span class="hljs-attr">easing</span>: <span class="hljs-string">"easeInExpo"</span>,
            <span class="hljs-attr">duration</span>: <span class="hljs-number">250</span>
          });
          next();
        });
      }
      $scope.bounceTab = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">index</span>) </span>{
        <span class="hljs-keyword">if</span> (index &gt;= $scope.tabs.length || index &lt; <span class="hljs-number">0</span>)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">var</span> tabScope = $scope.tabs[index];
        <span class="hljs-keyword">if</span> (!tabScope.selected) {
          <span class="hljs-keyword">var</span> tabElem = $element.find(<span class="hljs-string">'.flyout-tab'</span>).eq(index);
          <span class="hljs-keyword">if</span> (!baseColor) {
            baseColor = tabElem.css(<span class="hljs-string">'backgroundColor'</span>).match(<span class="hljs-regexp">/[0-9]+/g</span>);
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; baseColor.length; i++)
              baseColor[i] = <span class="hljs-built_in">parseInt</span>(baseColor[i], <span class="hljs-number">10</span>);
          }
          <span class="hljs-keyword">if</span> (!highLightColor)
            highLightColor = invertColor(baseColor);
          <span class="hljs-keyword">if</span> (tabScope.highlighted)
            contractTab(tabElem);
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) {
            expandTab(tabElem);
            contractTab(tabElem);
          }
          expandTab(tabElem);
          tabElem.dequeue(<span class="hljs-string">"tabBounce"</span>);
          tabScope.highlighted = <span class="hljs-literal">true</span>;
        }
      }
      $scope.toggleOpen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $scope.open = !$scope.open;
      }
      <span class="hljs-keyword">this</span>.addTab = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tab</span>) </span>{
        $scope.tabs.push(tab);
        <span class="hljs-keyword">if</span> ($scope.tabs.length === <span class="hljs-number">1</span>)
          $scope.selectTab(tab)
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalizeTab</span>(<span class="hljs-params">index</span>) </span>{
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= $scope.tabs.length || !$scope.tabs[index].highlighted)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">var</span> tabElem = $element.find(<span class="hljs-string">'.flyout-tab'</span>).eq(index);
        tabElem.velocity({
          <span class="hljs-attr">width</span>: [<span class="hljs-string">"2.125rem"</span>, <span class="hljs-string">"2.5rem"</span>]
        }, {
          <span class="hljs-attr">easing</span>: <span class="hljs-string">"easeInExpo"</span>,
          <span class="hljs-attr">duration</span>: <span class="hljs-number">250</span>
        });
        tabElem.css(<span class="hljs-string">'backgroundColor'</span>, <span class="hljs-string">''</span>);
        $scope.tabs[index].highlighted = <span class="hljs-literal">false</span>;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">invertColor</span>(<span class="hljs-params">rgb</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> rgb === <span class="hljs-string">"string"</span>)
          <span class="hljs-keyword">var</span> color = rgb.match(<span class="hljs-regexp">/[0-9]+/g</span>);
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">var</span> color = rgb.slice(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; color.length; i++)
          color[i] = <span class="hljs-number">255</span> - <span class="hljs-built_in">parseInt</span>(color[i], <span class="hljs-number">10</span>);
        <span class="hljs-keyword">return</span> color;
      }
    }
  }
}).directive(<span class="hljs-string">"snFlyoutTab"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">"E"</span>,
    <span class="hljs-attr">require</span>: <span class="hljs-string">"^snFlyout"</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">template</span>: <span class="hljs-string">"&lt;div ng-show='selected' ng-transclude='' style='height: 100%'&gt;&lt;/div&gt;"</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs, flyoutCtrl</span>) </span>{
      flyoutCtrl.addTab(scope);
    }
  }
});
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/directive.snModal.js */</span>
angular.module(<span class="hljs-string">"sn.common.ui"</span>).directive(<span class="hljs-string">"snModal"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout, $rootScope</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">"AE"</span>,
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {},
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;div tabindex="-1" aria-hidden="true" class="modal" role="dialog"&gt;&lt;/div&gt;'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs, ctrl, transcludeFn</span>) </span>{
      <span class="hljs-keyword">var</span> transcludeScope = {};
      transcludeFn(element.scope().$<span class="hljs-keyword">new</span>(), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
        element.append(a);
        transcludeScope = b;
      });
      scope.$on(<span class="hljs-string">"dialog."</span> + attrs.name + <span class="hljs-string">".show"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, data</span>) </span>{
        <span class="hljs-keyword">if</span> (!isOpen())
          show(data);
      });
      scope.$on(<span class="hljs-string">"dialog."</span> + attrs.name + <span class="hljs-string">".close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (isOpen())
          close();
      });

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eventFn</span>(<span class="hljs-params">eventName</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
          $rootScope.$broadcast(<span class="hljs-string">"dialog."</span> + attrs.name + <span class="hljs-string">"."</span> + eventName, e);
        }
      }
      <span class="hljs-keyword">var</span> events = {
        <span class="hljs-string">'shown.bs.modal'</span>: eventFn(<span class="hljs-string">"opened"</span>),
        <span class="hljs-string">'hide.bs.modal'</span>: eventFn(<span class="hljs-string">"hide"</span>),
        <span class="hljs-string">'hidden.bs.modal'</span>: eventFn(<span class="hljs-string">"closed"</span>)
      };

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span>(<span class="hljs-params">data</span>) </span>{
        <span class="hljs-keyword">var</span> context = attrs.context;
        <span class="hljs-keyword">var</span> contextData = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (context &amp;&amp; data &amp;&amp; context <span class="hljs-keyword">in</span> data) {
          contextData = data[context];
          transcludeScope[context] = contextData;
        }
        $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          angular.element(<span class="hljs-string">'.sn-popover-basic'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> $<span class="hljs-keyword">this</span> = angular.element(<span class="hljs-keyword">this</span>);
            <span class="hljs-keyword">if</span> (angular.element($<span class="hljs-keyword">this</span>.attr(<span class="hljs-string">'data-target'</span>)).is(<span class="hljs-string">':visible'</span>)) {
              $<span class="hljs-keyword">this</span>.popover(<span class="hljs-string">'hide'</span>);
            }
          });
        });
        element.modal(<span class="hljs-string">'show'</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> event <span class="hljs-keyword">in</span> events)
          <span class="hljs-keyword">if</span> (events.hasOwnProperty(event))
            element.on(event, events[event]);
        <span class="hljs-keyword">if</span> (attrs.moveBackdrop == <span class="hljs-string">'true'</span>)
          moveBackdrop(element);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span>(<span class="hljs-params"></span>) </span>{
        element.modal(<span class="hljs-string">'hide'</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> event <span class="hljs-keyword">in</span> events)
          <span class="hljs-keyword">if</span> (events.hasOwnProperty(event))
            element.off(event, events[event]);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isOpen</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> element.hasClass(<span class="hljs-string">'in'</span>);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">moveBackdrop</span>(<span class="hljs-params">element</span>) </span>{
        element.after(angular.element(<span class="hljs-string">'.modal-backdrop:visible'</span>).remove());
      }
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/directive.snModalShow.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui'</span>).directive(<span class="hljs-string">'snModalShow'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs</span>) </span>{
      element.click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        showDialog();
      });
      element.keyup(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        <span class="hljs-keyword">if</span> (evt.which != <span class="hljs-number">13</span>)
          <span class="hljs-keyword">return</span>;
        showDialog();
      });

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showDialog</span>(<span class="hljs-params"></span>) </span>{
        scope.$broadcast(<span class="hljs-string">'dialog.'</span> + attrs.snModalShow + <span class="hljs-string">'.show'</span>);
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.SingletonKeyboardRegistry) {
        SingletonKeyboardRegistry.getInstance().bind(<span class="hljs-string">'ctrl + alt + i'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          scope.$broadcast(<span class="hljs-string">'dialog.impersonate.show'</span>);
        }).selector(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);
      }
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/directive.snTabs.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui'</span>).directive(<span class="hljs-string">'snTabs'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-string">'true'</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">tabData</span>: <span class="hljs-string">'='</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, element, attrs</span>) </span>{
      $scope.tabClass = attrs.tabClass;
      $scope.register = attrs.register;
      attrs.$observe(<span class="hljs-string">'register'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
        $scope.register = value;
        $scope.setupListeners();
      });
      $scope.bounceTab = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        angular.element()
      }
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-string">'snTabs'</span>
  }
}).controller(<span class="hljs-string">'snTabs'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $rootScope</span>) </span>{
  $scope.selectedTabIndex = <span class="hljs-number">0</span>;
  $scope.tabData[$scope.selectedTabIndex].selected = <span class="hljs-literal">true</span>;
  $scope.setupListeners = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    $scope.$on($scope.register + <span class="hljs-string">'.selectTabByIndex'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, index</span>) </span>{
      $scope.selectTabByIndex(event, index);
    });
  }
  $scope.selectTabByIndex = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, index</span>) </span>{
    <span class="hljs-keyword">if</span> (index === $scope.selectedTabIndex)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (event.stopPropagation)
      event.stopPropagation();
    $scope.tabData[$scope.selectedTabIndex].selected = <span class="hljs-literal">false</span>;
    $scope.tabData[index].selected = <span class="hljs-literal">true</span>;
    $scope.selectedTabIndex = index;
    $rootScope.$broadcast($scope.register + <span class="hljs-string">'.selectTabByIndex'</span>, $scope.selectedTabIndex);
  }
}).directive(<span class="hljs-string">'snTab'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">transclude</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-string">'true'</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">tabData</span>: <span class="hljs-string">'='</span>,
      <span class="hljs-attr">index</span>: <span class="hljs-string">'='</span>
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">controller</span>: <span class="hljs-string">'snTab'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, element, attrs</span>) </span>{
      $scope.register = attrs.register;
      attrs.$observe(<span class="hljs-string">'register'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
        $scope.register = value;
        $scope.setupListeners();
      });
      $scope.bounceTab = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        alert(<span class="hljs-string">'Bounce Tab at Index: '</span> + $scope.index);
      }
    }
  }
}).controller(<span class="hljs-string">'snTab'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
  $scope.selectTabByIndex = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">index</span>) </span>{
    $scope.$emit($scope.register + <span class="hljs-string">'.selectTabByIndex'</span>, index);
  }
  $scope.setupListeners = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    $scope.$on($scope.register + <span class="hljs-string">'.showTabActivity'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, index, type</span>) </span>{
      $scope.showTabActivity(index, type);
    });
  }
  $scope.showTabActivity = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">index, type</span>) </span>{
    <span class="hljs-keyword">if</span> ($scope.index !== index)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">switch</span> (type) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'message'</span>:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'error'</span>:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        $scope.bounceTab();
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/directive.snTextExpander.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui'</span>).directive(<span class="hljs-string">'snTextExpander'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, $timeout</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'sn_text_expander.xml'</span>),
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">maxHeight</span>: <span class="hljs-string">'&amp;'</span>,
      <span class="hljs-attr">value</span>: <span class="hljs-string">'='</span>
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compile</span>(<span class="hljs-params">scope, element, attrs</span>) </span>{
      <span class="hljs-keyword">var</span> container = angular.element(element).find(<span class="hljs-string">'.textblock-content-container'</span>);
      <span class="hljs-keyword">var</span> content = angular.element(element).find(<span class="hljs-string">'.textblock-content'</span>);
      <span class="hljs-keyword">if</span> (scope.maxHeight() === <span class="hljs-literal">undefined</span>) {
        scope.maxHeight = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
        }
      }
      container.css(<span class="hljs-string">'overflow-y'</span>, <span class="hljs-string">'hidden'</span>);
      container.css(<span class="hljs-string">'max-height'</span>, scope.maxHeight() + <span class="hljs-string">'px'</span>);
    },
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $element</span>) </span>{
      <span class="hljs-keyword">var</span> container = $element.find(<span class="hljs-string">'.textblock-content-container'</span>);
      <span class="hljs-keyword">var</span> content = $element.find(<span class="hljs-string">'.textblock-content'</span>);
      $scope.value = $scope.value || <span class="hljs-string">''</span>;
      $scope.toggleExpand = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $scope.showMore = !$scope.showMore;
        <span class="hljs-keyword">if</span> ($scope.showMore) {
          container.css(<span class="hljs-string">'max-height'</span>, content.height());
        } <span class="hljs-keyword">else</span> {
          container.css(<span class="hljs-string">'max-height'</span>, $scope.maxHeight());
        }
      };
      $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (content.height() &gt; $scope.maxHeight()) {
          $scope.showToggle = <span class="hljs-literal">true</span>;
          $scope.showMore = <span class="hljs-literal">false</span>;
        }
      });
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/directive.snAttachmentPreview.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui'</span>).directive(<span class="hljs-string">'snAttachmentPreview'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, snCustomEvent</span>) </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'sn_attachment_preview.xml'</span>),
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
      snCustomEvent.observe(<span class="hljs-string">'sn.attachment.preview'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt, attachment</span>) </span>{
        <span class="hljs-keyword">if</span> (evt.stopPropagation)
          evt.stopPropagation();
        <span class="hljs-keyword">if</span> (evt.preventDefault)
          evt.preventDefault();
        $scope.image = attachment;
        $scope.$broadcast(<span class="hljs-string">'dialog.attachment_preview.show'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      });
    }
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/service.progressDialog.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui'</span>).factory(<span class="hljs-string">'progressDialog'</span>, [<span class="hljs-string">'$rootScope'</span>, <span class="hljs-string">'$compile'</span>, <span class="hljs-string">'$timeout'</span>, <span class="hljs-string">'$http'</span>, <span class="hljs-string">'$templateCache'</span>, <span class="hljs-string">'nowServer'</span>, <span class="hljs-string">'i18n'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$rootScope, $compile, $timeout, $http, $templateCache, nowServer, i18n</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  i18n.getMessages([<span class="hljs-string">'Close'</span>]);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">STATES</span>: [<span class="hljs-string">"Pending"</span>, <span class="hljs-string">"Running"</span>, <span class="hljs-string">"Succeeded"</span>, <span class="hljs-string">"Failed"</span>, <span class="hljs-string">"Cancelled"</span>],
    <span class="hljs-attr">STATUS_IMAGES</span>: [<span class="hljs-string">"images/workflow_skipped.gif"</span>, <span class="hljs-string">"images/loading_anim2.gifx"</span>,
      <span class="hljs-string">"images/progress_success.png"</span>, <span class="hljs-string">"images/progress_failure.png"</span>,
      <span class="hljs-string">'images/request_cancelled.gif'</span>
    ],
    <span class="hljs-attr">EXPAND_IMAGE</span>: <span class="hljs-string">"images/icons/filter_hide.gif"</span>,
    <span class="hljs-attr">COLLAPSE_IMAGE</span>: <span class="hljs-string">"images/icons/filter_reveal.gif"</span>,
    <span class="hljs-attr">BACK_IMAGE</span>: <span class="hljs-string">"images/activity_filter_off.gif"</span>,
    <span class="hljs-attr">TIMEOUT_INTERVAL</span>: <span class="hljs-number">750</span>,
    <span class="hljs-attr">_findChildMessage</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">statusObject</span>) </span>{
      <span class="hljs-keyword">if</span> (!statusObject.children) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; statusObject.children.length; i++) {
        <span class="hljs-keyword">var</span> child = statusObject.children[i];
        <span class="hljs-keyword">if</span> (child.state == <span class="hljs-string">'1'</span>) {
          <span class="hljs-keyword">var</span> msg = child.message;
          <span class="hljs-keyword">var</span> submsg = <span class="hljs-keyword">this</span>._findChildMessage(child);
          <span class="hljs-keyword">if</span> (submsg == <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">return</span> msg;
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (child.state == <span class="hljs-string">'0'</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">else</span> {}
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    },
    <span class="hljs-attr">create</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, elemid, title, startCallback, endCallback, closeCallback</span>) </span>{
      <span class="hljs-keyword">var</span> namespace = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> progressItem = scope.$<span class="hljs-keyword">new</span>(<span class="hljs-literal">true</span>);
      progressItem.id = elemid + <span class="hljs-string">"_progressDialog"</span>;
      progressItem.overlayVisible = <span class="hljs-literal">true</span>;
      progressItem.state = <span class="hljs-number">0</span>;
      progressItem.message = <span class="hljs-string">''</span>;
      progressItem.percentComplete = <span class="hljs-number">0</span>;
      progressItem.enableChildMessages = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (!title) title = <span class="hljs-string">''</span>;
      progressItem.title = title;
      progressItem.button_close = i18n.getMessage(<span class="hljs-string">'Close'</span>);
      <span class="hljs-keyword">var</span> overlayElement;
      overlayElement = $compile(
        <span class="hljs-string">'&lt;div id="{{id}}" ng-show="overlayVisible" class="modal modal-mask" role="dialog" tabindex="-1"&gt;'</span> +
        <span class="hljs-string">'&lt;div class="modal-dialog m_progress_overlay_content"&gt;'</span> +
        <span class="hljs-string">'&lt;div class="modal-content"&gt;'</span> +
        <span class="hljs-string">'&lt;header class="modal-header"&gt;'</span> +
        <span class="hljs-string">'&lt;h4 class="modal-title"&gt;{{title}}&lt;/h4&gt;'</span> +
        <span class="hljs-string">'&lt;/header&gt;'</span> +
        <span class="hljs-string">'&lt;div class="modal-body"&gt;'</span> +
        <span class="hljs-string">'&lt;div class="progress" ng-class="{\'progress-danger\': (state == 3)}"&gt;'</span> +
        <span class="hljs-string">'&lt;div class="progress-bar" ng-class="{\'progress-bar-danger\': (state == 3)}" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{percentComplete}}" ng-style="{width: percentComplete + \'%\'}"&gt;'</span> +
        <span class="hljs-string">'&lt;/div&gt;'</span> +
        <span class="hljs-string">'&lt;/div&gt;'</span> +
        <span class="hljs-string">'&lt;div&gt;{{message}}&lt;span style="float: right;" ng-show="state==1 || state == 2"&gt;{{percentComplete}}%&lt;/span&gt;&lt;/div&gt;'</span> +
        <span class="hljs-string">'&lt;/div&gt;'</span> +
        <span class="hljs-string">'&lt;footer class="modal-footer"&gt;'</span> +
        <span class="hljs-string">'&lt;button class="btn btn-default sn-button sn-button-normal" ng-click="close()" ng-show="state &gt; 1"&gt;{{button_close}}&lt;/button&gt;'</span> +
        <span class="hljs-string">'&lt;/footer&gt;'</span> +
        <span class="hljs-string">'&lt;/div&gt;'</span> +
        <span class="hljs-string">'&lt;/div&gt;'</span> +
        <span class="hljs-string">'&lt;/div&gt;'</span>)(progressItem);
      $(<span class="hljs-string">"body"</span>)[<span class="hljs-number">0</span>].appendChild(overlayElement[<span class="hljs-number">0</span>]);
      progressItem.setEnableChildMessages = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">enableChildren</span>) </span>{
        progressItem.enableChildMessages = enableChildren;
      }
      progressItem.start = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">src, dataArray</span>) </span>{
        $http.post(src, dataArray).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
            progressItem.trackerId = response;
            <span class="hljs-keyword">try</span> {
              <span class="hljs-keyword">if</span> (startCallback) startCallback(response);
            } <span class="hljs-keyword">catch</span> (e) {}
            $timeout(progressItem.checkProgress.bind(progressItem));
          })
          .error(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response, status, headers, config</span>) </span>{
            progressItem.state = <span class="hljs-string">'3'</span>;
            <span class="hljs-keyword">if</span> (endCallback) endCallback(response);
          });
      };
      progressItem.checkProgress = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> src = nowServer.getURL(<span class="hljs-string">'progress_status'</span>, {
          <span class="hljs-attr">sysparm_execution_id</span>: <span class="hljs-keyword">this</span>.trackerId
        });
        $http.post(src).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
            <span class="hljs-keyword">if</span> ($.isEmptyObject(response)) {
              progressItem.state = <span class="hljs-string">'3'</span>;
              <span class="hljs-keyword">if</span> (endCallback) endCallback(response);
              <span class="hljs-keyword">return</span>;
            }
            progressItem.update(response);
            <span class="hljs-keyword">if</span> (response.status == <span class="hljs-string">'error'</span> || response.state == <span class="hljs-string">''</span>) {
              progressItem.state = <span class="hljs-string">'3'</span>;
              <span class="hljs-keyword">if</span> (response.message)
                progressItem.message = response.message;
              <span class="hljs-keyword">else</span>
                progressItem.message = response;
              <span class="hljs-keyword">if</span> (endCallback) endCallback(response);
              <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">if</span> (response.state == <span class="hljs-string">'0'</span> || response.state == <span class="hljs-string">'1'</span>) {
              $timeout(progressItem.checkProgress.bind(progressItem), namespace.TIMEOUT_INTERVAL);
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">if</span> (endCallback) endCallback(response);
            }
          })
          .error(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response, status, headers, config</span>) </span>{
            progressItem.state = <span class="hljs-string">'3'</span>;
            progressItem.message = response;
            <span class="hljs-keyword">if</span> (endCallback) endCallback(response);
          });
      };
      progressItem.update = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">statusObject</span>) </span>{
        <span class="hljs-keyword">var</span> msg = statusObject.message;
        <span class="hljs-keyword">if</span> (progressItem.enableChildMessages) {
          <span class="hljs-keyword">var</span> childMsg = namespace._findChildMessage(statusObject);
          <span class="hljs-keyword">if</span> (childMsg != <span class="hljs-literal">null</span>)
            msg = childMsg;
        }
        <span class="hljs-keyword">this</span>.message = msg;
        <span class="hljs-keyword">this</span>.state = statusObject.state;
        <span class="hljs-keyword">this</span>.percentComplete = statusObject.percent_complete;
      };
      progressItem.close = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ev</span>) </span>{
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">if</span> (closeCallback) closeCallback();
        } <span class="hljs-keyword">catch</span> (e) {}
        $(<span class="hljs-string">"body"</span>)[<span class="hljs-number">0</span>].removeChild($(<span class="hljs-string">"#"</span> + <span class="hljs-keyword">this</span>.id)[<span class="hljs-number">0</span>]);
        <span class="hljs-keyword">delete</span> namespace.progressItem;
      };
      <span class="hljs-keyword">return</span> progressItem;
    }
  }
}]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/factory.paneManager.js */</span>
angular.module(<span class="hljs-string">"sn.common.ui"</span>).factory(<span class="hljs-string">"paneManager"</span>, [<span class="hljs-string">'$timeout'</span>, <span class="hljs-string">'userPreferences'</span>, <span class="hljs-string">'snCustomEvent'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout, userPreferences, snCustomEvent</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> paneIndex = {};

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerPane</span>(<span class="hljs-params">paneName</span>) </span>{
    <span class="hljs-keyword">if</span> (!paneName <span class="hljs-keyword">in</span> paneIndex) {
      paneIndex[paneName] = <span class="hljs-literal">false</span>;
    }
    userPreferences.getPreference(paneName + <span class="hljs-string">'.opened'</span>).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
      <span class="hljs-keyword">var</span> isOpen = value !== <span class="hljs-string">'false'</span>;
      <span class="hljs-keyword">if</span> (isOpen) {
        togglePane(paneName);
      }
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">togglePane</span>(<span class="hljs-params">paneName</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> currentPane <span class="hljs-keyword">in</span> paneIndex) {
      <span class="hljs-keyword">if</span> (paneName != currentPane &amp;&amp; paneIndex[currentPane]) {
        CustomEvent.fireTop(currentPane + <span class="hljs-string">'.toggle'</span>);
        saveState(currentPane, <span class="hljs-literal">false</span>);
      }
    }
    snCustomEvent.fireTop(paneName + <span class="hljs-string">'.toggle'</span>);
    saveState(paneName, !paneIndex[paneName]);
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveState</span>(<span class="hljs-params">paneName, state</span>) </span>{
    paneIndex[paneName] = state;
    userPreferences.setPreference(paneName + <span class="hljs-string">'.opened'</span>, state);
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">registerPane</span>: registerPane,
    <span class="hljs-attr">togglePane</span>: togglePane
  };
}]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/ui/directive.snBootstrapPopover.js */</span>
angular.module(<span class="hljs-string">'sn.common.ui'</span>).directive(<span class="hljs-string">'snBootstrapPopover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$timeout, $compile, $rootScope</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
      element.on(<span class="hljs-string">'click.snBootstrapPopover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
        $rootScope.$broadcast(<span class="hljs-string">'sn-bootstrap-popover.close-other-popovers'</span>);
        createPopover(event);
      });
      element.on(<span class="hljs-string">'keypress.snBootstrapPopover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
        <span class="hljs-keyword">if</span> (event.keyCode == <span class="hljs-number">9</span>)
          <span class="hljs-keyword">return</span>;
        scope.$broadcast(<span class="hljs-string">'sn-bootstrap-popover.close-other-popovers'</span>);
        createPopover(event);
      });
      <span class="hljs-keyword">var</span> popoverOpen = <span class="hljs-literal">false</span>;

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_hidePopover</span>(<span class="hljs-params"></span>) </span>{
        popoverOpen = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">var</span> api = element.data(<span class="hljs-string">'bs.popover'</span>);
        <span class="hljs-keyword">if</span> (api) {
          api.hide();
          element.off(<span class="hljs-string">'.popover'</span>).removeData(<span class="hljs-string">'bs.popover'</span>);
          element.data(<span class="hljs-string">'bs.popover'</span>, <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>));
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_openPopover</span>(<span class="hljs-params"></span>) </span>{
        $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          popoverOpen = <span class="hljs-literal">true</span>;
          element.on(<span class="hljs-string">'hidden.bs.popover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            _hidePopover();
            popoverOpen = <span class="hljs-literal">false</span>;
          });
          element.popover(<span class="hljs-string">'show'</span>);
        }, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createPopover</span>(<span class="hljs-params">evt</span>) </span>{
        angular.element(<span class="hljs-string">'.popover'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">var</span> object = angular.element(<span class="hljs-keyword">this</span>);
          <span class="hljs-keyword">if</span> (!object.is(evt.target) &amp;&amp; object.has(evt.target).length === <span class="hljs-number">0</span> &amp;&amp; angular.element(<span class="hljs-string">'.popover'</span>).has(evt.target).length === <span class="hljs-number">0</span>) {
            _hidePopover();
            object.popover(<span class="hljs-string">'hide'</span>);
          }
        });
        <span class="hljs-keyword">if</span> (scope.disablePopover || evt.keyCode === <span class="hljs-number">9</span>)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (popoverOpen) {
          _hidePopover();
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">var</span> childScope = scope.$<span class="hljs-keyword">new</span>();
        evt.stopPropagation();
        element.attr(<span class="hljs-string">'data-toggle'</span>, <span class="hljs-string">'popover'</span>);
        element.attr(<span class="hljs-string">'data-trigger'</span>, <span class="hljs-string">'focus'</span>);
        element.attr(<span class="hljs-string">'tabindex'</span>, <span class="hljs-number">0</span>);
        angular.element(element).popover({
          <span class="hljs-attr">container</span>: <span class="hljs-string">'body'</span>,
          <span class="hljs-attr">placement</span>: <span class="hljs-string">'auto top'</span>,
          <span class="hljs-attr">html</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">trigger</span>: <span class="hljs-string">'manual'</span>,
          <span class="hljs-attr">content</span>: $compile(scope.template)(childScope)
        });
        <span class="hljs-keyword">var</span> wait = element.attr(<span class="hljs-string">'popover-wait-event'</span>);
        <span class="hljs-keyword">if</span> (wait)
          scope.$on(wait, _openPopover);
        <span class="hljs-keyword">else</span>
          _openPopover();
        <span class="hljs-keyword">var</span> bodyClickEvent = angular.element(<span class="hljs-string">'body'</span>).on(<span class="hljs-string">'click.snBootstrapPopover.body'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
          angular.element(<span class="hljs-string">'.popover'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> object = angular.element(<span class="hljs-keyword">this</span>);
            <span class="hljs-keyword">if</span> (!object.is(evt.target) &amp;&amp; object.has(evt.target).length === <span class="hljs-number">0</span> &amp;&amp; angular.element(<span class="hljs-string">'.popover'</span>).has(evt.target).length === <span class="hljs-number">0</span>) {
              bodyClickEvent.off();
              _hidePopover();
              childScope.$destroy();
            }
          })
        });
        element.on(<span class="hljs-string">'$destroy'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          bodyClickEvent.off();
          _hidePopover();
          childScope.$destroy();
        })
      };
    }
  }
});;;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/stream/js_includes_stream.js */</span>
<span class="hljs-comment">/*! RESOURCE: /scripts/thirdparty/ment.io/mentio.js */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  'use strict'</span>;
  angular.module(<span class="hljs-string">'mentio'</span>, [])
    .directive(<span class="hljs-string">'mentio'</span>, [<span class="hljs-string">'mentioUtil'</span>, <span class="hljs-string">'$document'</span>, <span class="hljs-string">'$compile'</span>, <span class="hljs-string">'$log'</span>, <span class="hljs-string">'$timeout'</span>,
      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mentioUtil, $document, $compile, $log, $timeout</span>) </span>{
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
          <span class="hljs-attr">scope</span>: {
            <span class="hljs-attr">macros</span>: <span class="hljs-string">'=mentioMacros'</span>,
            <span class="hljs-attr">search</span>: <span class="hljs-string">'&amp;mentioSearch'</span>,
            <span class="hljs-attr">select</span>: <span class="hljs-string">'&amp;mentioSelect'</span>,
            <span class="hljs-attr">items</span>: <span class="hljs-string">'=mentioItems'</span>,
            <span class="hljs-attr">typedTerm</span>: <span class="hljs-string">'=mentioTypedTerm'</span>,
            <span class="hljs-attr">altId</span>: <span class="hljs-string">'=mentioId'</span>,
            <span class="hljs-attr">iframeElement</span>: <span class="hljs-string">'=mentioIframeElement'</span>,
            <span class="hljs-attr">requireLeadingSpace</span>: <span class="hljs-string">'=mentioRequireLeadingSpace'</span>,
            <span class="hljs-attr">suppressTrailingSpace</span>: <span class="hljs-string">'=mentioSuppressTrailingSpace'</span>,
            <span class="hljs-attr">selectNotFound</span>: <span class="hljs-string">'=mentioSelectNotFound'</span>,
            <span class="hljs-attr">trimTerm</span>: <span class="hljs-string">'=mentioTrimTerm'</span>,
            <span class="hljs-attr">ngModel</span>: <span class="hljs-string">'='</span>
          },
          <span class="hljs-attr">controller</span>: [<span class="hljs-string">"$scope"</span>, <span class="hljs-string">"$timeout"</span>, <span class="hljs-string">"$attrs"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $timeout, $attrs</span>) </span>{
            $scope.query = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">triggerChar, triggerText</span>) </span>{
              <span class="hljs-keyword">var</span> remoteScope = $scope.triggerCharMap[triggerChar];
              <span class="hljs-keyword">if</span> ($scope.trimTerm === <span class="hljs-literal">undefined</span> || $scope.trimTerm) {
                triggerText = triggerText.trim();
              }
              remoteScope.showMenu();
              remoteScope.search({
                <span class="hljs-attr">term</span>: triggerText
              });
              remoteScope.typedTerm = triggerText;
            };
            $scope.defaultSearch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">locals</span>) </span>{
              <span class="hljs-keyword">var</span> results = [];
              angular.forEach($scope.items, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
                <span class="hljs-keyword">if</span> (item.label.toUpperCase().indexOf(locals.term.toUpperCase()) &gt;= <span class="hljs-number">0</span>) {
                  results.push(item);
                }
              });
              $scope.localItems = results;
            };
            $scope.bridgeSearch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">termString</span>) </span>{
              <span class="hljs-keyword">var</span> searchFn = $attrs.mentioSearch ? $scope.search : $scope.defaultSearch;
              searchFn({
                <span class="hljs-attr">term</span>: termString
              });
            };
            $scope.defaultSelect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">locals</span>) </span>{
              <span class="hljs-keyword">return</span> $scope.defaultTriggerChar + locals.item.label;
            };
            $scope.bridgeSelect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">itemVar</span>) </span>{
              <span class="hljs-keyword">var</span> selectFn = $attrs.mentioSelect ? $scope.select : $scope.defaultSelect;
              <span class="hljs-keyword">return</span> selectFn({
                <span class="hljs-attr">item</span>: itemVar
              });
            };
            $scope.setTriggerText = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text</span>) </span>{
              <span class="hljs-keyword">if</span> ($scope.syncTriggerText) {
                $scope.typedTerm = ($scope.trimTerm === <span class="hljs-literal">undefined</span> || $scope.trimTerm) ? text.trim() : text;
              }
            };
            $scope.context = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">if</span> ($scope.iframeElement) {
                <span class="hljs-keyword">return</span> {
                  <span class="hljs-attr">iframe</span>: $scope.iframeElement
                };
              }
            };
            $scope.replaceText = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text, hasTrailingSpace</span>) </span>{
              $scope.hideAll();
              mentioUtil.replaceTriggerText($scope.context(), $scope.targetElement, $scope.targetElementPath,
                $scope.targetElementSelectedOffset, $scope.triggerCharSet, text, $scope.requireLeadingSpace,
                hasTrailingSpace, $scope.suppressTrailingSpace);
              <span class="hljs-keyword">if</span> (!hasTrailingSpace) {
                $scope.setTriggerText(<span class="hljs-string">''</span>);
                angular.element($scope.targetElement).triggerHandler(<span class="hljs-string">'change'</span>);
                <span class="hljs-keyword">if</span> ($scope.isContentEditable()) {
                  $scope.contentEditableMenuPasted = <span class="hljs-literal">true</span>;
                  <span class="hljs-keyword">var</span> timer = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    $scope.contentEditableMenuPasted = <span class="hljs-literal">false</span>;
                  }, <span class="hljs-number">200</span>);
                  $scope.$on(<span class="hljs-string">'$destroy'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    $timeout.cancel(timer);
                  });
                }
              }
            };
            $scope.hideAll = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> $scope.triggerCharMap) {
                <span class="hljs-keyword">if</span> ($scope.triggerCharMap.hasOwnProperty(key)) {
                  $scope.triggerCharMap[key].hideMenu();
                }
              }
            };
            $scope.getActiveMenuScope = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> $scope.triggerCharMap) {
                <span class="hljs-keyword">if</span> ($scope.triggerCharMap.hasOwnProperty(key)) {
                  <span class="hljs-keyword">if</span> ($scope.triggerCharMap[key].visible) {
                    <span class="hljs-keyword">return</span> $scope.triggerCharMap[key];
                  }
                }
              }
              <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            };
            $scope.selectActive = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> $scope.triggerCharMap) {
                <span class="hljs-keyword">if</span> ($scope.triggerCharMap.hasOwnProperty(key)) {
                  <span class="hljs-keyword">if</span> ($scope.triggerCharMap[key].visible) {
                    $scope.triggerCharMap[key].selectActive();
                  }
                }
              }
            };
            $scope.isActive = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> $scope.triggerCharMap) {
                <span class="hljs-keyword">if</span> ($scope.triggerCharMap.hasOwnProperty(key)) {
                  <span class="hljs-keyword">if</span> ($scope.triggerCharMap[key].visible) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                  }
                }
              }
              <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            };
            $scope.isContentEditable = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">return</span> ($scope.targetElement.nodeName !== <span class="hljs-string">'INPUT'</span> &amp;&amp; $scope.targetElement.nodeName !== <span class="hljs-string">'TEXTAREA'</span>);
            };
            $scope.replaceMacro = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">macro, hasTrailingSpace</span>) </span>{
              <span class="hljs-keyword">if</span> (!hasTrailingSpace) {
                $scope.replacingMacro = <span class="hljs-literal">true</span>;
                $scope.timer = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                  mentioUtil.replaceMacroText($scope.context(), $scope.targetElement,
                    $scope.targetElementPath, $scope.targetElementSelectedOffset,
                    $scope.macros, $scope.macros[macro]);
                  angular.element($scope.targetElement).triggerHandler(<span class="hljs-string">'change'</span>);
                  $scope.replacingMacro = <span class="hljs-literal">false</span>;
                }, <span class="hljs-number">300</span>);
                $scope.$on(<span class="hljs-string">'$destroy'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                  $timeout.cancel($scope.timer);
                });
              } <span class="hljs-keyword">else</span> {
                mentioUtil.replaceMacroText($scope.context(), $scope.targetElement, $scope.targetElementPath,
                  $scope.targetElementSelectedOffset, $scope.macros, $scope.macros[macro]);
              }
            };
            $scope.addMenu = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">menuScope</span>) </span>{
              <span class="hljs-keyword">if</span> (menuScope.parentScope &amp;&amp; $scope.triggerCharMap.hasOwnProperty(menuScope.triggerChar)) {
                <span class="hljs-keyword">return</span>;
              }
              $scope.triggerCharMap[menuScope.triggerChar] = menuScope;
              <span class="hljs-keyword">if</span> ($scope.triggerCharSet === <span class="hljs-literal">undefined</span>) {
                $scope.triggerCharSet = [];
              }
              $scope.triggerCharSet.push(menuScope.triggerChar);
              menuScope.setParent($scope);
            };
            $scope.$on(
              <span class="hljs-string">'menuCreated'</span>,
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, data</span>) </span>{
                <span class="hljs-keyword">if</span> (
                  $attrs.id !== <span class="hljs-literal">undefined</span> ||
                  $attrs.mentioId !== <span class="hljs-literal">undefined</span>
                ) {
                  <span class="hljs-keyword">if</span> (
                    $attrs.id === data.targetElement ||
                    (
                      $attrs.mentioId !== <span class="hljs-literal">undefined</span> &amp;&amp;
                      $scope.altId === data.targetElement
                    )
                  ) {
                    $scope.addMenu(data.scope);
                  }
                }
              }
            );
            $<span class="hljs-built_in">document</span>.on(
              <span class="hljs-string">'click'</span>,
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> ($scope.isActive()) {
                  $scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    $scope.hideAll();
                  });
                }
              }
            );
            $<span class="hljs-built_in">document</span>.on(
              <span class="hljs-string">'keydown keypress paste'</span>,
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
                <span class="hljs-keyword">var</span> activeMenuScope = $scope.getActiveMenuScope();
                <span class="hljs-keyword">if</span> (activeMenuScope) {
                  <span class="hljs-keyword">if</span> (event.which === <span class="hljs-number">9</span> || event.which === <span class="hljs-number">13</span>) {
                    event.preventDefault();
                    activeMenuScope.selectActive();
                  }
                  <span class="hljs-keyword">if</span> (event.which === <span class="hljs-number">27</span>) {
                    event.preventDefault();
                    activeMenuScope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                      activeMenuScope.hideMenu();
                    });
                  }
                  <span class="hljs-keyword">if</span> (event.which === <span class="hljs-number">40</span>) {
                    event.preventDefault();
                    activeMenuScope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                      activeMenuScope.activateNextItem();
                    });
                    activeMenuScope.adjustScroll(<span class="hljs-number">1</span>);
                  }
                  <span class="hljs-keyword">if</span> (event.which === <span class="hljs-number">38</span>) {
                    event.preventDefault();
                    activeMenuScope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                      activeMenuScope.activatePreviousItem();
                    });
                    activeMenuScope.adjustScroll(<span class="hljs-number">-1</span>);
                  }
                  <span class="hljs-keyword">if</span> (event.which === <span class="hljs-number">37</span> || event.which === <span class="hljs-number">39</span>) {
                    event.preventDefault();
                  }
                }
              }
            );
          }],
          <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs, $timeout</span>) </span>{
            scope.triggerCharMap = {};
            scope.targetElement = element;
            scope.scrollBarParents = element.parents().filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">var</span> overflow = angular.element(<span class="hljs-keyword">this</span>).css(<span class="hljs-string">"overflow"</span>);
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.scrollHeight &gt; <span class="hljs-keyword">this</span>.clientHeight &amp;&amp; overflow !== <span class="hljs-string">"hidden"</span> &amp;&amp; overflow !== <span class="hljs-string">"visible"</span>;
            });
            scope.scrollPosition = <span class="hljs-literal">null</span>;
            attrs.$set(<span class="hljs-string">'autocomplete'</span>, <span class="hljs-string">'off'</span>);
            <span class="hljs-keyword">if</span> (attrs.mentioItems) {
              scope.localItems = [];
              scope.parentScope = scope;
              <span class="hljs-keyword">var</span> itemsRef = attrs.mentioSearch ? <span class="hljs-string">' mentio-items="items"'</span> : <span class="hljs-string">' mentio-items="localItems"'</span>;
              scope.defaultTriggerChar = attrs.mentioTriggerChar ? scope.$<span class="hljs-built_in">eval</span>(attrs.mentioTriggerChar) : <span class="hljs-string">'@'</span>;
              <span class="hljs-keyword">var</span> html = <span class="hljs-string">'&lt;mentio-menu'</span> +
                <span class="hljs-string">' mentio-search="bridgeSearch(term)"'</span> +
                <span class="hljs-string">' mentio-select="bridgeSelect(item)"'</span> +
                itemsRef;
              <span class="hljs-keyword">if</span> (attrs.mentioTemplateUrl) {
                html = html + <span class="hljs-string">' mentio-template-url="'</span> + attrs.mentioTemplateUrl + <span class="hljs-string">'"'</span>;
              }
              html = html + <span class="hljs-string">' mentio-trigger-char="\''</span> + scope.defaultTriggerChar + <span class="hljs-string">'\'"'</span> +
                <span class="hljs-string">' mentio-parent-scope="parentScope"'</span> +
                <span class="hljs-string">'/&gt;'</span>;
              <span class="hljs-keyword">var</span> linkFn = $compile(html);
              <span class="hljs-keyword">var</span> el = linkFn(scope);
              element.parent().append(el);
              scope.$on(<span class="hljs-string">'$destroy'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                el.remove();
              });
            }
            <span class="hljs-keyword">if</span> (attrs.mentioTypedTerm) {
              scope.syncTriggerText = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">keyHandler</span>(<span class="hljs-params">event</span>) </span>{
              <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stopEvent</span>(<span class="hljs-params">event</span>) </span>{
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
              }
              <span class="hljs-keyword">var</span> activeMenuScope = scope.getActiveMenuScope();
              <span class="hljs-keyword">if</span> (activeMenuScope) {
                <span class="hljs-keyword">if</span> (event.which === <span class="hljs-number">9</span> || event.which === <span class="hljs-number">13</span>) {
                  stopEvent(event);
                  activeMenuScope.selectActive();
                  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                <span class="hljs-keyword">if</span> (event.which === <span class="hljs-number">27</span>) {
                  stopEvent(event);
                  activeMenuScope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    activeMenuScope.hideMenu();
                  });
                  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                <span class="hljs-keyword">if</span> (event.which === <span class="hljs-number">40</span>) {
                  stopEvent(event);
                  activeMenuScope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    activeMenuScope.activateNextItem();
                  });
                  activeMenuScope.adjustScroll(<span class="hljs-number">1</span>);
                  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                <span class="hljs-keyword">if</span> (event.which === <span class="hljs-number">38</span>) {
                  stopEvent(event);
                  activeMenuScope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    activeMenuScope.activatePreviousItem();
                  });
                  activeMenuScope.adjustScroll(<span class="hljs-number">-1</span>);
                  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                <span class="hljs-keyword">if</span> (event.which === <span class="hljs-number">37</span> || event.which === <span class="hljs-number">39</span>) {
                  stopEvent(event);
                  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
              }
            }
            scope.$watch(
              <span class="hljs-string">'iframeElement'</span>,
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>) </span>{
                <span class="hljs-keyword">if</span> (newValue) {
                  <span class="hljs-keyword">var</span> iframeDocument = newValue.contentWindow.document;
                  iframeDocument.addEventListener(<span class="hljs-string">'click'</span>,
                    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                      <span class="hljs-keyword">if</span> (scope.isActive()) {
                        scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                          scope.hideAll();
                        });
                      }
                    }
                  );
                  iframeDocument.addEventListener(<span class="hljs-string">'keydown'</span>, keyHandler, <span class="hljs-literal">true</span>);
                  scope.$on(<span class="hljs-string">'$destroy'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    iframeDocument.removeEventListener(<span class="hljs-string">'keydown'</span>, keyHandler);
                  });
                }
              }
            );
            scope.$watch(
              <span class="hljs-string">'ngModel'</span>,
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>) </span>{
                <span class="hljs-keyword">if</span> ((!newValue || newValue === <span class="hljs-string">''</span>) &amp;&amp; !scope.isActive()) {
                  <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-keyword">if</span> (scope.triggerCharSet === <span class="hljs-literal">undefined</span>) {
                  $log.warn(<span class="hljs-string">'Error, no mentio-items attribute was provided, '</span> +
                    <span class="hljs-string">'and no separate mentio-menus were specified.  Nothing to do.'</span>);
                  <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-keyword">if</span> (scope.contentEditableMenuPasted) {
                  scope.contentEditableMenuPasted = <span class="hljs-literal">false</span>;
                  <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-keyword">if</span> (scope.replacingMacro) {
                  $timeout.cancel(scope.timer);
                  scope.replacingMacro = <span class="hljs-literal">false</span>;
                }
                <span class="hljs-keyword">var</span> isActive = scope.isActive();
                <span class="hljs-keyword">var</span> isContentEditable = scope.isContentEditable();
                <span class="hljs-keyword">var</span> mentionInfo = mentioUtil.getTriggerInfo(scope.context(), scope.triggerCharSet,
                  scope.requireLeadingSpace, isActive);
                <span class="hljs-keyword">if</span> (mentionInfo !== <span class="hljs-literal">undefined</span> &amp;&amp;
                  (!isActive ||
                    (isActive &amp;&amp;
                      (
                        (isContentEditable &amp;&amp; mentionInfo.mentionTriggerChar ===
                          scope.currentMentionTriggerChar) ||
                        (!isContentEditable &amp;&amp; mentionInfo.mentionPosition ===
                          scope.currentMentionPosition)
                      )
                    )
                  )
                ) {
                  <span class="hljs-keyword">if</span> (mentionInfo.mentionSelectedElement) {
                    scope.targetElement = mentionInfo.mentionSelectedElement;
                    scope.targetElementPath = mentionInfo.mentionSelectedPath;
                    scope.targetElementSelectedOffset = mentionInfo.mentionSelectedOffset;
                  }
                  scope.setTriggerText(mentionInfo.mentionText);
                  scope.currentMentionPosition = mentionInfo.mentionPosition;
                  scope.currentMentionTriggerChar = mentionInfo.mentionTriggerChar;
                  scope.query(mentionInfo.mentionTriggerChar, mentionInfo.mentionText);
                } <span class="hljs-keyword">else</span> {
                  <span class="hljs-keyword">var</span> currentTypedTerm = scope.typedTerm;
                  scope.setTriggerText(<span class="hljs-string">''</span>);
                  scope.hideAll();
                  <span class="hljs-keyword">var</span> macroMatchInfo = mentioUtil.getMacroMatch(scope.context(), scope.macros);
                  <span class="hljs-keyword">if</span> (macroMatchInfo !== <span class="hljs-literal">undefined</span>) {
                    scope.targetElement = macroMatchInfo.macroSelectedElement;
                    scope.targetElementPath = macroMatchInfo.macroSelectedPath;
                    scope.targetElementSelectedOffset = macroMatchInfo.macroSelectedOffset;
                    scope.replaceMacro(macroMatchInfo.macroText, macroMatchInfo.macroHasTrailingSpace);
                  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scope.selectNotFound &amp;&amp; currentTypedTerm &amp;&amp; currentTypedTerm !== <span class="hljs-string">''</span>) {
                    <span class="hljs-keyword">var</span> lastScope = scope.triggerCharMap[scope.currentMentionTriggerChar];
                    <span class="hljs-keyword">if</span> (lastScope) {
                      <span class="hljs-keyword">var</span> text = lastScope.select({
                        <span class="hljs-attr">item</span>: {
                          <span class="hljs-attr">label</span>: currentTypedTerm
                        }
                      });
                      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> text.then === <span class="hljs-string">'function'</span>) {
                        text.then(scope.replaceText);
                      } <span class="hljs-keyword">else</span> {
                        scope.replaceText(text, <span class="hljs-literal">true</span>);
                      }
                    }
                  }
                }
              }
            );
          }
        };
      }
    ])
    .directive(<span class="hljs-string">'mentioMenu'</span>, [<span class="hljs-string">'mentioUtil'</span>, <span class="hljs-string">'$rootScope'</span>, <span class="hljs-string">'$log'</span>, <span class="hljs-string">'$window'</span>, <span class="hljs-string">'$document'</span>, <span class="hljs-string">'$timeout'</span>,
      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mentioUtil, $rootScope, $log, $window, $document, $timeout</span>) </span>{
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">restrict</span>: <span class="hljs-string">'E'</span>,
          <span class="hljs-attr">scope</span>: {
            <span class="hljs-attr">search</span>: <span class="hljs-string">'&amp;mentioSearch'</span>,
            <span class="hljs-attr">select</span>: <span class="hljs-string">'&amp;mentioSelect'</span>,
            <span class="hljs-attr">items</span>: <span class="hljs-string">'=mentioItems'</span>,
            <span class="hljs-attr">triggerChar</span>: <span class="hljs-string">'=mentioTriggerChar'</span>,
            <span class="hljs-attr">forElem</span>: <span class="hljs-string">'=mentioFor'</span>,
            <span class="hljs-attr">parentScope</span>: <span class="hljs-string">'=mentioParentScope'</span>
          },
          <span class="hljs-attr">templateUrl</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tElement, tAttrs</span>) </span>{
            <span class="hljs-keyword">return</span> tAttrs.mentioTemplateUrl !== <span class="hljs-literal">undefined</span> ? tAttrs.mentioTemplateUrl : <span class="hljs-string">'mentio-menu.tpl.html'</span>;
          },
          <span class="hljs-attr">controller</span>: [<span class="hljs-string">"$scope"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
            $scope.visible = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">this</span>.activate = $scope.activate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
              $scope.activeItem = item;
            };
            <span class="hljs-keyword">this</span>.isActive = $scope.isActive = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
              <span class="hljs-keyword">return</span> $scope.activeItem === item;
            };
            <span class="hljs-keyword">this</span>.selectItem = $scope.selectItem = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
              <span class="hljs-keyword">if</span> (item.termLengthIsZero) {
                item.name = $scope.triggerChar + $scope.typedTerm
              }
              <span class="hljs-keyword">var</span> text = $scope.select({
                <span class="hljs-attr">item</span>: item
              });
              <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> text.then === <span class="hljs-string">'function'</span>) {
                text.then($scope.parentMentio.replaceText);
              } <span class="hljs-keyword">else</span> {
                $scope.parentMentio.replaceText(text);
              }
            };
            $scope.activateNextItem = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">var</span> index = $scope.items.indexOf($scope.activeItem);
              <span class="hljs-keyword">this</span>.activate($scope.items[(index + <span class="hljs-number">1</span>) % $scope.items.length]);
            };
            $scope.activatePreviousItem = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">var</span> index = $scope.items.indexOf($scope.activeItem);
              <span class="hljs-keyword">this</span>.activate($scope.items[index === <span class="hljs-number">0</span> ? $scope.items.length - <span class="hljs-number">1</span> : index - <span class="hljs-number">1</span>]);
            };
            $scope.isFirstItemActive = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">var</span> index = $scope.items.indexOf($scope.activeItem);
              <span class="hljs-keyword">return</span> index === <span class="hljs-number">0</span>;
            };
            $scope.isLastItemActive = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">var</span> index = $scope.items.indexOf($scope.activeItem);
              <span class="hljs-keyword">return</span> index === ($scope.items.length - <span class="hljs-number">1</span>);
            };
            $scope.selectActive = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              $scope.selectItem($scope.activeItem);
            };
            $scope.isVisible = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">return</span> $scope.visible;
            };
            $scope.showMenu = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">if</span> (!$scope.visible) {
                $scope.menuElement.css(<span class="hljs-string">"visibility"</span>, <span class="hljs-string">"visible"</span>);
                $scope.requestVisiblePendingSearch = <span class="hljs-literal">true</span>;
              }
            };
            $scope.setParent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope</span>) </span>{
              $scope.parentMentio = scope;
              $scope.targetElement = scope.targetElement;
            };
            <span class="hljs-keyword">var</span> scopeDuplicate = $scope;
            $rootScope.$on(<span class="hljs-string">'mentio.closeMenu'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              scopeDuplicate.hideMenu();
            })
          }],
          <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
            element[<span class="hljs-number">0</span>].parentNode.removeChild(element[<span class="hljs-number">0</span>]);
            $<span class="hljs-built_in">document</span>[<span class="hljs-number">0</span>].body.appendChild(element[<span class="hljs-number">0</span>]);
            scope.menuElement = element;
            scope.menuElement.css(<span class="hljs-string">"visibility"</span>, <span class="hljs-string">"hidden"</span>);
            <span class="hljs-keyword">if</span> (scope.parentScope) {
              scope.parentScope.addMenu(scope);
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">if</span> (!scope.forElem) {
                $log.error(<span class="hljs-string">'mentio-menu requires a target element in tbe mentio-for attribute'</span>);
                <span class="hljs-keyword">return</span>;
              }
              <span class="hljs-keyword">if</span> (!scope.triggerChar) {
                $log.error(<span class="hljs-string">'mentio-menu requires a trigger char'</span>);
                <span class="hljs-keyword">return</span>;
              }
              $rootScope.$broadcast(<span class="hljs-string">'menuCreated'</span>, {
                <span class="hljs-attr">targetElement</span>: scope.forElem,
                <span class="hljs-attr">scope</span>: scope
              });
            }
            angular.element($<span class="hljs-built_in">window</span>).bind(
              <span class="hljs-string">'resize'</span>,
              <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (scope.isVisible()) {
                  <span class="hljs-keyword">var</span> triggerCharSet = [];
                  triggerCharSet.push(scope.triggerChar);
                  mentioUtil.popUnderMention(scope.parentMentio.context(),
                    triggerCharSet, element, scope.requireLeadingSpace);
                }
              }
            );
            scope.$watch(<span class="hljs-string">'items'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">items</span>) </span>{
              <span class="hljs-keyword">if</span> (items &amp;&amp; items.length &gt; <span class="hljs-number">0</span>) {
                scope.activate(items[<span class="hljs-number">0</span>]);
                <span class="hljs-keyword">if</span> (!scope.visible &amp;&amp; scope.requestVisiblePendingSearch) {
                  scope.visible = <span class="hljs-literal">true</span>;
                  scope.requestVisiblePendingSearch = <span class="hljs-literal">false</span>;
                }
                $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                  <span class="hljs-keyword">var</span> menu = element.find(<span class="hljs-string">".dropdown-menu"</span>);
                  <span class="hljs-keyword">if</span> (menu.length &gt; <span class="hljs-number">0</span> &amp;&amp; menu.offset().top &lt; <span class="hljs-number">0</span>)
                    menu.addClass(<span class="hljs-string">"reverse"</span>);
                }, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);
              } <span class="hljs-keyword">else</span> {
                scope.activate({
                  <span class="hljs-attr">termLengthIsZero</span>: <span class="hljs-literal">true</span>
                });
              }
            });
            scope.$watch(<span class="hljs-string">'isVisible()'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">visible</span>) </span>{
              <span class="hljs-keyword">if</span> (visible) {
                <span class="hljs-keyword">var</span> triggerCharSet = [];
                triggerCharSet.push(scope.triggerChar);
                mentioUtil.popUnderMention(scope.parentMentio.context(),
                  triggerCharSet, element, scope.requireLeadingSpace);
              } <span class="hljs-keyword">else</span> {
                element.find(<span class="hljs-string">".dropdown-menu"</span>).removeClass(<span class="hljs-string">"reverse"</span>);
              }
            });
            <span class="hljs-keyword">var</span> prevScroll;
            scope.parentMentio.scrollBarParents.each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              angular.element(<span class="hljs-keyword">this</span>).on(<span class="hljs-string">"scroll.mentio"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (!prevScroll)
                  prevScroll = <span class="hljs-keyword">this</span>.scrollTop;
                <span class="hljs-keyword">var</span> scrollDiff = prevScroll - <span class="hljs-keyword">this</span>.scrollTop;
                prevScroll = <span class="hljs-keyword">this</span>.scrollTop;
                <span class="hljs-keyword">if</span> (element[<span class="hljs-number">0</span>].style[<span class="hljs-string">"position"</span>] === <span class="hljs-string">"absolute"</span>) {
                  element[<span class="hljs-number">0</span>].style[<span class="hljs-string">"z-index"</span>] = <span class="hljs-number">9</span>;
                  element[<span class="hljs-number">0</span>].style.top = (<span class="hljs-built_in">parseInt</span>(element[<span class="hljs-number">0</span>].style.top) + scrollDiff) + <span class="hljs-string">"px"</span>;
                }
              });
            });
            scope.parentMentio.$on(<span class="hljs-string">'$destroy'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              element.remove();
            });
            scope.hideMenu = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              scope.visible = <span class="hljs-literal">false</span>;
              element.css(<span class="hljs-string">'display'</span>, <span class="hljs-string">'none'</span>);
            };
            scope.adjustScroll = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">direction</span>) </span>{
              <span class="hljs-keyword">var</span> menuEl = element[<span class="hljs-number">0</span>];
              <span class="hljs-keyword">var</span> menuItemsList = menuEl.querySelector(<span class="hljs-string">'ul'</span>);
              <span class="hljs-keyword">var</span> menuItem = menuEl.querySelector(<span class="hljs-string">'[mentio-menu-item].active'</span>);
              <span class="hljs-keyword">if</span> (scope.isFirstItemActive()) {
                <span class="hljs-keyword">return</span> menuItemsList.scrollTop = <span class="hljs-number">0</span>;
              } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scope.isLastItemActive()) {
                <span class="hljs-keyword">return</span> menuItemsList.scrollTop = menuItemsList.scrollHeight;
              }
              <span class="hljs-keyword">if</span> (direction === <span class="hljs-number">1</span>) {
                menuItemsList.scrollTop += menuItem.offsetHeight;
              } <span class="hljs-keyword">else</span> {
                menuItemsList.scrollTop -= menuItem.offsetHeight;
              }
            };
          }
        };
      }
    ])
    .directive(<span class="hljs-string">'mentioMenuItem'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
        <span class="hljs-attr">scope</span>: {
          <span class="hljs-attr">item</span>: <span class="hljs-string">'=mentioMenuItem'</span>
        },
        <span class="hljs-attr">require</span>: <span class="hljs-string">'^mentioMenu'</span>,
        <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element, attrs, controller</span>) </span>{
          scope.$watch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> controller.isActive(scope.item);
          }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">active</span>) </span>{
            <span class="hljs-keyword">if</span> (active) {
              element.addClass(<span class="hljs-string">'active'</span>);
            } <span class="hljs-keyword">else</span> {
              element.removeClass(<span class="hljs-string">'active'</span>);
            }
          });
          element.bind(<span class="hljs-string">'mouseenter'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            scope.$apply(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              controller.activate(scope.item);
            });
          });
          element.bind(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            controller.selectItem(scope.item);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
          });
        }
      };
    })
    .filter(<span class="hljs-string">'unsafe'</span>, [<span class="hljs-string">"$sce"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$sce</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>) </span>{
        <span class="hljs-keyword">return</span> $sce.trustAsHtml(val);
      };
    }])
    .filter(<span class="hljs-string">'mentioHighlight'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">escapeRegexp</span>(<span class="hljs-params">queryToEscape</span>) </span>{
        <span class="hljs-keyword">return</span> queryToEscape.replace(<span class="hljs-regexp">/([.?*+^$[\]\\(){}|-])/g</span>, <span class="hljs-string">'\\$1'</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">matchItem, query, hightlightClass</span>) </span>{
        <span class="hljs-keyword">if</span> (query) {
          <span class="hljs-keyword">var</span> replaceText = hightlightClass ?
            <span class="hljs-string">'&lt;span class="'</span> + hightlightClass + <span class="hljs-string">'"&gt;$&amp;&lt;/span&gt;'</span> :
            <span class="hljs-string">'&lt;strong&gt;$&amp;&lt;/strong&gt;'</span>;
          <span class="hljs-keyword">return</span> (<span class="hljs-string">''</span> + matchItem).replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(escapeRegexp(query), <span class="hljs-string">'gi'</span>), replaceText);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> matchItem;
        }
      };
    });
  <span class="hljs-string">'use strict'</span>;
  angular.module(<span class="hljs-string">'mentio'</span>)
    .factory(<span class="hljs-string">'mentioUtil'</span>, [<span class="hljs-string">"$window"</span>, <span class="hljs-string">"$location"</span>, <span class="hljs-string">"$anchorScroll"</span>, <span class="hljs-string">"$timeout"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$window, $location, $anchorScroll, $timeout</span>) </span>{
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">popUnderMention</span>(<span class="hljs-params">ctx, triggerCharSet, selectionEl, requireLeadingSpace</span>) </span>{
        <span class="hljs-keyword">var</span> coordinates;
        <span class="hljs-keyword">var</span> mentionInfo = getTriggerInfo(ctx, triggerCharSet, requireLeadingSpace, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">if</span> (mentionInfo !== <span class="hljs-literal">undefined</span>) {
          <span class="hljs-keyword">if</span> (selectedElementIsTextAreaOrInput(ctx)) {
            coordinates = getTextAreaOrInputUnderlinePosition(ctx, getDocument(ctx).activeElement,
              mentionInfo.mentionPosition);
          } <span class="hljs-keyword">else</span> {
            coordinates = getContentEditableCaretPosition(ctx, mentionInfo.mentionPosition);
          }
          selectionEl.css({
            <span class="hljs-attr">top</span>: coordinates.top + <span class="hljs-string">'px'</span>,
            <span class="hljs-attr">left</span>: coordinates.left + <span class="hljs-string">'px'</span>,
            <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
            <span class="hljs-attr">zIndex</span>: <span class="hljs-number">5000</span>,
            <span class="hljs-attr">display</span>: <span class="hljs-string">'block'</span>
          });
          $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            scrollIntoView(ctx, selectionEl);
          }, <span class="hljs-number">0</span>);
        } <span class="hljs-keyword">else</span> {
          selectionEl.css({
            <span class="hljs-attr">display</span>: <span class="hljs-string">'none'</span>
          });
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scrollIntoView</span>(<span class="hljs-params">ctx, elem</span>) </span>{
        <span class="hljs-keyword">var</span> reasonableBuffer = <span class="hljs-number">20</span>;
        <span class="hljs-keyword">var</span> maxScrollDisplacement = <span class="hljs-number">100</span>;
        <span class="hljs-keyword">var</span> clientRect;
        <span class="hljs-keyword">var</span> e = elem[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">while</span> (clientRect === <span class="hljs-literal">undefined</span> || clientRect.height === <span class="hljs-number">0</span>) {
          clientRect = e.getBoundingClientRect();
          <span class="hljs-keyword">if</span> (clientRect.height === <span class="hljs-number">0</span>) {
            e = e.childNodes[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">if</span> (e === <span class="hljs-literal">undefined</span> || !e.getBoundingClientRect) {
              <span class="hljs-keyword">return</span>;
            }
          }
        }
        <span class="hljs-keyword">var</span> elemTop = clientRect.top;
        <span class="hljs-keyword">var</span> elemBottom = elemTop + clientRect.height;
        <span class="hljs-keyword">if</span> (elemTop &lt; <span class="hljs-number">0</span>) {
          $<span class="hljs-built_in">window</span>.scrollTo(<span class="hljs-number">0</span>, $<span class="hljs-built_in">window</span>.pageYOffset + clientRect.top - reasonableBuffer);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elemBottom &gt; $<span class="hljs-built_in">window</span>.innerHeight) {
          <span class="hljs-keyword">var</span> maxY = $<span class="hljs-built_in">window</span>.pageYOffset + clientRect.top - reasonableBuffer;
          <span class="hljs-keyword">if</span> (maxY - $<span class="hljs-built_in">window</span>.pageYOffset &gt; maxScrollDisplacement) {
            maxY = $<span class="hljs-built_in">window</span>.pageYOffset + maxScrollDisplacement;
          }
          <span class="hljs-keyword">var</span> targetY = $<span class="hljs-built_in">window</span>.pageYOffset - ($<span class="hljs-built_in">window</span>.innerHeight - elemBottom);
          <span class="hljs-keyword">if</span> (targetY &gt; maxY) {
            targetY = maxY;
          }
          $<span class="hljs-built_in">window</span>.scrollTo(<span class="hljs-number">0</span>, targetY);
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">selectedElementIsTextAreaOrInput</span>(<span class="hljs-params">ctx</span>) </span>{
        <span class="hljs-keyword">var</span> element = getDocument(ctx).activeElement;
        <span class="hljs-keyword">if</span> (element !== <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">var</span> nodeName = element.nodeName;
          <span class="hljs-keyword">var</span> type = element.getAttribute(<span class="hljs-string">'type'</span>);
          <span class="hljs-keyword">return</span> (nodeName === <span class="hljs-string">'INPUT'</span> &amp;&amp; type === <span class="hljs-string">'text'</span>) || nodeName === <span class="hljs-string">'TEXTAREA'</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">selectElement</span>(<span class="hljs-params">ctx, targetElement, path, offset</span>) </span>{
        <span class="hljs-keyword">var</span> range;
        <span class="hljs-keyword">var</span> elem = targetElement;
        <span class="hljs-keyword">if</span> (path) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; path.length; i++) {
            elem = elem.childNodes[path[i]];
            <span class="hljs-keyword">if</span> (elem === <span class="hljs-literal">undefined</span>) {
              <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">while</span> (elem.length &lt; offset) {
              offset -= elem.length;
              elem = elem.nextSibling;
            }
            <span class="hljs-keyword">if</span> (elem.childNodes.length === <span class="hljs-number">0</span> &amp;&amp; !elem.length) {
              elem = elem.previousSibling;
            }
          }
        }
        <span class="hljs-keyword">var</span> sel = getWindowSelection(ctx);
        range = getDocument(ctx).createRange();
        range.setStart(elem, offset);
        range.setEnd(elem, offset);
        range.collapse(<span class="hljs-literal">true</span>);
        <span class="hljs-keyword">try</span> {
          sel.removeAllRanges();
        } <span class="hljs-keyword">catch</span> (error) {}
        sel.addRange(range);
        targetElement.focus();
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pasteHtml</span>(<span class="hljs-params">ctx, html, startPos, endPos</span>) </span>{
        <span class="hljs-keyword">var</span> range, sel;
        sel = getWindowSelection(ctx);
        range = getDocument(ctx).createRange();
        range.setStart(sel.anchorNode, startPos);
        range.setEnd(sel.anchorNode, endPos);
        range.deleteContents();
        <span class="hljs-keyword">var</span> el = getDocument(ctx).createElement(<span class="hljs-string">'div'</span>);
        el.innerHTML = html;
        <span class="hljs-keyword">var</span> frag = getDocument(ctx).createDocumentFragment(),
          node, lastNode;
        <span class="hljs-keyword">while</span> ((node = el.firstChild)) {
          lastNode = frag.appendChild(node);
        }
        range.insertNode(frag);
        <span class="hljs-keyword">if</span> (lastNode) {
          range = range.cloneRange();
          range.setStartAfter(lastNode);
          range.collapse(<span class="hljs-literal">true</span>);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resetSelection</span>(<span class="hljs-params">ctx, targetElement, path, offset</span>) </span>{
        <span class="hljs-keyword">var</span> nodeName = targetElement.nodeName;
        <span class="hljs-keyword">if</span> (nodeName === <span class="hljs-string">'INPUT'</span> || nodeName === <span class="hljs-string">'TEXTAREA'</span>) {
          <span class="hljs-keyword">if</span> (targetElement !== getDocument(ctx).activeElement) {
            targetElement.focus();
          }
        } <span class="hljs-keyword">else</span> {
          selectElement(ctx, targetElement, path, offset);
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replaceMacroText</span>(<span class="hljs-params">ctx, targetElement, path, offset, macros, text</span>) </span>{
        resetSelection(ctx, targetElement, path, offset);
        <span class="hljs-keyword">var</span> macroMatchInfo = getMacroMatch(ctx, macros);
        <span class="hljs-keyword">if</span> (macroMatchInfo.macroHasTrailingSpace) {
          macroMatchInfo.macroText = macroMatchInfo.macroText + <span class="hljs-string">'\xA0'</span>;
          text = text + <span class="hljs-string">'\xA0'</span>;
        }
        <span class="hljs-keyword">if</span> (macroMatchInfo !== <span class="hljs-literal">undefined</span>) {
          <span class="hljs-keyword">var</span> element = getDocument(ctx).activeElement;
          <span class="hljs-keyword">if</span> (selectedElementIsTextAreaOrInput(ctx)) {
            <span class="hljs-keyword">var</span> startPos = macroMatchInfo.macroPosition;
            <span class="hljs-keyword">var</span> endPos = macroMatchInfo.macroPosition + macroMatchInfo.macroText.length;
            element.value = element.value.substring(<span class="hljs-number">0</span>, startPos) + text +
              element.value.substring(endPos, element.value.length);
            element.selectionStart = startPos + text.length;
            element.selectionEnd = startPos + text.length;
          } <span class="hljs-keyword">else</span> {
            pasteHtml(ctx, text, macroMatchInfo.macroPosition,
              macroMatchInfo.macroPosition + macroMatchInfo.macroText.length);
          }
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replaceTriggerText</span>(<span class="hljs-params">ctx, targetElement, path, offset, triggerCharSet,
        text, requireLeadingSpace, hasTrailingSpace, suppressTrailingSpace</span>) </span>{
        resetSelection(ctx, targetElement, path, offset);
        <span class="hljs-keyword">var</span> mentionInfo = getTriggerInfo(ctx, triggerCharSet, requireLeadingSpace, <span class="hljs-literal">true</span>, hasTrailingSpace);
        <span class="hljs-keyword">if</span> (mentionInfo !== <span class="hljs-literal">undefined</span>) {
          <span class="hljs-keyword">if</span> (selectedElementIsTextAreaOrInput()) {
            <span class="hljs-keyword">var</span> myField = getDocument(ctx).activeElement;
            <span class="hljs-keyword">if</span> (!suppressTrailingSpace) {
              text = text + <span class="hljs-string">' '</span>;
            }
            <span class="hljs-keyword">var</span> startPos = mentionInfo.mentionPosition;
            <span class="hljs-keyword">var</span> endPos = mentionInfo.mentionPosition + mentionInfo.mentionText.length + <span class="hljs-number">1</span>;
            myField.value = myField.value.substring(<span class="hljs-number">0</span>, startPos) + text +
              myField.value.substring(endPos, myField.value.length);
            myField.selectionStart = startPos + text.length;
            myField.selectionEnd = startPos + text.length;
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (!suppressTrailingSpace) {
              text = text + <span class="hljs-string">'\xA0'</span>;
            }
            pasteHtml(ctx, text, mentionInfo.mentionPosition,
              mentionInfo.mentionPosition + mentionInfo.mentionText.length + <span class="hljs-number">1</span>);
          }
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getNodePositionInParent</span>(<span class="hljs-params">ctx, elem</span>) </span>{
        <span class="hljs-keyword">if</span> (elem.parentNode === <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; elem.parentNode.childNodes.length; i++) {
          <span class="hljs-keyword">var</span> node = elem.parentNode.childNodes[i];
          <span class="hljs-keyword">if</span> (node === elem) {
            <span class="hljs-keyword">return</span> i;
          }
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMacroMatch</span>(<span class="hljs-params">ctx, macros</span>) </span>{
        <span class="hljs-keyword">var</span> selected, path = [],
          offset;
        <span class="hljs-keyword">if</span> (selectedElementIsTextAreaOrInput(ctx)) {
          selected = getDocument(ctx).activeElement;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> selectionInfo = getContentEditableSelectedPath(ctx);
          <span class="hljs-keyword">if</span> (selectionInfo) {
            selected = selectionInfo.selected;
            path = selectionInfo.path;
            offset = selectionInfo.offset;
          }
        }
        <span class="hljs-keyword">var</span> effectiveRange = getTextPrecedingCurrentSelection(ctx);
        <span class="hljs-keyword">if</span> (effectiveRange !== <span class="hljs-literal">undefined</span> &amp;&amp; effectiveRange !== <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">var</span> matchInfo;
          <span class="hljs-keyword">var</span> hasTrailingSpace = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">if</span> (effectiveRange.length &gt; <span class="hljs-number">0</span> &amp;&amp;
            (effectiveRange.charAt(effectiveRange.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'\xA0'</span> ||
              effectiveRange.charAt(effectiveRange.length - <span class="hljs-number">1</span>) === <span class="hljs-string">' '</span>)) {
            hasTrailingSpace = <span class="hljs-literal">true</span>;
            effectiveRange = effectiveRange.substring(<span class="hljs-number">0</span>, effectiveRange.length - <span class="hljs-number">1</span>);
          }
          angular.forEach(macros, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">macro, c</span>) </span>{
            <span class="hljs-keyword">var</span> idx = effectiveRange.toUpperCase().lastIndexOf(c.toUpperCase());
            <span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span> &amp;&amp; c.length + idx === effectiveRange.length) {
              <span class="hljs-keyword">var</span> prevCharPos = idx - <span class="hljs-number">1</span>;
              <span class="hljs-keyword">if</span> (idx === <span class="hljs-number">0</span> || effectiveRange.charAt(prevCharPos) === <span class="hljs-string">'\xA0'</span> ||
                effectiveRange.charAt(prevCharPos) === <span class="hljs-string">' '</span>) {
                matchInfo = {
                  <span class="hljs-attr">macroPosition</span>: idx,
                  <span class="hljs-attr">macroText</span>: c,
                  <span class="hljs-attr">macroSelectedElement</span>: selected,
                  <span class="hljs-attr">macroSelectedPath</span>: path,
                  <span class="hljs-attr">macroSelectedOffset</span>: offset,
                  <span class="hljs-attr">macroHasTrailingSpace</span>: hasTrailingSpace
                };
              }
            }
          });
          <span class="hljs-keyword">if</span> (matchInfo) {
            <span class="hljs-keyword">return</span> matchInfo;
          }
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getContentEditableSelectedPath</span>(<span class="hljs-params">ctx</span>) </span>{
        <span class="hljs-keyword">var</span> sel = getWindowSelection(ctx);
        <span class="hljs-keyword">var</span> selected = sel.anchorNode;
        <span class="hljs-keyword">var</span> path = [];
        <span class="hljs-keyword">var</span> offset;
        <span class="hljs-keyword">if</span> (selected != <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">var</span> i;
          <span class="hljs-keyword">var</span> ce = selected.contentEditable;
          <span class="hljs-keyword">while</span> (selected !== <span class="hljs-literal">null</span> &amp;&amp; ce !== <span class="hljs-string">'true'</span>) {
            i = getNodePositionInParent(ctx, selected);
            path.push(i);
            selected = selected.parentNode;
            <span class="hljs-keyword">if</span> (selected !== <span class="hljs-literal">null</span>) {
              ce = selected.contentEditable;
            }
          }
          path.reverse();
          offset = sel.getRangeAt(<span class="hljs-number">0</span>).startOffset;
          <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">selected</span>: selected,
            <span class="hljs-attr">path</span>: path,
            <span class="hljs-attr">offset</span>: offset
          };
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTriggerInfo</span>(<span class="hljs-params">ctx, triggerCharSet, requireLeadingSpace, menuAlreadyActive, hasTrailingSpace</span>) </span>{
        <span class="hljs-keyword">var</span> selected, path, offset;
        <span class="hljs-keyword">if</span> (selectedElementIsTextAreaOrInput(ctx)) {
          selected = getDocument(ctx).activeElement;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> selectionInfo = getContentEditableSelectedPath(ctx);
          <span class="hljs-keyword">if</span> (selectionInfo) {
            selected = selectionInfo.selected;
            path = selectionInfo.path;
            offset = selectionInfo.offset;
          }
        }
        <span class="hljs-keyword">var</span> effectiveRange = getTextPrecedingCurrentSelection(ctx);
        <span class="hljs-keyword">if</span> (effectiveRange !== <span class="hljs-literal">undefined</span> &amp;&amp; effectiveRange !== <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">var</span> mostRecentTriggerCharPos = <span class="hljs-number">-1</span>;
          <span class="hljs-keyword">var</span> triggerChar;
          triggerCharSet.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{
            <span class="hljs-keyword">var</span> idx = effectiveRange.lastIndexOf(c);
            <span class="hljs-keyword">if</span> (idx &gt; mostRecentTriggerCharPos) {
              mostRecentTriggerCharPos = idx;
              triggerChar = c;
            }
          });
          <span class="hljs-keyword">if</span> (mostRecentTriggerCharPos &gt;= <span class="hljs-number">0</span> &amp;&amp;
            (
              mostRecentTriggerCharPos === <span class="hljs-number">0</span> ||
              !requireLeadingSpace ||
              <span class="hljs-regexp">/[\xA0\s]/g</span>.test(
                effectiveRange.substring(
                  mostRecentTriggerCharPos - <span class="hljs-number">1</span>,
                  mostRecentTriggerCharPos)
              )
            )
          ) {
            <span class="hljs-keyword">var</span> currentTriggerSnippet = effectiveRange.substring(mostRecentTriggerCharPos + <span class="hljs-number">1</span>,
              effectiveRange.length);
            triggerChar = effectiveRange.substring(mostRecentTriggerCharPos, mostRecentTriggerCharPos + <span class="hljs-number">1</span>);
            <span class="hljs-keyword">var</span> firstSnippetChar = currentTriggerSnippet.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
            <span class="hljs-keyword">var</span> leadingSpace = currentTriggerSnippet.length &gt; <span class="hljs-number">0</span> &amp;&amp;
              (
                firstSnippetChar === <span class="hljs-string">' '</span> ||
                firstSnippetChar === <span class="hljs-string">'\xA0'</span>
              );
            <span class="hljs-keyword">if</span> (hasTrailingSpace) {
              currentTriggerSnippet = currentTriggerSnippet.trim();
            }
            <span class="hljs-keyword">if</span> (!leadingSpace &amp;&amp; (menuAlreadyActive || !(<span class="hljs-regexp">/[\xA0\s]/g</span>.test(currentTriggerSnippet)))) {
              <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">mentionPosition</span>: mostRecentTriggerCharPos,
                <span class="hljs-attr">mentionText</span>: currentTriggerSnippet,
                <span class="hljs-attr">mentionSelectedElement</span>: selected,
                <span class="hljs-attr">mentionSelectedPath</span>: path,
                <span class="hljs-attr">mentionSelectedOffset</span>: offset,
                <span class="hljs-attr">mentionTriggerChar</span>: triggerChar
              };
            }
          }
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWindowSelection</span>(<span class="hljs-params">ctx</span>) </span>{
        <span class="hljs-keyword">if</span> (!ctx) {
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.getSelection();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> ctx.iframe.contentWindow.getSelection();
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDocument</span>(<span class="hljs-params">ctx</span>) </span>{
        <span class="hljs-keyword">if</span> (!ctx) {
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> ctx.iframe.contentWindow.document;
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTextPrecedingCurrentSelection</span>(<span class="hljs-params">ctx</span>) </span>{
        <span class="hljs-keyword">var</span> text;
        <span class="hljs-keyword">if</span> (selectedElementIsTextAreaOrInput(ctx)) {
          <span class="hljs-keyword">var</span> textComponent = getDocument(ctx).activeElement;
          <span class="hljs-keyword">var</span> startPos = textComponent.selectionStart;
          text = textComponent.value.substring(<span class="hljs-number">0</span>, startPos);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> selectedElem = getWindowSelection(ctx).anchorNode;
          <span class="hljs-keyword">if</span> (selectedElem != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">var</span> workingNodeContent = selectedElem.textContent;
            <span class="hljs-keyword">var</span> selectStartOffset = getWindowSelection(ctx).getRangeAt(<span class="hljs-number">0</span>).startOffset;
            <span class="hljs-keyword">if</span> (selectStartOffset &gt;= <span class="hljs-number">0</span>) {
              text = workingNodeContent.substring(<span class="hljs-number">0</span>, selectStartOffset);
            }
          }
        }
        <span class="hljs-keyword">return</span> text;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getContentEditableCaretPosition</span>(<span class="hljs-params">ctx, selectedNodePosition</span>) </span>{
        <span class="hljs-keyword">var</span> markerTextChar = <span class="hljs-string">'\ufeff'</span>;
        <span class="hljs-keyword">var</span> markerEl, markerId = <span class="hljs-string">'sel_'</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() + <span class="hljs-string">'_'</span> + <span class="hljs-built_in">Math</span>.random().toString().substr(<span class="hljs-number">2</span>);
        <span class="hljs-keyword">var</span> range;
        <span class="hljs-keyword">var</span> sel = getWindowSelection(ctx);
        <span class="hljs-keyword">var</span> prevRange = sel.getRangeAt(<span class="hljs-number">0</span>);
        range = getDocument(ctx).createRange();
        range.setStart(sel.anchorNode, selectedNodePosition);
        range.setEnd(sel.anchorNode, selectedNodePosition);
        range.collapse(<span class="hljs-literal">false</span>);
        markerEl = getDocument(ctx).createElement(<span class="hljs-string">'span'</span>);
        markerEl.id = markerId;
        markerEl.appendChild(getDocument(ctx).createTextNode(markerTextChar));
        range.insertNode(markerEl);
        sel.removeAllRanges();
        sel.addRange(prevRange);
        <span class="hljs-keyword">var</span> coordinates = {
          <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>,
          <span class="hljs-attr">top</span>: markerEl.offsetHeight
        };
        localToGlobalCoordinates(ctx, markerEl, coordinates);
        markerEl.parentNode.removeChild(markerEl);
        <span class="hljs-keyword">return</span> coordinates;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">localToGlobalCoordinates</span>(<span class="hljs-params">ctx, element, coordinates</span>) </span>{
        <span class="hljs-keyword">var</span> obj = element;
        <span class="hljs-keyword">var</span> iframe = ctx ? ctx.iframe : <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">while</span> (obj) {
          coordinates.left += obj.offsetLeft;
          coordinates.top += obj.offsetTop;
          <span class="hljs-keyword">if</span> (obj !== getDocument().body) {
            coordinates.top -= obj.scrollTop;
            coordinates.left -= obj.scrollLeft;
          }
          obj = obj.offsetParent;
          <span class="hljs-keyword">if</span> (!obj &amp;&amp; iframe) {
            obj = iframe;
            iframe = <span class="hljs-literal">null</span>;
          }
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTextAreaOrInputUnderlinePosition</span>(<span class="hljs-params">ctx, element, position</span>) </span>{
        <span class="hljs-keyword">var</span> properties = [
          <span class="hljs-string">'direction'</span>,
          <span class="hljs-string">'boxSizing'</span>,
          <span class="hljs-string">'width'</span>,
          <span class="hljs-string">'height'</span>,
          <span class="hljs-string">'overflowX'</span>,
          <span class="hljs-string">'overflowY'</span>,
          <span class="hljs-string">'borderTopWidth'</span>,
          <span class="hljs-string">'borderRightWidth'</span>,
          <span class="hljs-string">'borderBottomWidth'</span>,
          <span class="hljs-string">'borderLeftWidth'</span>,
          <span class="hljs-string">'paddingTop'</span>,
          <span class="hljs-string">'paddingRight'</span>,
          <span class="hljs-string">'paddingBottom'</span>,
          <span class="hljs-string">'paddingLeft'</span>,
          <span class="hljs-string">'fontStyle'</span>,
          <span class="hljs-string">'fontVariant'</span>,
          <span class="hljs-string">'fontWeight'</span>,
          <span class="hljs-string">'fontStretch'</span>,
          <span class="hljs-string">'fontSize'</span>,
          <span class="hljs-string">'fontSizeAdjust'</span>,
          <span class="hljs-string">'lineHeight'</span>,
          <span class="hljs-string">'fontFamily'</span>,
          <span class="hljs-string">'textAlign'</span>,
          <span class="hljs-string">'textTransform'</span>,
          <span class="hljs-string">'textIndent'</span>,
          <span class="hljs-string">'textDecoration'</span>,
          <span class="hljs-string">'letterSpacing'</span>,
          <span class="hljs-string">'wordSpacing'</span>
        ];
        <span class="hljs-keyword">var</span> isFirefox = (<span class="hljs-built_in">window</span>.mozInnerScreenX !== <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">var</span> div = getDocument(ctx).createElement(<span class="hljs-string">'div'</span>);
        div.id = <span class="hljs-string">'input-textarea-caret-position-mirror-div'</span>;
        getDocument(ctx).body.appendChild(div);
        <span class="hljs-keyword">var</span> style = div.style;
        <span class="hljs-keyword">var</span> computed = <span class="hljs-built_in">window</span>.getComputedStyle ? getComputedStyle(element) : element.currentStyle;
        style.whiteSpace = <span class="hljs-string">'pre-wrap'</span>;
        <span class="hljs-keyword">if</span> (element.nodeName !== <span class="hljs-string">'INPUT'</span>) {
          style.wordWrap = <span class="hljs-string">'break-word'</span>;
        }
        style.position = <span class="hljs-string">'absolute'</span>;
        style.visibility = <span class="hljs-string">'hidden'</span>;
        properties.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prop</span>) </span>{
          style[prop] = computed[prop];
        });
        <span class="hljs-keyword">if</span> (isFirefox) {
          style.width = (<span class="hljs-built_in">parseInt</span>(computed.width) - <span class="hljs-number">2</span>) + <span class="hljs-string">'px'</span>;
          <span class="hljs-keyword">if</span> (element.scrollHeight &gt; <span class="hljs-built_in">parseInt</span>(computed.height))
            style.overflowY = <span class="hljs-string">'scroll'</span>;
        } <span class="hljs-keyword">else</span> {
          style.overflow = <span class="hljs-string">'hidden'</span>;
        }
        div.textContent = element.value.substring(<span class="hljs-number">0</span>, position);
        <span class="hljs-keyword">if</span> (element.nodeName === <span class="hljs-string">'INPUT'</span>) {
          div.textContent = div.textContent.replace(<span class="hljs-regexp">/\s/g</span>, <span class="hljs-string">'\u00a0'</span>);
        }
        <span class="hljs-keyword">var</span> span = getDocument(ctx).createElement(<span class="hljs-string">'span'</span>);
        span.textContent = element.value.substring(position) || <span class="hljs-string">'.'</span>;
        div.appendChild(span);
        <span class="hljs-keyword">var</span> coordinates = {
          <span class="hljs-attr">top</span>: span.offsetTop + <span class="hljs-built_in">parseInt</span>(computed.borderTopWidth) + <span class="hljs-built_in">parseInt</span>(computed.fontSize),
          <span class="hljs-attr">left</span>: span.offsetLeft + <span class="hljs-built_in">parseInt</span>(computed.borderLeftWidth)
        };
        localToGlobalCoordinates(ctx, element, coordinates);
        getDocument(ctx).body.removeChild(div);
        <span class="hljs-keyword">return</span> coordinates;
      }
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">popUnderMention</span>: popUnderMention,
        <span class="hljs-attr">replaceMacroText</span>: replaceMacroText,
        <span class="hljs-attr">replaceTriggerText</span>: replaceTriggerText,
        <span class="hljs-attr">getMacroMatch</span>: getMacroMatch,
        <span class="hljs-attr">getTriggerInfo</span>: getTriggerInfo,
        <span class="hljs-attr">selectElement</span>: selectElement,
        <span class="hljs-attr">getTextAreaOrInputUnderlinePosition</span>: getTextAreaOrInputUnderlinePosition,
        <span class="hljs-attr">getTextPrecedingCurrentSelection</span>: getTextPrecedingCurrentSelection,
        <span class="hljs-attr">getContentEditableSelectedPath</span>: getContentEditableSelectedPath,
        <span class="hljs-attr">getNodePositionInParent</span>: getNodePositionInParent,
        <span class="hljs-attr">getContentEditableCaretPosition</span>: getContentEditableCaretPosition,
        <span class="hljs-attr">pasteHtml</span>: pasteHtml,
        <span class="hljs-attr">resetSelection</span>: resetSelection,
        <span class="hljs-attr">scrollIntoView</span>: scrollIntoView
      };
    }]);
  angular.module(<span class="hljs-string">"mentio"</span>).run([<span class="hljs-string">"$templateCache"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$templateCache</span>) </span>{
    $templateCache.put(<span class="hljs-string">"mentio-menu.tpl.html"</span>, <span class="hljs-string">"&lt;style&gt;\n.scrollable-menu {\n    height: auto;\n    max-height: 300px;\n    overflow: auto;\n}\n\n.menu-highlighted {\n    font-weight: bold;\n}\n&lt;/style&gt;\n&lt;ul class=\"dropdown-menu scrollable-menu\" style=\"display:block\"&gt;\n    &lt;li mentio-menu-item=\"item\" ng-repeat=\"item in items track by $index\"&gt;\n        &lt;a class=\"text-primary\" ng-bind-html=\"item.label | mentioHighlight:typedTerm:\'menu-highlighted\' | unsafe\"&gt;&lt;/a&gt;\n    &lt;/li&gt;\n&lt;/ul&gt;"</span>);
  }]);
})();
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/stream/_module.js */</span>
angular.module(<span class="hljs-string">"sn.common.stream"</span>, [<span class="hljs-string">'sn.base'</span>, <span class="hljs-string">'ng.amb'</span>, <span class="hljs-string">'sn.messaging'</span>, <span class="hljs-string">'sn.common.glide'</span>, <span class="hljs-string">'ngSanitize'</span>,
  <span class="hljs-string">'sn.common.avatar'</span>, <span class="hljs-string">'sn.common.ui.popover'</span>, <span class="hljs-string">'mentio'</span>, <span class="hljs-string">'sn.common.controls'</span>, <span class="hljs-string">'sn.common.user_profile'</span>,
  <span class="hljs-string">'sn.common.datetime'</span>, <span class="hljs-string">'sn.common.mention'</span>, <span class="hljs-string">'sn.common.ui'</span>
]);
angular.module(<span class="hljs-string">"sn.stream.direct"</span>, [<span class="hljs-string">'sn.common.stream'</span>]);;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/stream/controller.Stream.js */</span>
angular.module(<span class="hljs-string">"sn.common.stream"</span>).controller(<span class="hljs-string">"Stream"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, snRecordWatcher, $timeout</span>) </span>{
  <span class="hljs-keyword">var</span> isForm = NOW.sysId.length &gt; <span class="hljs-number">0</span>;
  $scope.showCommentsAndWorkNotes = isForm;
  $scope.sessions = {};
  $scope.recordStreamOpen = <span class="hljs-literal">false</span>;
  $scope.streamHidden = <span class="hljs-literal">true</span>;
  $scope.recordSysId = <span class="hljs-string">''</span>;
  $scope.recordDisplayValue = <span class="hljs-string">''</span>;
  $scope.$on(<span class="hljs-string">'record.updated'</span>, onRecordUpdated);
  $scope.$on(<span class="hljs-string">'sn.sessions'</span>, onSessions);
  $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (isForm)
      snRecordWatcher.initRecord(NOW.targetTable, NOW.sysId);
    <span class="hljs-keyword">else</span>
      snRecordWatcher.initList(NOW.targetTable, NOW.tableQuery);
  }, <span class="hljs-number">100</span>);
  $scope.controls = {
    <span class="hljs-attr">showRecord</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$event, entry, sysId</span>) </span>{
      <span class="hljs-keyword">if</span> (sysId !== <span class="hljs-string">''</span>)
        <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> ($event.currentTarget != $event.target &amp;&amp; $event.target.tagName == <span class="hljs-string">'A'</span>)
        <span class="hljs-keyword">return</span>;
      $scope.recordSysId = entry.document_id;
      $scope.recordDisplayValue = entry.display_value;
      $scope.recordStreamOpen = <span class="hljs-literal">true</span>;
      $scope.streamHidden = <span class="hljs-literal">true</span>;
    },
    <span class="hljs-attr">openRecord</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> targetFrame = <span class="hljs-built_in">window</span>.self;
      <span class="hljs-keyword">var</span> url = NOW.targetTable + <span class="hljs-string">".do?sys_id="</span> + $scope.recordSysId;
      <span class="hljs-keyword">if</span> (NOW.linkTarget == <span class="hljs-string">'form_pane'</span>) {
        url += <span class="hljs-string">"&amp;sysparm_clear_stack=true"</span>;
        <span class="hljs-built_in">window</span>.parent.CustomEvent.fireTop(
          <span class="hljs-string">"glide:nav_open_url"</span>, {
            <span class="hljs-attr">url</span>: url,
            <span class="hljs-attr">openInForm</span>: <span class="hljs-literal">true</span>
          });
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">if</span> (NOW.streamLinkTarget == <span class="hljs-string">'parent'</span> || NOW.concourse == <span class="hljs-string">'true'</span>)
        targetFrame = <span class="hljs-built_in">window</span>.parent;
      targetFrame.location = url;
    },
    <span class="hljs-attr">openAttachment</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, sysId</span>) </span>{
      event.stopPropagation();
      <span class="hljs-keyword">var</span> url = <span class="hljs-string">"/sys_attachment.do?view=true&amp;sys_id="</span> + sysId;
      <span class="hljs-keyword">var</span> newTab = <span class="hljs-built_in">window</span>.open(url, <span class="hljs-string">'_blank'</span>);
      newTab.focus();
    }
  };
  $scope.sessionCount = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    $scope.sessions.length = <span class="hljs-built_in">Object</span>.keys($scope.sessions.data).length;
    <span class="hljs-keyword">return</span> $scope.sessions.length;
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onSessions</span>(<span class="hljs-params">name, sessions</span>) </span>{
    $scope.sessions.data = sessions;
    $scope.sessionCount();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onRecordUpdated</span>(<span class="hljs-params">name, data</span>) </span>{}
  $scope.showListStream = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    $scope.recordStreamOpen = <span class="hljs-literal">false</span>;
    $scope.recordHidden = <span class="hljs-literal">false</span>;
    $scope.streamHidden = <span class="hljs-literal">false</span>;
    angular.element(<span class="hljs-string">'div.list-stream-record'</span>).velocity(<span class="hljs-string">'snTransition.streamSlideRight'</span>, {
      <span class="hljs-attr">duration</span>: <span class="hljs-number">400</span>
    });
    angular.element(<span class="hljs-string">'[streamType="list"]'</span>).velocity(<span class="hljs-string">'snTransition.slideIn'</span>, {
      <span class="hljs-attr">duration</span>: <span class="hljs-number">400</span>,
      <span class="hljs-attr">complete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element</span>) </span>{
        angular.element(element).css({
          <span class="hljs-attr">display</span>: <span class="hljs-string">'block'</span>
        });
      }
    });
  };
  $scope.$watch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> angular.element(<span class="hljs-string">'div.list-stream-record'</span>).length
  }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>) </span>{
    <span class="hljs-keyword">if</span> (newValue == <span class="hljs-number">1</span>) {
      angular.element(<span class="hljs-string">'div.list-stream-record'</span>).delay(<span class="hljs-number">100</span>).velocity(<span class="hljs-string">'snTransition.streamSlideLeft'</span>, {
        <span class="hljs-attr">begin</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element</span>) </span>{
          angular.element(element).css({
            <span class="hljs-attr">visibility</span>: <span class="hljs-string">'visible'</span>
          });
          angular.element(<span class="hljs-string">'.list-stream-record-header'</span>).css({
            <span class="hljs-attr">visibility</span>: <span class="hljs-string">'visible'</span>
          });
        },
        <span class="hljs-attr">duration</span>: <span class="hljs-number">400</span>,
        <span class="hljs-attr">complete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element</span>) </span>{
          angular.element(element).css({
            <span class="hljs-attr">transform</span>: <span class="hljs-string">"translateX(0)"</span>
          });
          angular.element(element).scrollTop(<span class="hljs-number">0</span>);
          angular.element(element).css({
            <span class="hljs-attr">transform</span>: <span class="hljs-string">"initial"</span>
          });
        }
      });
    }
  });
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/stream/directive.snStream.js */</span>
angular.module(<span class="hljs-string">"sn.common.stream"</span>).directive(<span class="hljs-string">"snStream"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl, $http, $sce, $sanitize</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">"E"</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">table</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">query</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">sysId</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">active</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">controls</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">showCommentsAndWorkNotes</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">previousActivity</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">sessions</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">attachments</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">board</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">formJournalFields</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">useMultipleInputs</span>: <span class="hljs-string">"=?"</span>,
      <span class="hljs-attr">preferredInput</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">labels</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">subStream</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">expandEntries</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">scaleAnimatedGifs</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">scaleImages</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">pageSize</span>: <span class="hljs-string">"="</span>,
      <span class="hljs-attr">maxEntries</span>: <span class="hljs-string">"@"</span>
    },
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">"ng_activity_stream.xml"</span>),
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $attrs, nowStream, snRecordPresence, snCustomEvent, userPreferences, $window, $q, $timeout, snMention, i18n</span>) </span>{
      <span class="hljs-keyword">var</span> stream;
      <span class="hljs-keyword">var</span> processor = $attrs.processor || <span class="hljs-string">"list_history"</span>;
      <span class="hljs-keyword">var</span> interval;
      <span class="hljs-keyword">var</span> FROM_LIST = <span class="hljs-string">'from_list'</span>;
      <span class="hljs-keyword">var</span> FROM_FORM = <span class="hljs-string">'from_form'</span>;
      <span class="hljs-keyword">var</span> source = $scope.sysId ? FROM_FORM : FROM_LIST;
      <span class="hljs-keyword">var</span> amb = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">var</span> _firstPoll = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">var</span> _firstPollTimeout;
      <span class="hljs-keyword">var</span> primaryJournalFieldOrder = [<span class="hljs-string">"comments"</span>, <span class="hljs-string">"work_notes"</span>];
      <span class="hljs-keyword">var</span> primaryJournalField = <span class="hljs-literal">null</span>;
      $scope.defaultShowCommentsAndWorkNotes = ($scope.sysId != <span class="hljs-literal">null</span> &amp;&amp; !angular.isUndefined($scope.sysId) &amp;&amp; $scope.sysId.length &gt; <span class="hljs-number">0</span>);
      $scope.canWriteWorkNotes = <span class="hljs-literal">false</span>;
      $scope.inputTypeValue = <span class="hljs-string">""</span>;
      $scope.entryTemplate = getTemplateUrl($attrs.template || <span class="hljs-string">"list_stream_entry"</span>);
      $scope.isFormStream = $attrs.template === <span class="hljs-string">"record_stream_entry.xml"</span>;
      $scope.allFields = <span class="hljs-literal">null</span>;
      $scope.fields = <span class="hljs-literal">null</span>;
      $scope.fieldColor = <span class="hljs-string">"transparent"</span>;
      $scope.multipleInputs = $scope.useMultipleInputs;
      <span class="hljs-keyword">var</span> typing = <span class="hljs-string">'{0} is typing'</span>,
        viewing = <span class="hljs-string">'{0} is viewing'</span>,
        entered = <span class="hljs-string">'{0} has entered'</span>;
      <span class="hljs-keyword">var</span> probablyLeft = <span class="hljs-string">'{0} has probably left'</span>,
        exited = <span class="hljs-string">'{0} has exited'</span>,
        offline = <span class="hljs-string">'{0} is offline'</span>;
      i18n.getMessages(
        [
          typing,
          viewing,
          entered,
          probablyLeft,
          exited,
          offline
        ],
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">results</span>) </span>{
          typing = results[typing];
          viewing = results[viewing];
          entered = results[entered];
          probablyLeft = results[probablyLeft];
          exited = results[exited];
          offline = results[offline];
        }
      );
      $scope.parsePresence = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sessionData</span>) </span>{
        <span class="hljs-keyword">var</span> status = sessionData.status;
        <span class="hljs-keyword">var</span> name = sessionData.user_display_name;
        <span class="hljs-keyword">switch</span> (status) {
          <span class="hljs-keyword">case</span> <span class="hljs-string">'typing'</span>:
            <span class="hljs-keyword">return</span> i18n.format(typing, name);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'viewing'</span>:
            <span class="hljs-keyword">return</span> i18n.format(viewing, name);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'entered'</span>:
            <span class="hljs-keyword">return</span> i18n.format(entered, name);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'probably left'</span>:
            <span class="hljs-keyword">return</span> i18n.format(probablyLeft, name);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'exited'</span>:
            <span class="hljs-keyword">return</span> i18n.format(exited, name);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'offline'</span>:
            <span class="hljs-keyword">return</span> i18n.format(offline, name);
          <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
        }
      };
      $scope.members = [];
      $scope.members.loading = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">var</span> mentionMap = {};
      $scope.selectAtMention = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
        <span class="hljs-keyword">if</span> (item.termLengthIsZero)
          <span class="hljs-keyword">return</span> (item.name || <span class="hljs-string">""</span>) + <span class="hljs-string">"\n"</span>;
        mentionMap[item.name] = item.sys_id;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"@["</span> + item.name + <span class="hljs-string">"]"</span>;
      };
      <span class="hljs-keyword">var</span> typingTimer;
      $scope.searchMembersAsync = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">term</span>) </span>{
        $scope.members = [];
        $scope.members.loading = <span class="hljs-literal">true</span>;
        $timeout.cancel(typingTimer);
        <span class="hljs-keyword">if</span> (term.length === <span class="hljs-number">0</span>) {
          $scope.members = [{
            <span class="hljs-attr">termLengthIsZero</span>: <span class="hljs-literal">true</span>
          }];
          $scope.members.loading = <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">else</span> {
          typingTimer = $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            snMention.retrieveMembers($scope.table, $scope.sysId, term).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">members</span>) </span>{
              $scope.members = members;
              $scope.members.loading = <span class="hljs-literal">false</span>;
            }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              $scope.members = [{
                <span class="hljs-attr">termLengthIsZero</span>: <span class="hljs-literal">true</span>
              }];
              $scope.members.loading = <span class="hljs-literal">false</span>;
            });
          }, <span class="hljs-number">500</span>);
        }
      };
      $scope.expandMentions = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text</span>) </span>{
        <span class="hljs-keyword">return</span> stream.expandMentions(text, mentionMap)
      }
      $scope.reduceMentions = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text</span>) </span>{
        <span class="hljs-keyword">if</span> (!text)
          <span class="hljs-keyword">return</span> text;
        <span class="hljs-keyword">var</span> regexMentionParts = <span class="hljs-regexp">/[\w\d\s/\']+/gi</span>;
        text = text.replace(<span class="hljs-regexp">/@\[[\w\d\s]+:[\w\d\s/\']+\]/gi</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mention</span>) </span>{
          <span class="hljs-keyword">var</span> mentionParts = mention.match(regexMentionParts);
          <span class="hljs-keyword">if</span> (mentionParts.length === <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">var</span> name = mentionParts[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">var</span> userID = mentionParts[<span class="hljs-number">0</span>];
            mentionMap[name] = userID;
            <span class="hljs-keyword">return</span> <span class="hljs-string">"@["</span> + name + <span class="hljs-string">"]"</span>;
          }
          <span class="hljs-keyword">return</span> mentionParts;
        });
        <span class="hljs-keyword">return</span> text;
      }
      $scope.parseMentions = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry</span>) </span>{
        <span class="hljs-keyword">var</span> regexMentionParts = <span class="hljs-regexp">/[\w\d\s/\']+/gi</span>;
        entry = entry.replace(<span class="hljs-regexp">/@\[[\w\d\s]+:[\w\d\s/\']+\]/gi</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mention</span>) </span>{
          <span class="hljs-keyword">var</span> mentionParts = mention.match(regexMentionParts);
          <span class="hljs-keyword">if</span> (mentionParts.length === <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;a class="at-mention at-mention-user-'</span> + mentionParts[<span class="hljs-number">0</span>] + <span class="hljs-string">'"&gt;@'</span> + mentionParts[<span class="hljs-number">1</span>] + <span class="hljs-string">'&lt;/a&gt;'</span>;
          }
          <span class="hljs-keyword">return</span> mentionParts;
        });
        <span class="hljs-keyword">return</span> entry;
      };
      $scope.parseLinks = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text</span>) </span>{
        <span class="hljs-keyword">var</span> regexLinks = <span class="hljs-regexp">/@L\[([^|]+?)\|([^\]]*)]/gi</span>;
        <span class="hljs-keyword">return</span> text.replace(regexLinks, <span class="hljs-string">"&lt;a href='$1' target='_blank'&gt;$2&lt;/a&gt;"</span>);
      };
      $scope.parseSpecial = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text</span>) </span>{
        <span class="hljs-keyword">var</span> parsedText = $scope.parseLinks($sanitize(text));
        parsedText = $scope.parseMentions(parsedText);
        <span class="hljs-keyword">return</span> $sce.trustAsHtml(parsedText);
      };
      $scope.getFullEntryValue = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry, event</span>) </span>{
        event.stopPropagation();
        <span class="hljs-keyword">var</span> index = getEntryIndex(entry);
        <span class="hljs-keyword">var</span> journal = $scope.entries[index].entries.journal[<span class="hljs-number">0</span>];
        journal.loading = <span class="hljs-literal">true</span>;
        $http.get(<span class="hljs-string">'/api/now/ui/stream_entry/full_entry'</span>, {
          <span class="hljs-attr">params</span>: {
            <span class="hljs-attr">sysparm_sys_id</span>: journal.sys_id
          }
        }).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
          journal.new_value = response.data.result.replace(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">'&lt;br/&gt;'</span>);
          journal.is_truncated = <span class="hljs-literal">false</span>;
          journal.loading = <span class="hljs-literal">false</span>;
          journal.showMore = <span class="hljs-literal">true</span>;
        });
      };

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getEntryIndex</span>(<span class="hljs-params">entry</span>) </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = $scope.entries.length; i &lt; l; i++) {
          <span class="hljs-keyword">if</span> (entry === $scope.entries[i]) {
            <span class="hljs-keyword">return</span> i;
          }
        }
      }
      $scope.$watch(<span class="hljs-string">'active'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n, o</span>) </span>{
        <span class="hljs-keyword">if</span> (n === o)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> ($scope.active)
          startPolling();
        <span class="hljs-keyword">else</span>
          cancelStream();
      });
      $scope.defaultControls = {
        <span class="hljs-attr">getTitle</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry</span>) </span>{
          <span class="hljs-keyword">if</span> (entry &amp;&amp; entry.short_description) {
            <span class="hljs-keyword">return</span> entry.short_description;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (entry &amp;&amp; entry.shortDescription) {
            <span class="hljs-keyword">return</span> entry.shortDescription;
          }
        },
        <span class="hljs-attr">showCreatedBy</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        },
        <span class="hljs-attr">hideCommentLabel</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">journal</span>) </span>{
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        },
        <span class="hljs-attr">showRecord</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$event, entry</span>) </span>{},
        <span class="hljs-attr">showRecordLink</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
      };
      <span class="hljs-keyword">if</span> ($scope.controls) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> attr <span class="hljs-keyword">in</span> $scope.controls) {
          $scope.defaultControls[attr] = $scope.controls[attr];
        }
      }
      $scope.controls = $scope.defaultControls;
      <span class="hljs-keyword">if</span> ($scope.showCommentsAndWorkNotes === <span class="hljs-literal">undefined</span>) {
        $scope.showCommentsAndWorkNotes = $scope.defaultShowCommentsAndWorkNotes;
      }
      snCustomEvent.observe(<span class="hljs-string">'sn.stream.change_input_display'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">table, display</span>) </span>{
        <span class="hljs-keyword">if</span> (table != $scope.table)
          <span class="hljs-keyword">return</span>;
        $scope.showCommentsAndWorkNotes = display;
        $scope.$apply();
      });
      $scope.$on(<span class="hljs-string">"$destroy"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        cancelStream();
      });
      $scope.$on(<span class="hljs-string">'sn.stream.interval'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$event, time</span>) </span>{
        interval = time;
        reschedulePoll();
      });
      $scope.$on(<span class="hljs-string">"sn.stream.tap"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (stream)
          stream.tap();
        <span class="hljs-keyword">else</span>
          startPolling();
      });
      $scope.$on(<span class="hljs-string">'window_visibility_change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$event, hidden</span>) </span>{
        interval = (hidden) ? <span class="hljs-number">120000</span> : <span class="hljs-literal">undefined</span>;
        reschedulePoll();
      });
      $scope.$on(<span class="hljs-string">"sn.stream.refresh"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, data</span>) </span>{
        stream._successCallback(data.response);
      });
      $scope.$on(<span class="hljs-string">"sn.stream.reload"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        startPolling();
      });
      $scope.$on(<span class="hljs-string">'sn.stream.input_value'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">otherScope, value</span>) </span>{
        $scope.inputTypeValue = value;
      });
      $scope.$watchCollection(<span class="hljs-string">'[table, query, sysId]'</span>, startPolling);
      $scope.changeInputType = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">field</span>) </span>{
        $scope.inputType = field.checked ? field.name : primaryJournalField;
        userPreferences.setPreference(<span class="hljs-string">'glide.ui.'</span> + $scope.table + <span class="hljs-string">'.stream_input'</span>, $scope.inputType);
      };
      $scope.$watch(<span class="hljs-string">'inputType'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!$scope.inputType || !$scope.preferredInput)
          <span class="hljs-keyword">return</span>;
        $scope.preferredInput = $scope.inputType;
      });
      $scope.submitCheck = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
        <span class="hljs-keyword">var</span> key = event.keyCode || event.which;
        <span class="hljs-keyword">if</span> (key === <span class="hljs-number">13</span>) {
          $scope.postJournalEntryForCurrent(event);
        }
      };
      $scope.postJournalEntry = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, entry, event</span>) </span>{
        type = type || primaryJournalFieldOrder[<span class="hljs-number">0</span>];
        event.stopPropagation();
        <span class="hljs-keyword">var</span> requestTable = $scope.table || <span class="hljs-string">"board:"</span> + $scope.board.sys_id;
        stream.insertForEntry(type, entry.journalText, requestTable, entry.document_id);
        entry.journalText = <span class="hljs-string">""</span>;
        entry.commentBoxVisible = <span class="hljs-literal">false</span>;
        snRecordPresence.termPresence();
      };
      $scope.postJournalEntryForCurrent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
        event.stopPropagation();
        <span class="hljs-keyword">var</span> entries = [];
        <span class="hljs-keyword">if</span> ($scope.multipleInputs) {
          angular.forEach($scope.fields, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
            <span class="hljs-keyword">if</span> (!item.value)
              <span class="hljs-keyword">return</span>;
            entries.push({
              <span class="hljs-attr">field</span>: item.name,
              <span class="hljs-attr">text</span>: item.value
            });
          })
        } <span class="hljs-keyword">else</span> {
          entries.push({
            <span class="hljs-attr">field</span>: $scope.inputType,
            <span class="hljs-attr">text</span>: $scope.inputTypeValue
          })
        }
        <span class="hljs-keyword">var</span> request = stream.insertEntries(entries, $scope.table, $scope.sysId, mentionMap);
        <span class="hljs-keyword">if</span> (request) {
          request.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; entries.length; i++) {
              fireInsertEvent(entries[i].field, entries[i].text);
            }
          });
        }
        clearInputs();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      };

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fireInsertEvent</span>(<span class="hljs-params">name, value</span>) </span>{
        snCustomEvent.fire(<span class="hljs-string">'sn.stream.insert'</span>, name, value);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearInputs</span>(<span class="hljs-params"></span>) </span>{
        $scope.inputTypeValue = <span class="hljs-string">""</span>;
        angular.forEach($scope.fields, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">if</span> (item.value)
            item.filled = <span class="hljs-literal">true</span>;
          item.value = <span class="hljs-string">""</span>;
        });
      }
      $scope.showCommentBox = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry, event</span>) </span>{
        event.stopPropagation();
        <span class="hljs-keyword">if</span> (entry !== $scope.selectedEntry)
          $scope.closeEntry();
        $scope.selectedEntry = entry;
        entry.commentBoxVisible = !entry.commentBoxVisible;
        <span class="hljs-keyword">if</span> (entry.commentBoxVisible) {
          snRecordPresence.initPresence($scope.table, entry.document_id);
        }
      };
      $scope.showMore = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">journal, event</span>) </span>{
        event.stopPropagation();
        journal.showMore = <span class="hljs-literal">true</span>;
      };
      $scope.showLess = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">journal, event</span>) </span>{
        event.stopPropagation();
        journal.showMore = <span class="hljs-literal">false</span>;
      };
      $scope.closeEntry = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.selectedEntry)
          $scope.selectedEntry.commentBoxVisible = <span class="hljs-literal">false</span>;
      };
      $scope.previewAttachment = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt, attachmentUrl</span>) </span>{
        snCustomEvent.fire(<span class="hljs-string">'sn.attachment.preview'</span>, evt, attachmentUrl);
      }
      $scope.$on(<span class="hljs-string">'sn.sessions'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">someOtherScope, sessions</span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.selectedEntry &amp;&amp; $scope.selectedEntry.commentBoxVisible)
          $scope.selectedEntry.sessions = sessions;
      });
      $scope.$watch(<span class="hljs-string">"inputTypeValue"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        emitTyping($scope.inputTypeValue);
      });
      $scope.$watch(<span class="hljs-string">"selectedEntry.journalText"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.selectedEntry)
          emitTyping(newValue || <span class="hljs-string">""</span>);
      });
      $scope.$watch(<span class="hljs-string">'useMultipleInputs'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        setMultipleInputs();
      });

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">emitTyping</span>(<span class="hljs-params">inputValue</span>) </span>{
        <span class="hljs-keyword">var</span> status = inputValue.length ? <span class="hljs-string">"typing"</span> : <span class="hljs-string">"viewing"</span>;
        $scope.$emit(<span class="hljs-string">"record.typing"</span>, {
          <span class="hljs-attr">status</span>: status,
          <span class="hljs-attr">value</span>: inputValue,
          <span class="hljs-attr">table</span>: $scope.table,
          <span class="hljs-attr">sys_id</span>: $scope.sys_id
        });
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">preloadedData</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span>.NOW.snActivityStreamData === <span class="hljs-string">'object'</span> &amp;&amp;
          <span class="hljs-built_in">window</span>.NOW.snActivityStreamData[$scope.table + <span class="hljs-string">'_'</span> + $scope.sysId]) {
          _firstPoll = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">var</span> data = <span class="hljs-built_in">window</span>.NOW.snActivityStreamData[$scope.table + <span class="hljs-string">'_'</span> + $scope.sysId];
          stream = nowStream.create($scope.table, $scope.query, $scope.sysId,
            processor, interval, source, $scope.attachments);
          stream.callback = onPoll;
          stream.preRequestCallback = beforePoll;
          stream.lastTimestamp = data.sys_timestamp;
          <span class="hljs-keyword">if</span> (data.entries &amp;&amp; data.entries.length) {
            stream.lastEntry = angular.copy(data.entries[<span class="hljs-number">0</span>]);
          }
          _firstPollTimeout = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            stream.poll(onPoll, beforePoll);
            _firstPollTimeout = <span class="hljs-literal">false</span>;
          }, <span class="hljs-number">20000</span>);
          beforePoll();
          onPoll(data);
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scheduleNewPoll</span>(<span class="hljs-params">lastTimestamp</span>) </span>{
        cancelStream();
        stream = nowStream.create($scope.table, $scope.query, $scope.sysId,
          processor, interval, source, $scope.attachments);
        stream.lastTimestamp = lastTimestamp;
        stream.poll(onPoll, beforePoll);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reschedulePoll</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> lastTimestamp = stream ? stream.lastTimestamp : <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (cancelStream()) {
          scheduleNewPoll(lastTimestamp);
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reset</span>(<span class="hljs-params"></span>) </span>{
        $scope.loaded = <span class="hljs-literal">false</span>;
        startPolling();
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startPolling</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.loading &amp;&amp; !$scope.loaded)
          <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (!$scope.active)
          <span class="hljs-keyword">return</span>;
        $scope.entries = [];
        $scope.allEntries = [];
        $scope.showAllEntriesButton = <span class="hljs-literal">false</span>;
        $scope.loaded = <span class="hljs-literal">false</span>;
        $scope.loading = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (_firstPoll &amp;&amp; preloadedData()) {
          <span class="hljs-keyword">return</span>;
        }
        scheduleNewPoll();
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onPoll</span>(<span class="hljs-params">response</span>) </span>{
        $scope.loading = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (response.primary_fields)
          primaryJournalFieldOrder = response.primary_fields;
        <span class="hljs-keyword">if</span> (!$scope.fields)
          processFields(response.fields);
        processEntries(response.entries);
        <span class="hljs-keyword">if</span> (!$scope.loaded) {
          $scope.loaded = <span class="hljs-literal">true</span>;
          $scope.$emit(<span class="hljs-string">"sn.stream.loaded"</span>, response);
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">beforePoll</span>(<span class="hljs-params"></span>) </span>{
        $scope.$emit(<span class="hljs-string">"sn.stream.requested"</span>);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processFields</span>(<span class="hljs-params">fields</span>) </span>{
        <span class="hljs-keyword">if</span> (!fields || !fields.length)
          <span class="hljs-keyword">return</span>;
        $scope.fields = {};
        $scope.allFields = fields;
        setShowAllFields();
        $scope.fieldsVisible = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
        angular.forEach(fields, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">field</span>) </span>{
          <span class="hljs-keyword">if</span> (!field.isJournal)
            <span class="hljs-keyword">return</span>;
          <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>)
            $scope.firstJournal = field.name;
          i++;
          $scope.fields[field.name] = field;
          $scope.fields[field.name].visible = $scope.formJournalFields ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">if</span> ($scope.fields[field.name].visible)
            $scope.fieldsVisible++;
          <span class="hljs-keyword">var</span> fieldColor = field.color;
          <span class="hljs-keyword">if</span> (fieldColor)
            fieldColor = field.color.replace(<span class="hljs-regexp">/background-color: /</span>, <span class="hljs-string">''</span>)
          <span class="hljs-keyword">if</span> (!fieldColor || fieldColor == <span class="hljs-string">'transparent'</span>)
            fieldColor = <span class="hljs-literal">null</span>;
          $scope.fields[field.name].color = fieldColor;
        });
        setFieldVisibility();
        setPrimaryJournalField();
        setMultipleInputs();
      }
      $scope.$watch(<span class="hljs-string">'formJournalFields'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        setFieldVisibility();
        setPrimaryJournalField();
        setMultipleInputs();
      }, <span class="hljs-literal">true</span>);

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setFieldVisibility</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!$scope.formJournalFields || !$scope.fields || !$scope.showCommentsAndWorkNotes)
          <span class="hljs-keyword">return</span>;
        $scope.fieldsVisible = <span class="hljs-number">0</span>;
        angular.forEach($scope.formJournalFields, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">formField</span>) </span>{
          <span class="hljs-keyword">if</span> (!$scope.fields[formField.name])
            <span class="hljs-keyword">return</span>;
          $scope.fields[formField.name].value = formField.value;
          $scope.fields[formField.name].mandatory = formField.mandatory;
          $scope.fields[formField.name].label = formField.label;
          $scope.fields[formField.name].messages = formField.messages;
          $scope.fields[formField.name].visible = formField.visible &amp;&amp; !formField.readonly;
          <span class="hljs-keyword">if</span> ($scope.fields[formField.name].visible)
            $scope.fieldsVisible++;
        });
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setPrimaryJournalField</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!$scope.fields || !$scope.showCommentsAndWorkNotes)
          <span class="hljs-keyword">return</span>;
        angular.forEach($scope.fields, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          item.isPrimary = <span class="hljs-literal">false</span>;
        });
        <span class="hljs-keyword">var</span> visibleFields = <span class="hljs-built_in">Object</span>.keys($scope.fields).filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">return</span> $scope.fields[item].visible;
        });
        <span class="hljs-keyword">if</span> (visibleFields.indexOf($scope.preferredInput) != <span class="hljs-number">-1</span>) {
          $scope.inputType = $scope.preferredInput;
          $scope.fields[$scope.preferredInput].checked = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; primaryJournalFieldOrder.length; i++) {
          <span class="hljs-keyword">var</span> fieldName = primaryJournalFieldOrder[i];
          <span class="hljs-keyword">if</span> (visibleFields.indexOf(fieldName) != <span class="hljs-number">-1</span>) {
            $scope.fields[fieldName].isPrimary = <span class="hljs-literal">true</span>;
            primaryJournalField = fieldName;
            <span class="hljs-keyword">if</span> (!$scope.inputType)
              $scope.inputType = fieldName;
            <span class="hljs-keyword">break</span>;
          }
        }
        <span class="hljs-keyword">if</span> (!$scope.inputType &amp;&amp; visibleFields.length &gt; <span class="hljs-number">0</span>) {
          primaryJournalField = visibleFields[<span class="hljs-number">0</span>];
          $scope.inputType = primaryJournalField;
          $scope.fields[primaryJournalField].isPrimary = <span class="hljs-literal">true</span>;
        }
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setShowAllFields</span>(<span class="hljs-params"></span>) </span>{
        $scope.showAllFields = $scope.allFields &amp;&amp; !$scope.allFields.some(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">return</span> !item.isActive;
        });
        $scope.hideAllFields = !$scope.allFields || !$scope.allFields.some(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">return</span> item.isActive;
        });
      }
      $scope.setPrimary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry</span>) </span>{
        angular.forEach($scope.fields, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          item.checked = <span class="hljs-literal">false</span>;
        });
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; primaryJournalFieldOrder.length; i++) {
          <span class="hljs-keyword">var</span> fieldName = primaryJournalFieldOrder[i];
          <span class="hljs-keyword">if</span> (entry.writable_journal_fields.indexOf(fieldName) != <span class="hljs-number">-1</span>) {
            entry.primaryJournalField = fieldName;
            entry.inputType = fieldName;
            <span class="hljs-keyword">return</span>;
          }
        }
        <span class="hljs-keyword">if</span> (!entry.inputType) {
          <span class="hljs-keyword">var</span> primaryField = entry.writable_journal_fields[<span class="hljs-number">0</span>];
          entry.primaryJournalField = primaryField;
          entry.inputType = primaryField;
        }
      }
      $scope.updateFieldVisibilityAll = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $scope.showAllFields = !$scope.showAllFields;
        angular.forEach($scope.allFields, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          item.isActive = $scope.showAllFields;
        });
        $scope.updateFieldVisibility();
      }
      $scope.updateFieldVisibility = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> activeFields = $scope.allFields.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">return</span> item.isActive;
        }).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">return</span> item.name + <span class="hljs-string">','</span> + item.isActive;
        });
        setShowAllFields();
        userPreferences
          .setPreference($scope.table + <span class="hljs-string">'.activity.filter'</span>, activeFields.join(<span class="hljs-string">';'</span>))
          .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            reset();
          })
      }
      $scope.configureAvailableFields = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $<span class="hljs-built_in">window</span>.personalizer($scope.table, <span class="hljs-string">'activity'</span>, $scope.sysId);
      }
      $scope.toggleMultipleInputs = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>) </span>{
        userPreferences.setPreference(<span class="hljs-string">'glide.ui.activity_stream.multiple_inputs'</span>, val ? <span class="hljs-string">'true'</span> : <span class="hljs-string">'false'</span>)
          .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            $scope.useMultipleInputs = val;
            setMultipleInputs();
          });
      };
      $scope.changeEntryInputType = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fieldName, entry</span>) </span>{
        <span class="hljs-keyword">var</span> checked = $scope.fields[fieldName].checked;
        entry.inputType = checked ? fieldName : entry.primaryJournalField;
      };

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processEntries</span>(<span class="hljs-params">entries</span>) </span>{
        <span class="hljs-keyword">if</span> (!entries || !entries.length)
          <span class="hljs-keyword">return</span>;
        entries = entries.reverse();
        <span class="hljs-keyword">var</span> newEntries = [];
        angular.forEach(entries, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry</span>) </span>{
          <span class="hljs-keyword">var</span> entriesToAdd = [entry];
          <span class="hljs-keyword">if</span> (entry.attachment) {
            entry.type = getAttachmentType(entry.attachment);
            entry.attachment.extension = getAttachmentExt(entry.attachment);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (entry.is_email === <span class="hljs-literal">true</span>) {
            entry.email = {};
            <span class="hljs-keyword">var</span> allFields = entry.entries.custom;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; allFields.length; i++) {
              entry.email[allFields[i].field_name] = {
                <span class="hljs-attr">label</span>: allFields[i][<span class="hljs-string">'field_label'</span>],
                <span class="hljs-attr">displayValue</span>: allFields[i][<span class="hljs-string">'new_value'</span>]
              };
            }
            entry[<span class="hljs-string">'entries'</span>].custom = [];
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($scope.sysId) {
            entriesToAdd = extractJournalEntries(entry);
          } <span class="hljs-keyword">else</span> {
            entriesToAdd = handleJournalEntriesWithoutExtraction(entry);
          }
          <span class="hljs-keyword">if</span> (entriesToAdd <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {
            entriesToAdd.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
              $scope.entries.unshift(e);
              newEntries.unshift(e);
            });
          } <span class="hljs-keyword">else</span> {
            $scope.entries.unshift(entriesToAdd);
            newEntries.unshift(entriesToAdd)
          }
          <span class="hljs-keyword">if</span> (source != FROM_FORM)
            $scope.entries = $scope.entries.slice(<span class="hljs-number">0</span>, <span class="hljs-number">49</span>);
          <span class="hljs-keyword">if</span> ($scope.maxEntries != <span class="hljs-literal">undefined</span>) {
            <span class="hljs-keyword">var</span> maxNumEntries = <span class="hljs-built_in">parseInt</span>($scope.maxEntries, <span class="hljs-number">10</span>);
            $scope.entries = $scope.entries.slice(<span class="hljs-number">0</span>, maxNumEntries);
          }
        });
        <span class="hljs-keyword">if</span> ($scope.loaded) {
          $scope.$emit(<span class="hljs-string">"sn.stream.new_entries"</span>, newEntries);
          triggerResize();
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($scope.pageSize &amp;&amp; $scope.entries.length &gt; $scope.pageSize)
          setUpPaging();
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setUpPaging</span>(<span class="hljs-params"></span>) </span>{
        $scope.showAllEntriesButton = <span class="hljs-literal">true</span>;
        $scope.allEntries = $scope.entries;
        $scope.entries = [];
        loadEntries(<span class="hljs-number">0</span>, $scope.pageSize);
      }
      $scope.loadMore = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> ($scope.entries.length + $scope.pageSize &gt; $scope.allEntries.length) {
          $scope.loadAll();
          <span class="hljs-keyword">return</span>;
        }
        loadEntries($scope.loadedEntries, $scope.loadedEntries + $scope.pageSize);
      }
      $scope.loadAll = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $scope.showAllEntriesButton = <span class="hljs-literal">false</span>;
        loadEntries($scope.loadedEntries, $scope.allEntries.length);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadEntries</span>(<span class="hljs-params">start, end</span>) </span>{
        $scope.entries = $scope.entries.concat($scope.allEntries.slice(start, end));
        $scope.loadedEntries = $scope.entries.length;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAttachmentType</span>(<span class="hljs-params">attachment</span>) </span>{
        <span class="hljs-keyword">if</span> (attachment.content_type.startsWith(<span class="hljs-string">'image/'</span>) &amp;&amp; attachment.size_bytes &lt; <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> &amp;&amp; attachment.path.indexOf(attachment.sys_id) == <span class="hljs-number">0</span>)
          <span class="hljs-keyword">return</span> <span class="hljs-string">'attachment-image'</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-string">'attachment'</span>;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAttachmentExt</span>(<span class="hljs-params">attachment</span>) </span>{
        <span class="hljs-keyword">var</span> filename = attachment.file_name;
        <span class="hljs-keyword">return</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">'.'</span>) + <span class="hljs-number">1</span>);
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleJournalEntriesWithoutExtraction</span>(<span class="hljs-params">oneLargeEntry</span>) </span>{
        <span class="hljs-keyword">if</span> (oneLargeEntry.entries.journal.length === <span class="hljs-number">0</span>)
          <span class="hljs-keyword">return</span> oneLargeEntry;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; oneLargeEntry.entries.journal.length; i++) {
          newLinesToBR(oneLargeEntry.entries.journal);
        }
        <span class="hljs-keyword">return</span> oneLargeEntry;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">extractJournalEntries</span>(<span class="hljs-params">oneLargeEntry</span>) </span>{
        <span class="hljs-keyword">var</span> smallerEntries = [];
        <span class="hljs-keyword">if</span> (oneLargeEntry.entries.journal.length === <span class="hljs-number">0</span>)
          <span class="hljs-keyword">return</span> oneLargeEntry;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; oneLargeEntry.entries.journal.length; i++) {
          <span class="hljs-keyword">var</span> journalEntry = angular.copy(oneLargeEntry);
          journalEntry.entries.journal = journalEntry.entries.journal.slice(i, i + <span class="hljs-number">1</span>);
          newLinesToBR(journalEntry.entries.journal);
          journalEntry.entries.changes = [];
          journalEntry.type = <span class="hljs-string">'journal'</span>;
          smallerEntries.unshift(journalEntry);
        }
        oneLargeEntry.entries.journal = [];
        oneLargeEntry.type = <span class="hljs-string">'changes'</span>;
        <span class="hljs-keyword">if</span> (oneLargeEntry.entries.changes.length &gt; <span class="hljs-number">0</span>)
          smallerEntries.unshift(oneLargeEntry);
        <span class="hljs-keyword">return</span> smallerEntries;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newLinesToBR</span>(<span class="hljs-params">entries</span>) </span>{
        angular.forEach(entries, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">if</span> (!item.new_value)
            <span class="hljs-keyword">return</span>;
          item.new_value = item.new_value.replace(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">'&lt;br/&gt;'</span>);
        });
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cancelStream</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (_firstPollTimeout) {
          clearTimeout(_firstPollTimeout);
          _firstPollTimeout = <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">if</span> (!stream)
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        stream.cancel();
        stream = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; 
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setMultipleInputs</span>(<span class="hljs-params"></span>) </span>{
        $scope.multipleInputs = $scope.useMultipleInputs;
        <span class="hljs-keyword">if</span> ($scope.useMultipleInputs === <span class="hljs-literal">true</span> || !$scope.formJournalFields) {
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">var</span> numAffectedFields = <span class="hljs-number">0</span>;
        angular.forEach($scope.formJournalFields, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">if</span> (item.mandatory || item.value)
            numAffectedFields++;
        });
        <span class="hljs-keyword">if</span> (numAffectedFields &gt; <span class="hljs-number">0</span>)
          $scope.multipleInputs = <span class="hljs-literal">true</span>;
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">triggerResize</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>._frameChanged)
          setTimeout(_frameChanged, <span class="hljs-number">0</span>);
      }
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
      element.on(<span class="hljs-string">"click"</span>, <span class="hljs-string">".at-mention"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        <span class="hljs-keyword">var</span> userID = angular.element(evt.target).attr(<span class="hljs-string">'class'</span>).substring(<span class="hljs-string">"at-mention at-mention-user-"</span>.length);
        $http({
          <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/now/form/mention/user/'</span> + userID,
          <span class="hljs-attr">method</span>: <span class="hljs-string">"GET"</span>
        }).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
          scope.showPopover = <span class="hljs-literal">true</span>;
          scope.mentionPopoverProfile = response.data.result;
          scope.clickEvent = evt;
        }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          $http({
            <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/now/live/profiles/'</span> + userID,
            <span class="hljs-attr">method</span>: <span class="hljs-string">"GET"</span>
          }).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
            scope.showPopover = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">var</span> tempProfile = response.data.result;
            tempProfile.userID = tempProfile.sys_id = response.data.result.document;
            scope.mentionPopoverProfile = tempProfile;
            scope.mentionPopoverProfile.sysID = response.data.result[<span class="hljs-string">"userID"</span>];
            scope.clickEvent = evt;
          })
        });
      });
      scope.toggleEmailIframe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">email, event</span>) </span>{
        email.expanded = email.expanded ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;
        event.preventDefault();
      };
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/stream/directive.formStreamEntry.js */</span>
angular.module(<span class="hljs-string">'sn.common.stream'</span>).directive(<span class="hljs-string">'formStreamEntry'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getTemplateUrl</span>) </span>{
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">templateUrl</span>: getTemplateUrl(<span class="hljs-string">'record_stream_entry.xml'</span>)
  }
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/sn/common/stream/directive.snExpandedEmail.js */</span>
angular.module(<span class="hljs-string">"sn.common.stream"</span>).directive(<span class="hljs-string">"snExpandedEmail"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">"E"</span>,
    <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">scope</span>: {
      <span class="hljs-attr">email</span>: <span class="hljs-string">"="</span>
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">"&lt;iframe style='width: 100%;' class='card' src='{{::emailBodySrc}}'&gt;&lt;/iframe&gt;"</span>,
    <span class="hljs-attr">controller</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope</span>) </span>{
      $scope.emailBodySrc = <span class="hljs-string">"email_display.do?email_id="</span> + $scope.email.sys_id.displayValue;
    },
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scope, element</span>) </span>{
      element.load(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> bodyHeight = $j(<span class="hljs-keyword">this</span>).get(<span class="hljs-number">0</span>).contentWindow.document.body.scrollHeight + <span class="hljs-string">"px"</span>;
        $j(<span class="hljs-keyword">this</span>).height(bodyHeight);
      });
    }
  };
});;
<span class="hljs-comment">/*! RESOURCE: /scripts/app.form_presence/controller.formStream.js */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> journalModel = {};
  <span class="hljs-built_in">window</span>.journalModel = journalModel;
  CustomEvent.observe(<span class="hljs-string">'sn.form.journal_field.add'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, mandatory, readonly, visible, value, label</span>) </span>{
    journalModel[name] = {
      <span class="hljs-attr">name</span>: name,
      <span class="hljs-attr">mandatory</span>: mandatory,
      <span class="hljs-attr">readonly</span>: readonly,
      <span class="hljs-attr">visible</span>: visible,
      <span class="hljs-attr">value</span>: value,
      <span class="hljs-attr">label</span>: label,
      <span class="hljs-attr">messages</span>: []
    };
  });
  CustomEvent.observe(<span class="hljs-string">'sn.form.journal_field.readonly'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, readonly</span>) </span>{
    modifyJournalAttribute(name, <span class="hljs-string">"readonly"</span>, readonly);
  });
  CustomEvent.observe(<span class="hljs-string">'sn.form.journal_field.value'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, value</span>) </span>{
    modifyJournalAttribute(name, <span class="hljs-string">"value"</span>, value);
  });
  CustomEvent.observe(<span class="hljs-string">'sn.form.journal_field.mandatory'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, mandatory</span>) </span>{
    modifyJournalAttribute(name, <span class="hljs-string">"mandatory"</span>, mandatory);
  });
  CustomEvent.observe(<span class="hljs-string">'sn.form.journal_field.visible'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, visible</span>) </span>{
    modifyJournalAttribute(name, <span class="hljs-string">"visible"</span>, visible);
  });
  CustomEvent.observe(<span class="hljs-string">'sn.form.journal_field.label'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, visible</span>) </span>{
    modifyJournalAttribute(name, <span class="hljs-string">"label"</span>, visible);
  });
  CustomEvent.observe(<span class="hljs-string">'sn.form.journal_field.show_msg'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">input, message, type</span>) </span>{
    <span class="hljs-keyword">var</span> messages = journalModel[input][<span class="hljs-string">'messages'</span>].concat([{
      <span class="hljs-attr">type</span>: type,
      <span class="hljs-attr">message</span>: message
    }]);
    modifyJournalAttribute(input, <span class="hljs-string">'messages'</span>, messages);
  });
  CustomEvent.observe(<span class="hljs-string">'sn.form.journal_field.hide_msg'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">input, clearAll</span>) </span>{
    <span class="hljs-keyword">if</span> (journalModel[input][<span class="hljs-string">'messages'</span>].length == <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> desiredValue = [];
    <span class="hljs-keyword">if</span> (!clearAll)
      desiredValue = journalModel[input][<span class="hljs-string">'messages'</span>].slice(<span class="hljs-number">1</span>);
    modifyJournalAttribute(input, <span class="hljs-string">'messages'</span>, desiredValue);
  });
  CustomEvent.observe(<span class="hljs-string">'sn.form.hide_all_field_msg'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) </span>{
    <span class="hljs-keyword">var</span> fields = <span class="hljs-built_in">Object</span>.keys(journalModel);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; fields.length; i++) {
      <span class="hljs-keyword">var</span> f = fields[i];
      <span class="hljs-keyword">if</span> (journalModel[f].messages.length == <span class="hljs-number">0</span>)
        <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">var</span> messages = [];
      <span class="hljs-keyword">if</span> (type) {
        <span class="hljs-keyword">var</span> oldMessages = angular.copy(journalModel[f].messages);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; oldMessages.length; j++) {
          <span class="hljs-keyword">if</span> (oldMessages[j].type != type)
            messages.push(oldMessages[j]);
        }
      }
      modifyJournalAttribute(f, <span class="hljs-string">'messages'</span>, messages);
    }
  });
  CustomEvent.observe(<span class="hljs-string">'sn.stream.insert'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">field, text</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span>.g_form !== <span class="hljs-string">"undefined"</span>)
      g_form.getControl(field).value = NOW.STREAM_VALUE_KEY + text;
  });

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">modifyJournalAttribute</span>(<span class="hljs-params">field, prop, value</span>) </span>{
    journalModel[field][prop] = value;
    CustomEvent.fire(<span class="hljs-string">'sn.form.journal_field.changed'</span>);
  }
  angular.module(<span class="hljs-string">'sn.common.stream'</span>).controller(<span class="hljs-string">'formStream'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, snCustomEvent</span>) </span>{
    $scope.formJournalFields = journalModel;
    $scope.formJournalFieldsVisible = <span class="hljs-literal">false</span>;
    setUp();
    snCustomEvent.observe(<span class="hljs-string">'sn.form.journal_field.changed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      setUp();
      <span class="hljs-keyword">if</span> (!$scope.$$phase)
        $scope.$apply();
    });

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setUp</span>(<span class="hljs-params"></span>) </span>{
      setInputValue();
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setInputValue</span>(<span class="hljs-params"></span>) </span>{
      angular.forEach($scope.formJournalFields, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span>.g_form === <span class="hljs-string">"undefined"</span>)
          <span class="hljs-keyword">return</span>;
        item.value = g_form.getValue(item.name);
        <span class="hljs-keyword">if</span> (!item.readonly &amp;&amp; item.visible &amp;&amp; (item.value !== <span class="hljs-literal">undefined</span> || item.value !== <span class="hljs-literal">null</span>)) {
          $scope.$broadcast(<span class="hljs-string">'sn.stream.input_value'</span>, item.value);
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
      });
    }
  })
})();;
<span class="hljs-comment">/*! RESOURCE: /scripts/app.form_presence/directive.scroll_form.js */</span>
angular.module(<span class="hljs-string">'sn.common.stream'</span>).directive(<span class="hljs-string">'scrollFrom'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  "use strict"</span>;
  <span class="hljs-keyword">var</span> SCROLL_TOP_PAD = <span class="hljs-number">10</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">restrict</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">link</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $element, $attrs</span>) </span>{
      <span class="hljs-keyword">var</span> target = $attrs.scrollFrom;
      $j(target).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.g_form) {
          <span class="hljs-keyword">var</span> tab = g_form._getTabNameForElement($element);
          <span class="hljs-keyword">if</span> (tab)
            g_form.activateTab(tab);
        }
        <span class="hljs-keyword">var</span> $scrollRoot = $element.closest(<span class="hljs-string">'.form-group'</span>);
        <span class="hljs-keyword">if</span> ($scrollRoot.length === <span class="hljs-number">0</span>)
          $scrollRoot = $element;
        <span class="hljs-keyword">var</span> $scrollParent = $scrollRoot.scrollParent();
        <span class="hljs-keyword">var</span> offset = $element.offset().top - $scrollParent.offset().top - SCROLL_TOP_PAD + $scrollParent.scrollTop();
        $scrollParent.animate({
          <span class="hljs-attr">scrollTop</span>: offset
        }, <span class="hljs-string">'500'</span>, <span class="hljs-string">'swing'</span>);
        evt.stopPropagation();
      })
    }
  }
});;;;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
